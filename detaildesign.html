<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Îã§Îã¥ Ï∫êÎπÑÎÑ∑ ÏóêÏù¥Ï†ÑÌä∏ - v33.0 (ÏûêÏû¨Ï∂îÏ∂ú ÏãúÏä§ÌÖú Í∞úÏÑ†)</title>
    <style>
      :root {
        /* Í∏∞Î≥∏ ÏÉâÏÉÅ */
        --primary-color: #4a7dff;
        --bg-color: #f4f6f8;
        --card-bg: #ffffff;
        --text-color: #333;
        --text-muted: #666;
        --border-color: #ddd;

        /* ÏÉÅÌÉú ÏÉâÏÉÅ */
        --danger-color: #ff4d4f;
        --success-color: #00c853;
        --warning-color: #f59e0b;

        /* Í∞ÄÍµ¨ ÌÉÄÏûÖÎ≥Ñ ÏÉâÏÉÅ */
        --upper-color: #5b8def;
        --lower-color: #f59e0b;
        --tall-color: #10b981;
        --fridge-color: #0ea5e9;
        --wardrobe-color: #10b981;
        --homecafe-color: #8b5cf6;
        --sink-color: #3b82f6;

        /* Î†àÏù¥ÏïÑÏõÉ */
        --border-radius: 12px;
        --border-radius-sm: 6px;
        --border-radius-xs: 4px;

        /* Í∞ÑÍ≤© */
        --gap-xs: 4px;
        --gap-sm: 8px;
        --gap-md: 12px;
        --gap-lg: 16px;
        --gap-xl: 24px;

        /* Ìè∞Ìä∏ ÌÅ¨Í∏∞ */
        --font-xs: 9px;
        --font-sm: 11px;
        --font-md: 13px;
        --font-lg: 15px;

        /* Í∑∏Î¶ºÏûê */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
      }
      * {
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      body {
        margin: 0;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
      }
      .app-container {
        max-width: 1100px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 30px;
        min-height: 80vh;
      }
      h1 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 10px;
      }
      .subtitle {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
      }
      .stepper-indicator {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
      }
      .step-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #eee;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }
      .step-dot.active {
        background: var(--primary-color);
        color: white;
      }
      .section-label {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .badge {
        background: #eef2ff;
        color: var(--primary-color);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
      }
      label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
        display: block;
      }
      input[type='number'],
      input[type='text'],
      select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 100%;
        font-size: 13px;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--primary-color);
      }
      .btn-next {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 999px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-next:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .btn-back {
        background: white;
        border: 1px solid #ddd;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 30px;
      }
      .category-card {
        background: #fafafa;
        border: 2px solid transparent;
        border-radius: var(--border-radius);
        height: 100px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .category-card:hover {
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .category-card.active {
        border-color: var(--primary-color);
        background: #f4f8ff;
      }
      .category-name {
        font-size: 15px;
        font-weight: 600;
        color: #555;
        transition: transform 0.3s;
      }
      .category-card.active .category-name {
        transform: translateY(-15px);
        color: var(--primary-color);
      }
      .card-stepper {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        transform: translateY(100%);
        transition: transform 0.3s;
      }
      .category-card.active .card-stepper {
        transform: translateY(0);
      }
      .stepper-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        width: 30px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .stepper-count {
        color: white;
        font-weight: bold;
        font-size: 16px;
      }
      #detailInputSection {
        display: none;
        background: #f9fafb;
        padding: 24px;
        border-radius: var(--border-radius);
        border: 1px solid #eee;
        margin-top: 20px;
      }
      .ai-guide-box {
        background: #fff;
        border-left: 4px solid var(--primary-color);
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .item-input-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .item-body {
        display: flex;
        gap: 12px;
      }
      .input-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .input-row {
        display: flex;
        gap: 8px;
      }
      .input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .extra-settings {
        background: #f8f9fa;
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .extra-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--primary-color);
      }
      .photo-section {
        width: 90px;
        flex-shrink: 0;
      }
      .photo-box {
        background: #f0f0f0;
        border: 1px dashed #ccc;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #888;
        font-size: 10px;
        min-height: 80px;
        position: relative;
        overflow: hidden;
      }
      .photo-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
      }
      .file-input-hidden {
        display: none;
      }
      .btn-delete {
        background: transparent;
        color: #999;
        border: none;
        font-size: 18px;
        cursor: pointer;
      }
      #step2-content {
        display: none;
      }
      #step3-content {
        display: none;
      }
      .bookmark-tabs {
        display: flex;
        gap: 4px;
        border-bottom: 2px solid var(--primary-color);
        padding-top: 5px;
      }
      .bookmark-tab {
        padding: 10px 20px;
        background: #eef2f6;
        color: #888;
        border-radius: 10px 10px 0 0;
        border: 1px solid #ddd;
        border-bottom: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        top: 2px;
      }
      .bookmark-tab.active {
        background: #fff;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        border-bottom: 2px solid #fff;
        z-index: 10;
      }
      .design-workspace {
        background: #fff;
        border: 2px solid var(--primary-color);
        border-top: none;
        border-radius: 0 0 12px 12px;
        padding: 20px;
        min-height: 500px;
      }
      .ws-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .ws-title {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .ws-info-badge {
        font-size: 13px;
        color: #666;
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .ws-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
      }
      .spec-panel {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #eee;
        max-height: 700px;
        overflow-y: auto;
      }
      .spec-group-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 15px 0 8px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 4px;
      }
      .spec-group-title:first-child {
        margin-top: 0;
      }
      .spec-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .spec-field {
        flex: 1;
      }
      .color-select-row {
        display: flex;
        gap: 4px;
      }
      .color-select-row select {
        width: 50%;
        font-size: 12px;
      }
      .acc-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 6px;
      }
      .acc-item {
        display: flex;
        gap: 4px;
      }
      .btn-add-acc {
        width: 100%;
        padding: 6px;
        background: #fff;
        border: 1px dashed #ccc;
        color: #666;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
      }
      .btn-del-acc {
        color: #ccc;
        border: 1px solid #eee;
        background: white;
        border-radius: 4px;
        width: 24px;
        cursor: pointer;
      }
      .module-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .module-section {
        margin-bottom: 16px;
      }
      .module-section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        padding: 10px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 700;
      }
      .module-section-header.upper {
        background: linear-gradient(135deg, #e0ecff 0%, #f0f5ff 100%);
        color: var(--upper-color);
        border-left: 4px solid var(--upper-color);
      }
      .module-section-header.lower {
        background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
        color: var(--lower-color);
        border-left: 4px solid var(--lower-color);
      }
      .section-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      .section-info-row {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        margin-top: 6px;
        font-size: 11px;
      }
      .effective-space-group {
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(255, 255, 255, 0.7);
        padding: 3px 8px;
        border-radius: 4px;
      }
      .effective-space-group label {
        font-size: 10px;
        color: #666;
        margin: 0;
      }
      .effective-space-input {
        width: 70px;
        padding: 3px 6px;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 3px;
        text-align: center;
      }
      .section-remaining {
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.7);
        padding: 3px 8px;
        border-radius: 4px;
      }
      .section-buttons {
        display: flex;
        gap: 4px;
        margin-left: auto;
      }
      .btn-section-undo,
      .btn-section-auto {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-section-undo {
        background: #f0f0f0;
        border: 1px solid #ccc;
        color: #666;
      }
      .btn-section-undo:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .btn-section-auto {
        background: white;
        border: 1px solid currentColor;
      }
      .module-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-height: 80px;
        padding: 8px;
        background: #fafafa;
        border-radius: 6px;
        border: 2px dashed #ddd;
      }
      .module-list.empty-list::before {
        content: '+ Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ïû•ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî';
        color: #aaa;
        font-size: 12px;
        text-align: center;
        display: block;
        padding: 20px;
      }
      .module-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        position: relative;
      }
      .module-card:hover {
        border-color: #bbb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .module-card.tall-type {
        border-left: 3px solid var(--tall-color);
        background: linear-gradient(90deg, #ecfdf5 0%, white 20%);
      }
      .module-card.fixed-module {
        border-left: 3px solid var(--primary-color);
        background: linear-gradient(90deg, #e8f4ff 0%, white 20%);
      }
      .module-card.fixed-module::after {
        content: 'Í≥†Ï†ï';
        position: absolute;
        top: 4px;
        right: 28px;
        font-size: 9px;
        color: var(--primary-color);
        background: #e8f4ff;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .module-card.base-module {
        border-left: 3px solid #9333ea;
        background: linear-gradient(90deg, #f3e8ff 0%, white 20%);
      }
      .module-card.base-module::after {
        content: 'Í∏∞Ï§Ä';
        position: absolute;
        top: 4px;
        right: 28px;
        font-size: 9px;
        color: #9333ea;
        background: #f3e8ff;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .move-buttons {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .btn-move {
        width: 24px;
        height: 20px;
        border: 1px solid #ddd;
        background: #f8f8f8;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
      }
      .btn-move:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .btn-move:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      .module-icon {
        width: 32px;
        height: 32px;
        background: #f4f6f8;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .module-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .module-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .module-title {
        font-size: 13px;
        font-weight: 600;
      }
      .module-type-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 3px;
        background: var(--tall-color);
        color: white;
      }
      .module-dims {
        display: flex;
        gap: 6px;
        margin-top: 2px;
        flex-wrap: wrap;
      }
      .dim-group {
        display: flex;
        align-items: center;
        gap: 2px;
        background: #fafafa;
        padding: 1px 4px;
        border-radius: 4px;
        border: 1px solid #eee;
      }
      .dim-label {
        font-size: 10px;
        color: #888;
        font-weight: 600;
        margin: 0;
      }
      .dim-input {
        width: 40px;
        padding: 2px 4px;
        font-size: 11px;
        border: none;
        background: transparent;
        text-align: center;
      }
      .dim-input:focus {
        outline: none;
        color: var(--primary-color);
        background: #fff;
      }
      .module-options {
        display: flex;
        gap: 8px;
        margin-top: 4px;
        flex-wrap: wrap;
      }
      .module-chk {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 11px;
        color: #666;
        cursor: pointer;
      }
      .module-chk input {
        margin: 0;
        transform: scale(0.9);
      }
      .btn-delete-module {
        color: #ccc;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 0 4px;
        margin-left: auto;
      }
      .btn-delete-module:hover {
        color: var(--danger-color);
      }
      .module-btn-group {
        display: flex;
        gap: 6px;
        margin-top: 8px;
      }
      .btn-add-split {
        flex: 1;
        padding: 8px;
        background: #fff;
        border: 1px dashed #ccc;
        color: #666;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
      }
      .btn-add-split:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: #f4f8ff;
      }
      .btn-add-upper {
        border-color: var(--upper-color);
        color: var(--upper-color);
      }
      .btn-add-lower {
        border-color: var(--lower-color);
        color: var(--lower-color);
      }
      .btn-add-tall {
        border-color: var(--tall-color);
        color: var(--tall-color);
      }

      /* ÏµúÏ†ÅÌôî: Í≥µÌÜµ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
      .btn-toggle {
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 10px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        transition: all 0.15s;
      }
      .btn-toggle:hover {
        opacity: 0.8;
      }
      .btn-toggle.active {
        border-color: currentColor;
      }
      .btn-toggle.green {
        color: var(--tall-color);
      }
      .btn-toggle.green.active {
        background: #ecfdf5;
        border-color: var(--tall-color);
      }
      .btn-toggle.blue {
        color: var(--sink-color);
      }
      .btn-toggle.blue.active {
        background: #eff6ff;
        border-color: var(--sink-color);
      }
      .btn-toggle.orange {
        color: var(--lower-color);
      }
      .btn-toggle.orange.active {
        background: #fef3c7;
        border-color: var(--lower-color);
      }
      .btn-toggle.purple {
        color: #8b5cf6;
      }
      .btn-toggle.purple.active {
        background: #f3e8ff;
        border-color: #8b5cf6;
      }

      .btn-adjust {
        width: 20px;
        height: 20px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        background: var(--card-bg);
        cursor: pointer;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .btn-adjust:hover {
        background: #f0f0f0;
      }
      .btn-adjust:active {
        background: #e0e0e0;
      }

      .btn-purple-gradient {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        transition: all 0.2s;
      }
      .btn-purple-gradient:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .adjust-control {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
      }
      .adjust-control .value {
        min-width: 20px;
        text-align: center;
        font-weight: 600;
      }

      .toggle-group {
        display: flex;
        gap: 2px;
      }

      .spec-input-sm {
        width: 50px;
        padding: 3px 4px;
        font-size: 11px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        text-align: center;
      }
      .spec-input-sm:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
      }
      .checkbox-label input {
        margin: 0;
        transform: scale(0.9);
      }

      /* ÏµúÏ†ÅÌôî: Wardrobe Î™®Îìà Ïπ¥Îìú Ïä§ÌÉÄÏùº */
      .wm-card {
        display: flex;
        gap: 8px;
        padding: 10px;
        align-items: flex-start;
      }
      .wm-left {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 50px;
      }
      .wm-move-btns {
        display: flex;
        gap: 2px;
        margin-bottom: 2px;
      }
      .wm-type-btn {
        font-size: 8px;
        padding: 3px 2px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
      }
      .wm-type-btn.short {
        color: var(--tall-color);
      }
      .wm-type-btn.short.active {
        border-color: var(--tall-color);
        background: #ecfdf5;
      }
      .wm-type-btn.long {
        color: var(--sink-color);
      }
      .wm-type-btn.long.active {
        border-color: var(--sink-color);
        background: #eff6ff;
      }
      .wm-type-btn.shelf {
        color: var(--lower-color);
      }
      .wm-type-btn.shelf.active {
        border-color: var(--lower-color);
        background: #fffbeb;
      }
      .wm-center {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .wm-header {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .wm-icon {
        font-size: 14px;
      }
      .wm-name {
        font-weight: 600;
        color: #333;
        font-size: 13px;
      }
      .wm-badge {
        font-size: 9px;
        padding: 1px 5px;
        border-radius: 3px;
      }
      .wm-badge.short {
        background: #ecfdf5;
        color: var(--tall-color);
      }
      .wm-badge.long {
        background: #eff6ff;
        color: var(--sink-color);
      }
      .wm-badge.shelf {
        background: #fffbeb;
        color: var(--lower-color);
      }
      .wm-section {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 5px;
      }
      .wm-section.upper {
        background: #ecfdf5;
        border: 1px solid var(--tall-color);
      }
      .wm-section.lower {
        background: #eff6ff;
        border: 1px solid var(--sink-color);
      }
      .wm-section.full {
        background: #f0f7ff;
        border: 1px solid var(--primary-color);
      }
      .wm-section-label {
        font-size: 10px;
        font-weight: 700;
        min-width: 38px;
      }
      .wm-section.upper .wm-section-label {
        color: var(--tall-color);
      }
      .wm-section.lower .wm-section-label {
        color: var(--sink-color);
      }
      .wm-section.full .wm-section-label {
        color: var(--primary-color);
      }
      .wm-dim-label {
        font-size: 10px;
        color: var(--text-muted);
      }
      .wm-dim-input {
        width: 52px;
        padding: 3px 4px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
      }
      .wm-sett-btn {
        padding: 2px 5px;
        font-size: 9px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-left: auto;
      }
      .wm-drawer-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3px 5px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
      }
      .wm-drawer-label {
        font-size: 8px;
        color: var(--text-muted);
        margin-bottom: 2px;
      }
      .wm-drawer-btns {
        display: flex;
        gap: 1px;
      }
      .wm-drawer-btn {
        padding: 1px 3px;
        font-size: 8px;
        border-radius: 2px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-muted);
      }
      .wm-drawer-btn.active {
        border-color: var(--sink-color);
        background: #eff6ff;
        color: var(--sink-color);
      }

      @media (max-width: 800px) {
        .ws-layout {
          grid-template-columns: 1fr;
        }
      }

      /* Ïù∏Ï¶ù Ïò§Î≤ÑÎ†àÏù¥ */
      .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .auth-modal {
        background: white;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        max-width: 400px;
      }
      .auth-modal h2 {
        font-size: 24px;
        margin-bottom: 16px;
      }
      .auth-modal p {
        color: #666;
        margin-bottom: 24px;
      }
      .auth-modal .btn-login {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }
      .auth-modal .btn-login:hover {
        opacity: 0.9;
      }

      /* ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
      .nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1001;
        padding: 0 48px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(10px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .nav-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #2d2a26;
        text-decoration: none;
      }
      .nav-logo svg {
        width: 28px;
        height: 28px;
      }
      .nav-logo span {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
      }
      .nav-menu {
        display: flex;
        gap: 28px;
      }
      .nav-menu a {
        color: #2d2a26;
        font-size: 13px;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        text-decoration: none;
      }
      .nav-menu a:hover {
        opacity: 0.7;
      }
      .nav-menu a.active {
        color: #b8956c;
        font-weight: 500;
      }
      .nav-icons {
        display: flex;
        align-items: center;
        gap: 20px;
        color: #2d2a26;
      }
      .user-menu {
        position: relative;
      }
      .user-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        background: #f8f7f4;
        border: none;
        color: inherit;
        cursor: pointer;
        transition: all 0.3s;
      }
      .user-btn:hover {
        background: #ebe8e2;
      }
      .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #b8956c;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: #fff;
      }
      .user-name {
        font-size: 13px;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .user-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 180px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s;
        z-index: 200;
      }
      .user-menu:hover .user-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      .user-dropdown a,
      .user-dropdown button {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        color: #2d2a26;
        background: none;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
        text-align: left;
        text-decoration: none;
      }
      .user-dropdown a:hover,
      .user-dropdown button:hover {
        background: #f8f7f4;
      }
      .user-dropdown svg {
        width: 18px;
        height: 18px;
        color: #8b8680;
      }
      .hamburger {
        display: none;
        flex-direction: column;
        gap: 5px;
        padding: 8px;
        cursor: pointer;
        background: none;
        border: none;
      }
      .hamburger span {
        width: 24px;
        height: 2px;
        background: #2d2a26;
        border-radius: 2px;
        transition: all 0.3s;
      }
      .mobile-menu {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 1000;
        padding: 24px;
        display: none;
        flex-direction: column;
        gap: 8px;
      }
      .mobile-menu.active {
        display: flex;
      }
      .mobile-menu a {
        padding: 16px 20px;
        font-size: 16px;
        border-radius: 12px;
        transition: background 0.3s;
        text-decoration: none;
        color: #2d2a26;
      }
      .mobile-menu a:hover,
      .mobile-menu a.active {
        background: #f8f7f4;
        color: #b8956c;
      }
      @media (max-width: 768px) {
        .nav {
          padding: 0 16px;
          height: 56px;
        }
        .nav-menu {
          display: none;
        }
        .hamburger {
          display: flex;
        }
      }

      /* ÏÉÅÎã® Ìà¥Î∞î */
      .top-toolbar {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      @media (max-width: 768px) {
        .top-toolbar {
          top: 56px;
        }
      }
      .toolbar-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .toolbar-logo {
        font-weight: 700;
        font-size: 16px;
        color: #333;
        text-decoration: none;
      }
      .toolbar-user {
        font-size: 13px;
        color: #666;
      }
      .toolbar-right {
        display: flex;
        gap: 8px;
      }
      .btn-toolbar {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid #ddd;
        background: white;
        transition: all 0.2s;
      }
      .btn-toolbar:hover {
        background: #f5f5f5;
      }
      .btn-toolbar.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .btn-toolbar.primary:hover {
        opacity: 0.9;
      }
      .btn-toolbar.success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      /* Ï†ÄÏû• ÏÉÅÌÉú ÌëúÏãú */
      .save-status {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .save-status.saving {
        background: #fef3c7;
        color: #92400e;
      }
      .save-status.saved {
        background: #dcfce7;
        color: #166534;
      }
      .save-status.error {
        background: #fee2e2;
        color: #dc2626;
      }

      /* Î∞îÎîî Ìå®Îî© Ï°∞Ï†ï (ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò 64px + Ìà¥Î∞î 50px) */
      body.has-toolbar {
        padding-top: 120px;
      }
      @media (max-width: 768px) {
        body.has-toolbar {
          padding-top: 112px;
        }
      }

      /* Î∂àÎü¨Ïò§Í∏∞ Î™®Îã¨ */
      .load-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .load-modal {
        background: #fff;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .load-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #eee;
      }
      .load-modal-header h3 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .load-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .load-modal-close:hover {
        color: #333;
      }
      .load-modal-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 0;
      }
      .load-modal-empty {
        padding: 60px 24px;
        text-align: center;
        color: #888;
      }
      .design-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }
      .design-list-item:hover {
        background: #f8f9fa;
      }
      .design-list-item .info {
        flex: 1;
      }
      .design-list-item .name {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 4px;
        color: #333;
      }
      .design-list-item .meta {
        font-size: 12px;
        color: #888;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .design-list-item .status {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
      }
      .design-list-item .status.draft {
        background: #fff3cd;
        color: #856404;
      }
      .design-list-item .status.submitted {
        background: #cce5ff;
        color: #004085;
      }
      .design-list-item .status.completed {
        background: #d4edda;
        color: #155724;
      }
      .design-list-item .delete-btn {
        padding: 8px;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 16px;
      }
      .design-list-item:hover .delete-btn {
        opacity: 1;
      }

      .hidden {
        display: none !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-utils.js"></script>
  </head>
  <body class="has-toolbar">
    <!-- Navigation -->
    <nav class="nav">
      <a href="index.html" class="nav-logo">
        <svg viewBox="0 0 40 40" fill="currentColor">
          <path d="M20 4L4 12v16l16 8 16-8V12L20 4zm0 4l12 6-12 6-12-6 12-6zm-12 10l12 6 12-6v8l-12 6-12-6v-8z" />
        </svg>
        <span>Îã§Îã¥</span>
      </a>
      <div class="nav-menu">
        <a href="index.html">Ìôà</a>
        <a href="ai-design.html">AI ÏÑ§Í≥Ñ</a>
        <a href="consultation.html">ÏÉÅÎã¥ Ïã†Ï≤≠</a>
      </div>
      <div class="nav-icons">
        <div class="user-menu" id="navUserMenu">
          <button class="user-btn">
            <div class="user-avatar" id="navUserAvatar">?</div>
            <span class="user-name" id="navUserName">ÏÇ¨Ïö©Ïûê</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6" />
            </svg>
          </button>
          <div class="user-dropdown">
            <a href="mypage.html"
              ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" /></svg
              >ÎßàÏù¥ÌéòÏù¥ÏßÄ</a
            >
            <a href="my-designs.html"
              ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" /></svg
              >ÎÇ¥ ÏÑ§Í≥Ñ</a
            >
            <button onclick="logoutNav()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" /></svg
              >Î°úÍ∑∏ÏïÑÏõÉ
            </button>
          </div>
        </div>
        <button class="hamburger" onclick="toggleMobileMenu()">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
      <a href="index.html">Ìôà</a>
      <a href="ai-design.html">AI ÏÑ§Í≥Ñ</a>
      <a href="consultation.html">ÏÉÅÎã¥ Ïã†Ï≤≠</a>
      <a href="mypage.html">ÎßàÏù¥ÌéòÏù¥ÏßÄ</a>
      <a href="my-designs.html">ÎÇ¥ ÏÑ§Í≥Ñ</a>
      <a
        href="#"
        onclick="
          logoutNav();
          return false;
        "
        style="color: #8b8680; margin-top: 16px; border-top: 1px solid #ebe8e2; padding-top: 24px"
        >Î°úÍ∑∏ÏïÑÏõÉ</a
      >
    </div>

    <!-- Ïù∏Ï¶ù Ïò§Î≤ÑÎ†àÏù¥ (Î°úÍ∑∏Ïù∏ ÏïàÎê®) -->
    <div class="auth-overlay" id="authOverlay">
      <div class="auth-modal">
        <h2>üîí Î°úÍ∑∏Ïù∏ ÌïÑÏöî</h2>
        <p>ÏÉÅÏÑ∏ ÏÑ§Í≥Ñ ÎèÑÍµ¨Î•º Ïù¥Ïö©ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
        <button class="btn-login" onclick="location.href = 'login.html'">Î°úÍ∑∏Ïù∏ÌïòÍ∏∞</button>
      </div>
    </div>

    <!-- ÏÉÅÎã® Ìà¥Î∞î -->
    <div class="top-toolbar" id="topToolbar">
      <div class="toolbar-left">
        <a href="index.html" class="toolbar-logo">ü™ë Îã§Îã¥Í∞ÄÍµ¨</a>
        <span class="toolbar-user" id="toolbarUser">Î°úÎî©Ï§ë...</span>
        <span class="save-status saved hidden" id="saveStatus">
          <span id="saveStatusIcon">‚úì</span>
          <span id="saveStatusText">Ï†ÄÏû•Îê®</span>
        </span>
      </div>
      <div class="toolbar-right">
        <button class="btn-toolbar" onclick="loadDesignList()">üìÇ Î∂àÎü¨Ïò§Í∏∞</button>
        <button class="btn-toolbar primary" onclick="saveDesign()">üíæ Ï†ÄÏû•ÌïòÍ∏∞</button>
        <button class="btn-toolbar success" onclick="submitDesign()">üì§ Ï†úÏ∂úÌïòÍ∏∞</button>
      </div>
    </div>

    <div class="app-container">
      <h1>Îã§Îã¥ Ï∫êÎπÑÎÑ∑ ÏóêÏù¥Ï†ÑÌä∏</h1>
      <div class="subtitle">ÌÜµÌï© Í∞ÄÍµ¨ ÏÑ§Í≥Ñ Î∞è ÏûêÎèô ÏûêÏû¨ ÏÇ∞Ï∂ú ÏÜîÎ£®ÏÖò (v33.0 - ÏûêÏû¨Ï∂îÏ∂ú ÏãúÏä§ÌÖú Í∞úÏÑ†)</div>
      <div class="stepper-indicator">
        <div id="step-dot-1" class="step-dot active">1</div>
        <div id="step-dot-2" class="step-dot">2</div>
        <div id="step-dot-3" class="step-dot">3</div>
      </div>
      <div id="step1-content">
        <div class="section-label">1. ÌïÑÏöîÌïú Í∞ÄÍµ¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî <span class="badge">ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù</span></div>
        <div class="category-grid" id="categoryGrid"></div>
        <div id="detailInputSection">
          <div class="ai-guide-box">
            <span style="font-size: 18px">ü§ñ</span><span id="aiGuideText">Í∞ÄÍµ¨Î•º Ï∂îÍ∞ÄÌïòÎ©¥ ÏûÖÎ†•Ï∞ΩÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§.</span>
          </div>
          <div class="section-label">2. Í∞ÄÍµ¨Î≥Ñ ÏÉÅÏÑ∏ ÏπòÏàò Î∞è ÌòÑÏû• ÏÇ¨ÏßÑ</div>
          <div id="dynamicInputList"></div>
          <div style="display: flex; justify-content: flex-end; margin-top: 30px">
            <button class="btn-next" id="btnNext" disabled onclick="goToStep2()">Îã§Ïùå Îã®Í≥Ñ (ÏÑ§Í≥Ñ ÏãúÏûë) ‚Üí</button>
          </div>
        </div>
      </div>
      <div id="step2-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
          <div class="section-label" style="margin: 0">ÏÑ§Í≥Ñ ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§</div>
          <button class="btn-back" onclick="backToStep1()">‚Üê ÏûÖÎ†• ÏàòÏ†ïÌïòÍ∏∞</button>
        </div>
        <div class="bookmark-tabs" id="bookmarkTabs"></div>
        <div class="design-workspace" id="designWorkspace"></div>
      </div>
      <div id="step3-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div class="section-label" style="margin:0;">BOM ÏÇ∞Ï∂ú Í≤∞Í≥º</div>
          <button class="btn-back" onclick="backToStep2()">‚Üê ÏÑ§Í≥Ñ ÏàòÏ†ïÌïòÍ∏∞</button>
        </div>
        <div id="step3-report-area">
          <!-- BOM Î≥¥Í≥†ÏÑúÍ∞Ä Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® -->
        </div>
        <div style="display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap;margin-top:20px;padding:15px;background:#f9f9f9;border-radius:12px;">
          <div style="display:flex;gap:8px;">
            <button onclick="downloadReportExcel()" style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üìä ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
            <button onclick="downloadReportCSV()" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üìÑ CSV Îã§Ïö¥Î°úÎìú</button>
            <button onclick="downloadReportCNC()" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üîß CNC ÌååÏùº</button>
          </div>
          <button onclick="proceedToBOM()" style="background:linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üîÑ Ïû¨ÏÇ∞Ï∂ú</button>
        </div>
      </div>
    </div>

    <script>
      // ============================================================
      // Ïï± ÏÑ§Ï†ï Î∞è Î≤ÑÏ†Ñ Ï†ïÎ≥¥
      // ============================================================
      const APP_CONFIG = {
        version: '33.0',
        versionName: 'Material Extractor V2',
        lastUpdate: '2026-01-16',
        features: ['Ïã±ÌÅ¨ÎåÄ', 'Î∂ôÎ∞ïÏù¥Ïû•', 'ÎÉâÏû•Í≥†Ïû•', 'AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏', 'ÏûêÏû¨Ï∂îÏ∂ú V2'],
      };

      // ============================================================
      // AI ÏóêÏù¥Ï†ÑÌä∏ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
      // ============================================================
      const AIAgentInterface = {
        // ÌòÑÏû¨ ÏÑ§Í≥Ñ ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
        getDesignState: () => ({
          selectedItems: selectedItems,
          currentStep: document.getElementById('step-dot-1').classList.contains('active') ? 1 : 2,
        }),

        // ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
        addItem: (category, dimensions) => {
          const categoryData = CATEGORIES.find((c) => c.id === category);
          if (!categoryData) return { success: false, error: 'Invalid category' };

          const newItem = {
            uniqueId: Date.now(),
            category: category,
            name: categoryData.name,
            w: dimensions.w || 0,
            h: dimensions.h || 0,
            d: dimensions.d || categoryData.defaultD,
            specs: { ...DEFAULT_SPECS },
            modules: [],
          };
          selectedItems.push(newItem);
          return { success: true, item: newItem };
        },

        // ÏïÑÏù¥ÌÖú Ï°∞Ìöå
        getItem: (itemId) => getItem(itemId),

        // Î™®Îìà Ï∂îÍ∞Ä
        addModule: (itemId, moduleData) => {
          const item = getItem(itemId);
          if (!item) return { success: false, error: 'Item not found' };

          const newModule = {
            id: Date.now(),
            ...moduleData,
          };
          item.modules.push(newModule);
          return { success: true, module: newModule };
        },

        // ÏûêÎèô Í≥ÑÏÇ∞ Ïã§Ìñâ
        runAutoCalc: (itemId, section) => {
          const item = getItem(itemId);
          if (!item) return { success: false, error: 'Item not found' };

          // ‚òÖ categoryId ÏÇ¨Ïö©
          const category = item.categoryId || item.category;
          if (category === 'sink') {
            if (section === 'upper') runAutoCalcUpper(itemId);
            else if (section === 'lower') runAutoCalcLower(itemId);
          } else if (category === 'wardrobe') {
            runWardrobeAutoCalc(itemId);
          } else if (category === 'fridge') {
            autoCalculateFridge(itemId);
          }
          return { success: true };
        },

        // Ïä§Ìéô ÏóÖÎç∞Ïù¥Ìä∏
        updateSpec: (itemId, field, value) => {
          const item = updateItemSpec(itemId, field, value, false);
          return item ? { success: true } : { success: false, error: 'Item not found' };
        },

        // ÏÑ§Í≥Ñ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (JSON)
        exportDesign: () => ({
          appVersion: APP_CONFIG.version,
          exportDate: new Date().toISOString(),
          items: selectedItems.map((item) => ({
            ...item,
            specs: { ...item.specs },
            modules: (item.modules || []).map((m) => ({ ...m })),
          })),
        }),

        // ÏÑ§Í≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        importDesign: (designData) => {
          try {
            if (designData.items) {
              selectedItems = designData.items;
              updateUI();
              return { success: true };
            }
            return { success: false, error: 'Invalid design data' };
          } catch (e) {
            return { success: false, error: e.message };
          }
        },
      };

      // Ï†ÑÏó≠ÏúºÎ°ú ÎÖ∏Ï∂ú (AI ÏóêÏù¥Ï†ÑÌä∏ Ï†ëÍ∑ºÏö©)
      window.DadamAgent = AIAgentInterface;

      // ============================================================
      // FurnitureOptionCatalog - Supabase ÏòµÏÖò Ïπ¥ÌÉàÎ°úÍ∑∏
      // ============================================================
      const FurnitureOptionCatalog = {
        options: {},   // { door_color: [...], handle: [...], ... }
        loaded: false,

        // materials ÌÖåÏù¥Î∏î Ïπ¥ÌÖåÍ≥†Î¶¨ ‚Üí Í∏∞Ï°¥ Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë
        _categoryMap: { 'door': 'door_color', 'door_finish': 'door_finish' },

        async load() {
          try {
            const client = typeof SupabaseUtils !== 'undefined' && SupabaseUtils.client;
            if (!client) { this._loadFallback(); return; }

            // materials ÌÖåÏù¥Î∏îÏóêÏÑú Î°úÎìú (v3 ÎèôÏ†Å ÌîÑÎ°¨ÌîÑÌä∏)
            const { data, error } = await client
              .from('materials').select('*')
              .eq('is_active', true).order('sort_order');

            if (error) throw error;
            if (!data || data.length === 0) {
              // materials ÌÖåÏù¥Î∏îÏù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Ï°¥ furniture_options ÏãúÎèÑ
              const { data: foData, error: foError } = await client
                .from('furniture_options').select('*')
                .eq('is_active', true).order('sort_order');
              if (foError) throw foError;
              this._loadFromFurnitureOptions(foData || []);
              return;
            }

            this.options = {};
            for (const m of data) {
              // materials Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í∏∞Ï°¥ Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú Î≥ÄÌôò (door ‚Üí door_color)
              const cat = this._categoryMap[m.category] || m.category;
              if (!this.options[cat]) this.options[cat] = [];
              this.options[cat].push({
                name_ko: m.color_name,
                name_en: m.color_name_en || '',
                color_hex: m.color_hex || null,
                prompt_description: m.texture_prompt,
                texture_prompt: m.texture_prompt,
                applicable_to: m.applicable_to || [],
                texture_url: m.thumbnail_url || null,
                image_public_url: m.thumbnail_url || null,
                finish: m.finish || null,
              });
            }
            this.loaded = true;
            console.log('[Catalog] Loaded', data.length, 'materials from Supabase (v3)');
          } catch (e) {
            console.warn('[Catalog] Load failed, using hardcoded fallback:', e.message);
            this._loadFallback();
          }
        },

        _loadFromFurnitureOptions(data) {
          this.options = {};
          for (const opt of data) {
            if (!this.options[opt.category]) this.options[opt.category] = [];
            this.options[opt.category].push(opt);
          }
          this.loaded = true;
          console.log('[Catalog] Loaded', data.length, 'options from furniture_options (legacy)');
        },

        _loadFallback() {
          this.options = {
            door_color: [
              { name_ko: 'ÌôîÏù¥Ìä∏', name_en: 'white', color_hex: '#f5f5f5', prompt_description: 'pure white, smooth flat surface with zero wood grain, dead matte finish with no reflection, uniform solid color', texture_prompt: 'pure white, smooth flat surface with zero wood grain, dead matte finish with no reflection, uniform solid color', applicable_to: ['sink','wardrobe','fridge'], texture_url: null },
              { name_ko: 'Í∑∏Î†àÏù¥', name_en: 'gray', color_hex: '#9e9e9e', prompt_description: 'neutral medium gray, smooth flat surface with zero wood grain, matte finish, uniform solid color', texture_prompt: 'neutral medium gray, smooth flat surface with zero wood grain, matte finish, uniform solid color without warm or cool cast', applicable_to: ['sink','wardrobe','fridge'], texture_url: null },
              { name_ko: 'Î≤†Ïù¥ÏßÄ', name_en: 'beige', color_hex: '#d4c4b0', prompt_description: 'warm beige with subtle sand undertone, smooth flat surface, soft matte finish', texture_prompt: 'warm beige with subtle sand undertone, smooth flat surface with zero wood grain, soft matte finish, uniform solid color', applicable_to: ['sink','wardrobe','fridge'], texture_url: null },
              { name_ko: 'ÏõîÎÑõ', name_en: 'walnut', color_hex: '#5d4037', prompt_description: 'dark walnut wood grain laminate, realistic horizontal wood grain pattern, rich brown tones', texture_prompt: 'dark walnut wood grain laminate, realistic horizontal wood grain pattern, rich brown tones, matte natural wood finish', applicable_to: ['sink','wardrobe'], texture_url: null },
              { name_ko: 'Ïò§ÌÅ¨', name_en: 'oak', color_hex: '#c4a35a', prompt_description: 'natural light oak wood grain laminate, visible straight grain pattern, warm honey tones', texture_prompt: 'natural light oak wood grain laminate, visible straight grain pattern, warm honey tones, matte oiled wood finish', applicable_to: ['sink','wardrobe'], texture_url: null },
              { name_ko: 'ÎÑ§Ïù¥ÎπÑ', name_en: 'navy', color_hex: '#1a237e', prompt_description: 'deep navy blue, smooth flat surface with zero wood grain, dead matte finish', texture_prompt: 'deep navy blue, smooth flat surface with zero wood grain, dead matte finish with no reflection, rich saturated color', applicable_to: ['sink'], texture_url: null },
              { name_ko: 'Î∏îÎûô', name_en: 'black', color_hex: '#2c2c2c', prompt_description: 'matte black, smooth flat surface with zero wood grain, dead matte finish', texture_prompt: 'matte black, smooth flat surface with zero wood grain, dead matte finish absorbing light, deep solid black', applicable_to: ['sink','wardrobe','fridge'], texture_url: null },
            ],
            door_finish: [
              { name_ko: 'Î¨¥Í¥ë', name_en: 'matte', prompt_description: 'dead matte finish with zero reflection, smooth flat surface', texture_prompt: 'dead matte finish with zero reflection, smooth flat surface, no sheen under any lighting angle', applicable_to: ['sink','wardrobe','fridge'] },
              { name_ko: 'Ïú†Í¥ë', name_en: 'glossy', prompt_description: 'high-gloss mirror-like finish with sharp reflections', texture_prompt: 'high-gloss mirror-like finish with sharp reflections, smooth polished surface, visible light bounce', applicable_to: ['sink','wardrobe','fridge'] },
              { name_ko: 'Ïó†Î≥¥', name_en: 'embossed', prompt_description: 'textured embossed surface with subtle tactile pattern', texture_prompt: 'textured embossed surface with subtle tactile pattern, low sheen satin finish, visible micro-texture under raking light', applicable_to: ['sink','wardrobe'] },
            ],
            handle: [
              { name_ko: 'Ï∞¨ÎÑ¨ (Î™©Ï∞¨ÎÑ¨)', name_en: 'channel', prompt_description: 'routed wooden channel handle at door top edge, 52mm front depth x 40mm underside grip, shadow gap underneath', texture_prompt: 'routed wooden channel handle at door top edge, 52mm front depth x 40mm underside grip, shadow gap underneath, same finish as door face', applicable_to: ['sink'] },
              { name_ko: 'CÏ∞¨ÎÑ¨', name_en: 'c-channel', prompt_description: 'aluminum C-channel recessed handle, anodized silver finish, slim integrated profile', texture_prompt: 'aluminum C-channel recessed handle at door top edge, anodized silver finish, slim integrated profile creating shadow line', applicable_to: ['sink'] },
              { name_ko: 'Ïä§ÎßàÌä∏Î∞î', name_en: 'smartbar', prompt_description: 'aluminum smart bar handle, slim rectangular cross-section, matte silver', texture_prompt: 'aluminum smart bar handle, slim rectangular cross-section, matte silver anodized finish, 128mm center-to-center mounting', applicable_to: ['sink','wardrobe'] },
              { name_ko: 'Ìë∏Ïâ¨ ÎèÑÏñ¥', name_en: 'push-open', prompt_description: 'handleless push-to-open, completely flat door surface, no visible hardware', texture_prompt: 'handleless push-to-open mechanism, completely flat door surface, no visible hardware, 3mm shadow gap between doors', applicable_to: ['sink','wardrobe'] },
            ],
            sink: [
              { name_ko: 'ÏÇ¨Í∞ÅÎ≥º 850', name_en: 'square-850', prompt_description: 'stainless steel rectangular undermount sink bowl 850mm wide, brushed satin finish', texture_prompt: 'stainless steel rectangular undermount sink bowl 850mm wide, brushed satin finish, sharp square corners, single deep basin' },
              { name_ko: 'ÏÇ¨Í∞ÅÎ≥º 800', name_en: 'square-800', prompt_description: 'stainless steel rectangular undermount sink bowl 800mm wide, brushed satin finish', texture_prompt: 'stainless steel rectangular undermount sink bowl 800mm wide, brushed satin finish, sharp square corners, single deep basin' },
              { name_ko: 'ÎùºÏö¥ÎìúÎ≥º', name_en: 'round', prompt_description: 'stainless steel round undermount sink bowl 480mm diameter, brushed satin finish', texture_prompt: 'stainless steel round undermount sink bowl 480mm diameter, brushed satin finish, smooth curved basin' },
            ],
            faucet: [
              { name_ko: 'Í±∞ÏúÑÎ™© ÏàòÏ†Ñ', name_en: 'gooseneck', prompt_description: 'tall gooseneck kitchen faucet, arched spout, single lever pull-down sprayer', texture_prompt: 'tall gooseneck kitchen faucet, arched spout, chrome or matte black finish, single lever pull-down sprayer' },
              { name_ko: '„Ñ±Ïûê ÏàòÏ†Ñ', name_en: 'l-shaped', prompt_description: 'L-shaped angular kitchen faucet, 90-degree bent spout, chrome finish', texture_prompt: 'L-shaped angular kitchen faucet, 90-degree bent spout, chrome finish, single lever control' },
              { name_ko: 'ÏùºÎ∞ò ÏàòÏ†Ñ', name_en: 'standard', prompt_description: 'standard straight kitchen faucet, simple upright spout, chrome finish', texture_prompt: 'standard straight kitchen faucet, simple upright spout, chrome finish, single lever control' },
            ],
            hood: [
              { name_ko: 'ÌûàÎì† ÌõÑÎìú', name_en: 'hidden', prompt_description: 'built-in concealed range hood hidden inside upper cabinet, NOT visible externally', texture_prompt: 'built-in concealed range hood hidden inside upper cabinet, NOT visible externally, cabinet door covers the hood completely' },
              { name_ko: 'Ïπ®Îãà ÌõÑÎìú', name_en: 'chimney', prompt_description: 'wall-mounted chimney range hood, stainless steel canopy with vertical duct cover', texture_prompt: 'wall-mounted chimney range hood, stainless steel canopy with vertical duct cover to ceiling, modern pyramid shape' },
              { name_ko: 'Ïä¨ÎùºÏù¥Îî© ÌõÑÎìú', name_en: 'sliding', prompt_description: 'slide-out range hood under upper cabinet, thin profile, pull-out visor panel', texture_prompt: 'slide-out range hood under upper cabinet, thin profile, pull-out visor panel, stainless steel or matching cabinet finish' },
            ],
            cooktop: [
              { name_ko: 'Ïù∏ÎçïÏÖò', name_en: 'induction', prompt_description: 'flush-mount induction cooktop with smooth black ceramic glass surface', texture_prompt: 'flush-mount induction cooktop with smooth black ceramic glass surface, white printed zone markings, touch controls at front edge' },
              { name_ko: 'Í∞ÄÏä§Ïø°ÌÉë', name_en: 'gas', prompt_description: 'built-in gas cooktop with cast iron grates, stainless steel surface', texture_prompt: 'built-in gas cooktop with cast iron grates, stainless steel surface, 3 or 4 burners with metal knob controls' },
              { name_ko: 'ÌïòÏù¥ÎùºÏù¥Ìä∏', name_en: 'highlight', prompt_description: 'electric radiant highlight cooktop with smooth black ceramic glass surface', texture_prompt: 'electric radiant highlight cooktop with smooth black ceramic glass surface, glowing red heating zones, touch controls' },
            ],
            countertop: [
              { name_ko: 'Ïä§ÎÖ∏Ïö∞', name_en: 'snow white', color_hex: '#FAFAFA', prompt_description: 'pure white engineered quartz countertop with subtle micro-flecks, polished surface', texture_prompt: 'pure white engineered quartz countertop with subtle micro-flecks, polished surface, clean bullnose edge profile, 20mm overhang', texture_url: null },
              { name_ko: 'ÎßàÎ∏îÌôîÏù¥Ìä∏', name_en: 'marble white', color_hex: '#F0F0F0', prompt_description: 'white marble-look engineered stone countertop with delicate grey veining', texture_prompt: 'white marble-look engineered stone countertop with delicate grey veining, polished surface, natural stone appearance, bullnose edge', texture_url: null },
              { name_ko: 'Í∑∏Î†àÏù¥ÎßàÎ∏î', name_en: 'gray marble', color_hex: '#B0B0B0', prompt_description: 'gray marble-look engineered stone countertop with dramatic veining', texture_prompt: 'gray marble-look engineered stone countertop with dramatic white and charcoal veining, polished surface, bullnose edge', texture_url: null },
              { name_ko: 'Ï∞®ÏΩú', name_en: 'charcoal', color_hex: '#404040', prompt_description: 'dark charcoal engineered stone countertop, matte honed finish', texture_prompt: 'dark charcoal engineered stone countertop, near-black with subtle aggregate texture, matte honed finish, bullnose edge', texture_url: null },
            ],
          };
          this.loaded = true;
        },

        getOptions(category, furnitureType) {
          const opts = this.options[category] || [];
          if (!furnitureType) return opts;
          return opts.filter(o => !o.applicable_to?.length || o.applicable_to.includes(furnitureType));
        },

        buildOptionsHtml(category, selectedValue, furnitureType) {
          return this.getOptions(category, furnitureType)
            .map(o => `<option value="${o.name_ko}" ${o.name_ko === selectedValue ? 'selected' : ''}>${o.name_ko}</option>`)
            .join('');
        },

        getPromptDescription(category, nameKo) {
          return (this.options[category] || []).find(o => o.name_ko === nameKo)?.prompt_description || nameKo;
        },

        getTexturePrompt(category, nameKo) {
          const opt = (this.options[category] || []).find(o => o.name_ko === nameKo);
          return opt?.texture_prompt || opt?.prompt_description || nameKo;
        },

        getImageUrl(category, nameKo) {
          return (this.options[category] || []).find(o => o.name_ko === nameKo)?.image_public_url || null;
        },

        getColorHex(category, nameKo) {
          return (this.options[category] || []).find(o => o.name_ko === nameKo)?.color_hex || null;
        },

        getTextureUrl(category, nameKo) {
          return (this.options[category] || []).find(o => o.name_ko === nameKo)?.texture_url || null;
        }
      };

      // Ï¥àÍ∏∞ Ìè¥Î∞± Î°úÎìú (Supabase Ïó∞Í≤∞ Ï†ÑÏóêÎèÑ Î†åÎçîÎßÅ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
      FurnitureOptionCatalog._loadFallback();

      // ============================================================
      // LayoutRenderer - ÏàòÏπò Í∏∞Î∞ò Canvas Î†àÏù¥ÏïÑÏõÉ Î†åÎçîÎü¨ (v2: ÌÖçÏä§Ï≤ò + ÎßàÏä§ÌÅ¨)
      // mm Îç∞Ïù¥ÌÑ∞ ‚Üí Ï†ïÍ∑úÌôî ÎπÑÏú® ‚Üí Canvas ÌîΩÏÖÄ ‚Üí base64 PNG
      // Stage 1: ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Íµ¨Ï°∞ Î†åÎçîÎßÅ (ÌÖçÏä§Ï≤ò Ìå®ÌÑ¥ + 3D Ìå®ÎÑê Ìö®Í≥º)
      // Stage 2: AI Ïù∏ÌéòÏù∏ÌåÖÏö© ÎßàÏä§ÌÅ¨ ÏÉùÏÑ± (Í∞ÄÍµ¨ ÌëúÎ©¥ = Ìù∞ÏÉâ, ÎÇòÎ®∏ÏßÄ = Í≤ÄÏ†ï)
      // ============================================================
      const LayoutRenderer = {
        _textureCache: {},   // { url: HTMLImageElement } - Î°úÎìúÎêú ÌÖçÏä§Ï≤ò Ï∫êÏãú
        _loadingPromises: {}, // ÏßÑÌñâ Ï§ëÏù∏ Î°úÎìú Î∞©ÏßÄ

        // ‚îÄ‚îÄ‚îÄ ÌÖçÏä§Ï≤ò Ïù¥ÎØ∏ÏßÄ ÌîÑÎ¶¨Î°úÎìú ‚îÄ‚îÄ‚îÄ
        async _loadTexture(url) {
          if (!url) return null;
          if (this._textureCache[url]) return this._textureCache[url];
          if (this._loadingPromises[url]) return this._loadingPromises[url];

          this._loadingPromises[url] = new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
              this._textureCache[url] = img;
              delete this._loadingPromises[url];
              resolve(img);
            };
            img.onerror = () => {
              delete this._loadingPromises[url];
              resolve(null); // Ïã§Ìå® Ïãú null ‚Üí Ìè¥Î∞± ÏÉâÏÉÅ ÏÇ¨Ïö©
            };
            img.src = url;
          });
          return this._loadingPromises[url];
        },

        // ‚îÄ‚îÄ‚îÄ Î™®Îì† ÌïÑÏöîÌïú ÌÖçÏä§Ï≤ò ÌîÑÎ¶¨Î°úÎìú ‚îÄ‚îÄ‚îÄ
        async _preloadTextures(specs) {
          const urls = [];
          const upperTex = FurnitureOptionCatalog.getTextureUrl('door_color', specs.doorColorUpper);
          const lowerTex = FurnitureOptionCatalog.getTextureUrl('door_color', specs.doorColorLower);
          const countertopTex = FurnitureOptionCatalog.getTextureUrl('countertop', specs.topColor);
          if (upperTex) urls.push(upperTex);
          if (lowerTex) urls.push(lowerTex);
          if (countertopTex) urls.push(countertopTex);
          await Promise.all(urls.map(u => this._loadTexture(u)));
          return { upperTex, lowerTex, countertopTex };
        },

        // ‚îÄ‚îÄ‚îÄ ÏàòÏπò Îç∞Ïù¥ÌÑ∞ ‚Üí Ï†ïÍ∑úÌôî Ï¢åÌëú (0~1) Î≥ÄÌôò ‚îÄ‚îÄ‚îÄ
        computeLayout(cabinetSpecs, upperModules, lowerModules) {
          const totalW = cabinetSpecs.total_width_mm || 3600;
          const totalH = cabinetSpecs.total_height_mm || 2400;

          const moldingH = cabinetSpecs.molding_height || 60;
          const upperH = cabinetSpecs.upper_cabinet_height || 720;
          const lowerH = cabinetSpecs.lower_cabinet_height || 870;
          const toeKickH = cabinetSpecs.leg_height || 150;
          const countertopH = cabinetSpecs.countertop_thickness || 20;
          const backsplashH = totalH - moldingH - upperH - lowerH - toeKickH - countertopH;

          const ny = (mm) => mm / totalH;
          const nx = (mm) => mm / totalW;

          let y = 0;
          const layout = {
            aspectRatio: totalW / totalH,
            totalW_mm: totalW,
            totalH_mm: totalH,
            molding:     { y: y, h: ny(moldingH) },
            upper:       { y: (y += ny(moldingH)), h: ny(upperH), modules: [] },
            backsplash:  { y: (y += ny(upperH)), h: ny(Math.max(backsplashH, 0)) },
            countertop:  { y: (y += ny(Math.max(backsplashH, 0))), h: ny(countertopH) },
            lower:       { y: (y += ny(countertopH)), h: ny(lowerH), modules: [] },
            toeKick:     { y: (y += ny(lowerH)), h: ny(toeKickH) },
          };

          // ÏÉÅÎ∂Ä Î™®Îìà Ï†ïÍ∑úÌôî
          for (const m of (upperModules || [])) {
            layout.upper.modules.push({
              x: nx(m.position_from_left_mm || 0),
              w: nx(m.width_mm || parseInt(m.w) || 0),
              type: m.is_drawer ? 'drawer' : 'door',
              doorCount: m.door_count || 1,
              name: m.name || '',
            });
          }

          // ÌïòÎ∂Ä Î™®Îìà Ï†ïÍ∑úÌôî
          for (const m of (lowerModules || [])) {
            layout.lower.modules.push({
              x: nx(m.position_from_left_mm || 0),
              w: nx(m.width_mm || parseInt(m.w) || 0),
              type: m.is_drawer ? 'drawer' : 'door',
              doorCount: m.door_count || 1,
              hasSink: m.has_sink || false,
              hasCooktop: m.has_cooktop || false,
              name: m.name || '',
            });
          }

          return layout;
        },

        // ‚îÄ‚îÄ‚îÄ Î©îÏù∏ Î†åÎçîÎßÅ (async: ÌÖçÏä§Ï≤ò ÏßÄÏõê) ‚îÄ‚îÄ‚îÄ
        // ÎèôÍ∏∞ Ìè¥Î∞±: ÌÖçÏä§Ï≤ò ÏóÜÏù¥ Ï¶âÏãú Î†åÎçîÎßÅ (Í∏∞Ï°¥ Ìò∏Ìôò)
        render(cabinetSpecs, upperModules, lowerModules, specs) {
          return this._renderInternal(cabinetSpecs, upperModules, lowerModules, specs, {}, false);
        },

        // ÎπÑÎèôÍ∏∞ ÌÖçÏä§Ï≤ò Î†åÎçîÎßÅ (ÌîÑÎ¶¨ÎØ∏ÏóÑ ÌîÑÎ¶¨Î∑∞Ïö©)
        async renderWithTextures(cabinetSpecs, upperModules, lowerModules, specs) {
          const texUrls = await this._preloadTextures(specs);
          return this._renderInternal(cabinetSpecs, upperModules, lowerModules, specs, texUrls, false);
        },

        // ‚îÄ‚îÄ‚îÄ ÎßàÏä§ÌÅ¨ Î†åÎçîÎßÅ (Í∞ÄÍµ¨=Ìù∞ÏÉâ, ÎÇòÎ®∏ÏßÄ=Í≤ÄÏ†ï) ‚îÄ‚îÄ‚îÄ
        renderMask(cabinetSpecs, upperModules, lowerModules, specs) {
          return this._renderInternal(cabinetSpecs, upperModules, lowerModules, specs, {}, true);
        },

        // ‚îÄ‚îÄ‚îÄ ÎÇ¥Î∂Ä Î†åÎçîÎßÅ ÏóîÏßÑ ‚îÄ‚îÄ‚îÄ
        _renderInternal(cabinetSpecs, upperModules, lowerModules, specs, texUrls, isMask) {
          const layout = this.computeLayout(cabinetSpecs, upperModules, lowerModules);

          const canvasW = 1024;
          const canvasH = Math.round(canvasW / layout.aspectRatio);

          const canvas = document.createElement('canvas');
          canvas.width = canvasW;
          canvas.height = canvasH;
          const ctx = canvas.getContext('2d');

          // ÌîΩÏÖÄ Î≥ÄÌôò Ìó¨Ìçº
          const pxY = (n) => Math.round(n * canvasH);
          const pxX = (n) => Math.round(n * canvasW);

          if (isMask) {
            // ÎßàÏä§ÌÅ¨ Î™®Îìú: Î∞∞Í≤Ω Í≤ÄÏ†ï
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvasW, canvasH);
          } else {
            ctx.clearRect(0, 0, canvasW, canvasH);
          }

          // Ïπ¥ÌÉàÎ°úÍ∑∏ÏóêÏÑú ÏÉâÏÉÅ Í∞ÄÏ†∏Ïò§Í∏∞
          const upperColor = FurnitureOptionCatalog.getColorHex('door_color', specs.doorColorUpper) || '#f5f5f5';
          const lowerColor = FurnitureOptionCatalog.getColorHex('door_color', specs.doorColorLower) || '#f5f5f5';
          const countertopColor = FurnitureOptionCatalog.getColorHex('countertop', specs.topColor) || '#FAFAFA';

          // ÌÖçÏä§Ï≤ò Ìå®ÌÑ¥ ÏÉùÏÑ± Ìó¨Ìçº
          const getPattern = (texUrl, fallbackColor) => {
            if (isMask) return '#ffffff';
            const img = texUrl ? this._textureCache[texUrl] : null;
            if (img) {
              try { return ctx.createPattern(img, 'repeat') || fallbackColor; }
              catch (e) { return fallbackColor; }
            }
            return fallbackColor;
          };

          const upperFill = getPattern(texUrls.upperTex, upperColor);
          const lowerFill = getPattern(texUrls.lowerTex, lowerColor);
          const countertopFill = getPattern(texUrls.countertopTex, countertopColor);

          // ‚ïê‚ïê‚ïê Î™∞Îî© ‚ïê‚ïê‚ïê
          const moldY = pxY(layout.molding.y), moldH = pxY(layout.molding.h);
          if (isMask) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, moldY, canvasW, moldH);
          } else {
            // Î™∞Îî© Í∑∏ÎùºÎîîÏñ∏Ìä∏ (ÏïΩÍ∞Ñ ÏûÖÏ≤¥Í∞ê)
            const moldGrad = ctx.createLinearGradient(0, moldY, 0, moldY + moldH);
            moldGrad.addColorStop(0, '#e0e0e0');
            moldGrad.addColorStop(0.5, '#c8c8c8');
            moldGrad.addColorStop(1, '#b8b8b8');
            ctx.fillStyle = moldGrad;
            ctx.fillRect(0, moldY, canvasW, moldH);
            this._drawBorder(ctx, 0, moldY, canvasW, moldH);
          }

          // ‚ïê‚ïê‚ïê ÏÉÅÎ∂ÄÏû• Î™®Îìà ‚ïê‚ïê‚ïê
          const upperY = pxY(layout.upper.y);
          const upperH = pxY(layout.upper.h);
          if (layout.upper.modules.length > 0) {
            for (const mod of layout.upper.modules) {
              const x = pxX(mod.x), w = pxX(mod.w);
              if (isMask) {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x, upperY, w, upperH);
              } else {
                ctx.fillStyle = upperFill;
                ctx.fillRect(x, upperY, w, upperH);
                this._drawPanelEffect(ctx, x, upperY, w, upperH, upperColor);
                this._drawDoorLines(ctx, mod, x, upperY, w, upperH);
                // ÎèÑÏñ¥Î≥Ñ ÏÜêÏû°Ïù¥
                this._drawHandles(ctx, mod, x, upperY, w, upperH, specs.handle);
              }
            }
          } else {
            ctx.fillStyle = isMask ? '#ffffff' : upperFill;
            ctx.fillRect(0, upperY, canvasW, upperH);
            if (!isMask) this._drawPanelEffect(ctx, 0, upperY, canvasW, upperH, upperColor);
          }

          // ‚ïê‚ïê‚ïê Î∞±Ïä§ÌîåÎûòÏãú (Î≤ΩÎ©¥ ÎÖ∏Ï∂ú) ‚ïê‚ïê‚ïê
          const bsY = pxY(layout.backsplash.y);
          const bsH = pxY(layout.backsplash.h);
          if (bsH > 0 && !isMask) {
            // ÌÉÄÏùº Ìå®ÌÑ¥ (Í≤©Ïûê ÎäêÎÇå)
            ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
            ctx.fillRect(0, bsY, canvasW, bsH);
            ctx.strokeStyle = 'rgba(220, 220, 220, 0.6)';
            ctx.lineWidth = 0.5;
            const tileSize = 24;
            for (let tx = 0; tx < canvasW; tx += tileSize) {
              ctx.beginPath(); ctx.moveTo(tx, bsY); ctx.lineTo(tx, bsY + bsH); ctx.stroke();
            }
            for (let ty = bsY; ty < bsY + bsH; ty += tileSize) {
              ctx.beginPath(); ctx.moveTo(0, ty); ctx.lineTo(canvasW, ty); ctx.stroke();
            }
          }
          // ÎßàÏä§ÌÅ¨: Î∞±Ïä§ÌîåÎûòÏãúÎäî Í≤ÄÏ†ï (Î≤ΩÏù¥ÎØÄÎ°ú Ïù∏ÌéòÏù∏Ìä∏ Î∂àÌïÑÏöî)

          // ‚ïê‚ïê‚ïê ÏÉÅÌåê ‚ïê‚ïê‚ïê
          const ctY = pxY(layout.countertop.y);
          const ctH = Math.max(pxY(layout.countertop.h), 4);
          if (isMask) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, ctY, canvasW, ctH);
          } else {
            ctx.fillStyle = countertopFill;
            ctx.fillRect(0, ctY, canvasW, ctH);
            // ÏÉÅÌåê Ïó£ÏßÄ ÌïòÏù¥ÎùºÏù¥Ìä∏
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.fillRect(0, ctY, canvasW, 1);
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0, ctY + ctH - 1, canvasW, 1);
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, ctY, canvasW, ctH);
          }

          // ‚ïê‚ïê‚ïê ÌïòÎ∂ÄÏû• Î™®Îìà ‚ïê‚ïê‚ïê
          const lowerY = pxY(layout.lower.y);
          const lowerH = pxY(layout.lower.h);
          if (layout.lower.modules.length > 0) {
            for (const mod of layout.lower.modules) {
              const x = pxX(mod.x), w = pxX(mod.w);

              if (isMask) {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x, lowerY, w, lowerH);
              } else {
                ctx.fillStyle = lowerFill;
                ctx.fillRect(x, lowerY, w, lowerH);
                this._drawPanelEffect(ctx, x, lowerY, w, lowerH, lowerColor);

                if (mod.type === 'drawer') {
                  this._drawDrawerLines(ctx, x, lowerY, w, lowerH, specs.handle);
                } else {
                  this._drawDoorLines(ctx, mod, x, lowerY, w, lowerH);
                  this._drawHandles(ctx, mod, x, lowerY, w, lowerH, specs.handle);
                }
              }

              // Ïã±ÌÅ¨Î≥º (ÎßàÏä§ÌÅ¨ÏóêÏÑúÎäî Ìù∞ÏÉâ)
              if (mod.hasSink) {
                if (isMask) {
                  // Ïã±ÌÅ¨ÎèÑ Í∞ÄÍµ¨ ÌëúÎ©¥ ÏòÅÏó≠ÏúºÎ°ú Ìè¨Ìï®
                } else {
                  this._drawSink(ctx, mod, x, w, ctY, lowerH, specs);
                }
              }

              // Ïø°ÌÉë (ÎßàÏä§ÌÅ¨ÏóêÏÑúÎäî Ìù∞ÏÉâ)
              if (mod.hasCooktop) {
                if (isMask) {
                  // Ïø°ÌÉëÎèÑ Í∞ÄÍµ¨ ÌëúÎ©¥ ÏòÅÏó≠ÏúºÎ°ú Ìè¨Ìï®
                } else {
                  this._drawCooktop(ctx, mod, x, w, ctY, lowerH, specs);
                }
              }
            }
          } else {
            ctx.fillStyle = isMask ? '#ffffff' : lowerFill;
            ctx.fillRect(0, lowerY, canvasW, lowerH);
            if (!isMask) this._drawPanelEffect(ctx, 0, lowerY, canvasW, lowerH, lowerColor);
          }

          // ‚ïê‚ïê‚ïê ÌÜ†ÌÇ• ‚ïê‚ïê‚ïê
          const tkY = pxY(layout.toeKick.y);
          const tkH = pxY(layout.toeKick.h);
          if (isMask) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, tkY, canvasW, tkH);
          } else {
            const tkGrad = ctx.createLinearGradient(0, tkY, 0, tkY + tkH);
            tkGrad.addColorStop(0, '#333');
            tkGrad.addColorStop(1, '#1a1a1a');
            ctx.fillStyle = tkGrad;
            ctx.fillRect(0, tkY, canvasW, tkH);
          }

          // ‚ïê‚ïê‚ïê ÏπòÏàò ÎùºÎ≤® (ÎßàÏä§ÌÅ¨ÏóêÎäî ÌëúÏãú ÏïàÌï®) ‚ïê‚ïê‚ïê
          if (!isMask) {
            this._drawDimensionLabels(ctx, layout, canvasW, canvasH);
          }

          const dataUrl = canvas.toDataURL('image/png');
          return dataUrl.split(',')[1];
        },

        // ‚îÄ‚îÄ‚îÄ 3D Ìå®ÎÑê Ìö®Í≥º (Î≤†Î≤® + Í∑∏Î¶ºÏûê) ‚îÄ‚îÄ‚îÄ
        _drawPanelEffect(ctx, x, y, w, h, baseColor) {
          // Ïù∏ÏÖã Ìå®Îî© (ÎèÑÏñ¥ Ìå®ÎÑê ÎäêÎÇå)
          const pad = 3;
          // ÏÉÅÎã® ÌïòÏù¥ÎùºÏù¥Ìä∏
          ctx.fillStyle = 'rgba(255,255,255,0.25)';
          ctx.fillRect(x + pad, y + pad, w - pad * 2, 2);
          // Ï¢åÏ∏° ÌïòÏù¥ÎùºÏù¥Ìä∏
          ctx.fillRect(x + pad, y + pad, 2, h - pad * 2);
          // ÌïòÎã® Í∑∏Î¶ºÏûê
          ctx.fillStyle = 'rgba(0,0,0,0.12)';
          ctx.fillRect(x + pad, y + h - pad - 2, w - pad * 2, 2);
          // Ïö∞Ï∏° Í∑∏Î¶ºÏûê
          ctx.fillRect(x + w - pad - 2, y + pad, 2, h - pad * 2);
          // ÌÖåÎëêÎ¶¨
          this._drawBorder(ctx, x, y, w, h);
        },

        // ‚îÄ‚îÄ‚îÄ ÏÜêÏû°Ïù¥ Î†åÎçîÎßÅ ‚îÄ‚îÄ‚îÄ
        _drawHandles(ctx, mod, x, y, w, h, handleType) {
          const count = mod.doorCount || 1;
          const doorW = w / count;
          const handleH = Math.min(h * 0.12, 40);
          const handleW = 3;

          for (let i = 0; i < count; i++) {
            const doorX = x + doorW * i;
            let hx, hy;

            if (handleType === 'Ìë∏Ïâ¨ ÎèÑÏñ¥' || handleType === 'push-open') {
              continue; // Ìï∏Îì§Î¶¨Ïä§
            }

            if (handleType === 'Ïä§ÎßàÌä∏Î∞î' || handleType === 'smartbar') {
              // ÏÉÅÎã® Í∞ÄÎ°ú Î∞î
              const barW = doorW * 0.6;
              hx = doorX + (doorW - barW) / 2;
              hy = y + 6;
              ctx.fillStyle = '#aaa';
              ctx.fillRect(hx, hy, barW, 3);
              ctx.fillStyle = 'rgba(255,255,255,0.3)';
              ctx.fillRect(hx, hy, barW, 1);
              continue;
            }

            // Í∏∞Î≥∏ ÏÑ∏Î°ú Ìï∏Îì§ (Ï∞¨ÎÑ¨ / CÏ∞¨ÎÑ¨)
            // ÎèÑÏñ¥ Ï§ëÏïôÎ∂ÄÏóê ÏÑ∏Î°ú Ìï∏Îì§
            if (count > 1) {
              // 2ÎèÑÏñ¥: Ï§ëÏïô Í≤ΩÍ≥Ñ Î∂ÄÍ∑º
              hx = (i === 0) ? doorX + doorW - 12 : doorX + 8;
            } else {
              hx = doorX + doorW / 2;
            }
            hy = y + (h - handleH) / 2;

            // Í∑∏Î¶ºÏûê
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(hx + 1, hy + 1, handleW, handleH);
            // Ìï∏Îì§ Î≥∏Ï≤¥
            const hGrad = ctx.createLinearGradient(hx, hy, hx + handleW, hy);
            hGrad.addColorStop(0, '#c0c0c0');
            hGrad.addColorStop(0.5, '#e8e8e8');
            hGrad.addColorStop(1, '#a0a0a0');
            ctx.fillStyle = hGrad;
            ctx.fillRect(hx, hy, handleW, handleH);
          }
        },

        // ‚îÄ‚îÄ‚îÄ Ïã±ÌÅ¨Î≥º (Í∞úÏÑ†) ‚îÄ‚îÄ‚îÄ
        _drawSink(ctx, mod, modX, modW, countertopY, lowerH, specs) {
          const sw = modW * 0.65, sh = lowerH * 0.09;
          const sx = modX + (modW - sw) / 2;
          const sy = countertopY - sh - 1;

          // Ïã±ÌÅ¨ Î≥∏Ï≤¥ (Ïä§ÌÖåÏù∏Î¶¨Ïä§ Í∑∏ÎùºÎîîÏñ∏Ìä∏)
          const sGrad = ctx.createLinearGradient(sx, sy, sx, sy + sh);
          sGrad.addColorStop(0, '#c8cdd2');
          sGrad.addColorStop(0.3, '#b8bfc6');
          sGrad.addColorStop(0.7, '#a8b0b8');
          sGrad.addColorStop(1, '#98a0a8');
          ctx.fillStyle = sGrad;
          this._roundRect(ctx, sx, sy, sw, sh, 4);
          ctx.fill();

          // Ïã±ÌÅ¨ ÎÇ¥Î∂Ä Ìôà
          const innerPad = 4;
          ctx.fillStyle = 'rgba(0,0,0,0.08)';
          this._roundRect(ctx, sx + innerPad, sy + innerPad, sw - innerPad * 2, sh - innerPad * 2, 2);
          ctx.fill();

          // Î∞∞ÏàòÍµ¨
          const drainX = sx + sw / 2, drainY = sy + sh * 0.6;
          ctx.beginPath();
          ctx.arc(drainX, drainY, 4, 0, Math.PI * 2);
          ctx.fillStyle = '#707880';
          ctx.fill();
          ctx.beginPath();
          ctx.arc(drainX, drainY, 2, 0, Math.PI * 2);
          ctx.fillStyle = '#505860';
          ctx.fill();

          // ÌÖåÎëêÎ¶¨
          ctx.strokeStyle = '#8890a0';
          ctx.lineWidth = 1;
          this._roundRect(ctx, sx, sy, sw, sh, 4);
          ctx.stroke();

          // ÏàòÏ†Ñ (Í±∞ÏúÑÎ™© Ïä§ÌÉÄÏùº)
          const faucetX = modX + modW / 2;
          const faucetBaseY = sy - 2;

          // ÏàòÏ†Ñ Î≤†Ïù¥Ïä§
          ctx.fillStyle = '#b0b0b0';
          ctx.fillRect(faucetX - 4, faucetBaseY - 4, 8, 6);

          // ÏàòÏ†Ñ Í∏∞Îë•
          const fGrad = ctx.createLinearGradient(faucetX - 3, 0, faucetX + 3, 0);
          fGrad.addColorStop(0, '#a0a0a0');
          fGrad.addColorStop(0.5, '#d0d0d0');
          fGrad.addColorStop(1, '#909090');
          ctx.fillStyle = fGrad;
          ctx.fillRect(faucetX - 2, faucetBaseY - 18, 4, 16);

          // ÏàòÏ†Ñ Î™© (Í≥°ÏÑ†)
          ctx.strokeStyle = '#b8b8b8';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(faucetX, faucetBaseY - 18);
          ctx.quadraticCurveTo(faucetX + 12, faucetBaseY - 22, faucetX + 10, faucetBaseY - 12);
          ctx.stroke();

          // ÏàòÏ†Ñ ÌïòÏù¥ÎùºÏù¥Ìä∏
          ctx.strokeStyle = 'rgba(255,255,255,0.4)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(faucetX - 1, faucetBaseY - 16);
          ctx.lineTo(faucetX - 1, faucetBaseY - 4);
          ctx.stroke();
        },

        // ‚îÄ‚îÄ‚îÄ Ïø°ÌÉë (Í∞úÏÑ†) ‚îÄ‚îÄ‚îÄ
        _drawCooktop(ctx, mod, modX, modW, countertopY, lowerH, specs) {
          const cw = modW * 0.65, ch = lowerH * 0.07;
          const cx = modX + (modW - cw) / 2;
          const cy = countertopY - ch - 1;

          // Ïø°ÌÉë Í∏ÄÎûòÏä§ ÌëúÎ©¥
          const cGrad = ctx.createLinearGradient(cx, cy, cx, cy + ch);
          cGrad.addColorStop(0, '#1a1a1a');
          cGrad.addColorStop(0.5, '#2a2a2a');
          cGrad.addColorStop(1, '#111');
          ctx.fillStyle = cGrad;
          this._roundRect(ctx, cx, cy, cw, ch, 4);
          ctx.fill();

          // Í∏ÄÎûòÏä§ Î∞òÏÇ¨
          ctx.fillStyle = 'rgba(255,255,255,0.06)';
          this._roundRect(ctx, cx + 2, cy + 1, cw - 4, ch / 2, 3);
          ctx.fill();

          // Î≤ÑÎÑà ÏõêÌòï 4Í∞ú (ÎèôÏã¨Ïõê)
          const spacing = cw / 5;
          const burnerR = ch * 0.32;
          for (let i = 1; i <= 4; i++) {
            const bx = cx + spacing * i, by = cy + ch / 2;
            // Ïô∏Î∂Ä ÎßÅ
            ctx.strokeStyle = 'rgba(100,100,100,0.6)';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(bx, by, burnerR, 0, Math.PI * 2);
            ctx.stroke();
            // ÎÇ¥Î∂Ä ÎßÅ
            ctx.strokeStyle = 'rgba(80,80,80,0.5)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(bx, by, burnerR * 0.55, 0, Math.PI * 2);
            ctx.stroke();
            // Ï§ëÏïô Ï†ê
            ctx.beginPath();
            ctx.arc(bx, by, 1.5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(60,60,60,0.8)';
            ctx.fill();
          }

          // ÌÖåÎëêÎ¶¨
          ctx.strokeStyle = 'rgba(60,60,60,0.5)';
          ctx.lineWidth = 1;
          this._roundRect(ctx, cx, cy, cw, ch, 4);
          ctx.stroke();
        },

        // ‚îÄ‚îÄ‚îÄ Ìó¨Ìçº: ÌÖåÎëêÎ¶¨ ‚îÄ‚îÄ‚îÄ
        _drawBorder(ctx, x, y, w, h) {
          ctx.strokeStyle = 'rgba(0,0,0,0.2)';
          ctx.lineWidth = 1;
          ctx.strokeRect(x + 0.5, y + 0.5, w - 1, h - 1);
        },

        // ‚îÄ‚îÄ‚îÄ Ìó¨Ìçº: ÎèÑÏñ¥ Î∂ÑÌï†ÏÑ† ‚îÄ‚îÄ‚îÄ
        _drawDoorLines(ctx, mod, x, y, w, h) {
          const count = mod.doorCount || 1;
          if (count <= 1) return;
          const doorW = w / count;
          for (let i = 1; i < count; i++) {
            const lx = x + doorW * i;
            // Í∑∏Î¶ºÏûê (Ïò§Î•∏Ï™Ω)
            ctx.strokeStyle = 'rgba(0,0,0,0.15)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(lx + 1, y + 2);
            ctx.lineTo(lx + 1, y + h - 2);
            ctx.stroke();
            // Ï£º Î∂ÑÌï†ÏÑ†
            ctx.strokeStyle = 'rgba(0,0,0,0.25)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(lx + 0.5, y);
            ctx.lineTo(lx + 0.5, y + h);
            ctx.stroke();
            // ÌïòÏù¥ÎùºÏù¥Ìä∏ (ÏôºÏ™Ω)
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(lx - 0.5, y + 2);
            ctx.lineTo(lx - 0.5, y + h - 2);
            ctx.stroke();
          }
        },

        // ‚îÄ‚îÄ‚îÄ Ìó¨Ìçº: ÏÑúÎûç ÏàòÌèâÏÑ† ‚îÄ‚îÄ‚îÄ
        _drawDrawerLines(ctx, x, y, w, h, handleType) {
          const drawerCount = Math.max(Math.round(h / 60), 2);
          const dh = h / drawerCount;
          for (let i = 1; i < drawerCount; i++) {
            const ly = y + dh * i;
            // Í∑∏Î¶ºÏûê
            ctx.strokeStyle = 'rgba(0,0,0,0.15)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + 4, ly + 1);
            ctx.lineTo(x + w - 4, ly + 1);
            ctx.stroke();
            // Ï£º Î∂ÑÌï†ÏÑ†
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + 4, ly + 0.5);
            ctx.lineTo(x + w - 4, ly + 0.5);
            ctx.stroke();
            // ÌïòÏù¥ÎùºÏù¥Ìä∏
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + 4, ly - 0.5);
            ctx.lineTo(x + w - 4, ly - 0.5);
            ctx.stroke();
          }

          // ÏÑúÎûç ÏÜêÏû°Ïù¥ (Í∞Å ÏÑúÎûç Ï§ëÏïô)
          if (handleType === 'Ìë∏Ïâ¨ ÎèÑÏñ¥' || handleType === 'push-open') return;
          for (let i = 0; i < drawerCount; i++) {
            const dy = y + dh * i;
            const centerX = x + w / 2;
            const centerY = dy + dh / 2;

            if (handleType === 'Ïä§ÎßàÌä∏Î∞î' || handleType === 'smartbar') {
              // Í∞ÄÎ°ú Ïä§ÎßàÌä∏Î∞î
              const barW = w * 0.4;
              ctx.fillStyle = '#aaa';
              ctx.fillRect(centerX - barW / 2, centerY - 1.5, barW, 3);
              ctx.fillStyle = 'rgba(255,255,255,0.3)';
              ctx.fillRect(centerX - barW / 2, centerY - 1.5, barW, 1);
            } else {
              // Í∏∞Î≥∏ Í∞ÄÎ°ú Ìï∏Îì§
              const barW = Math.min(w * 0.25, 60);
              const hGrad = ctx.createLinearGradient(0, centerY - 1.5, 0, centerY + 1.5);
              hGrad.addColorStop(0, '#d0d0d0');
              hGrad.addColorStop(1, '#a0a0a0');
              ctx.fillStyle = hGrad;
              ctx.fillRect(centerX - barW / 2, centerY - 1.5, barW, 3);
            }
          }
        },

        // ‚îÄ‚îÄ‚îÄ Ìó¨Ìçº: Îë•Í∑º ÏÇ¨Í∞ÅÌòï ‚îÄ‚îÄ‚îÄ
        _roundRect(ctx, x, y, w, h, r) {
          ctx.beginPath();
          ctx.moveTo(x + r, y);
          ctx.lineTo(x + w - r, y);
          ctx.quadraticCurveTo(x + w, y, x + w, y + r);
          ctx.lineTo(x + w, y + h - r);
          ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
          ctx.lineTo(x + r, y + h);
          ctx.quadraticCurveTo(x, y + h, x, y + h - r);
          ctx.lineTo(x, y + r);
          ctx.quadraticCurveTo(x, y, x + r, y);
          ctx.closePath();
        },

        // ‚îÄ‚îÄ‚îÄ Ìó¨Ìçº: ÏπòÏàò ÎùºÎ≤® ‚îÄ‚îÄ‚îÄ
        _drawDimensionLabels(ctx, layout, canvasW, canvasH) {
          ctx.font = '11px Arial';
          ctx.fillStyle = '#e74c3c';
          ctx.textAlign = 'left';
          const lx = canvasW - 80;

          const labels = [
            { name: 'molding', text: Math.round(layout.totalH_mm * layout.molding.h) + '' },
            { name: 'upper', text: Math.round(layout.totalH_mm * layout.upper.h) + '' },
            { name: 'countertop', text: Math.round(layout.totalH_mm * layout.countertop.h) + '' },
            { name: 'lower', text: Math.round(layout.totalH_mm * layout.lower.h) + '' },
            { name: 'toeKick', text: Math.round(layout.totalH_mm * layout.toeKick.h) + '' },
          ];

          for (const l of labels) {
            const sec = layout[l.name];
            const midY = Math.round((sec.y + sec.h / 2) * canvasH);
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(lx - 4, midY - 8, 78, 16);
            ctx.fillStyle = '#fff';
            ctx.fillText(l.text + 'mm', lx, midY + 4);
          }

          // Ï†ÑÏ≤¥ ÎÑàÎπÑ ÎùºÎ≤® (ÌïòÎã®)
          ctx.fillStyle = 'rgba(0,0,0,0.5)';
          ctx.fillRect(canvasW / 2 - 40, canvasH - 20, 80, 18);
          ctx.fillStyle = '#fff';
          ctx.textAlign = 'center';
          ctx.fillText(layout.totalW_mm + 'mm', canvasW / 2, canvasH - 6);
        },

        // ‚îÄ‚îÄ‚îÄ Ï†ïÍ∑úÌôî Î†àÏù¥ÏïÑÏõÉ Îç∞Ïù¥ÌÑ∞ JSON ‚îÄ‚îÄ‚îÄ
        getLayoutData(cabinetSpecs, upperModules, lowerModules) {
          return this.computeLayout(cabinetSpecs, upperModules, lowerModules);
        }
      };

      // ============================================================
      // Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÉÅÏàò
      // ============================================================
      const CATEGORIES = [
        { id: 'sink', name: 'Ïã±ÌÅ¨ÎåÄ', defaultD: 650 },
        { id: 'island', name: 'ÏïÑÏùºÎûúÎìú', defaultD: 800 },
        { id: 'wardrobe', name: 'Î∂ôÎ∞ïÏù¥Ïû•', defaultD: 650 },
        { id: 'fridge', name: 'ÎÉâÏû•Í≥†Ïû•', defaultD: 700 },
        { id: 'shoerack', name: 'Ïã†Î∞úÏû•', defaultD: 350 },
        { id: 'vanity', name: 'ÌôîÏû•ÎåÄ', defaultD: 500 },
        { id: 'storage', name: 'ÏàòÎÇ©Ïû•', defaultD: 400 },
        { id: 'warehouse', name: 'Ï∞ΩÍ≥†Ïû•', defaultD: 450 },
        { id: 'door', name: 'ÎèÑÏñ¥ÍµêÏ≤¥', defaultD: 18 },
        { id: 'custom', name: 'ÎπÑÍ∑úÍ≤©Ïû•', defaultD: 0 },
      ];

      // ‚òÖ Rule 10: Í∑†Îì±Î∂ÑÎ∞∞ ÏÉÅÏàò (v28 ÏóÖÎç∞Ïù¥Ìä∏)
      const DOOR_TARGET_WIDTH = 450; // Î™©Ìëú ÎèÑÏñ¥ ÎÑàÎπÑ (Ïã±ÌÅ¨ÎåÄ)
      const DOOR_MAX_WIDTH = 600; // ÏµúÎåÄ ÎèÑÏñ¥ ÎÑàÎπÑ
      const DOOR_MIN_WIDTH = 350; // ‚òÖ ÏµúÏÜå ÎèÑÏñ¥ ÎÑàÎπÑ (NEW)
      const MIN_REMAINDER = 4; // ‚òÖ ÏµúÏÜå ÏûîÏó¨ (0‚Üí4)
      const MAX_REMAINDER = 10; // ÏµúÎåÄ ÏûîÏó¨

      const DEFAULT_SPECS = {
        layoutShape: 'I',
        doorColorUpper: 'ÌôîÏù¥Ìä∏',
        doorFinishUpper: 'Î¨¥Í¥ë',
        doorColorLower: 'ÌôîÏù¥Ìä∏',
        doorFinishLower: 'Î¨¥Í¥ë',
        topColor: 'Ïä§ÎÖ∏Ïö∞',
        topThickness: 12,
        upperH: 720,
        lowerH: 870,
        moldingH: 60,
        sinkLegHeight: 150,
        handle: 'Ï∞¨ÎÑ¨ (Î™©Ï∞¨ÎÑ¨)',
        sink: 'ÏÇ¨Í∞ÅÎ≥º 850',
        faucet: 'Í±∞ÏúÑÎ™© ÏàòÏ†Ñ',
        hood: 'ÌûàÎì† ÌõÑÎìú',
        cooktop: 'Ïù∏ÎçïÏÖò',
        dishwasher: 'None',
        accessories: [{ id: Date.now(), type: 'LTMesh' }],
        // Ïã§Ï∏° Í∏∞Ï§Ä = Î∂ÑÎ∞∞Í∏∞ Í∏∞Ï§Ä = Ïû• Í∏∞Ï§Ä
        measurementBase: 'Left',
        distributorStart: 0,
        distributorEnd: 0,
        ventStart: 0,
        finishLeftType: 'Filler',
        finishLeftWidth: 60,
        finishRightType: 'Filler',
        finishRightWidth: 60,
        finishCorner1Type: 'Filler',
        finishCorner1Width: 60,
        finishCorner2Type: 'Filler',
        finishCorner2Width: 60,
        topSizes: [''],
        effectiveUpperW: null,
        effectiveLowerW: null,
        // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû• Ï†ÑÏö© ÏÑ§Ï†ï
        curtainBoxW: 0,
        curtainBoxH: 0,
        wardrobePedestal: 60, // Ï¢åÎåÄ ÎÜíÏù¥ (Í∏∞Î≥∏ 60mm)
        wardrobeMoldingH: 15, // ÏÉÅÎ™∞Îî© ÎÜíÏù¥ (Í∏∞Î≥∏ 15mm)
        // ‚òÖ ÎÉâÏû•Í≥†Ïû• Ï†ÑÏö© ÏÑ§Ï†ï (Í∑úÏπô Í∏∞Î∞ò)
        fridgeBrand: 'LG',
        fridgeUpperH: 415, // ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥ (Í≥†Ï†ï)
        fridgeLowerH: 870, // ÌïòÎ∂ÄÏû• ÎÜíÏù¥ (Ï¢åÎåÄ 60 Ìè¨Ìï®)
        fridgePedestal: 60, // Ï¢åÎåÄ ÎÜíÏù¥
        fridgeGap: 50, // ÎÉâÏû•Í≥† Ï¢åÏö∞ Ïó¨Ïú† Í∞ÑÍ≤©
        fridgeModuleD: 550, // Î™®Îìà Í∏∞Î≥∏ ÍπäÏù¥
        fridgeInstallD: 700, // ÏÑ§Ïπò ÌïÑÏöî ÍπäÏù¥
      };

      // ‚òÖ ÎÉâÏû•Í≥†Ïû• Í∑úÏπô ÏÉÅÏàò (ÏóÖÎç∞Ïù¥Ìä∏)
      const FRIDGE_RULES = {
        MAX_UPPER_H: 400, // ÏÉÅÎ∂ÄÏû• ÏµúÎåÄ ÎÜíÏù¥
        PEDESTAL_H: 60, // Ï¢åÎåÄ ÎÜíÏù¥
        LEG_H: 60, // Îã§Î¶¨Î∞ú ÎÜíÏù¥
        LOWER_BODY_H: 810, // ÌïòÎ∂ÄÏû• Î™®Îìà ÎÜíÏù¥ (Îã§Î¶¨ Ï†úÏô∏)
        MODULE_D: 550, // Î™®Îìà Í∏∞Î≥∏ ÍπäÏù¥
        INSTALL_D: 700, // ÏÑ§Ïπò ÌïÑÏöî ÍπäÏù¥
        TOP_GAP: 15, // ÎÉâÏû•Í≥† ÏÉÅÎã® Í∞ÑÍ≤© (Í≥†Ï†ï)
        MOLDING_H: 50, // ÏÉÅÎ™∞Îî© Í∏∞Î≥∏ ÎÜíÏù¥
        EL_W: 600, // ÌÇ§ÌÅ∞Ïû•/ELÏû• Í∏∞Î≥∏ Ìè≠
        HOMECAFE_W: 600, // ÌôàÏπ¥ÌéòÏû• Í∏∞Î≥∏ Ìè≠
        // Ïó¨Ïú†Í≥µÍ∞Ñ Í∏∞Î≥∏Í∞í
        DEFAULT_GAPS: {
          LG_BUILTIN: { side: 4, between: 8 },
          LG_FREESTANDING: { side: 50, between: 0 },
          SS_BESPOKE: { side: 12, between: 10 },
          SS_INFINITE: { side: 5, between: 10 },
          SS_FREESTANDING: { side: 50, between: 0 },
        },
      };

      // ‚òÖ ÎÉâÏû•Í≥†Ïû• Îã§Î¶¨ ÌÉÄÏûÖ
      const FRIDGE_LEG_TYPES = [
        { id: 'pedestal', name: 'Ï¢åÎåÄ', defaultH: 60 },
        { id: 'leg', name: 'Îã§Î¶¨Î∞ú', defaultH: 60 },
      ];

      // ‚òÖ ÎÉâÏû•Í≥† Î™®Îç∏ Îç∞Ïù¥ÌÑ∞ (Ïó¨Ïú†Í≥µÍ∞Ñ Ï†ïÎ≥¥ Ìè¨Ìï®)
      // ‚òÖ ÎÉâÏû•Í≥† Î™®Îç∏ Îç∞Ïù¥ÌÑ∞ (Í∞úÎ≥Ñ ÎèÑÏñ¥ Ï†ïÎ≥¥ Ìè¨Ìï®)
      const FRIDGE_DATA = {
        LG: {
          name: 'LG',
          categories: {
            'Îã®ÎèÖ (Fit&Max)': [
              {
                id: 'lg_300l',
                name: 'Îã®ÎèÖ 300L',
                w: 595,
                h: 1780,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '300L', w: 595 }],
              },
              {
                id: 'lg_400l',
                name: 'Îã®ÎèÖ 400L',
                w: 595,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '400L', w: 595 }],
              },
              {
                id: 'lg_500l',
                name: 'Îã®ÎèÖ 500L',
                w: 700,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '500L', w: 700 }],
              },
              {
                id: 'lg_600l',
                name: 'Îã®ÎèÖ 600L',
                w: 700,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '600L', w: 700 }],
              },
            ],
            'ÏÑ∏Ìä∏ (Fit&Max)': [
              {
                id: 'lg_set_1d1d',
                name: '1ÎèÑÏñ¥+1ÎèÑÏñ¥',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'lg_set_1d1d1d',
                name: '1ÎèÑÏñ¥√ó3',
                w: 1809,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'lg_set_300_1d',
                name: '300+1ÎèÑÏñ¥',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '300L', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'lg_set_400_1d',
                name: '400+1ÎèÑÏñ¥',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '400L', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'lg_set_500_1d',
                name: '500+1ÎèÑÏñ¥',
                w: 1408,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '1ÎèÑÏñ¥', w: 700 },
                ],
              },
              {
                id: 'lg_set_500_300',
                name: '500+300',
                w: 1303,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '300L', w: 595 },
                ],
              },
              {
                id: 'lg_set_500_400',
                name: '500+400',
                w: 1303,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '400L', w: 595 },
                ],
              },
              {
                id: 'lg_set_600_300',
                name: '600+300',
                w: 1303,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '600L', w: 700 },
                  { name: '300L', w: 595 },
                ],
              },
              {
                id: 'lg_set_600_400',
                name: '600+400',
                w: 1303,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '600L', w: 700 },
                  { name: '400L', w: 595 },
                ],
              },
            ],
            ÎπåÌä∏Ïù∏: [
              {
                id: 'lg_builtin_fridge_1d',
                name: 'ÎÉâÏû•Í≥†+1ÎèÑÏñ¥',
                w: 1568,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ÎÉâÏû•Í≥†', w: 897 },
                  { name: '1ÎèÑÏñ¥', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_kimchi_1d',
                name: 'ÍπÄÏπò+1ÎèÑÏñ¥',
                w: 1309,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ÍπÄÏπò', w: 649 },
                  { name: '1ÎèÑÏñ¥', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_fridge_kimchi',
                name: 'ÎÉâÏû•+ÍπÄÏπò',
                w: 1612,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ÎÉâÏû•', w: 897 },
                  { name: 'ÍπÄÏπò', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_fridge_kimchi_1d',
                name: 'ÎÉâÏû•+ÍπÄÏπò+1ÎèÑÏñ¥',
                w: 2272,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ÎÉâÏû•', w: 897 },
                  { name: 'ÍπÄÏπò', w: 649 },
                  { name: '1ÎèÑÏñ¥', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_1d3',
                name: '1ÎèÑÏñ¥√ó3',
                w: 2013,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 649 },
                  { name: '1ÎèÑÏñ¥', w: 649 },
                  { name: '1ÎèÑÏñ¥', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_mood',
                name: 'Î¨¥ÎìúÎÉâÏû•+Î¨¥ÎìúÍπÄÏπò',
                w: 1612,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'Î¨¥ÎìúÎÉâÏû•', w: 897 },
                  { name: 'Î¨¥ÎìúÍπÄÏπò', w: 649 },
                ],
              },
            ],
            ÌîÑÎ¶¨Ïä§ÌÉ†Îî©: [
              {
                id: 'lg_free_600_side',
                name: 'ÎÉâÏû•Í≥†600 ÏñëÎ¨∏Ìòï',
                w: 913,
                h: 1790,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ÏñëÎ¨∏Ìòï600', w: 913 }],
              },
              {
                id: 'lg_free_800_side',
                name: 'ÎÉâÏû•Í≥†800 ÏñëÎ¨∏Ìòï',
                w: 913,
                h: 1820,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ÏñëÎ¨∏Ìòï800', w: 913 }],
              },
              {
                id: 'lg_free_800_topbot',
                name: 'ÎÉâÏû•Í≥†800 ÏÉÅÎÉâÏû•ÌïòÎÉâÎèô',
                w: 913,
                h: 1820,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ÏÉÅÌïòÎÉâÏû•', w: 913 }],
              },
            ],
            Î™®ÎçòÏó£ÏßÄ: [
              {
                id: 'lg_modern_1d1d',
                name: 'Î™®ÎçòÏó£ÏßÄ+1ÎèÑÏñ¥√ó2',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: 'Î™®ÎçòÏó£ÏßÄ', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
            ],
          },
        },
        Samsung: {
          name: 'ÏÇºÏÑ±',
          categories: {
            'Bespoke ÎÉâÏû•Í≥†': [
              {
                id: 'ss_bespoke_1d',
                name: '1ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '1ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_bespoke_2d',
                name: '2ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '2ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_bespoke_4d',
                name: '4ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 912,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '4ÎèÑÏñ¥', w: 912 }],
              },
            ],
            'Bespoke ÍπÄÏπòÌîåÎü¨Ïä§': [
              {
                id: 'ss_kimchi_1d',
                name: '1ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ÍπÄÏπò1ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_kimchi_3d',
                name: '3ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 695,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ÍπÄÏπò3ÎèÑÏñ¥', w: 695 }],
              },
              {
                id: 'ss_kimchi_4d',
                name: '4ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 912,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ÍπÄÏπò4ÎèÑÏñ¥', w: 912 }],
              },
            ],
            'Bespoke ÌÇ§ÏπúÌïè ÏÑ∏Ìä∏': [
              {
                id: 'ss_kf_2d1d',
                name: '2ÎèÑÏñ¥+1ÎèÑÏñ¥',
                w: 1200,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '2ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_kf_4d1d',
                name: '4ÎèÑÏñ¥+1ÎèÑÏñ¥',
                w: 1517,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ÎèÑÏñ¥', w: 912 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_kf_4d3d',
                name: '4ÎèÑÏñ¥+3ÎèÑÏñ¥',
                w: 1617,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ÎèÑÏñ¥', w: 912 },
                  { name: '3ÎèÑÏñ¥', w: 695 },
                ],
              },
              {
                id: 'ss_kf_4d3d1d',
                name: '4ÎèÑÏñ¥+3ÎèÑÏñ¥+1ÎèÑÏñ¥',
                w: 2222,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ÎèÑÏñ¥', w: 912 },
                  { name: '3ÎèÑÏñ¥', w: 695 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_kf_1d3',
                name: '1ÎèÑÏñ¥√ó3',
                w: 1805,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_kf_1d4',
                name: '1ÎèÑÏñ¥√ó4',
                w: 2410,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_kf_max',
                name: 'Max 4ÎèÑÏñ¥+4ÎèÑÏñ¥',
                w: 1834,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ÎèÑÏñ¥', w: 912 },
                  { name: '4ÎèÑÏñ¥', w: 912 },
                ],
              },
            ],
            'Bespoke ÌîÑÎ¶¨Ïä§ÌÉ†Îî©': [
              {
                id: 'ss_bespoke_4d_free',
                name: '4ÎèÑÏñ¥ ÌîÑÎ¶¨Ïä§ÌÉ†Îî©',
                w: 912,
                h: 1853,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: '4ÎèÑÏñ¥FS', w: 912 }],
              },
              {
                id: 'ss_kimchi_4d_free',
                name: 'ÍπÄÏπò 4ÎèÑÏñ¥ ÌîÑÎ¶¨Ïä§ÌÉ†Îî©',
                w: 912,
                h: 1853,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ÍπÄÏπò4ÎèÑÏñ¥FS', w: 912 }],
              },
            ],
            'Infinite Line ÎÉâÏû•Í≥†': [
              {
                id: 'ss_inf_1d',
                name: '1ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 595,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: '1ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_inf_4d',
                name: '4ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 912,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: '4ÎèÑÏñ¥', w: 912 }],
              },
            ],
            'Infinite Line ÍπÄÏπòÌîåÎü¨Ïä§': [
              {
                id: 'ss_inf_kimchi_1d',
                name: '1ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 595,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: 'ÍπÄÏπò1ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_inf_kimchi_4d',
                name: '4ÎèÑÏñ¥ ÌÇ§ÏπúÌïè',
                w: 912,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: 'ÍπÄÏπò4ÎèÑÏñ¥', w: 912 }],
              },
            ],
            'Infinite Line ÌÇ§ÏπúÌïè ÏÑ∏Ìä∏': [
              {
                id: 'ss_inf_1d1d',
                name: '1ÎèÑÏñ¥+1ÎèÑÏñ¥',
                w: 1200,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_inf_1d3',
                name: '1ÎèÑÏñ¥√ó3',
                w: 1815,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_inf_1d4',
                name: '1ÎèÑÏñ¥√ó4',
                w: 2420,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                  { name: '1ÎèÑÏñ¥', w: 595 },
                ],
              },
              {
                id: 'ss_inf_4d4d',
                name: '4ÎèÑÏñ¥+4ÎèÑÏñ¥',
                w: 1834,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '4ÎèÑÏñ¥', w: 912 },
                  { name: '4ÎèÑÏñ¥', w: 912 },
                ],
              },
            ],
            'Infinite Line ÌîÑÎ¶¨Ïä§ÌÉ†Îî©': [
              {
                id: 'ss_inf_4d_free',
                name: '4ÎèÑÏñ¥ ÌîÑÎ¶¨Ïä§ÌÉ†Îî©',
                w: 912,
                h: 1855,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: '4ÎèÑÏñ¥FS', w: 912 }],
              },
            ],
            'ÍπÄÏπòÌîåÎü¨Ïä§ Ïä§ÌÉ†Îìú': [
              {
                id: 'ss_stand_3d',
                name: 'Ïä§ÌÉ†ÎìúÌòï 3ÎèÑÏñ¥',
                w: 595,
                h: 1380,
                d: 688,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'Ïä§ÌÉ†Îìú3ÎèÑÏñ¥', w: 595 }],
              },
              {
                id: 'ss_stand_4d',
                name: 'Ïä§ÌÉ†ÎìúÌòï 4ÎèÑÏñ¥',
                w: 595,
                h: 1530,
                d: 688,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'Ïä§ÌÉ†Îìú4ÎèÑÏñ¥', w: 595 }],
              },
            ],
            ÏñëÎ¨∏Ìòï: [
              {
                id: 'ss_rs70',
                name: 'RS70',
                w: 912,
                h: 1780,
                d: 716,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS70', w: 912 }],
              },
              {
                id: 'ss_rs80f',
                name: 'RS80F',
                w: 912,
                h: 1780,
                d: 716,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS80F', w: 912 }],
              },
              {
                id: 'ss_rs84',
                name: 'RS84',
                w: 912,
                h: 1825,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS84', w: 912 }],
              },
            ],
          },
        },
      };

      // ‚òÖ ELÏû• ÎèÑÏñ¥ ÌÉÄÏûÖ (5Í∞ÄÏßÄ)
      const EL_DOOR_TYPES = [
        { id: 'liftup', name: 'Î¶¨ÌîÑÌä∏ÏóÖ' },
        { id: 'flap', name: 'ÌîåÎû©ÎèÑÏñ¥' },
        { id: 'pocket', name: 'Ìè¨ÏºìÎèÑÏñ¥' },
        { id: 'swing', name: 'Ïó¨Îã´Ïù¥' },
        { id: 'sliding', name: 'Ïä¨ÎùºÏù¥Îî©' },
      ];

      // ‚òÖ ÎèÑÏñ¥ Íµ¨Î∂Ñ ÌÉÄÏûÖ (3Í∞ÄÏßÄ)
      const DOOR_DIVISION_TYPES = [
        { id: 'individual', name: 'Í∞úÎ≥Ñ' },
        { id: 'midLower', name: 'Ï§ëÍ∞ÑÏû•„ÜçÌïòÎ∂ÄÏû•' },
        { id: 'all', name: 'Ï†ÑÏ≤¥' },
      ];

      // ‚òÖ ÎßàÍ∞ê ÌÉÄÏûÖ (Î™∞Îî©, Ìú†Îùº, EP, ÏóÜÏùå)
      const FINISH_TYPES = [
        { id: 'Molding', name: 'Î™∞Îî©', defaultW: 60, editable: true },
        { id: 'Filler', name: 'Ìú†Îùº', defaultW: 60, editable: true },
        { id: 'EP', name: 'EP', defaultW: 20, editable: false },
        { id: 'None', name: 'ÏóÜÏùå', defaultW: 0, editable: false },
      ];

      // ‚òÖ ÎèÑÏñ¥ ÏÉâÏÉÅ Îß§Ìïë
      const DOOR_COLOR_MAP = {
        ÌôîÏù¥Ìä∏: '#f5f5f5',
        Í∑∏Î†àÏù¥: '#9e9e9e',
        Î≤†Ïù¥ÏßÄ: '#d4c4b0',
        ÏõîÎÑõ: '#5d4037',
        Ïò§ÌÅ¨: '#c4a35a',
      };

      function getDoorColor(colorName) {
        return DOOR_COLOR_MAP[colorName] || '#f5f5f5';
      }

      // ‚òÖ ÌïòÎ∂ÄÏû• Î™®Îìà ÌÉÄÏûÖ
      const LOWER_MODULE_TYPES = [
        { id: 'default', name: 'Í∏∞Î≥∏', defaultW: 600, color: '#6b7280', icon: 'üóÑÔ∏è' },
        { id: 'robot', name: 'Î°úÎ¥áÏ≤≠ÏÜåÍ∏∞', defaultW: 600, color: '#f59e0b', icon: 'ü§ñ' },
        { id: 'foodwaste', name: 'ÏùåÏãùÎ¨ºÏ≤òÎ¶¨Í∏∞', defaultW: 450, color: '#22c55e', icon: '‚ôªÔ∏è' },
        { id: 'rice', name: 'Î∞•ÏÜ•', defaultW: 450, color: '#ef4444', icon: 'üçö' },
      ];

      let selectedItems = [];

      // ============================================================
      // Í≥µÌÜµ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
      // ============================================================

      /**
       * debounce Ïú†Ìã∏Î¶¨Ìã∞ - Ïó∞ÏÜç Ìò∏Ï∂ú Ïãú ÎßàÏßÄÎßâ Ìò∏Ï∂úÎßå Ïã§Ìñâ
       * Î†åÎçîÎßÅ ÏÑ±Îä• ÏµúÏ†ÅÌôîÎ•º ÏúÑÌï¥ ÏÇ¨Ïö©
       */
      function debounce(func, wait = 50) {
        let timeoutId = null;
        return function (...args) {
          if (timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            func.apply(this, args);
            timeoutId = null;
          }, wait);
        };
      }

      /**
       * throttle Ïú†Ìã∏Î¶¨Ìã∞ - ÏßÄÏ†ï ÏãúÍ∞Ñ ÎèôÏïà ÏµúÎåÄ 1ÌöåÎßå Ïã§Ìñâ
       */
      function throttle(func, limit = 100) {
        let inThrottle = false;
        return function (...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => (inThrottle = false), limit);
          }
        };
      }

      /**
       * Ìè¨Ïª§Ïä§ Î≥µÏõê Ìï®Ïàò - Î†åÎçîÎßÅ ÌõÑ ÏûÖÎ†• ÌïÑÎìú Ìè¨Ïª§Ïä§ Î≥µÏõê
       */
      function _restoreFocus(container, focusInfo) {
        if (!focusInfo) return;

        // requestAnimationFrameÏúºÎ°ú DOM ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ìè¨Ïª§Ïä§ Î≥µÏõê
        requestAnimationFrame(() => {
          // onchange ÎòêÎäî onblur ÏÜçÏÑ±ÏúºÎ°ú Í∞ôÏùÄ ÏöîÏÜå Ï∞æÍ∏∞
          let targetEl = null;
          if (focusInfo.onchange) {
            targetEl = container.querySelector(`input[onchange="${focusInfo.onchange}"]`);
          } else if (focusInfo.onblur) {
            targetEl = container.querySelector(`input[onblur="${focusInfo.onblur}"]`);
          }

          if (targetEl) {
            targetEl.focus();
            // ÏÑ†ÌÉù ÏòÅÏó≠ Î≥µÏõê (Ïà´Ïûê ÏûÖÎ†• ÌïÑÎìú)
            if (focusInfo.selectionStart !== null && targetEl.type !== 'number') {
              try {
                targetEl.setSelectionRange(focusInfo.selectionStart, focusInfo.selectionEnd);
              } catch (e) {
                // ÏùºÎ∂Ä input ÌÉÄÏûÖÏùÄ setSelectionRangeÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏùå
              }
            }
          }
        });
      }

      /**
       * ÏïÑÏù¥ÌÖú Ï°∞Ìöå Ìó¨Ìçº
       */
      function getItem(itemUniqueId) {
        return selectedItems.find((i) => i.uniqueId === itemUniqueId);
      }

      /**
       * Î™®Îìà Ï°∞Ìöå Ìó¨Ìçº
       */
      function getModule(itemUniqueId, modId) {
        const item = getItem(itemUniqueId);
        return item ? item.modules.find((m) => m.id === modId) : null;
      }

      /**
       * Ïä§Ìéô ÏóÖÎç∞Ïù¥Ìä∏ Í≥µÌÜµ Ìï®Ïàò
       */
      function updateItemSpec(itemUniqueId, field, value, shouldRender = true) {
        const item = getItem(itemUniqueId);
        if (!item) return null;
        item.specs[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);
        if (shouldRender) renderWorkspaceContent(item);
        return item;
      }

      /**
       * Î™®Îìà ÏóÖÎç∞Ïù¥Ìä∏ Í≥µÌÜµ Ìï®Ïàò
       */
      function updateModuleField(itemUniqueId, modId, field, value, shouldRender = true) {
        const item = getItem(itemUniqueId);
        if (!item) return null;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return null;
        mod[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);
        if (shouldRender) renderWorkspaceContent(item);
        return { item, mod };
      }

      /**
       * SVG ÏÇ¨Í∞ÅÌòï ÏÉùÏÑ± Ìó¨Ìçº
       */
      function svgRect(x, y, w, h, fill, stroke, strokeWidth = 1, rx = 0) {
        return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" rx="${rx}"/>`;
      }

      /**
       * SVG ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Ìó¨Ìçº
       */
      function svgText(x, y, text, opts = {}) {
        const anchor = opts.anchor || 'middle';
        const fontSize = opts.fontSize || 10;
        const fill = opts.fill || '#333';
        const fontWeight = opts.fontWeight || 'normal';
        return `<text x="${x}" y="${y}" text-anchor="${anchor}" font-size="${fontSize}" fill="${fill}" font-weight="${fontWeight}">${text}</text>`;
      }

      /**
       * Î≤ÑÌäº HTML ÏÉùÏÑ± Ìó¨Ìçº
       */
      function createButton(label, onclick, className = '', style = '') {
        return `<button class="${className}" onclick="${onclick}" style="${style}">${label}</button>`;
      }

      /**
       * Ïù∏Ìíã HTML ÏÉùÏÑ± Ìó¨Ìçº
       */
      function createNumberInput(value, onchange, style = 'width:60px;') {
        return `<input type="number" value="${value}" onchange="${onchange}" style="${style}">`;
      }

      // ============================================================
      // ÏµúÏ†ÅÌôî: Í≥µÌÜµ Î™®Îìà Ï°∞Ïûë Ìï®ÏàòÎì§
      // ============================================================

      /**
       * Î™®Îìà ÏòµÏÖò ÌÜ†Í∏Ä (Ï≤¥ÌÅ¨Î∞ïÏä§Ïö© - Í∏∞Ï°¥ toggleOptionÍ≥º Î≥ëÌñâ)
       */
      function toggleModuleOption(itemUniqueId, modId, field, checked) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[field] = checked;
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * Î™®Îìà Í∞í Ï°∞Ï†à (+/- Î≤ÑÌäºÏö©)
       */
      function adjustModuleValue(itemUniqueId, modId, field, delta, min = 0) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[field] = Math.max(min, (mod[field] || 0) + delta);
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * Î™®Îìà ÌÉÄÏûÖ ÏÑ§Ï†ï
       */
      function setModuleType(itemUniqueId, modId, typeField, value) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[typeField] = value;
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * ÏïÑÏù¥ÌÖú Ïä§Ìéô ÌÜ†Í∏Ä
       */
      function toggleItemSpec(itemUniqueId, field) {
        const item = getItem(itemUniqueId);
        if (item && item.specs) {
          item.specs[field] = !item.specs[field];
          renderWorkspaceContent(item);
        }
      }

      // ============================================================
      // ÏµúÏ†ÅÌôî: Î†åÎçîÎßÅ Ìó¨Ìçº Ìï®ÏàòÎì§
      // ============================================================

      /**
       * ÌÜ†Í∏Ä Î≤ÑÌäº Í∑∏Î£π Î†åÎçîÎßÅ
       * @param {number} itemId - ÏïÑÏù¥ÌÖú ID
       * @param {number} modId - Î™®Îìà ID
       * @param {Array} options - [{value, label}] Î∞∞Ïó¥
       * @param {string} currentValue - ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞í
       * @param {string} colorClass - ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ (green, blue, orange, purple)
       * @param {string} typeField - ÌÉÄÏûÖ ÌïÑÎìúÎ™Ö
       */
      function renderToggleButtons(itemId, modId, options, currentValue, colorClass, typeField = 'type') {
        return `<div class="toggle-group">${options
          .map(
            (opt) =>
              `<button class="btn-toggle ${colorClass} ${currentValue === opt.value ? 'active' : ''}"
       data-action="setType" data-item="${itemId}" data-mod="${modId}"
       data-field="${typeField}" data-value="${opt.value}">${opt.label}</button>`
          )
          .join('')}</div>`;
      }

      /**
       * Ï°∞Ï†à Ïª®Ìä∏Î°§ Î†åÎçîÎßÅ (+/- Î≤ÑÌäº)
       * @param {number} itemId - ÏïÑÏù¥ÌÖú ID
       * @param {number} modId - Î™®Îìà ID
       * @param {string} field - ÌïÑÎìúÎ™Ö
       * @param {number} value - ÌòÑÏû¨ Í∞í
       * @param {string} label - ÎùºÎ≤® (ÏÑ†ÌÉù)
       */
      function renderAdjustControl(itemId, modId, field, value, label = '') {
        return `<div class="adjust-control">
    ${label ? `<span>${label}</span>` : ''}
    <button class="btn-adjust" data-action="adjust" data-item="${itemId}"
      data-mod="${modId}" data-field="${field}" data-delta="-1">‚àí</button>
    <span class="value">${value}</span>
    <button class="btn-adjust" data-action="adjust" data-item="${itemId}"
      data-mod="${modId}" data-field="${field}" data-delta="1">+</button>
  </div>`;
      }

      /**
       * Ï≤¥ÌÅ¨Î∞ïÏä§ Î†åÎçîÎßÅ
       */
      function renderCheckbox(itemId, modId, field, checked, label) {
        return `<label class="checkbox-label">
    <input type="checkbox" ${checked ? 'checked' : ''}
      data-action="toggle" data-item="${itemId}" data-mod="${modId}" data-field="${field}">
    ${label}
  </label>`;
      }

      /**
       * Ïà´Ïûê ÏûÖÎ†• ÌïÑÎìú Î†åÎçîÎßÅ
       */
      function renderNumberInput(itemId, modId, field, value, width = '50px') {
        return `<input type="number" class="spec-input-sm" value="${value}"
    data-item="${itemId}" data-mod="${modId}" data-field="${field}"
    style="width:${width}">`;
      }

      // ============================================================
      // ÌïµÏã¨ Í≥ÑÏÇ∞ Ìï®ÏàòÎì§
      // ============================================================

      /**
       * ÎèÑÏñ¥ ÎÑàÎπÑ ÏµúÏ†ÅÌôî (v28 ÏóÖÎç∞Ïù¥Ìä∏)
       * ÏµúÏö∞ÏÑ†: 4mm ‚â§ ÏûîÏó¨Í≥µÍ∞Ñ ‚â§ 10mm
       * Ï∞®ÏÑ†: 0mm ‚â§ ÏûîÏó¨Í≥µÍ∞Ñ < 4mm (Ï†ïÌôïÌûà ÎÇòÎàÑÏñ¥ Îñ®Ïñ¥ÏßÄÎäî Í≤ΩÏö∞)
       * Í∑∏ Îã§Ïùå: 10Ïùò Îã®ÏúÑ > ÏßùÏàò
       * Ï†úÏïΩ: 350mm ‚â§ ÎèÑÏñ¥ ÎÑàÎπÑ ‚â§ 600mm
       */
      function findBestDoorWidth(totalSpace, doorCount) {
        const rawWidth = totalSpace / doorCount;

        // ‚òÖ ÎèÑÏñ¥ ÏµúÏÜå/ÏµúÎåÄ ÎÑàÎπÑ Ï†úÏïΩ ÌôïÏù∏
        if (rawWidth > DOOR_MAX_WIDTH) return null;
        if (rawWidth < DOOR_MIN_WIDTH) return null;

        const primaryCandidates = []; // 4~10mm Ï°∞Í±¥ ÎßåÏ°±
        const secondaryCandidates = []; // 0~3mm (Ï∞®ÏÑ†)

        // 10Ïùò Îã®ÏúÑ ÌõÑÎ≥¥ (ÎÇ¥Î¶º, Ïò¨Î¶º)
        const tenFloor = Math.floor(rawWidth / 10) * 10;
        const tenCeil = Math.ceil(rawWidth / 10) * 10;

        // ÏßùÏàò ÌõÑÎ≥¥ (ÎÇ¥Î¶º, Ïò¨Î¶º)
        const evenFloor = Math.floor(rawWidth / 2) * 2;
        const evenCeil = Math.ceil(rawWidth / 2) * 2;

        // ÌõÑÎ≥¥Îì§Í≥º Ïö∞ÏÑ†ÏàúÏúÑ (priority ÎÇÆÏùÑÏàòÎ°ù Ïö∞ÏÑ†)
        const allCandidates = [
          { width: tenFloor, priority: 1 },
          { width: tenCeil, priority: 1 },
          { width: evenFloor, priority: 2 },
          { width: evenCeil, priority: 2 },
        ];

        // ÌõÑÎ≥¥ Î∂ÑÎ•ò
        for (const cand of allCandidates) {
          if (cand.width < DOOR_MIN_WIDTH || cand.width > DOOR_MAX_WIDTH) continue;
          const used = cand.width * doorCount;
          const gap = totalSpace - used;
          if (gap < 0) continue;

          if (gap >= MIN_REMAINDER && gap <= MAX_REMAINDER) {
            // ‚òÖ Ïö∞ÏÑ†: 4~10mm Ï°∞Í±¥ ÎßåÏ°±
            primaryCandidates.push({ ...cand, gap });
          } else if (gap >= 0 && gap < MIN_REMAINDER) {
            // ‚òÖ Ï∞®ÏÑ†: 0~3mm (Ï†ïÌôïÌûà ÎÇòÎàÑÏñ¥ Îñ®Ïñ¥ÏßÄÎäî Í≤ΩÏö∞ Ìè¨Ìï®)
            secondaryCandidates.push({ ...cand, gap });
          }
        }

        // Ïö∞ÏÑ†ÏàúÏúÑ Ï†ïÎ†¨ Ìï®Ïàò
        const sortCandidates = (arr) => {
          arr.sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            return a.gap - b.gap;
          });
        };

        // Ïö∞ÏÑ† ÌõÑÎ≥¥ ÏÑ†ÌÉù
        if (primaryCandidates.length > 0) {
          sortCandidates(primaryCandidates);
          return primaryCandidates[0].width;
        }

        // Ï∞®ÏÑ† ÌõÑÎ≥¥ ÏÑ†ÌÉù (0~3mm)
        if (secondaryCandidates.length > 0) {
          sortCandidates(secondaryCandidates);
          return secondaryCandidates[0].width;
        }

        return null;
      }

      /**
       * Î™®Îìà Í∑†Îì± Î∂ÑÎ∞∞ Ìï®Ïàò (v28 ÏóÖÎç∞Ïù¥Ìä∏)
       * - ÏµúÏö∞ÏÑ†: 4mm ‚â§ ÏûîÏó¨Í≥µÍ∞Ñ ‚â§ 10mm
       * - Ï∞®ÏÑ†: 0mm ‚â§ ÏûîÏó¨Í≥µÍ∞Ñ < 4mm
       * - Ï†úÏïΩ: 350mm ‚â§ ÎèÑÏñ¥ ÎÑàÎπÑ ‚â§ 600mm, Î™©Ìëú ‚âà 450mm
       * - ÎèÑÏñ¥Í∞úÏàò/2 ‚Üí Î™´*2D, ÎÇòÎ®∏ÏßÄ*1D
       */
      function distributeModules(totalSpace) {
        if (totalSpace < 100) return { modules: [], doorWidth: 0, doorCount: 0 };

        // ‚òÖ ÎèÑÏñ¥ Í∞úÏàò Î≤îÏúÑ ÏÑ§Ï†ï (ÏµúÏÜå/ÏµúÎåÄ ÎèÑÏñ¥ ÎÑàÎπÑ Î∞òÏòÅ)
        const minCount = Math.max(1, Math.ceil(totalSpace / DOOR_MAX_WIDTH));
        const maxDoorCount = Math.floor(totalSpace / DOOR_MIN_WIDTH);
        const baseCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
        const maxCount = Math.min(maxDoorCount, Math.max(baseCount + 3, minCount + 5));

        // Î™®Îì† Ïú†Ìö®Ìïú Ï°∞Ìï© ÏàòÏßë
        let allResults = [];

        for (let count = minCount; count <= maxCount; count++) {
          const width = findBestDoorWidth(totalSpace, count);
          if (width !== null) {
            const gap = totalSpace - width * count;
            const targetDiff = Math.abs(width - DOOR_TARGET_WIDTH);
            const isPrimary = gap >= MIN_REMAINDER && gap <= MAX_REMAINDER;

            allResults.push({
              doorCount: count,
              doorWidth: width,
              gap,
              targetDiff,
              isPrimary, // 4~10mm Ï°∞Í±¥ ÎßåÏ°± Ïó¨Î∂Ä
            });
          }
        }

        // Ï†ïÎ†¨: isPrimary Ïö∞ÏÑ† ‚Üí targetDiff ÏûëÏùÄ Ïàú ‚Üí gap ÏûëÏùÄ Ïàú
        allResults.sort((a, b) => {
          // 1. 4~10mm Ï°∞Í±¥ ÎßåÏ°±ÌïòÎäî Í≤É Ïö∞ÏÑ†
          if (a.isPrimary !== b.isPrimary) return b.isPrimary - a.isPrimary;
          // 2. Î™©Ìëú ÎèÑÏñ¥ ÎÑàÎπÑ(450mm)Ïóê Í∞ÄÍπåÏö¥ Í≤É Ïö∞ÏÑ†
          if (a.targetDiff !== b.targetDiff) return a.targetDiff - b.targetDiff;
          // 3. ÏûîÏó¨ ÏûëÏùÄ Í≤É Ïö∞ÏÑ†
          return a.gap - b.gap;
        });

        let bestResult = allResults.length > 0 ? allResults[0] : null;

        // Í≤∞Í≥ºÍ∞Ä ÏóÜÏúºÎ©¥ Í∞ïÏ†ú Í≥ÑÏÇ∞
        if (!bestResult) {
          // Î™©Ìëú ÎèÑÏñ¥ ÎÑàÎπÑÏóê Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎèÑÏñ¥ Í∞úÏàò Í≥ÑÏÇ∞
          const idealCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
          const count = Math.max(minCount, Math.min(maxDoorCount, idealCount));
          let width = Math.floor(totalSpace / count / 2) * 2;
          width = Math.max(DOOR_MIN_WIDTH, Math.min(DOOR_MAX_WIDTH, width));
          bestResult = { doorCount: count, doorWidth: width, gap: totalSpace - width * count };
        }

        const { doorCount, doorWidth } = bestResult;
        const quotient = Math.floor(doorCount / 2);
        const remainder = doorCount % 2;

        const modules = [];
        // 2D Î™®Îìà (Î™´ Í∞ú)
        for (let i = 0; i < quotient; i++) {
          modules.push({ w: doorWidth * 2, is2D: true });
        }
        // 1D Î™®Îìà (ÎÇòÎ®∏ÏßÄ Í∞ú)
        if (remainder > 0) {
          modules.push({ w: doorWidth, is2D: false });
        }

        return { modules, doorWidth, doorCount };
      }

      /**
       * Ïú†Ìö® Í≥µÍ∞Ñ Í≥ÑÏÇ∞
       */
      function calcEffectiveSpace(item) {
        const W = parseFloat(item.w) || 0;
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        const fC1 =
          item.specs.layoutShape !== 'I' && item.specs.finishCorner1Type !== 'None'
            ? parseFloat(item.specs.finishCorner1Width) || 0
            : 0;
        const fC2 =
          item.specs.layoutShape === 'U' && item.specs.finishCorner2Type !== 'None'
            ? parseFloat(item.specs.finishCorner2Width) || 0
            : 0;
        return W - fL - fR - fC1 - fC2;
      }

      function getEffectiveSpace(item, section) {
        const manualValue = section === 'upper' ? item.specs.effectiveUpperW : item.specs.effectiveLowerW;
        if (manualValue !== null && manualValue !== '') return parseFloat(manualValue) || 0;
        return calcEffectiveSpace(item);
      }

      /**
       * Í≥†Ï†ï Î™®Îìà ÏúÑÏπò Ï°∞Ï†ï (Í≤ΩÍ≥Ñ ÎÇ¥Î°ú)
       */
      function adjustFixedPositions(fixedList, startBound, endBound) {
        fixedList.sort((a, b) => a.x - b.x);

        // ÏôºÏ™ΩÏóêÏÑú Ïò§Î•∏Ï™ΩÏúºÎ°ú Í≤πÏπ® Î∞©ÏßÄ
        let cursor = startBound;
        fixedList.forEach((mod) => {
          if (mod.x < cursor) {
            mod.x = cursor;
            mod.endX = mod.x + mod.w;
          }
          cursor = mod.endX;
        });

        // Ïò§Î•∏Ï™ΩÏóêÏÑú ÏôºÏ™ΩÏúºÎ°ú Í≤ΩÍ≥Ñ Ï°∞Ï†ï
        let rightCursor = endBound;
        for (let i = fixedList.length - 1; i >= 0; i--) {
          const mod = fixedList[i];
          if (mod.endX > rightCursor) {
            mod.endX = rightCursor;
            mod.x = mod.endX - mod.w;
          }
          rightCursor = mod.x;
        }

        return fixedList;
      }

      /**
       * Îπà Í≥µÍ∞Ñ(Gap) Í≥ÑÏÇ∞
       */
      function calculateGaps(fixedList, startBound, endBound) {
        const gaps = [];
        let cursor = startBound;

        for (const fixed of fixedList) {
          if (fixed.x > cursor + 1) {
            gaps.push({ start: cursor, end: fixed.x, width: fixed.x - cursor });
          }
          cursor = fixed.endX;
        }
        if (cursor < endBound - 1) {
          gaps.push({ start: cursor, end: endBound, width: endBound - cursor });
        }

        return gaps;
      }

      /**
       * GapÏùÑ Î™®ÎìàÎ°ú Ï±ÑÏö∞Í∏∞ (v28 ÏóÖÎç∞Ïù¥Ìä∏: ÌõÑÎìú Ï†úÏô∏ Î™®Îì† ÎèÑÏñ¥ ÎèôÏùº ÌÅ¨Í∏∞)
       * @param {Object} gap - { start, end, width }
       * @param {string} section - 'upper' | 'lower'
       * @param {number} defaultH - Í∏∞Î≥∏ ÎÜíÏù¥
       * @param {number} defaultD - Í∏∞Î≥∏ ÍπäÏù¥
       * @param {number} fixedDoorWidth - Í≥†Ï†ï ÎèÑÏñ¥ ÎÑàÎπÑ (Ï†ÑÎã¨Ïãú Ìï¥Îãπ ÎÑàÎπÑ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©)
       */
      function fillGapWithModules(gap, section, defaultH, defaultD, fixedDoorWidth = null) {
        const newModules = [];
        const namePrefix = section === 'upper' ? 'ÏÉÅÎ∂ÄÏû•' : 'ÌïòÎ∂ÄÏû•';

        if (gap.width < 100) return newModules;

        let doorWidth, doorCount;

        if (fixedDoorWidth) {
          // ‚òÖ Í≥†Ï†ï ÎèÑÏñ¥ ÎÑàÎπÑÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (Î™®Îì† ÎèÑÏñ¥ ÎèôÏùº ÌÅ¨Í∏∞)
          doorWidth = fixedDoorWidth;
          doorCount = Math.round(gap.width / fixedDoorWidth);
          if (doorCount < 1) doorCount = 1;

          // Ï†úÏïΩ Ï°∞Í±¥ÏúºÎ°ú Ïù∏Ìï¥ ÎèÑÏñ¥ Í∞úÏàò Ï°∞Ï†ïÏù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞Îßå
          if (doorWidth < DOOR_MIN_WIDTH) {
            doorCount = Math.max(1, Math.floor(gap.width / DOOR_MIN_WIDTH));
          } else if (doorWidth > DOOR_MAX_WIDTH) {
            doorCount = Math.ceil(gap.width / DOOR_MAX_WIDTH);
          }
          // ‚òÖ doorWidthÎäî Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå (ÎèôÏùº ÌÅ¨Í∏∞ Ïú†ÏßÄ)
        } else {
          // Í≥†Ï†ï ÎèÑÏñ¥ ÎÑàÎπÑÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞: Í∏∞Ï°¥ Î∂ÑÎ∞∞Í∑úÏπô Ï†ÅÏö©
          const result = distributeModules(gap.width);
          doorWidth = result.doorWidth;
          doorCount = result.doorCount;
        }

        // Î™®Îìà ÏÉùÏÑ± (ÎèÑÏñ¥Í∞úÏàò/2 ‚Üí Î™´*2D + ÎÇòÎ®∏ÏßÄ*1D)
        const quotient = Math.floor(doorCount / 2);
        const mod1D = doorCount % 2;

        let dx = gap.start;

        // 2D Î™®Îìà (Î™´ Í∞ú) - Î™®Îëê ÎèôÏùºÌïú ÎèÑÏñ¥ ÎÑàÎπÑ √ó 2
        for (let i = 0; i < quotient; i++) {
          const w = doorWidth * 2;
          newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, true, dx));
          dx += w;
        }

        // 1D Î™®Îìà (ÎÇòÎ®∏ÏßÄ Í∞ú) - ÎèôÏùºÌïú ÎèÑÏñ¥ ÎÑàÎπÑ
        if (mod1D > 0) {
          const w = doorWidth;
          newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, false, dx));
          dx += w;
        }

        // ‚òÖ ÏûîÏó¨ Í≥µÍ∞ÑÏùÄ ÏãúÍ≥µ Ïó¨Ïú†Î°ú Ï≤òÎ¶¨ (Î™®Îìà ÎÑàÎπÑÏóê Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå)

        return newModules;
      }

      /**
       * Î™®Îìà Í∞ùÏ≤¥ ÏÉùÏÑ± Ìó¨Ìçº
       */
      function createModule(pos, namePrefix, w, h, d, is2D, x) {
        return {
          id: Date.now() + Math.random(),
          type: 'storage',
          name: `${namePrefix}(${is2D ? '2D' : '1D'})`,
          pos,
          w,
          h,
          d,
          doorCount: is2D ? 2 : 1,
          isDrawer: false,
          isEL: false,
          isFixed: false,
          _x: x,
        };
      }

      /**
       * ÏûîÏó¨ Í≥µÍ∞Ñ ÏÉâÏÉÅ (v28: 0~10mmÍ∞Ä ÎÖπÏÉâ)
       */
      function getRemainColor(remaining) {
        if (remaining < 0 || remaining > MAX_REMAINDER + 5) return '#ff4d4f'; // ÏùåÏàò ÎòêÎäî 15mm Ï¥àÍ≥º
        if (remaining >= 0 && remaining <= MAX_REMAINDER) return '#00c853'; // 0~10mm ÎÖπÏÉâ
        return '#4a7dff'; // 11~15mm ÌååÎûÄÏÉâ
      }

      // ============================================================
      // ÏÑπÏÖò ÏûêÎèô Í≥ÑÏÇ∞ Ìï®Ïàò
      // ============================================================

      /**
       * ÏûêÎèôÍ≥ÑÏÇ∞ Î°úÏßÅ ÏöîÏïΩ (v28 ÏóÖÎç∞Ïù¥Ìä∏):
       *
       * 1. Ïú†Ìö®Í≥µÍ∞Ñ = Ï†ÑÏ≤¥ÎÑàÎπÑ - ÎßàÍ∞êÎì§
       * 2. Í≥†Ï†ï Î™®Îìà ÏàòÏßë Î∞è ÏúÑÏπò Í≤∞Ï†ï
       *    - ÌïòÎ∂Ä: Í∞úÏàòÎåÄ(Î∂ÑÎ∞∞Í∏∞ÏãúÏûë-100), Í∞ÄÏä§ÎåÄ(ÌôòÌíçÍµ¨Ï§ëÏïô), LTÎßùÏû•(Í∞ÄÏä§ÎåÄÏòÜ+Î®ºÏ™Ω)
       *    - ÏÉÅÎ∂Ä: ÌõÑÎìú(ÌôòÌíçÍµ¨Ï§ëÏïô), Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû•(Í∞úÏàòÎåÄ Ï§ëÏïô Ï†ïÎ†¨, 2D)
       * 3. Í∞úÏàòÎåÄ ÎÖºÎ¶¨Ï°∞Í±¥ Í≤ÄÏ¶ù: ÏãúÏûë<Î∂ÑÎ∞∞Í∏∞ÏãúÏûë AND ÎÅù>Î∂ÑÎ∞∞Í∏∞ÎÅù
       * 4. Gap Í≥ÑÏÇ∞ Î∞è Í∑†Îì±Î∂ÑÎ∞∞
       *    - ÏµúÏö∞ÏÑ†: 4mm ‚â§ ÏûîÏó¨ ‚â§ 10mm
       *    - Ï∞®ÏÑ†: 0mm ‚â§ ÏûîÏó¨ < 4mm
       *    - ÎèÑÏñ¥: 350~600mm, Î™©Ìëú ‚âà 450mm
       *    - ÎèÑÏñ¥Í∞úÏàò/2 ‚Üí Î™´*2D + ÎÇòÎ®∏ÏßÄ*1D
       */

      function runAutoCalcSection(itemUniqueId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        if (section === 'upper') {
          item.prevUpperModules = JSON.parse(JSON.stringify(item.modules.filter((m) => m.pos === 'upper')));
          runAutoCalcUpper(item);
        } else {
          item.prevLowerModules = JSON.parse(JSON.stringify(item.modules.filter((m) => m.pos === 'lower')));
          runAutoCalcLower(item);
        }

        renderWorkspaceContent(item);
      }

      function runAutoCalcUpper(item) {
        const W = parseFloat(item.w) || 0;
        const effectiveW = getEffectiveSpace(item, 'upper');

        if (effectiveW <= 0) {
          alert('ÏÉÅÎ∂ÄÏû• Ïú†Ìö® Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
          return;
        }

        const specUpperH = parseFloat(item.specs.upperH) || 720;
        const upperBodyH = specUpperH - 20;
        const isRefLeft = item.specs.measurementBase === 'Left';
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const startBound = fL;
        const endBound = startBound + effectiveW;

        // ‚òÖ Step 1: Í∞úÏàòÎåÄ Ï§ëÏïôÏ†ê Í≥ÑÏÇ∞
        let absDistStart;
        if (isRefLeft) {
          absDistStart = parseFloat(item.specs.distributorStart) || 0;
        } else {
          absDistStart = W - (parseFloat(item.specs.distributorStart) || 0);
        }
        const sinkStart = absDistStart - 100;
        const sinkW = 1000;
        const sinkCenter = sinkStart + sinkW / 2; // Í∞úÏàòÎåÄ Ï§ëÏïô

        // ‚òÖ Step 2: ÌõÑÎìú Ï¥àÍ∏∞ ÏúÑÏπò Í≥ÑÏÇ∞ (ÌôòÌíçÍµ¨ Ï§ëÏïô Ï†ïÎ†¨)
        const absVent = isRefLeft ? parseFloat(item.specs.ventStart) || 0 : W - (parseFloat(item.specs.ventStart) || 0);
        const hoodW = 800;
        let hoodXInit = Math.max(startBound, Math.min(absVent - hoodW / 2, endBound - hoodW));

        // ‚òÖ Step 3-4: Ïú†Ìö®Í≥µÍ∞Ñ(ÌõÑÎìú Ï†úÏô∏)ÏóêÏÑú ÏûÑÏãú ÎèÑÏñ¥ ÎÑàÎπÑ Í≥ÑÏÇ∞
        const totalSpaceExcludeHood = effectiveW - hoodW;
        const tempResult = distributeModules(totalSpaceExcludeHood);
        const tempDoorWidth = tempResult.doorWidth || DOOR_TARGET_WIDTH;

        // Í∏∞Ï§Ä ÏÉÅÎ∂ÄÏû• ÏûÑÏãú ÎÑàÎπÑ (2D)
        const tempBaseUpperW = tempDoorWidth * 2;

        // Í∏∞Ï§Ä ÏÉÅÎ∂ÄÏû• Ï¥àÍ∏∞ ÏúÑÏπò (Í∞úÏàòÎåÄ Ï§ëÏïô Ï†ïÎ†¨)
        let baseUpperXInit = sinkCenter - tempBaseUpperW / 2;
        if (baseUpperXInit < startBound) baseUpperXInit = startBound;
        if (baseUpperXInit + tempBaseUpperW > endBound) baseUpperXInit = endBound - tempBaseUpperW;

        // ‚òÖ Step 5-6-7: ÌõÑÎìú ¬±50mm, Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• ¬±100mm Ïù¥ÎèôÌïòÎ©¥ÏÑú ÏµúÏ†Å ÏúÑÏπò Ï∞æÍ∏∞
        const hoodTolerance = 50;
        const baseTolerance = 100;

        let bestHoodOffset = 0;
        let bestBaseOffset = 0;
        let bestDoorWidth = tempDoorWidth;
        let bestTotalRemainder = Infinity;
        let bestHoodX = hoodXInit;
        let bestBaseUpperX = baseUpperXInit;

        for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
          const testHoodX = hoodXInit + hoodOffset;

          // ÌõÑÎìú Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
          if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;

          for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
            const testBaseX = baseUpperXInit + baseOffset;

            // Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
            if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;

            // ÌõÑÎìúÏôÄ Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• Í≤πÏπ® Ï≤¥ÌÅ¨
            if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;

            // Í≥†Ï†ï Î™®Îìà ÏúÑÏπò Ï†ïÎ†¨
            const fixedModules = [
              { x: testHoodX, endX: testHoodX + hoodW, type: 'hood' },
              { x: testBaseX, endX: testBaseX + tempBaseUpperW, type: 'base' },
            ].sort((a, b) => a.x - b.x);

            // ‚òÖ Step 5: ÏãúÏûë Í≥µÍ∞Ñ - ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÎèÑÏñ¥ Í∞úÏàò Í≥ÑÏÇ∞
            let startSpace = 0;
            let startDoorCount = 0;
            if (fixedModules[0].x > startBound + 50) {
              startSpace = fixedModules[0].x - startBound;
              startDoorCount = Math.round(startSpace / tempDoorWidth);
              if (startDoorCount < 1 && startSpace >= 200) startDoorCount = 1;
            }

            // Ï§ëÍ∞Ñ Í≥µÍ∞Ñ - ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÎèÑÏñ¥ Í∞úÏàò Í≥ÑÏÇ∞
            let middleSpace = 0;
            let middleDoorCount = 0;
            if (fixedModules[1].x > fixedModules[0].endX + 50) {
              middleSpace = fixedModules[1].x - fixedModules[0].endX;
              middleDoorCount = Math.round(middleSpace / tempDoorWidth);
              if (middleDoorCount < 1 && middleSpace >= 200) middleDoorCount = 1;
            }

            // ‚òÖ Step 6: ÎÅù Í≥µÍ∞Ñ - ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÎèÑÏñ¥ Í∞úÏàò Í≥ÑÏÇ∞
            let endSpace = 0;
            let endDoorCount = 0;
            if (endBound > fixedModules[1].endX + 50) {
              endSpace = endBound - fixedModules[1].endX;
              endDoorCount = Math.round(endSpace / tempDoorWidth);
              if (endDoorCount < 1 && endSpace >= 200) endDoorCount = 1;
            }

            // Ï¥ù ÎèÑÏñ¥ Í∞úÏàò (Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• = 2D = ÎèÑÏñ¥ 2Í∞ú)
            const baseDoorCount = 2;
            const totalDoorCount = startDoorCount + middleDoorCount + baseDoorCount + endDoorCount;

            if (totalDoorCount < 2) continue;

            // ‚òÖ Step 7: Í∑†Îì± ÎèÑÏñ¥ ÎÑàÎπÑ Í≥ÑÏÇ∞ (ÌõÑÎìú Ï†úÏô∏ Ï†ÑÏ≤¥ Í≥µÍ∞Ñ / Ï¥ù ÎèÑÏñ¥ Í∞úÏàò)
            const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);

            // ÎèÑÏñ¥ Ï†úÏïΩ Ï°∞Í±¥ ÌôïÏù∏
            if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;

            // ÏÉà Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• ÎÑàÎπÑ
            const newBaseUpperW = testDoorWidth * 2;

            // ÏÉà Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû• ÏúÑÏπò (Í∞úÏàòÎåÄ Ï§ëÏïô Í∏∞Ï§Ä + offset)
            const newBaseUpperX = sinkCenter - newBaseUpperW / 2 + baseOffset;

            // ÏÉà Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
            if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;

            // ÌõÑÎìúÏôÄ Í≤πÏπ® Ïû¨Ï≤¥ÌÅ¨
            if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;

            // Ï¥ù ÏÇ¨Ïö© Í≥µÍ∞Ñ Î∞è ÏûîÏó¨ Í≥ÑÏÇ∞
            const totalUsed = testDoorWidth * totalDoorCount;
            const totalRemainder = totalSpaceExcludeHood - totalUsed;

            // ‚òÖ Ï°∞Í±¥: Ïó¨Ïú†Í≥µÍ∞Ñ ‚â§ 10mm
            if (totalRemainder >= 0 && totalRemainder <= MAX_REMAINDER) {
              if (totalRemainder < bestTotalRemainder) {
                bestTotalRemainder = totalRemainder;
                bestHoodOffset = hoodOffset;
                bestBaseOffset = baseOffset;
                bestDoorWidth = testDoorWidth;
                bestHoodX = testHoodX;
                bestBaseUpperX = newBaseUpperX;
              }
            }
          }
        }

        // Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÎäî Í≤ΩÏö∞Í∞Ä ÏóÜÏúºÎ©¥, ÏûîÏó¨Í∞Ä Í∞ÄÏû• ÏûëÏùÄ Í≤É ÏÑ†ÌÉù
        if (bestTotalRemainder > MAX_REMAINDER) {
          for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
            const testHoodX = hoodXInit + hoodOffset;
            if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;

            for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
              const testBaseX = baseUpperXInit + baseOffset;
              if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;
              if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;

              const fixedModules = [
                { x: testHoodX, endX: testHoodX + hoodW },
                { x: testBaseX, endX: testBaseX + tempBaseUpperW },
              ].sort((a, b) => a.x - b.x);

              let startDoorCount = 0,
                middleDoorCount = 0,
                endDoorCount = 0;

              if (fixedModules[0].x > startBound + 50) {
                startDoorCount = Math.max(1, Math.round((fixedModules[0].x - startBound) / tempDoorWidth));
              }
              if (fixedModules[1].x > fixedModules[0].endX + 50) {
                middleDoorCount = Math.max(1, Math.round((fixedModules[1].x - fixedModules[0].endX) / tempDoorWidth));
              }
              if (endBound > fixedModules[1].endX + 50) {
                endDoorCount = Math.max(1, Math.round((endBound - fixedModules[1].endX) / tempDoorWidth));
              }

              const totalDoorCount = startDoorCount + middleDoorCount + 2 + endDoorCount;
              if (totalDoorCount < 2) continue;

              const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);
              if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;

              const newBaseUpperW = testDoorWidth * 2;
              const newBaseUpperX = sinkCenter - newBaseUpperW / 2 + baseOffset;

              if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;
              if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;

              const totalRemainder = Math.abs(totalSpaceExcludeHood - testDoorWidth * totalDoorCount);

              if (totalRemainder < bestTotalRemainder) {
                bestTotalRemainder = totalRemainder;
                bestHoodOffset = hoodOffset;
                bestBaseOffset = baseOffset;
                bestDoorWidth = testDoorWidth;
                bestHoodX = testHoodX;
                bestBaseUpperX = newBaseUpperX;
              }
            }
          }
        }

        // ‚òÖ ÏµúÏ¢Ö Î™®Îìà Î∞∞Ïπò
        const finalBaseUpperW = bestDoorWidth * 2;
        const finalHoodX = bestHoodX;
        const finalBaseUpperX = bestBaseUpperX;

        let fixedOccupied = [];

        // ÌõÑÎìú Ï∂îÍ∞Ä
        fixedOccupied.push({
          type: 'hood',
          name: 'ÌõÑÎìúÏû•',
          w: hoodW,
          h: upperBodyH - 40,
          d: 295,
          x: finalHoodX,
          endX: finalHoodX + hoodW,
          pos: 'upper',
          isFixed: true,
        });

        // Í∏∞Ï§Ä ÏÉÅÎ∂ÄÏû• Ï∂îÍ∞Ä
        fixedOccupied.push({
          type: 'storage',
          name: 'Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû•(2D)',
          w: finalBaseUpperW,
          h: upperBodyH,
          d: 295,
          x: finalBaseUpperX,
          endX: finalBaseUpperX + finalBaseUpperW,
          pos: 'upper',
          isFixed: true,
          isBase: true,
        });

        // ÏúÑÏπò Ï°∞Ï†ï Î∞è Gap Í≥ÑÏÇ∞
        fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);
        const gaps = calculateGaps(fixedOccupied, startBound, endBound);

        // ‚òÖ Î™®Îìà ÏÉùÏÑ± (Î™®Îì† gapÏóê ÎèôÏùºÌïú ÎèÑÏñ¥ ÎÑàÎπÑ Ï†ÅÏö©)
        item.modules = item.modules.filter((m) => m.pos !== 'upper');
        let newModules = [];

        gaps.forEach((gap) => {
          newModules = newModules.concat(fillGapWithModules(gap, 'upper', upperBodyH, 295, bestDoorWidth));
        });

        // Í≥†Ï†ï Î™®Îìà Ï∂îÍ∞Ä
        fixedOccupied.forEach((fixed) => {
          newModules.push({
            id: fixed.id || Date.now() + Math.random(),
            type: fixed.type,
            name: fixed.name,
            pos: 'upper',
            w: fixed.w,
            h: fixed.h,
            d: fixed.d,
            isDrawer: fixed.isDrawer || false,
            isEL: fixed.isEL || false,
            isFixed: true,
            isBase: fixed.isBase || false,
            _x: fixed.x,
          });
        });

        // Ï†ïÎ†¨ Î∞è Ï†ÄÏû•
        newModules.sort((a, b) => a._x - b._x);
        newModules.forEach((m) => delete m._x);
        if (!isRefLeft) newModules.reverse();

        item.modules = item.modules.concat(newModules);

        console.log(
          `ÏÉÅÎ∂ÄÏû•: ÎèÑÏñ¥=${bestDoorWidth}mm, Í∏∞Ï§ÄÏÉÅÎ∂ÄÏû•=${finalBaseUpperW}mm, ÌõÑÎìúoffset=${bestHoodOffset}mm, Í∏∞Ï§Äoffset=${bestBaseOffset}mm, ÏûîÏó¨=${bestTotalRemainder}mm`
        );
      }

      function runAutoCalcLower(item) {
        const W = parseFloat(item.w) || 0;
        const effectiveW = getEffectiveSpace(item, 'lower');

        if (effectiveW <= 0) {
          alert('ÌïòÎ∂ÄÏû• Ïú†Ìö® Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
          return;
        }

        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const startBound = fL;
        const endBound = startBound + effectiveW;
        const isRefLeft = item.specs.measurementBase === 'Left';

        // ÏÑ§ÎπÑ ÏúÑÏπò Í≥ÑÏÇ∞
        let absDistStart, absDistEnd, absVent;
        if (isRefLeft) {
          absDistStart = parseFloat(item.specs.distributorStart) || 0;
          absDistEnd = parseFloat(item.specs.distributorEnd) || 0;
          absVent = parseFloat(item.specs.ventStart) || 0;
        } else {
          const dS = parseFloat(item.specs.distributorStart) || 0;
          const dE = parseFloat(item.specs.distributorEnd) || 0;
          absDistStart = Math.min(W - dS, W - dE);
          absDistEnd = Math.max(W - dS, W - dE);
          absVent = W - (parseFloat(item.specs.ventStart) || 0);
        }

        const specLowerH = parseFloat(item.specs.lowerH) || 870;
        const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;
        const defaultLowerH = specLowerH - specLegH;

        // ÌòÑÏû¨ Í≥†Ï†ï Î™®Îìà (Í∞úÏàòÎåÄ, Í∞ÄÏä§ÎåÄ, ELÏû•, LTÎßùÏû•, TLÏû•, ÏàòÏ†ïÎêú Î™®Îìà)
        const currentModules = item.modules.filter((m) => m.pos === 'lower');

        // ÌïÑÏàò Î™®Îìà ÏúÑÏπò Í≥ÑÏÇ∞
        const sinkW = 1000,
          cookW = 600;

        // ‚òÖ Í∞úÏàòÎåÄ Í∏∞Î≥∏ ÏúÑÏπò: Î∂ÑÎ∞∞Í∏∞ÏãúÏûë - 100
        let sinkX = absDistStart - 100;

        // ‚òÖ Í∞úÏàòÎåÄ ÎÖºÎ¶¨ Ï°∞Í±¥ Í≤ÄÏ¶ù (ÏóÖÎç∞Ïù¥Ìä∏)
        // Ï°∞Í±¥1 Ï∂©Ï°±: Í∞úÏàòÎåÄÏãúÏûë < Î∂ÑÎ∞∞Í∏∞ÏãúÏûë
        // Ï°∞Í±¥2 Ï∂©Ï°±: Í∞úÏàòÎåÄÎÅù > Î∂ÑÎ∞∞Í∏∞ÎÅù

        // Ï°∞Í±¥1 ÏúÑÎ∞ò Ïãú: Í∞úÏàòÎåÄ ÏãúÏûëÏ†ê = Î∂ÑÎ∞∞Í∏∞ ÏãúÏûëÏ†ê - 100mm
        if (sinkX >= absDistStart) {
          sinkX = absDistStart - 100;
        }
        // Ï°∞Í±¥2 ÏúÑÎ∞ò Ïãú: Í∞úÏàòÎåÄ ÏãúÏûëÏ†ê = Î∂ÑÎ∞∞Í∏∞ ÎÅùÏ†ê - Í∞úÏàòÎåÄ ÎÑàÎπÑ + 100mm
        if (sinkX + sinkW <= absDistEnd) {
          sinkX = absDistEnd - sinkW + 100;
        }

        // ‚òÖ Í∞úÏàòÎåÄ Ïù¥Îèô Í∞ÄÎä• Î≤îÏúÑ Í≥ÑÏÇ∞
        // Ï°∞Í±¥1 Ï∂©Ï°±: sinkX < absDistStart
        // Ï°∞Í±¥2 Ï∂©Ï°±: sinkX + sinkW > absDistEnd ‚Üí sinkX > absDistEnd - sinkW
        const sinkMinX = absDistEnd - sinkW + 1; // Ï°∞Í±¥2 ÎßåÏ°± ÏµúÏÜåÍ∞í
        const sinkMaxX = absDistStart - 1; // Ï°∞Í±¥1 ÎßåÏ°± ÏµúÎåÄÍ∞í

        // ‚òÖ Í∞ÄÏä§ÎåÄ ÏúÑÏπò: ÌôòÌíçÍµ¨ Ï§ëÏïô Ï†ïÎ†¨
        const cookX = absVent - cookW / 2;

        // ‚òÖ LTÎßùÏû• ÏúÑÏπò Í≥ÑÏÇ∞
        let ltX = null,
          ltW = 200;
        if (item.specs.accessories.some((a) => a.type === 'LTMesh')) {
          if (isRefLeft) {
            ltX = cookX + cookW;
          } else {
            ltX = cookX - ltW;
          }
        }

        // ÏÇ¨Ïö©Ïûê Í≥†Ï†ï Î™®Îìà ÌôïÏù∏ (ELÏû•, TLÏû•, ÏàòÏ†ïÎêú Î™®Îìà)
        const hasUserFixedModules = currentModules.some(
          (m) => m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTÎßùÏû•'
        );

        // ‚òÖ Î™®Îìà ÏàòÏ†ï ÌõÑ Ïû¨Í≥ÑÏÇ∞ Ïãú: Í∞úÏàòÎåÄ ÏúÑÏπò ÏµúÏ†ÅÌôî
        if (hasUserFixedModules) {
          // ÏÇ¨Ïö©Ïûê Í≥†Ï†ï Î™®Îìà ÏúÑÏπò ÏàòÏßë
          let userFixedModules = [];
          let tempX = startBound;
          currentModules.forEach((m) => {
            if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTÎßùÏû•') {
              userFixedModules.push({ ...m, x: tempX, endX: tempX + parseFloat(m.w) });
            }
            tempX += parseFloat(m.w) || 0;
          });

          // Í∞úÏàòÎåÄ Ïù¥Îèô Í∞ÄÎä• Î≤îÏúÑ ÎÇ¥ÏóêÏÑú ÏµúÏ†Å ÏúÑÏπò Ï∞æÍ∏∞
          let bestSinkX = sinkX;
          let bestTotalRemainder = Infinity;

          // 1mm Îã®ÏúÑÎ°ú ÌÉêÏÉâ (Î≤îÏúÑ ÎÇ¥ÏóêÏÑú)
          const searchMin = Math.max(startBound, sinkMinX);
          const searchMax = Math.min(endBound - sinkW, sinkMaxX);

          for (let testSinkX = searchMin; testSinkX <= searchMax; testSinkX++) {
            // ÏûÑÏãú Í≥†Ï†ï Î™®Îìà Î∞∞Ïó¥ Íµ¨ÏÑ±
            let tempFixed = [
              { x: testSinkX, endX: testSinkX + sinkW },
              { x: cookX, endX: cookX + cookW },
            ];
            if (ltX !== null) {
              tempFixed.push({ x: ltX, endX: ltX + ltW });
            }
            userFixedModules.forEach((m) => {
              tempFixed.push({ x: m.x, endX: m.endX });
            });
            tempFixed.sort((a, b) => a.x - b.x);

            // gapÎì§Ïùò ÏûîÏó¨Í≥µÍ∞Ñ Ìï© Í≥ÑÏÇ∞
            let totalRemainder = 0;
            let cursor = startBound;

            for (const fixed of tempFixed) {
              if (fixed.x > cursor + 1) {
                const gapWidth = fixed.x - cursor;
                // ÎèÖÎ¶Ω Î∂ÑÎ∞∞ Í≤∞Í≥ºÏùò ÏûîÏó¨ Í≥ÑÏÇ∞
                const result = distributeModules(gapWidth);
                if (result.doorCount > 0) {
                  const used = result.doorWidth * result.doorCount;
                  totalRemainder += Math.abs(gapWidth - used);
                }
              }
              cursor = Math.max(cursor, fixed.endX);
            }
            if (cursor < endBound - 1) {
              const gapWidth = endBound - cursor;
              const result = distributeModules(gapWidth);
              if (result.doorCount > 0) {
                const used = result.doorWidth * result.doorCount;
                totalRemainder += Math.abs(gapWidth - used);
              }
            }

            // ÏµúÏ†Å ÏúÑÏπò ÏÑ†ÌÉù
            if (totalRemainder < bestTotalRemainder) {
              bestTotalRemainder = totalRemainder;
              bestSinkX = testSinkX;
            }
          }

          sinkX = bestSinkX;
        }

        let fixedOccupied = [
          {
            type: 'sink',
            name: 'Í∞úÏàòÎåÄ',
            w: sinkW,
            h: defaultLowerH,
            d: 600,
            x: sinkX,
            endX: sinkX + sinkW,
            pos: 'lower',
            isFixed: true,
          },
          {
            type: 'cook',
            name: 'Í∞ÄÏä§ÎåÄ',
            w: cookW,
            h: defaultLowerH,
            d: 550,
            x: cookX,
            endX: cookX + cookW,
            pos: 'lower',
            isFixed: true,
          },
        ];

        // ‚òÖ LTÎßùÏû• Ï∂îÍ∞Ä
        if (ltX !== null) {
          fixedOccupied.push({
            type: 'storage',
            name: 'LTÎßùÏû•',
            w: ltW,
            h: defaultLowerH,
            d: 550,
            x: ltX,
            endX: ltX + ltW,
            isDrawer: true,
            pos: 'lower',
            isFixed: true,
          });
        }

        // ÏÇ¨Ïö©Ïûê Í≥†Ï†ï Î™®Îìà Ï∂îÍ∞Ä (ELÏû•, TLÏû•, ÏàòÏ†ïÎêú Î™®Îìà)
        let tempX2 = startBound;
        currentModules.forEach((m) => {
          if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTÎßùÏû•') {
            fixedOccupied.push({ ...m, x: tempX2, endX: tempX2 + parseFloat(m.w) });
          }
          tempX2 += parseFloat(m.w) || 0;
        });

        // ÏúÑÏπò Ï°∞Ï†ï Î∞è Gap Í≥ÑÏÇ∞
        fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);

        if (fixedOccupied[0] && fixedOccupied[0].x < startBound) {
          alert('Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±ÌïòÏó¨ ÌïÑÏàò Ïû•ÏùÑ Î∞∞ÏπòÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
          return;
        }

        const gaps = calculateGaps(fixedOccupied, startBound, endBound);

        // ÌïòÎ∂ÄÏû• Ï¥àÍ∏∞Ìôî ÌõÑ ÏÉà Î™®Îìà ÏÉùÏÑ±
        item.modules = item.modules.filter((m) => m.pos !== 'lower');
        let newModules = [];

        // hasUserFixedModulesÎäî Ïù¥ÎØ∏ ÏúÑÏóêÏÑú Í≥ÑÏÇ∞Îê®
        if (hasUserFixedModules) {
          // ‚òÖ ÌÜµÌï© Î∂ÑÎ∞∞: Î™®Îìà ÏàòÏ†ï ÌõÑ Ïû¨Í≥ÑÏÇ∞ Ïãú
          // Ï†ÑÏ≤¥ Í∞ÄÏö© Í≥µÍ∞ÑÏóêÏÑú ÌëúÏ§Ä ÎèÑÏñ¥ ÎÑàÎπÑ Í≥ÑÏÇ∞
          const totalAvailable = gaps.reduce((sum, g) => sum + g.width, 0);
          const standardResult = distributeModules(totalAvailable);
          const standardDoorWidth = standardResult.doorWidth || DOOR_TARGET_WIDTH;

          gaps.forEach((gap) => {
            newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, standardDoorWidth));
          });
        } else {
          // ‚òÖ ÎèÖÎ¶Ω Î∂ÑÎ∞∞: Ï¥àÍ∏∞ ÏûêÎèôÍ≥ÑÏÇ∞ Ïãú
          // Í∞úÏàòÎåÄ ÏãúÏûë Í≥µÍ∞ÑÍ≥º ÎÅù Í≥µÍ∞Ñ Í∞ÅÍ∞Å ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Î∂ÑÎ∞∞
          gaps.forEach((gap) => {
            newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, null));
          });
        }

        // Í≥†Ï†ï Î™®Îìà Ï∂îÍ∞Ä
        fixedOccupied.forEach((fixed) => {
          newModules.push({
            id: fixed.id || Date.now() + Math.random(),
            type: fixed.type,
            name: fixed.name,
            pos: 'lower',
            w: fixed.w,
            h: fixed.h,
            d: fixed.d,
            isDrawer: fixed.isDrawer || false,
            isEL: fixed.isEL || false,
            isFixed: true,
            _x: fixed.x,
          });
        });

        // Ï†ïÎ†¨ Î∞è Ï†ÄÏû•
        newModules.sort((a, b) => a._x - b._x);
        newModules.forEach((m) => delete m._x);
        if (!isRefLeft) newModules.reverse();

        item.modules = item.modules.concat(newModules);
      }

      function undoAutoCalc(itemUniqueId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        if (section === 'upper' && item.prevUpperModules) {
          item.modules = item.modules.filter((m) => m.pos !== 'upper').concat(item.prevUpperModules);
          item.prevUpperModules = null;
        } else if (section === 'lower' && item.prevLowerModules) {
          item.modules = item.modules.filter((m) => m.pos !== 'lower').concat(item.prevLowerModules);
          item.prevLowerModules = null;
        }
        renderWorkspaceContent(item);
      }

      // ============================================================
      // UI Í¥ÄÎ†® Ìï®ÏàòÎì§
      // ============================================================

      function initCategoryGrid() {
        const gridEl = document.getElementById('categoryGrid');
        CATEGORIES.forEach((cat) => {
          const btn = document.createElement('div');
          btn.className = 'category-card';
          btn.id = `btn-${cat.id}`;
          btn.innerHTML = `
      <div class="category-name">${cat.name}</div>
      <div class="card-stepper" onclick="event.stopPropagation()">
        <button class="stepper-btn" onclick="decrementCategory('${cat.id}')">Ôºç</button>
        <span class="stepper-count" id="count-${cat.id}">0</span>
        <button class="stepper-btn" onclick="incrementCategory('${cat.id}')">Ôºã</button>
      </div>
    `;
          btn.addEventListener('click', () => incrementCategory(cat.id));
          gridEl.appendChild(btn);
        });
      }

      function incrementCategory(catId) {
        const cat = CATEGORIES.find((c) => c.id === catId);
        const specLegH = 150;
        const specLowerH = 870;
        const specUpperH = 720;
        const lowerBodyH = specLowerH - specLegH;
        const upperBodyH = specUpperH - 20;

        const newItem = {
          uniqueId: Date.now() + Math.random(),
          categoryId: cat.id,
          name: cat.name,
          defaultD: cat.defaultD,
          w: '',
          h: '',
          d: '',
          image: null,
          specs: JSON.parse(JSON.stringify(DEFAULT_SPECS)),
          modules: [],
          prevUpperModules: null,
          prevLowerModules: null,
        };

        // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû•: Í∏∞Î≥∏ ÎßàÍ∞êÏùÑ Î™∞Îî©ÏúºÎ°ú ÏÑ§Ï†ï
        if (cat.id === 'wardrobe') {
          newItem.specs.finishLeftType = 'Molding';
          newItem.specs.finishRightType = 'Molding';
        }

        // ‚òÖ ÎÉâÏû•Í≥†Ïû•: Í∑úÏπô Í∏∞Î∞ò Ï¥àÍ∏∞Ìôî (ÏóÖÎç∞Ïù¥Ìä∏)
        if (cat.id === 'fridge') {
          newItem.specs.fridgeBrand = 'LG';
          newItem.specs.fridgeMoldingH = FRIDGE_RULES.MOLDING_H; // ÏÉÅÎ™∞Îî© ÎÜíÏù¥
          newItem.specs.fridgePedestal = FRIDGE_RULES.PEDESTAL_H; // Ï¢åÎåÄ ÎÜíÏù¥
          newItem.specs.fridgeModuleD = FRIDGE_RULES.MODULE_D; // Î™®Îìà ÍπäÏù¥ Í∏∞Î≥∏ 550
          newItem.specs.finishLeftType = 'molding'; // Î™∞Îî© Í∏∞Î≥∏
          newItem.specs.finishRightType = 'molding'; // Î™∞Îî© Í∏∞Î≥∏
          newItem.specs.finishLeftWidth = 60;
          newItem.specs.finishRightWidth = 60;
          // ÏûêÎèôÍ≥ÑÏÇ∞ Í¥ÄÎ†®
          newItem.specs.autoCalculated = false;
        }

        if (cat.id === 'sink') {
          newItem.modules = [
            {
              id: 1,
              type: 'sink',
              name: 'Í∞úÏàòÎåÄ',
              pos: 'lower',
              w: 1000,
              h: lowerBodyH,
              d: 600,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
            {
              id: 2,
              type: 'cook',
              name: 'Í∞ÄÏä§ÎåÄ',
              pos: 'lower',
              w: 600,
              h: lowerBodyH,
              d: 550,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
            {
              id: 3,
              type: 'storage',
              name: 'LTÎßùÏû•',
              pos: 'lower',
              w: 200,
              h: lowerBodyH,
              d: 550,
              isDrawer: true,
              isEL: false,
              isFixed: true,
            },
            {
              id: 4,
              type: 'hood',
              name: 'ÌõÑÎìúÏû•',
              pos: 'upper',
              w: 800,
              h: upperBodyH - 40,
              d: 295,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
          ];
        }

        selectedItems.push(newItem);
        updateUI();
      }

      function decrementCategory(catId) {
        const targets = selectedItems.filter((item) => item.categoryId === catId);
        if (targets.length > 0) removeInstance(targets[targets.length - 1].uniqueId);
      }

      function removeInstance(uniqueId) {
        selectedItems = selectedItems.filter((item) => item.uniqueId !== uniqueId);
        updateUI();
      }

      function updateUI() {
        const container = document.getElementById('dynamicInputList');
        const detailSection = document.getElementById('detailInputSection');

        detailSection.style.display = selectedItems.length > 0 ? 'block' : 'none';

        CATEGORIES.forEach((cat) => {
          const count = selectedItems.filter((item) => item.categoryId === cat.id).length;
          document.getElementById(`count-${cat.id}`).innerText = count;
          const btn = document.getElementById(`btn-${cat.id}`);
          btn.classList.toggle('active', count > 0);
        });

        const typeCounter = {};
        container.innerHTML = '';

        selectedItems.forEach((item) => {
          typeCounter[item.categoryId] = (typeCounter[item.categoryId] || 0) + 1;
          item.labelName = `${item.name} #${typeCounter[item.categoryId]}`;

          if (item.specs.layoutShape === 'I' && !item.specs.topSizes[0] && item.w && item.d) {
            item.specs.topSizes[0] = `${item.w} x ${item.d}`;
          }

          const sinkInputs =
            item.categoryId === 'sink'
              ? `
      <div class="extra-settings">
        <div class="extra-title">Layout & ÏÑ§ÎπÑ ÏÑ§Ï†ï</div>
        <div class="input-row">
          <div class="input-group"><label>Íµ¨Ï°∞ ÌòïÌÉú</label>
            <select onchange="changeLayoutShape(${item.uniqueId}, this.value)">
              <option value="I" ${item.specs.layoutShape === 'I' ? 'selected' : ''}>„Ö°ÏûêÌòï</option>
              <option value="L" ${item.specs.layoutShape === 'L' ? 'selected' : ''}>„Ñ±ÏûêÌòï</option>
              <option value="U" ${item.specs.layoutShape === 'U' ? 'selected' : ''}>„Ñ∑ÏûêÌòï</option>
            </select>
          </div>
          <div class="input-group"><label>Ïã§Ï∏° Í∏∞Ï§Ä</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase === 'Left' ? 'selected' : ''}>Ï¢åÏ∏°</option>
              <option value="Right" ${item.specs.measurementBase === 'Right' ? 'selected' : ''}>Ïö∞Ï∏°</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>Î∂ÑÎ∞∞Í∏∞ ÏãúÏûë(mm)</label><input type="number" value="${item.specs.distributorStart}" oninput="updateSpec(${item.uniqueId}, 'distributorStart', this.value)"></div>
          <div class="input-group"><label>Î∂ÑÎ∞∞Í∏∞ ÎÅù(mm)</label><input type="number" value="${item.specs.distributorEnd}" oninput="updateSpec(${item.uniqueId}, 'distributorEnd', this.value)"></div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>ÌôòÌíçÍµ¨ ÏúÑÏπò(mm)</label><input type="number" value="${item.specs.ventStart}" oninput="updateSpec(${item.uniqueId}, 'ventStart', this.value)"></div>
        </div>
      </div>
    `
              : '';

          // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû• Ï†ÑÏö© ÏûÖÎ†• Ìèº
          const wardrobeInputs =
            item.categoryId === 'wardrobe'
              ? `
      <div class="extra-settings">
        <div class="extra-title">Î∂ôÎ∞ïÏù¥Ïû• ÏÑ§Ï†ï</div>
        <div class="input-row">
          <div class="input-group"><label>Ïã§Ï∏° Í∏∞Ï§Ä</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase === 'Left' ? 'selected' : ''}>Ï¢åÏ∏°</option>
              <option value="Right" ${item.specs.measurementBase === 'Right' ? 'selected' : ''}>Ïö∞Ï∏°</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>Ïª§ÌäºÎ∞ïÏä§ Í∞ÄÎ°ú(mm)</label><input type="number" value="${item.specs.curtainBoxW || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="input-group"><label>Ïª§ÌäºÎ∞ïÏä§ ÎÜíÏù¥(mm)</label><input type="number" value="${item.specs.curtainBoxH || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>
      </div>
    `
              : '';

          // ‚òÖ ÎÉâÏû•Í≥†Ïû• Ï†ÑÏö© ÏûÖÎ†• Ìèº (Í∑úÏπô Í∏∞Î∞ò)
          const fridgeInputs =
            item.categoryId === 'fridge'
              ? `
      <div class="extra-settings">
        <div class="extra-title">üßä ÎÉâÏû•Í≥†Ïû• Í∏∞Î≥∏ ÏÑ§Ï†ï</div>
        <div class="input-row">
          <div class="input-group"><label>Î∏åÎûúÎìú</label>
            <select onchange="updateSpec(${item.uniqueId}, 'fridgeBrand', this.value)">
              <option value="LG" ${item.specs.fridgeBrand === 'LG' ? 'selected' : ''}>LG</option>
              <option value="Samsung" ${item.specs.fridgeBrand === 'Samsung' ? 'selected' : ''}>ÏÇºÏÑ±</option>
            </select>
          </div>
          <div class="input-group"><label>ÏÉÅÎ™∞Îî© ÎÜíÏù¥(mm)</label>
            <input type="number" value="${item.specs.fridgeMoldingH || 50}" oninput="updateSpec(${item.uniqueId}, 'fridgeMoldingH', this.value)">
          </div>
        </div>
        <div style="font-size:10px;color:#666;margin-top:4px;">
          ‚Äª ÏÉÅÎ∂ÄÏû• ÎèÑÏñ¥H = Ïã§Ï∏°H - ÎÉâÏû•Í≥†H - 15 - ÏÉÅÎ™∞Îî©H (ÏµúÎåÄ 400mm)
        </div>
      </div>
    `
              : '';

          const imageHtml =
            item.image === 'loading'
              ? `<div style="font-size:14px;">‚è≥</div><div>ÏóÖÎ°úÎìúÏ§ë...</div>`
              : item.image
                ? `<img src="${item.image}" alt="preview" onerror="this.outerHTML='<div>‚ùå Ïò§Î•ò</div>'">`
                : `<div style="font-size:20px;">üì∑</div><div>ÏÇ¨ÏßÑ</div>`;

          const card = document.createElement('div');
          card.className = 'item-input-card';
          card.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
        <div style="font-weight:bold;color:var(--primary-color);">${item.labelName}</div>
        <button class="btn-delete" onclick="removeInstance(${item.uniqueId})">√ó</button>
      </div>
      <div class="item-body">
        <div class="input-section">
          <div class="input-row">
            <div class="input-group"><label>Í∞ÄÎ°ú(W)</label><input type="number" placeholder="mm" value="${item.w}" oninput="updateItemValue(${item.uniqueId}, 'w', this.value)"></div>
            <div class="input-group"><label>ÎÜíÏù¥(H)</label><input type="number" placeholder="mm" value="${item.h}" oninput="updateItemValue(${item.uniqueId}, 'h', this.value)"></div>
            <div class="input-group"><label>ÍπäÏù¥(D)</label><input type="number" placeholder="mm" value="${item.d || item.defaultD || ''}" oninput="updateItemValue(${item.uniqueId}, 'd', this.value)"></div>
          </div>
          ${sinkInputs}
          ${wardrobeInputs}
          ${fridgeInputs}
        </div>
        <div class="photo-section">
          <label>ÌòÑÏû• ÏÇ¨ÏßÑ</label>
          <div class="photo-box" onclick="document.getElementById('file-${item.uniqueId}').click()">${imageHtml}</div>
          <input type="file" id="file-${item.uniqueId}" class="file-input-hidden" accept="image/*" onchange="handleItemPhoto(${item.uniqueId}, event)">
        </div>
      </div>
    `;
          container.appendChild(card);
          if (!item.d && item.defaultD > 0) item.d = item.defaultD;
        });

        document.getElementById('btnNext').disabled =
          selectedItems.length === 0 || !selectedItems.every((item) => item.w && item.h && item.d);
        document.getElementById('aiGuideText').innerHTML =
          selectedItems.length > 0
            ? `Ï¥ù <strong>${selectedItems.length}Í∞ú</strong>Ïùò Í∞ÄÍµ¨ ÏÑ§Ï†ï Ï§ë...`
            : 'Í∞ÄÍµ¨Î•º Ï∂îÍ∞ÄÌïòÎ©¥ ÏûÖÎ†•Ï∞ΩÏù¥ ÏÉùÏÑ±Îê©ÎãàÎã§.';
      }

      function updateItemValue(uniqueId, field, value) {
        const target = selectedItems.find((item) => item.uniqueId === uniqueId);
        if (target) {
          target[field] = value;
          if (target.specs.layoutShape === 'I' && (field === 'w' || field === 'd')) {
            target.specs.topSizes[0] = `${target.w} x ${target.d}`;
          }
          // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû•: Í∞ÄÎ°ú(W) Î≥ÄÍ≤Ω Ïãú Ïú†Ìö®Í≥µÍ∞Ñ ÏûêÎèô Ïû¨Í≥ÑÏÇ∞
          if (target.categoryId === 'wardrobe' && field === 'w') {
            const W = parseFloat(value) || 0;
            const fL = target.specs.finishLeftType !== 'None' ? parseFloat(target.specs.finishLeftWidth) || 0 : 0;
            const fR = target.specs.finishRightType !== 'None' ? parseFloat(target.specs.finishRightWidth) || 0 : 0;
            target.specs.wardrobeEffectiveW = W - fL - fR;
          }
          document.getElementById('btnNext').disabled = !selectedItems.every((item) => item.w && item.h && item.d);
        }
      }

      async function handleItemPhoto(uniqueId, event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!currentUser) {
          alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÎ•º ÏúÑÌï¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
          return;
        }

        const target = selectedItems.find((item) => item.uniqueId === uniqueId);
        if (!target) return;

        // Î°úÎî© ÌëúÏãú
        target.image = 'loading';
        updateUI();

        try {
          const imageUrl = await uploadImageToStorage(file, currentUser.id);
          target.image = imageUrl;
          target.imageUrl = imageUrl;
          updateUI();
          hasUnsavedChanges = true;
        } catch (error) {
          console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
          alert(error.message || 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
          target.image = null;
          updateUI();
        }
      }

      function goToStep2() {
        document.getElementById('step1-content').style.display = 'none';
        document.getElementById('step2-content').style.display = 'block';
        document.getElementById('step-dot-1').classList.remove('active');
        document.getElementById('step-dot-2').classList.add('active');
        renderBookmarks();
      }

      function backToStep1() {
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
        document.getElementById('step-dot-1').classList.add('active');
        document.getElementById('step-dot-2').classList.remove('active');
        updateUI();
      }

      function goToStep3() {
        document.getElementById('step2-content').style.display = 'none';
        document.getElementById('step3-content').style.display = 'block';
        document.getElementById('step-dot-2').classList.remove('active');
        document.getElementById('step-dot-3').classList.add('active');
      }

      function backToStep2() {
        document.getElementById('step3-content').style.display = 'none';
        document.getElementById('step2-content').style.display = 'block';
        document.getElementById('step-dot-3').classList.remove('active');
        document.getElementById('step-dot-2').classList.add('active');
      }

      function proceedToBOM() {
        // 1. AI Í≤∞Í≥º Î™®Îã¨ Îã´Í∏∞
        const modal = document.querySelector('.ai-design-result-modal');
        if (modal) modal.remove();

        // 2. ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
        const design = window.DadamAgent.exportDesign();
        if (!design.items || design.items.length === 0) {
          alert('ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }

        // 3. Step 3Î°ú Ïù¥Îèô
        goToStep3();

        // 4. ÏûêÏû¨ Ï∂îÏ∂ú
        const matResult = materialExtractor.extract(design);
        const hwResult = hardwareExtractor.extract(design);

        // 5. Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Îã§Ïö¥Î°úÎìúÏö©)
        window._reportData = {
          design,
          materials: matResult,
          hardware: hwResult,
          csvMaterial: materialExtractor.toCSV(matResult.materials),
          cncMaterial: materialExtractor.toCNC(matResult.materials),
          csvHardware: hardwareExtractor.toCSV(hwResult.hardware)
        };

        // 6. ÌÉ≠ ÏΩòÌÖêÏ∏† ÏÉùÏÑ± ÌõÑ Step 3 ÏòÅÏó≠Ïóê Î†åÎçîÎßÅ
        const tabContent = generateReportTabs(matResult, hwResult, design);
        document.getElementById('step3-report-area').innerHTML = tabContent;
      }

      function renderBookmarks() {
        const tabsContainer = document.getElementById('bookmarkTabs');
        tabsContainer.innerHTML = '';
        selectedItems.forEach((item, index) => {
          const tab = document.createElement('div');
          tab.className = 'bookmark-tab' + (index === 0 ? ' active' : '');
          tab.innerText = item.labelName;
          tab.onclick = () => {
            document.querySelectorAll('.bookmark-tab').forEach((t) => t.classList.remove('active'));
            tab.classList.add('active');
            currentItemId = item.uniqueId;
            renderWorkspaceContent(item);
          };
          tabsContainer.appendChild(tab);
        });
        if (selectedItems.length > 0) {
          currentItemId = selectedItems[0].uniqueId;
          renderWorkspaceContent(selectedItems[0]);
        }
      }

      // Î†åÎçîÎßÅ debounceÎ•º ÏúÑÌïú ÌÉÄÏù¥Î®∏ Ï†ÄÏû•ÏÜå
      const _renderTimers = new Map();

      function renderWorkspaceContent(item) {
        if (!item || !item.uniqueId) return;

        // ‚òÖ ÏÑ±Îä• ÏµúÏ†ÅÌôî: ÎèôÏùº ÏïÑÏù¥ÌÖúÏóê ÎåÄÌïú Ïó∞ÏÜç Î†åÎçîÎßÅ ÏöîÏ≤≠ÏùÑ debounce
        const itemId = item.uniqueId;
        if (_renderTimers.has(itemId)) {
          clearTimeout(_renderTimers.get(itemId));
        }

        _renderTimers.set(
          itemId,
          setTimeout(() => {
            _renderTimers.delete(itemId);
            _renderWorkspaceContentImpl(item);
          }, 30)
        ); // 30ms debounce
      }

      // Ïã§Ï†ú Î†åÎçîÎßÅ Íµ¨ÌòÑ
      function _renderWorkspaceContentImpl(item) {
        const ws = document.getElementById('designWorkspace');
        if (!ws) return;

        // ‚òÖ Ìè¨Ïª§Ïä§ Î≥µÏõêÏùÑ ÏúÑÌïú Ï†ïÎ≥¥ Ï†ÄÏû•
        const activeEl = document.activeElement;
        let focusInfo = null;
        if (activeEl && activeEl.tagName === 'INPUT' && ws.contains(activeEl)) {
          focusInfo = {
            type: activeEl.type,
            value: activeEl.value,
            selectionStart: activeEl.selectionStart,
            selectionEnd: activeEl.selectionEnd,
            // ÏöîÏÜå ÏãùÎ≥ÑÏùÑ ÏúÑÌïú ÏÜçÏÑ±Îì§
            onchange: activeEl.getAttribute('onchange'),
            onblur: activeEl.getAttribute('onblur'),
            parentClass: activeEl.closest('.dim-group, .spec-field, .effective-space-group')?.className,
          };
        }

        // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû•Ïù∏ Í≤ΩÏö∞ Î≥ÑÎèÑ Î†åÎçîÎßÅ
        if (item.categoryId === 'wardrobe') {
          renderWardrobeWorkspace(item);
          _restoreFocus(ws, focusInfo);
          return;
        }

        // ‚òÖ ÎÉâÏû•Í≥†Ïû•Ïù∏ Í≤ΩÏö∞ Î≥ÑÎèÑ Î†åÎçîÎßÅ
        if (item.categoryId === 'fridge') {
          renderFridgeWorkspace(item);
          _restoreFocus(ws, focusInfo);
          return;
        }

        const upperModules = item.modules.filter((m) => m.pos === 'upper');
        const lowerModules = item.modules.filter((m) => m.pos === 'lower');

        const autoEffectiveW = calcEffectiveSpace(item);
        const upperEffectiveW = getEffectiveSpace(item, 'upper');
        const lowerEffectiveW = getEffectiveSpace(item, 'lower');

        const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const upperRemaining = upperEffectiveW - upperUsedW;
        const lowerRemaining = lowerEffectiveW - lowerUsedW;

        const renderModuleCard = (mod, idx, section, totalCount) => {
          const icons = { sink: 'üö∞', cook: 'üî•', hood: 'üåÄ', tall: '‚ÜïÔ∏è', storage: mod.pos === 'upper' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è' };
          const icon = icons[mod.type] || 'üì¶';
          const isTall = mod.type === 'tall';
          const isBase = mod.isBase; // ‚òÖ Í∏∞Ï§Ä Î™®Îìà ÌôïÏù∏

          const options =
            mod.pos === 'lower' && (mod.type === 'storage' || mod.type === 'tall')
              ? `
      <div class="module-options">
        <label class="module-chk"><input type="checkbox" ${mod.isDrawer ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isDrawer', this.checked)"> ÏÑúÎûçÏû•</label>
        <label class="module-chk"><input type="checkbox" ${mod.isEL ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isEL', this.checked)"> ELÏû•</label>
        ${
          isTall
            ? `<div style="margin-top:4px;display:flex;gap:8px;">
          <label class="module-chk">ÎèÑÏñ¥Ïàò: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.doorCount || 1}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'doorCount', this.value)"></label>
          <label class="module-chk">ELÏàò: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.elCount || 0}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'elCount', this.value)"></label>
        </div>`
            : ''
        }
      </div>
    `
              : '';

          // ‚òÖ ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï: ÌÇ§ÌÅ∞Ïû• > Í∏∞Ï§ÄÎ™®Îìà > Í≥†Ï†ïÎ™®Îìà
          let cardClass = 'module-card';
          if (isTall) cardClass += ' tall-type';
          else if (isBase) cardClass += ' base-module';
          else if (mod.isFixed) cardClass += ' fixed-module';

          const fixedClass = mod.isFixed ? 'active' : '';
          return `
      <div class="${cardClass}" data-module-id="${mod.id}">
        <div class="move-buttons">
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'up')" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'down')" ${idx === totalCount - 1 ? 'disabled' : ''}>‚ñº</button>
        </div>
        <div class="module-icon">${icon}</div>
        <div class="module-info">
          <div class="module-header">
            <span class="module-title">${mod.name}</span>
            ${isTall ? '<span class="module-type-badge">ÌÇ§ÌÅ∞Ïû•</span>' : ''}
            <button class="toggle-btn ${fixedClass}" style="margin-left:auto;font-size:9px;padding:2px 6px;" onclick="toggleSinkModuleFixed(${item.uniqueId}, ${mod.id})">Í≥†Ï†ï</button>
          </div>
          <div class="module-dims">
            <div class="dim-group"><label class="dim-label">W</label><input type="number" class="dim-input" value="${mod.w}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)"></div>
            <div class="dim-group"><label class="dim-label">H</label><input type="number" class="dim-input" value="${mod.h}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'h', this.value)"></div>
            <div class="dim-group"><label class="dim-label">D</label><input type="number" class="dim-input" value="${mod.d}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)"></div>
          </div>
          ${options}
        </div>
        <button class="btn-delete-module" onclick="removeModule(${item.uniqueId}, ${mod.id})">√ó</button>
      </div>
    `;
        };

        const upperModulesHtml = upperModules
          .map((m, i) => renderModuleCard(m, i, 'upper', upperModules.length))
          .join('');
        const lowerModulesHtml = lowerModules
          .map((m, i) => renderModuleCard(m, i, 'lower', lowerModules.length))
          .join('');

        const upperEffDisplay =
          item.specs.effectiveUpperW !== null ? item.specs.effectiveUpperW : Math.round(autoEffectiveW);
        const lowerEffDisplay =
          item.specs.effectiveLowerW !== null ? item.specs.effectiveLowerW : Math.round(autoEffectiveW);

        // ‚òÖ Ïã±ÌÅ¨ÎåÄ Front View SVG ÏÉùÏÑ±
        const sinkW = parseFloat(item.w) || 3000;
        const sinkH = parseFloat(item.h) || 2400;
        const upperH = parseFloat(item.specs.upperH) || 720;
        const lowerH = parseFloat(item.specs.lowerH) || 870;
        const moldingH = parseFloat(item.specs.moldingH) || 50;
        const legH = parseFloat(item.specs.sinkLegHeight) || 120;
        const finishL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const finishR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;

        const svgWidth = 600;
        const svgHeight = 380;
        const scaleX = (svgWidth - 100) / sinkW;
        const scaleY = (svgHeight - 100) / sinkH;
        const scale = Math.min(scaleX, scaleY);
        const drawW = sinkW * scale;
        const drawH = sinkH * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        // Í∞Å ÏòÅÏó≠ ÎÜíÏù¥ (Ïä§ÏºÄÏùº Ï†ÅÏö©)
        const moldingH_s = moldingH * scale;
        const upperH_s = upperH * scale;
        const lowerH_s = lowerH * scale;
        const legH_s = legH * scale;

        let sinkModuleSvg = '';

        // ÏÉÅÎ™∞Îî©
        sinkModuleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${moldingH_s}" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + moldingH_s / 2 + 3}" text-anchor="middle" font-size="9" fill="#666">ÏÉÅÎ™∞Îî© ${moldingH}mm</text>`;

        // ÎèÑÏñ¥ ÏÉâÏÉÅ Î∞è Í∞ÑÍ≤© ÏÑ§Ï†ï
        const showDoors = item.specs.showDoors || false;
        const doorColorU = getDoorColor(item.specs.doorColorUpper || 'ÌôîÏù¥Ìä∏');
        const doorColorL = getDoorColor(item.specs.doorColorLower || 'ÌôîÏù¥Ìä∏');
        const doorGap = 3 * scale; // 3mm Í∞ÑÍ≤©

        // ÏÉÅÎ∂ÄÏû• Î™®ÎìàÎì§
        let upperStartX = offsetX + finishL * scale;
        const upperY = offsetY + moldingH_s;
        upperModules.forEach((mod, idx) => {
          const modW = parseFloat(mod.w) * scale;
          const icons = { hood: 'üåÄ', storage: 'üì¶' };
          const icon = icons[mod.type] || 'üì¶';
          const fillColor = mod.type === 'hood' ? '#fef3c7' : '#eff6ff';
          const strokeColor = mod.type === 'hood' ? '#f59e0b' : '#3b82f6';
          sinkModuleSvg += `<rect x="${upperStartX}" y="${upperY}" width="${modW}" height="${upperH_s}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
      <text x="${upperStartX + modW / 2}" y="${upperY + upperH_s / 2 - 8}" text-anchor="middle" font-size="11" fill="${mod.type === 'hood' ? '#b45309' : '#1d4ed8'}" font-weight="bold">${icon}</text>
      <text x="${upperStartX + modW / 2}" y="${upperY + upperH_s / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${mod.w}</text>`;
          upperStartX += modW;
        });

        // ‚òÖ ÏÉÅÎ∂ÄÏû• ÎèÑÏñ¥ ÌëúÏãú
        if (showDoors) {
          let upperDoorX = offsetX + finishL * scale;
          upperModules.forEach((mod, idx) => {
            const modW = parseFloat(mod.w) * scale;
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = modW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = upperDoorX + d * dW + doorGap / 2;
              sinkModuleSvg += `<rect x="${dX}" y="${upperY + doorGap / 2}" width="${dW - doorGap}" height="${upperH_s - doorGap}" fill="${doorColorU}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
            upperDoorX += modW;
          });
        }

        // Ï§ëÍ∞Ñ Í≥µÍ∞Ñ (ÏÉÅÌåê ÏòÅÏó≠)
        const middleY = upperY + upperH_s;
        const middleH_s = drawH - moldingH_s - upperH_s - lowerH_s - legH_s;
        if (middleH_s > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${middleY}" width="${drawW}" height="${middleH_s}" fill="#fafafa" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4"/>`;
        }

        // ÌïòÎ∂ÄÏû• Î™®ÎìàÎì§ + Îã§Î¶¨Î∞ú Ïó∞Îèô
        let lowerStartX = offsetX + finishL * scale;
        const lowerY = middleY + middleH_s;

        lowerModules.forEach((mod, idx) => {
          const modW = parseFloat(mod.w) * scale;
          const isTall = mod.type === 'tall';
          // ÌÇ§ÌÅ∞Ïû•ÏùÄ ÏÉÅÎ∂ÄÏû•~ÌïòÎ∂ÄÏû•, ÏùºÎ∞ò ÌïòÎ∂ÄÏû•ÏùÄ ÌïòÎ∂ÄÏû•+Îã§Î¶¨Î∞ú
          const modH_s = isTall ? upperH_s + middleH_s + lowerH_s : lowerH_s + legH_s;
          const modY = isTall ? upperY : lowerY;

          const icons = { sink: 'üö∞', cook: 'üî•', tall: '‚ÜïÔ∏è', storage: 'üóÑÔ∏è' };
          const icon = icons[mod.type] || 'üì¶';
          let fillColor = '#f3f4f6';
          let strokeColor = '#6b7280';
          if (mod.type === 'sink') {
            fillColor = '#dbeafe';
            strokeColor = '#3b82f6';
          } else if (mod.type === 'cook') {
            fillColor = '#fee2e2';
            strokeColor = '#ef4444';
          } else if (isTall) {
            fillColor = '#dcfce7';
            strokeColor = '#10b981';
          } else if (mod.isDrawer) {
            fillColor = '#fef3c7';
            strokeColor = '#f59e0b';
          }

          // Î™®Îìà Î≥∏Ï≤¥ (Îã§Î¶¨Î∞ú Ìè¨Ìï® ÎÜíÏù¥)
          sinkModuleSvg += `<rect x="${lowerStartX}" y="${modY}" width="${modW}" height="${modH_s}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>`;

          // Îã§Î¶¨Î∞ú Íµ¨Î∂ÑÏÑ† (ÌÇ§ÌÅ∞Ïû• Ï†úÏô∏)
          if (!isTall) {
            const legLineY = lowerY + lowerH_s;
            sinkModuleSvg += `<line x1="${lowerStartX}" y1="${legLineY}" x2="${lowerStartX + modW}" y2="${legLineY}" stroke="${strokeColor}" stroke-width="1" stroke-dasharray="3"/>`;
            sinkModuleSvg += `<text x="${lowerStartX + modW / 2}" y="${legLineY + legH_s / 2 + 3}" text-anchor="middle" font-size="7" fill="#888">${legH}</text>`;
          }

          // ÎèÑÏñ¥ ÌëúÏãú (showDoorsÍ∞Ä trueÏùº Îïå)
          if (showDoors && !isTall) {
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = modW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = lowerStartX + d * dW + doorGap / 2;
              sinkModuleSvg += `<rect x="${dX}" y="${modY + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_s - doorGap}" fill="${doorColorL}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
          }

          // ÏïÑÏù¥ÏΩò & ÌÖçÏä§Ìä∏ (ÎèÑÏñ¥ ÌëúÏãúÏãú ÏùºÎ∞ò ÌïòÎ∂ÄÏû• ÏïÑÏù¥ÏΩò Ïà®ÍπÄ, ÌÇ§ÌÅ∞Ïû•ÏùÄ Ìï≠ÏÉÅ ÌëúÏãú)
          if (!showDoors || isTall) {
            sinkModuleSvg += `<text x="${lowerStartX + modW / 2}" y="${modY + (isTall ? modH_s : lowerH_s) / 2 - 8}" text-anchor="middle" font-size="12" fill="${strokeColor}" font-weight="bold">${icon}</text>
        <text x="${lowerStartX + modW / 2}" y="${modY + (isTall ? modH_s : lowerH_s) / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${mod.w}${isTall ? ' (TL)' : ''}</text>`;
          }
          lowerStartX += modW;
        });

        // Îã§Î¶¨Î∞ú (Ï†ÑÏ≤¥ ÏòÅÏó≠ - ÎßàÍ∞ê Ìè¨Ìï®)
        const legY = lowerY + lowerH_s;
        // ÎßàÍ∞ê ÏòÅÏó≠ ÏïÑÎûòÏóêÎèÑ Îã§Î¶¨Î∞ú ÌëúÏãú
        if (finishL > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${legY}" width="${finishL * scale}" height="${legH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        }
        if (finishR > 0) {
          sinkModuleSvg += `<rect x="${offsetX + drawW - finishR * scale}" y="${legY}" width="${finishR * scale}" height="${legH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        }

        // Ï¢åÏ∏° ÎßàÍ∞ê
        if (finishL > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${upperY}" width="${finishL * scale}" height="${upperH_s + middleH_s + lowerH_s}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (finishL * scale) / 2}" y="${upperY + (upperH_s + middleH_s + lowerH_s) / 2}" text-anchor="middle" font-size="8" fill="#666" transform="rotate(-90 ${offsetX + (finishL * scale) / 2} ${upperY + (upperH_s + middleH_s + lowerH_s) / 2})">${finishL}</text>`;
        }
        // Ïö∞Ï∏° ÎßàÍ∞ê
        if (finishR > 0) {
          sinkModuleSvg += `<rect x="${offsetX + drawW - finishR * scale}" y="${upperY}" width="${finishR * scale}" height="${upperH_s + middleH_s + lowerH_s}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (finishR * scale) / 2}" y="${upperY + (upperH_s + middleH_s + lowerH_s) / 2}" text-anchor="middle" font-size="8" fill="#666" transform="rotate(-90 ${offsetX + drawW - (finishR * scale) / 2} ${upperY + (upperH_s + middleH_s + lowerH_s) / 2})">${finishR}</text>`;
        }

        // ‚òÖ Í±∏Î†àÎ∞õÏù¥ (ÎèÑÏñ¥ ÌëúÏãúÏãúÏóêÎßå, ÌïòÎ∂ÄÏû•Ïóê ÏÑ§Ïπò)
        if (showDoors) {
          const baseboardH = legH - 5; // Í±∏Î†àÎ∞õÏù¥ ÎÜíÏù¥ = Îã§Î¶¨Î∞ú ÎÜíÏù¥ - 5mm
          const baseboardH_s = baseboardH * scale;
          // ÌïòÎ∂ÄÏû• ÎÑàÎπÑ Ìï©Í≥Ñ (ÌÇ§ÌÅ∞Ïû• Ï†úÏô∏)
          const lowerTotalW = lowerModules
            .filter((m) => m.type !== 'tall')
            .reduce((sum, m) => sum + parseFloat(m.w), 0);

          if (lowerTotalW > 0 && baseboardH > 0) {
            const MAX_BASEBOARD_W = 2400;
            const baseboardCount = Math.ceil(lowerTotalW / MAX_BASEBOARD_W);
            const baseboardY = legY + (legH_s - baseboardH_s);
            let currentX = offsetX + finishL * scale;
            let remainingW = lowerTotalW;

            for (let i = 0; i < baseboardCount; i++) {
              const thisW = Math.min(remainingW, MAX_BASEBOARD_W);
              const thisW_s = thisW * scale;
              sinkModuleSvg += `<rect x="${currentX}" y="${baseboardY}" width="${thisW_s}" height="${baseboardH_s}" fill="#8b5cf6" stroke="#6d28d9" stroke-width="1.5" rx="1"/>
          <text x="${currentX + thisW_s / 2}" y="${baseboardY + baseboardH_s / 2 + 3}" text-anchor="middle" font-size="7" fill="#fff" font-weight="bold">Í±∏Î†àÎ∞õÏù¥ ${thisW}√ó${baseboardH}</text>`;
              currentX += thisW_s;
              remainingW -= thisW;
            }
          }
        }

        const sinkFrontViewSvg = `
    <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;">
      <!-- ÏπòÏàòÏÑ† - ÏÉÅÎã® -->
      <line x1="${offsetX}" y1="${offsetY - 15}" x2="${offsetX + drawW}" y2="${offsetY - 15}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX}" y1="${offsetY - 20}" x2="${offsetX}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX + drawW}" y1="${offsetY - 20}" x2="${offsetX + drawW}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX + drawW / 2}" y="${offsetY - 25}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${sinkW}mm</text>

      <!-- ÏπòÏàòÏÑ† - Ï¢åÏ∏° -->
      <line x1="${offsetX - 15}" y1="${offsetY}" x2="${offsetX - 15}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 10}" y2="${offsetY}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY + drawH}" x2="${offsetX - 10}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX - 25}" y="${offsetY + drawH / 2}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold" transform="rotate(-90 ${offsetX - 25} ${offsetY + drawH / 2})">${sinkH}mm</text>

      <!-- Î™®ÎìàÎì§ -->
      ${sinkModuleSvg}
    </svg>
  `;

        // ÎßàÍ∞ê ÏÑ§Ï†ï
        let cornerHtml = '';
        if (item.specs.layoutShape === 'L') {
          cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ÏΩîÎÑà ÎßàÍ∞ê</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Molding" ${item.specs.finishCorner1Type === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishCorner1Type === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option></select></div><div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>`;
        } else if (item.specs.layoutShape === 'U') {
          cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ÏΩîÎÑà1 ÎßàÍ∞ê</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Molding" ${item.specs.finishCorner1Type === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishCorner1Type === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option></select></div><div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>
    <div class="spec-row"><div class="spec-field"><label>ÏΩîÎÑà2 ÎßàÍ∞ê</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner2Type', this.value)"><option value="Molding" ${item.specs.finishCorner2Type === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishCorner2Type === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option></select></div><div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishCorner2Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner2Width', this.value)"></div></div>`;
        }

        const shapes = { I: '„Ö°ÏûêÌòï (1Í∞ú)', L: '„Ñ±ÏûêÌòï (2Í∞ú)', U: '„Ñ∑ÏûêÌòï (3Í∞ú)' };
        const topCount = item.specs.layoutShape === 'U' ? 3 : item.specs.layoutShape === 'L' ? 2 : 1;
        let topSizeInputs = '';
        for (let i = 0; i < topCount; i++) {
          topSizeInputs += `<input type="text" placeholder="W x D" value="${item.specs.topSizes[i] || ''}" oninput="updateTopSize(${item.uniqueId}, ${i}, this.value)" style="margin-bottom:4px;">`;
        }

        const accHtml = item.specs.accessories
          .map(
            (acc) => `
    <div class="acc-item">
      <select style="flex:1;" onchange="updateAccessory(${item.uniqueId}, ${acc.id}, this.value)">
        <option value="LTMesh" ${acc.type === 'LTMesh' ? 'selected' : ''}>LTÎßùÏû•</option>
        <option value="CircleMesh" ${acc.type === 'CircleMesh' ? 'selected' : ''}>ÏõêÎßùÏû•</option>
        <option value="Cutlery" ${acc.type === 'Cutlery' ? 'selected' : ''}>ÏàòÏ†ÄÎ∂ÑÎ¶¨Ìï®</option>
        <option value="Knife" ${acc.type === 'Knife' ? 'selected' : ''}>ÏπºÍΩÇÏù¥</option>
        <option value="DishRack" ${acc.type === 'DishRack' ? 'selected' : ''}>ÏãùÍ∏∞Í±¥Ï°∞ÎåÄ</option>
        <option value="Etc" ${acc.type === 'Etc' ? 'selected' : ''}>Í∏∞ÌÉÄ</option>
      </select>
      <button class="btn-del-acc" onclick="removeAccessory(${item.uniqueId}, ${acc.id})">√ó</button>
    </div>
  `
          )
          .join('');

        ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ÏÉÅÏÑ∏ ÏÑ§Í≥Ñ <span class="ws-info-badge">W ${item.w} x H ${item.h} x D ${item.d}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ÎîîÏûêÏù∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±">üé® AI ÎîîÏûêÏù∏ ÏÉùÏÑ±</button>
        <button onclick="proceedToBOM()" style="background:linear-gradient(135deg,#4caf50,#388e3c);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" title="ÏûêÏû¨/Î∂ÄÏûêÏû¨ ÏÇ∞Ï∂ú">üìã BOM ÏÇ∞Ï∂ú</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ÏπòÏàò)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥</label><input type="number" value="${item.specs.upperH}" onblur="updateSpecValue(${item.uniqueId}, 'upperH', this.value)"></div>
          <div class="spec-field"><label>ÌïòÎ∂ÄÏû• ÎÜíÏù¥</label><input type="number" value="${item.specs.lowerH}" onblur="updateSpecValue(${item.uniqueId}, 'lowerH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Îã§Î¶¨Î∞ú ÎÜíÏù¥</label>
            <select id="legHeight-${item.uniqueId}" onchange="updateSpec(${item.uniqueId}, 'sinkLegHeight', this.value)">
              <option value="120" ${item.specs.sinkLegHeight == 120 ? 'selected' : ''}>120mm</option>
              <option value="150" ${item.specs.sinkLegHeight == 150 ? 'selected' : ''}>150mm</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÜêÏû°Ïù¥</label><select onchange="updateSpec(${item.uniqueId}, 'handle', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('handle', item.specs.handle, 'sink')}</select></div>
          <div class="spec-field"><label>ÏîΩÌÅ¨Î≥º</label><select onchange="updateSpec(${item.uniqueId}, 'sink', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('sink', item.specs.sink)}</select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏàòÏ†Ñ</label><select onchange="updateSpec(${item.uniqueId}, 'faucet', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('faucet', item.specs.faucet)}</select></div>
          <div class="spec-field"><label>ÌõÑÎìú</label><select onchange="updateSpec(${item.uniqueId}, 'hood', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('hood', item.specs.hood)}</select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïø°ÌÉë</label><select onchange="updateSpec(${item.uniqueId}, 'cooktop', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('cooktop', item.specs.cooktop)}</select></div>
          <div class="spec-field"><label>ÏãùÍ∏∞ÏÑ∏Ï≤ôÍ∏∞</label>
            <select onchange="onDishwasherChange(${item.uniqueId}, this.value)">
              <option value="None" ${item.specs.dishwasher === 'None' ? 'selected' : ''}>ÏóÜÏùå</option>
              <option value="BuiltIn" ${item.specs.dishwasher === 'BuiltIn' ? 'selected' : ''}>ÎπåÌä∏Ïù∏</option>
              <option value="FreeStanding" ${item.specs.dishwasher === 'FreeStanding' ? 'selected' : ''}>ÌîÑÎ¶¨Ïä§ÌÉ†Îî©</option>
            </select>
          </div>
        </div>
        <div class="spec-row">
          <div class="spec-field">
            <label>Ïï°ÏÑ∏ÏÑúÎ¶¨</label>
            <div class="acc-list">${accHtml}</div>
            <button class="btn-add-acc" onclick="addAccessory(${item.uniqueId})">+ Ïï°ÏÑ∏ÏÑúÎ¶¨ Ï∂îÍ∞Ä</button>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ÎèÑÏñ¥)</div>
        <div class="spec-row"><div class="spec-field"><label>ÏÉÅÎ∂ÄÏû• ÎèÑÏñ¥</label><div class="color-select-row"><select onchange="updateSpec(${item.uniqueId}, 'doorFinishUpper', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_finish', item.specs.doorFinishUpper, 'sink')}</select><select onchange="updateSpec(${item.uniqueId}, 'doorColorUpper', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_color', item.specs.doorColorUpper, 'sink')}</select></div></div></div>
        <div class="spec-row"><div class="spec-field"><label>ÌïòÎ∂ÄÏû• ÎèÑÏñ¥</label><div class="color-select-row"><select onchange="updateSpec(${item.uniqueId}, 'doorFinishLower', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_finish', item.specs.doorFinishLower, 'sink')}</select><select onchange="updateSpec(${item.uniqueId}, 'doorColorLower', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_color', item.specs.doorColorLower, 'sink')}</select></div></div></div>

        <div class="spec-group-title">4. Countertop (ÏÉÅÌåê)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÉÅÌåê ÏÉâÏÉÅ</label><select onchange="updateSpec(${item.uniqueId}, 'topColor', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('countertop', item.specs.topColor)}</select></div>
          <div class="spec-field"><label>ÏÉÅÌåê ÎëêÍªò(T)</label><input type="number" value="${item.specs.topThickness}"></div>
        </div>
        <div class="spec-row"><div class="spec-field"><label>ÏÉÅÌåê ÌÅ¨Í∏∞ (${shapes[item.specs.layoutShape]})</label>${topSizeInputs}</div></div>

        <div class="spec-group-title">5. Finish Settings (ÎßàÍ∞ê)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÉÅÎ™∞Îî© ÎÜíÏù¥</label><input type="number" value="${item.specs.moldingH}" onblur="updateSpecValue(${item.uniqueId}, 'moldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ï¢åÏ∏° ÎßàÍ∞ê</label><select onchange="updateFinishType(${item.uniqueId}, 'Left', this.value)"><option value="Molding" ${item.specs.finishLeftType === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishLeftType === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option><option value="EP" ${item.specs.finishLeftType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishLeftType === 'None' ? 'selected' : ''}>ÏóÜÏùå</option></select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïö∞Ï∏° ÎßàÍ∞ê</label><select onchange="updateFinishType(${item.uniqueId}, 'Right', this.value)"><option value="Molding" ${item.specs.finishRightType === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishRightType === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option><option value="EP" ${item.specs.finishRightType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishRightType === 'None' ? 'selected' : ''}>ÏóÜÏùå</option></select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishRightWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
        ${cornerHtml ? `<div class="spec-group-title">Corner Settings (ÏΩîÎÑà)</div>${cornerHtml}` : ''}
      </div>

      <div class="module-panel">
        <!-- ‚òÖ Front View ÎèÑÎ©¥ -->
        <div class="front-view-section" style="margin-bottom:20px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìê Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(Ï†ÑÎ©¥Î∂Ä ÎèÑÎ©¥)</span>
            </div>
            <button onclick="toggleSinkDoors(${item.uniqueId})" class="toggle-btn ${showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">üö™ ÎèÑÏñ¥</button>
          </div>
          ${sinkFrontViewSvg}
        </div>

        <div class="module-section">
          <div class="module-section-header upper">
            <div class="section-title-row"><span>‚¨ÜÔ∏è ÏÉÅÎ∂ÄÏû• Î™®Îìà</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>Ïú†Ìö®Í≥µÍ∞Ñ:</label>
                <input type="number" class="effective-space-input" value="${upperEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'upper', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(upperRemaining)}">ÏûîÏó¨: ${Math.round(upperRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'upper')" ${item.prevUpperModules ? '' : 'disabled'}>‚Ü© ÎêòÎèåÎ¶¨Í∏∞</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'upper')">‚ö° ÏûêÎèôÍ≥ÑÏÇ∞</button>
              </div>
            </div>
          </div>
          <div class="module-list ${upperModules.length === 0 ? 'empty-list' : ''}">${upperModulesHtml}</div>
        </div>

        <div class="module-section">
          <div class="module-section-header lower">
            <div class="section-title-row"><span>‚¨áÔ∏è ÌïòÎ∂ÄÏû• Î™®Îìà</span><span style="font-size:10px;color:#888;">(ÌÇ§ÌÅ∞Ïû• Ìè¨Ìï®)</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>Ïú†Ìö®Í≥µÍ∞Ñ:</label>
                <input type="number" class="effective-space-input" value="${lowerEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'lower', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(lowerRemaining)}">ÏûîÏó¨: ${Math.round(lowerRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'lower')" ${item.prevLowerModules ? '' : 'disabled'}>‚Ü© ÎêòÎèåÎ¶¨Í∏∞</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'lower')">‚ö° ÏûêÎèôÍ≥ÑÏÇ∞</button>
              </div>
            </div>
          </div>
          <div class="module-list ${lowerModules.length === 0 ? 'empty-list' : ''}">${lowerModulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split btn-add-upper" onclick="addStorageModule(${item.uniqueId}, 'upper')">+ ÏÉÅÎ∂ÄÏû•</button>
          <button class="btn-add-split btn-add-lower" onclick="addStorageModule(${item.uniqueId}, 'lower')">+ ÌïòÎ∂ÄÏû•</button>
          <button class="btn-add-split btn-add-tall" onclick="addTallModule(${item.uniqueId})">+ ÌÇ§ÌÅ∞Ïû•(TL)</button>
        </div>
      </div>
    </div>
  `;

        // ‚òÖ Ìè¨Ïª§Ïä§ Î≥µÏõê
        _restoreFocus(ws, focusInfo);
      }

      // ============================================================
      // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ìï®ÏàòÎì§
      // ============================================================

      // ‚òÖ Î∂ôÎ∞ïÏù¥Ïû• Ï†ÑÏö© ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î†åÎçîÎßÅ
      function renderWardrobeWorkspace(item) {
        const ws = document.getElementById('designWorkspace');
        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 0;
        const curtainW = parseFloat(item.specs.curtainBoxW) || 0;
        const curtainH = parseFloat(item.specs.curtainBoxH) || 0;
        const isRefLeft = item.specs.measurementBase === 'Left';

        // Î™®Îìà Ï¥àÍ∏∞Ìôî (ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Î™®Îìà ÏÉùÏÑ±)
        if (!item.modules || item.modules.length === 0) {
          item.modules = [];
        }

        const wardrobeModules = item.modules.filter((m) => m.pos === 'wardrobe');
        const usedW = wardrobeModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        // ‚òÖ Ïú†Ìö®Í≥µÍ∞Ñ: ÏßÅÏ†ë ÏûÖÎ†•Í∞í Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÏûêÎèô Í≥ÑÏÇ∞
        const autoEffectiveW =
          W -
          (item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0) -
          (item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0);
        const effectiveW = item.specs.wardrobeEffectiveW || autoEffectiveW;
        const remaining = effectiveW - usedW;

        // Front View SVG ÏÉùÏÑ± (ÌôïÎåÄ Î∞è ÌïòÎã® Ïó¨Î∞± Ï∂îÍ∞Ä)
        const svgWidth = 650;
        const svgHeight = 450;
        const scale = Math.min((svgWidth - 100) / W, (svgHeight - 100) / H);
        const drawW = W * scale;
        const drawH = H * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 40; // ÏÉÅÎã® Ïó¨Î∞± Í≥†Ï†ï

        // Î™®Îìà SVG Í∑∏Î¶¨Í∏∞
        let moduleSvg = '';
        let currentX = isRefLeft ? 0 : W;

        // Ï¢åÏ∏° ÎßàÍ∞ê
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;

        if (fL > 0) {
          moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${fL * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (fL * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fL}</text>`;
        }

        // Ïª§ÌäºÎ∞ïÏä§ ÌëúÏãú
        let curtainSvg = '';
        if (curtainW > 0 && curtainH > 0) {
          const cbX = isRefLeft ? offsetX + fL * scale : offsetX + drawW - fR * scale - curtainW * scale;
          curtainSvg = `<rect x="${cbX}" y="${offsetY}" width="${curtainW * scale}" height="${curtainH * scale}" fill="#ffe4b5" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4"/>
      <text x="${cbX + (curtainW * scale) / 2}" y="${offsetY + (curtainH * scale) / 2 + 4}" text-anchor="middle" font-size="10" fill="#b45309">Ïª§ÌäºÎ∞ïÏä§</text>`;
        }

        // Î™®Îìà Í∑∏Î¶¨Í∏∞ (ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• Íµ¨Î∂Ñ) + Ïò∑Î¥â/ÏÑ†Î∞ò/ÏÑúÎûç
        let moduleStartX = offsetX + fL * scale;
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const showDoors = item.specs.showDoors || false; // ÎèÑÏñ¥ ÌëúÏãú Ïó¨Î∂Ä
        const doorColor = getDoorColor(item.specs.doorColorUpper || 'ÌôîÏù¥Ìä∏');
        const doorGap = 3 * scale; // 3mm Í∞ÑÍ≤©
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalModuleH = H - pedestalH - moldingH;
        const pedestalHScaled = pedestalH * scale;
        const moldingHScaled = moldingH * scale;
        const PANEL_THICKNESS = 15; // Ï≤úÌåê/ÏßÄÌåê/ÏÑ†Î∞ò ÎëêÍªò
        const ROD_OFFSET = 75; // Ïò∑Î¥â ÏúÑÏπò: ÏÉÅÎã®ÏóêÏÑú -75mm
        const LONG_FIRST_SHELF = 315; // Í∏¥Ïò∑ Ï≤´ ÏÑ†Î∞ò: ÏÉÅÎã®ÏóêÏÑú -315mm
        const DRAWER_HEIGHT = 300; // ÏÑúÎûç ÎÜíÏù¥ (300mm Í≥†Ï†ï)
        const SMARTBAR_WIDTH = 30; // Ïä§ÎßàÌä∏Î∞î ÎÑàÎπÑ
        const handleType = item.specs.handleType || 'bar';

        // ÏÑ†Î∞ò ÏúÑÏπò Í≥ÑÏÇ∞ Ìï®Ïàò (ÏùºÎ∞ò): (Î™®ÎìàÎÜíÏù¥ - Ï≤úÌåê(15) - ÏßÄÌåê(15) - ÏÑ†Î∞òÍ∞ØÏàò*15) / (ÏÑ†Î∞òÍ∞ØÏàò+1)
        const calcShelfPositions = (moduleH, shelfCount, startY, scale) => {
          if (shelfCount <= 0) return [];
          const usableH = moduleH - PANEL_THICKNESS * 2 - shelfCount * PANEL_THICKNESS;
          const spacing = usableH / (shelfCount + 1);
          const positions = [];
          for (let i = 1; i <= shelfCount; i++) {
            const shelfY = startY + PANEL_THICKNESS * scale + (i * spacing + (i - 1) * PANEL_THICKNESS) * scale;
            positions.push(shelfY);
          }
          return positions;
        };

        // Í∏¥Ïò∑Ïö© ÏÑ†Î∞ò ÏúÑÏπò Í≥ÑÏÇ∞ (Ï≤´ ÏÑ†Î∞òÏùÄ ÏÉÅÎã®ÏóêÏÑú -315mm)
        const calcLongShelfPositions = (moduleH, shelfCount, startY, scale) => {
          if (shelfCount <= 0) return [];
          const positions = [];
          // Ï≤´ ÏÑ†Î∞ò: ÏÉÅÎã®ÏóêÏÑú -315mm
          const firstShelfY = startY + LONG_FIRST_SHELF * scale;
          positions.push(firstShelfY);

          if (shelfCount > 1) {
            // ÎÇòÎ®∏ÏßÄ ÏÑ†Î∞ò: Ï≤´ ÏÑ†Î∞ò ÏïÑÎûò Í∑†Îì± Î∂ÑÎ∞∞
            const remainingH = moduleH - LONG_FIRST_SHELF - PANEL_THICKNESS;
            const spacing = remainingH / shelfCount;
            for (let i = 2; i <= shelfCount; i++) {
              const shelfY = firstShelfY + (i - 1) * spacing * scale;
              positions.push(shelfY);
            }
          }
          return positions;
        };

        // ÏÑúÎûç Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
        const drawDrawers = (x, y, w, drawerCount, isExternal, scale) => {
          if (drawerCount <= 0) return '';
          let svg = '';
          const drawerH = DRAWER_HEIGHT * scale;
          const padding = isExternal ? 0 : 5;

          for (let i = 0; i < drawerCount; i++) {
            const drawerY = y - (i + 1) * drawerH;
            const dx = x + padding;
            const dw = w - padding * 2;

            // ÏÑúÎûç Î∞ïÏä§
            svg += `<rect x="${dx}" y="${drawerY}" width="${dw}" height="${drawerH - 2}" fill="#f5f5f5" stroke="#888" stroke-width="1.5"/>`;
            // ÏÑúÎûç ÏÜêÏû°Ïù¥
            const handleY = drawerY + drawerH / 2 - 3;
            const handleW = 30;
            svg += `<rect x="${dx + dw / 2 - handleW / 2}" y="${handleY}" width="${handleW}" height="6" rx="2" fill="#666"/>`;
          }
          return svg;
        };

        // Ïä§ÎßàÌä∏Î∞î Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
        const drawSmartbar = (x, y, h, scale) => {
          const sbW = SMARTBAR_WIDTH * scale;
          const sbH = h * scale;
          return `<rect x="${x}" y="${y}" width="${sbW}" height="${sbH}" fill="#333" stroke="#222" stroke-width="1"/>
      <rect x="${x + 2}" y="${y + sbH * 0.3}" width="${sbW - 4}" height="${sbH * 0.4}" fill="#555" rx="2"/>`;
        };

        wardrobeModules.forEach((mod, idx) => {
          const mW = parseFloat(mod.w) * scale;
          const moduleType = mod.moduleType || 'short';
          const isDivided = moduleType === 'short' || moduleType === 'shelf';
          const isShelfType = moduleType === 'shelf';
          const shelfCountUpper = mod.shelfCountUpper || 0;
          const shelfCountLower = mod.shelfCountLower || 0;
          const shelfCount = mod.shelfCount || 0;
          const drawerCount = mod.drawerCount || 0;
          const isExternalDrawer = mod.isExternalDrawer || false;

          if (isDivided) {
            // ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• Î∂ÑÎ¶¨Ìòï
            const upperH = parseFloat(mod.upperH) || Math.round(totalModuleH / 2);
            const lowerH = parseFloat(mod.lowerH) || Math.round(totalModuleH / 2);
            const upperHScaled = upperH * scale;
            const lowerHScaled = lowerH * scale;

            // ÌïòÎ∂ÄÏû• (ÏïÑÎûò) - Ï¢åÎåÄ ÏúÑÏóê ÏúÑÏπò
            const lowerY = offsetY + drawH - pedestalHScaled - lowerHScaled;
            moduleSvg += `<rect x="${moduleStartX}" y="${lowerY}" width="${mW}" height="${lowerHScaled}" fill="${isShelfType ? '#fffbeb' : '#eff6ff'}" stroke="${isShelfType ? '#f59e0b' : '#3b82f6'}" stroke-width="2"/>`;

            // ÌïòÎ∂ÄÏû• Ïò∑Î¥â (ÏÑ†Î∞òÌòï Ï†úÏô∏) - ÏÉÅÎã®ÏóêÏÑú -75mm
            if (!isShelfType) {
              const rodY = lowerY + ROD_OFFSET * scale;
              moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
            }

            // ÌïòÎ∂ÄÏû• ÏÑ†Î∞ò
            const lowerShelfPositions = calcShelfPositions(lowerH, shelfCountLower, lowerY, scale);
            lowerShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // ÌïòÎ∂ÄÏû• ÏÑúÎûç (ÌïòÎã®ÏóêÏÑú ÏúÑÎ°ú Ïä§ÌÉù)
            const lowerBottom = lowerY + lowerHScaled;
            moduleSvg += drawDrawers(moduleStartX, lowerBottom, mW, drawerCount, isExternalDrawer, scale);

            // ÌïòÎ∂ÄÏû• ÌÖçÏä§Ìä∏
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${lowerY + lowerHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}√ó${lowerH}</text>`;

            // ÏÉÅÎ∂ÄÏû• (ÏúÑ)
            const upperY = lowerY - upperHScaled;
            moduleSvg += `<rect x="${moduleStartX}" y="${upperY}" width="${mW}" height="${upperHScaled}" fill="${isShelfType ? '#fef3c7' : '#ecfdf5'}" stroke="${isShelfType ? '#f59e0b' : '#10b981'}" stroke-width="2"/>`;

            // ÏÉÅÎ∂ÄÏû• Ïò∑Î¥â (ÏÑ†Î∞òÌòï Ï†úÏô∏) - ÏÉÅÎã®ÏóêÏÑú -75mm
            if (!isShelfType) {
              const rodY = upperY + ROD_OFFSET * scale;
              moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
            }

            // ÏÉÅÎ∂ÄÏû• ÏÑ†Î∞ò
            const upperShelfPositions = calcShelfPositions(upperH, shelfCountUpper, upperY, scale);
            upperShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // ÏÉÅÎ∂ÄÏû• ÌÖçÏä§Ìä∏
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${upperY + upperHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}√ó${upperH}</text>`;

            // ÌïòÎã® ÎÑàÎπÑ ÏπòÏàò
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;
          } else {
            // Í∏¥Ïò∑ Îã®ÏùºÌòï - Ï¢åÎåÄ ÏúÑÏóê ÏúÑÏπò
            const mH = parseFloat(mod.h) || totalModuleH;
            const mHScaled = mH * scale;
            const mY = offsetY + drawH - pedestalHScaled - mHScaled;

            moduleSvg += `<rect x="${moduleStartX}" y="${mY}" width="${mW}" height="${mHScaled}" fill="#f0f7ff" stroke="#4a7dff" stroke-width="2"/>`;

            // Í∏¥Ïò∑ Ïò∑Î¥â - ÏÉÅÎã®ÏóêÏÑú -75mm
            const rodY = mY + ROD_OFFSET * scale;
            moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
        <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
        <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;

            // Í∏¥Ïò∑ ÏÑ†Î∞ò (Ï≤´ ÏÑ†Î∞ò: ÏÉÅÎã® -315mm)
            const longShelfPositions = calcLongShelfPositions(mH, shelfCount, mY, scale);
            longShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // Í∏¥Ïò∑ ÏÑúÎûç (ÌïòÎã®ÏóêÏÑú ÏúÑÎ°ú Ïä§ÌÉù)
            const longBottom = mY + mHScaled;
            moduleSvg += drawDrawers(moduleStartX, longBottom, mW, drawerCount, isExternalDrawer, scale);

            // ÌÖçÏä§Ìä∏
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${mY + mHScaled / 2 + 5}" text-anchor="middle" font-size="9" fill="#666">${mod.w}√ó${mH}</text>
        <text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;

            // ÎèÑÏñ¥ ÌëúÏãú (Í∏¥Ïò∑)
            if (showDoors) {
              const doorCount = Math.max(1, Math.round(mod.w / 450));
              const dW = mW / doorCount;
              for (let d = 0; d < doorCount; d++) {
                const dX = moduleStartX + d * dW + doorGap / 2;
                moduleSvg += `<rect x="${dX}" y="${mY + doorGap / 2}" width="${dW - doorGap}" height="${mHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
              }
            }
          }

          // ÎèÑÏñ¥ ÌëúÏãú (ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• ÌÜµÌï© ÎèÑÏñ¥)
          if (showDoors && isDivided) {
            const upperH = parseFloat(mod.upperH) || Math.round(totalModuleH / 2);
            const lowerH = parseFloat(mod.lowerH) || Math.round(totalModuleH / 2);
            const upperHScaled = upperH * scale;
            const lowerHScaled = lowerH * scale;
            const lowerY = offsetY + drawH - pedestalHScaled - lowerHScaled;
            const upperY = lowerY - upperHScaled;

            // Ïô∏Î∂Ä ÏÑúÎûçÏù¥ ÏûàÏúºÎ©¥ ÏÑúÎûç ÎÜíÏù¥ÎßåÌÅº Ï†úÏô∏
            const DRAWER_H = 300;
            const externalDrawerH = isExternalDrawer ? drawerCount * DRAWER_H : 0;
            const doorAreaH = upperH + lowerH - externalDrawerH;
            const doorAreaHScaled = doorAreaH * scale;

            // ÌÜµÌï© ÎèÑÏñ¥ (ÏÉÅÎ∂ÄÏû• + ÌïòÎ∂ÄÏû•, Ïô∏Î∂ÄÏÑúÎûç Ï†úÏô∏)
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = mW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = moduleStartX + d * dW + doorGap / 2;
              moduleSvg += `<rect x="${dX}" y="${upperY + doorGap / 2}" width="${dW - doorGap}" height="${doorAreaHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
            }

            // Ïô∏Î∂Ä ÏÑúÎûç Í∞úÎ≥Ñ ÎèÑÏñ¥
            if (isExternalDrawer && drawerCount > 0) {
              const drawerHScaled = DRAWER_H * scale;
              for (let i = 0; i < drawerCount; i++) {
                const drawerY = offsetY + drawH - pedestalHScaled - (i + 1) * drawerHScaled;
                moduleSvg += `<rect x="${moduleStartX + doorGap / 2}" y="${drawerY + doorGap / 2}" width="${mW - doorGap}" height="${drawerHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
              }
            }
          }

          moduleStartX += mW;
        });

        // Ïö∞Ï∏° ÎßàÍ∞ê
        if (fR > 0) {
          moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY}" width="${fR * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (fR * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fR}</text>`;
        }

        const frontViewSvg = `
    <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;">
      <!-- Ïô∏Í≥ΩÏÑ† -->
      <rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${drawH}" fill="none" stroke="#333" stroke-width="2"/>

      <!-- ÏÉÅÎ™∞Îî© ÏòÅÏó≠ -->
      <rect x="${offsetX + fL * scale}" y="${offsetY}" width="${drawW - fL * scale - fR * scale}" height="${moldingHScaled}" fill="#d4c4a8" stroke="#b8a898" stroke-width="1"/>
      <text x="${offsetX + drawW + 8}" y="${offsetY + moldingHScaled / 2 + 4}" text-anchor="start" font-size="9" fill="#8b7355" font-weight="bold">${moldingH}</text>

      <!-- Ï¢åÎåÄ ÏòÅÏó≠ -->
      <rect x="${offsetX + fL * scale}" y="${offsetY + drawH - pedestalHScaled}" width="${drawW - fL * scale - fR * scale}" height="${pedestalHScaled}" fill="#c9c0b8" stroke="#a9a098" stroke-width="1"/>
      <text x="${offsetX + drawW + 8}" y="${offsetY + drawH - pedestalHScaled / 2 + 4}" text-anchor="start" font-size="9" fill="#7a7168" font-weight="bold">${pedestalH}</text>

      <!-- ÏπòÏàòÏÑ† - ÏÉÅÎã® -->
      <line x1="${offsetX}" y1="${offsetY - 15}" x2="${offsetX + drawW}" y2="${offsetY - 15}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX}" y1="${offsetY - 20}" x2="${offsetX}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX + drawW}" y1="${offsetY - 20}" x2="${offsetX + drawW}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX + drawW / 2}" y="${offsetY - 22}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>

      <!-- ÏπòÏàòÏÑ† - Ï¢åÏ∏° -->
      <line x1="${offsetX - 15}" y1="${offsetY}" x2="${offsetX - 15}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 10}" y2="${offsetY}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY + drawH}" x2="${offsetX - 10}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX - 25}" y="${offsetY + drawH / 2}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold" transform="rotate(-90 ${offsetX - 25} ${offsetY + drawH / 2})">${H}mm</text>

      <!-- Ïª§ÌäºÎ∞ïÏä§ -->
      ${curtainSvg}

      <!-- Î™®ÎìàÎì§ -->
      ${moduleSvg}

      <!-- Ïã§Ï∏° Í∏∞Ï§Ä ÌëúÏãú -->
      <text x="${isRefLeft ? offsetX + 10 : offsetX + drawW - 10}" y="${offsetY + drawH - pedestalHScaled - 5}" text-anchor="${isRefLeft ? 'start' : 'end'}" font-size="10" fill="#4a7dff" font-weight="bold">‚ñº Ïã§Ï∏°Í∏∞Ï§Ä</text>
    </svg>
  `;

        // Î™®Îìà Ïπ¥Îìú Î†åÎçîÎßÅ
        const renderWardrobeModuleCard = (mod, idx, totalCount) => {
          const drawerCount = mod.drawerCount || 0;
          const shelfCountUpper = mod.shelfCountUpper || 0;
          const shelfCountLower = mod.shelfCountLower || 0;
          const shelfCount = mod.shelfCount || 0;
          const rodCountUpper = mod.rodCountUpper || 0;
          const rodCountLower = mod.rodCountLower || 0;
          const moduleType = mod.moduleType || 'short';
          const isDivided = moduleType === 'short' || moduleType === 'shelf';
          const isShelfType = moduleType === 'shelf';
          const isExternalDrawer = mod.isExternalDrawer || false;

          // ÎÜíÏù¥ Í≥ÑÏÇ∞
          const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 0;
          const effectiveH = totalH - pedestalH - moldingH;
          const halfH = Math.floor(effectiveH / 2);

          // Ïπ¥Ïö¥ÌÑ∞ Î∞ïÏä§ Ïä§ÌÉÄÏùº (ÏïïÏ∂ïÌòï)
          const cBoxStyle =
            'display:flex;flex-direction:column;align-items:center;padding:4px 6px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;';
          const cBtnStyle =
            'width:20px;height:20px;border:1px solid #ddd;background:#fff;border-radius:3px;cursor:pointer;font-size:12px;line-height:1;';
          // ÏÑúÎûç ÌÉÄÏûÖ ÌÜ†Í∏Ä (ÏïïÏ∂ïÌòï)
          const drawerToggle = `
      <div class="wm-drawer-toggle">
        <div class="wm-drawer-label">ÏÑúÎûçÌòï</div>
        <div class="wm-drawer-btns">
          <button class="wm-drawer-btn ${!isExternalDrawer ? 'active' : ''}" data-action="setDrawerType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-value="false">ÎÇ¥Î∂Ä</button>
          <button class="wm-drawer-btn ${isExternalDrawer ? 'active' : ''}" data-action="setDrawerType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-value="true">Ïô∏Î∂Ä</button>
        </div>
      </div>
    `;

          return `
      <div class="module-card wm-card" data-module-id="${mod.id}">
        <!-- Ï¢åÏ∏°: Ïù¥Îèô + ÌÉÄÏûÖ -->
        <div class="wm-left">
          <div class="wm-move-btns">
            <button class="btn-move" data-action="moveWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}" data-dir="up" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
            <button class="btn-move" data-action="moveWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}" data-dir="down" ${idx === totalCount - 1 ? 'disabled' : ''}>‚ñº</button>
          </div>
          <button class="wm-type-btn short ${moduleType === 'short' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="short">ÏßßÏùÄÏò∑</button>
          <button class="wm-type-btn long ${moduleType === 'long' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="long">Í∏¥Ïò∑</button>
          <button class="wm-type-btn shelf ${moduleType === 'shelf' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="shelf">ÏÑ†Î∞òÌòï</button>
        </div>

        <!-- Ï§ëÏïô: Î™®Îìà Ï†ïÎ≥¥ -->
        <div class="wm-center">
          <!-- Ìó§Îçî -->
          <div class="wm-header">
            <span class="wm-icon">üö™</span>
            <span class="wm-name">${mod.name}</span>
            <span class="wm-badge ${moduleType}">${moduleType === 'short' ? 'ÏßßÏùÄÏò∑' : moduleType === 'long' ? 'Í∏¥Ïò∑' : 'ÏÑ†Î∞ò'}</span>
            <label class="checkbox-label" style="margin-left:auto;"><input type="checkbox" ${mod.hasMirror ? 'checked' : ''} data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="hasMirror"> Í±∞Ïö∏</label>
            <button class="btn-delete-module" data-action="removeWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}">√ó</button>
          </div>

          ${
            isDivided
              ? `
          <!-- ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• Î∂ÑÎ¶¨Ìòï -->
          <div style="display:flex;flex-direction:column;gap:4px;">
            <!-- ÏÉÅÎ∂ÄÏû• -->
            <div class="wm-section upper">
              <span class="wm-section-label">ÏÉÅÎ∂ÄÏû•</span>
              <span class="wm-dim-label">W</span>
              <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
              <span class="wm-dim-label">H</span>
              <input type="number" class="wm-dim-input" value="${mod.upperH || halfH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="upperH">
              <span class="wm-dim-label">D</span>
              <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
              ${moduleType !== 'short' ? `<button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'upper')">‚öôÔ∏è</button>` : ''}
            </div>
            <!-- ÌïòÎ∂ÄÏû• -->
            <div class="wm-section lower">
              <span class="wm-section-label">ÌïòÎ∂ÄÏû•</span>
              <span class="wm-dim-label">W</span>
              <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
              <span class="wm-dim-label">H</span>
              <input type="number" class="wm-dim-input" value="${mod.lowerH || halfH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="lowerH">
              <span class="wm-dim-label">D</span>
              <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
              <button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'lower')">‚öôÔ∏è</button>
            </div>
          </div>
          `
              : `
          <!-- Í∏¥Ïò∑ Îã®ÏùºÌòï -->
          <div class="wm-section full">
            <span class="wm-section-label">Í∏¥Ïò∑Ïû•</span>
            <span class="wm-dim-label">W</span>
            <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
            <span class="wm-dim-label">H</span>
            <input type="number" class="wm-dim-input" value="${mod.h || effectiveH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="h">
            <span class="wm-dim-label">D</span>
            <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
            <button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'full')">‚öôÔ∏è</button>
          </div>
          `
          }
        </div>
      </div>
    `;
        };

        const modulesHtml = wardrobeModules
          .map((m, i) => renderWardrobeModuleCard(m, i, wardrobeModules.length))
          .join('');

        ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ÏÉÅÏÑ∏ ÏÑ§Í≥Ñ <span class="ws-info-badge">W ${W} x H ${H} x D ${D}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ÎîîÏûêÏù∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±">üé® AI ÎîîÏûêÏù∏ ÏÉùÏÑ±</button>
        <button onclick="proceedToBOM()" style="background:linear-gradient(135deg,#4caf50,#388e3c);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" title="ÏûêÏû¨/Î∂ÄÏûêÏû¨ ÏÇ∞Ï∂ú">üìã BOM ÏÇ∞Ï∂ú</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ÏπòÏàò)</div>
        <div class="spec-row">
          <div class="spec-field"><label>Ï†ÑÏ≤¥ ÎÜíÏù¥</label><input type="number" value="${H}" disabled></div>
          <div class="spec-field"><label>Ï†ÑÏ≤¥ ÍπäÏù¥</label><input type="number" value="${D}" disabled></div>
          <div class="spec-field"><label>Ï¢åÎåÄ ÎÜíÏù¥</label><input type="number" value="${item.specs.wardrobePedestal || 60}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobePedestal', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïª§ÌäºÎ∞ïÏä§ Í∞ÄÎ°ú</label><input type="number" value="${curtainW}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="spec-field"><label>Ïª§ÌäºÎ∞ïÏä§ ÎÜíÏù¥</label><input type="number" value="${curtainH}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÜêÏû°Ïù¥</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'handleType', this.value)">
              <option value="bar" ${(item.specs.handleType || 'bar') === 'bar' ? 'selected' : ''}>ÏùºÏûê ÏÜêÏû°Ïù¥</option>
              <option value="cchannel" ${item.specs.handleType === 'cchannel' ? 'selected' : ''}>CÏ∞¨ÎÑ¨</option>
              <option value="push" ${item.specs.handleType === 'push' ? 'selected' : ''}>Ìë∏Ïâ¨ ÎèÑÏñ¥</option>
              <option value="smartbar" ${item.specs.handleType === 'smartbar' ? 'selected' : ''}>Ïä§ÎßàÌä∏Î∞î</option>
            </select>
          </div>
          <div class="spec-field"><label>Î†àÏùº</label><select><option>ÏÜåÌîÑÌä∏ÌÅ¥Î°úÏßï</option><option>ÏùºÎ∞ò Î†àÏùº</option><option>ÌíÄÏùµÏä§ÌÖêÏÖò</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïã§Ï∏° Í∏∞Ï§Ä</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${isRefLeft ? 'selected' : ''}>Ï¢åÏ∏°</option>
              <option value="Right" ${!isRefLeft ? 'selected' : ''}>Ïö∞Ï∏°</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ÎèÑÏñ¥)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÎèÑÏñ¥ ÏÉâÏÉÅ</label>
            <div class="color-select-row">
              <select onchange="updateWardrobeSpec(${item.uniqueId}, 'doorFinishUpper', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_finish', item.specs.doorFinishUpper, 'wardrobe')}</select>
              <select onchange="updateWardrobeSpec(${item.uniqueId}, 'doorColorUpper', this.value)">${FurnitureOptionCatalog.buildOptionsHtml('door_color', item.specs.doorColorUpper, 'wardrobe')}</select>
            </div>
          </div>
        </div>

        <div class="spec-group-title">4. Finish Settings (ÎßàÍ∞ê)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÉÅÎ™∞Îî© ÎÜíÏù¥(mm)</label><input type="number" value="${item.specs.wardrobeMoldingH || 15}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobeMoldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ï¢åÏ∏° ÎßàÍ∞ê</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Left', this.value)"><option value="Molding" ${item.specs.finishLeftType === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishLeftType === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option><option value="EP" ${item.specs.finishLeftType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishLeftType === 'None' ? 'selected' : ''}>ÏóÜÏùå</option></select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" ${item.specs.finishLeftType === 'EP' || item.specs.finishLeftType === 'None' ? 'disabled' : ''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïö∞Ï∏° ÎßàÍ∞ê</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Right', this.value)"><option value="Molding" ${item.specs.finishRightType === 'Molding' ? 'selected' : ''}>Î™∞Îî©</option><option value="Filler" ${item.specs.finishRightType === 'Filler' ? 'selected' : ''}>Ìú†Îùº</option><option value="EP" ${item.specs.finishRightType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishRightType === 'None' ? 'selected' : ''}>ÏóÜÏùå</option></select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥(mm)</label><input type="number" value="${item.specs.finishRightWidth}" ${item.specs.finishRightType === 'EP' || item.specs.finishRightType === 'None' ? 'disabled' : ''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
      </div>

      <div class="module-panel">
        <!-- ‚òÖ Front View ÎèÑÎ©¥ -->
        <div class="front-view-section" style="margin-bottom:20px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìê Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(Ï†ÑÎ©¥Î∂Ä ÎèÑÎ©¥)</span>
            </div>
            <button onclick="toggleWardrobeDoors(${item.uniqueId})" class="toggle-btn ${item.specs.showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">üö™ ÎèÑÏñ¥</button>
          </div>
          ${frontViewSvg}
        </div>

        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="section-title-row"><span>üö™ Î∂ôÎ∞ïÏù¥Ïû• Î™®Îìà</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>Ïú†Ìö®Í≥µÍ∞Ñ:</label>
                <input type="number" value="${Math.round(item.specs.wardrobeEffectiveW || effectiveW)}" 
                  onblur="updateWardrobeEffectiveW(${item.uniqueId}, this.value)"
                  style="width:70px;padding:2px 6px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.15);color:white;font-weight:bold;font-size:13px;text-align:right;">
                <span style="color:white;">mm</span>
              </div>
              <span class="section-remaining" style="color:${remaining >= 0 && remaining <= 10 ? '#90EE90' : remaining < 0 ? '#ff6b6b' : 'white'}">ÏûîÏó¨: ${Math.round(remaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-auto" onclick="runWardrobeAutoCalc(${item.uniqueId})">‚ö° ÏûêÎèôÍ≥ÑÏÇ∞</button>
              </div>
            </div>
          </div>
          <div class="module-list ${wardrobeModules.length === 0 ? 'empty-list' : ''}">${modulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split" style="border-color:#10b981;color:#10b981;" onclick="addWardrobeModule(${item.uniqueId})">+ Î∂ôÎ∞ïÏù¥Ïû• Î™®Îìà</button>
        </div>
      </div>
    </div>
  `;
      }

      // Î∂ôÎ∞ïÏù¥Ïû• Î™®Îìà Í¥ÄÎ†® Ìï®ÏàòÎì§
      function addWardrobeModule(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // ‚òÖ ÎÜíÏù¥ Í≥ÑÏÇ∞: (Ï†ÑÏ≤¥ÎÜíÏù¥ - Ï¢åÎåÄ - ÏÉÅÎ™∞Îî©) / 2
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalH = parseFloat(item.h) || 0;
        const effectiveH = totalH - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2);

        item.modules.push({
          id: Date.now(),
          type: 'wardrobe',
          name: 'ÏßßÏùÄÏò∑(2Îã®)',
          pos: 'wardrobe',
          w: 900,
          h: effectiveH, // Í∏¥Ïò∑Ïö© Ï†ÑÏ≤¥ ÎÜíÏù¥
          upperH: halfH, // ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥
          lowerH: halfH, // ÌïòÎ∂ÄÏû• ÎÜíÏù¥
          d: parseFloat(item.d) || 650,
          moduleType: 'short',
          isDivided: true,
          drawerCount: 0,
          shelfCount: 0,
          shelfCountUpper: 0,
          shelfCountLower: 0,
          hasMirror: false,
        });
        renderWorkspaceContent(item);
      }

      function removeWardrobeModule(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.modules = item.modules.filter((m) => m.id !== modId);
        renderWorkspaceContent(item);
      }

      function moveWardrobeModule(itemUniqueId, modId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const modules = item.modules.filter((m) => m.pos === 'wardrobe');
        const idx = modules.findIndex((m) => m.id === modId);
        if (idx === -1) return;

        const newIdx = direction === 'up' ? idx - 1 : idx + 1;
        if (newIdx < 0 || newIdx >= modules.length) return;

        [modules[idx], modules[newIdx]] = [modules[newIdx], modules[idx]];
        item.modules = item.modules.filter((m) => m.pos !== 'wardrobe').concat(modules);
        renderWorkspaceContent(item);
      }

      function updateWardrobeModuleDim(itemUniqueId, modId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = parseFloat(value) || 0;
          renderWorkspaceContent(item);
        }
      }

      function toggleWardrobeOption(itemUniqueId, modId, field, checked) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = checked;
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ ÏÑúÎûç Í∞úÏàò Ï°∞Ï†à Ìï®Ïàò
      function adjustWardrobeDrawer(itemUniqueId, modId, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.drawerCount = Math.max(0, Math.min(5, (mod.drawerCount || 0) + delta));
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ Î™®Îìà ÌÉÄÏûÖ ÏÑ§Ï†ï Ìï®Ïàò (ÏßßÏùÄÏò∑2Îã®, Í∏¥Ïò∑1Îã®, ÏÑ†Î∞òÌòï)
      function setWardrobeModuleType(itemUniqueId, modId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.moduleType = type;
          // ÌÉÄÏûÖÏóê Îî∞Î•∏ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
          const typeNames = { short: 'ÏßßÏùÄÏò∑(2Îã®)', long: 'Í∏¥Ïò∑(1Îã®)', shelf: 'ÏÑ†Î∞òÌòï' };
          mod.name = typeNames[type] || mod.name;

          // ‚òÖ ÎÜíÏù¥ Í≥ÑÏÇ∞
          const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 0;
          const effectiveH = totalH - pedestalH - moldingH;
          const halfH = Math.floor(effectiveH / 2);

          // ‚òÖ ÌÉÄÏûÖÎ≥Ñ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
          if (type === 'short') {
            // ÏßßÏùÄÏò∑(2Îã®): ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• 2Îì±Î∂Ñ
            mod.isDivided = true;
            mod.h = effectiveH;
            mod.upperH = halfH;
            mod.lowerH = halfH;
            mod.drawerCount = mod.drawerCount || 0;
            mod.shelfCountUpper = mod.shelfCountUpper || 0;
            mod.shelfCountLower = mod.shelfCountLower || 0;
            mod.shelfCount = 0;
          } else if (type === 'long') {
            // Í∏¥Ïò∑(1Îã®): ÏÑúÎûç Í∏∞Î≥∏Í∞í 1, ÏÑ†Î∞ò Í∏∞Î≥∏Í∞í 1
            mod.isDivided = false;
            mod.h = effectiveH;
            mod.upperH = 0;
            mod.lowerH = 0;
            mod.drawerCount = 1;
            mod.shelfCount = 1;
            mod.shelfCountUpper = 0;
            mod.shelfCountLower = 0;
          } else if (type === 'shelf') {
            // ÏÑ†Î∞òÌòï: ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• 2Îì±Î∂Ñ, ÏÑ†Î∞ò Í∏∞Î≥∏Í∞í ÏÉÅÎ∂Ä2 + ÌïòÎ∂Ä2 = 4
            mod.isDivided = true;
            mod.h = effectiveH;
            mod.upperH = halfH;
            mod.lowerH = halfH;
            mod.drawerCount = mod.drawerCount || 0;
            mod.shelfCountUpper = 2;
            mod.shelfCountLower = 2;
            mod.shelfCount = 0;
          }

          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ ÏÑ†Î∞ò Í∞úÏàò Ï°∞Ï†à Ìï®Ïàò
      function adjustWardrobeShelf(itemUniqueId, modId, section, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          if (section === 'upper') {
            mod.shelfCountUpper = Math.max(0, Math.min(6, (mod.shelfCountUpper || 0) + delta));
          } else {
            mod.shelfCountLower = Math.max(0, Math.min(6, (mod.shelfCountLower || 0) + delta));
          }
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ Í∏¥Ïò∑Ïö© Îã®Ïùº ÏÑ†Î∞ò Í∞úÏàò Ï°∞Ï†à Ìï®Ïàò
      function adjustWardrobeShelfSingle(itemUniqueId, modId, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.shelfCount = Math.max(0, Math.min(6, (mod.shelfCount || 0) + delta));
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ Ïò∑Î¥â Í∞úÏàò Ï°∞Ï†à Ìï®Ïàò (ÏÑ†Î∞òÌòï Î™®ÎìàÏö©)
      function adjustWardrobeRod(itemUniqueId, modId, section, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          if (section === 'upper') {
            mod.rodCountUpper = Math.max(0, Math.min(3, (mod.rodCountUpper || 0) + delta));
          } else {
            mod.rodCountLower = Math.max(0, Math.min(3, (mod.rodCountLower || 0) + delta));
          }
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• ÏÑ§Ï†ï ÌåùÏóÖ Ïó¥Í∏∞
      // ÌòÑÏû¨ Ïó¥Î¶∞ Î∂ôÎ∞ïÏù¥Ïû• ÏÑπÏÖò ÏÑ§Ï†ï ÌåùÏóÖ ÏÉÅÌÉú
      let currentWardrobePopup = { itemId: null, modId: null, section: null };

      function openWardrobeSectionSettings(itemUniqueId, modId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return;

        currentWardrobePopup = { itemId: itemUniqueId, modId: modId, section: section };
        renderWardrobeSectionPopup(item, mod, section);
      }

      function renderWardrobeSectionPopup(item, mod, section) {
        const existingPopup = document.getElementById('wardrobe-section-popup');
        if (existingPopup) existingPopup.remove();

        const moduleType = mod.moduleType || 'short'; // short, long, shelf
        const isShortType = moduleType === 'short';
        const isLongType = moduleType === 'long';
        const isShelfType = moduleType === 'shelf';
        const isFullType = section === 'full';

        let sectionName, sectionColor, sectionBg;
        if (section === 'upper') {
          sectionName = 'ÏÉÅÎ∂ÄÏû•';
          sectionColor = '#10b981';
          sectionBg = '#ecfdf5';
        } else if (section === 'lower') {
          sectionName = 'ÌïòÎ∂ÄÏû•';
          sectionColor = '#3b82f6';
          sectionBg = '#eff6ff';
        } else {
          sectionName = 'Í∏¥Ïò∑Ïû•';
          sectionColor = '#4a7dff';
          sectionBg = '#f0f7ff';
        }

        // ÏÑúÎûç ÎÜíÏù¥ 300mm Í≥†Ï†ï
        const DRAWER_HEIGHT = 300;
        // ÏÑ†Î∞ò ÎÇ¥Í≤Ω 300mm
        const SHELF_INNER_HEIGHT = 300;

        let shelfCount, rodCount, drawerCount, hasRod;
        if (isFullType) {
          // Í∏¥Ïò∑(1Îã®) - ÏÑ†Î∞ò, ÏÑúÎûç Í∞ÄÎä•
          shelfCount = mod.shelfCount || 0;
          drawerCount = mod.drawerCount || 0;
          rodCount = 1; // Í∏∞Î≥∏ Ïò∑Î¥â 1Í∞ú
          hasRod = true;
        } else if (section === 'upper') {
          shelfCount = mod.shelfCountUpper || 0;
          rodCount = mod.rodCountUpper || 0;
          hasRod = rodCount > 0;
          drawerCount = 0;
        } else {
          shelfCount = mod.shelfCountLower || 0;
          rodCount = mod.rodCountLower || 0;
          hasRod = rodCount > 0;
          drawerCount = mod.drawerCount || 0;
        }

        // ÎÜíÏù¥ Í≥ÑÏÇ∞
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalH = parseFloat(item.h) || 0;
        const effectiveH = totalH - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2);
        let sectionH;
        if (isFullType) {
          sectionH = mod.h || effectiveH;
        } else {
          sectionH = section === 'upper' ? mod.upperH || halfH : mod.lowerH || halfH;
        }

        // SVG ÌîÑÎ°†Ìä∏Î∑∞ ÏÉùÏÑ±
        const svgW = 180;
        const svgH = 280;
        const scale = Math.min((svgW - 40) / mod.w, (svgH - 80) / sectionH);
        const drawW = mod.w * scale;
        const drawH = sectionH * scale;
        const offsetX = (svgW - drawW) / 2;
        const offsetY = 40;

        // ÏÑúÎûç/ÏÑ†Î∞ò/Ïò∑Î¥â Í∑∏Î¶¨Í∏∞
        let contentSvg = '';

        // ÏÑúÎûç Í∑∏Î¶¨Í∏∞ (300mm Í≥†Ï†ï ÎÜíÏù¥, ÏïÑÎûòÎ∂ÄÌÑ∞)
        const drawerH_scaled = DRAWER_HEIGHT * scale;
        const totalDrawerH = drawerCount * DRAWER_HEIGHT;
        for (let i = 0; i < drawerCount; i++) {
          const y = offsetY + drawH - drawerH_scaled * (i + 1);
          contentSvg += `<rect x="${offsetX + 3}" y="${y}" width="${drawW - 6}" height="${drawerH_scaled - 2}" fill="#e5e7eb" stroke="#6366f1" stroke-width="1.5" rx="2"/>
      <line x1="${offsetX + drawW / 2 - 15}" y1="${y + drawerH_scaled / 2}" x2="${offsetX + drawW / 2 + 15}" y2="${y + drawerH_scaled / 2}" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
      <text x="${offsetX + drawW - 8}" y="${y + drawerH_scaled / 2 + 3}" text-anchor="end" font-size="7" fill="#6366f1">${DRAWER_HEIGHT}</text>`;
        }

        // ÏÑ†Î∞ò Í∑∏Î¶¨Í∏∞ (Í∏¥Ïò∑Ïû•ÏùÄ ÏÑúÎûç ÏúÑÎ∂ÄÌÑ∞, ÎÇ¥Í≤Ω 300mm Í∞ÑÍ≤©)
        if (isFullType && shelfCount > 0) {
          const availableH = sectionH - totalDrawerH - 50; // Ïò∑Î¥â Í≥µÍ∞Ñ Ï†úÏô∏
          const shelfStartY = offsetY + 50; // Ïò∑Î¥â ÏïÑÎûò
          for (let i = 0; i < shelfCount; i++) {
            const y = offsetY + drawH - totalDrawerH * scale - (i + 1) * SHELF_INNER_HEIGHT * scale;
            if (y > shelfStartY) {
              contentSvg += `<line x1="${offsetX + 5}" y1="${y}" x2="${offsetX + drawW - 5}" y2="${y}" stroke="#9ca3af" stroke-width="2"/>`;
            }
          }
        } else if (!isFullType && shelfCount > 0) {
          const shelfGap = (drawH - totalDrawerH * scale) / (shelfCount + 1);
          for (let i = 1; i <= shelfCount; i++) {
            const y = offsetY + shelfGap * i;
            contentSvg += `<line x1="${offsetX + 5}" y1="${y}" x2="${offsetX + drawW - 5}" y2="${y}" stroke="#9ca3af" stroke-width="2"/>`;
          }
        }

        // Ïò∑Î¥â ÌëúÏãú
        if (isFullType || hasRod) {
          const rodY = offsetY + 25;
          contentSvg += `<line x1="${offsetX + 10}" y1="${rodY}" x2="${offsetX + drawW - 10}" y2="${rodY}" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
      <circle cx="${offsetX + 10}" cy="${rodY}" r="4" fill="#f59e0b"/>
      <circle cx="${offsetX + drawW - 10}" cy="${rodY}" r="4" fill="#f59e0b"/>`;
        }

        // Ïª®Ìä∏Î°§ ÏÉùÏÑ± - ÌÉÄÏûÖÎ≥ÑÎ°ú Îã§Î•∏ ÏòµÏÖò
        let controlsHtml = '';

        if (isShortType && section === 'lower') {
          // ÏßßÏùÄÏò∑ ÌïòÎ∂ÄÏû•: ÏÑúÎûçÎßå
          controlsHtml = `
      <div class="ws-counter-row">
        <span class="ws-counter-label" style="color:#6366f1;">ÏÑúÎûç (300mm)</span>
        <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
          <button onclick="adjustWardrobePopupValue('drawer', -1)">‚àí</button>
          <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
          <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
        </div>
      </div>
    `;
        } else if (isFullType) {
          // Í∏¥Ïò∑(1Îã®): Ïò∑Î¥â 1Í∞ú ÏûêÎèô(ÏòµÏÖò ÌëúÏãú ÏóÜÏùå), ÏÑ†Î∞ò+ÏÑúÎûç (ÏÑúÎûçÏùÄ ÏÑ†Î∞ò ÏïÑÎûò)
          controlsHtml = `
      <div style="font-size:10px;color:#b45309;padding:6px 12px;background:#fef3c7;border-radius:4px;margin-bottom:8px;">‚Äª Ïò∑Î¥â 1Í∞ú ÏûêÎèô ÏÑ§Ïπò (ÏÉÅÎã® Í≥†Ï†ïÏÑ†Î∞ò ÏïÑÎûò)</div>
      <div class="ws-counter-row">
        <span class="ws-counter-label">ÏÑ†Î∞ò (ÎÇ¥Í≤Ω 300mm)</span>
        <div class="ws-counter-box">
          <button onclick="adjustWardrobePopupValue('shelf', -1)">‚àí</button>
          <span id="ws-shelf-count">${shelfCount}</span>
          <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
        </div>
      </div>
      <div class="ws-counter-row">
        <span class="ws-counter-label" style="color:#6366f1;">ÏÑúÎûç (300mm)</span>
        <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
          <button onclick="adjustWardrobePopupValue('drawer', -1)">‚àí</button>
          <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
          <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
        </div>
      </div>
      <div style="font-size:10px;color:#888;padding:4px 12px;background:#f3f4f6;border-radius:4px;">‚Äª ÏÑúÎûçÏùÄ ÏÑ†Î∞ò ÏïÑÎûòÏóê Î∞∞ÏπòÎê©ÎãàÎã§</div>
    `;
        } else if (isShelfType) {
          // ÏÑ†Î∞òÌòï: Î∞∞ÌÉÄÏ†Å ÏûêÎèô ÏÑ†ÌÉù (ÏÑ†Î∞ò‚ÜîÏò∑Î¥â ÏûêÎèô Ï†ÑÌôò)
          if (section === 'upper') {
            // ÏÉÅÎ∂ÄÏû•: ÏÑ†Î∞ò OR Ïò∑Î¥â 1Í∞ú (ÏûêÎèô Ï†ÑÌôò)
            const shelfActive = shelfCount > 0;
            const rodActive = rodCount > 0;
            controlsHtml = `
        <div style="font-size:11px;color:#666;padding:8px;background:#fff7ed;border-radius:6px;margin-bottom:8px;">‚Äª ÏÑ†Î∞ò/Ïò∑Î¥â ÏÑ†ÌÉù Ïãú Î∞òÎåÄ Ìï≠Î™© ÏûêÎèô Ìï¥Ï†ú</div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label">ÏÑ†Î∞ò</span>
          <div class="ws-counter-box">
            <button onclick="adjustWardrobePopupValue('shelf', -1)">‚àí</button>
            <span id="ws-shelf-count">${shelfCount}</span>
            <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${shelfActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#b45309;">Ïò∑Î¥â (1Í∞ú)</span>
          <div class="ws-counter-box" style="border-color:#f59e0b;background:#fef3c7;">
            <button onclick="adjustWardrobePopupValue('rod', -1)">‚àí</button>
            <span id="ws-rod-count" style="color:#b45309;">${rodCount}</span>
            <button onclick="adjustWardrobePopupValue('rod', 1)">+</button>
          </div>
        </div>
      `;
          } else {
            // ÌïòÎ∂ÄÏû•: (ÏÑ†Î∞ò+ÏÑúÎûç) OR Ïò∑Î¥â (ÏûêÎèô Ï†ÑÌôò)
            const rodActive = rodCount > 0;
            const shelfDrawerActive = shelfCount > 0 || drawerCount > 0;
            controlsHtml = `
        <div style="font-size:11px;color:#666;padding:8px;background:#fff7ed;border-radius:6px;margin-bottom:8px;">‚Äª ÏÑ†Î∞ò/ÏÑúÎûç‚ÜîÏò∑Î¥â ÏÑ†ÌÉù Ïãú Î∞òÎåÄ Ìï≠Î™© ÏûêÎèô Ìï¥Ï†ú</div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label">ÏÑ†Î∞ò</span>
          <div class="ws-counter-box">
            <button onclick="adjustWardrobePopupValue('shelf', -1)">‚àí</button>
            <span id="ws-shelf-count">${shelfCount}</span>
            <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#6366f1;">ÏÑúÎûç (300mm)</span>
          <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
            <button onclick="adjustWardrobePopupValue('drawer', -1)">‚àí</button>
            <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
            <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${shelfDrawerActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#b45309;">Ïò∑Î¥â (1Í∞ú)</span>
          <div class="ws-counter-box" style="border-color:#f59e0b;background:#fef3c7;">
            <button onclick="adjustWardrobePopupValue('rod', -1)">‚àí</button>
            <span id="ws-rod-count" style="color:#b45309;">${rodCount}</span>
            <button onclick="adjustWardrobePopupValue('rod', 1)">+</button>
          </div>
        </div>
      `;
          }
        }

        const popupHtml = `
    <div id="wardrobe-section-popup" class="ws-popup-overlay" onclick="if(event.target===this)closeWardrobeSectionPopup()">
      <div class="ws-popup">
        <div class="ws-popup-header" style="background:${sectionColor};">
          <span>üö™ ${mod.name} - ${sectionName} ÏÑ§Ï†ï</span>
          <button onclick="closeWardrobeSectionPopup()" class="ws-popup-close">‚úï</button>
        </div>
        <div class="ws-popup-body">
          <div class="ws-popup-preview">
            <svg width="${svgW}" height="${svgH}" style="background:#fafafa;border-radius:10px;border:1px solid #e5e7eb;">
              <text x="${svgW / 2}" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">${sectionName} Front View</text>
              <rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${drawH}" fill="${sectionBg}" stroke="${sectionColor}" stroke-width="2" rx="4"/>
              ${contentSvg}
              <text x="${svgW / 2}" y="${offsetY + drawH + 20}" text-anchor="middle" font-size="10" fill="#666">${mod.w} √ó ${sectionH}mm</text>
            </svg>
          </div>
          <div class="ws-popup-controls">
            ${controlsHtml}
          </div>
        </div>
        <div class="ws-popup-footer">
          <button onclick="applyWardrobeSectionAndClose()" class="ws-popup-save-btn">ÏôÑÎ£å</button>
        </div>
      </div>
    </div>
    <style>
      .ws-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center}
      .ws-popup{background:white;border-radius:16px;width:420px;max-width:95vw;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
      .ws-popup-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:white;font-weight:700;font-size:14px}
      .ws-popup-close{background:none;border:none;color:white;font-size:20px;cursor:pointer}
      .ws-popup-body{display:flex;gap:20px;padding:20px}
      .ws-popup-preview{flex:0 0 auto}
      .ws-popup-controls{flex:1;display:flex;flex-direction:column;gap:10px;justify-content:center}
      .ws-counter-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f9fafb;border-radius:8px}
      .ws-counter-label{font-weight:700;font-size:12px;color:#374151}
      .ws-counter-box{display:flex;align-items:center;gap:8px;padding:6px 10px;border:2px solid #e5e7eb;border-radius:8px;background:white}
      .ws-counter-box button{width:28px;height:28px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:16px;font-weight:bold}
      .ws-counter-box button:hover{background:#f3f4f6}
      .ws-counter-box span{min-width:24px;text-align:center;font-weight:bold;font-size:16px}
      .ws-popup-footer{padding:14px 20px;border-top:1px solid #e5e7eb;background:#f9fafb;text-align:right}
      .ws-popup-save-btn{padding:10px 24px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer}
      .ws-popup-save-btn:hover{opacity:0.9}
    </style>
  `;
        document.body.insertAdjacentHTML('beforeend', popupHtml);
      }

      function adjustWardrobePopupValue(type, delta) {
        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentWardrobePopup.modId);
        if (!mod) return;
        const section = currentWardrobePopup.section;
        const isShelfType = mod.moduleType === 'shelf';

        if (type === 'shelf') {
          if (section === 'upper') {
            mod.shelfCountUpper = Math.max(0, Math.min(6, (mod.shelfCountUpper || 0) + delta));
            // ÏÑ†Î∞òÌòï ÏÉÅÎ∂ÄÏû•: ÏÑ†Î∞ò Ï∂îÍ∞ÄÏãú Ïò∑Î¥â Ï†úÍ±∞
            if (isShelfType && mod.shelfCountUpper > 0) mod.rodCountUpper = 0;
          } else if (section === 'full') {
            mod.shelfCount = Math.max(0, Math.min(6, (mod.shelfCount || 0) + delta));
          } else {
            mod.shelfCountLower = Math.max(0, Math.min(6, (mod.shelfCountLower || 0) + delta));
            // ÏÑ†Î∞òÌòï ÌïòÎ∂ÄÏû•: ÏÑ†Î∞ò/ÏÑúÎûç Ï∂îÍ∞ÄÏãú Ïò∑Î¥â Ï†úÍ±∞
            if (isShelfType && mod.shelfCountLower > 0) mod.rodCountLower = 0;
          }
        } else if (type === 'rod') {
          if (section === 'upper') {
            mod.rodCountUpper = Math.max(0, Math.min(1, (mod.rodCountUpper || 0) + delta));
            // ÏÑ†Î∞òÌòï ÏÉÅÎ∂ÄÏû•: Ïò∑Î¥â Ï∂îÍ∞ÄÏãú ÏÑ†Î∞ò Ï†úÍ±∞
            if (isShelfType && mod.rodCountUpper > 0) mod.shelfCountUpper = 0;
          } else if (section !== 'full') {
            mod.rodCountLower = Math.max(0, Math.min(1, (mod.rodCountLower || 0) + delta));
            // ÏÑ†Î∞òÌòï ÌïòÎ∂ÄÏû•: Ïò∑Î¥â Ï∂îÍ∞ÄÏãú ÏÑ†Î∞ò/ÏÑúÎûç Ï†úÍ±∞
            if (isShelfType && mod.rodCountLower > 0) {
              mod.shelfCountLower = 0;
              mod.drawerCount = 0;
            }
          }
        } else if (type === 'drawer') {
          mod.drawerCount = Math.max(0, Math.min(6, (mod.drawerCount || 0) + delta));
          // ÏÑ†Î∞òÌòï ÌïòÎ∂ÄÏû•: ÏÑúÎûç Ï∂îÍ∞ÄÏãú Ïò∑Î¥â Ï†úÍ±∞
          if (isShelfType && section === 'lower' && mod.drawerCount > 0) {
            mod.rodCountLower = 0;
          }
        }

        renderWardrobeSectionPopup(item, mod, section);
      }

      function closeWardrobeSectionPopup() {
        const popup = document.getElementById('wardrobe-section-popup');
        if (popup) popup.remove();

        // Î©îÏù∏ ÌîÑÎ°†Ìä∏Î∑∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (item) renderWorkspaceContent(item);

        currentWardrobePopup = { itemId: null, modId: null, section: null };
      }

      function applyWardrobeSectionAndClose() {
        const popup = document.getElementById('wardrobe-section-popup');
        if (popup) popup.remove();

        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (item) renderWorkspaceContent(item);

        currentWardrobePopup = { itemId: null, modId: null, section: null };
      }

      // ‚òÖ ÏÑúÎûç Ïô∏Î∂ÄÌòï/ÎÇ¥Î∂ÄÌòï ÌÜ†Í∏Ä Ìï®Ïàò
      function toggleWardrobeDrawerType(itemUniqueId, modId, isExternal) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.isExternalDrawer = isExternal;
          renderWorkspaceContent(item);
        }
      }

      // ‚òÖ ÎßàÍ∞ê ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ìï®Ïàò (EP ÏÑ†ÌÉù Ïãú Í∏∏Ïù¥ 20ÏúºÎ°ú Í≥†Ï†ï)
      function updateWardrobeFinishType(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // ÌÉÄÏûÖÏóê Îî∞Î•∏ Í∏∞Î≥∏ ÎÑàÎπÑ: Î™∞Îî© 60, Ìú†Îùº 60, EP 20, ÏóÜÏùå 0
        const defaultWidths = { Molding: 60, Filler: 60, EP: 20, None: 0 };
        const defaultWidth = defaultWidths[value] || 0;

        item.specs[`finish${side}Type`] = value;
        item.specs[`finish${side}Width`] = defaultWidth;

        // ‚òÖ Ïú†Ìö®Í≥µÍ∞Ñ ÏûêÎèô Ïû¨Í≥ÑÏÇ∞
        recalcWardrobeEffectiveW(item);

        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû• ÌõÑ Î†åÎçîÎßÅ
        const specPanel = document.querySelector('.spec-panel');
        const scrollTop = specPanel ? specPanel.scrollTop : 0;
        renderWorkspaceContent(item);
        const newSpecPanel = document.querySelector('.spec-panel');
        if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
      }

      // ‚òÖ Ïú†Ìö®Í≥µÍ∞Ñ ÏûêÎèô Ïû¨Í≥ÑÏÇ∞ Ìï®Ïàò
      function recalcWardrobeEffectiveW(item) {
        const W = parseFloat(item.w) || 0;
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        item.specs.wardrobeEffectiveW = W - fL - fR;
      }

      function updateWardrobeSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);

        // ‚òÖ ÎßàÍ∞ê Í∏∏Ïù¥ Î≥ÄÍ≤Ω Ïãú Ïú†Ìö®Í≥µÍ∞Ñ Ïû¨Í≥ÑÏÇ∞
        if (field === 'finishLeftWidth' || field === 'finishRightWidth') {
          recalcWardrobeEffectiveW(item);
        }

        renderWorkspaceContent(item);
      }

      // Î∂ôÎ∞ïÏù¥Ïû• ÎèÑÏñ¥ ÌëúÏãú ÌÜ†Í∏Ä
      function toggleWardrobeDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      // ‚òÖ Ïú†Ìö®Í≥µÍ∞Ñ ÏßÅÏ†ë ÏàòÏ†ï Ìï®Ïàò
      function updateWardrobeEffectiveW(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const newValue = parseFloat(value);
        if (!isNaN(newValue) && newValue > 0) {
          item.specs.wardrobeEffectiveW = newValue;
        } else {
          // Îπà Í∞íÏù¥Î©¥ ÏûêÎèô Í≥ÑÏÇ∞ Î™®ÎìúÎ°ú Î≥µÍ∑Ä
          delete item.specs.wardrobeEffectiveW;
        }
        renderWorkspaceContent(item);
      }

      function runWardrobeAutoCalc(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 650;

        // ‚òÖ ÎÜíÏù¥ Í≥ÑÏÇ∞: (Ï†ÑÏ≤¥ÎÜíÏù¥ - Ï¢åÎåÄ - ÏÉÅÎ™∞Îî©)
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const effectiveH = H - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2); // ÏÉÅÎ∂ÄÏû•/ÌïòÎ∂ÄÏû• Í∞ÅÍ∞Å (ÎÇ¥Î¶º)

        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        // ‚òÖ Ïú†Ìö®Í≥µÍ∞Ñ: ÏßÅÏ†ë ÏûÖÎ†•Í∞í Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ ÏûêÎèô Í≥ÑÏÇ∞
        const effectiveW = item.specs.wardrobeEffectiveW || W - fL - fR;

        if (effectiveW <= 0) {
          alert('Ïú†Ìö® Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
          return;
        }

        const handleType = item.specs.handleType || 'bar';
        const SMARTBAR_WIDTH = 30; // Ïä§ÎßàÌä∏Î∞î ÎÑàÎπÑ
        const TARGET_DOOR_WIDTH = 480; // Î™©Ìëú ÎèÑÏñ¥ ÎÑàÎπÑ
        const TOLERANCE = 10; // ÏãúÍ≥µ Ïó¨Ïú†Í≥µÍ∞Ñ

        item.modules = item.modules.filter((m) => m.pos !== 'wardrobe');

        // ‚òÖ Î™®Îìà ÌÉÄÏûÖ Í∏∞Î≥∏Í∞í Ìï®Ïàò (ÏóÖÎç∞Ïù¥Ìä∏: 2ÌÜµ/3ÌÜµ/4ÌÜµ/Î∞òÌÜµ Í∑úÏπô)
        const getModuleTypeDefaults = (modules2DCount, modules1DCount, idx, is2D) => {
          // Î∞òÌÜµ(1D)Îßå ÏûàÎäî Í≤ΩÏö∞: ÏÑ†Î∞òÌòï
          if (!is2D) {
            return { type: 'shelf', name: 'ÏÑ†Î∞òÌòï', isDivided: true };
          }

          // 2ÌÜµ (2D, 2D): ÏßßÏùÄÏò∑(2Îã®), Í∏¥Ïò∑(1Îã®)
          if (modules2DCount === 2 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 1) return { type: 'long', name: 'Í∏¥Ïò∑(1Îã®)', isDivided: false };
          }

          // 3ÌÜµ (2D, 2D, 2D): ÏßßÏùÄÏò∑(2Îã®), ÏßßÏùÄÏò∑(2Îã®), Í∏¥Ïò∑(1Îã®)
          if (modules2DCount === 3 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'Í∏¥Ïò∑(1Îã®)', isDivided: false };
          }

          // 4ÌÜµ (2D, 2D, 2D, 2D): ÏßßÏùÄÏò∑(2Îã®), ÏßßÏùÄÏò∑(2Îã®), Í∏¥Ïò∑(1Îã®), ÏÑ†Î∞òÌòï
          if (modules2DCount === 4 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'Í∏¥Ïò∑(1Îã®)', isDivided: false };
            if (idx === 3) return { type: 'shelf', name: 'ÏÑ†Î∞òÌòï', isDivided: true };
          }

          // 2D + 1D Ï°∞Ìï©: ÎßàÏßÄÎßâ 1DÎäî ÏÑ†Î∞òÌòï
          if (modules2DCount === 2 && modules1DCount === 1) {
            // 2D, 2D, 1D: ÏßßÏùÄÏò∑, Í∏¥Ïò∑, ÏÑ†Î∞ò
            if (idx === 0) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 1) return { type: 'long', name: 'Í∏¥Ïò∑(1Îã®)', isDivided: false };
          }

          if (modules2DCount === 3 && modules1DCount === 1) {
            // 2D, 2D, 2D, 1D: ÏßßÏùÄÏò∑, ÏßßÏùÄÏò∑, Í∏¥Ïò∑, ÏÑ†Î∞ò
            if (idx === 0) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'Í∏¥Ïò∑(1Îã®)', isDivided: false };
          }

          // Í∏∞Î≥∏Í∞í
          return { type: 'short', name: 'ÏßßÏùÄÏò∑(2Îã®)', isDivided: true };
        };

        if (handleType === 'smartbar') {
          // ‚òÖ Ïä§ÎßàÌä∏Î∞î Î™®Îìú: ÎèÑÏñ¥ Í∑†Îì±Î∂ÑÎ∞∞ (ÏµúÏö∞ÏÑ†)

          // 1. Ï¥ù ÎèÑÏñ¥ Ïàò Í≤∞Ï†ï (Î™©Ìëú 480mm Í∏∞Ï§Ä)
          const totalDoors = Math.round(effectiveW / TARGET_DOOR_WIDTH);

          if (totalDoors <= 0) {
            alert('Í≥µÍ∞ÑÏù¥ ÎÑàÎ¨¥ ÏûëÏäµÎãàÎã§.');
            return;
          }

          // 2. Î™®Îìà Ï°∞Ìï© Í≤∞Ï†ï (2D Ïö∞ÏÑ†)
          const modules2D = Math.floor(totalDoors / 2);
          const modules1D = totalDoors % 2;
          const totalModules = modules2D + modules1D;

          // 3. Ïä§ÎßàÌä∏Î∞î Ï¥ù ÎÑàÎπÑ
          const smartbarTotal = totalModules * SMARTBAR_WIDTH;

          // 4. ÎèÑÏñ¥ Í≥µÍ∞Ñ Í∑†Îì±Î∂ÑÎ∞∞ (‚òÖ Î™®Îì† ÎèÑÏñ¥ ÎèôÏùº ÎÑàÎπÑ)
          const doorSpace = effectiveW - smartbarTotal;
          const doorWidth = Math.floor(doorSpace / totalDoors); // Í∑†Îì± ÎèÑÏñ¥ ÎÑàÎπÑ
          const usedDoorSpace = doorWidth * totalDoors;
          const remainder = doorSpace - usedDoorSpace; // Ïó¨Ïú†Í≥µÍ∞Ñ (ÏãúÍ≥µ Ïó¨Ïú†)

          // 5. Î™®Îìà ÏÉùÏÑ± (Î™®Îì† ÎèÑÏñ¥ ÎèôÏùº ÎÑàÎπÑ)
          let doorIdx = 0;

          // 2D Î™®ÎìàÎì§
          for (let i = 0; i < modules2D; i++) {
            const modWidth = doorWidth * 2 + SMARTBAR_WIDTH;
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, i, true);

            item.modules.push({
              id: Date.now() + i,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: modWidth,
              doorCount: 2,
              doorWidth: doorWidth,
              hasSmartbar: true,
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          }

          // 1D Î™®Îìà (ÏûàÏúºÎ©¥)
          if (modules1D > 0) {
            const modWidth = doorWidth + SMARTBAR_WIDTH;
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, 0, false);

            item.modules.push({
              id: Date.now() + modules2D,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: modWidth,
              doorCount: 1,
              doorWidth: doorWidth,
              hasSmartbar: true,
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: 0,
              shelfCount: 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          }

          // Í≤ÄÏ¶ù Î°úÍ∑∏
          const totalWidth = item.modules.filter((m) => m.pos === 'wardrobe').reduce((sum, m) => sum + m.w, 0);
          console.log(`Ïä§ÎßàÌä∏Î∞î Í≥ÑÏÇ∞: ÎèÑÏñ¥ÎÑàÎπÑ=${doorWidth}mm, Î™®ÎìàÌï©=${totalWidth}mm, Ïó¨Ïú†Í≥µÍ∞Ñ=${remainder}mm`);

          if (remainder > TOLERANCE) {
            console.warn(`ÏãúÍ≥µ Ïó¨Ïú†Í≥µÍ∞Ñ Ï¥àÍ≥º: ${remainder}mm (ÌóàÏö©: ${TOLERANCE}mm)`);
          }
        } else {
          // ‚òÖ ÏùºÎ∞ò Î™®Îìú: Í∏∞Ï°¥ Î∂ÑÎ∞∞Í∑úÏπô Ï†ÅÏö©
          const result = distributeModules(effectiveW);

          // ‚òÖ Î™®Îìà Íµ¨ÏÑ± Î∂ÑÏÑù: 600mm Í∏∞Ï§ÄÏúºÎ°ú 2D/1D ÌåêÎ≥Ñ
          let modules2D = 0;
          let modules1D = 0;
          const MODULE_2D_THRESHOLD = 600; // 600mm Ïù¥ÏÉÅÏù¥Î©¥ 2D

          result.modules.forEach((m) => {
            if (m.w >= MODULE_2D_THRESHOLD) modules2D++;
            else modules1D++;
          });

          // 2D/1D Î™®Îìà Ïù∏Îç±Ïä§ Ï∂îÏ†Å
          let idx2D = 0;
          let idx1D = 0;

          result.modules.forEach((m, idx) => {
            const is2D = m.w >= MODULE_2D_THRESHOLD;
            const currentIdx = is2D ? idx2D++ : idx1D++;

            // ‚òÖ ÏÉàÎ°úÏö¥ Í∑úÏπô Ï†ÅÏö©
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, currentIdx, is2D);

            item.modules.push({
              id: Date.now() + idx,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: m.w,
              doorCount: is2D ? 2 : 1, // ‚òÖ 2D/1DÏóê Îî∞Î•∏ ÎèÑÏñ¥ Ïàò
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          });

          console.log(`Î∂ôÎ∞ïÏù¥Ïû• ÏûêÎèôÍ≥ÑÏÇ∞: 2D=${modules2D}Í∞ú, 1D=${modules1D}Í∞ú`);
        }

        renderWorkspaceContent(item);
      }

      function onEffectiveSpaceBlur(itemUniqueId, section, inputEl) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const value = inputEl.value.trim();
        if (section === 'upper') item.specs.effectiveUpperW = value === '' ? null : parseFloat(value);
        else item.specs.effectiveLowerW = value === '' ? null : parseFloat(value);

        renderWorkspaceContent(item);
      }

      function onDishwasherChange(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        item.specs.dishwasher = value;
        if (value === 'BuiltIn' || value === 'FreeStanding') {
          item.specs.sinkLegHeight = 120;
        }
        renderWorkspaceContent(item);
      }

      function changeLayoutShape(itemUniqueId, shape) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.layoutShape = shape;
          renderWorkspaceContent(item);
        }
      }

      function updateTopSize(itemUniqueId, index, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) item.specs.topSizes[index] = value;
      }

      function updateSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = value;
          renderWorkspaceContent(item);
        }
      }

      function updateSpecNoRender(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) item.specs[field] = value;
      }

      // ÎßàÍ∞êÏû¨ ÌÉÄÏûÖ Î≥ÄÍ≤Ω Ïãú Í∏∞Î≥∏ ÎÑàÎπÑÎèÑ ÏûêÎèô ÏÑ§Ï†ï
      function updateFinishType(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // ÌÉÄÏûÖÏóê Îî∞Î•∏ Í∏∞Î≥∏ ÎÑàÎπÑ: Ìú†Îùº 60, Î™∞Îî© 60, EP 20, ÏóÜÏùå 0
        const defaultWidths = { Filler: 60, Molding: 60, EP: 20, None: 0 };
        const defaultWidth = defaultWidths[value] || 0;

        item.specs[`finish${side}Type`] = value;
        item.specs[`finish${side}Width`] = defaultWidth;

        // Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû• ÌõÑ Î†åÎçîÎßÅ
        const specPanel = document.querySelector('.spec-panel');
        const scrollTop = specPanel ? specPanel.scrollTop : 0;
        renderWorkspaceContent(item);
        const newSpecPanel = document.querySelector('.spec-panel');
        if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
      }

      function updateSpecValue(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          // Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû• ÌõÑ Î†åÎçîÎßÅ
          const specPanel = document.querySelector('.spec-panel');
          const scrollTop = specPanel ? specPanel.scrollTop : 0;
          renderWorkspaceContent(item);
          // Ïä§ÌÅ¨Î°§ ÏúÑÏπò Î≥µÏõê
          const newSpecPanel = document.querySelector('.spec-panel');
          if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
        }
      }

      function updateModuleDim(itemUniqueId, moduleId, dim, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const mod = item.modules.find((m) => m.id === moduleId);
        if (!mod) return;

        mod[dim] = parseFloat(value) || 0;
        mod.isFixed = true;

        updateRemainingDisplay(item);
      }

      function updateRemainingDisplay(item) {
        const upperModules = item.modules.filter((m) => m.pos === 'upper');
        const lowerModules = item.modules.filter((m) => m.pos === 'lower');

        const upperEffectiveW = getEffectiveSpace(item, 'upper');
        const lowerEffectiveW = getEffectiveSpace(item, 'lower');

        const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);

        const upperRemaining = upperEffectiveW - upperUsedW;
        const lowerRemaining = lowerEffectiveW - lowerUsedW;

        const upperSpan = document.querySelector('.module-section-header.upper .section-remaining');
        const lowerSpan = document.querySelector('.module-section-header.lower .section-remaining');

        if (upperSpan) {
          upperSpan.textContent = `ÏûîÏó¨: ${Math.round(upperRemaining)}mm`;
          upperSpan.style.color = getRemainColor(upperRemaining);
        }
        if (lowerSpan) {
          lowerSpan.textContent = `ÏûîÏó¨: ${Math.round(lowerRemaining)}mm`;
          lowerSpan.style.color = getRemainColor(lowerRemaining);
        }

        item.modules.forEach((mod) => {
          if (mod.isFixed) {
            const card = document.querySelector(`[data-module-id="${mod.id}"]`);
            if (card && !card.classList.contains('fixed-module')) {
              card.classList.add('fixed-module');
            }
          }
        });
      }

      function updateModuleDetail(itemUniqueId, moduleId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const mod = item.modules.find((m) => m.id === moduleId);
          if (mod) mod[field] = parseFloat(value) || 0;
        }
      }

      function toggleOption(itemUniqueId, moduleId, field, isChecked) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const mod = item.modules.find((m) => m.id === moduleId);
          if (mod) {
            mod[field] = isChecked;
            // ELÏû• ÌôúÏÑ±Ìôî Ïãú ÌïòÎ∂ÄÏû• ÎÑàÎπÑ 600ÏúºÎ°ú ÏûêÎèô Î≥ÄÍ≤Ω + Í≥†Ï†ïÏû• Î≥ÄÌôò
            if (field === 'isEL' && isChecked && mod.pos === 'lower') {
              mod.w = 600;
              mod.isFixed = true; // ELÏû•ÏùÄ Í≥†Ï†ïÏû•ÏúºÎ°ú Î≥ÄÌôò
            }
          }
          renderWorkspaceContent(item);
        }
      }

      function moveModule(itemUniqueId, moduleId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const module = item.modules.find((m) => m.id === moduleId);
        if (!module) return;

        const sectionModules = item.modules.filter((m) => m.pos === module.pos);
        const currentIndex = sectionModules.findIndex((m) => m.id === moduleId);

        if (
          (direction === 'up' && currentIndex === 0) ||
          (direction === 'down' && currentIndex === sectionModules.length - 1)
        )
          return;

        const globalCurrentIndex = item.modules.findIndex((m) => m.id === moduleId);
        const targetModuleId =
          direction === 'up' ? sectionModules[currentIndex - 1].id : sectionModules[currentIndex + 1].id;
        const globalTargetIndex = item.modules.findIndex((m) => m.id === targetModuleId);

        [item.modules[globalCurrentIndex], item.modules[globalTargetIndex]] = [
          item.modules[globalTargetIndex],
          item.modules[globalCurrentIndex],
        ];
        renderWorkspaceContent(item);
      }

      function removeModule(itemUniqueId, moduleId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.modules = item.modules.filter((m) => m.id !== moduleId);
          renderWorkspaceContent(item);
        }
      }

      // Ïã±ÌÅ¨ÎåÄ Î™®Îìà Í≥†Ï†ï ÌÜ†Í∏Ä
      function toggleSinkModuleFixed(itemUniqueId, moduleId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === moduleId);
        if (mod) {
          mod.isFixed = !mod.isFixed;
          renderWorkspaceContent(item);
        }
      }

      // Ïã±ÌÅ¨ÎåÄ ÎèÑÏñ¥ ÌëúÏãú ÌÜ†Í∏Ä
      function toggleSinkDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      function addStorageModule(itemUniqueId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const specUpperH = parseFloat(item.specs.upperH) || 720;
        const specLowerH = parseFloat(item.specs.lowerH) || 870;
        const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;

        const defaultH = type === 'upper' ? specUpperH - 20 : specLowerH - specLegH;
        const defaultD = type === 'upper' ? 295 : 550;
        const name = type === 'upper' ? 'ÏÉÅÎ∂ÄÏû•' : 'ÌïòÎ∂ÄÏû•';

        item.modules.push({
          id: Date.now(),
          type: 'storage',
          name,
          pos: type,
          w: 600,
          h: defaultH,
          d: defaultD,
          isDrawer: false,
          isEL: false,
          isFixed: false,
        });
        renderWorkspaceContent(item);
      }

      function addTallModule(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const specMoldingH = parseFloat(item.specs.moldingH) || 60;
        const spaceH = parseFloat(item.h) || 2300;
        const defaultH = spaceH - specMoldingH - 60;

        item.modules.push({
          id: Date.now(),
          type: 'tall',
          name: 'ÌÇ§ÌÅ∞Ïû•(TL)',
          pos: 'lower',
          w: 600,
          h: defaultH,
          d: 550,
          isDrawer: false,
          isEL: false,
          isFixed: false,
          doorCount: 1,
          elCount: 0,
        });
        renderWorkspaceContent(item);
      }

      function addAccessory(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.accessories.push({ id: Date.now(), type: 'LTMesh' });
          renderWorkspaceContent(item);
        }
      }

      function updateAccessory(itemUniqueId, accId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const acc = item.specs.accessories.find((a) => a.id === accId);
          if (acc) acc.type = type;
        }
      }

      function removeAccessory(itemUniqueId, accId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.accessories = item.specs.accessories.filter((a) => a.id !== accId);
          renderWorkspaceContent(item);
        }
      }

      // ============================================================
      // ‚òÖ ÎÉâÏû•Í≥†Ïû• Ï†ÑÏö© ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Î†åÎçîÎßÅ (v30 Í∑úÏπô Í∏∞Î∞ò)
      // ============================================================
      function renderFridgeWorkspace(item) {
        const ws = document.getElementById('designWorkspace');
        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 700;

        if (!item.modules) item.modules = [];

        // Í∑úÏπô ÏÉÅÏàò
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
        const TOP_GAP = FRIDGE_RULES.TOP_GAP;

        // ÎßàÍ∞ê Í≥ÑÏÇ∞
        const fL =
          item.specs.finishLeftType !== 'None'
            ? item.specs.finishLeftType === 'EP'
              ? 20
              : parseFloat(item.specs.finishLeftWidth) || 60
            : 0;
        const fR =
          item.specs.finishRightType !== 'None'
            ? item.specs.finishRightType === 'EP'
              ? 20
              : parseFloat(item.specs.finishRightWidth) || 60
            : 0;
        const effectiveW = W - fL - fR;

        // Î™®ÎìàÎì§ÏùÑ order ÏàúÏúºÎ°ú Ï†ïÎ†¨
        const allModules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        const fridgeMod = allModules.find((m) => m.type === 'fridge');

        // ‚òÖ ÎÉâÏû•Í≥† Í∏∞Ï§Ä ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥ ÏûêÎèô Í≥ÑÏÇ∞ (ÎÉâÏû•Í≥†Îäî Î∞îÎã•ÏóêÏÑú ÏãúÏûë, Ï¢åÎåÄ Î¨¥Í¥Ä)
        const fridgeH = fridgeMod ? fridgeMod.h : 0;
        const calcUpperH = fridgeMod
          ? Math.max(0, Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeH - TOP_GAP - MOLDING_H))
          : 0;

        // ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥ (Í≥ÑÏÇ∞Í∞í ÏÇ¨Ïö©, ÏàòÎèô ÏûÖÎ†•ÏùÄ recalcFridgeHeightsÏóêÏÑú Ï≤òÎ¶¨)
        const upperDoorH = item.specs.fridgeUpperH !== undefined ? parseFloat(item.specs.fridgeUpperH) : calcUpperH;

        // Ï§ëÍ∞ÑÏû•/ÌïòÎ∂ÄÏû• ÎÜíÏù¥ Í≥ÑÏÇ∞ (Î™®Îìà ÏòÅÏó≠ = H - ÏÉÅÎ™∞Îî© - ÏÉÅÎ∂ÄÏû• - Ï¢åÎåÄ)
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH =
          item.specs.fridgeMiddleH !== undefined
            ? parseFloat(item.specs.fridgeMiddleH)
            : Math.floor(moduleBodyH * 0.55);
        const lowerH =
          item.specs.fridgeLowerH !== undefined
            ? parseFloat(item.specs.fridgeLowerH)
            : Math.floor(moduleBodyH - middleH);

        // ÏÇ¨Ïö© ÎÑàÎπÑ Í≥ÑÏÇ∞
        let totalUsedW = 0;
        allModules.forEach((m) => {
          if (m.type === 'fridge') {
            const sideGap = m.sideGap || 50;
            const betweenGap = m.betweenGap || 0;
            const units = m.units || [{ w: m.w }];
            totalUsedW += sideGap * 2;
            units.forEach((u, idx) => {
              totalUsedW += u.w;
              if (idx < units.length - 1) totalUsedW += betweenGap;
            });
          } else {
            totalUsedW += parseFloat(m.w) || 0;
          }
        });
        const remaining = effectiveW - totalUsedW;
        const isOverflow = remaining < 0;

        // SVG ÏÑ§Ï†ï
        const svgWidth = 720;
        const svgHeight = 560;
        const scale = Math.min((svgWidth - 100) / W, (svgHeight - 160) / H);
        const drawW = W * scale;
        const drawH = H * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        let moduleSvg = '';
        const showDoors = item.specs.showDoors || false; // ÎèÑÏñ¥ ÌëúÏãú Ïó¨Î∂Ä

        // ÏÉÅÎ™∞Îî©
        moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${MOLDING_H * scale}" fill="#d4a574" stroke="#a67c52" stroke-width="1"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + (MOLDING_H * scale) / 2 + 4}" text-anchor="middle" font-size="9" fill="#fff">ÏÉÅÎ™∞Îî© ${MOLDING_H}</text>`;

        // Ï¢åÏ∏° ÎßàÍ∞ê
        if (fL > 0) {
          moduleSvg += `<rect x="${offsetX}" y="${offsetY + MOLDING_H * scale}" width="${fL * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (fL * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fL}</text>`;
        }
        // Ïö∞Ï∏° ÎßàÍ∞ê
        if (fR > 0) {
          moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY + MOLDING_H * scale}" width="${fR * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (fR * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fR}</text>`;
        }

        // ÏÉÅÎ∂ÄÏû• Í≤∞Ìï©
        const contentStartY = offsetY + MOLDING_H * scale;
        const upperH_scaled = upperDoorH * scale;
        let upperX = offsetX + fL * scale;

        // ÏÉÅÎ∂ÄÏû• Ï†ïÎ≥¥ ÏàòÏßë
        let upperCabinets = [];
        allModules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ name: mod.name, w: mod.w }];
            units.forEach((unit, unitIdx) => {
              let upperW = unit.w;
              if (unitIdx === 0) upperW += sideGap;
              if (unitIdx < units.length - 1) upperW += betweenGap / 2;
              if (unitIdx === units.length - 1) upperW += sideGap;
              if (unitIdx > 0) upperW += betweenGap / 2;
              upperCabinets.push({ type: 'fridge', name: unit.name, w: upperW });
            });
          } else {
            upperCabinets.push({ type: mod.type, name: mod.type === 'tall' ? 'ÌÇ§ÌÅ∞Ïû•' : 'ÌôàÏπ¥Ìéò', w: mod.w });
          }
        });

        // ÏÉÅÎ∂ÄÏû• Ïó∞ÏÜç Í∑∏Î¶¨Í∏∞
        const doorColor = getDoorColor(item.specs.doorColorUpper || 'ÌôîÏù¥Ìä∏');
        const doorGap = 3 * scale; // 3mm Í∞ÑÍ≤©
        upperCabinets.forEach((cab) => {
          const cabW = cab.w * scale;
          moduleSvg += `<rect x="${upperX}" y="${contentStartY}" width="${cabW}" height="${upperH_scaled}" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" rx="2"/>
      <text x="${upperX + cabW / 2}" y="${contentStartY + upperH_scaled / 2 - 2}" text-anchor="middle" font-size="8" fill="#1d4ed8">ÏÉÅÎ∂ÄÏû•</text>
      <text x="${upperX + cabW / 2}" y="${contentStartY + upperH_scaled / 2 + 10}" text-anchor="middle" font-size="7" fill="#666">${Math.round(cab.w)}mm</text>`;
          upperX += cabW;
        });

        // ‚òÖ ÏÉÅÎ∂ÄÏû• ÎèÑÏñ¥ ÌëúÏãú
        if (showDoors) {
          let upperDoorX = offsetX + fL * scale;
          upperCabinets.forEach((cab) => {
            const cabW = cab.w * scale;
            const doorCount = 1; // Î™®ÎìàÎãπ 1Í∞ú ÎèÑÏñ¥
            const doorWidth = cabW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const doorX = upperDoorX + d * doorWidth + doorGap / 2;
              const doorW = doorWidth - doorGap;
              moduleSvg += `<rect x="${doorX}" y="${contentStartY + doorGap / 2}" width="${doorW}" height="${upperH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
            upperDoorX += cabW;
          });
        }

        // Î≥∏Ï≤¥ ÏòÅÏó≠ Í∑∏Î¶¨Í∏∞
        let currentX = offsetX + fL * scale;
        const bodyStartY = contentStartY + upperH_scaled;
        const middleH_scaled = middleH * scale;
        const lowerH_scaled = lowerH * scale;
        const pedestalH_scaled = PEDESTAL_H * scale;

        allModules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ name: mod.name, w: mod.w }];
            const fridgeDrawH = mod.h * scale;
            // ‚òÖ ÎÉâÏû•Í≥†Îäî Î∞îÎã•ÏóêÏÑú ÏãúÏûë (Ï¢åÎåÄ ÏòÅÏó≠ÍπåÏßÄ Ï∞®ÏßÄ)
            const fridgeContentH = drawH - MOLDING_H * scale - upperH_scaled;
            const gapW = sideGap * scale;

            // Ï¢åÏ∏° Ï∏°Î©¥Í≥µÍ∞Ñ
            moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW / 2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
            currentX += gapW;

            // Í∞Å ÎÉâÏû•Í≥† Ïú†Îãõ (Î∞îÎã•ÍπåÏßÄ)
            units.forEach((unit, unitIdx) => {
              const unitW = unit.w * scale;
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${unitW}" height="${fridgeDrawH}" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="2" rx="3"/>
          <text x="${currentX + unitW / 2}" y="${bodyStartY + fridgeDrawH / 2 - 6}" text-anchor="middle" font-size="10" fill="#0369a1" font-weight="bold">üßä ${unit.name}</text>
          <text x="${currentX + unitW / 2}" y="${bodyStartY + fridgeDrawH / 2 + 10}" text-anchor="middle" font-size="8" fill="#666">${unit.w}√ó${mod.h}</text>`;
              moduleSvg += `<text x="${currentX + unitW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#0ea5e9">${unit.w}</text>`;
              currentX += unitW;

              if (unitIdx < units.length - 1 && betweenGap > 0) {
                const bGapW = betweenGap * scale;
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${bGapW}" height="${fridgeContentH}" fill="#fed7aa" stroke="#ea580c" stroke-width="1" stroke-dasharray="2"/>
            <text x="${currentX + bGapW / 2}" y="${bodyStartY + fridgeContentH / 2}" text-anchor="middle" font-size="7" fill="#c2410c" transform="rotate(-90, ${currentX + bGapW / 2}, ${bodyStartY + fridgeContentH / 2})">${betweenGap}</text>`;
                currentX += bGapW;
              }
            });

            // Ïö∞Ï∏° Ï∏°Î©¥Í≥µÍ∞Ñ
            moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW / 2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
            currentX += gapW;
          } else {
            // ÌÇ§ÌÅ∞Ïû•/ÌôàÏπ¥ÌéòÏû•
            const modW = mod.w * scale;
            const isEL = mod.isEL;

            if (mod.type === 'tall') {
              // ÌÇ§ÌÅ∞Ïû•: Ï§ëÍ∞ÑÏû• + ÌïòÎ∂ÄÏû• + Ï¢åÎåÄ
              // EL Î™®ÎìàÎì§Ïù¥ ÏûàÏúºÎ©¥ Í∞úÎ≥Ñ Î†åÎçîÎßÅ, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Ï§ëÍ∞ÑÏû• ÌëúÏãú
              if (mod.elModules && mod.elModules.length > 0) {
                let elY = bodyStartY;
                let usedH = 0;
                mod.elModules.forEach((elMod, elIdx) => {
                  const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                  const isOpen = elMod.type === 'open';
                  const isEL = elMod.isEL === true; // Í∏∞Î≥∏Í∞í false (Í∏∞Î≥∏Î™®Îìà)
                  let fillColor, strokeColor, label, labelColor;
                  if (isOpen) {
                    fillColor = '#fef3c7';
                    strokeColor = '#f59e0b';
                    label = 'üìÇ';
                    labelColor = '#b45309';
                  } else if (isEL) {
                    fillColor = '#dcfce7';
                    strokeColor = '#10b981';
                    label = '‚ö°';
                    labelColor = '#065f46';
                  } else {
                    fillColor = '#f3f4f6';
                    strokeColor = '#9ca3af';
                    label = 'üì¶';
                    labelColor = '#4b5563';
                  }
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${elModH_scaled}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
              <text x="${currentX + modW / 2}" y="${elY + elModH_scaled / 2}" text-anchor="middle" font-size="9" fill="${labelColor}" font-weight="bold">${label} ${elMod.h}</text>`;
                  elY += elModH_scaled;
                  usedH += elMod.h;
                });
                // ÎÇ®ÏùÄ Ï§ëÍ∞ÑÏû• Í≥µÍ∞Ñ
                const remainingH = middleH - usedH;
                if (remainingH > 0) {
                  const remainingH_scaled = (remainingH / middleH) * middleH_scaled;
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${remainingH_scaled}" fill="#f0fdf4" stroke="#86efac" stroke-width="1" stroke-dasharray="3"/>
              <text x="${currentX + modW / 2}" y="${elY + remainingH_scaled / 2}" text-anchor="middle" font-size="7" fill="#16a34a">ÏûîÏó¨ ${remainingH}</text>`;
                }
              } else {
                // EL Î™®Îìà ÏóÜÏùÑ Îïå Í∏∞Î≥∏ Ï§ëÍ∞ÑÏû• ÌëúÏãú
                const midColor = mod.isEL ? '#dcfce7' : '#dcfce7';
                const midLabel = mod.isEL ? '‚ö° ELÏû•' : 'üóÑÔ∏è Ï§ëÍ∞ÑÏû•';
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${middleH_scaled}" fill="${midColor}" stroke="#10b981" stroke-width="2" rx="2"/>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 - 8}" text-anchor="middle" font-size="10" fill="#065f46" font-weight="bold">${midLabel}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 + 6}" text-anchor="middle" font-size="8" fill="#666">${mod.w}√ó${middleH}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled - 8}" text-anchor="middle" font-size="7" fill="#888">${EL_DOOR_TYPES.find((t) => t.id === mod.doorType)?.name || 'Ïó¨Îã´Ïù¥'}</text>`;
              }

              // ÌïòÎ∂ÄÏû•
              const lowerColor =
                mod.lowerType === 'robot'
                  ? '#fef3c7'
                  : mod.lowerType === 'rice'
                    ? '#fee2e2'
                    : mod.lowerType === 'foodwaste'
                      ? '#dcfce7'
                      : '#f3f4f6';
              const lowerStroke =
                mod.lowerType === 'robot'
                  ? '#f59e0b'
                  : mod.lowerType === 'rice'
                    ? '#ef4444'
                    : mod.lowerType === 'foodwaste'
                      ? '#22c55e'
                      : '#6b7280';
              const lowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'üóÑÔ∏è';
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled}" width="${modW}" height="${lowerH_scaled}" fill="${lowerColor}" stroke="${lowerStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled + lowerH_scaled / 2}" text-anchor="middle" font-size="9" fill="${lowerStroke}">${lowerIcon} ÌïòÎ∂ÄÏû•</text>`;

              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled + lowerH_scaled}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
              moduleSvg += `<text x="${currentX + modW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#10b981">${mod.w}${mod.isFixed ? 'üîí' : ''}</text>`;

              // ‚òÖ ÌÇ§ÌÅ∞Ïû• ÎèÑÏñ¥ ÌëúÏãú (ÎèÑÏñ¥Íµ¨Î∂ÑÏóê Îî∞Îùº Îã§Î•¥Í≤å ÌëúÏãú)
              if (showDoors) {
                const doorDivision = mod.doorDivision || 'individual';
                const doorCount = Math.max(1, Math.round(mod.w / 450)); // Í∞ÄÎ°úÎÑàÎπÑ Í∏∞Ï§Ä ÎèÑÏñ¥Î∂ÑÎ∞∞
                const dW = modW / doorCount;

                if (doorDivision === 'all') {
                  // Ï†ÑÏ≤¥: Ï§ëÍ∞ÑÏû•+ÌïòÎ∂ÄÏû• ÌÜµÌï© ÎèÑÏñ¥
                  const totalDoorH = middleH_scaled + lowerH_scaled;
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${totalDoorH - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                } else if (doorDivision === 'midLower') {
                  // Ï§ëÍ∞ÑÏû•„ÜçÌïòÎ∂ÄÏû•: Ï§ëÍ∞ÑÏû• ÎèÑÏñ¥ + ÌïòÎ∂ÄÏû• ÎèÑÏñ¥ Î∂ÑÎ¶¨
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${middleH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                } else {
                  // Í∞úÎ≥Ñ: EL Î™®ÎìàÎ≥Ñ ÎèÑÏñ¥ (Ïò§ÌîàÏû• Ï†úÏô∏) + ÌïòÎ∂ÄÏû• ÎèÑÏñ¥
                  if (mod.elModules && mod.elModules.length > 0) {
                    let elDoorY = bodyStartY;
                    mod.elModules.forEach((elMod) => {
                      const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                      const isOpen = elMod.type === 'open';
                      if (!isOpen) {
                        for (let d = 0; d < doorCount; d++) {
                          const dX = currentX + d * dW + doorGap / 2;
                          moduleSvg += `<rect x="${dX}" y="${elDoorY + doorGap / 2}" width="${dW - doorGap}" height="${elModH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                        }
                      }
                      elDoorY += elModH_scaled;
                    });
                  } else {
                    for (let d = 0; d < doorCount; d++) {
                      const dX = currentX + d * dW + doorGap / 2;
                      moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${middleH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                    }
                  }
                  // ÌïòÎ∂ÄÏû• ÎèÑÏñ¥
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                }
              }
            } else if (mod.type === 'homecafe') {
              // ÌôàÏπ¥ÌéòÏû•: Ï§ëÍ∞ÑÏû• + ÌïòÎ∂ÄÏû• + Ï¢åÎåÄ (ÌÇ§ÌÅ∞Ïû•Í≥º ÎèôÏùº Íµ¨Ï°∞)
              // EL Î™®ÎìàÎì§Ïù¥ ÏûàÏúºÎ©¥ Í∞úÎ≥Ñ Î†åÎçîÎßÅ, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÌëúÏãú
              if (mod.elModules && mod.elModules.length > 0) {
                let elY = bodyStartY;
                let usedH = 0;
                mod.elModules.forEach((elMod, elIdx) => {
                  const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                  const isOpen = elMod.type === 'open';
                  const isEL = elMod.isEL === true; // Í∏∞Î≥∏Í∞í false (Í∏∞Î≥∏Î™®Îìà)
                  let fillColor, strokeColor, label, labelColor;
                  if (isOpen) {
                    fillColor = '#fef3c7';
                    strokeColor = '#f59e0b';
                    label = 'üìÇ';
                    labelColor = '#b45309';
                  } else if (isEL) {
                    fillColor = '#f3e8ff';
                    strokeColor = '#8b5cf6';
                    label = '‚ö°';
                    labelColor = '#6b21a8';
                  } else {
                    fillColor = '#f3f4f6';
                    strokeColor = '#9ca3af';
                    label = 'üì¶';
                    labelColor = '#4b5563';
                  }
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${elModH_scaled}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
              <text x="${currentX + modW / 2}" y="${elY + elModH_scaled / 2}" text-anchor="middle" font-size="9" fill="${labelColor}" font-weight="bold">${label} ${elMod.h}</text>`;
                  elY += elModH_scaled;
                  usedH += elMod.h;
                });
                const remainingH = middleH - usedH;
                if (remainingH > 0) {
                  const remainingH_scaled = (remainingH / middleH) * middleH_scaled;
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${remainingH_scaled}" fill="#faf5ff" stroke="#c4b5fd" stroke-width="1" stroke-dasharray="3"/>
              <text x="${currentX + modW / 2}" y="${elY + remainingH_scaled / 2}" text-anchor="middle" font-size="7" fill="#7c3aed">ÏûîÏó¨ ${remainingH}</text>`;
                }
              } else {
                const midColor = '#f3e8ff';
                const midStroke = '#8b5cf6';
                const midLabel = '‚òï ÌôàÏπ¥Ìéò';
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${middleH_scaled}" fill="${midColor}" stroke="${midStroke}" stroke-width="2" rx="2"/>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 - 4}" text-anchor="middle" font-size="10" fill="#6b21a8" font-weight="bold">${midLabel}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 + 10}" text-anchor="middle" font-size="8" fill="#666">${mod.w}√ó${middleH}</text>`;
              }

              // ÌôàÏπ¥Ìéò ÌïòÎ∂ÄÏû•
              const cafeLowerColor =
                mod.lowerType === 'robot'
                  ? '#fef3c7'
                  : mod.lowerType === 'rice'
                    ? '#fee2e2'
                    : mod.lowerType === 'foodwaste'
                      ? '#dcfce7'
                      : '#ede9fe';
              const cafeLowerStroke =
                mod.lowerType === 'robot'
                  ? '#f59e0b'
                  : mod.lowerType === 'rice'
                    ? '#ef4444'
                    : mod.lowerType === 'foodwaste'
                      ? '#22c55e'
                      : '#a78bfa';
              const cafeLowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'üóÑÔ∏è';
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled}" width="${modW}" height="${lowerH_scaled}" fill="${cafeLowerColor}" stroke="${cafeLowerStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled + lowerH_scaled / 2}" text-anchor="middle" font-size="9" fill="${cafeLowerStroke}">${cafeLowerIcon} ÌïòÎ∂ÄÏû•</text>`;

              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled + lowerH_scaled}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
              moduleSvg += `<text x="${currentX + modW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#8b5cf6">${mod.w}${mod.isFixed ? 'üîí' : ''}</text>`;

              // ‚òÖ ÌôàÏπ¥ÌéòÏû• ÌïòÎ∂ÄÏû• ÎèÑÏñ¥Îßå ÌëúÏãú (Ï§ëÍ∞ÑÏû•ÏùÄ ÎèÑÏñ¥ ÏóÜÏùå)
              if (showDoors) {
                const doorCount = Math.max(1, Math.round(mod.w / 450)); // Í∞ÄÎ°úÎÑàÎπÑ Í∏∞Ï§Ä ÎèÑÏñ¥Î∂ÑÎ∞∞
                const dW = modW / doorCount;
                for (let d = 0; d < doorCount; d++) {
                  const dX = currentX + d * dW + doorGap / 2;
                  moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                }
              }
            }
            currentX += modW;
          }
        });

        // Ï¥ù ÎÑàÎπÑ
        moduleSvg += `<line x1="${offsetX}" y1="${offsetY + drawH + 35}" x2="${offsetX + drawW}" y2="${offsetY + drawH + 35}" stroke="#333" stroke-width="1" marker-start="url(#arrowL)" marker-end="url(#arrowR)"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + drawH + 50}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>`;

        // ÎÉâÏû•Í≥† Î™®Îç∏ Î™©Î°ù
        const brand = item.specs.fridgeBrand || 'LG';
        const brandData = FRIDGE_DATA[brand];

        let fridgeButtonsHtml = '';
        Object.keys(brandData.categories).forEach((catName) => {
          fridgeButtonsHtml += `<div class="fridge-cat-group"><div class="fridge-cat-title">${catName}</div><div class="fridge-btn-row">`;
          brandData.categories[catName].forEach((model) => {
            const isSelected = fridgeMod && fridgeMod.modelId === model.id;
            fridgeButtonsHtml += `<button class="fridge-model-btn ${isSelected ? 'selected' : ''}" onclick="selectFridgeModel(${item.uniqueId}, '${model.id}')">${model.name}<br><span style="font-size:9px;color:#999;">${model.w}√ó${model.h}</span></button>`;
          });
          fridgeButtonsHtml += `</div></div>`;
        });

        // Î™®Îìà Ïπ¥Îìú HTML
        const moduleCardsHtml = allModules
          .map((mod, idx) => {
            const isFirst = idx === 0;
            const isLast = idx === allModules.length - 1;

            if (mod.type === 'fridge') {
              const sideGap = mod.sideGap || 50;
              const betweenGap = mod.betweenGap || 0;
              const units = mod.units || [{ w: mod.w }];
              let upperInfo = units
                .map((u, i) => {
                  let uw = u.w;
                  if (i === 0) uw += sideGap;
                  if (i < units.length - 1) uw += betweenGap / 2;
                  if (i === units.length - 1) uw += sideGap;
                  if (i > 0) uw += betweenGap / 2;
                  return Math.round(uw);
                })
                .join('+');

              return `<div class="module-card" style="border-left:3px solid #0ea5e9;">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>‚ñ≤</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>‚ñº</button>
        </div>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:12px;">üßä ${mod.name}</div>
          <div style="font-size:10px;color:#666;">${mod.w} √ó ${mod.h}mm | Ïú†Îãõ: ${units.length}Í∞ú</div>
          <div style="font-size:9px;color:#888;">Ï∏°Î©¥: ${sideGap}mm | ÏÇ¨Ïù¥: ${betweenGap}mm</div>
          <div style="font-size:9px;color:#3b82f6;">ÏÉÅÎ∂ÄÏû•: ${upperInfo}mm</div>
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">√ó</button>
      </div>`;
            } else {
              const typeInfo =
                mod.type === 'tall'
                  ? { name: 'ÌÇ§ÌÅ∞Ïû•', icon: 'üóÑÔ∏è', color: '#10b981' }
                  : { name: 'ÌôàÏπ¥ÌéòÏû•', icon: '‚òï', color: '#8b5cf6' };
              const fixedClass = mod.isFixed ? 'active' : '';

              return `<div class="module-card" style="border-left:3px solid ${typeInfo.color};">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>‚ñ≤</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>‚ñº</button>
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <span style="font-weight:700;font-size:12px;">${typeInfo.icon} ${typeInfo.name}</span>
            <button class="toggle-btn ${fixedClass}" onclick="toggleFridgeModuleFixed(${item.uniqueId}, ${mod.id})">Í≥†Ï†ï</button>
            <button class="el-config-btn" onclick="openELPopup(${item.uniqueId}, ${mod.id})">‚öôÔ∏è ÏÑ§Ï†ï</button>
          </div>
          <div class="module-inline-inputs">
            <label>W</label><input type="number" value="${mod.w}" style="width:55px;" onchange="updateFridgeModuleW(${item.uniqueId}, ${mod.id}, this.value)">
            <label>ÎèÑÏñ¥ Íµ¨Î∂Ñ</label><select onchange="updateFridgeDoorDivision(${item.uniqueId}, ${mod.id}, this.value)">${DOOR_DIVISION_TYPES.map((t) => `<option value="${t.id}" ${mod.doorDivision === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select>
            <label>ÌïòÎ∂Ä</label><select onchange="updateFridgeSideModule(${item.uniqueId}, ${mod.id}, 'lowerType', this.value)">${LOWER_MODULE_TYPES.map((t) => `<option value="${t.id}" ${mod.lowerType === t.id ? 'selected' : ''}>${t.icon}</option>`).join('')}</select>
          </div>
          ${mod.elModules && mod.elModules.length > 0 ? `<div style="font-size:9px;color:#10b981;margin-top:4px;">‚ö° Î™®Îìà: ${mod.elModules.length}Í∞ú</div>` : ''}
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">√ó</button>
      </div>`;
            }
          })
          .join('');

        const leftDisabled =
          item.specs.finishLeftType === 'EP' || item.specs.finishLeftType === 'None' ? 'disabled' : '';
        const rightDisabled =
          item.specs.finishRightType === 'EP' || item.specs.finishRightType === 'None' ? 'disabled' : '';
        const leftWidthVal =
          item.specs.finishLeftType === 'EP'
            ? 20
            : item.specs.finishLeftType === 'None'
              ? 0
              : item.specs.finishLeftWidth || 60;
        const rightWidthVal =
          item.specs.finishRightType === 'EP'
            ? 20
            : item.specs.finishRightType === 'None'
              ? 0
              : item.specs.finishRightWidth || 60;

        ws.innerHTML = `
    <style>
      .fridge-brand-tabs{display:flex;gap:8px;margin-bottom:12px}.fridge-brand-tab{padding:8px 20px;border:2px solid #ddd;border-radius:8px;background:#f9f9f9;cursor:pointer;font-weight:600;font-size:13px}.fridge-brand-tab.active{border-color:#0ea5e9;background:#e0f2fe;color:#0369a1}.fridge-cat-group{margin-bottom:10px}.fridge-cat-title{font-size:11px;font-weight:700;color:#666;margin-bottom:5px}.fridge-btn-row{display:flex;flex-wrap:wrap;gap:5px}.fridge-model-btn{padding:5px 8px;border:1px solid #ddd;border-radius:5px;background:white;font-size:10px;cursor:pointer;min-width:80px}.fridge-model-btn:hover{border-color:#0ea5e9;background:#f0f9ff}.fridge-model-btn.selected{border-color:#0ea5e9;background:#0ea5e9;color:white}.fridge-model-btn.selected span{color:#e0f2fe!important}.module-add-btns{display:flex;gap:8px;margin-bottom:12px}.module-add-btn{flex:1;padding:10px;border:2px dashed #ccc;border-radius:8px;background:white;font-size:12px;cursor:pointer;font-weight:600}.module-add-btn:hover{border-style:solid}.module-add-btn.tall{color:#10b981;border-color:#10b981}.module-add-btn.tall:hover{background:#dcfce7}.module-add-btn.homecafe{color:#8b5cf6;border-color:#8b5cf6}.module-add-btn.homecafe:hover{background:#f3e8ff}.auto-calc-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;margin-bottom:15px}.auto-calc-btn:hover{opacity:0.9}.auto-calc-btn:disabled{background:#ccc;cursor:not-allowed}.overflow-warning{background:#fee2e2;color:#b91c1c;padding:8px 12px;border-radius:6px;font-size:11px;margin-bottom:10px}.module-inline-inputs{display:flex;align-items:center;gap:4px;font-size:10px;margin-top:4px}.module-inline-inputs input,.module-inline-inputs select{padding:2px 4px;font-size:10px;border:1px solid #ddd;border-radius:4px}.module-order-btns{display:flex;flex-direction:column;gap:2px;margin-right:8px}.order-btn{width:24px;height:20px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;cursor:pointer;font-size:10px;padding:0}.order-btn:hover:not(:disabled){background:#e0e0e0}.order-btn:disabled{opacity:0.3;cursor:not-allowed}.module-card{display:flex;align-items:center;padding:10px;background:#f9fafb;border-radius:8px;margin-bottom:8px}.height-inputs{display:flex;gap:8px;margin-top:8px;padding:8px;background:#f0f9ff;border-radius:6px;font-size:10px}.height-inputs label{color:#0369a1;font-weight:600}.height-inputs input{width:50px;padding:2px 4px;border:1px solid #0ea5e9;border-radius:4px;font-size:10px}.toggle-btn{padding:2px 6px;border:1px solid #ccc;border-radius:4px;background:#f9f9f9;font-size:9px;cursor:pointer}.toggle-btn:hover{background:#e5e5e5}.toggle-btn.active{background:#ef4444;color:white;border-color:#ef4444}.toggle-btn.el{border-color:#10b981;color:#10b981}.toggle-btn.el.active{background:#10b981;color:white}.el-config-btn{padding:2px 8px;border:1px solid #10b981;border-radius:4px;background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);font-size:9px;cursor:pointer;color:#065f46;font-weight:600}.el-config-btn:hover{background:linear-gradient(135deg,#bbf7d0 0%,#86efac 100%)}.auto-calc-btn-sm{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;padding:4px 10px;border-radius:6px;font-weight:600;cursor:pointer;font-size:10px}.auto-calc-btn-sm:hover{opacity:0.9}.auto-calc-btn-sm:disabled{background:#ccc;cursor:not-allowed}
    </style>
    <div class="ws-header">
      <div class="ws-title">üßä ${item.labelName || item.name} <span class="ws-info-badge">${W} √ó ${H} √ó ${D}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ÎîîÏûêÏù∏ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±">üé® AI ÎîîÏûêÏù∏ ÏÉùÏÑ±</button>
        <button onclick="proceedToBOM()" style="background:linear-gradient(135deg,#4caf50,#388e3c);color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" title="ÏûêÏû¨/Î∂ÄÏûêÏû¨ ÏÇ∞Ï∂ú">üìã BOM ÏÇ∞Ï∂ú</button>
        <button style="background:var(--primary-color);color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" onclick="saveDesignToFile()">üíæ Ï†ÄÏû•</button>
        <button class="btn-back" onclick="goBackToStep1()">‚Üê Î™©Î°ù</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">Î∏åÎûúÎìú ÏÑ†ÌÉù</div>
        <div class="fridge-brand-tabs">
          <div class="fridge-brand-tab ${brand === 'LG' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'LG')">LG</div>
          <div class="fridge-brand-tab ${brand === 'Samsung' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'Samsung')">ÏÇºÏÑ±</div>
        </div>
        <div class="spec-group-title">ÎÉâÏû•Í≥† Î™®Îç∏ ÏÑ†ÌÉù</div>
        <div style="max-height:200px;overflow-y:auto;padding-right:6px;margin-bottom:12px;">${fridgeButtonsHtml}</div>
        <div class="spec-group-title">ÏÑ§Ï†ï</div>
        <div class="spec-row">
          <div class="spec-field"><label>ÏÉÅÎ™∞Îî©</label><input type="number" value="${MOLDING_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgeMoldingH', this.value)"></div>
          <div class="spec-field"><label>ÍπäÏù¥</label><input type="number" value="${MODULE_D}" onchange="updateFridgeSpec(${item.uniqueId}, 'fridgeModuleD', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ÌïòÎ∂Ä Îã§Î¶¨</label><select onchange="updateFridgeLegType(${item.uniqueId}, this.value)">${FRIDGE_LEG_TYPES.map((t) => `<option value="${t.id}" ${(item.specs.fridgeLegType || 'pedestal') === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>ÎÜíÏù¥</label><input type="number" value="${PEDESTAL_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgePedestal', this.value)"></div>
        </div>
        <div class="spec-group-title">ÎßàÍ∞ê ÏÑ§Ï†ï</div>
        <div class="spec-row">
          <div class="spec-field"><label>Ï¢åÏ∏°</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Left', this.value)">${FINISH_TYPES.map((t) => `<option value="${t.id}" ${item.specs.finishLeftType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥</label><input type="number" value="${leftWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)" ${leftDisabled}></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>Ïö∞Ï∏°</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Right', this.value)">${FINISH_TYPES.map((t) => `<option value="${t.id}" ${item.specs.finishRightType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>Í∏∏Ïù¥</label><input type="number" value="${rightWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishRightWidth', this.value)" ${rightDisabled}></div>
        </div>
        <div style="font-size:9px;color:#888;margin-top:4px;">‚Äª Í∏∞Î≥∏Í∞í: Î™∞Îî©=60, Ìú†Îùº=60, EP=20, ÏóÜÏùå=0</div>
      </div>
      <div class="module-panel">
        <div class="front-view-section" style="margin-bottom:12px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>üìê Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(ÎèÑÏñ¥ Í∏∞Ï§Ä)</span>
            </div>
            <button onclick="toggleFridgeDoors(${item.uniqueId})" class="toggle-btn ${item.specs.showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">üö™ ÎèÑÏñ¥</button>
          </div>
          <div style="text-align:center;">
            <svg width="${svgWidth}" height="${svgHeight + 20}" style="background:#fafafa;border-radius:8px;border:1px solid #eee;">
              <defs><marker id="arrowL" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M6,0 L0,3 L6,6" fill="none" stroke="#333"/></marker><marker id="arrowR" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6" fill="none" stroke="#333"/></marker></defs>
              ${moduleSvg}
            </svg>
          </div>
        </div>
        ${isOverflow ? `<div class="overflow-warning">‚ö†Ô∏è Ïú†Ìö®Í≥µÍ∞Ñ(${effectiveW}mm)ÏùÑ ${Math.abs(remaining)}mm Ï¥àÍ≥º!</div>` : ''}
        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg,#e0f2fe,#f0f9ff);color:#0369a1;border-left:4px solid #0ea5e9;">
            <div class="section-title-row" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
              <div><span>üì¶ Î™®Îìà Íµ¨ÏÑ±</span><span style="font-size:11px;font-weight:normal;color:#666;margin-left:8px;">Ïú†Ìö®: ${effectiveW}mm</span></div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span class="section-remaining" style="color:${isOverflow ? '#ef4444' : '#10b981'};font-size:11px;">ÏûîÏó¨: ${remaining}mm</span>
                <button class="auto-calc-btn-sm" onclick="autoCalculateFridge(${item.uniqueId})" ${allModules.length === 0 ? 'disabled' : ''}>‚ö° ÏûêÎèôÍ≥ÑÏÇ∞</button>
              </div>
            </div>
          </div>
          <div class="height-inputs">
            <label>ÏÉÅÎ∂ÄÏû•H</label><input type="number" value="${Math.round(upperDoorH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeUpperH', this.value)">
            <label>Ï§ëÍ∞ÑÏû•H</label><input type="number" value="${Math.round(middleH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeMiddleH', this.value)">
            <label>ÌïòÎ∂ÄÏû•H</label><input type="number" value="${Math.round(lowerH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeLowerH', this.value)">
          </div>
          <div class="module-add-btns" style="margin-top:10px;">
            <button class="module-add-btn tall" onclick="addFridgeSideModule(${item.uniqueId}, 'tall')">üóÑÔ∏è + ÌÇ§ÌÅ∞Ïû•</button>
            <button class="module-add-btn homecafe" onclick="addFridgeSideModule(${item.uniqueId}, 'homecafe')">‚òï + ÌôàÏπ¥ÌéòÏû•</button>
          </div>
          ${moduleCardsHtml || '<div style="padding:15px;text-align:center;color:#999;font-size:11px;">ÎÉâÏû•Í≥†Î•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Î™®ÎìàÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>'}
        </div>
      </div>
    </div>
  `;
      }

      function changeFridgeBrand(itemUniqueId, brand) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.fridgeBrand = brand;
          item.modules = item.modules.filter((m) => m.type !== 'fridge');
          renderWorkspaceContent(item);
        }
      }

      function selectFridgeModel(itemUniqueId, modelId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const brand = item.specs.fridgeBrand || 'LG';
        let model = null;
        Object.values(FRIDGE_DATA[brand].categories).forEach((cat) => {
          const found = cat.find((m) => m.id === modelId);
          if (found) model = found;
        });
        if (!model) return;

        item.modules = item.modules.filter((m) => m.type !== 'fridge');
        const existingModules = item.modules;
        const midOrder = existingModules.length > 0 ? Math.floor(existingModules.length / 2) + 1 : 1;
        existingModules.forEach((m, idx) => {
          m.order = idx < Math.floor(existingModules.length / 2) ? idx + 1 : idx + 2;
        });

        item.modules.push({
          id: Date.now(),
          modelId: model.id,
          type: 'fridge',
          name: model.name,
          w: model.w,
          h: model.h,
          d: model.d,
          line: model.line,
          sideGap: model.sideGap,
          betweenGap: model.betweenGap,
          units: model.units,
          order: midOrder,
        });

        // ÎÜíÏù¥ ÏûêÎèô Ïû¨Í≥ÑÏÇ∞
        recalcFridgeHeights(item);
        renderWorkspaceContent(item);
      }

      // ‚òÖ ÎÜíÏù¥ ÏûêÎèô Ïû¨Í≥ÑÏÇ∞ Ìï®Ïàò
      function recalcFridgeHeights(item) {
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const fridgeMod = item.modules.find((m) => m.type === 'fridge');

        if (fridgeMod) {
          // ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥ = Ï†ÑÏ≤¥ - ÎÉâÏû•Í≥†ÎÜíÏù¥ - ÏÉÅÎã®Í∞ÑÍ≤© - ÏÉÅÎ™∞Îî©
          const calcUpperH = Math.max(
            0,
            Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeMod.h - FRIDGE_RULES.TOP_GAP - MOLDING_H)
          );
          item.specs.fridgeUpperH = calcUpperH;

          // Î™®Îìà Î≥∏Ï≤¥ ÏòÅÏó≠ = Ï†ÑÏ≤¥ - ÏÉÅÎ™∞Îî© - ÏÉÅÎ∂ÄÏû• - Ï¢åÎåÄ
          const moduleBodyH = H - MOLDING_H - calcUpperH - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH * 0.55);
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - item.specs.fridgeMiddleH);
        }
      }

      function removeFridgeModule(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.modules = item.modules.filter((m) => m.id !== modId);
          item.modules.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((m, idx) => (m.order = idx + 1));
          renderWorkspaceContent(item);
        }
      }

      function addFridgeSideModule(itemUniqueId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const H = parseFloat(item.h) || 2290;
        const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
        const defaultW = type === 'tall' ? FRIDGE_RULES.EL_W : FRIDGE_RULES.HOMECAFE_W;
        const maxOrder = item.modules.length > 0 ? Math.max(...item.modules.map((m) => m.order || 0)) : 0;
        item.modules.push({
          id: Date.now(),
          type: type,
          name: type === 'tall' ? 'ÌÇ§ÌÅ∞Ïû•' : 'ÌôàÏπ¥ÌéòÏû•',
          order: maxOrder + 1,
          w: defaultW,
          h: H,
          d: MODULE_D,
          doorType: 'swing',
          lowerType: 'default',
          isFixed: false,
          isEL: false,
        });
        renderWorkspaceContent(item);
      }

      function moveFridgeModule(itemUniqueId, modId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        const idx = modules.findIndex((m) => m.id === modId);
        if (idx === -1) return;
        if (direction === -1 && idx === 0) return;
        if (direction === 1 && idx === modules.length - 1) return;
        const swapIdx = idx + direction;
        const tempOrder = modules[idx].order;
        modules[idx].order = modules[swapIdx].order;
        modules[swapIdx].order = tempOrder;
        renderWorkspaceContent(item);
      }

      function toggleFridgeDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      function updateFridgeModuleW(itemUniqueId, modId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.w = parseFloat(value) || 0;
          mod.isFixed = true;
          renderWorkspaceContent(item);
        }
      }

      function toggleFridgeModuleFixed(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.isFixed = !mod.isFixed;
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeSideModule(itemUniqueId, modId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = value;
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeDoorDivision(itemUniqueId, modId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.doorDivision = value;
          renderWorkspaceContent(item);
        }
      }

      function toggleFridgeModuleEL(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.hasEL = !mod.hasEL;
          // ELÏû•Ïù¥ ÏóÜÏùÑ Îïå ÌôúÏÑ±ÌôîÌïòÎ©¥ Í∏∞Î≥∏ ELÎ™®Îìà Ï∂îÍ∞Ä
          if (mod.hasEL && (!mod.elModules || mod.elModules.length === 0)) {
            mod.elModules = [{ id: 1, type: 'open', h: 450 }];
          }
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          renderWorkspaceContent(item);
        }
      }

      // ÏÉÅÎ™∞Îî©, Ï¢åÎåÄ Î≥ÄÍ≤Ω Ïãú ÎÜíÏù¥ Ïû¨Í≥ÑÏÇ∞
      function updateFridgeSpecWithRecalc(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          recalcFridgeHeights(item);
          renderWorkspaceContent(item);
        }
      }

      // ÎÜíÏù¥ Í∞í Î≥ÄÍ≤Ω Ïãú Ïó∞Îèô Í≥ÑÏÇ∞
      function updateFridgeHeightWithRecalc(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const newVal = parseFloat(value) || 0;

        if (field === 'fridgeUpperH') {
          item.specs.fridgeUpperH = newVal;
          const moduleBodyH = H - MOLDING_H - newVal - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH * 0.55);
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - item.specs.fridgeMiddleH);
        } else if (field === 'fridgeMiddleH') {
          item.specs.fridgeMiddleH = newVal;
          const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
          const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - newVal);
        } else if (field === 'fridgeLowerH') {
          item.specs.fridgeLowerH = newVal;
          const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
          const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH - newVal);
        }

        renderWorkspaceContent(item);
      }

      function updateFridgeFinish(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs[`finish${side}Type`] = value;
        // ÎßàÍ∞êÏû¨ Í∏∞Î≥∏Í∞í: Î™∞Îî©=60, Ìú†Îùº=60, EP=20, ÏóÜÏùå=0
        const finishType = FINISH_TYPES.find((t) => t.id === value);
        if (finishType) item.specs[`finish${side}Width`] = finishType.defaultW;
        renderWorkspaceContent(item);
      }

      function updateFridgeLegType(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs.fridgeLegType = value;
        const legType = FRIDGE_LEG_TYPES.find((t) => t.id === value);
        if (legType) item.specs.fridgePedestal = legType.defaultH;
        recalcFridgeHeights(item);
        renderWorkspaceContent(item);
      }

      function autoCalculateFridge(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item || item.modules.length === 0) {
          alert('Î™®ÎìàÏùÑ Î®ºÏ†Ä Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        const W = parseFloat(item.w) || 0;
        const fL =
          item.specs.finishLeftType !== 'None'
            ? item.specs.finishLeftType === 'EP'
              ? 20
              : parseFloat(item.specs.finishLeftWidth) || 60
            : 0;
        const fR =
          item.specs.finishRightType !== 'None'
            ? item.specs.finishRightType === 'EP'
              ? 20
              : parseFloat(item.specs.finishRightWidth) || 60
            : 0;
        const effectiveW = W - fL - fR;

        const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        let fixedW = 0,
          adjustableCount = 0;

        modules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ w: mod.w }];
            fixedW += sideGap * 2;
            units.forEach((u, idx) => {
              fixedW += u.w;
              if (idx < units.length - 1) fixedW += betweenGap;
            });
          } else if (mod.isFixed) {
            fixedW += parseFloat(mod.w) || 0;
          } else {
            adjustableCount++;
          }
        });

        if (adjustableCount === 0) {
          alert('Ï°∞Ï†à Í∞ÄÎä•Ìïú Î™®ÎìàÏù¥ ÏóÜÏäµÎãàÎã§.');
          return;
        }
        const remainingW = effectiveW - fixedW;
        if (remainingW <= 0) {
          alert('Ïú†Ìö®Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
          return;
        }
        const perModuleW = Math.floor(remainingW / adjustableCount);
        if (perModuleW < 300) {
          alert(`Í∞Å Î™®ÎìàÏóê ${perModuleW}mmÎßå Ìï†Îãπ Í∞ÄÎä•Ìï©ÎãàÎã§.`);
          return;
        }

        modules.forEach((mod) => {
          if (mod.type !== 'fridge' && !mod.isFixed) mod.w = perModuleW;
        });
        renderWorkspaceContent(item);
      }

      // Ï¥àÍ∏∞Ìôî
      initCategoryGrid();

      // ============================================================
      // ELÏû• ÌåùÏóÖ Í∏∞Îä•
      // ============================================================
      let currentELPopup = { itemId: null, modId: null };

      function openELPopup(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return;

        currentELPopup = { itemId: itemUniqueId, modId: modId };

        // EL Î™®Îìà Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
        if (!mod.elModules) mod.elModules = [];

        // ÌåùÏóÖ HTML ÏÉùÏÑ±
        renderELPopup(item, mod);
      }

      function renderELPopup(item, mod) {
        // Í∏∞Ï°¥ ÌåùÏóÖ Ï†úÍ±∞
        const existingPopup = document.getElementById('el-popup-overlay');
        if (existingPopup) existingPopup.remove();

        // ÌÇ§ÌÅ∞Ïû• Ï†ÑÏ≤¥ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);
        const lowerH = parseFloat(item.specs.fridgeLowerH) || Math.floor(moduleBodyH * 0.45);
        const modW = mod.w;

        // ÌïòÎ∂ÄÏû• ÎÜíÏù¥ (870mm = ÌïòÎ∂ÄÏû• + Ï¢åÎåÄ)
        const lowerWithPedestal = lowerH + PEDESTAL_H;

        // ÌÇ§ÌÅ∞Ïû• Ï†ÑÏ≤¥ ÎÜíÏù¥ (ÏÉÅÎ∂ÄÏû• Ï†úÏô∏, Ï§ëÍ∞ÑÏû• + ÌïòÎ∂ÄÏû• + Ï¢åÎåÄ)
        const tallTotalH = middleH + lowerH + PEDESTAL_H;

        // SVG ÌîÑÎ°†Ìä∏Î∑∞ ÏÉùÏÑ± - ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî
        const svgWidth = 220;
        const svgHeight = 480;
        const scale = Math.min((svgWidth - 40) / modW, (svgHeight - 100) / tallTotalH);
        const drawW = modW * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        // Ïä§ÏºÄÏùºÎêú ÎÜíÏù¥
        const middleH_s = middleH * scale;
        const lowerH_s = lowerH * scale;
        const pedestalH_s = PEDESTAL_H * scale;

        let moduleSvg = '';
        let currentY = offsetY;
        let usedH = 0;

        // Ï§ëÍ∞ÑÏû• ÏòÅÏó≠ - EL Î™®ÎìàÎì§ Í∑∏Î¶¨Í∏∞
        if (mod.elModules && mod.elModules.length > 0) {
          mod.elModules.forEach((elMod, idx) => {
            const elModH = elMod.h * scale;
            const isOpen = elMod.type === 'open';
            const isEL = elMod.isEL === true; // Í∏∞Î≥∏Í∞í false (Í∏∞Î≥∏Î™®Îìà)
            // ELÏû•: ÎÖπÏÉâ, Í∏∞Î≥∏Î™®Îìà: ÌöåÏÉâ, Ïò§ÌîàÏû•: ÎÖ∏ÎûÄÏÉâ
            let fillColor, strokeColor, labelColor, icon, label;
            if (isOpen) {
              fillColor = '#fef3c7';
              strokeColor = '#f59e0b';
              labelColor = '#b45309';
              icon = 'üìÇ';
              label = 'Ïò§ÌîàÏû•';
            } else if (isEL) {
              fillColor = '#dcfce7';
              strokeColor = '#10b981';
              labelColor = '#065f46';
              icon = '‚ö°';
              label = 'ELÏû•';
            } else {
              fillColor = '#f3f4f6';
              strokeColor = '#9ca3af';
              labelColor = '#4b5563';
              icon = 'üì¶';
              label = 'Î™®Îìà';
            }
            const doorName = EL_DOOR_TYPES.find((t) => t.id === elMod.doorType)?.name || 'Ïó¨Îã´Ïù¥';

            moduleSvg += `
        <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${elModH}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="4"/>
        <text x="${offsetX + drawW / 2}" y="${currentY + elModH / 2 - 6}" text-anchor="middle" font-size="11" fill="${labelColor}" font-weight="bold">${icon} ${label}</text>
        <text x="${offsetX + drawW / 2}" y="${currentY + elModH / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${!isOpen && isEL ? doorName + ' | ' : ''}${elMod.h}mm</text>
      `;
            currentY += elModH;
            usedH += elMod.h;
          });
        }

        // Ï§ëÍ∞ÑÏû• ÎÇ®ÏùÄ Í≥µÍ∞Ñ
        const remainingH = middleH - usedH;
        if (remainingH > 0) {
          const remainingScaled = remainingH * scale;
          moduleSvg += `
      <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${remainingScaled}" fill="#f0fdf4" stroke="#86efac" stroke-width="1" stroke-dasharray="4"/>
      <text x="${offsetX + drawW / 2}" y="${currentY + remainingScaled / 2}" text-anchor="middle" font-size="11" fill="#16a34a">Ï§ëÍ∞ÑÏû• ÏûîÏó¨: ${Math.round(remainingH)}mm</text>
    `;
          currentY += remainingScaled;
        }

        // ÌïòÎ∂ÄÏû•
        const lowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'üóÑÔ∏è';
        const lowerName = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.name || 'Í∏∞Î≥∏';
        moduleSvg += `
    <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${lowerH_s}" fill="#f3f4f6" stroke="#6b7280" stroke-width="2" rx="4"/>
    <text x="${offsetX + drawW / 2}" y="${currentY + lowerH_s / 2 - 4}" text-anchor="middle" font-size="11" fill="#374151" font-weight="bold">${lowerIcon} ÌïòÎ∂ÄÏû•</text>
    <text x="${offsetX + drawW / 2}" y="${currentY + lowerH_s / 2 + 12}" text-anchor="middle" font-size="9" fill="#666">${lowerH}mm</text>
  `;
        currentY += lowerH_s;

        // Ï¢åÎåÄ
        moduleSvg += `
    <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${pedestalH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1" rx="2"/>
    <text x="${offsetX + drawW / 2}" y="${currentY + pedestalH_s / 2 + 3}" text-anchor="middle" font-size="8" fill="#6b7280">Ï¢åÎåÄ ${PEDESTAL_H}mm</text>
  `;

        // ÏπòÏàòÏÑ†
        const totalDrawH = middleH_s + lowerH_s + pedestalH_s;
        moduleSvg += `
    <line x1="${offsetX + drawW + 15}" y1="${offsetY}" x2="${offsetX + drawW + 15}" y2="${offsetY + middleH_s}" stroke="#10b981" stroke-width="1"/>
    <text x="${offsetX + drawW + 20}" y="${offsetY + middleH_s / 2}" font-size="9" fill="#10b981" dominant-baseline="middle">Ï§ëÍ∞ÑÏû• ${middleH}</text>
    <line x1="${offsetX + drawW + 15}" y1="${offsetY + middleH_s}" x2="${offsetX + drawW + 15}" y2="${offsetY + middleH_s + lowerH_s + pedestalH_s}" stroke="#6b7280" stroke-width="1"/>
    <text x="${offsetX + drawW + 20}" y="${offsetY + middleH_s + (lowerH_s + pedestalH_s) / 2}" font-size="9" fill="#6b7280" dominant-baseline="middle">ÌïòÎ∂Ä ${lowerWithPedestal}</text>
  `;

        // EL Î™®Îìà Ïπ¥Îìú HTML - Ïù¥ÎèôÎ≤ÑÌäº Ï¢åÏ∏°, Í≥†Ï†ïÎ≤ÑÌäº Ï∂îÍ∞Ä, ELÏû• ÌÜ†Í∏Ä
        const elModuleCards = (mod.elModules || [])
          .map((elMod, idx) => {
            const isOpen = elMod.type === 'open';
            const isEL = elMod.isEL === true; // Í∏∞Î≥∏Í∞í false (Í∏∞Î≥∏Î™®Îìà)
            const isFixed = elMod.isFixed || false;
            const fixedClass = isFixed ? 'fixed-active' : '';
            const elClass = isEL ? 'active' : '';
            return `
      <div class="el-module-card" style="border-left:4px solid ${isOpen ? '#f59e0b' : isEL ? '#10b981' : '#9ca3af'};">
        <div class="el-module-move-btns">
          <button onclick="moveELModule(${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
          <button onclick="moveELModule(${idx}, 1)" ${idx === mod.elModules.length - 1 ? 'disabled' : ''}>‚ñº</button>
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
            <span style="font-weight:700;font-size:12px;">${isOpen ? 'üìÇ Ïò§ÌîàÏû•' : 'üì¶ Î™®Îìà'}</span>
            ${!isOpen ? `<button class="toggle-btn el ${elClass}" onclick="toggleELModuleIsEL(${idx})" style="margin-left:auto;">ELÏû•</button>` : ''}
          </div>
          <div class="el-module-inputs">
            <label>ÎÜíÏù¥</label>
            <input type="number" value="${elMod.h}" onchange="updateELModule(${idx}, 'h', this.value)">
            <span>mm</span>
            ${
              !isOpen
                ? `
              <label>ÎèÑÏñ¥</label>
              <select onchange="updateELModule(${idx}, 'doorType', this.value)" ${mod.doorDivision && mod.doorDivision !== 'individual' ? 'disabled style="opacity:0.5;"' : ''}>
                ${EL_DOOR_TYPES.map((t) => `<option value="${t.id}" ${elMod.doorType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
              </select>
              ${mod.doorDivision && mod.doorDivision !== 'individual' ? '<span style="font-size:8px;color:#888;">(ÎèÑÏñ¥ Íµ¨Î∂Ñ Ï†ÅÏö©)</span>' : ''}
            `
                : ''
            }
          </div>
        </div>
        <div class="el-module-action-btns">
          <button onclick="toggleELModuleFixed(${idx})" class="fixed-btn ${fixedClass}">Í≥†Ï†ï</button>
          <button onclick="removeELModule(${idx})" class="del-btn">√ó</button>
        </div>
      </div>
    `;
          })
          .join('');

        const modTypeName = mod.type === 'tall' ? 'ÌÇ§ÌÅ∞Ïû•' : 'ÌôàÏπ¥ÌéòÏû•';

        const popupHtml = `
    <div id="el-popup-overlay" class="el-popup-overlay" onclick="if(event.target===this)closeELPopup()">
      <div class="el-popup">
        <div class="el-popup-header">
          <span>‚ö° ${modTypeName} ÏÑ§Ï†ï (${mod.w}mm)</span>
          <button onclick="closeELPopup()" class="el-popup-close">‚úï</button>
        </div>
        <div class="el-popup-body">
          <div class="el-popup-preview">
            <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border-radius:12px;border:1px solid #e5e7eb;">
              <text x="${svgWidth / 2}" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">${modTypeName} Front View</text>
              <text x="${svgWidth / 2}" y="${svgHeight - 15}" text-anchor="middle" font-size="10" fill="#666">W: ${modW}mm</text>
              ${moduleSvg}
            </svg>
          </div>
          <div class="el-popup-controls">
            <div class="el-popup-info">
              <div class="info-row"><span class="info-label">Ïú†Ìö®Í≥µÍ∞Ñ</span><span class="info-value">${middleH}mm</span></div>
              <div class="info-row"><span class="info-label">EL ÏÇ¨Ïö©</span><span class="info-value">${usedH}mm</span></div>
              <div class="info-row highlight"><span class="info-label">ÏûîÏó¨</span><span class="info-value ${remainingH < 0 ? 'over' : ''}">${remainingH}mm</span></div>
              <div class="info-row auto-calc-row"><button onclick="autoCalculateELModules()" class="el-auto-calc-btn">‚ö° ÏûêÎèôÍ≥ÑÏÇ∞</button></div>
            </div>
            <div class="el-popup-section-title">EL Î™®Îìà Ï∂îÍ∞Ä</div>
            <div class="el-add-btns">
              <button class="el-add-btn el-type" onclick="addELSubModule('el')">‚ö° Î™®Îìà Ï∂îÍ∞Ä</button>
              <button class="el-add-btn open-type" onclick="addELSubModule('open')">üìÇ Ïò§ÌîàÏû• Ï∂îÍ∞Ä</button>
            </div>
            <div class="el-popup-section-title">Î™®Îìà Î™©Î°ù (${mod.elModules?.length || 0}Í∞ú)</div>
            <div class="el-module-list">
              ${elModuleCards || '<div class="empty-msg">Î™®ÎìàÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>'}
            </div>
            <div class="el-popup-section-title">ÌïòÎ∂ÄÏû• ÏÑ§Ï†ï</div>
            <div class="el-lower-selector">
              ${LOWER_MODULE_TYPES.map(
                (t) => `
                <button onclick="updateELLowerType('${t.id}')" class="el-lower-btn ${mod.lowerType === t.id ? 'active' : ''}" data-type="${t.id}">
                  <span class="lower-icon">${t.icon}</span>
                  <span class="lower-name">${t.name}</span>
                </button>
              `
              ).join('')}
            </div>
          </div>
        </div>
        <div class="el-popup-footer">
          <div class="footer-info">üí° ELÏû•: Ï†ÑÎèô Í∞ÄÏ†ÑÏàòÎÇ© | Ïò§ÌîàÏû•: ÎèÑÏñ¥ ÏóÜÏùå</div>
          <button onclick="applyELPopupAndClose()" class="el-popup-save-btn">ÏôÑÎ£å</button>
        </div>
      </div>
    </div>
    <style>
      .el-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center}
      .el-popup{background:white;border-radius:20px;width:720px;max-width:95vw;max-height:90vh;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,0.35)}
      .el-popup-header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;font-weight:700;font-size:16px}
      .el-popup-close{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0 4px}
      .el-popup-body{display:flex;gap:24px;padding:24px;max-height:calc(90vh - 160px);overflow-y:auto}
      .el-popup-preview{flex:0 0 auto}
      .el-popup-controls{flex:1;min-width:0}
      .el-popup-info{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;padding:12px;background:#f0fdf4;border-radius:10px}
      .info-row{display:flex;flex-direction:column;align-items:center;padding:8px}
      .info-row.highlight{background:#dcfce7;border-radius:8px}
      .info-row.auto-calc-row{justify-content:center}
      .info-label{font-size:10px;color:#666;margin-bottom:2px}
      .info-value{font-size:16px;font-weight:700;color:#065f46}
      .info-value.over{color:#ef4444}
      .el-auto-calc-btn{padding:8px 14px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer}
      .el-auto-calc-btn:hover{opacity:0.9}
      .el-popup-section-title{font-size:13px;font-weight:700;color:#333;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #e5e7eb}
      .el-add-btns{display:flex;gap:10px;margin-bottom:16px}
      .el-add-btn{flex:1;padding:14px;border:2px dashed #ccc;border-radius:10px;background:white;font-size:13px;cursor:pointer;font-weight:700;transition:all 0.2s}
      .el-add-btn.el-type{color:#10b981;border-color:#10b981}.el-add-btn.el-type:hover{background:#dcfce7;border-style:solid}
      .el-add-btn.open-type{color:#f59e0b;border-color:#f59e0b}.el-add-btn.open-type:hover{background:#fef3c7;border-style:solid}
      .el-module-list{max-height:220px;overflow-y:auto}
      .el-module-card{display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:10px}
      .el-module-move-btns{display:flex;flex-direction:column;gap:4px}
      .el-module-move-btns button{width:26px;height:26px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:11px}
      .el-module-move-btns button:hover:not(:disabled){background:#e5e5e5}
      .el-module-move-btns button:disabled{opacity:0.3}
      .el-module-inputs{display:flex;align-items:center;gap:8px;font-size:11px;flex-wrap:wrap}
      .el-module-inputs label{font-weight:600;color:#555}
      .el-module-inputs input{width:70px;padding:6px 8px;font-size:12px;border:1px solid #ddd;border-radius:6px}
      .el-module-inputs select{padding:6px 8px;font-size:12px;border:1px solid #ddd;border-radius:6px}
      .el-module-inputs span{color:#888}
      .el-module-action-btns{display:flex;gap:6px;margin-left:auto}
      .el-module-action-btns button{height:28px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:11px}
      .el-module-action-btns .fixed-btn{padding:0 10px;color:#6b7280;border-color:#d1d5db}
      .el-module-action-btns .fixed-btn:hover{background:#e5e5e5}
      .el-module-action-btns .fixed-btn.fixed-active{background:#dbeafe;color:#2563eb;border-color:#3b82f6;font-weight:700}
      .el-module-action-btns .del-btn{width:28px;color:#ef4444;border-color:#fecaca}
      .el-module-action-btns .del-btn:hover{background:#fee2e2}
      .empty-msg{padding:20px;text-align:center;color:#999;font-size:12px;background:#f9fafb;border-radius:8px}
      .el-lower-selector{display:flex;gap:10px;margin-bottom:16px}
      .el-lower-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border:2px solid #e5e7eb;border-radius:10px;background:white;cursor:pointer;transition:all 0.2s}
      .el-lower-btn:hover{border-color:#6b7280;background:#f9fafb}
      .el-lower-btn.active{border-color:#3b82f6;background:#eff6ff}
      .el-lower-btn .lower-icon{font-size:20px}
      .el-lower-btn .lower-name{font-size:11px;font-weight:600;color:#374151}
      .el-lower-btn.active .lower-name{color:#2563eb}
      .el-popup-footer{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;border-top:1px solid #e5e7eb;background:#f9fafb}
      .footer-info{font-size:11px;color:#666}
      .el-popup-save-btn{padding:12px 28px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer}
      .el-popup-save-btn:hover{opacity:0.9}
    </style>
  `;

        document.body.insertAdjacentHTML('beforeend', popupHtml);
      }

      function closeELPopup() {
        const popup = document.getElementById('el-popup-overlay');
        if (popup) popup.remove();
        currentELPopup = { itemId: null, modId: null };
      }

      // EL ÌåùÏóÖ ÏôÑÎ£å Ïãú ÌîÑÎ°†Ìä∏Î∑∞ Î∞òÏòÅ
      function applyELPopupAndClose() {
        const popup = document.getElementById('el-popup-overlay');
        if (popup) popup.remove();

        // Î©îÏù∏ ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ Îã§Ïãú Î†åÎçîÎßÅÌïòÏó¨ ÌîÑÎ°†Ìä∏Î∑∞ Î∞òÏòÅ
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (item) {
          renderWorkspaceContent(item);
        }

        currentELPopup = { itemId: null, modId: null };
      }

      // EL ÌåùÏóÖÏóêÏÑú ÌïòÎ∂ÄÏû• ÌÉÄÏûÖ Î≥ÄÍ≤Ω
      function updateELLowerType(typeId) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod) return;

        mod.lowerType = typeId;
        renderELPopup(item, mod);
      }

      function addELSubModule(type) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod) return;

        if (!mod.elModules) mod.elModules = [];

        // Í∏∞Î≥∏ ÎÜíÏù¥ Í≥ÑÏÇ∞ (ÏûîÏó¨ ÎÜíÏù¥ ÎòêÎäî 300mm)
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);

        const usedH = mod.elModules.reduce((sum, m) => sum + m.h, 0);
        const remainingH = middleH - usedH;
        // Ïò§ÌîàÏû•ÏùÄ 450mm Í∏∞Î≥∏Í∞í, ELÏû•ÏùÄ ÏûîÏó¨ ÎÜíÏù¥ Í∏∞Î∞ò
        const defaultH = type === 'open' ? 450 : Math.min(300, Math.max(100, remainingH));

        mod.elModules.push({
          id: Date.now(),
          type: type,
          h: defaultH,
          doorType: type === 'el' ? 'swing' : null, // Ïò§ÌîàÏû•ÏùÄ ÎèÑÏñ¥ ÏóÜÏùå
          isFixed: false, // Í≥†Ï†ï Ïó¨Î∂Ä
          isEL: false, // Í∏∞Î≥∏Í∞í: Í∏∞Î≥∏Î™®Îìà (ELÏû• ÏïÑÎãò)
        });

        renderELPopup(item, mod);
      }

      function removeELModule(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules) return;

        mod.elModules.splice(idx, 1);
        renderELPopup(item, mod);
      }

      function updateELModule(idx, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        if (field === 'h') {
          mod.elModules[idx].h = parseFloat(value) || 100;
        } else {
          mod.elModules[idx][field] = value;
        }

        renderELPopup(item, mod);
      }

      function moveELModule(idx, direction) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules) return;

        const newIdx = idx + direction;
        if (newIdx < 0 || newIdx >= mod.elModules.length) return;

        [mod.elModules[idx], mod.elModules[newIdx]] = [mod.elModules[newIdx], mod.elModules[idx]];
        renderELPopup(item, mod);
      }

      // EL Î™®Îìà Í≥†Ï†ï ÌÜ†Í∏Ä
      function toggleELModuleFixed(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        mod.elModules[idx].isFixed = !mod.elModules[idx].isFixed;
        renderELPopup(item, mod);
      }

      // EL Î™®Îìà ELÏû•/Í∏∞Î≥∏Î™®Îìà ÌÜ†Í∏Ä
      function toggleELModuleIsEL(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        // ÌÜ†Í∏Ä: trueÎ©¥ falseÎ°ú, false/undefinedÎ©¥ trueÎ°ú
        mod.elModules[idx].isEL = !mod.elModules[idx].isEL;
        renderELPopup(item, mod);
      }

      // EL Î™®Îìà ÏûêÎèô Í≥ÑÏÇ∞ (Í≥†Ï†ïÎêòÏßÄ ÏïäÏùÄ Î™®ÎìàÏùò ÎÜíÏù¥ Í∑†Îì± Î∞∞Î∂Ñ)
      function autoCalculateELModules() {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || mod.elModules.length === 0) return;

        // Ï§ëÍ∞ÑÏû• Ïú†Ìö® ÎÜíÏù¥ Í≥ÑÏÇ∞
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);

        // Í≥†Ï†ïÎêú Î™®ÎìàÍ≥º Í≥†Ï†ïÎêòÏßÄ ÏïäÏùÄ Î™®Îìà Î∂ÑÎ¶¨
        const fixedModules = mod.elModules.filter((m) => m.isFixed);
        const unfixedModules = mod.elModules.filter((m) => !m.isFixed);

        // Í≥†Ï†ïÎêú Î™®ÎìàÏù¥ ÏÇ¨Ïö©ÌïòÎäî ÎÜíÏù¥
        const fixedHeight = fixedModules.reduce((sum, m) => sum + m.h, 0);

        // Í≥†Ï†ïÎêòÏßÄ ÏïäÏùÄ Î™®ÎìàÏóê Î∞∞Î∂ÑÌï† ÎÜíÏù¥
        const availableHeight = middleH - fixedHeight;

        if (unfixedModules.length > 0 && availableHeight > 0) {
          const heightPerModule = Math.floor(availableHeight / unfixedModules.length);
          unfixedModules.forEach((m) => {
            m.h = heightPerModule;
          });
        }

        renderELPopup(item, mod);
      }

      // ============================================================
      // AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ (Î∂ÄÍ∞Ä Í∏∞Îä•)
      // ============================================================
      (function () {
        // AI Î≤ÑÌäº Î∞è Î™®Îã¨ HTML ÏÇΩÏûÖ
        const aiHTML = `
    <!-- AI Floating Button -->
    <div id="ai-fab" onclick="toggleAIPanel()" title="AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏">
      <span>AI</span>
      <div class="ai-pulse"></div>
    </div>

    <!-- AI Chat Panel -->
    <div id="ai-panel" class="ai-panel-hidden">
      <div class="ai-header">
        <span>ü§ñ Îã§Îã¥ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏</span>
        <button onclick="toggleAIPanel()" class="ai-close">‚úï</button>
      </div>
      <div id="ai-messages" class="ai-messages">
        <div class="ai-msg ai-bot">ÏïàÎÖïÌïòÏÑ∏Ïöî! Í∞ÄÍµ¨ ÏÑ§Í≥ÑÏóê ÎèÑÏõÄÏù¥ ÌïÑÏöîÌïòÏãúÎ©¥ ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî.</div>
      </div>
      <div class="ai-input-area">
        <button id="ai-voice-btn" onclick="toggleVoiceInput()" class="ai-voice-btn" title="ÏùåÏÑ± ÏûÖÎ†•">üé§</button>
        <input type="text" id="ai-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeypress="if(event.key==='Enter')sendAIMessage()">
        <button onclick="sendAIMessage()" class="ai-send-btn">Ï†ÑÏÜ°</button>
      </div>
    </div>
  `;

        // AI Ïä§ÌÉÄÏùº ÏÇΩÏûÖ
        const aiStyles = `
    <style>
      #ai-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
      }
      #ai-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
      }
      #ai-fab span {
        color: white;
        font-weight: bold;
        font-size: 18px;
        z-index: 1;
      }
      #ai-fab .ai-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.4);
        animation: ai-pulse-anim 2s infinite;
      }
      @keyframes ai-pulse-anim {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(1.5); opacity: 0; }
      }

      #ai-panel {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 360px;
        height: 480px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9998;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .ai-panel-hidden {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none !important;
      }
      .ai-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }
      .ai-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }
      .ai-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #f8f9fa;
      }
      .ai-msg {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }
      .ai-bot {
        background: white;
        align-self: flex-start;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
      }
      .ai-user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .ai-input-area {
        display: flex;
        padding: 12px;
        gap: 8px;
        border-top: 1px solid #e9ecef;
        background: white;
      }
      #ai-input {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        outline: none;
      }
      #ai-input:focus {
        border-color: #667eea;
      }
      .ai-voice-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
        background: white;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
      }
      .ai-voice-btn:hover {
        background: #f8f9fa;
      }
      .ai-voice-btn.listening {
        background: #dc3545;
        border-color: #dc3545;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      .ai-send-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }
      .ai-send-btn:hover {
        opacity: 0.9;
      }
      .ai-typing {
        display: flex;
        gap: 4px;
        padding: 10px 14px;
        background: white;
        border-radius: 16px;
        border: 1px solid #e9ecef;
        align-self: flex-start;
      }
      .ai-typing span {
        width: 8px;
        height: 8px;
        background: #adb5bd;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }
      .ai-typing span:nth-child(2) { animation-delay: 0.2s; }
      .ai-typing span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
      }
    </style>
  `;

        document.head.insertAdjacentHTML('beforeend', aiStyles);
        document.body.insertAdjacentHTML('beforeend', aiHTML);
      })();

      // AI Ìå®ÎÑê ÌÜ†Í∏Ä
      let aiPanelOpen = false;
      function toggleAIPanel() {
        const panel = document.getElementById('ai-panel');
        aiPanelOpen = !aiPanelOpen;
        if (aiPanelOpen) {
          panel.classList.remove('ai-panel-hidden');
        } else {
          panel.classList.add('ai-panel-hidden');
        }
      }

      // AI ÏÑ∏ÏÖò ID
      let aiSessionId = null;

      // AI Î©îÏãúÏßÄ Ï†ÑÏÜ°
      async function sendAIMessage() {
        const input = document.getElementById('ai-input');
        const msg = input.value.trim();
        if (!msg) return;

        input.value = '';
        addAIMessage(msg, 'user');

        // ÌÉÄÏù¥Ìïë ÌëúÏãú
        const messagesDiv = document.getElementById('ai-messages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-typing';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: msg,
              session_id: aiSessionId,
              context: getCurrentDesignContext(),
            }),
          });

          const data = await response.json();
          typingDiv.remove();

          if (data.session_id) aiSessionId = data.session_id;
          addAIMessage(data.message || data.error || 'ÏùëÎãµÏùÑ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§.', 'bot');

          // TTS (ÏÑ†ÌÉùÏ†Å)
          if (window.speechSynthesis && data.message) {
            speakAI(data.message);
          }
        } catch (err) {
          typingDiv.remove();
          addAIMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'bot');
        }
      }

      function addAIMessage(text, type) {
        const messagesDiv = document.getElementById('ai-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `ai-msg ai-${type}`;
        msgDiv.textContent = text;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // ÌòÑÏû¨ ÏÑ§Í≥Ñ Ïª®ÌÖçÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
      function getCurrentDesignContext() {
        if (selectedItems.length === 0) return null;
        const item = selectedItems[selectedItems.length - 1];
        return {
          category: item.category,
          name: item.name,
          dimensions: { width: item.w, height: item.h, depth: item.d },
          modules: item.modules,
        };
      }

      // ÏùåÏÑ± Ïù∏Ïãù
      let recognition = null;
      let isListening = false;

      function toggleVoiceInput() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
          return;
        }

        const btn = document.getElementById('ai-voice-btn');

        if (isListening) {
          recognition.stop();
          return;
        }

        if (!recognition) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.lang = 'ko-KR';
          recognition.continuous = false;
          recognition.interimResults = true;

          recognition.onstart = () => {
            isListening = true;
            btn.classList.add('listening');
            btn.textContent = 'üî¥';
          };

          recognition.onresult = (event) => {
            const result = event.results[event.resultIndex];
            const text = result[0].transcript;
            document.getElementById('ai-input').value = text;

            if (result.isFinal) {
              setTimeout(() => sendAIMessage(), 300);
            }
          };

          recognition.onend = () => {
            isListening = false;
            btn.classList.remove('listening');
            btn.textContent = 'üé§';
          };

          recognition.onerror = () => {
            isListening = false;
            btn.classList.remove('listening');
            btn.textContent = 'üé§';
          };
        }

        recognition.start();
      }

      // TTS
      function speakAI(text) {
        const synth = window.speechSynthesis;
        synth.cancel();

        const cleanText = text
          .replace(/\*\*/g, '')
          .replace(/\*/g, '')
          .replace(/#{1,6}\s/g, '')
          .replace(/\n+/g, '. ')
          .trim();

        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.1;
        synth.speak(utterance);
      }

      // ============================================================
      // ÏûêÏû¨ Ï∂îÏ∂ú ÌÅ¥ÎûòÏä§ (Material Extractor) V2.0
      // SKILL: material-extractor-v2.md Í∏∞Î∞ò
      // ============================================================
      class MaterialExtractor {
        constructor(config = {}) {
          this.PANEL_W = 1220;
          this.PANEL_H = 2440;
          this.T = config.thickness || 18; // Î™∏ÌÜµ ÎëêÍªò (15T ÎòêÎäî 18T)
        }

        // ========================================
        // Î©îÏù∏ Ï∂îÏ∂ú Ìï®Ïàò
        // ========================================
        extract(designData) {
          const materials = [];
          const items = designData.items || [];

          console.log('[MaterialExtractor] Ï∂îÏ∂ú ÏãúÏûë, ÏïÑÏù¥ÌÖú Ïàò:', items.length);

          items.forEach((item) => {
            // ‚òÖ categoryId ÏÇ¨Ïö© (categoryÍ∞Ä ÏïÑÎãò!)
            const category = item.categoryId || item.category;
            console.log('[MaterialExtractor] Ï≤òÎ¶¨ Ï§ë:', category, 'Î™®Îìà Ïàò:', (item.modules || []).length);

            switch (category) {
              case 'sink':
                this.extractSink(item, materials);
                break;
              case 'wardrobe':
                this.extractWardrobe(item, materials);
                break;
              case 'fridge':
                this.extractFridge(item, materials);
                break;
            }
          });

          console.log('[MaterialExtractor] Ï∂îÏ∂ú ÏôÑÎ£å, ÏûêÏû¨ Ïàò:', materials.length);

          return {
            materials,
            summary: this.calculateSummary(materials),
            extractDate: new Date().toISOString(),
          };
        }

        // ========================================
        // ÏûêÏû¨ Ï∂îÍ∞Ä Ìó¨Ìçº
        // ========================================
        add(arr, module, part, material, thickness, w, h, qty, edge, note = '') {
          arr.push({
            module,
            part,
            material,
            thickness,
            w: Math.round(w),
            h: Math.round(h),
            qty,
            edge,
            note,
          });
        }

        // ========================================
        // Ïã±ÌÅ¨ÎåÄ ÏûêÏû¨ Ï∂îÏ∂ú
        // ========================================
        extractSink(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const upperD = 295; // ÏÉÅÎ∂ÄÏû• ÍπäÏù¥ (Í≥†Ï†ï)
          const lowerD = 550; // ÌïòÎ∂ÄÏû• ÍπäÏù¥ (Í≥†Ï†ï)
          const isWoodChannel = (specs.handle || '').includes('Î™©Ï∞¨ÎÑ¨');
          const legH = specs.sinkLegHeight || 150;

          // ===== ÏÉÅÎ∂ÄÏû• Î™®Îìà =====
          const upperModules = (item.modules || []).filter((m) => m.pos === 'upper' && m.type !== 'hood');
          console.log('[Sink] ÏÉÅÎ∂ÄÏû• Î™®Îìà:', upperModules.length);

          upperModules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || specs.upperH - 20 || 700;
            const name = mod.name || `${W}/${mod.doorCount || 1}ÎèÑÏñ¥`;

            // Ï∏°Ìåê 2Í∞ú (ÏÇ¨Ïø†Î¶¨Ìôà)
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'Ï∏°Ìåê', 'PB', T, upperD, H, 2, '4Î©¥', 'ÏÇ¨Ïø†Î¶¨(17mmÏóêÏÑú 3mmÌôà)');
            // ÏßÄÌåê (ÏÇ¨Ïø†Î¶¨ Î∞òÏòÅ D-20)
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'ÏßÄÌåê', 'PB', T, W - T * 2, upperD - 20, 1, '1Î©¥(Ï†Ñ)');
            // Ï≤úÌåê
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'Ï≤úÌåê', 'PB', T, W - T * 2, upperD - 20, 1, '1Î©¥(Ï†Ñ)');
            // Îí∑Ìåê (ÏÇ¨Ïø†Î¶¨ÌôàÏóê ÎÅºÏõÄ)
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'Îí∑Ìåê', 'MDF', 2.7, W - 20, H - 1, 1, '-');
            // Î∞¥Îìú(Î≥¥Í∞ïÎ™©) 2Í∞ú
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'Î∞¥Îìú(Î≥¥Í∞ïÎ™©)', 'PB', T, W - T * 2, 60, 2, '2Î©¥(Ïû•)');
            // Î∞¥Îìú(Ï≤òÏßêÎ∞©ÏßÄÎ™©) - W>=700Ïù¥Î©¥ 2Í∞ú
            const bandQty = W >= 700 ? 2 : 1;
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'Î∞¥Îìú(Ï≤òÏßêÎ∞©ÏßÄ)', 'PB', T, 70, H - T * 2, bandQty, '2Î©¥(Ïû•)');
            // ÏÑ†Î∞ò 2Í∞ú
            this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'ÏÑ†Î∞ò', 'PB', T, W - T * 2, upperD - 35, 2, '1Î©¥(Ï†Ñ)');
            // ÎèÑÏñ¥ (H + 20)
            const doorCount = mod.doorCount || 1;
            if (doorCount > 0) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `ÏÉÅÎ∂ÄÏû•-${name}`, 'ÎèÑÏñ¥', 'MDF', 18, doorW, H + 20, doorCount, '4Î©¥');
            }
          });

          // ===== ÌïòÎ∂ÄÏû• Î™®Îìà =====
          const lowerModules = (item.modules || []).filter((m) => m.pos === 'lower' && m.type !== 'cook');
          console.log('[Sink] ÌïòÎ∂ÄÏû• Î™®Îìà:', lowerModules.length);

          lowerModules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || (specs.lowerH || 870) - legH;
            const name = mod.name || `${W}/${mod.doorCount || 1}ÎèÑÏñ¥`;
            const isDrawer = mod.isDrawer || false;
            const isEL = mod.isEL || false;
            const isOpen = mod.isOpen || false;

            // Ï∏°Ìåê 2Í∞ú
            this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'Ï∏°Ìåê', 'PB', T, lowerD, H, 2, '4Î©¥');
            // ÏßÄÌåê
            this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'ÏßÄÌåê', 'PB', T, W - T * 2, lowerD, 1, '1Î©¥(Ï†Ñ)');
            // Î∞¥Îìú 2Í∞ú
            this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'Î∞¥Îìú', 'PB', T, 60, W - T * 2, 2, '2Î©¥(Ïû•)');
            // Îí∑Ìåê
            this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'Îí∑Ìåê', 'MDF', 2.7, W - 1, H - 1, 1, '-');
            // Î∞¥Îìú(Ï≤òÏßêÎ∞©ÏßÄÎ™©) - Î™©Ï∞¨ÎÑ¨Ïù¥Î©¥ -70, W>=800Ïù¥Î©¥ 2Í∞ú
            const bandH = isWoodChannel ? H - T * 2 - 70 : H - T * 2;
            const bandQty = W >= 800 ? 2 : 1;
            this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'Î∞¥Îìú(Ï≤òÏßêÎ∞©ÏßÄ)', 'PB', T, 70, bandH, bandQty, '2Î©¥(Ïû•)');
            // ÏÑ†Î∞ò (ÏÑúÎûç/EL/Ïò§ÌîàÏû• ÏóÜÏúºÎ©¥ 1Í∞ú)
            if (!isDrawer && !isEL && !isOpen && mod.type !== 'sink') {
              this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'ÏÑ†Î∞ò', 'PB', T, W - T * 2, lowerD - 15, 1, '1Î©¥(Ï†Ñ)');
            }
            // ÎèÑÏñ¥ (H - 30)
            const doorCount = mod.doorCount || 0;
            if (doorCount > 0 && !isDrawer) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `ÌïòÎ∂ÄÏû•-${name}`, 'ÎèÑÏñ¥', 'MDF', 18, doorW, H - 30, doorCount, '4Î©¥');
            }
          });

          // ===== EP (ÎßàÍ∞êÏû¨) =====
          const totalLowerW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
          const effectiveW = totalLowerW || item.w - 120;

          // Í±∏Î†àÎ∞õÏù¥
          this.add(materials, 'EP', 'Í±∏Î†àÎ∞õÏù¥', 'MDF', 18, effectiveW, legH - 5, 1, '2Î©¥(Ïû•)');

          // Î™©Ï∞¨ÎÑ¨
          if (isWoodChannel) {
            this.add(materials, 'EP', 'Î™©Ï∞¨ÎÑ¨(Ï†ÑÎ©¥)', 'MDF', 18, 52, effectiveW, 1, '-');
            this.add(materials, 'EP', 'Î™©Ï∞¨ÎÑ¨(ÏßÄÎ©¥)', 'MDF', 18, 40, effectiveW, 1, '-');
          }

          // Ìú†Îùº (Ï¢å/Ïö∞)
          const lowerH = (specs.lowerH || 870) - legH;
          if (specs.finishLeftType === 'Filler' && specs.finishLeftWidth > 0) {
            this.add(materials, 'EP', 'Ìú†Îùº(Ï¢å)', 'MDF', 18, specs.finishLeftWidth, lowerH, 1, '2Î©¥(Ïû•)');
          }
          if (specs.finishRightType === 'Filler' && specs.finishRightWidth > 0) {
            this.add(materials, 'EP', 'Ìú†Îùº(Ïö∞)', 'MDF', 18, specs.finishRightWidth, lowerH, 1, '2Î©¥(Ïû•)');
          }
        }

        // ========================================
        // Î∂ôÎ∞ïÏù¥Ïû• ÏûêÏû¨ Ï∂îÏ∂ú
        // ========================================
        extractWardrobe(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const D = parseFloat(item.d) || 650;
          const pedestalH = parseFloat(specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 2300;
          const bodyH = totalH - pedestalH - moldingH;

          console.log('[Wardrobe] ===== Î∂ôÎ∞ïÏù¥Ïû• ÏûêÏû¨ Ï∂îÏ∂ú ÏãúÏûë =====');
          console.log('[Wardrobe] item.modules:', item.modules);

          // ‚òÖ Î™®Îì† Î™®Îìà Ï≤òÎ¶¨ (ÌïÑÌÑ∞ ÏóÜÏù¥)
          const modules = item.modules || [];

          console.log('[Wardrobe] Î™®Îìà Ïàò:', modules.length);

          if (modules.length === 0) {
            console.warn('[Wardrobe] ‚ö†Ô∏è Î™®ÎìàÏù¥ ÏóÜÏäµÎãàÎã§!');
            return;
          }

          let totalW = 0;

          modules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 900;
            totalW += W;

            // ‚òÖ moduleTypeÏù¥ Ïã§Ï†ú Î™®Îìà Ï¢ÖÎ•ò (short/long/shelf)
            const modType = mod.moduleType || mod.type || 'long';
            const name = mod.name || `${idx + 1}Î≤à`;

            console.log(`[Wardrobe] Î™®Îìà ${idx + 1} Ï≤òÎ¶¨: ${name}, W=${W}, type=${modType}`);

            // Ï∏°Ìåê 2Í∞ú
            this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'Ï∏°Ìåê', 'PB', T, D, bodyH, 2, '4Î©¥');
            // Ï≤úÌåê
            this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'Ï≤úÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
            // ÏßÄÌåê
            this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'ÏßÄÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
            // Îí∑Ìåê
            this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'Îí∑Ìåê', 'MDF', 2.7, W - 1, bodyH - 1, 1, '-');

            // Ï§ëÍ∞ÑÏπ∏ÎßâÏù¥ (ÏßßÏùÄÏò∑2Îã®Îßå)
            if (modType === 'short') {
              this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'Ï§ëÍ∞ÑÏπ∏ÎßâÏù¥', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
            }

            // ÏÑ†Î∞ò (ÏÑ†Î∞òÌòï=4Í∞ú, Í∑∏Ïô∏=1Í∞ú)
            const shelfCount = modType === 'shelf' ? 4 : mod.shelfCount || 1;
            this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'ÏÑ†Î∞ò', 'PB', T, W - T * 2, D - 15, shelfCount, '1Î©¥(Ï†Ñ)');

            // ÎèÑÏñ¥ (H + 20)
            const doorCount = mod.doorCount || 1;
            if (doorCount > 0) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `Î∂ôÎ∞ïÏù¥Ïû•-${name}`, 'ÎèÑÏñ¥', 'MDF', 18, doorW, bodyH + 20, doorCount, '4Î©¥');
            }
          });

          console.log('[Wardrobe] Î™®Îìà Ìï©Í≥Ñ ÎÑàÎπÑ:', totalW);

          // EP (ÏÉÅÎ™∞Îî©, Ï¢åÎåÄ)
          if (moldingH > 0 && totalW > 0) {
            this.add(materials, 'EP', 'ÏÉÅÎ™∞Îî©', 'MDF', 18, totalW, moldingH, 1, '2Î©¥(Ïû•)');
          }
          if (pedestalH > 0 && totalW > 0) {
            this.add(materials, 'EP', 'Ï¢åÎåÄ', 'PB', T, totalW, pedestalH, 1, '1Î©¥(Ï†Ñ)');
          }

          console.log('[Wardrobe] ===== Ï∂îÏ∂ú ÏôÑÎ£å, ÏûêÏû¨ Ïàò:', materials.length, '=====');
        }

        // ========================================
        // ÎÉâÏû•Í≥†Ïû• ÏûêÏû¨ Ï∂îÏ∂ú
        // ========================================
        extractFridge(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const modules = item.modules || [];

          console.log('[Fridge] Î™®Îìà:', modules.length);

          if (modules.length === 0) return;

          modules.forEach((mod, idx) => {
            const modType = mod.type || '';
            if (modType === 'fridge') return; // ÎÉâÏû•Í≥† ÏûêÏ≤¥Îäî Ï†úÏô∏

            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || 2000;
            const D = parseFloat(mod.d) || specs.fridgeModuleD || 550;
            const name = mod.name || modType;

            console.log(`[Fridge] Î™®Îìà: ${modType}, W=${W}, H=${H}, D=${D}`);

            // ÌÇ§ÌÅ∞Ïû• (tall)
            if (modType === 'tall') {
              this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'Ï∏°Ìåê', 'PB', T, D, H, 2, '4Î©¥');
              this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'Ï≤úÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'ÏßÄÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'Îí∑Ìåê', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'ÏÑ†Î∞ò', 'PB', T, W - T * 2, D - 15, 3, '1Î©¥(Ï†Ñ)');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'ÌÇ§ÌÅ∞Ïû•', 'ÎèÑÏñ¥', 'MDF', 18, doorW, H + 20, doorCount, '4Î©¥');
              }
            }
            // ÌôàÏπ¥ÌéòÏû• (homecafe) - Ïò§ÌîàÏû• Í∑úÏπô: MDF 18T
            else if (modType === 'homecafe') {
              this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'Ï∏°Ìåê', 'MDF', 18, D + 20, H, 2, '4Î©¥');
              this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'Ï≤úÌåê', 'MDF', 18, W - 36, D, 1, '2Î©¥(Í∞ÄÎ°ú)');
              this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'ÏßÄÌåê', 'MDF', 18, W - 36, D, 1, '2Î©¥(Í∞ÄÎ°ú)');
              this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'Îí∑Ìåê', 'MDF', 18, W - 36, H, 1, '2Î©¥(Í∞ÄÎ°ú)'); // 18T!
              this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'ÏÑ†Î∞ò', 'MDF', 18, W - 36, D - 15, 2, '1Î©¥(Ï†Ñ)');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'ÌôàÏπ¥ÌéòÏû•', 'ÎèÑÏñ¥', 'MDF', 18, doorW, H + 20, doorCount, '4Î©¥');
              }
            }
            // ÏÉÅÎ∂ÄÏû• (upper)
            else if (modType === 'upper') {
              this.add(materials, 'ÎÉâÏû•Í≥†ÏÉÅÎ∂ÄÏû•', 'Ï∏°Ìåê', 'PB', T, D, H, 2, '4Î©¥');
              this.add(materials, 'ÎÉâÏû•Í≥†ÏÉÅÎ∂ÄÏû•', 'Ï≤úÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÎÉâÏû•Í≥†ÏÉÅÎ∂ÄÏû•', 'ÏßÄÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÎÉâÏû•Í≥†ÏÉÅÎ∂ÄÏû•', 'Îí∑Ìåê', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              this.add(materials, 'ÎÉâÏû•Í≥†ÏÉÅÎ∂ÄÏû•', 'ÎèÑÏñ¥', 'MDF', 18, W - 4, H + 20, 1, '4Î©¥');
            }
            // ÌïòÎ∂ÄÏû• (lower)
            else if (modType === 'lower') {
              this.add(materials, 'ÎÉâÏû•Í≥†ÌïòÎ∂ÄÏû•', 'Ï∏°Ìåê', 'PB', T, D, H, 2, '4Î©¥');
              this.add(materials, 'ÎÉâÏû•Í≥†ÌïòÎ∂ÄÏû•', 'Ï≤úÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÎÉâÏû•Í≥†ÌïòÎ∂ÄÏû•', 'ÏßÄÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ÎÉâÏû•Í≥†ÌïòÎ∂ÄÏû•', 'Îí∑Ìåê', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'ÎÉâÏû•Í≥†ÌïòÎ∂ÄÏû•', 'ÎèÑÏñ¥', 'MDF', 18, doorW, H - 30, doorCount, '4Î©¥');
              }
            }
            // ELÏû• (el)
            else if (modType === 'el') {
              this.add(materials, 'ELÏû•', 'Ï∏°Ìåê', 'PB', T, D, H, 2, '4Î©¥');
              this.add(materials, 'ELÏû•', 'Ï≤úÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ELÏû•', 'ÏßÄÌåê', 'PB', T, W - T * 2, D, 1, '1Î©¥(Ï†Ñ)');
              this.add(materials, 'ELÏû•', 'Îí∑Ìåê', 'MDF', 2.7, W - 1, H - 1, 1, '-');
            }
          });
        }

        // ========================================
        // ÏöîÏïΩ Í≥ÑÏÇ∞
        // ========================================
        calculateSummary(materials) {
          const summary = {};
          materials.forEach((m) => {
            const key = `${m.material}_${m.thickness}`;
            if (!summary[key]) {
              summary[key] = { material: m.material, thickness: m.thickness, totalArea: 0, panelCount: 0 };
            }
            summary[key].totalArea += m.w * m.h * m.qty;
          });

          const panelArea = this.PANEL_W * this.PANEL_H;
          Object.values(summary).forEach((s) => {
            s.panelCount = Math.ceil(s.totalArea / panelArea);
          });

          return summary;
        }

        // ========================================
        // CSV Ï∂úÎ†•
        // ========================================
        toCSV(materials) {
          let csv = 'Î™®Îìà,Î∂ÄÌíà,ÏûêÏû¨,ÎëêÍªò,Í∞ÄÎ°ú,ÏÑ∏Î°ú,ÏàòÎüâ,Ïó£ÏßÄ,ÎπÑÍ≥†\n';
          materials.forEach((m) => {
            csv += `${m.module},${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${m.edge},${m.note || ''}\n`;
          });
          return csv;
        }

        // ========================================
        // CNC Ï∂úÎ†•
        // ========================================
        toCNC(materials) {
          let csv = 'ÌíàÎ™©,ÏûêÏû¨,ÎëêÍªò,Í∞ÄÎ°ú,ÏÑ∏Î°ú,ÏàòÎüâ,Ïó£ÏßÄL,Ïó£ÏßÄR,Ïó£ÏßÄT,Ïó£ÏßÄB\n';
          materials.forEach((m) => {
            let el = 0,
              er = 0,
              et = 0,
              eb = 0;
            if (m.edge === '4Î©¥') {
              el = er = et = eb = 1;
            } else if (m.edge.includes('2Î©¥')) {
              if (m.w > m.h) {
                el = er = 1;
              } else {
                et = eb = 1;
              }
            } else if (m.edge.includes('1Î©¥')) {
              el = 1;
            }
            csv += `${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${el},${er},${et},${eb}\n`;
          });
          return csv;
        }
      }

      // ============================================================
      // Î∂ÄÏûêÏû¨ Ï∂îÏ∂ú ÌÅ¥ÎûòÏä§ (Hardware Extractor) v1.0
      // ============================================================
      class HardwareExtractor {
        constructor() {
          this.hingeRules = { 900: 2, 1600: 3, 9999: 4 }; // ÎÜíÏù¥Î≥Ñ Í≤ΩÏ≤© Ïàò
        }

        extract(designData) {
          const hardware = [];
          const items = designData.items || [];

          items.forEach((item) => {
            this.extractHinges(item, hardware);
            this.extractRails(item, hardware);
            this.extractHandles(item, hardware);
            this.extractLegs(item, hardware);
            this.extractBrackets(item, hardware);
            this.extractOthers(item, hardware);
          });

          return {
            hardware,
            summary: this.calculateSummary(hardware),
            extractDate: new Date().toISOString(),
          };
        }

        // Í≤ΩÏ≤© Ïàò Í≥ÑÏÇ∞
        getHingeCount(doorH) {
          if (doorH <= 900) return 2;
          if (doorH <= 1600) return 3;
          return 4;
        }

        // Î≥¥ÎßÅ ÏúÑÏπò Í≥ÑÏÇ∞
        getBoringPositions(doorH) {
          const count = this.getHingeCount(doorH);
          if (count === 2) return [110, doorH - 110];
          if (count === 3) return [110, Math.round(doorH / 2), doorH - 110];
          return [110, Math.round(doorH / 3), Math.round((doorH * 2) / 3), doorH - 110];
        }

        // Í≤ΩÏ≤© Ï∂îÏ∂ú
        extractHinges(item, hardware) {
          const specs = item.specs || {};
          (item.modules || []).forEach((mod) => {
            const doorCount = mod.doorCount || 0;
            if (doorCount === 0) return;

            let doorH;
            if (mod.pos === 'upper') doorH = (mod.h || specs.upperH - 20) + 20;
            else if (mod.pos === 'lower') doorH = (mod.h || specs.lowerH - specs.sinkLegHeight) - 30;
            else doorH = mod.h || 700;

            const hingesPerDoor = this.getHingeCount(doorH);
            const boring = this.getBoringPositions(doorH);

            hardware.push({
              category: 'Í≤ΩÏ≤©',
              item: 'Ïª®Ïã§Îìú Í≤ΩÏ≤© 110¬∞',
              manufacturer: 'Î∏îÎ£∏',
              spec: `${hingesPerDoor}Íµ¨`,
              qty: hingesPerDoor * doorCount,
              unit: 'EA',
              note: `${mod.name || mod.type} (Î≥¥ÎßÅ: ${boring.join(', ')})`,
            });
          });
        }

        // Î†àÏùº Ï∂îÏ∂ú
        extractRails(item, hardware) {
          (item.modules || []).forEach((mod) => {
            if (!mod.isDrawer) return;
            const depth = mod.d || 550;
            let railLength = 500;
            if (depth <= 350) railLength = 350;
            else if (depth <= 450) railLength = 450;

            hardware.push({
              category: 'Î†àÏùº',
              item: 'ÏÜåÌîÑÌä∏ÌÅ¥Î°úÏ¶à ÏÑúÎûçÎ†àÏùº',
              manufacturer: 'Î∏îÎ£∏',
              spec: `${railLength}mm`,
              qty: 1,
              unit: 'SET',
              note: mod.name || mod.type,
            });
          });
        }

        // ÏÜêÏû°Ïù¥ Ï∂îÏ∂ú
        extractHandles(item, hardware) {
          const specs = item.specs || {};
          const handleType = specs.handle || 'Ï∞¨ÎÑ¨';
          let totalDoors = 0;

          (item.modules || []).forEach((mod) => {
            totalDoors += mod.doorCount || 0;
          });

          if (totalDoors > 0) {
            hardware.push({
              category: 'ÏÜêÏû°Ïù¥',
              item: handleType.includes('Ïä§ÎßàÌä∏Î∞î')
                ? 'Ïä§ÎßàÌä∏Î∞î'
                : handleType.includes('Î™©Ï∞¨ÎÑ¨')
                  ? 'Î™©Ï∞¨ÎÑ¨'
                  : handleType,
              manufacturer: '-',
              spec: '-',
              qty: handleType.includes('Ïä§ÎßàÌä∏Î∞î') ? (item.modules || []).length : totalDoors,
              unit: 'EA',
              note: item.category,
            });
          }
        }

        // Îã§Î¶¨Î∞ú Ï∂îÏ∂ú
        extractLegs(item, hardware) {
          const category = item.categoryId || item.category;
          if (category !== 'sink') return;
          const specs = item.specs || {};
          const legH = specs.sinkLegHeight || 150;
          let totalLegs = 0;

          (item.modules || [])
            .filter((m) => m.pos === 'lower')
            .forEach((mod) => {
              const w = mod.w || 600;
              if (w <= 600) totalLegs += 4;
              else if (w <= 900) totalLegs += 6;
              else totalLegs += 8;
            });

          if (totalLegs > 0) {
            hardware.push({
              category: 'Îã§Î¶¨Î∞ú',
              item: 'Ï°∞Ï†à Îã§Î¶¨Î∞ú',
              manufacturer: '-',
              spec: `${legH}mm`,
              qty: totalLegs,
              unit: 'EA',
              note: 'ÌïòÎ∂ÄÏû•',
            });
          }
        }

        // ÏÑ†Î∞ò Î∏åÎùºÏºì Ï∂îÏ∂ú
        extractBrackets(item, hardware) {
          let shelfCount = 0;
          (item.modules || []).forEach((mod) => {
            if (mod.pos === 'upper' && mod.type !== 'hood') shelfCount += 2;
            else if (mod.pos === 'lower' && !mod.isDrawer && mod.type !== 'sink' && mod.type !== 'cook')
              shelfCount += 1;
          });

          if (shelfCount > 0) {
            hardware.push({
              category: 'Î∏åÎùºÏºì',
              item: 'ÏÑ†Î∞ò Î∏åÎùºÏºì (ÌïÄÌÉÄÏûÖ)',
              manufacturer: '-',
              spec: 'Œ¶5mm',
              qty: shelfCount * 4,
              unit: 'EA',
              note: `ÏÑ†Î∞ò ${shelfCount}Í∞ú √ó 4`,
            });
          }
        }

        // Í∏∞ÌÉÄ Î∂ÄÏûêÏû¨
        extractOthers(item, hardware) {
          let totalDoors = 0;
          (item.modules || []).forEach((mod) => {
            totalDoors += mod.doorCount || 0;
          });

          if (totalDoors > 0) {
            hardware.push({
              category: 'Í∏∞ÌÉÄ',
              item: 'ÎèÑÏñ¥ ÎåêÌçº',
              manufacturer: '-',
              spec: '-',
              qty: totalDoors * 2,
              unit: 'EA',
              note: `ÎèÑÏñ¥ ${totalDoors}Í∞ú √ó 2`,
            });
          }
        }

        // ÏöîÏïΩ
        calculateSummary(hardware) {
          const summary = {};
          hardware.forEach((h) => {
            if (!summary[h.category]) summary[h.category] = 0;
            summary[h.category] += h.qty;
          });
          return summary;
        }

        // CSV ÏÉùÏÑ±
        toCSV(hardware) {
          let csv = 'Î∂ÑÎ•ò,ÌíàÎ™©,Ï†úÏ°∞ÏÇ¨,Ïä§Ìéô,ÏàòÎüâ,Îã®ÏúÑ,ÎπÑÍ≥†\n';
          hardware.forEach((h) => {
            csv += `${h.category},${h.item},${h.manufacturer},${h.spec},${h.qty},${h.unit},${h.note}\n`;
          });
          return csv;
        }
      }

      // ============================================================
      // ÎèÑÎ©¥ ÏãúÍ∞ÅÌôî ÌÅ¥ÎûòÏä§ (Drawing Visualizer) v1.0
      // ============================================================
      class DrawingVisualizer {
        constructor() {
          this.PANEL_W = 1220;
          this.PANEL_H = 2440;
          this.KERF = 4;
        }

        // Ïû¨Îã® ÎèÑÎ©¥ ÏÉùÏÑ±
        generateCuttingLayout(materials, mode = 'material') {
          const groups = this.groupByMaterial(materials);
          const panels = {};

          Object.keys(groups).forEach((key) => {
            panels[key] = this.packParts(groups[key], mode);
          });

          return panels;
        }

        // ÏûêÏû¨Î≥Ñ Í∑∏Î£πÌôî
        groupByMaterial(materials) {
          const groups = {};
          materials.forEach((m) => {
            const key = `${m.material}_${m.thickness}T`;
            if (!groups[key]) groups[key] = [];
            for (let i = 0; i < m.qty; i++) {
              groups[key].push({ ...m, qty: 1 });
            }
          });
          return groups;
        }

        // Bin Packing
        packParts(parts, mode) {
          const sorted = [...parts].sort((a, b) => b.w * b.h - a.w * a.h);
          const panels = [];
          let panelId = 1;

          sorted.forEach((part) => {
            let placed = false;
            for (const panel of panels) {
              if (this.tryPlace(panel, part)) {
                placed = true;
                break;
              }
            }
            if (!placed) {
              const newPanel = this.createPanel(panelId++);
              this.tryPlace(newPanel, part);
              panels.push(newPanel);
            }
          });

          return panels;
        }

        createPanel(id) {
          return {
            id,
            w: this.PANEL_W,
            h: this.PANEL_H,
            parts: [],
            freeRects: [{ x: 0, y: 0, w: this.PANEL_W, h: this.PANEL_H }],
          };
        }

        tryPlace(panel, part) {
          const orientations = [
            { w: part.w, h: part.h, rotated: false },
            { w: part.h, h: part.w, rotated: true },
          ];

          for (const orient of orientations) {
            for (let i = 0; i < panel.freeRects.length; i++) {
              const rect = panel.freeRects[i];
              if (orient.w + this.KERF <= rect.w && orient.h + this.KERF <= rect.h) {
                const placed = {
                  ...part,
                  x: rect.x,
                  y: rect.y,
                  w: orient.w,
                  h: orient.h,
                  rotated: orient.rotated,
                };
                panel.parts.push(placed);
                this.splitRect(panel, rect, orient.w, orient.h);
                return true;
              }
            }
          }
          return false;
        }

        splitRect(panel, rect, usedW, usedH) {
          const idx = panel.freeRects.indexOf(rect);
          panel.freeRects.splice(idx, 1);

          const rightW = rect.w - usedW - this.KERF;
          if (rightW > 100) {
            panel.freeRects.push({ x: rect.x + usedW + this.KERF, y: rect.y, w: rightW, h: rect.h });
          }

          const bottomH = rect.h - usedH - this.KERF;
          if (bottomH > 100) {
            panel.freeRects.push({ x: rect.x, y: rect.y + usedH + this.KERF, w: usedW, h: bottomH });
          }

          panel.freeRects.sort((a, b) => b.w * b.h - a.w * a.h);
        }

        getEfficiency(panel) {
          const used = panel.parts.reduce((sum, p) => sum + p.w * p.h, 0);
          return ((used / (panel.w * panel.h)) * 100).toFixed(1);
        }

        // SVG ÏÉùÏÑ±
        generateSVG(panel, matKey, scale = 0.25) {
          const svgW = Math.round(this.PANEL_W * scale);
          const svgH = Math.round(this.PANEL_H * scale);
          const eff = this.getEfficiency(panel);

          let svg = `<svg width="${svgW + 40}" height="${svgH + 60}" viewBox="0 0 ${svgW + 40} ${svgH + 60}" xmlns="http://www.w3.org/2000/svg">
      <style>
        .panel { fill: #f5f5f5; stroke: #333; stroke-width: 2; }
        .part { fill: #e3f2fd; stroke: #1976d2; stroke-width: 1; }
        .door { fill: #fff3e0; stroke: #f57c00; stroke-width: 1; }
        .back { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 1; }
        .label { font-family: Arial; font-size: 9px; fill: #333; }
        .dim { font-family: Arial; font-size: 7px; fill: #666; }
        .title { font-family: Arial; font-size: 11px; font-weight: bold; fill: #333; }
      </style>
      <text x="20" y="18" class="title">Ìå®ÎÑê #${panel.id} (${matKey}) - Ìö®Ïú®: ${eff}%</text>
      <rect x="20" y="30" width="${svgW}" height="${svgH}" class="panel"/>`;

          panel.parts.forEach((part) => {
            const x = Math.round(part.x * scale) + 20;
            const y = Math.round(part.y * scale) + 30;
            const w = Math.round(part.w * scale);
            const h = Math.round(part.h * scale);
            const cls = part.part.includes('ÎèÑÏñ¥') ? 'door' : part.part.includes('Îí∑Ìåê') ? 'back' : 'part';

            svg += `<rect x="${x}" y="${y}" width="${w}" height="${h}" class="${cls}"/>`;
            svg += `<text x="${x + w / 2}" y="${y + h / 2 - 4}" class="label" text-anchor="middle">${part.part}</text>`;
            svg += `<text x="${x + w / 2}" y="${y + h / 2 + 8}" class="dim" text-anchor="middle">${part.w}√ó${part.h}</text>`;
            if (part.rotated) svg += `<text x="${x + 3}" y="${y + 12}" class="dim">‚Üª</text>`;
          });

          svg += `</svg>`;
          return svg;
        }

        // HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
        generateReport(panelGroups) {
          let html = `<div style="font-family:Arial;padding:20px;">
      <h2 style="color:#1976d2;">ü™µ Ïû¨Îã® ÎèÑÎ©¥</h2>
      <p>ÏÉùÏÑ±Ïùº: ${new Date().toLocaleString('ko-KR')}</p>`;

          let totalPanels = 0;
          Object.keys(panelGroups).forEach((key) => {
            const panels = panelGroups[key];
            totalPanels += panels.length;
            html += `<h3>${key}: ${panels.length}Ïû•</h3>`;
            panels.forEach((panel) => {
              html += `<div style="margin:10px 0;border:1px solid #ddd;padding:10px;border-radius:8px;">`;
              html += this.generateSVG(panel, key);
              html += `<p style="font-size:12px;color:#666;">Î∂ÄÌíà ${panel.parts.length}Í∞ú</p></div>`;
            });
          });

          html += `<h3>Ï¥ù Ìå®ÎÑê: ${totalPanels}Ïû•</h3></div>`;
          return html;
        }
      }

      // ============================================================
      // Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
      // ============================================================
      const materialExtractor = new MaterialExtractor();
      const hardwareExtractor = new HardwareExtractor();
      const drawingVisualizer = new DrawingVisualizer();

      // DadamAgentÏóê Ï∂îÏ∂ú Í∏∞Îä• Ï∂îÍ∞Ä
      window.DadamAgent.extractMaterials = function () {
        const design = window.DadamAgent.exportDesign();
        return materialExtractor.extract(design);
      };

      window.DadamAgent.extractHardware = function () {
        const design = window.DadamAgent.exportDesign();
        return hardwareExtractor.extract(design);
      };

      window.DadamAgent.generateDrawings = function (mode = 'material') {
        const design = window.DadamAgent.exportDesign();
        const matResult = materialExtractor.extract(design);
        return drawingVisualizer.generateCuttingLayout(matResult.materials, mode);
      };

      // ============================================================
      // UI Ìï®Ïàò: Î™®Îã¨ ÌëúÏãú
      // ============================================================
      function showExtractorModal(title, content) {
        const existingModal = document.getElementById('extractorModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'extractorModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:900px;max-height:85vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="background:#1976d2;color:white;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:18px;">${title}</h3>
          <button onclick="document.getElementById('extractorModal').remove()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;overflow-y:auto;max-height:calc(85vh - 120px);">
          ${content}
        </div>
        <div style="padding:12px 20px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;">
          <button onclick="downloadExtractorData()" style="background:#4caf50;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">üì• Îã§Ïö¥Î°úÎìú</button>
          <button onclick="document.getElementById('extractorModal').remove()" style="background:#eee;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Îã´Í∏∞</button>
        </div>
      </div>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // ÏûêÏû¨ Ï∂îÏ∂ú UI
      function showMaterialExtractor() {
        const result = window.DadamAgent.extractMaterials();
        if (!result.materials.length) {
          alert('Ï∂îÏ∂úÌï† ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÑ§Í≥ÑÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
          return;
        }

        let tableHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead style="background:#e3f2fd;">
      <tr>
        <th style="border:1px solid #ddd;padding:8px;">No</th>
        <th style="border:1px solid #ddd;padding:8px;">Î™®Îìà</th>
        <th style="border:1px solid #ddd;padding:8px;">Î∂ÄÌíà</th>
        <th style="border:1px solid #ddd;padding:8px;">ÏûêÏû¨</th>
        <th style="border:1px solid #ddd;padding:8px;">ÎëêÍªò</th>
        <th style="border:1px solid #ddd;padding:8px;">Í∞ÄÎ°ú</th>
        <th style="border:1px solid #ddd;padding:8px;">ÏÑ∏Î°ú</th>
        <th style="border:1px solid #ddd;padding:8px;">ÏàòÎüâ</th>
        <th style="border:1px solid #ddd;padding:8px;">Ïó£ÏßÄ</th>
      </tr>
    </thead><tbody>`;

        result.materials.forEach((m, i) => {
          tableHTML += `<tr>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${i + 1}</td>
      <td style="border:1px solid #ddd;padding:6px;">${m.module}</td>
      <td style="border:1px solid #ddd;padding:6px;">${m.part}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.material}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.thickness}T</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.w}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.h}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.qty}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.edge}</td>
    </tr>`;
        });
        tableHTML += `</tbody></table>`;

        // ÏöîÏïΩ
        let summaryHTML = `<div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
    <h4 style="margin:0 0 10px 0;">üìä ÏûêÏû¨ ÏöîÏïΩ</h4><table style="width:100%;font-size:13px;">
    <tr style="background:#e8f5e9;"><th style="padding:8px;text-align:left;">ÏûêÏû¨</th><th>Ï¥ùÎ©¥Ï†Å</th><th>Ìå®ÎÑê Ïàò</th></tr>`;
        Object.values(result.summary).forEach((s) => {
          summaryHTML += `<tr><td style="padding:6px;">${s.material} ${s.thickness}T</td>
      <td style="text-align:right;">${(s.totalArea / 1000000).toFixed(2)} „é°</td>
      <td style="text-align:center;font-weight:bold;">${s.panelCount}Ïû•</td></tr>`;
        });
        summaryHTML += `</table></div>`;

        window._extractorData = {
          type: 'material',
          csv: materialExtractor.toCSV(result.materials),
          cnc: materialExtractor.toCNC(result.materials),
        };
        showExtractorModal('üì¶ ÏûêÏû¨ Ï∂îÏ∂ú Í≤∞Í≥º', tableHTML + summaryHTML);
      }

      // Î∂ÄÏûêÏû¨ Ï∂îÏ∂ú UI
      function showHardwareExtractor() {
        const result = window.DadamAgent.extractHardware();
        if (!result.hardware.length) {
          alert('Ï∂îÏ∂úÌï† Î∂ÄÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÑ§Í≥ÑÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
          return;
        }

        let tableHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead style="background:#e8f5e9;">
      <tr>
        <th style="border:1px solid #ddd;padding:8px;">No</th>
        <th style="border:1px solid #ddd;padding:8px;">Î∂ÑÎ•ò</th>
        <th style="border:1px solid #ddd;padding:8px;">ÌíàÎ™©</th>
        <th style="border:1px solid #ddd;padding:8px;">Ï†úÏ°∞ÏÇ¨</th>
        <th style="border:1px solid #ddd;padding:8px;">Ïä§Ìéô</th>
        <th style="border:1px solid #ddd;padding:8px;">ÏàòÎüâ</th>
        <th style="border:1px solid #ddd;padding:8px;">Îã®ÏúÑ</th>
        <th style="border:1px solid #ddd;padding:8px;">ÎπÑÍ≥†</th>
      </tr>
    </thead><tbody>`;

        result.hardware.forEach((h, i) => {
          tableHTML += `<tr>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${i + 1}</td>
      <td style="border:1px solid #ddd;padding:6px;">${h.category}</td>
      <td style="border:1px solid #ddd;padding:6px;">${h.item}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.manufacturer}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.spec}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;">${h.qty}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.unit}</td>
      <td style="border:1px solid #ddd;padding:6px;font-size:11px;">${h.note}</td>
    </tr>`;
        });
        tableHTML += `</tbody></table>`;

        // ÏöîÏïΩ
        let summaryHTML = `<div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
    <h4 style="margin:0 0 10px 0;">üî© Î∂ÄÏûêÏû¨ ÏöîÏïΩ</h4><div style="display:flex;gap:15px;flex-wrap:wrap;">`;
        Object.entries(result.summary).forEach(([cat, qty]) => {
          summaryHTML += `<div style="background:white;padding:10px 15px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
      <div style="font-size:11px;color:#666;">${cat}</div>
      <div style="font-size:18px;font-weight:bold;color:#1976d2;">${qty}</div></div>`;
        });
        summaryHTML += `</div></div>`;

        window._extractorData = { type: 'hardware', csv: hardwareExtractor.toCSV(result.hardware) };
        showExtractorModal('üî© Î∂ÄÏûêÏû¨ Ï∂îÏ∂ú Í≤∞Í≥º', tableHTML + summaryHTML);
      }

      // Ïû¨Îã® ÎèÑÎ©¥ UI
      function showDrawingVisualizer() {
        const result = window.DadamAgent.extractMaterials();
        if (!result.materials.length) {
          alert('ÏÉùÏÑ±Ìï† ÎèÑÎ©¥Ïù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÑ§Í≥ÑÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
          return;
        }

        const panels = drawingVisualizer.generateCuttingLayout(result.materials);
        const reportHTML = drawingVisualizer.generateReport(panels);

        window._extractorData = { type: 'drawing', panels };
        showExtractorModal('ü™µ Ïû¨Îã® ÎèÑÎ©¥', reportHTML);
      }

      // Îã§Ïö¥Î°úÎìú Ìï®Ïàò
      function downloadExtractorData() {
        if (!window._extractorData) return;

        const data = window._extractorData;
        let blob, filename;

        if (data.type === 'material') {
          blob = new Blob(['\uFEFF' + data.csv], { type: 'text/csv;charset=utf-8;' });
          filename = `ÏûêÏû¨Î™©Î°ù_${new Date().toISOString().slice(0, 10)}.csv`;
        } else if (data.type === 'hardware') {
          blob = new Blob(['\uFEFF' + data.csv], { type: 'text/csv;charset=utf-8;' });
          filename = `Î∂ÄÏûêÏû¨Î™©Î°ù_${new Date().toISOString().slice(0, 10)}.csv`;
        } else if (data.type === 'drawing') {
          const html = drawingVisualizer.generateReport(data.panels);
          blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
          filename = `Ïû¨Îã®ÎèÑÎ©¥_${new Date().toISOString().slice(0, 10)}.html`;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ============================================================
      // ÏÑ§Í≥Ñ Ï†ÄÏû• Ìï®Ïàò (JSON ÌååÏùº Îã§Ïö¥Î°úÎìú)
      // ============================================================
      function saveDesignToFile() {
        const design = window.DadamAgent.exportDesign();

        if (!design.items || design.items.length === 0) {
          alert('Ï†ÄÏû•Ìï† ÏÑ§Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }

        // ÌååÏùºÎ™Ö ÏÉùÏÑ± (Ï≤´Î≤àÏß∏ ÏïÑÏù¥ÌÖú Í∏∞Ï§Ä)
        const firstItem = design.items[0];
        const categoryName = firstItem.category || 'design';
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `Îã§Îã¥_${categoryName}_${firstItem.w}x${firstItem.h}_${dateStr}.json`;

        // JSON ÌååÏùº Îã§Ïö¥Î°úÎìú
        const jsonStr = JSON.stringify(design, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        alert(`ÏÑ§Í≥ÑÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.\nÌååÏùºÎ™Ö: ${filename}`);
      }

      // ============================================================
      // AI ÎîîÏûêÏù∏ ÏÉùÏÑ± ÏãúÏä§ÌÖú (ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò - Fast Generation)
      // ============================================================

      // Ïä§ÌÉÄÏùº Ï∂îÏ∂ú Ìó¨Ìçº Ìï®Ïàò
      function extractStyleFromSpecs(specs) {
        if (!specs) return 'modern minimal white';
        const styles = [];

        // ÎßàÍ∞êÏû¨ Ïä§ÌÉÄÏùº
        if (specs.doorFinishUpper === 'Î¨¥Í¥ë' || specs.doorFinishLower === 'Î¨¥Í¥ë') {
          styles.push('matte');
        } else if (specs.doorFinishUpper === 'Ïú†Í¥ë') {
          styles.push('glossy');
        }

        // ÏÉâÏÉÅ Ïä§ÌÉÄÏùº
        const colorMap = {
          'ÌôîÏù¥Ìä∏': 'white', 'Í∑∏Î†àÏù¥': 'gray', 'Î∏îÎûô': 'black',
          'ÏïÑÏù¥Î≥¥Î¶¨': 'ivory', 'Ïò§ÌÅ¨': 'oak', 'ÏõîÎÑõ': 'walnut'
        };
        if (specs.doorColorUpper && colorMap[specs.doorColorUpper]) {
          styles.push(colorMap[specs.doorColorUpper]);
        }

        // Ìï∏Îì§ Ïä§ÌÉÄÏùº
        if (specs.handle?.includes('Ìë∏Ïãú') || specs.handle?.includes('push')) {
          styles.push('handleless');
        }

        return `modern minimal korean ${styles.join(' ')}`.trim();
      }

      // Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïö© ÏÉÅÏÑ∏ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± (v3: texture_prompt ÌôúÏö©)
      function buildDesignPrompt(specs, cabinetSpecs) {
        const cat = FurnitureOptionCatalog;

        // v3: getTexturePromptÎ°ú ÏÉÅÏÑ∏ ÏßàÍ∞ê ÌîÑÎ°¨ÌîÑÌä∏ ÏÇ¨Ïö©
        const upperColor = cat.getTexturePrompt('door_color', cabinetSpecs.door_color_upper);
        const lowerColor = cat.getTexturePrompt('door_color', cabinetSpecs.door_color_lower);
        const upperFinish = cat.getTexturePrompt('door_finish', cabinetSpecs.door_finish_upper);
        const lowerFinish = cat.getTexturePrompt('door_finish', cabinetSpecs.door_finish_lower);
        const topDesc = cat.getTexturePrompt('countertop', cabinetSpecs.countertop_color);
        const handleDesc = cat.getTexturePrompt('handle', cabinetSpecs.handle_type);
        const hoodDesc = cat.getTexturePrompt('hood', cabinetSpecs.hood_type);
        const cooktopDesc = cat.getTexturePrompt('cooktop', cabinetSpecs.cooktop_type);
        const sinkDesc = cat.getTexturePrompt('sink', cabinetSpecs.sink_type);
        const faucetDesc = cat.getTexturePrompt('faucet', cabinetSpecs.faucet_type);

        const lines = [];
        lines.push(`Korean built-in kitchen cabinet, photorealistic interior photograph.`);
        lines.push(`Upper cabinet doors: ${upperColor}, ${upperFinish}.`);
        lines.push(`Lower cabinet doors: ${lowerColor}, ${lowerFinish}.`);
        lines.push(`Countertop: ${topDesc}.`);
        lines.push(`Hardware: ${handleDesc}.`);

        if (cabinetSpecs.hood_type) {
          lines.push(`Range hood: ${hoodDesc}.`);
        }
        if (cabinetSpecs.cooktop_type) {
          lines.push(`Cooktop: ${cooktopDesc}.`);
        }
        if (cabinetSpecs.sink_type) {
          lines.push(`Sink: ${sinkDesc}.`);
        }
        if (cabinetSpecs.faucet_type) {
          lines.push(`Faucet: ${faucetDesc}.`);
        }

        const negatives = [];
        negatives.push('NO exposed hood duct');
        negatives.push('NO hood ventilation pipe');
        negatives.push('NO external ductwork');
        negatives.push('NO visible exhaust pipe on wall or ceiling');
        negatives.push('NO silver/metallic duct tube');

        return {
          prompt: lines.join(' '),
          negative_prompt: negatives.join(', ')
        };
      }

      // Î™®Îìà ÏúÑÏπò Í≥ÑÏÇ∞ Ìó¨Ìçº Ìï®Ïàò
      function calculateModulePositions(modules, section) {
        let currentPos = 0;
        return modules
          .filter(m => m.pos === section)
          .map(m => {
            const moduleWithPos = {
              ...m,
              position_from_left_mm: currentPos,
              width_mm: parseInt(m.w) || 0,
              height_mm: parseInt(m.h) || 0,
              depth_mm: parseInt(m.d) || 0,
              is_drawer: m.isDrawer || false,
              door_count: m.doorCount || 1,
              has_sink: m.moduleType === 'sink' || m.name?.includes('Ïã±ÌÅ¨'),
              has_cooktop: m.moduleType === 'cooktop' || m.name?.includes('Ïø°ÌÉë') || m.name?.includes('Ïù∏ÎçïÏÖò'),
            };
            currentPos += parseInt(m.w) || 0;
            return moduleWithPos;
          });
      }

      // Ïù¥ÎØ∏ÏßÄ URLÏùÑ base64Î°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
      async function fetchImageAsBase64(imageUrl) {
        try {
          const response = await fetch(imageUrl);
          if (!response.ok) throw new Error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®');

          const blob = await response.blob();
          const mimeType = blob.type || 'image/jpeg';

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64 = reader.result.split(',')[1]; // data:image/...;base64, Ï†úÍ±∞
              resolve({ base64, type: mimeType });
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error('Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò Ïã§Ìå®:', error);
          return null;
        }
      }

      async function generateAIDesign() {
        // 1. ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
        const design = window.DadamAgent.exportDesign();

        if (!design.items || design.items.length === 0) {
          alert('AI ÎîîÏûêÏù∏ÏùÑ ÏÉùÏÑ±Ìï† ÏÑ§Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.\nÎ®ºÏ†Ä Ï∫êÎπÑÎÑ∑ÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        // 2. Î°úÎî© UI ÌëúÏãú
        showAIGeneratingModal();

        try {
          // 3. Ï≤´ Î≤àÏß∏ ÏïÑÏù¥ÌÖú Í∏∞Ï§ÄÏúºÎ°ú ÏÉÅÏÑ∏ ÏÇ¨Ïñë Ï∂îÏ∂ú
          const mainItem = design.items[0];
          const specs = mainItem.specs || {};
          const modules = mainItem.modules || [];

          // 4. Ïπ¥ÌÖåÍ≥†Î¶¨ Î∞è Ïä§ÌÉÄÏùº Í≤∞Ï†ï
          const category = mainItem.categoryId || mainItem.category || 'sink';
          const style = extractStyleFromSpecs(specs);

          // 5. ÏÉÅÏÑ∏ Ï∫êÎπÑÎÑ∑ ÏÇ¨Ïñë Íµ¨ÏÑ±
          const cabinetSpecs = {
            // Í∏∞Î≥∏ ÏπòÏàò
            total_width_mm: parseInt(mainItem.w) || 0,
            total_height_mm: parseInt(mainItem.h) || 0,
            depth_mm: parseInt(mainItem.d) || 0,

            // ÎÜíÏù¥ ÏÑ∏Î∂Ä ÏÇ¨Ìï≠
            upper_cabinet_height: specs.upperH || 720,
            lower_cabinet_height: specs.lowerH || 870,
            molding_height: specs.moldingH || 60,
            leg_height: specs.sinkLegHeight || specs.legH || 150,
            countertop_thickness: specs.topThickness || 20,

            // ÏÉâÏÉÅ Î∞è ÎßàÍ∞ê
            door_color_upper: specs.doorColorUpper || 'ÌôîÏù¥Ìä∏',
            door_color_lower: specs.doorColorLower || 'ÌôîÏù¥Ìä∏',
            door_finish_upper: specs.doorFinishUpper || 'Î¨¥Í¥ë',
            door_finish_lower: specs.doorFinishLower || 'Î¨¥Í¥ë',
            countertop_color: specs.topColor || 'Ïä§ÎÖ∏Ïö∞',

            // ÌïòÎìúÏõ®Ïñ¥
            handle_type: specs.handle || 'push-open',

            // Í∞ÄÏ†Ñ (Ïã±ÌÅ¨ÎåÄ/ÏïÑÏùºÎûúÎìú)
            sink_type: specs.sink || null,
            faucet_type: specs.faucet || null,
            hood_type: specs.hood || null,
            cooktop_type: specs.cooktop || null,

            // ÎßàÍ∞ê (Ï¢åÏö∞)
            finish_left_type: specs.finishLeftType || 'Molding',
            finish_left_width: specs.finishLeftWidth || 60,
            finish_right_type: specs.finishRightType || 'Molding',
            finish_right_width: specs.finishRightWidth || 60,
          };

          // 6. Î™®Îìà Î†àÏù¥ÏïÑÏõÉ Íµ¨ÏÑ±
          const upperModules = calculateModulePositions(modules, 'upper');
          const lowerModules = calculateModulePositions(modules, 'lower');

          // Ïã±ÌÅ¨ÎåÄ/Ïø°ÌÉë ÏúÑÏπò Ï∞æÍ∏∞
          const sinkModule = lowerModules.find(m => m.has_sink);
          const cooktopModule = lowerModules.find(m => m.has_cooktop);

          if (sinkModule) {
            cabinetSpecs.sink_position_mm = sinkModule.position_from_left_mm;
          }
          if (cooktopModule) {
            cabinetSpecs.cooktop_position_mm = cooktopModule.position_from_left_mm;
          }

          // 6-2. Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ URL + prompt_description ÏàòÏßë
          const referenceImages = {};
          const materialDescriptions = {};
          const optMappings = [
            { spec: 'doorColorUpper', cat: 'door_color', descKey: 'upper_door_color' },
            { spec: 'doorColorLower', cat: 'door_color', descKey: 'lower_door_color' },
            { spec: 'doorFinishUpper', cat: 'door_finish', descKey: 'upper_door_finish' },
            { spec: 'doorFinishLower', cat: 'door_finish', descKey: 'lower_door_finish' },
            { spec: 'handle', cat: 'handle', descKey: 'handle' },
            { spec: 'topColor', cat: 'countertop', descKey: 'countertop' },
            { spec: 'hood', cat: 'hood', descKey: 'hood' },
            { spec: 'cooktop', cat: 'cooktop', descKey: 'cooktop' },
            { spec: 'sink', cat: 'sink', descKey: 'sink' },
            { spec: 'faucet', cat: 'faucet', descKey: 'faucet' },
          ];
          for (const m of optMappings) {
            const val = specs[m.spec];
            if (val) {
              const url = FurnitureOptionCatalog.getImageUrl(m.cat, val);
              const desc = FurnitureOptionCatalog.getPromptDescription(m.cat, val);
              const texPrompt = FurnitureOptionCatalog.getTexturePrompt(m.cat, val);
              if (url) referenceImages[m.spec] = { url, prompt_description: desc };
              materialDescriptions[m.descKey] = texPrompt;
            }
          }

          // 6-3. LayoutRendererÎ°ú ÏàòÏπò Í∏∞Î∞ò Î†àÏù¥ÏïÑÏõÉ Î∏îÎ£®ÌîÑÎ¶∞Ìä∏ ÏÉùÏÑ±
          //   - ÌÖçÏä§Ï≤ò Î†åÎçîÎßÅ (async) + ÎßàÏä§ÌÅ¨ ÏÉùÏÑ± (AI Ïù∏ÌéòÏù∏ÌåÖÏö©)
          let layoutImageBase64 = null;
          let layoutData = null;
          let maskImageBase64 = null;
          try {
            // ÌÖçÏä§Ï≤ò Ìè¨Ìï® Î†åÎçîÎßÅ ÏãúÎèÑ (Ïã§Ìå® Ïãú ÎèôÍ∏∞ Ìè¥Î∞±)
            try {
              layoutImageBase64 = await LayoutRenderer.renderWithTextures(cabinetSpecs, upperModules, lowerModules, specs);
              console.log('[LayoutRenderer] ÌÖçÏä§Ï≤ò Î†åÎçîÎßÅ ÏôÑÎ£å');
            } catch (texErr) {
              console.warn('[LayoutRenderer] ÌÖçÏä§Ï≤ò Î†åÎçîÎßÅ Ïã§Ìå®, Í∏∞Î≥∏ Î†åÎçîÎßÅ ÏÇ¨Ïö©:', texErr.message);
              layoutImageBase64 = LayoutRenderer.render(cabinetSpecs, upperModules, lowerModules, specs);
            }
            layoutData = LayoutRenderer.getLayoutData(cabinetSpecs, upperModules, lowerModules);

            // ÎßàÏä§ÌÅ¨ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (Í∞ÄÍµ¨ ÌëúÎ©¥=Ìù∞ÏÉâ, ÎÇòÎ®∏ÏßÄ=Í≤ÄÏ†ï ‚Üí AI Ïù∏ÌéòÏù∏ÌåÖÏö©)
            maskImageBase64 = LayoutRenderer.renderMask(cabinetSpecs, upperModules, lowerModules, specs);

            console.log('[LayoutRenderer] Î∏îÎ£®ÌîÑÎ¶∞Ìä∏ + ÎßàÏä§ÌÅ¨ ÏÉùÏÑ± ÏôÑÎ£å:', {
              canvasSize: Math.round(1024 / layoutData.aspectRatio) + 'x1024',
              upperModules: layoutData.upper.modules.length,
              lowerModules: layoutData.lower.modules.length,
              hasMask: !!maskImageBase64,
            });
          } catch (e) {
            console.warn('[LayoutRenderer] Î∏îÎ£®ÌîÑÎ¶∞Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:', e.message);
          }

          // 7. ÌòÑÏû• ÏÇ¨ÏßÑ ÌôïÏù∏ Î∞è Î≥ÄÌôò
          let roomImageData = null;
          const sitePhotoUrl = mainItem.imageUrl || mainItem.image;

          if (sitePhotoUrl && sitePhotoUrl !== 'loading') {
            console.log('ÌòÑÏû• ÏÇ¨ÏßÑ Î∞úÍ≤¨:', sitePhotoUrl);
            roomImageData = await fetchImageAsBase64(sitePhotoUrl);
            if (roomImageData) {
              console.log('ÌòÑÏû• ÏÇ¨ÏßÑ Î≥ÄÌôò ÏÑ±Í≥µ:', roomImageData.type);
            }
          }

          // 8. ÏóîÎìúÌè¨Ïù∏Ìä∏ Í≤∞Ï†ï (Ïù¥ÎØ∏ÏßÄ Ïú†Î¨¥Ïóê Îî∞Îùº)
          // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Î©îÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ (Wall Analysis Ìè¨Ìï®), ÏóÜÏúºÎ©¥ design-to-image
          const apiEndpoint = roomImageData
            ? 'https://dadam.app.n8n.cloud/webhook/dadam-interior-v4'  // Î©îÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ (Wall Analysis)
            : N8N_AI_DESIGN_URL;  // design-to-image ÏõåÌÅ¨ÌîåÎ°úÏö∞

          // 8-1. ÏÉÅÏÑ∏ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±
          const designPrompt = buildDesignPrompt(specs, cabinetSpecs);

          console.log('AI ÎîîÏûêÏù∏ ÏÉùÏÑ± ÏöîÏ≤≠:', {
            category,
            style,
            prompt: designPrompt.prompt,
            negative_prompt: designPrompt.negative_prompt,
            cabinetSpecs,
            upperModules: upperModules.length,
            lowerModules: lowerModules.length,
            hasRoomImage: !!roomImageData,
            hasLayoutImage: !!layoutImageBase64,
            hasMaskImage: !!maskImageBase64,
            layoutData: layoutData,
            endpoint: apiEndpoint
          });

          // 9. n8n ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ìò∏Ï∂ú (Í∞ïÌôîÎêú ÌéòÏù¥Î°úÎìú)
          const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              // ÌòÑÏû• ÏÇ¨ÏßÑ (ÏûàÎäî Í≤ΩÏö∞)
              room_image: roomImageData?.base64 || '',
              image_type: roomImageData?.type || 'image/jpeg',

              // Í∏∞Î≥∏ Ï†ïÎ≥¥
              category: category,
              style: style,
              design_style: style,

              // ÏÉÅÏÑ∏ ÎîîÏûêÏù∏ ÌîÑÎ°¨ÌîÑÌä∏
              prompt: designPrompt.prompt,
              negative_prompt: designPrompt.negative_prompt,

              // ÏÉÅÏÑ∏ Ï∫êÎπÑÎÑ∑ ÏÇ¨Ïñë
              cabinet_specs: cabinetSpecs,

              // Î†àÌçºÎü∞Ïä§ Ïù¥ÎØ∏ÏßÄ + ÏûêÏû¨ ÏÑ§Î™Ö
              reference_images: referenceImages,
              material_descriptions: materialDescriptions,

              // ÏàòÏπò Í∏∞Î∞ò Î†àÏù¥ÏïÑÏõÉ Î∏îÎ£®ÌîÑÎ¶∞Ìä∏ (Canvas Î†åÎçîÎßÅ + ÌÖçÏä§Ï≤ò)
              layout_image: layoutImageBase64 || '',
              layout_data: layoutData || {},

              // AI Ïù∏ÌéòÏù∏ÌåÖÏö© ÎßàÏä§ÌÅ¨ (Í∞ÄÍµ¨ ÌëúÎ©¥=Ìù∞ÏÉâ, ÎÇòÎ®∏ÏßÄ=Í≤ÄÏ†ï)
              mask_image: maskImageBase64 || '',

              // Î™®Îìà Î†àÏù¥ÏïÑÏõÉ
              modules: {
                upper: upperModules,
                lower: lowerModules,
                upper_count: upperModules.length,
                lower_count: lowerModules.length,
              },

              // Î†àÍ±∞Ïãú Ìò∏Ìôò (Í∏∞Ï°¥ Parse Design Data ÎÖ∏Îìú)
              design_data: design,
              items: design.items.map((item) => ({
                categoryId: item.categoryId || item.category,
                category: item.categoryId || item.category,
                name: item.name,
                w: parseInt(item.w) || 0,
                h: parseInt(item.h) || 0,
                d: parseInt(item.d) || 0,
                specs: item.specs,
                modules: item.modules,
              })),
            }),
          });

          if (!response.ok) throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: HTTP ${response.status}`);

          // ÏùëÎãµ ÌÖçÏä§Ìä∏ Î®ºÏ†Ä ÌôïÏù∏
          const responseText = await response.text();
          if (!responseText || responseText.trim() === '') {
            throw new Error('AI ÏÑúÎ≤ÑÏóêÏÑú Îπà ÏùëÎãµÏùÑ Î∞õÏïòÏäµÎãàÎã§.\nn8n ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
          }

          // JSON ÌååÏã± ÏãúÎèÑ
          let data;
          try {
            data = JSON.parse(responseText);
            if (Array.isArray(data)) data = data[0];
          } catch (parseError) {
            console.error('JSON ÌååÏã± Ïã§Ìå®:', responseText);
            throw new Error('AI ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\nÏùëÎãµ: ' + responseText.substring(0, 100));
          }

          // 4. Í≤∞Í≥º ÌôïÏù∏ Î∞è ÌëúÏãú
          if (data.success === false) {
            throw new Error(data.error || data.message || 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
          }

          showAIDesignResult(data);
        } catch (error) {
          console.error('AI ÎîîÏûêÏù∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
          alert('AI ÎîîÏûêÏù∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n' + error.message);
        } finally {
          hideAIGeneratingModal();
        }
      }

      // AI ÏÉùÏÑ± Î°úÎî© Î™®Îã¨ ÌëúÏãú
      function showAIGeneratingModal() {
        // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
        const existing = document.getElementById('aiGeneratingModal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'aiGeneratingModal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
    <div style="background:#fff;border-radius:20px;padding:40px 60px;text-align:center;max-width:400px;">
      <div style="width:60px;height:60px;margin:0 auto 20px;border:4px solid #EBE8E2;border-top-color:#6366F1;border-radius:50%;animation:spin 1s linear infinite;"></div>
      <h3 style="font-size:18px;margin:0 0 12px;color:#2D2A26;">üé® AI ÎîîÏûêÏù∏ ÏÉùÏÑ± Ï§ë...</h3>
      <p style="color:#8B8680;margin:0;font-size:14px;">ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§</p>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // AI ÏÉùÏÑ± Î°úÎî© Î™®Îã¨ Ïà®Í∏∞Í∏∞
      function hideAIGeneratingModal() {
        const modal = document.getElementById('aiGeneratingModal');
        if (modal) modal.remove();
      }

      // AI ÎîîÏûêÏù∏ Í≤∞Í≥º ÌëúÏãú
      function showAIDesignResult(data) {
        // Í∏∞Ï°¥ Î™®Îã¨ Ï†úÍ±∞
        const existing = document.querySelector('.ai-design-result-modal');
        if (existing) existing.remove();

        // Ïù¥ÎØ∏ÏßÄ URL Ï∂îÏ∂ú
        let closedImageUrl = '';
        let openImageUrl = '';

        if (data.generated_image) {
          // Îã´Ìûå ÎèÑÏñ¥ Ïù¥ÎØ∏ÏßÄ
          if (data.generated_image.closed && data.generated_image.closed.base64) {
            const mimeType = data.generated_image.closed.mime_type || 'image/png';
            closedImageUrl = `data:${mimeType};base64,${data.generated_image.closed.base64}`;
          } else if (data.generated_image.base64) {
            const mimeType = data.generated_image.mime_type || 'image/png';
            closedImageUrl = `data:${mimeType};base64,${data.generated_image.base64}`;
          }
          // Ïó¥Î¶∞ ÎèÑÏñ¥ Ïù¥ÎØ∏ÏßÄ
          if (data.generated_image.open && data.generated_image.open.base64) {
            const mimeType = data.generated_image.open.mime_type || 'image/png';
            openImageUrl = `data:${mimeType};base64,${data.generated_image.open.base64}`;
          }
        } else if (data.image_url) {
          closedImageUrl = data.image_url;
        }

        const hasOpenImage = !!openImageUrl;

        const modal = document.createElement('div');
        modal.className = 'ai-design-result-modal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
    <div style="background:#fff;border-radius:20px;max-width:900px;width:95%;max-height:95vh;overflow:hidden;display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #EBE8E2;">
        <h3 style="margin:0;font-size:18px;color:#2D2A26;">üé® AI ÎîîÏûêÏù∏ Í≤∞Í≥º</h3>
        <button onclick="this.closest('.ai-design-result-modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#8B8680;line-height:1;">&times;</button>
      </div>
      <div style="padding:24px;overflow-y:auto;flex:1;">
        ${closedImageUrl ? `
        <!-- Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥ -->
        <div style="position:relative;margin-bottom:16px;">
          <!-- ÏÉÅÌÉú ÌëúÏãú -->
          <div style="display:flex;justify-content:center;gap:8px;margin-bottom:12px;">
            <span id="aiResultStatus" style="background:#6366F1;color:#fff;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:500;">
              üö™ Îã´Ìûå ÎèÑÏñ¥
            </span>
          </div>

          <!-- Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà -->
          <div style="position:relative;display:flex;align-items:center;justify-content:center;">
            ${hasOpenImage ? `<button onclick="aiResultPrevImage()" style="position:absolute;left:8px;z-index:10;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.9);border:none;font-size:18px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);">‚óÄ</button>` : ''}
            <img id="aiResultImage"
                 src="${closedImageUrl}"
                 data-closed="${closedImageUrl}"
                 data-open="${openImageUrl}"
                 data-state="closed"
                 style="width:100%;max-height:60vh;object-fit:contain;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
            ${hasOpenImage ? `<button onclick="aiResultNextImage()" style="position:absolute;right:8px;z-index:10;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.9);border:none;font-size:18px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);">‚ñ∂</button>` : ''}
          </div>

          ${hasOpenImage ? `
          <!-- Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
          <div style="display:flex;justify-content:center;gap:8px;margin-top:12px;">
            <div id="aiDot0" onclick="aiResultGoToImage(0)" style="width:10px;height:10px;border-radius:50%;background:#6366F1;cursor:pointer;transition:all 0.2s;"></div>
            <div id="aiDot1" onclick="aiResultGoToImage(1)" style="width:10px;height:10px;border-radius:50%;background:#D1D5DB;cursor:pointer;transition:all 0.2s;"></div>
          </div>
          <div style="text-align:center;margin-top:8px;font-size:12px;color:#8B8680;">
            ‚óÄ ‚ñ∂ ÌôîÏÇ¥ÌëúÎ°ú Îã´Ìûå ÎèÑÏñ¥ / Ïó¥Î¶∞ ÎèÑÏñ¥ Ï†ÑÌôò
          </div>
          ` : ''}
        </div>
        ` : ''}

        <div style="background:#F8F7F4;padding:16px;border-radius:12px;color:#2D2A26;line-height:1.7;">
          ${data.analysis || data.message || data.output || 'ÎîîÏûêÏù∏Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.'}
          ${data.rag_rules_count ? `<br><small style="color:#8B8680;">RAG Í∑úÏπô ${data.rag_rules_count}Í∞ú Ï†ÅÏö©</small>` : ''}
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid #EBE8E2;">
        ${closedImageUrl ? `
          <button onclick="downloadAIDesignImage('closed')" style="padding:12px 24px;background:#6366F1;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">üíæ Îã´Ìûå ÎèÑÏñ¥ Ï†ÄÏû•</button>
          ${hasOpenImage ? `<button onclick="downloadAIDesignImage('open')" style="padding:12px 24px;background:#10B981;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">üíæ Ïó¥Î¶∞ ÎèÑÏñ¥ Ï†ÄÏû•</button>` : ''}
        ` : ''}
        <button onclick="proceedToBOM()" style="padding:12px 24px;background:linear-gradient(135deg,#6366F1,#4F46E5);color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;font-weight:bold;">üìã BOM ÏÇ∞Ï∂úÌïòÍ∏∞ ‚Üí</button>
        <button onclick="this.closest('.ai-design-result-modal').remove()" style="padding:12px 24px;background:#EBE8E2;color:#2D2A26;border:none;border-radius:10px;font-size:14px;cursor:pointer;">Îã´Í∏∞</button>
      </div>
    </div>
  `;

        // Í≤∞Í≥º Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Îã§Ïö¥Î°úÎìúÏö©)
        window._aiDesignResult = data;
        window._aiDesignImages = { closed: closedImageUrl, open: openImageUrl };

        document.body.appendChild(modal);

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞ - ÎπÑÌôúÏÑ±Ìôî (Ïù¥ÎØ∏ÏßÄ ÌôïÏù∏ Ï§ë Ïã§ÏàòÎ°ú Îã´ÌûàÎäî Í≤É Î∞©ÏßÄ)
        // modal.addEventListener('click', (e) => {
        //   if (e.target === modal) modal.remove();
        // });
      }

      // AI Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
      function aiResultGoToImage(index) {
        const img = document.getElementById('aiResultImage');
        const status = document.getElementById('aiResultStatus');
        if (!img) return;

        const closedUrl = img.dataset.closed;
        const openUrl = img.dataset.open;

        if (index === 0) {
          img.src = closedUrl;
          img.dataset.state = 'closed';
          status.innerHTML = 'üö™ Îã´Ìûå ÎèÑÏñ¥';
          status.style.background = '#6366F1';
        } else if (index === 1 && openUrl) {
          img.src = openUrl;
          img.dataset.state = 'open';
          status.innerHTML = 'üö™ Ïó¥Î¶∞ ÎèÑÏñ¥';
          status.style.background = '#10B981';
        }

        // Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('aiDot0').style.background = index === 0 ? '#6366F1' : '#D1D5DB';
        document.getElementById('aiDot1').style.background = index === 1 ? '#10B981' : '#D1D5DB';
      }

      function aiResultNextImage() {
        const img = document.getElementById('aiResultImage');
        if (!img) return;
        const currentState = img.dataset.state;
        aiResultGoToImage(currentState === 'closed' ? 1 : 0);
      }

      function aiResultPrevImage() {
        const img = document.getElementById('aiResultImage');
        if (!img) return;
        const currentState = img.dataset.state;
        aiResultGoToImage(currentState === 'closed' ? 1 : 0);
      }

      // AI ÎîîÏûêÏù∏ Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
      function downloadAIDesignImage(type = 'closed') {
        const images = window._aiDesignImages;
        if (!images) return;

        const imageUrl = type === 'open' ? images.open : images.closed;
        if (!imageUrl) return;

        const suffix = type === 'open' ? '-open' : '-closed';
        const a = document.createElement('a');
        a.href = imageUrl;
        a.download = `ai-design${suffix}-${new Date().toISOString().slice(0, 10)}.png`;
        a.click();
      }

      // ============================================================
      // ÏÑ§Í≥Ñ ÏôÑÎ£å Î≥¥Í≥†ÏÑú (ÌÜµÌï© ÏûêÏû¨ Ï∂îÏ∂ú ÏãúÏä§ÌÖú V2)
      // Ïû¨Îã® Ï∂îÏ∂ú Í∏∞Îä• ÏûÑÏãú ÎπÑÌôúÏÑ±Ìôî - AI ÎîîÏûêÏù∏ ÏÉùÏÑ±ÏúºÎ°ú ÎåÄÏ≤¥
      // ============================================================
      function showDesignCompleteReport() {
        proceedToBOM();

        /* ===== Ïû¨Îã® Ï∂îÏ∂ú Í∏∞Îä• ÏûÑÏãú ÎπÑÌôúÏÑ±Ìôî =====
  const design = window.DadamAgent.exportDesign();
  console.log('===== ÏÑ§Í≥Ñ ÏôÑÎ£å Î≥¥Í≥†ÏÑú ÏÉùÏÑ± =====');
  console.log('ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞:', design);
  console.log('ÏïÑÏù¥ÌÖú Ïàò:', design.items?.length);

  if (design.items && design.items.length > 0) {
    design.items.forEach((item, idx) => {
      console.log(`ÏïÑÏù¥ÌÖú[${idx}]:`, item.category, 'W=', item.w, 'H=', item.h);
      console.log(`  modules (${item.modules?.length || 0}Í∞ú):`, item.modules);
    });
  }

  if (!design.items || design.items.length === 0) {
    alert('ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÑ§Í≥ÑÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî.');
    return;
  }

  // ÏûêÏû¨ Ï∂îÏ∂ú
  console.log('ÏûêÏû¨ Ï∂îÏ∂ú ÏãúÏûë...');
  const matResult = materialExtractor.extract(design);
  console.log('ÏûêÏû¨ Ï∂îÏ∂ú Í≤∞Í≥º:', matResult);
  console.log('Ï∂îÏ∂úÎêú ÏûêÏû¨ Ïàò:', matResult.materials?.length);

  // Î™®ÎìàÏù¥ ÏóÜÏñ¥ÎèÑ Î≥¥Í≥†ÏÑúÎäî Î≥¥Ïó¨Ï§å
  if (!matResult.materials.length) {
    console.warn('‚ö†Ô∏è Ï∂îÏ∂úÎêú ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§!');
    console.warn('Ï≤´ Î≤àÏß∏ ÏïÑÏù¥ÌÖú Î™®Îìà:', design.items[0]?.modules);
  }

  // Î∂ÄÏûêÏû¨ Ï∂îÏ∂ú
  const hwResult = hardwareExtractor.extract(design);

  // ÌÉ≠ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
  const tabContent = generateReportTabs(matResult, hwResult, design);

  // Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Îã§Ïö¥Î°úÎìúÏö©)
  window._reportData = {
    design,
    materials: matResult,
    hardware: hwResult,
    csvMaterial: materialExtractor.toCSV(matResult.materials),
    cncMaterial: materialExtractor.toCNC(matResult.materials),
    csvHardware: hardwareExtractor.toCSV(hwResult.hardware)
  };

  showReportModal(tabContent);
  ===== Ïû¨Îã® Ï∂îÏ∂ú Í∏∞Îä• ÏûÑÏãú ÎπÑÌôúÏÑ±Ìôî ===== */
      }

      // Î≥¥Í≥†ÏÑú ÌÉ≠ ÏÉùÏÑ±
      function generateReportTabs(matResult, hwResult, design) {
        const firstItem = design.items[0];
        const projectName = `${firstItem.name || firstItem.category} ${firstItem.w}√ó${firstItem.h}`;

        // 1. ÏöîÏïΩ ÌÉ≠
        const summaryTab = generateSummaryTab(matResult, hwResult, design);

        // 2. Î≥∏Ï≤¥ ÏûêÏû¨ ÌÉ≠
        const bodyTab = generateBodyMaterialTab(matResult.materials);

        // 3. ÎèÑÏñ¥ ÏûêÏû¨ ÌÉ≠
        const doorTab = generateDoorMaterialTab(matResult.materials);

        // 4. EP ÏûêÏû¨ ÌÉ≠
        const epTab = generateEPMaterialTab(matResult.materials);

        // 5. Î∂ÄÏûêÏû¨ ÌÉ≠
        const hardwareTab = generateHardwareTab(hwResult);

        return `
    <div style="margin-bottom:15px;">
      <div style="font-size:20px;font-weight:bold;color:#1976d2;margin-bottom:5px;">üìã ÏÑ§Í≥Ñ ÏôÑÎ£å Î≥¥Í≥†ÏÑú</div>
      <div style="font-size:13px;color:#666;">ÌîÑÎ°úÏ†ùÌä∏: ${projectName} | Ï∂îÏ∂úÏùºÏãú: ${new Date().toLocaleString('ko-KR')}</div>
    </div>
    <div class="report-tabs" style="display:flex;border-bottom:2px solid #1976d2;margin-bottom:15px;">
      <button class="report-tab active" onclick="switchReportTab(this, 'summary')" style="padding:10px 20px;border:none;background:#1976d2;color:white;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;">üìä ÏöîÏïΩ</button>
      <button class="report-tab" onclick="switchReportTab(this, 'body')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">ü™µ Î≥∏Ï≤¥</button>
      <button class="report-tab" onclick="switchReportTab(this, 'door')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">üö™ ÎèÑÏñ¥</button>
      <button class="report-tab" onclick="switchReportTab(this, 'ep')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">üìê EP</button>
      <button class="report-tab" onclick="switchReportTab(this, 'hardware')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">üî© Î∂ÄÏûêÏû¨</button>
    </div>
    <div id="report-content-summary" class="report-content">${summaryTab}</div>
    <div id="report-content-body" class="report-content" style="display:none;">${bodyTab}</div>
    <div id="report-content-door" class="report-content" style="display:none;">${doorTab}</div>
    <div id="report-content-ep" class="report-content" style="display:none;">${epTab}</div>
    <div id="report-content-hardware" class="report-content" style="display:none;">${hardwareTab}</div>
  `;
      }

      // ÌÉ≠ Ï†ÑÌôò
      function switchReportTab(btn, tabId) {
        // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        document.querySelectorAll('.report-tab').forEach((t) => {
          t.style.background = '#e3f2fd';
          t.style.color = '#1976d2';
          t.classList.remove('active');
        });
        // ÌÅ¥Î¶≠Îêú ÌÉ≠ ÌôúÏÑ±Ìôî
        btn.style.background = '#1976d2';
        btn.style.color = 'white';
        btn.classList.add('active');

        // Î™®Îì† ÏΩòÌÖêÏ∏† Ïà®ÍπÄ
        document.querySelectorAll('.report-content').forEach((c) => (c.style.display = 'none'));
        // ÏÑ†ÌÉùÎêú ÏΩòÌÖêÏ∏† ÌëúÏãú
        document.getElementById('report-content-' + tabId).style.display = 'block';
      }

      // ÏöîÏïΩ ÌÉ≠ ÏÉùÏÑ±
      function generateSummaryTab(matResult, hwResult, design) {
        const summary = matResult.summary;
        const item = design.items[0];
        // ‚òÖ categoryId ÏÇ¨Ïö©
        const category = item.categoryId || item.category;

        // Ìå®ÎÑê ÏÇ¨Ïö©Îüâ Ïπ¥Îìú
        let panelCards = '';
        if (Object.keys(summary).length === 0) {
          panelCards = '<div style="color:#999;font-size:13px;">ÏûêÏû¨ Ï†ïÎ≥¥ ÏóÜÏùå</div>';
        } else {
          Object.values(summary).forEach((s) => {
            const area = (s.totalArea / 1000000).toFixed(2);
            const efficiency = ((s.totalArea / (s.panelCount * 1220 * 2440)) * 100).toFixed(1);
            panelCards += `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:15px;border-radius:10px;min-width:150px;">
          <div style="font-size:12px;opacity:0.9;">${s.material} ${s.thickness}T</div>
          <div style="font-size:28px;font-weight:bold;margin:5px 0;">${s.panelCount}Ïû•</div>
          <div style="font-size:11px;opacity:0.8;">${area}„é° (Ìö®Ïú® ${efficiency}%)</div>
        </div>
      `;
          });
        }

        // Î∂ÄÏûêÏû¨ ÏöîÏïΩ
        let hwSummary = '';
        Object.entries(hwResult.summary || {}).forEach(([cat, qty]) => {
          hwSummary += `<span style="background:#fff3e0;color:#e65100;padding:4px 10px;border-radius:15px;font-size:12px;margin-right:5px;">${cat}: ${qty}</span>`;
        });

        // Î™®Îìà Ïàò Í≥ÑÏÇ∞ (Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ)
        let moduleInfo = '';
        if (category === 'sink') {
          const upperCount = (item.modules || []).filter((m) => m.pos === 'upper').length;
          const lowerCount = (item.modules || []).filter((m) => m.pos === 'lower').length;
          moduleInfo = `
      <div><span style="color:#666;">ÏÉÅÎ∂ÄÏû• Ïàò:</span> <strong>${upperCount}Í∞ú</strong></div>
      <div><span style="color:#666;">ÌïòÎ∂ÄÏû• Ïàò:</span> <strong>${lowerCount}Í∞ú</strong></div>
    `;
        } else if (category === 'wardrobe') {
          const wardrobeCount = (item.modules || []).filter(
            (m) => m.pos === 'wardrobe' || m.type === 'wardrobe'
          ).length;
          const shortCount = (item.modules || []).filter((m) => m.moduleType === 'short').length;
          const longCount = (item.modules || []).filter((m) => m.moduleType === 'long').length;
          const shelfCount = (item.modules || []).filter((m) => m.moduleType === 'shelf').length;
          moduleInfo = `
      <div><span style="color:#666;">Ï¥ù Î™®Îìà Ïàò:</span> <strong>${wardrobeCount}Í∞ú</strong></div>
      <div><span style="color:#666;">ÏßßÏùÄÏò∑/Í∏¥Ïò∑/ÏÑ†Î∞ò:</span> <strong>${shortCount}/${longCount}/${shelfCount}</strong></div>
    `;
        } else if (category === 'fridge') {
          const moduleCount = (item.modules || []).filter((m) => m.type !== 'fridge').length;
          moduleInfo = `
      <div><span style="color:#666;">Î™®Îìà Ïàò:</span> <strong>${moduleCount}Í∞ú</strong></div>
      <div><span style="color:#666;">ÎÉâÏû•Í≥† ÌÉÄÏûÖ:</span> <strong>${item.specs?.fridgeModel || '-'}</strong></div>
    `;
        }

        const totalParts = matResult.materials.length;

        return `
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;">
      <div style="background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid #e0e0e0;">
        <h4 style="margin:0 0 15px 0;color:#333;display:flex;align-items:center;gap:8px;">üì¶ Ìå®ÎÑê ÏÇ¨Ïö©Îüâ</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">${panelCards}</div>
      </div>
      
      <div style="background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid #e0e0e0;">
        <h4 style="margin:0 0 15px 0;color:#333;display:flex;align-items:center;gap:8px;">üìê ÏÑ§Í≥Ñ Ï†ïÎ≥¥</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;">
          <div><span style="color:#666;">Í∞ÄÍµ¨ Ïú†Ìòï:</span> <strong>${item.name || item.category}</strong></div>
          <div><span style="color:#666;">Ï†ÑÏ≤¥ ÌÅ¨Í∏∞:</span> <strong>${item.w} √ó ${item.h} √ó ${item.d}</strong></div>
          ${moduleInfo}
          <div><span style="color:#666;">Ï¥ù Î∂ÄÌíà Ïàò:</span> <strong>${totalParts}Í∞ú</strong></div>
          <div><span style="color:#666;">Î∂ÄÏûêÏû¨ ÌíàÎ™©:</span> <strong>${hwResult.hardware?.length || 0}Í∞ú</strong></div>
        </div>
      </div>
    </div>
    
    <div style="margin-top:20px;background:#e8f5e9;padding:15px;border-radius:10px;border:1px solid #c8e6c9;">
      <h4 style="margin:0 0 10px 0;color:#2e7d32;">üî© Î∂ÄÏûêÏû¨ ÏöîÏïΩ</h4>
      <div>${hwSummary || '<span style="color:#666;">Î∂ÄÏûêÏû¨ Ï†ïÎ≥¥ ÏóÜÏùå</span>'}</div>
    </div>
    
    <div style="margin-top:20px;background:#fff8e1;padding:15px;border-radius:10px;border:1px solid #ffe082;">
      <h4 style="margin:0 0 10px 0;color:#f57c00;">üí° Ï∞∏Í≥†ÏÇ¨Ìï≠</h4>
      <ul style="margin:0;padding-left:20px;font-size:12px;color:#666;">
        <li>Ìå®ÎÑê Í∑úÍ≤©: 1220 √ó 2440 mm (4√ó8 Ìï©Ìåê Í∏∞Ï§Ä)</li>
        <li>Î≥∏Ï≤¥ ÏûêÏû¨: PB (ÌååÌã∞ÌÅ¥Î≥¥Îìú) 18T Í∏∞Ï§Ä</li>
        <li>ÎèÑÏñ¥ ÏûêÏû¨: MDF 18T Í∏∞Ï§Ä</li>
        <li>Îí∑Ìåê ÏûêÏû¨: MDF 2.7T Í∏∞Ï§Ä (ÌôàÏπ¥Ìéò/Ïò§ÌîàÏû•ÏùÄ 18T)</li>
      </ul>
    </div>
  `;
      }

      // Î≥∏Ï≤¥ ÏûêÏû¨ ÌÉ≠
      function generateBodyMaterialTab(materials) {
        const bodyParts = materials.filter(
          (m) => !['ÎèÑÏñ¥', 'Í±∏Î†àÎ∞õÏù¥', 'Ìú†Îùº', 'Î™©Ï∞¨ÎÑ¨', 'ÏÉÅÎ™∞Îî©'].some((p) => m.part.includes(p))
        );

        if (bodyParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">Î≥∏Ï≤¥ ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#e3f2fd;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">Î™®Îìà</th>
          <th style="border:1px solid #ddd;padding:10px;">Î∂ÄÌíà</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏûêÏû¨</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÎëêÍªò</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">Í∞ÄÎ°ú</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ÏÑ∏Î°ú</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏàòÎüâ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">Ïó£ÏßÄ</th>
          <th style="border:1px solid #ddd;padding:10px;">ÎπÑÍ≥†</th>
        </tr>
      </thead>
      <tbody>`;

        bodyParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#f9f9f9'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#1976d2;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-size:11px;">${m.edge}</td>
        <td style="border:1px solid #ddd;padding:8px;font-size:11px;color:#666;">${m.note || ''}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:14px;font-weight:bold;color:#333;">ü™µ Î≥∏Ï≤¥ ÏûêÏû¨ Î™©Î°ù (${bodyParts.length}Í∞ú ÌíàÎ™©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // ÎèÑÏñ¥ ÏûêÏû¨ ÌÉ≠
      function generateDoorMaterialTab(materials) {
        const doorParts = materials.filter((m) => m.part.includes('ÎèÑÏñ¥'));

        if (doorParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">ÎèÑÏñ¥ ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#fff3e0;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">Î™®Îìà</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏûêÏû¨</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÎëêÍªò</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">Í∞ÄÎ°ú(W)</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ÏÑ∏Î°ú(H)</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏàòÎüâ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">Ïó£ÏßÄ</th>
        </tr>
      </thead>
      <tbody>`;

        doorParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#fff8e1'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:600;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:600;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#e65100;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.edge}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        // ÎèÑÏñ¥ Ï¥ù ÏàòÎüâ Í≥ÑÏÇ∞
        const totalDoors = doorParts.reduce((sum, m) => sum + m.qty, 0);

        return `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:14px;font-weight:bold;color:#333;">üö™ ÎèÑÏñ¥ ÏûêÏû¨ Î™©Î°ù</span>
      <span style="background:#ff9800;color:white;padding:4px 12px;border-radius:15px;font-size:12px;">Ï¥ù ${totalDoors}Í∞ú</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
    <div style="margin-top:15px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#666;">
      <strong>üìå ÎèÑÏñ¥ Í∑úÏπô:</strong> ÏÉÅÎ∂ÄÏû• ÎèÑÏñ¥ = Î™®ÎìàÎÜíÏù¥ + 20mm / ÌïòÎ∂ÄÏû• ÎèÑÏñ¥ = Î™®ÎìàÎÜíÏù¥ - 30mm / ÎÑàÎπÑ = Î™®ÎìàÎÑàÎπÑ - 4mm
    </div>
  `;
      }

      // EP ÏûêÏû¨ ÌÉ≠
      function generateEPMaterialTab(materials) {
        const epParts = materials.filter((m) =>
          ['Í±∏Î†àÎ∞õÏù¥', 'Ìú†Îùº', 'Î™©Ï∞¨ÎÑ¨', 'ÏÉÅÎ™∞Îî©', 'EP'].some((p) => m.module.includes(p) || m.part.includes(p))
        );

        if (epParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">EP(ÎßàÍ∞êÏû¨) ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#e8f5e9;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">ÌíàÎ™©</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏûêÏû¨</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÎëêÍªò</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">Í∞ÄÎ°ú</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ÏÑ∏Î°ú</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏàòÎüâ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">Ïó£ÏßÄ</th>
        </tr>
      </thead>
      <tbody>`;

        epParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#e8f5e9'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#2e7d32;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.edge}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;">
      <span style="font-size:14px;font-weight:bold;color:#333;">üìê EP(ÎßàÍ∞êÏû¨) ÏûêÏû¨ Î™©Î°ù (${epParts.length}Í∞ú ÌíàÎ™©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // Î∂ÄÏûêÏû¨ ÌÉ≠
      function generateHardwareTab(hwResult) {
        if (!hwResult.hardware || hwResult.hardware.length === 0) {
          return '<p style="color:#666;text-align:center;padding:40px;">Î∂ÄÏûêÏû¨ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
        }

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#fce4ec;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">Î∂ÑÎ•ò</th>
          <th style="border:1px solid #ddd;padding:10px;">ÌíàÎ™©</th>
          <th style="border:1px solid #ddd;padding:10px;">Ï†úÏ°∞ÏÇ¨</th>
          <th style="border:1px solid #ddd;padding:10px;">Ïä§Ìéô</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ÏàòÎüâ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">Îã®ÏúÑ</th>
          <th style="border:1px solid #ddd;padding:10px;">ÎπÑÍ≥†</th>
        </tr>
      </thead>
      <tbody>`;

        hwResult.hardware.forEach((h, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#fce4ec'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.category}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${h.item}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.manufacturer || '-'}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.spec || '-'}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#c2185b;">${h.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${h.unit}</td>
        <td style="border:1px solid #ddd;padding:8px;font-size:11px;color:#666;">${h.note || ''}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;">
      <span style="font-size:14px;font-weight:bold;color:#333;">üî© Î∂ÄÏûêÏû¨ Î™©Î°ù (${hwResult.hardware.length}Í∞ú ÌíàÎ™©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // Î≥¥Í≥†ÏÑú Î™®Îã¨ ÌëúÏãú
      function showReportModal(content) {
        const existingModal = document.getElementById('reportModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'reportModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);">
      <div style="background:white;border-radius:16px;width:95%;max-width:1100px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%);color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:20px;display:flex;align-items:center;gap:10px;">‚úÖ ÏÑ§Í≥Ñ ÏôÑÎ£å - ÏûêÏû¨ Ï∂îÏ∂ú Î≥¥Í≥†ÏÑú</h3>
          <button onclick="document.getElementById('reportModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">&times;</button>
        </div>
        <div style="padding:24px;overflow-y:auto;max-height:calc(90vh - 180px);">
          ${content}
        </div>
        <div style="padding:15px 24px;border-top:1px solid #eee;background:#f9f9f9;">
          <div style="display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;">
              <button onclick="downloadReportExcel()" style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                üìä ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
              </button>
              <button onclick="downloadReportCSV()" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                üìÑ CSV Îã§Ïö¥Î°úÎìú
              </button>
              <button onclick="downloadReportCNC()" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                üîß CNC ÌååÏùº
              </button>
            </div>
            <div style="display:flex;gap:8px;">
              <button onclick="generateDrawingFromReport()" style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                üìê ÎèÑÎ©¥ ÏÉùÏÑ±
              </button>
              <button onclick="document.getElementById('reportModal').remove()" style="background:#eee;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">Îã´Í∏∞</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // Î≥¥Í≥†ÏÑúÏóêÏÑú Ïû¨Îã® ÏµúÏ†ÅÌôî Ïã§Ìñâ
      function generateDrawingFromReport() {
        // ÌåùÏóÖ Îã´Í∏∞
        document.getElementById('reportModal')?.remove();
        // Ïû¨Îã® ÏµúÏ†ÅÌôî Ïã§Ìñâ
        showNestingOptimizer();
      }

      // ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú (CSVÎ•º ÏóëÏÖÄ Ìò∏Ìôò ÌòïÏãùÏúºÎ°ú)
      function downloadReportExcel() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);

        // ÏóëÏÖÄ Ìò∏Ìôò CSV (UTF-8 BOM + Tab Íµ¨Î∂Ñ)
        let excelContent = '\uFEFF'; // BOM

        // Ìó§Îçî Ï†ïÎ≥¥
        const item = data.design.items[0];
        excelContent += `Îã§Îã¥ Ï∫êÎπÑÎÑ∑ - ÏûêÏû¨ Ï∂îÏ∂ú Î≥¥Í≥†ÏÑú\n`;
        excelContent += `ÌîÑÎ°úÏ†ùÌä∏\t${item.name || item.category}\n`;
        excelContent += `ÌÅ¨Í∏∞\t${item.w} √ó ${item.h} √ó ${item.d}\n`;
        excelContent += `Ï∂îÏ∂úÏùºÏãú\t${new Date().toLocaleString('ko-KR')}\n\n`;

        // ÏûêÏû¨ Î™©Î°ù
        excelContent += `[Î≥∏Ï≤¥ Î∞è ÎèÑÏñ¥ ÏûêÏû¨]\n`;
        excelContent += `Î™®Îìà\tÎ∂ÄÌíà\tÏûêÏû¨\tÎëêÍªò(T)\tÍ∞ÄÎ°ú(mm)\tÏÑ∏Î°ú(mm)\tÏàòÎüâ\tÏó£ÏßÄ\tÎπÑÍ≥†\n`;
        data.materials.materials.forEach((m) => {
          excelContent += `${m.module}\t${m.part}\t${m.material}\t${m.thickness}\t${m.w}\t${m.h}\t${m.qty}\t${m.edge}\t${m.note || ''}\n`;
        });

        excelContent += `\n[Ìå®ÎÑê ÏÇ¨Ïö©Îüâ ÏöîÏïΩ]\n`;
        excelContent += `ÏûêÏû¨\tÏ¥ùÎ©¥Ï†Å(„é°)\tÌïÑÏöî Ìå®ÎÑê Ïàò\n`;
        Object.values(data.materials.summary).forEach((s) => {
          excelContent += `${s.material} ${s.thickness}T\t${(s.totalArea / 1000000).toFixed(2)}\t${s.panelCount}Ïû•\n`;
        });

        // Î∂ÄÏûêÏû¨ Î™©Î°ù
        if (data.hardware.hardware && data.hardware.hardware.length > 0) {
          excelContent += `\n[Î∂ÄÏûêÏû¨]\n`;
          excelContent += `Î∂ÑÎ•ò\tÌíàÎ™©\tÏ†úÏ°∞ÏÇ¨\tÏä§Ìéô\tÏàòÎüâ\tÎã®ÏúÑ\tÎπÑÍ≥†\n`;
          data.hardware.hardware.forEach((h) => {
            excelContent += `${h.category}\t${h.item}\t${h.manufacturer || ''}\t${h.spec || ''}\t${h.qty}\t${h.unit}\t${h.note || ''}\n`;
          });
        }

        const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const filename = `ÏûêÏû¨Î≥¥Í≥†ÏÑú_${item.category}_${dateStr}.xls`;
        downloadBlob(blob, filename);

        showToast('üìä ÏóëÏÖÄ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
      }

      // CSV Îã§Ïö¥Î°úÎìú
      function downloadReportCSV() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);
        const item = data.design.items[0];

        const blob = new Blob(['\uFEFF' + data.csvMaterial], { type: 'text/csv;charset=utf-8;' });
        const filename = `ÏûêÏû¨Î™©Î°ù_${item.category}_${dateStr}.csv`;
        downloadBlob(blob, filename);

        showToast('üìÑ CSV ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
      }

      // CNC ÌååÏùº Îã§Ïö¥Î°úÎìú
      function downloadReportCNC() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);
        const item = data.design.items[0];

        const blob = new Blob(['\uFEFF' + data.cncMaterial], { type: 'text/csv;charset=utf-8;' });
        const filename = `CNCÏû¨Îã®_${item.category}_${dateStr}.csv`;
        downloadBlob(blob, filename);

        showToast('üîß CNC ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
      }

      // ÌååÏùº Îã§Ïö¥Î°úÎìú Ìó¨Ìçº
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ
      function showToast(message) {
        const existing = document.querySelector('.toast-message');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.style.cssText =
          'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:20000;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease;';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, 2500);
      }

      // ============================================================
      // ÏÑ§Í≥Ñ Î∂àÎü¨Ïò§Í∏∞ Ìï®Ïàò
      // ============================================================
      function loadDesignFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const design = JSON.parse(event.target.result);
              const result = window.DadamAgent.importDesign(design);
              if (result.success) {
                alert('ÏÑ§Í≥ÑÎ•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                location.reload();
              } else {
                alert('ÏÑ§Í≥Ñ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + result.error);
              }
            } catch (err) {
              alert('ÌååÏùº ÌòïÏãù Ïò§Î•ò: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      // ============================================================
      // Ïû¨Îã® ÏµúÏ†ÅÌôî ÌÅ¥ÎûòÏä§ (Nesting Optimizer) v1.0
      // ============================================================
      // Í∑∏Î£π1: Ï∏°Ìåê, ÏßÄÌåê ‚Üí Ïã§ÏãúÍ∞Ñ Ïû¨Îã® ÎèÑÎ©¥
      // Í∑∏Î£π2: ÏÑúÎûçÏû¨ (H60, H120, H180) ‚Üí Ïû¨Í≥† Ïö¥ÏòÅ
      // Í∑∏Î£π3: Î≥¥Í∞ïÎ™©, Ï´ÑÎåÄ (W60, W70) ‚Üí Ïû¨Í≥† Ïö¥ÏòÅ
      // ============================================================

      class NestingOptimizer {
        constructor() {
          this.PANEL_W = 1220; // Ìå®ÎÑê ÎÑàÎπÑ
          this.PANEL_H = 2440; // Ìå®ÎÑê ÎÜíÏù¥
          this.KERF = 4; // ÌÜ±ÎÇ† ÎëêÍªò
          this.MARGIN = 10; // Ìå®ÎÑê Í∞ÄÏû•ÏûêÎ¶¨ Ïó¨Ïú†
        }

        // ========================================
        // Î©îÏù∏: ÏûêÏû¨ Î∂ÑÎ•ò Î∞è Ïû¨Îã® ÏµúÏ†ÅÌôî
        // ========================================
        process(materials) {
          // 1. ÏûêÏû¨ Í∑∏Î£π Î∂ÑÎ•ò
          const grouped = this.classifyMaterials(materials);

          // 2. Í∑∏Î£π1 Ïû¨Îã® ÏµúÏ†ÅÌôî (Ï∏°Ìåê, ÏßÄÌåê Îì±)
          const nestingResult = this.optimizeNesting(grouped.group1);

          // 3. Í≤∞Í≥º Î∞òÌôò
          return {
            group1: grouped.group1, // Ïû¨Îã® ÎåÄÏÉÅ
            group2: grouped.group2, // ÏÑúÎûçÏû¨ (Ïû¨Í≥†)
            group3: grouped.group3, // Î≥¥Í∞ïÎ™©/Ï´ÑÎåÄ (Ïû¨Í≥†)
            doors: grouped.doors, // ÎèÑÏñ¥Ïû¨
            backs: grouped.backs, // Îí∑Ìåê
            eps: grouped.eps, // EP (Í±∏Î†àÎ∞õÏù¥ Îì±)
            nesting: nestingResult, // Ïû¨Îã® Í≤∞Í≥º
            summary: this.calculateSummary(grouped, nestingResult),
          };
        }

        // ========================================
        // ÏûêÏû¨ Í∑∏Î£π Î∂ÑÎ•ò
        // ========================================
        classifyMaterials(materials) {
          const result = {
            group1: [], // Ï∏°Ìåê, ÏßÄÌåê, Ï≤úÌåê, ÏÑ†Î∞ò, Ï§ëÍ∞ÑÏπ∏ÎßâÏù¥
            group2: [], // ÏÑúÎûçÏû¨ (H: 60, 120, 180)
            group3: [], // Î≥¥Í∞ïÎ™©, Ï´ÑÎåÄ, Î∞¥Îìú (W: 60, 70)
            doors: [], // ÎèÑÏñ¥
            backs: [], // Îí∑Ìåê
            eps: [], // EP (Í±∏Î†àÎ∞õÏù¥, Ìú†Îùº, Î™©Ï∞¨ÎÑ¨, ÏÉÅÎ™∞Îî©, Ï¢åÎåÄ)
          };

          materials.forEach((m) => {
            const part = m.part;
            const h = m.h;
            const w = m.w;

            // ÎèÑÏñ¥
            if (part.includes('ÎèÑÏñ¥')) {
              result.doors.push(m);
            }
            // Îí∑Ìåê
            else if (part.includes('Îí∑Ìåê')) {
              result.backs.push(m);
            }
            // EPÎ•ò
            else if (['Í±∏Î†àÎ∞õÏù¥', 'Ìú†Îùº', 'Î™©Ï∞¨ÎÑ¨', 'ÏÉÅÎ™∞Îî©', 'Ï¢åÎåÄ'].some((ep) => part.includes(ep))) {
              result.eps.push(m);
            }
            // Í∑∏Î£π2: ÏÑúÎûçÏû¨ (ÎÜíÏù¥ 60, 120, 180)
            else if (part.includes('ÏÑúÎûç') || [60, 120, 180].includes(h)) {
              result.group2.push(m);
            }
            // Í∑∏Î£π3: Î≥¥Í∞ïÎ™©, Ï´ÑÎåÄ, Î∞¥Îìú (Ìè≠ 60, 70)
            else if (part.includes('Î∞¥Îìú') || part.includes('Î≥¥Í∞ï') || part.includes('Ï´ÑÎåÄ') || [60, 70].includes(w)) {
              result.group3.push(m);
            }
            // Í∑∏Î£π1: Ï∏°Ìåê, ÏßÄÌåê, Ï≤úÌåê, ÏÑ†Î∞ò Îì± (Ïû¨Îã® ÎåÄÏÉÅ)
            else {
              result.group1.push(m);
            }
          });

          return result;
        }

        // ========================================
        // Í∑∏Î£π1 Ïû¨Îã® ÏµúÏ†ÅÌôî (Guillotine Cut)
        // ========================================
        optimizeNesting(parts) {
          if (!parts || parts.length === 0) {
            return { sheets: [], totalSheets: 0, efficiency: 0 };
          }

          // ÏûêÏû¨+ÎëêÍªòÎ≥Ñ Î∂ÑÎ•ò
          const byMaterial = {};
          parts.forEach((p) => {
            const key = `${p.material}_${p.thickness}T`;
            if (!byMaterial[key]) byMaterial[key] = [];
            // ÏàòÎüâÎßåÌÅº Í∞úÎ≥Ñ Î∂ÄÌíàÏúºÎ°ú ÌôïÏû•
            for (let i = 0; i < p.qty; i++) {
              byMaterial[key].push({
                ...p,
                partId: `${p.module}_${p.part}_${i + 1}`,
                qty: 1,
              });
            }
          });

          const allSheets = [];

          // ÏûêÏû¨Î≥Ñ Ïû¨Îã®
          Object.entries(byMaterial).forEach(([matKey, matParts]) => {
            const [material, thickness] = matKey.split('_');
            const sheets = this.nestParts(matParts, material, thickness);
            allSheets.push(...sheets);
          });

          // Ï†ÑÏ≤¥ Ìö®Ïú® Í≥ÑÏÇ∞
          let totalUsed = 0,
            totalPanel = 0;
          allSheets.forEach((s) => {
            totalUsed += s.usedArea;
            totalPanel += this.PANEL_W * this.PANEL_H;
          });

          return {
            sheets: allSheets,
            totalSheets: allSheets.length,
            efficiency: totalPanel > 0 ? Math.round((totalUsed / totalPanel) * 1000) / 10 : 0,
          };
        }

        // ========================================
        // Guillotine Nesting (ÏµúÏÜå Ïû¨Îã® ÌöüÏàò)
        // ========================================
        nestParts(parts, material, thickness) {
          const sheets = [];

          // Î©¥Ï†Å Í∏∞Ï§Ä ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨ (ÌÅ∞ Í≤É Î®ºÏ†Ä)
          const sorted = [...parts].sort((a, b) => {
            const areaA = a.w * a.h;
            const areaB = b.w * b.h;
            if (areaA !== areaB) return areaB - areaA;
            return b.h - a.h; // ÎÜíÏù¥ ÌÅ∞ Í≤É Ïö∞ÏÑ†
          });

          const remaining = [...sorted];

          while (remaining.length > 0) {
            const sheet = this.createSheet(material, thickness);

            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            sheet.freeRects = [
              {
                x: this.MARGIN,
                y: this.MARGIN,
                w: this.PANEL_W - this.MARGIN * 2,
                h: this.PANEL_H - this.MARGIN * 2,
              },
            ];

            // Î∂ÄÌíà Î∞∞Ïπò
            const placed = [];
            for (let i = remaining.length - 1; i >= 0; i--) {
              const part = remaining[i];
              const placement = this.placePart(sheet, part);
              if (placement) {
                sheet.placements.push(placement);
                placed.push(i);
              }
            }

            // Î∞∞ÏπòÎêú Î∂ÄÌíà Ï†úÍ±∞
            placed.forEach((idx) => remaining.splice(idx, 1));

            // Ïû¨Îã®ÏÑ† Í≥ÑÏÇ∞
            sheet.cuts = this.calculateCuts(sheet.placements);

            // ÏÇ¨Ïö© Î©¥Ï†Å Í≥ÑÏÇ∞
            sheet.usedArea = sheet.placements.reduce((sum, p) => sum + p.w * p.h, 0);
            sheet.efficiency = Math.round((sheet.usedArea / (this.PANEL_W * this.PANEL_H)) * 1000) / 10;

            sheets.push(sheet);

            // Î¨¥ÌïúÎ£®ÌîÑ Î∞©ÏßÄ
            if (placed.length === 0) {
              console.warn('Î∞∞Ïπò Î∂àÍ∞ÄÎä•Ìïú Î∂ÄÌíà:', remaining[0]);
              break;
            }
          }

          return sheets;
        }

        createSheet(material, thickness) {
          return {
            sheetId: Date.now() + Math.random(),
            material,
            thickness,
            width: this.PANEL_W,
            height: this.PANEL_H,
            placements: [],
            cuts: [],
            freeRects: [],
            usedArea: 0,
            efficiency: 0,
          };
        }

        // ========================================
        // Î∂ÄÌíà Î∞∞Ïπò (Best Fit)
        // ========================================
        placePart(sheet, part) {
          let bestRect = null;
          let bestFit = Infinity;
          let bestIdx = -1;

          // Í∞ÄÏû• Ï†ÅÌï©Ìïú Îπà Í≥µÍ∞Ñ Ï∞æÍ∏∞
          for (let i = 0; i < sheet.freeRects.length; i++) {
            const rect = sheet.freeRects[i];

            // ÌöåÏ†Ñ ÏóÜÏù¥ Î∞∞Ïπò Í∞ÄÎä•?
            if (part.w <= rect.w && part.h <= rect.h) {
              const fit = rect.w * rect.h - part.w * part.h;
              if (fit < bestFit) {
                bestFit = fit;
                bestRect = { ...rect, rotated: false };
                bestIdx = i;
              }
            }

            // ÌöåÏ†ÑÌï¥ÏÑú Î∞∞Ïπò Í∞ÄÎä•? (Îí∑ÌåêÎßå ÌöåÏ†Ñ ÌóàÏö©)
            if (part.part && part.part.includes('Îí∑Ìåê')) {
              if (part.h <= rect.w && part.w <= rect.h) {
                const fit = rect.w * rect.h - part.w * part.h;
                if (fit < bestFit) {
                  bestFit = fit;
                  bestRect = { ...rect, rotated: true };
                  bestIdx = i;
                }
              }
            }
          }

          if (!bestRect) return null;

          // Î∂ÄÌíà Î∞∞Ïπò
          const placement = {
            partId: part.partId || `${part.module}_${part.part}`,
            name: part.part,
            module: part.module,
            x: bestRect.x,
            y: bestRect.y,
            w: bestRect.rotated ? part.h : part.w,
            h: bestRect.rotated ? part.w : part.h,
            originalW: part.w,
            originalH: part.h,
            rotated: bestRect.rotated,
            edge: part.edge,
            material: part.material,
            thickness: part.thickness,
          };

          // Îπà Í≥µÍ∞ÑÏóêÏÑú Ï†úÍ±∞
          sheet.freeRects.splice(bestIdx, 1);

          // Guillotine Î∂ÑÌï† (ÏµúÏÜå Ïû¨Îã® ÌöüÏàò ÏúÑÌï¥ ÏàòÌèâ Ïö∞ÏÑ†)
          this.splitRect(sheet, bestRect, placement);

          return placement;
        }

        // ========================================
        // Guillotine Î∂ÑÌï† (ÏàòÌèâ Ïö∞ÏÑ† - Ïû¨Îã® ÌöüÏàò ÏµúÏÜåÌôî)
        // ========================================
        splitRect(sheet, rect, placement) {
          const rightW = rect.w - placement.w - this.KERF;
          const topH = rect.h - placement.h - this.KERF;

          // ÏàòÌèâ Î∂ÑÌï† Ïö∞ÏÑ† (Í∏¥ ÏàòÌèâÏÑ† ÌïòÎÇòÎ°ú Ïó¨Îü¨ Î∂ÄÌíà Ïû¨Îã® Í∞ÄÎä•)
          if (topH > 50) {
            sheet.freeRects.push({
              x: rect.x,
              y: rect.y + placement.h + this.KERF,
              w: rect.w,
              h: topH,
            });
          }
          if (rightW > 50) {
            sheet.freeRects.push({
              x: rect.x + placement.w + this.KERF,
              y: rect.y,
              w: rightW,
              h: placement.h,
            });
          }

          // Îπà Í≥µÍ∞Ñ Ï†ïÎ†¨ (ÏûëÏùÄ Í≤É Ïö∞ÏÑ† ÏÇ¨Ïö©)
          sheet.freeRects.sort((a, b) => a.w * a.h - b.w * b.h);
        }

        // ========================================
        // Ïû¨Îã®ÏÑ† Í≥ÑÏÇ∞
        // ========================================
        calculateCuts(placements) {
          const cuts = [];
          const horizontalY = new Set();
          const verticalX = new Set();

          placements.forEach((p) => {
            // ÏàòÌèâ Ïû¨Îã®ÏÑ† (Î∂ÄÌíà ÏÉÅÎã®)
            horizontalY.add(p.y + p.h + this.KERF / 2);
            // ÏàòÏßÅ Ïû¨Îã®ÏÑ† (Î∂ÄÌíà Ïö∞Ï∏°)
            verticalX.add(p.x + p.w + this.KERF / 2);
          });

          horizontalY.forEach((y) => {
            if (y < this.PANEL_H - this.MARGIN) {
              cuts.push({ type: 'horizontal', y, x1: 0, x2: this.PANEL_W });
            }
          });

          verticalX.forEach((x) => {
            if (x < this.PANEL_W - this.MARGIN) {
              cuts.push({ type: 'vertical', x, y1: 0, y2: this.PANEL_H });
            }
          });

          return cuts;
        }

        // ========================================
        // ÏöîÏïΩ Í≥ÑÏÇ∞
        // ========================================
        calculateSummary(grouped, nesting) {
          const countParts = (arr) => arr.reduce((sum, p) => sum + (p.qty || 1), 0);

          return {
            group1Count: countParts(grouped.group1),
            group2Count: countParts(grouped.group2),
            group3Count: countParts(grouped.group3),
            doorCount: countParts(grouped.doors),
            backCount: countParts(grouped.backs),
            epCount: countParts(grouped.eps),
            totalSheets: nesting.totalSheets,
            efficiency: nesting.efficiency,
          };
        }

        // ========================================
        // Canvas Î†åÎçîÎßÅ (Ïû¨Îã® ÎèÑÎ©¥)
        // ========================================
        renderSheet(canvas, sheet, scale = 0.25) {
          const ctx = canvas.getContext('2d');
          const W = this.PANEL_W * scale;
          const H = this.PANEL_H * scale;

          canvas.width = W + 40;
          canvas.height = H + 60;

          ctx.fillStyle = '#f5f5f5';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Ìå®ÎÑê Î∞∞Í≤Ω
          ctx.fillStyle = '#fff8e1';
          ctx.fillRect(20, 20, W, H);
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 2;
          ctx.strokeRect(20, 20, W, H);

          // Ìå®ÎÑê ÌÅ¨Í∏∞ ÌëúÏãú
          ctx.fillStyle = '#333';
          ctx.font = '11px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`${this.PANEL_W}mm`, 20 + W / 2, 15);
          ctx.save();
          ctx.translate(12, 20 + H / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.fillText(`${this.PANEL_H}mm`, 0, 0);
          ctx.restore();

          // ÏÉâÏÉÅ ÌåîÎ†àÌä∏
          const colors = ['#81d4fa', '#a5d6a7', '#ffe082', '#ef9a9a', '#ce93d8', '#80cbc4', '#ffcc80', '#b39ddb'];

          // Î∂ÄÌíà Î†åÎçîÎßÅ
          sheet.placements.forEach((p, idx) => {
            const x = 20 + p.x * scale;
            const y = 20 + (this.PANEL_H - p.y - p.h) * scale; // YÏ∂ï Î∞òÏ†Ñ
            const w = p.w * scale;
            const h = p.h * scale;

            // Î∂ÄÌíà Î∞∞Í≤Ω
            ctx.fillStyle = colors[idx % colors.length];
            ctx.fillRect(x, y, w, h);

            // Î∂ÄÌíà ÌÖåÎëêÎ¶¨
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);

            // Ïó£ÏßÄ ÌëúÏãú
            this.renderEdge(ctx, x, y, w, h, p.edge);

            // Î∂ÄÌíàÎ™Ö
            ctx.fillStyle = '#000';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const label = p.name.length > 6 ? p.name.substring(0, 6) : p.name;
            ctx.fillText(label, x + w / 2, y + h / 2 - 6);

            ctx.font = '9px Arial';
            ctx.fillText(`${p.originalW}√ó${p.originalH}`, x + w / 2, y + h / 2 + 6);
          });

          // Ïû¨Îã®ÏÑ† Î†åÎçîÎßÅ
          ctx.strokeStyle = '#e53935';
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 3]);

          sheet.cuts.forEach((cut) => {
            ctx.beginPath();
            if (cut.type === 'horizontal') {
              const y = 20 + (this.PANEL_H - cut.y) * scale;
              ctx.moveTo(20, y);
              ctx.lineTo(20 + W, y);
            } else {
              const x = 20 + cut.x * scale;
              ctx.moveTo(x, 20);
              ctx.lineTo(x, 20 + H);
            }
            ctx.stroke();
          });

          ctx.setLineDash([]);

          // Ï†ïÎ≥¥ ÌëúÏãú
          ctx.fillStyle = '#333';
          ctx.font = '11px Arial';
          ctx.textAlign = 'left';
          ctx.fillText(
            `${sheet.material} ${sheet.thickness}  |  Ìö®Ïú®: ${sheet.efficiency}%  |  Î∂ÄÌíà: ${sheet.placements.length}Í∞ú  |  Ïû¨Îã®ÏÑ†: ${sheet.cuts.length}Í∞ú`,
            20,
            H + 50
          );
        }

        // ========================================
        // Ïó£ÏßÄ ÌëúÏãú Î†åÎçîÎßÅ
        // ========================================
        renderEdge(ctx, x, y, w, h, edge) {
          if (!edge || edge === '-') return;

          ctx.strokeStyle = '#d32f2f';
          ctx.lineWidth = 3;

          const edgeStr = edge.toString();

          // 4Î©¥ Ïó£ÏßÄ
          if (edgeStr.includes('4Î©¥')) {
            ctx.strokeRect(x + 1, y + 1, w - 2, h - 2);
            return;
          }

          // 1Î©¥(Ï†Ñ) - ÏïûÎ©¥Îßå
          if (edgeStr.includes('1Î©¥(Ï†Ñ)') || edgeStr.includes('1Î©¥')) {
            ctx.beginPath();
            ctx.moveTo(x, y + h);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
            return;
          }

          // 2Î©¥(Ïû•) - Í∏¥Î©¥ 2Í∞ú
          if (edgeStr.includes('2Î©¥(Ïû•)')) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + w, y);
            ctx.moveTo(x, y + h);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
            return;
          }

          // 2Î©¥(Îã®) - ÏßßÏùÄÎ©¥ 2Í∞ú
          if (edgeStr.includes('2Î©¥(Îã®)')) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + h);
            ctx.moveTo(x + w, y);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
          }
        }
      }

      // Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§
      const nestingOptimizer = new NestingOptimizer();

      // ============================================================
      // Ïû¨Îã® ÏµúÏ†ÅÌôî UI
      // ============================================================
      function showNestingOptimizer() {
        const design = window.DadamAgent.exportDesign();
        if (!design.items || design.items.length === 0) {
          alert('ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }

        // ÏûêÏû¨ Ï∂îÏ∂ú
        const matResult = materialExtractor.extract(design);
        if (!matResult.materials.length) {
          alert('Ï∂îÏ∂úÎêú ÏûêÏû¨Í∞Ä ÏóÜÏäµÎãàÎã§.');
          return;
        }

        // Ïû¨Îã® ÏµúÏ†ÅÌôî
        const result = nestingOptimizer.process(matResult.materials);
        console.log('[Nesting] Í≤∞Í≥º:', result);

        // ÌåùÏóÖ ÏÉùÏÑ±
        showNestingModal(result, design);
      }

      function showNestingModal(result, design) {
        const existingModal = document.getElementById('nestingModal');
        if (existingModal) existingModal.remove();

        const item = design.items[0];
        const projectName = `${item.name || item.categoryId} ${item.w}√ó${item.h}`;

        // ÏûêÏû¨ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        const group1Table = generateMaterialTable(result.group1, 'Í∑∏Î£π1: Ïû¨Îã® ÎåÄÏÉÅ (Ï∏°Ìåê, ÏßÄÌåê, Ï≤úÌåê, ÏÑ†Î∞ò Îì±)');
        const group2Table = generateMaterialTable(result.group2, 'Í∑∏Î£π2: ÏÑúÎûçÏû¨ (Ïû¨Í≥† Ïö¥ÏòÅ)');
        const group3Table = generateMaterialTable(result.group3, 'Í∑∏Î£π3: Î≥¥Í∞ïÎ™©/Ï´ÑÎåÄ (Ïû¨Í≥† Ïö¥ÏòÅ)');
        const doorTable = generateMaterialTable(result.doors, 'ÎèÑÏñ¥Ïû¨');
        const backTable = generateMaterialTable(result.backs, 'Îí∑Ìåê');
        const epTable = generateMaterialTable(result.eps, 'EP (Í±∏Î†àÎ∞õÏù¥, Ìú†Îùº Îì±)');

        // Ïû¨Îã® ÎèÑÎ©¥ Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
        let sheetCanvases = '';
        if (result.nesting.sheets.length > 0) {
          result.nesting.sheets.forEach((sheet, idx) => {
            sheetCanvases += `
        <div style="margin-bottom:20px;padding:15px;background:#fafafa;border-radius:8px;">
          <h4 style="margin:0 0 10px 0;color:#1976d2;">üìê Ìå®ÎÑê #${idx + 1} - ${sheet.material} ${sheet.thickness}</h4>
          <canvas id="nestingCanvas_${idx}" style="border:1px solid #ddd;border-radius:4px;"></canvas>
        </div>
      `;
          });
        } else {
          sheetCanvases = '<p style="color:#666;text-align:center;padding:40px;">Ïû¨Îã® ÎåÄÏÉÅ Î∂ÄÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
        }

        const modal = document.createElement('div');
        modal.id = 'nestingModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);">
      <div style="background:white;border-radius:16px;width:95%;max-width:1200px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="background:linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:20px;display:flex;align-items:center;gap:10px;">ü™µ Ïû¨Îã® ÏµúÏ†ÅÌôî - ${projectName}</h3>
          <button onclick="document.getElementById('nestingModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">&times;</button>
        </div>
        
        <div style="display:flex;border-bottom:1px solid #e0e0e0;">
          <button class="nesting-tab active" onclick="switchNestingTab(this, 'summary')" style="flex:1;padding:12px;border:none;background:#e8f5e9;color:#2e7d32;font-weight:bold;cursor:pointer;">üìä ÏöîÏïΩ</button>
          <button class="nesting-tab" onclick="switchNestingTab(this, 'cutting')" style="flex:1;padding:12px;border:none;background:#f5f5f5;color:#666;font-weight:bold;cursor:pointer;">üìê Ïû¨Îã®ÎèÑÎ©¥</button>
          <button class="nesting-tab" onclick="switchNestingTab(this, 'materials')" style="flex:1;padding:12px;border:none;background:#f5f5f5;color:#666;font-weight:bold;cursor:pointer;">üìã Ï†ÑÏ≤¥ÏûêÏû¨</button>
        </div>
        
        <div style="padding:20px;overflow-y:auto;max-height:calc(90vh - 180px);">
          <!-- ÏöîÏïΩ ÌÉ≠ -->
          <div id="nesting-tab-summary" class="nesting-content">
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:15px;margin-bottom:20px;">
              <div style="background:linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.nesting.totalSheets}</div>
                <div style="font-size:12px;opacity:0.9;">ÌïÑÏöî Ìå®ÎÑê Ïàò</div>
              </div>
              <div style="background:linear-gradient(135deg, #66bb6a 0%, #43a047 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.nesting.efficiency}%</div>
                <div style="font-size:12px;opacity:0.9;">Ïû¨Îã® Ìö®Ïú®</div>
              </div>
              <div style="background:linear-gradient(135deg, #ffca28 0%, #ffa000 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.summary.group1Count}</div>
                <div style="font-size:12px;opacity:0.9;">Ïû¨Îã® Î∂ÄÌíà</div>
              </div>
              <div style="background:linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.summary.doorCount}</div>
                <div style="font-size:12px;opacity:0.9;">ÎèÑÏñ¥ Ïàò</div>
              </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
              <div style="background:#e3f2fd;padding:15px;border-radius:10px;">
                <h4 style="margin:0 0 10px 0;color:#1565c0;">üîß Ïû¨Í≥† Ïö¥ÏòÅ Î∂ÄÌíà</h4>
                <div style="font-size:13px;color:#333;">
                  <div style="margin-bottom:5px;">‚Ä¢ ÏÑúÎûçÏû¨ (Í∑∏Î£π2): <strong>${result.summary.group2Count}Í∞ú</strong></div>
                  <div>‚Ä¢ Î≥¥Í∞ïÎ™©/Ï´ÑÎåÄ (Í∑∏Î£π3): <strong>${result.summary.group3Count}Í∞ú</strong></div>
                </div>
              </div>
              <div style="background:#fce4ec;padding:15px;border-radius:10px;">
                <h4 style="margin:0 0 10px 0;color:#c2185b;">üì¶ Í∏∞ÌÉÄ ÏûêÏû¨</h4>
                <div style="font-size:13px;color:#333;">
                  <div style="margin-bottom:5px;">‚Ä¢ Îí∑Ìåê: <strong>${result.summary.backCount}Í∞ú</strong></div>
                  <div>‚Ä¢ EP (Í±∏Î†àÎ∞õÏù¥ Îì±): <strong>${result.summary.epCount}Í∞ú</strong></div>
                </div>
              </div>
            </div>
            
            <div style="margin-top:20px;background:#fff3e0;padding:15px;border-radius:10px;border:1px solid #ffe0b2;">
              <h4 style="margin:0 0 10px 0;color:#e65100;">üí° Ïó£ÏßÄ ÌëúÏãú ÏïàÎÇ¥</h4>
              <div style="display:flex;gap:20px;font-size:12px;">
                <span><span style="display:inline-block;width:20px;height:3px;background:#d32f2f;vertical-align:middle;margin-right:5px;"></span> Îπ®Í∞Ñ ÍµµÏùÄÏÑ† = Ïó£ÏßÄ Ï≤òÎ¶¨Î©¥</span>
                <span><span style="display:inline-block;width:20px;height:1px;background:#e53935;border-style:dashed;vertical-align:middle;margin-right:5px;"></span> Îπ®Í∞Ñ Ï†êÏÑ† = Ïû¨Îã®ÏÑ†</span>
              </div>
            </div>
          </div>
          
          <!-- Ïû¨Îã®ÎèÑÎ©¥ ÌÉ≠ -->
          <div id="nesting-tab-cutting" class="nesting-content" style="display:none;">
            ${sheetCanvases}
          </div>
          
          <!-- Ï†ÑÏ≤¥ÏûêÏû¨ ÌÉ≠ -->
          <div id="nesting-tab-materials" class="nesting-content" style="display:none;">
            ${group1Table}
            ${doorTable}
            ${group2Table}
            ${group3Table}
            ${backTable}
            ${epTable}
          </div>
        </div>
        
        <div style="padding:15px 24px;border-top:1px solid #eee;background:#f9f9f9;display:flex;gap:10px;justify-content:space-between;">
          <div style="display:flex;gap:8px;">
            <button onclick="downloadNestingCSV()" style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üìÑ Ïû¨Îã®Î™©Î°ù CSV</button>
            <button onclick="downloadNestingPDF()" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üìã Ïû¨Îã®ÏßÄÏãúÏÑú</button>
            <button onclick="printNestingSheets()" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">üñ®Ô∏è Ïù∏ÏáÑ</button>
          </div>
          <button onclick="document.getElementById('nestingModal').remove()" style="background:#eee;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">Îã´Í∏∞</button>
        </div>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        // Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        window._nestingResult = result;

        // Canvas Î†åÎçîÎßÅ
        setTimeout(() => {
          result.nesting.sheets.forEach((sheet, idx) => {
            const canvas = document.getElementById(`nestingCanvas_${idx}`);
            if (canvas) {
              nestingOptimizer.renderSheet(canvas, sheet, 0.28);
            }
          });
        }, 100);
      }

      // ÌÉ≠ Ï†ÑÌôò
      function switchNestingTab(btn, tabId) {
        document.querySelectorAll('.nesting-tab').forEach((t) => {
          t.style.background = '#f5f5f5';
          t.style.color = '#666';
          t.classList.remove('active');
        });
        btn.style.background = '#e8f5e9';
        btn.style.color = '#2e7d32';
        btn.classList.add('active');

        document.querySelectorAll('.nesting-content').forEach((c) => (c.style.display = 'none'));
        document.getElementById('nesting-tab-' + tabId).style.display = 'block';

        // Ïû¨Îã®ÎèÑÎ©¥ ÌÉ≠ ÏÑ†ÌÉùÏãú Canvas Îã§Ïãú Î†åÎçîÎßÅ
        if (tabId === 'cutting' && window._nestingResult) {
          setTimeout(() => {
            window._nestingResult.nesting.sheets.forEach((sheet, idx) => {
              const canvas = document.getElementById(`nestingCanvas_${idx}`);
              if (canvas) {
                nestingOptimizer.renderSheet(canvas, sheet, 0.28);
              }
            });
          }, 50);
        }
      }

      // ÏûêÏû¨ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
      function generateMaterialTable(materials, title) {
        if (!materials || materials.length === 0) {
          return `<div style="margin-bottom:20px;"><h4 style="color:#666;margin-bottom:10px;">${title}</h4><p style="color:#999;font-size:13px;">Ìï¥Îãπ ÏûêÏû¨ ÏóÜÏùå</p></div>`;
        }

        let html = `
    <div style="margin-bottom:25px;">
      <h4 style="color:#333;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #4caf50;">${title}</h4>
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#e8f5e9;">
          <tr>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">No</th>
            <th style="border:1px solid #ddd;padding:8px;">Î™®Îìà</th>
            <th style="border:1px solid #ddd;padding:8px;">Î∂ÄÌíà</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ÏûêÏû¨</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ÎëêÍªò</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:right;">Í∞ÄÎ°ú</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:right;">ÏÑ∏Î°ú</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ÏàòÎüâ</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">Ïó£ÏßÄ</th>
          </tr>
        </thead>
        <tbody>
  `;

        materials.forEach((m, idx) => {
          html += `
      <tr style="background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${idx + 1}</td>
        <td style="border:1px solid #ddd;padding:6px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:6px;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;color:#d32f2f;font-weight:bold;">${m.edge}</td>
      </tr>
    `;
        });

        html += '</tbody></table></div>';
        return html;
      }

      // CSV Îã§Ïö¥Î°úÎìú
      function downloadNestingCSV() {
        if (!window._nestingResult) return;

        const result = window._nestingResult;
        let csv = '\uFEFF'; // BOM
        csv += 'Í∑∏Î£π,Î™®Îìà,Î∂ÄÌíà,ÏûêÏû¨,ÎëêÍªò,Í∞ÄÎ°ú,ÏÑ∏Î°ú,ÏàòÎüâ,Ïó£ÏßÄ\n';

        const addRows = (group, groupName) => {
          group.forEach((m) => {
            csv += `${groupName},${m.module},${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${m.edge}\n`;
          });
        };

        addRows(result.group1, 'Í∑∏Î£π1(Ïû¨Îã®)');
        addRows(result.doors, 'ÎèÑÏñ¥Ïû¨');
        addRows(result.group2, 'Í∑∏Î£π2(ÏÑúÎûç)');
        addRows(result.group3, 'Í∑∏Î£π3(Î≥¥Í∞ï)');
        addRows(result.backs, 'Îí∑Ìåê');
        addRows(result.eps, 'EP');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ïû¨Îã®Î™©Î°ù_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
      }

      // Ïû¨Îã® ÏßÄÏãúÏÑú (Í∞ÑÎã® Î≤ÑÏ†Ñ)
      function downloadNestingPDF() {
        if (!window._nestingResult) return;

        const result = window._nestingResult;
        let content = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        content += '              Îã§Îã¥ Í∞ÄÍµ¨ - Ïû¨Îã® ÏßÄÏãúÏÑú\n';
        content += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        content += `ÏûëÏÑ±ÏùºÏãú: ${new Date().toLocaleString('ko-KR')}\n`;
        content += `ÌïÑÏöî Ìå®ÎÑê: ${result.nesting.totalSheets}Ïû•  |  Ìö®Ïú®: ${result.nesting.efficiency}%\n`;
        content += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';

        result.nesting.sheets.forEach((sheet, idx) => {
          content += `[Ìå®ÎÑê #${idx + 1}] ${sheet.material} ${sheet.thickness} (${sheet.width}√ó${sheet.height}mm)\n`;
          content += `Ìö®Ïú®: ${sheet.efficiency}%  |  Ïû¨Îã®ÏÑ†: ${sheet.cuts.length}Í∞ú\n`;
          content += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';

          sheet.placements.forEach((p, pIdx) => {
            content += `  ${pIdx + 1}. ${p.name} (${p.originalW}√ó${p.originalH})\n`;
            content += `     ÏúÑÏπò: X=${p.x}, Y=${p.y}  |  Ïó£ÏßÄ: ${p.edge}\n`;
            content += `     Î™®Îìà: ${p.module}\n\n`;
          });
          content += '\n';
        });

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ïû¨Îã®ÏßÄÏãúÏÑú_${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
      }

      // Ïù∏ÏáÑ
      function printNestingSheets() {
        window.print();
      }

      // ============================================================
      // Supabase Ïù∏Ï¶ù Î∞è Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏãúÏä§ÌÖú
      // ============================================================
      // (Supabase ÏÑ§Ï†ïÏùÄ js/supabase-utils.jsÏóêÏÑú Í¥ÄÎ¶¨)

      // n8n Webhook URL (ÏÑ§Ï†ï ÌïÑÏöî)
      const N8N_WEBHOOK_URL = ''; // Ïòà: 'https://your-n8n.com/webhook/design-save'

      // AI ÎîîÏûêÏù∏ ÏÉùÏÑ± API URL (ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò - Fast Generation)
      // Cloudflare Proxy Í≤ΩÏú† (CORS Ìï¥Í≤∞)
      const N8N_AI_DESIGN_URL = 'https://dadam.app.n8n.cloud/webhook/design-to-image';
      const N8N_CHAT_URL = 'https://dadam.app.n8n.cloud/webhook/chat';

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // Ï±ÑÌåÖ Í∏∞Î°ù Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ (Supabase)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ÏÑ∏ÏÖò ID ÏÉùÏÑ±/Í∞ÄÏ†∏Ïò§Í∏∞ (ÎπÑÎ°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÏö©)
      function getChatSessionId() {
        let sessionId = sessionStorage.getItem('chat_session_id');
        if (!sessionId) {
          sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('chat_session_id', sessionId);
        }
        return sessionId;
      }

      // Î©îÏãúÏßÄ Ï†ÄÏû•
      async function saveChatMessage(content, role) {
        if (!supabaseClient) return;

        try {
          const userId = currentUser?.id || null;
          const sessionId = userId ? null : getChatSessionId();

          await supabaseClient.from('chat_messages').insert({
            user_id: userId,
            session_id: sessionId,
            role: role,
            content: content,
            page_source: 'detail-design'
          });
        } catch (error) {
          console.log('Î©îÏãúÏßÄ Ï†ÄÏû• Ïã§Ìå®:', error.message);
        }
      }

      // ÎåÄÌôî Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞
      async function loadChatHistory() {
        if (!supabaseClient) return;

        try {
          const userId = currentUser?.id;
          const sessionId = getChatSessionId();

          let query = supabaseClient
            .from('chat_messages')
            .select('*')
            .eq('page_source', 'detail-design')
            .order('created_at', { ascending: true })
            .limit(50);

          if (userId) {
            query = query.eq('user_id', userId);
          } else {
            query = query.eq('session_id', sessionId);
          }

          const { data, error } = await query;

          if (error) throw error;

          if (data && data.length > 0) {
            data.forEach(msg => {
              addChatMessage(msg.content, msg.role === 'user', null, false);
            });
          }
        } catch (error) {
          console.log('ÎåÄÌôî Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error.message);
        }
      }

      // Ïù¥ÎØ∏ÏßÄÎ•º Supabase StorageÏóê ÏóÖÎ°úÎìú (SupabaseUtils ÏúÑÏûÑ)
      async function uploadImageToStorage(file, userId) {
        return SupabaseUtils.uploadImage(file, userId);
      }

      let supabaseClient = null;
      let currentUser = null;
      let userProfile = null;
      let currentDesignId = null;
      let autoSaveTimer = null;
      let hasUnsavedChanges = false;

      // Supabase Ï¥àÍ∏∞Ìôî Î∞è Ïù∏Ï¶ù ÌôïÏù∏ (SupabaseUtils ÌÜµÌï©)
      async function initAuth() {
        // SupabaseUtils ÏÇ¨Ïö© (js/supabase-utils.js)
        const session = await SupabaseUtils.init();

        // Ïπ¥ÌÉàÎ°úÍ∑∏ Î°úÎìú (Supabase Ïó∞Í≤∞ ÌõÑ)
        FurnitureOptionCatalog.load().catch(e => console.warn('[Catalog] async load error:', e));

        // Î°úÏª¨ Ï∞∏Ï°∞ ÎèôÍ∏∞Ìôî (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
        supabaseClient = SupabaseUtils.client;

        if (!session) {
          showAuthOverlay();
          return;
        }

        currentUser = SupabaseUtils.currentUser;
        await loadUserProfile();
      }

      // ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ Î°úÎìú
      async function loadUserProfile() {
        // profiles ÌÖåÏù¥Î∏îÏóêÏÑú Ï°∞Ìöå (ÎòêÎäî auth.users metadata ÏÇ¨Ïö©)
        try {
          const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();

          if (!error && data) {
            userProfile = data;
          } else {
            // profiles ÌÖåÏù¥Î∏îÏù¥ ÏóÜÍ±∞ÎÇò Ï°∞Ìöå Ïã§Ìå® Ïãú auth.users metadata ÏÇ¨Ïö©
            userProfile = {
              id: currentUser.id,
              email: currentUser.email,
              tier: currentUser.user_metadata?.tier || 'standard',
              name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
            };
          }
        } catch (e) {
          // Ìè¥Î∞±: auth.users metadata ÏÇ¨Ïö©
          userProfile = {
            id: currentUser.id,
            email: currentUser.email,
            tier: currentUser.user_metadata?.tier || 'standard',
            name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
          };
        }

        // Ïù∏Ï¶ù ÏÑ±Í≥µ - UI ÏóÖÎç∞Ïù¥Ìä∏ (Îì±Í∏â Ï†úÌïú Ï†úÍ±∞ - ai-design.htmlÏóêÏÑú Î¶¨ÎîîÎ†âÌä∏ Ï≤òÎ¶¨)
        hideAuthOverlay();
        document.getElementById('toolbarUser').textContent = currentUser.email;

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
        const name = userProfile.name || currentUser.email.split('@')[0];
        document.getElementById('navUserAvatar').textContent = name.charAt(0).toUpperCase();
        document.getElementById('navUserName').textContent = name;

        // URLÏóêÏÑú ÏÑ§Í≥Ñ ID ÌôïÏù∏ (ÏàòÏ†ï Î™®Îìú)
        const urlParams = new URLSearchParams(window.location.search);
        const designId = urlParams.get('id');
        if (designId) {
          await loadDesign(designId);
        }

        // ÏûêÎèô Ï†ÄÏû• ÏÑ§Ï†ï (5Î∂ÑÎßàÎã§)
        setupAutoSave();

        // Ïù¥Ï†Ñ ÎåÄÌôî Í∏∞Î°ù Î∂àÎü¨Ïò§Í∏∞
        loadChatHistory();
      }

      // Ïù∏Ï¶ù Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú/Ïà®ÍπÄ
      function showAuthOverlay() {
        document.getElementById('authOverlay').classList.remove('hidden');
        document.getElementById('topToolbar').classList.add('hidden');
      }

      function hideAuthOverlay() {
        document.getElementById('authOverlay').classList.add('hidden');
        document.getElementById('topToolbar').classList.remove('hidden');
      }

      // Î™®Î∞îÏùº Î©îÎâ¥ ÌÜ†Í∏Ä
      function toggleMobileMenu() {
        const hamburger = document.querySelector('.hamburger');
        const mobileMenu = document.getElementById('mobileMenu');
        hamburger.classList.toggle('active');
        mobileMenu.classList.toggle('active');
      }

      // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î°úÍ∑∏ÏïÑÏõÉ
      async function logoutNav() {
        await SupabaseUtils.signOut('index.html');
      }

      // ÏÑ§Í≥Ñ Ï†ÄÏû•
      async function saveDesign() {
        if (!currentUser || !supabaseClient) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
          return;
        }

        if (selectedItems.length === 0) {
          alert('Ï†ÄÏû•Ìï† ÏÑ§Í≥Ñ ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
          return;
        }

        updateSaveStatus('saving', 'Ï†ÄÏû• Ï§ë...');

        try {
          // ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
          const designData = window.DadamAgent.exportDesign();
          const designName = prompt(
            'ÏÑ§Í≥Ñ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:',
            currentDesignId ? 'Í∏∞Ï°¥ ÏÑ§Í≥Ñ' : `ÏÑ§Í≥Ñ_${new Date().toLocaleDateString('ko-KR')}`
          );

          if (!designName) {
            updateSaveStatus('saved', 'Ï†ÄÏû•Îê®');
            return;
          }

          // Ïã†Í∑ú ÎòêÎäî ÏóÖÎç∞Ïù¥Ìä∏
          if (currentDesignId) {
            // Í∏∞Ï°¥ ÏÑ§Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            const { error } = await supabaseClient
              .from('designs')
              .update({
                name: designName,
                total_items: selectedItems.length,
                total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
                app_version: APP_CONFIG.version,
                updated_at: new Date().toISOString(),
              })
              .eq('id', currentDesignId);

            if (error) throw error;

            // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú ÏÇ≠Ï†ú ÌõÑ Ïû¨ÏÇΩÏûÖ
            await supabaseClient.from('design_items').delete().eq('design_id', currentDesignId);

            await saveDesignItems(currentDesignId);
          } else {
            // Ïã†Í∑ú ÏÑ§Í≥Ñ ÏÉùÏÑ±
            const { data: newDesign, error } = await supabaseClient
              .from('designs')
              .insert({
                user_id: currentUser.id,
                name: designName,
                status: 'draft',
                total_items: selectedItems.length,
                total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
                app_version: APP_CONFIG.version,
              })
              .select()
              .single();

            if (error) throw error;

            currentDesignId = newDesign.id;
            await saveDesignItems(currentDesignId);

            // URL ÏóÖÎç∞Ïù¥Ìä∏
            window.history.replaceState({}, '', `?id=${currentDesignId}`);
          }

          // n8n Webhook Ìò∏Ï∂ú (ÏÑ§Ï†ïÎêú Í≤ΩÏö∞)
          if (N8N_WEBHOOK_URL) {
            await sendToN8N(designData);
          }

          hasUnsavedChanges = false;
          updateSaveStatus('saved', 'Ï†ÄÏû•Îê®');
        } catch (error) {
          console.error('Ï†ÄÏû• Ïã§Ìå®:', error);
          updateSaveStatus('error', 'Ï†ÄÏû• Ïã§Ìå®');
          alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        }
      }

      // ÏÑ§Í≥Ñ ÏïÑÏù¥ÌÖú Ï†ÄÏû•
      async function saveDesignItems(designId) {
        const itemsToInsert = selectedItems.map((item, index) => ({
          design_id: designId,
          category: item.category || item.categoryId,
          name: item.name,
          unique_id: Math.floor(item.uniqueId), // bigint Ìò∏ÌôòÏùÑ ÏúÑÌï¥ Ï†ïÏàòÎ°ú Î≥ÄÌôò
          width: item.w,
          height: item.h,
          depth: item.d,
          specs: {
            ...(item.specs || {}),
            imageUrl: (item.imageUrl || item.image) !== 'loading' ? item.imageUrl || item.image || null : null,
          },
          modules: item.modules || [],
          item_order: index,
        }));

        const { error } = await supabaseClient.from('design_items').insert(itemsToInsert);

        if (error) throw error;
      }

      // ÏÑ§Í≥Ñ Î∂àÎü¨Ïò§Í∏∞
      async function loadDesign(designId) {
        try {
          // ÏÑ§Í≥Ñ Î©îÌÉÄ Ï†ïÎ≥¥
          const { data: design, error: designError } = await supabaseClient
            .from('designs')
            .select('*')
            .eq('id', designId)
            .eq('user_id', currentUser.id)
            .single();

          if (designError || !design) {
            throw new Error('ÏÑ§Í≥ÑÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
          }

          // ÏÑ§Í≥Ñ ÏïÑÏù¥ÌÖú
          const { data: items, error: itemsError } = await supabaseClient
            .from('design_items')
            .select('*')
            .eq('design_id', designId)
            .order('item_order');

          if (itemsError) throw itemsError;

          // Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
          currentDesignId = designId;
          selectedItems = items.map((item) => ({
            uniqueId: item.unique_id || Date.now(),
            category: item.category,
            categoryId: item.category,
            name: item.name,
            w: item.width,
            h: item.height,
            d: item.depth,
            specs: item.specs || { ...DEFAULT_SPECS },
            modules: item.modules || [],
            image: item.specs?.imageUrl || item.specs?.image || null,
            imageUrl: item.specs?.imageUrl || item.specs?.image || null,
          }));

          // UI ÏóÖÎç∞Ïù¥Ìä∏
          updateUI();
          updateSaveStatus('saved', 'Î∂àÎü¨Ïò¥');
        } catch (error) {
          console.error('Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
          alert('ÏÑ§Í≥ÑÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        }
      }

      // ÏÑ§Í≥Ñ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ (ÌåùÏóÖ Î™®Îã¨)
      async function loadDesignList() {
        if (!currentUser || !supabaseClient) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
          return;
        }

        try {
          const { data: designs, error } = await supabaseClient
            .from('designs')
            .select('id, name, status, total_items, total_modules, created_at, updated_at')
            .eq('user_id', currentUser.id)
            .order('updated_at', { ascending: false })
            .limit(30);

          if (error) throw error;

          // Î™®Îã¨ ÏÉùÏÑ±
          const modal = document.createElement('div');
          modal.className = 'load-modal-overlay';
          modal.id = 'loadDesignModal';
          modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
          };

          const statusLabels = {
            draft: 'ÏûÑÏãúÏ†ÄÏû•',
            submitted: 'Ï†úÏ∂úÎê®',
            in_review: 'Í≤ÄÌÜ†Ï§ë',
            completed: 'ÏôÑÎ£å',
            feedback_done: 'ÌîºÎìúÎ∞±ÏôÑÎ£å',
          };

          modal.innerHTML = `
      <div class="load-modal">
        <div class="load-modal-header">
          <h3>üìÇ Ï†ÄÏû•Îêú ÏÑ§Í≥Ñ Î∂àÎü¨Ïò§Í∏∞</h3>
          <button class="load-modal-close" onclick="closeLoadModal()">&times;</button>
        </div>
        <div class="load-modal-body">
          ${
            designs.length === 0
              ? `
            <div class="load-modal-empty">
              <div style="font-size:48px;margin-bottom:16px;">üìã</div>
              <p>Ï†ÄÏû•Îêú ÏÑ§Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
            </div>
          `
              : designs
                  .map(
                    (d) => `
            <div class="design-list-item" onclick="selectDesign('${d.id}')">
              <div class="info">
                <div class="name">${d.name || 'Ï†úÎ™© ÏóÜÏùå'}</div>
                <div class="meta">
                  <span>ü™ë ${d.total_items || 0}Í∞ú Í∞ÄÍµ¨</span>
                  <span>üìÖ ${new Date(d.updated_at).toLocaleDateString('ko-KR')}</span>
                  <span class="status ${d.status}">${statusLabels[d.status] || d.status}</span>
                </div>
              </div>
              <button class="delete-btn" onclick="event.stopPropagation();deleteDesignFromList('${d.id}','${(d.name || '').replace(/'/g, "\\'")}')">üóëÔ∏è</button>
            </div>
          `
                  )
                  .join('')
          }
        </div>
      </div>
    `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
          alert('ÏÑ§Í≥Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      }

      // Î∂àÎü¨Ïò§Í∏∞ Î™®Îã¨ Îã´Í∏∞
      function closeLoadModal() {
        const modal = document.getElementById('loadDesignModal');
        if (modal) modal.remove();
      }

      // ÏÑ§Í≥Ñ ÏÑ†ÌÉù (ÏÉà Ï∞ΩÏúºÎ°ú Ïó¥Í∏∞)
      function selectDesign(designId) {
        closeLoadModal();
        window.open(`detaildesign.html?id=${designId}`, '_blank');
      }

      // ÏÑ§Í≥Ñ ÏÇ≠Ï†ú (Î™©Î°ùÏóêÏÑú)
      async function deleteDesignFromList(designId, designName) {
        if (!confirm(`"${designName}" ÏÑ§Í≥ÑÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†úÎêú ÏÑ§Í≥ÑÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`)) return;

        try {
          const { error } = await supabaseClient
            .from('designs')
            .delete()
            .eq('id', designId)
            .eq('user_id', currentUser.id);

          if (error) throw error;

          // Î™®Îã¨ÏóêÏÑú Ìï¥Îãπ Ìï≠Î™© Ï†úÍ±∞
          const item = document.querySelector(`.design-list-item[onclick*="${designId}"]`);
          if (item) item.remove();

          // Î™©Î°ùÏù¥ ÎπÑÏóàÏúºÎ©¥ Îπà ÏÉÅÌÉú ÌëúÏãú
          const body = document.querySelector('.load-modal-body');
          if (body && !body.querySelector('.design-list-item')) {
            body.innerHTML = `
        <div class="load-modal-empty">
          <div style="font-size:48px;margin-bottom:16px;">üìã</div>
          <p>Ï†ÄÏû•Îêú ÏÑ§Í≥ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
        </div>
      `;
          }

          // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ ÏÑ§Í≥ÑÍ∞Ä ÏÇ≠Ï†úÎêú Í≤ΩÏö∞
          if (currentDesignId === designId) {
            currentDesignId = null;
            hasUnsavedChanges = true;
          }
        } catch (error) {
          console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', error);
          alert('ÏÑ§Í≥Ñ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      }

      // ÏÑ§Í≥Ñ Ï†úÏ∂ú (Í≤ÄÌÜ† ÏöîÏ≤≠)
      async function submitDesign() {
        if (!currentDesignId) {
          alert('Î®ºÏ†Ä ÏÑ§Í≥ÑÎ•º Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        if (!confirm('ÏÑ§Í≥ÑÎ•º Ï†úÏ∂úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏ†úÏ∂ú ÌõÑÏóêÎèÑ ÏàòÏ†ïÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.')) return;

        try {
          const { error } = await supabaseClient
            .from('designs')
            .update({
              status: 'submitted',
              submitted_at: new Date().toISOString(),
            })
            .eq('id', currentDesignId);

          if (error) throw error;

          // n8nÏúºÎ°ú Ï†úÏ∂ú ÏïåÎ¶º
          if (N8N_WEBHOOK_URL) {
            const designData = window.DadamAgent.exportDesign();
            await sendToN8N({ ...designData, action: 'submit', designId: currentDesignId });
          }

          alert('ÏÑ§Í≥ÑÍ∞Ä Ï†úÏ∂úÎêòÏóàÏäµÎãàÎã§.');
        } catch (error) {
          console.error('Ï†úÏ∂ú Ïã§Ìå®:', error);
          alert('Ï†úÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        }
      }

      // n8n Webhook Ï†ÑÏÜ°
      async function sendToN8N(data) {
        if (!N8N_WEBHOOK_URL) return;

        try {
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              timestamp: new Date().toISOString(),
              userId: currentUser.id,
              userEmail: currentUser.email,
              designId: currentDesignId,
              appVersion: APP_CONFIG.version,
              data: data,
            }),
          });

          if (!response.ok) {
            console.warn('n8n Webhook ÏùëÎãµ Ïò§Î•ò:', response.status);
          }
        } catch (error) {
          console.warn('n8n Webhook Ï†ÑÏÜ° Ïã§Ìå®:', error);
        }
      }

      // Ï†ÄÏû• ÏÉÅÌÉú UI ÏóÖÎç∞Ïù¥Ìä∏
      function updateSaveStatus(status, text) {
        const statusEl = document.getElementById('saveStatus');
        const iconEl = document.getElementById('saveStatusIcon');
        const textEl = document.getElementById('saveStatusText');

        statusEl.classList.remove('hidden', 'saving', 'saved', 'error');
        statusEl.classList.add(status);

        if (status === 'saving') {
          iconEl.textContent = '‚è≥';
        } else if (status === 'saved') {
          iconEl.textContent = '‚úì';
        } else if (status === 'error') {
          iconEl.textContent = '‚úï';
        }

        textEl.textContent = text;
      }

      // ÏûêÎèô Ï†ÄÏû• ÏÑ§Ï†ï
      function setupAutoSave() {
        // Î≥ÄÍ≤Ω Í∞êÏßÄ
        const originalUpdateUI = window.updateUI;
        window.updateUI = function () {
          if (originalUpdateUI) originalUpdateUI.apply(this, arguments);
          hasUnsavedChanges = true;
          updateSaveStatus('saving', 'ÏàòÏ†ïÎê®');
        };

        // 5Î∂ÑÎßàÎã§ ÏûêÎèô Ï†ÄÏû•
        autoSaveTimer = setInterval(
          () => {
            if (hasUnsavedChanges && currentDesignId) {
              console.log('ÏûêÎèô Ï†ÄÏû• Ïã§Ìñâ...');
              // ÏûêÎèô Ï†ÄÏû•ÏùÄ Ï°∞Ïö©Ìûà Ïã§Ìñâ
              saveDesignQuiet();
            }
          },
          5 * 60 * 1000
        );

        // ÌéòÏù¥ÏßÄ Îñ†ÎÇ† Îïå Í≤ΩÍ≥†
        window.addEventListener('beforeunload', (e) => {
          if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
          }
        });
      }

      // Ï°∞Ïö©Ìïú Ï†ÄÏû• (ÌîÑÎ°¨ÌîÑÌä∏ ÏóÜÏù¥)
      async function saveDesignQuiet() {
        if (!currentUser || !supabaseClient || !currentDesignId) return;

        try {
          await supabaseClient
            .from('designs')
            .update({
              total_items: selectedItems.length,
              total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
              updated_at: new Date().toISOString(),
            })
            .eq('id', currentDesignId);

          await supabaseClient.from('design_items').delete().eq('design_id', currentDesignId);

          await saveDesignItems(currentDesignId);

          hasUnsavedChanges = false;
          updateSaveStatus('saved', 'ÏûêÎèô Ï†ÄÏû•Îê®');
        } catch (error) {
          console.error('ÏûêÎèô Ï†ÄÏû• Ïã§Ìå®:', error);
        }
      }

      // ============================================================
      // AI Ï±ÑÌåÖ ÏãúÏä§ÌÖú
      // ============================================================
      function toggleAIChat() {
        const panel = document.getElementById('aiChatPanel');
        const btn = document.getElementById('aiChatToggle');
        if (panel.style.display === 'none' || !panel.style.display) {
          panel.style.display = 'flex';
          btn.innerHTML = '‚úï';
          btn.style.background = '#2D2A26';
        } else {
          panel.style.display = 'none';
          btn.innerHTML = 'üí¨ AI ÏÉÅÎã¥';
          btn.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
        }
      }

      async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú Î∞è Ï†ÄÏû•
        addChatMessage(message, true);
        input.value = '';

        // Î°úÎî© ÌëúÏãú
        const loadingId = 'loading-' + Date.now();
        addChatMessage(
          '<div style="display:flex;align-items:center;gap:8px;"><span class="chat-loading"></span> ÏùëÎãµ Ï§ë...</div>',
          false,
          loadingId,
          false
        );

        // ÌòÑÏû¨ ÏÑ§Í≥Ñ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®
        const design = window.DadamAgent?.exportDesign() || { items: [] };

        try {
          const response = await fetch(N8N_CHAT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: message,
              context: {
                page: 'detaildesign',
                designData: design,
                itemCount: design.items?.length || 0,
              },
            }),
          });

          // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
          const loadingMsg = document.getElementById(loadingId);
          if (loadingMsg) loadingMsg.remove();

          const data = await response.json();
          const aiResponse = data.response || data.output || 'ÏùëÎãµÏùÑ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.';
          addChatMessage(aiResponse, false);
        } catch (error) {
          // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
          const loadingMsg = document.getElementById(loadingId);
          if (loadingMsg) loadingMsg.remove();
          addChatMessage('Ï£ÑÏÜ°Ìï©ÎãàÎã§. Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', false);
        }
      }

      function addChatMessage(text, isUser, msgId, shouldSave = true) {
        const container = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        if (msgId) msg.id = msgId;
        msg.className = `chat-msg ${isUser ? 'user' : 'ai'}`;
        msg.innerHTML = text;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;

        // DBÏóê Ï†ÄÏû• (shouldSaveÍ∞Ä trueÏùº ÎïåÎßå)
        if (shouldSave && !msgId) {
          saveChatMessage(text, isUser ? 'user' : 'assistant');
        }
      }

      // ============================================================
      // ÏµúÏ†ÅÌôî: Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ Ìï∏Îì§Îü¨
      // ============================================================

      function setupEventDelegation() {
        const workspace = document.getElementById('step2-content');
        if (!workspace) return;

        // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
        workspace.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-action]');
          if (!btn) return;

          const { action, item, mod, field, delta, value } = btn.dataset;
          const itemId = parseInt(item);
          const modId = parseInt(mod);

          switch (action) {
            case 'adjust':
              adjustModuleValue(itemId, modId, field, parseInt(delta));
              break;
            case 'setType':
              setModuleType(itemId, modId, field, value);
              break;
            case 'toggle':
              toggleModuleOption(
                itemId,
                modId,
                field,
                btn.checked !== undefined ? btn.checked : !btn.classList.contains('active')
              );
              break;
            // Wardrobe Ï†ÑÏö© Ïï°ÏÖò
            case 'moveWdrb':
              moveWardrobeModule(itemId, modId, btn.dataset.dir);
              break;
            case 'setWdrbType':
              setWardrobeModuleType(itemId, modId, btn.dataset.type);
              break;
            case 'removeWdrb':
              removeWardrobeModule(itemId, modId);
              break;
            case 'setDrawerType':
              toggleWardrobeDrawerType(itemId, modId, btn.dataset.value === 'true');
              break;
          }
        });

        // Change Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ (input, select)
        workspace.addEventListener('change', (e) => {
          const input = e.target;
          if (!input.dataset.item) return;

          const { item, mod, field } = input.dataset;
          const itemId = parseInt(item);
          const modId = mod ? parseInt(mod) : null;
          const value = input.type === 'checkbox' ? input.checked : input.value;

          if (modId) {
            updateModuleField(itemId, modId, field, value);
          } else if (field) {
            updateItemSpec(itemId, field, value);
          }
        });

        // Input Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ (Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏)
        workspace.addEventListener('input', (e) => {
          const input = e.target;
          if (!input.dataset.item || input.type === 'checkbox') return;

          // ÎîîÎ∞îÏö¥Ïä§ Ï≤òÎ¶¨
          clearTimeout(input._debounceTimer);
          input._debounceTimer = setTimeout(() => {
            const { item, mod, field } = input.dataset;
            const itemId = parseInt(item);
            const modId = mod ? parseInt(mod) : null;

            if (modId) {
              updateModuleField(itemId, modId, field, input.value, false);
            } else if (field) {
              updateItemSpec(itemId, field, input.value, false);
            }
          }, 300);
        });
      }

      // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
      document.addEventListener('DOMContentLoaded', () => {
        initAuth();
        setupEventDelegation();
      });
    </script>

    <!-- AI Ï±ÑÌåÖ ÌÜ†Í∏Ä Î≤ÑÌäº -->
    <button
      id="aiChatToggle"
      onclick="toggleAIChat()"
      style="
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        padding: 14px 24px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
        border: none;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        transition: all 0.3s;
      "
    >
      üí¨ AI ÏÉÅÎã¥
    </button>

    <!-- AI Ï±ÑÌåÖ Ìå®ÎÑê -->
    <div
      id="aiChatPanel"
      style="
        display: none;
        position: fixed;
        bottom: 90px;
        right: 24px;
        width: 360px;
        height: 500px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
        flex-direction: column;
        z-index: 1000;
        overflow: hidden;
      "
    >
      <div
        style="
          padding: 18px 20px;
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          color: #fff;
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <span style="font-weight: 600; font-size: 15px">ü§ñ Îã§Îã¥ AI ÏÑ§Í≥Ñ ÏÉÅÎã¥</span>
        <button
          onclick="toggleAIChat()"
          style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; line-height: 1"
        >
          ‚úï
        </button>
      </div>
      <div
        id="chatMessages"
        style="flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px"
      >
        <div class="chat-msg ai">
          ÏïàÎÖïÌïòÏÑ∏Ïöî! ÏÑ§Í≥ÑÏóê ÎåÄÌï¥ Í∂ÅÍ∏àÌïú Ï†êÏù¥ ÏûàÏúºÏãúÎ©¥ Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî.<br />
          ÌòÑÏû¨ ÏÑ§Í≥ÑÎ•º Î∂ÑÏÑùÌïòÏó¨ Í∞úÏÑ† Ï†úÏïàÎèÑ ÎìúÎ¶¥ Ïàò ÏûàÏäµÎãàÎã§.
        </div>
      </div>
      <div style="display: flex; padding: 12px 16px; border-top: 1px solid #ebe8e2; gap: 10px">
        <input
          type="text"
          id="chatInput"
          placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
          style="
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ebe8e2;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
          "
          onkeypress="if (event.key === 'Enter') sendChatMessage();"
        />
        <button
          onclick="sendChatMessage()"
          style="
            padding: 12px 20px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
          "
        >
          Ï†ÑÏÜ°
        </button>
      </div>
    </div>

    <style>
      .chat-msg {
        padding: 12px 16px;
        border-radius: 14px;
        max-width: 85%;
        line-height: 1.5;
        font-size: 14px;
      }
      .chat-msg.ai {
        background: #f8f7f4;
        color: #2d2a26;
        align-self: flex-start;
      }
      .chat-msg.user {
        background: #2d2a26;
        color: #fff;
        align-self: flex-end;
      }
      .chat-loading {
        width: 20px;
        height: 20px;
        border: 2px solid #ebe8e2;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
    </style>
  </body>
</html>
