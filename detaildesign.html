<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹¤ë‹´ ìºë¹„ë„· ì—ì´ì „íŠ¸ - v33.0 (ìì¬ì¶”ì¶œ ì‹œìŠ¤í…œ ê°œì„ )</title>
    <style>
      :root {
        /* ê¸°ë³¸ ìƒ‰ìƒ */
        --primary-color: #4a7dff;
        --bg-color: #f4f6f8;
        --card-bg: #ffffff;
        --text-color: #333;
        --text-muted: #666;
        --border-color: #ddd;

        /* ìƒíƒœ ìƒ‰ìƒ */
        --danger-color: #ff4d4f;
        --success-color: #00c853;
        --warning-color: #f59e0b;

        /* ê°€êµ¬ íƒ€ì…ë³„ ìƒ‰ìƒ */
        --upper-color: #5b8def;
        --lower-color: #f59e0b;
        --tall-color: #10b981;
        --fridge-color: #0ea5e9;
        --wardrobe-color: #10b981;
        --homecafe-color: #8b5cf6;
        --sink-color: #3b82f6;

        /* ë ˆì´ì•„ì›ƒ */
        --border-radius: 12px;
        --border-radius-sm: 6px;
        --border-radius-xs: 4px;

        /* ê°„ê²© */
        --gap-xs: 4px;
        --gap-sm: 8px;
        --gap-md: 12px;
        --gap-lg: 16px;
        --gap-xl: 24px;

        /* í°íŠ¸ í¬ê¸° */
        --font-xs: 9px;
        --font-sm: 11px;
        --font-md: 13px;
        --font-lg: 15px;

        /* ê·¸ë¦¼ì */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
      }
      * {
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      body {
        margin: 0;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
      }
      .app-container {
        max-width: 1100px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 30px;
        min-height: 80vh;
      }
      h1 {
        text-align: center;
        font-size: 24px;
        margin-bottom: 10px;
      }
      .subtitle {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
      }
      .stepper-indicator {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
      }
      .step-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #eee;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }
      .step-dot.active {
        background: var(--primary-color);
        color: white;
      }
      .section-label {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .badge {
        background: #eef2ff;
        color: var(--primary-color);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
      }
      label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
        display: block;
      }
      input[type='number'],
      input[type='text'],
      select {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 100%;
        font-size: 13px;
        outline: none;
      }
      input:focus,
      select:focus {
        border-color: var(--primary-color);
      }
      .btn-next {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 999px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-next:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .btn-back {
        background: white;
        border: 1px solid #ddd;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin-bottom: 30px;
      }
      .category-card {
        background: #fafafa;
        border: 2px solid transparent;
        border-radius: var(--border-radius);
        height: 100px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .category-card:hover {
        background: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .category-card.active {
        border-color: var(--primary-color);
        background: #f4f8ff;
      }
      .category-name {
        font-size: 15px;
        font-weight: 600;
        color: #555;
        transition: transform 0.3s;
      }
      .category-card.active .category-name {
        transform: translateY(-15px);
        color: var(--primary-color);
      }
      .card-stepper {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        transform: translateY(100%);
        transition: transform 0.3s;
      }
      .category-card.active .card-stepper {
        transform: translateY(0);
      }
      .stepper-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        width: 30px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .stepper-count {
        color: white;
        font-weight: bold;
        font-size: 16px;
      }
      #detailInputSection {
        display: none;
        background: #f9fafb;
        padding: 24px;
        border-radius: var(--border-radius);
        border: 1px solid #eee;
        margin-top: 20px;
      }
      .ai-guide-box {
        background: #fff;
        border-left: 4px solid var(--primary-color);
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .item-input-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }
      .item-body {
        display: flex;
        gap: 12px;
      }
      .input-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .input-row {
        display: flex;
        gap: 8px;
      }
      .input-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .extra-settings {
        background: #f8f9fa;
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .extra-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--primary-color);
      }
      .photo-section {
        width: 90px;
        flex-shrink: 0;
      }
      .photo-box {
        background: #f0f0f0;
        border: 1px dashed #ccc;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #888;
        font-size: 10px;
        min-height: 80px;
        position: relative;
        overflow: hidden;
      }
      .photo-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
      }
      .file-input-hidden {
        display: none;
      }
      .btn-delete {
        background: transparent;
        color: #999;
        border: none;
        font-size: 18px;
        cursor: pointer;
      }
      #step2-content {
        display: none;
      }
      .bookmark-tabs {
        display: flex;
        gap: 4px;
        border-bottom: 2px solid var(--primary-color);
        padding-top: 5px;
      }
      .bookmark-tab {
        padding: 10px 20px;
        background: #eef2f6;
        color: #888;
        border-radius: 10px 10px 0 0;
        border: 1px solid #ddd;
        border-bottom: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        top: 2px;
      }
      .bookmark-tab.active {
        background: #fff;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        border-bottom: 2px solid #fff;
        z-index: 10;
      }
      .design-workspace {
        background: #fff;
        border: 2px solid var(--primary-color);
        border-top: none;
        border-radius: 0 0 12px 12px;
        padding: 20px;
        min-height: 500px;
      }
      .ws-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      .ws-title {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .ws-info-badge {
        font-size: 13px;
        color: #666;
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .ws-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
      }
      .spec-panel {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #eee;
        max-height: 700px;
        overflow-y: auto;
      }
      .spec-group-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 15px 0 8px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 4px;
      }
      .spec-group-title:first-child {
        margin-top: 0;
      }
      .spec-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .spec-field {
        flex: 1;
      }
      .color-select-row {
        display: flex;
        gap: 4px;
      }
      .color-select-row select {
        width: 50%;
        font-size: 12px;
      }
      .acc-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 6px;
      }
      .acc-item {
        display: flex;
        gap: 4px;
      }
      .btn-add-acc {
        width: 100%;
        padding: 6px;
        background: #fff;
        border: 1px dashed #ccc;
        color: #666;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
      }
      .btn-del-acc {
        color: #ccc;
        border: 1px solid #eee;
        background: white;
        border-radius: 4px;
        width: 24px;
        cursor: pointer;
      }
      .module-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .module-section {
        margin-bottom: 16px;
      }
      .module-section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        padding: 10px 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 700;
      }
      .module-section-header.upper {
        background: linear-gradient(135deg, #e0ecff 0%, #f0f5ff 100%);
        color: var(--upper-color);
        border-left: 4px solid var(--upper-color);
      }
      .module-section-header.lower {
        background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
        color: var(--lower-color);
        border-left: 4px solid var(--lower-color);
      }
      .section-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      .section-info-row {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        margin-top: 6px;
        font-size: 11px;
      }
      .effective-space-group {
        display: flex;
        align-items: center;
        gap: 4px;
        background: rgba(255, 255, 255, 0.7);
        padding: 3px 8px;
        border-radius: 4px;
      }
      .effective-space-group label {
        font-size: 10px;
        color: #666;
        margin: 0;
      }
      .effective-space-input {
        width: 70px;
        padding: 3px 6px;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 3px;
        text-align: center;
      }
      .section-remaining {
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.7);
        padding: 3px 8px;
        border-radius: 4px;
      }
      .section-buttons {
        display: flex;
        gap: 4px;
        margin-left: auto;
      }
      .btn-section-undo,
      .btn-section-auto {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-section-undo {
        background: #f0f0f0;
        border: 1px solid #ccc;
        color: #666;
      }
      .btn-section-undo:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .btn-section-auto {
        background: white;
        border: 1px solid currentColor;
      }
      .module-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-height: 80px;
        padding: 8px;
        background: #fafafa;
        border-radius: 6px;
        border: 2px dashed #ddd;
      }
      .module-list.empty-list::before {
        content: '+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¥ì„ ì¶”ê°€í•˜ì„¸ìš”';
        color: #aaa;
        font-size: 12px;
        text-align: center;
        display: block;
        padding: 20px;
      }
      .module-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 10px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        position: relative;
      }
      .module-card:hover {
        border-color: #bbb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .module-card.tall-type {
        border-left: 3px solid var(--tall-color);
        background: linear-gradient(90deg, #ecfdf5 0%, white 20%);
      }
      .module-card.fixed-module {
        border-left: 3px solid var(--primary-color);
        background: linear-gradient(90deg, #e8f4ff 0%, white 20%);
      }
      .module-card.fixed-module::after {
        content: 'ê³ ì •';
        position: absolute;
        top: 4px;
        right: 28px;
        font-size: 9px;
        color: var(--primary-color);
        background: #e8f4ff;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .module-card.base-module {
        border-left: 3px solid #9333ea;
        background: linear-gradient(90deg, #f3e8ff 0%, white 20%);
      }
      .module-card.base-module::after {
        content: 'ê¸°ì¤€';
        position: absolute;
        top: 4px;
        right: 28px;
        font-size: 9px;
        color: #9333ea;
        background: #f3e8ff;
        padding: 1px 4px;
        border-radius: 3px;
      }
      .move-buttons {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .btn-move {
        width: 24px;
        height: 20px;
        border: 1px solid #ddd;
        background: #f8f8f8;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
      }
      .btn-move:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .btn-move:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      .module-icon {
        width: 32px;
        height: 32px;
        background: #f4f6f8;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
      }
      .module-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .module-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .module-title {
        font-size: 13px;
        font-weight: 600;
      }
      .module-type-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 3px;
        background: var(--tall-color);
        color: white;
      }
      .module-dims {
        display: flex;
        gap: 6px;
        margin-top: 2px;
        flex-wrap: wrap;
      }
      .dim-group {
        display: flex;
        align-items: center;
        gap: 2px;
        background: #fafafa;
        padding: 1px 4px;
        border-radius: 4px;
        border: 1px solid #eee;
      }
      .dim-label {
        font-size: 10px;
        color: #888;
        font-weight: 600;
        margin: 0;
      }
      .dim-input {
        width: 40px;
        padding: 2px 4px;
        font-size: 11px;
        border: none;
        background: transparent;
        text-align: center;
      }
      .dim-input:focus {
        outline: none;
        color: var(--primary-color);
        background: #fff;
      }
      .module-options {
        display: flex;
        gap: 8px;
        margin-top: 4px;
        flex-wrap: wrap;
      }
      .module-chk {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 11px;
        color: #666;
        cursor: pointer;
      }
      .module-chk input {
        margin: 0;
        transform: scale(0.9);
      }
      .btn-delete-module {
        color: #ccc;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 0 4px;
        margin-left: auto;
      }
      .btn-delete-module:hover {
        color: var(--danger-color);
      }
      .module-btn-group {
        display: flex;
        gap: 6px;
        margin-top: 8px;
      }
      .btn-add-split {
        flex: 1;
        padding: 8px;
        background: #fff;
        border: 1px dashed #ccc;
        color: #666;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
      }
      .btn-add-split:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: #f4f8ff;
      }
      .btn-add-upper {
        border-color: var(--upper-color);
        color: var(--upper-color);
      }
      .btn-add-lower {
        border-color: var(--lower-color);
        color: var(--lower-color);
      }
      .btn-add-tall {
        border-color: var(--tall-color);
        color: var(--tall-color);
      }

      /* ìµœì í™”: ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .btn-toggle {
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 10px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        transition: all 0.15s;
      }
      .btn-toggle:hover {
        opacity: 0.8;
      }
      .btn-toggle.active {
        border-color: currentColor;
      }
      .btn-toggle.green {
        color: var(--tall-color);
      }
      .btn-toggle.green.active {
        background: #ecfdf5;
        border-color: var(--tall-color);
      }
      .btn-toggle.blue {
        color: var(--sink-color);
      }
      .btn-toggle.blue.active {
        background: #eff6ff;
        border-color: var(--sink-color);
      }
      .btn-toggle.orange {
        color: var(--lower-color);
      }
      .btn-toggle.orange.active {
        background: #fef3c7;
        border-color: var(--lower-color);
      }
      .btn-toggle.purple {
        color: #8b5cf6;
      }
      .btn-toggle.purple.active {
        background: #f3e8ff;
        border-color: #8b5cf6;
      }

      .btn-adjust {
        width: 20px;
        height: 20px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        background: var(--card-bg);
        cursor: pointer;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }
      .btn-adjust:hover {
        background: #f0f0f0;
      }
      .btn-adjust:active {
        background: #e0e0e0;
      }

      .btn-purple-gradient {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        transition: all 0.2s;
      }
      .btn-purple-gradient:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .adjust-control {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
      }
      .adjust-control .value {
        min-width: 20px;
        text-align: center;
        font-weight: 600;
      }

      .toggle-group {
        display: flex;
        gap: 2px;
      }

      .spec-input-sm {
        width: 50px;
        padding: 3px 4px;
        font-size: 11px;
        border: 1px solid var(--border-color);
        border-radius: 3px;
        text-align: center;
      }
      .spec-input-sm:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
      }
      .checkbox-label input {
        margin: 0;
        transform: scale(0.9);
      }

      /* ìµœì í™”: Wardrobe ëª¨ë“ˆ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .wm-card {
        display: flex;
        gap: 8px;
        padding: 10px;
        align-items: flex-start;
      }
      .wm-left {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 50px;
      }
      .wm-move-btns {
        display: flex;
        gap: 2px;
        margin-bottom: 2px;
      }
      .wm-type-btn {
        font-size: 8px;
        padding: 3px 2px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
      }
      .wm-type-btn.short {
        color: var(--tall-color);
      }
      .wm-type-btn.short.active {
        border-color: var(--tall-color);
        background: #ecfdf5;
      }
      .wm-type-btn.long {
        color: var(--sink-color);
      }
      .wm-type-btn.long.active {
        border-color: var(--sink-color);
        background: #eff6ff;
      }
      .wm-type-btn.shelf {
        color: var(--lower-color);
      }
      .wm-type-btn.shelf.active {
        border-color: var(--lower-color);
        background: #fffbeb;
      }
      .wm-center {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .wm-header {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .wm-icon {
        font-size: 14px;
      }
      .wm-name {
        font-weight: 600;
        color: #333;
        font-size: 13px;
      }
      .wm-badge {
        font-size: 9px;
        padding: 1px 5px;
        border-radius: 3px;
      }
      .wm-badge.short {
        background: #ecfdf5;
        color: var(--tall-color);
      }
      .wm-badge.long {
        background: #eff6ff;
        color: var(--sink-color);
      }
      .wm-badge.shelf {
        background: #fffbeb;
        color: var(--lower-color);
      }
      .wm-section {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 5px;
      }
      .wm-section.upper {
        background: #ecfdf5;
        border: 1px solid var(--tall-color);
      }
      .wm-section.lower {
        background: #eff6ff;
        border: 1px solid var(--sink-color);
      }
      .wm-section.full {
        background: #f0f7ff;
        border: 1px solid var(--primary-color);
      }
      .wm-section-label {
        font-size: 10px;
        font-weight: 700;
        min-width: 38px;
      }
      .wm-section.upper .wm-section-label {
        color: var(--tall-color);
      }
      .wm-section.lower .wm-section-label {
        color: var(--sink-color);
      }
      .wm-section.full .wm-section-label {
        color: var(--primary-color);
      }
      .wm-dim-label {
        font-size: 10px;
        color: var(--text-muted);
      }
      .wm-dim-input {
        width: 52px;
        padding: 3px 4px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
      }
      .wm-sett-btn {
        padding: 2px 5px;
        font-size: 9px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        margin-left: auto;
      }
      .wm-drawer-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3px 5px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
      }
      .wm-drawer-label {
        font-size: 8px;
        color: var(--text-muted);
        margin-bottom: 2px;
      }
      .wm-drawer-btns {
        display: flex;
        gap: 1px;
      }
      .wm-drawer-btn {
        padding: 1px 3px;
        font-size: 8px;
        border-radius: 2px;
        cursor: pointer;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-muted);
      }
      .wm-drawer-btn.active {
        border-color: var(--sink-color);
        background: #eff6ff;
        color: var(--sink-color);
      }

      @media (max-width: 800px) {
        .ws-layout {
          grid-template-columns: 1fr;
        }
      }

      /* ì¸ì¦ ì˜¤ë²„ë ˆì´ */
      .auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .auth-modal {
        background: white;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        max-width: 400px;
      }
      .auth-modal h2 {
        font-size: 24px;
        margin-bottom: 16px;
      }
      .auth-modal p {
        color: #666;
        margin-bottom: 24px;
      }
      .auth-modal .btn-login {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 14px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }
      .auth-modal .btn-login:hover {
        opacity: 0.9;
      }

      /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
      .nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1001;
        padding: 0 48px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(10px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .nav-logo {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #2d2a26;
        text-decoration: none;
      }
      .nav-logo svg {
        width: 28px;
        height: 28px;
      }
      .nav-logo span {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
      }
      .nav-menu {
        display: flex;
        gap: 28px;
      }
      .nav-menu a {
        color: #2d2a26;
        font-size: 13px;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        text-decoration: none;
      }
      .nav-menu a:hover {
        opacity: 0.7;
      }
      .nav-menu a.active {
        color: #b8956c;
        font-weight: 500;
      }
      .nav-icons {
        display: flex;
        align-items: center;
        gap: 20px;
        color: #2d2a26;
      }
      .user-menu {
        position: relative;
      }
      .user-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        background: #f8f7f4;
        border: none;
        color: inherit;
        cursor: pointer;
        transition: all 0.3s;
      }
      .user-btn:hover {
        background: #ebe8e2;
      }
      .user-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #b8956c;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: #fff;
      }
      .user-name {
        font-size: 13px;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .user-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 180px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s;
        z-index: 200;
      }
      .user-menu:hover .user-dropdown {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }
      .user-dropdown a,
      .user-dropdown button {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        color: #2d2a26;
        background: none;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
        text-align: left;
        text-decoration: none;
      }
      .user-dropdown a:hover,
      .user-dropdown button:hover {
        background: #f8f7f4;
      }
      .user-dropdown svg {
        width: 18px;
        height: 18px;
        color: #8b8680;
      }
      .hamburger {
        display: none;
        flex-direction: column;
        gap: 5px;
        padding: 8px;
        cursor: pointer;
        background: none;
        border: none;
      }
      .hamburger span {
        width: 24px;
        height: 2px;
        background: #2d2a26;
        border-radius: 2px;
        transition: all 0.3s;
      }
      .mobile-menu {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 1000;
        padding: 24px;
        display: none;
        flex-direction: column;
        gap: 8px;
      }
      .mobile-menu.active {
        display: flex;
      }
      .mobile-menu a {
        padding: 16px 20px;
        font-size: 16px;
        border-radius: 12px;
        transition: background 0.3s;
        text-decoration: none;
        color: #2d2a26;
      }
      .mobile-menu a:hover,
      .mobile-menu a.active {
        background: #f8f7f4;
        color: #b8956c;
      }
      @media (max-width: 768px) {
        .nav {
          padding: 0 16px;
          height: 56px;
        }
        .nav-menu {
          display: none;
        }
        .hamburger {
          display: flex;
        }
      }

      /* ìƒë‹¨ íˆ´ë°” */
      .top-toolbar {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      @media (max-width: 768px) {
        .top-toolbar {
          top: 56px;
        }
      }
      .toolbar-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .toolbar-logo {
        font-weight: 700;
        font-size: 16px;
        color: #333;
        text-decoration: none;
      }
      .toolbar-user {
        font-size: 13px;
        color: #666;
      }
      .toolbar-right {
        display: flex;
        gap: 8px;
      }
      .btn-toolbar {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid #ddd;
        background: white;
        transition: all 0.2s;
      }
      .btn-toolbar:hover {
        background: #f5f5f5;
      }
      .btn-toolbar.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .btn-toolbar.primary:hover {
        opacity: 0.9;
      }
      .btn-toolbar.success {
        background: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      /* ì €ì¥ ìƒíƒœ í‘œì‹œ */
      .save-status {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .save-status.saving {
        background: #fef3c7;
        color: #92400e;
      }
      .save-status.saved {
        background: #dcfce7;
        color: #166534;
      }
      .save-status.error {
        background: #fee2e2;
        color: #dc2626;
      }

      /* ë°”ë”” íŒ¨ë”© ì¡°ì • (ë„¤ë¹„ê²Œì´ì…˜ 64px + íˆ´ë°” 50px) */
      body.has-toolbar {
        padding-top: 120px;
      }
      @media (max-width: 768px) {
        body.has-toolbar {
          padding-top: 112px;
        }
      }

      /* ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ */
      .load-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .load-modal {
        background: #fff;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .load-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #eee;
      }
      .load-modal-header h3 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .load-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      .load-modal-close:hover {
        color: #333;
      }
      .load-modal-body {
        max-height: 400px;
        overflow-y: auto;
        padding: 0;
      }
      .load-modal-empty {
        padding: 60px 24px;
        text-align: center;
        color: #888;
      }
      .design-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }
      .design-list-item:hover {
        background: #f8f9fa;
      }
      .design-list-item .info {
        flex: 1;
      }
      .design-list-item .name {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 4px;
        color: #333;
      }
      .design-list-item .meta {
        font-size: 12px;
        color: #888;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .design-list-item .status {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
      }
      .design-list-item .status.draft {
        background: #fff3cd;
        color: #856404;
      }
      .design-list-item .status.submitted {
        background: #cce5ff;
        color: #004085;
      }
      .design-list-item .status.completed {
        background: #d4edda;
        color: #155724;
      }
      .design-list-item .delete-btn {
        padding: 8px;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 16px;
      }
      .design-list-item:hover .delete-btn {
        opacity: 1;
      }

      .hidden {
        display: none !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-utils.js"></script>
  </head>
  <body class="has-toolbar">
    <!-- Navigation -->
    <nav class="nav">
      <a href="index.html" class="nav-logo">
        <svg viewBox="0 0 40 40" fill="currentColor">
          <path d="M20 4L4 12v16l16 8 16-8V12L20 4zm0 4l12 6-12 6-12-6 12-6zm-12 10l12 6 12-6v8l-12 6-12-6v-8z" />
        </svg>
        <span>ë‹¤ë‹´</span>
      </a>
      <div class="nav-menu">
        <a href="index.html">í™ˆ</a>
        <a href="ai-design.html">AI ì„¤ê³„</a>
        <a href="consultation.html">ìƒë‹´ ì‹ ì²­</a>
      </div>
      <div class="nav-icons">
        <div class="user-menu" id="navUserMenu">
          <button class="user-btn">
            <div class="user-avatar" id="navUserAvatar">?</div>
            <span class="user-name" id="navUserName">ì‚¬ìš©ì</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6" />
            </svg>
          </button>
          <div class="user-dropdown">
            <a href="mypage.html"
              ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" /></svg
              >ë§ˆì´í˜ì´ì§€</a
            >
            <a href="my-designs.html"
              ><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" /></svg
              >ë‚´ ì„¤ê³„</a
            >
            <button onclick="logoutNav()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" /></svg
              >ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>
        <button class="hamburger" onclick="toggleMobileMenu()">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
      <a href="index.html">í™ˆ</a>
      <a href="ai-design.html">AI ì„¤ê³„</a>
      <a href="consultation.html">ìƒë‹´ ì‹ ì²­</a>
      <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a href="my-designs.html">ë‚´ ì„¤ê³„</a>
      <a
        href="#"
        onclick="
          logoutNav();
          return false;
        "
        style="color: #8b8680; margin-top: 16px; border-top: 1px solid #ebe8e2; padding-top: 24px"
        >ë¡œê·¸ì•„ì›ƒ</a
      >
    </div>

    <!-- ì¸ì¦ ì˜¤ë²„ë ˆì´ (ë¡œê·¸ì¸ ì•ˆë¨) -->
    <div class="auth-overlay" id="authOverlay">
      <div class="auth-modal">
        <h2>ğŸ”’ ë¡œê·¸ì¸ í•„ìš”</h2>
        <p>ìƒì„¸ ì„¤ê³„ ë„êµ¬ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <button class="btn-login" onclick="location.href = 'login.html'">ë¡œê·¸ì¸í•˜ê¸°</button>
      </div>
    </div>

    <!-- ìƒë‹¨ íˆ´ë°” -->
    <div class="top-toolbar" id="topToolbar">
      <div class="toolbar-left">
        <a href="index.html" class="toolbar-logo">ğŸª‘ ë‹¤ë‹´ê°€êµ¬</a>
        <span class="toolbar-user" id="toolbarUser">ë¡œë”©ì¤‘...</span>
        <span class="save-status saved hidden" id="saveStatus">
          <span id="saveStatusIcon">âœ“</span>
          <span id="saveStatusText">ì €ì¥ë¨</span>
        </span>
      </div>
      <div class="toolbar-right">
        <button class="btn-toolbar" onclick="loadDesignList()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn-toolbar primary" onclick="saveDesign()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        <button class="btn-toolbar success" onclick="submitDesign()">ğŸ“¤ ì œì¶œí•˜ê¸°</button>
      </div>
    </div>

    <div class="app-container">
      <h1>ë‹¤ë‹´ ìºë¹„ë„· ì—ì´ì „íŠ¸</h1>
      <div class="subtitle">í†µí•© ê°€êµ¬ ì„¤ê³„ ë° ìë™ ìì¬ ì‚°ì¶œ ì†”ë£¨ì…˜ (v33.0 - ìì¬ì¶”ì¶œ ì‹œìŠ¤í…œ ê°œì„ )</div>
      <div class="stepper-indicator">
        <div id="step-dot-1" class="step-dot active">1</div>
        <div id="step-dot-2" class="step-dot">2</div>
        <div id="step-dot-3" class="step-dot">3</div>
      </div>
      <div id="step1-content">
        <div class="section-label">1. í•„ìš”í•œ ê°€êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš” <span class="badge">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
        <div class="category-grid" id="categoryGrid"></div>
        <div id="detailInputSection">
          <div class="ai-guide-box">
            <span style="font-size: 18px">ğŸ¤–</span><span id="aiGuideText">ê°€êµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì…ë ¥ì°½ì´ ìƒì„±ë©ë‹ˆë‹¤.</span>
          </div>
          <div class="section-label">2. ê°€êµ¬ë³„ ìƒì„¸ ì¹˜ìˆ˜ ë° í˜„ì¥ ì‚¬ì§„</div>
          <div id="dynamicInputList"></div>
          <div style="display: flex; justify-content: flex-end; margin-top: 30px">
            <button class="btn-next" id="btnNext" disabled onclick="goToStep2()">ë‹¤ìŒ ë‹¨ê³„ (ì„¤ê³„ ì‹œì‘) â†’</button>
          </div>
        </div>
      </div>
      <div id="step2-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
          <div class="section-label" style="margin: 0">ì„¤ê³„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</div>
          <button class="btn-back" onclick="backToStep1()">â† ì…ë ¥ ìˆ˜ì •í•˜ê¸°</button>
        </div>
        <div class="bookmark-tabs" id="bookmarkTabs"></div>
        <div class="design-workspace" id="designWorkspace"></div>
      </div>
    </div>

    <script>
      // ============================================================
      // ì•± ì„¤ì • ë° ë²„ì „ ì •ë³´
      // ============================================================
      const APP_CONFIG = {
        version: '33.0',
        versionName: 'Material Extractor V2',
        lastUpdate: '2026-01-16',
        features: ['ì‹±í¬ëŒ€', 'ë¶™ë°•ì´ì¥', 'ëƒ‰ì¥ê³ ì¥', 'AI ì–´ì‹œìŠ¤í„´íŠ¸', 'ìì¬ì¶”ì¶œ V2'],
      };

      // ============================================================
      // AI ì—ì´ì „íŠ¸ ì¸í„°í˜ì´ìŠ¤
      // ============================================================
      const AIAgentInterface = {
        // í˜„ì¬ ì„¤ê³„ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
        getDesignState: () => ({
          selectedItems: selectedItems,
          currentStep: document.getElementById('step-dot-1').classList.contains('active') ? 1 : 2,
        }),

        // ì•„ì´í…œ ì¶”ê°€
        addItem: (category, dimensions) => {
          const categoryData = CATEGORIES.find((c) => c.id === category);
          if (!categoryData) return { success: false, error: 'Invalid category' };

          const newItem = {
            uniqueId: Date.now(),
            category: category,
            name: categoryData.name,
            w: dimensions.w || 0,
            h: dimensions.h || 0,
            d: dimensions.d || categoryData.defaultD,
            specs: { ...DEFAULT_SPECS },
            modules: [],
          };
          selectedItems.push(newItem);
          return { success: true, item: newItem };
        },

        // ì•„ì´í…œ ì¡°íšŒ
        getItem: (itemId) => getItem(itemId),

        // ëª¨ë“ˆ ì¶”ê°€
        addModule: (itemId, moduleData) => {
          const item = getItem(itemId);
          if (!item) return { success: false, error: 'Item not found' };

          const newModule = {
            id: Date.now(),
            ...moduleData,
          };
          item.modules.push(newModule);
          return { success: true, module: newModule };
        },

        // ìë™ ê³„ì‚° ì‹¤í–‰
        runAutoCalc: (itemId, section) => {
          const item = getItem(itemId);
          if (!item) return { success: false, error: 'Item not found' };

          // â˜… categoryId ì‚¬ìš©
          const category = item.categoryId || item.category;
          if (category === 'sink') {
            if (section === 'upper') runAutoCalcUpper(itemId);
            else if (section === 'lower') runAutoCalcLower(itemId);
          } else if (category === 'wardrobe') {
            runWardrobeAutoCalc(itemId);
          } else if (category === 'fridge') {
            autoCalculateFridge(itemId);
          }
          return { success: true };
        },

        // ìŠ¤í™ ì—…ë°ì´íŠ¸
        updateSpec: (itemId, field, value) => {
          const item = updateItemSpec(itemId, field, value, false);
          return item ? { success: true } : { success: false, error: 'Item not found' };
        },

        // ì„¤ê³„ ë‚´ë³´ë‚´ê¸° (JSON)
        exportDesign: () => ({
          appVersion: APP_CONFIG.version,
          exportDate: new Date().toISOString(),
          items: selectedItems.map((item) => ({
            ...item,
            specs: { ...item.specs },
            modules: (item.modules || []).map((m) => ({ ...m })),
          })),
        }),

        // ì„¤ê³„ ê°€ì ¸ì˜¤ê¸°
        importDesign: (designData) => {
          try {
            if (designData.items) {
              selectedItems = designData.items;
              updateUI();
              return { success: true };
            }
            return { success: false, error: 'Invalid design data' };
          } catch (e) {
            return { success: false, error: e.message };
          }
        },
      };

      // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (AI ì—ì´ì „íŠ¸ ì ‘ê·¼ìš©)
      window.DadamAgent = AIAgentInterface;

      // ============================================================
      // ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
      // ============================================================
      const CATEGORIES = [
        { id: 'sink', name: 'ì‹±í¬ëŒ€', defaultD: 650 },
        { id: 'island', name: 'ì•„ì¼ëœë“œ', defaultD: 800 },
        { id: 'wardrobe', name: 'ë¶™ë°•ì´ì¥', defaultD: 650 },
        { id: 'fridge', name: 'ëƒ‰ì¥ê³ ì¥', defaultD: 700 },
        { id: 'shoerack', name: 'ì‹ ë°œì¥', defaultD: 350 },
        { id: 'vanity', name: 'í™”ì¥ëŒ€', defaultD: 500 },
        { id: 'storage', name: 'ìˆ˜ë‚©ì¥', defaultD: 400 },
        { id: 'warehouse', name: 'ì°½ê³ ì¥', defaultD: 450 },
        { id: 'door', name: 'ë„ì–´êµì²´', defaultD: 18 },
        { id: 'custom', name: 'ë¹„ê·œê²©ì¥', defaultD: 0 },
      ];

      // â˜… Rule 10: ê· ë“±ë¶„ë°° ìƒìˆ˜ (v28 ì—…ë°ì´íŠ¸)
      const DOOR_TARGET_WIDTH = 450; // ëª©í‘œ ë„ì–´ ë„ˆë¹„ (ì‹±í¬ëŒ€)
      const DOOR_MAX_WIDTH = 600; // ìµœëŒ€ ë„ì–´ ë„ˆë¹„
      const DOOR_MIN_WIDTH = 350; // â˜… ìµœì†Œ ë„ì–´ ë„ˆë¹„ (NEW)
      const MIN_REMAINDER = 4; // â˜… ìµœì†Œ ì”ì—¬ (0â†’4)
      const MAX_REMAINDER = 10; // ìµœëŒ€ ì”ì—¬

      const DEFAULT_SPECS = {
        layoutShape: 'I',
        doorColorUpper: 'í™”ì´íŠ¸',
        doorFinishUpper: 'ë¬´ê´‘',
        doorColorLower: 'í™”ì´íŠ¸',
        doorFinishLower: 'ë¬´ê´‘',
        topColor: 'ìŠ¤ë…¸ìš°',
        topThickness: 12,
        upperH: 720,
        lowerH: 870,
        moldingH: 60,
        sinkLegHeight: 150,
        handle: 'ì°¬ë„¬ (ëª©ì°¬ë„¬)',
        sink: 'ì‚¬ê°ë³¼ 850',
        faucet: 'ê±°ìœ„ëª© ìˆ˜ì „',
        hood: 'íˆë“  í›„ë“œ',
        cooktop: 'ì¸ë•ì…˜',
        dishwasher: 'None',
        accessories: [{ id: Date.now(), type: 'LTMesh' }],
        // ì‹¤ì¸¡ ê¸°ì¤€ = ë¶„ë°°ê¸° ê¸°ì¤€ = ì¥ ê¸°ì¤€
        measurementBase: 'Left',
        distributorStart: 0,
        distributorEnd: 0,
        ventStart: 0,
        finishLeftType: 'Filler',
        finishLeftWidth: 60,
        finishRightType: 'Filler',
        finishRightWidth: 60,
        finishCorner1Type: 'Filler',
        finishCorner1Width: 60,
        finishCorner2Type: 'Filler',
        finishCorner2Width: 60,
        topSizes: [''],
        effectiveUpperW: null,
        effectiveLowerW: null,
        // â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì„¤ì •
        curtainBoxW: 0,
        curtainBoxH: 0,
        wardrobePedestal: 60, // ì¢ŒëŒ€ ë†’ì´ (ê¸°ë³¸ 60mm)
        wardrobeMoldingH: 15, // ìƒëª°ë”© ë†’ì´ (ê¸°ë³¸ 15mm)
        // â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì„¤ì • (ê·œì¹™ ê¸°ë°˜)
        fridgeBrand: 'LG',
        fridgeUpperH: 415, // ìƒë¶€ì¥ ë†’ì´ (ê³ ì •)
        fridgeLowerH: 870, // í•˜ë¶€ì¥ ë†’ì´ (ì¢ŒëŒ€ 60 í¬í•¨)
        fridgePedestal: 60, // ì¢ŒëŒ€ ë†’ì´
        fridgeGap: 50, // ëƒ‰ì¥ê³  ì¢Œìš° ì—¬ìœ  ê°„ê²©
        fridgeModuleD: 550, // ëª¨ë“ˆ ê¸°ë³¸ ê¹Šì´
        fridgeInstallD: 700, // ì„¤ì¹˜ í•„ìš” ê¹Šì´
      };

      // â˜… ëƒ‰ì¥ê³ ì¥ ê·œì¹™ ìƒìˆ˜ (ì—…ë°ì´íŠ¸)
      const FRIDGE_RULES = {
        MAX_UPPER_H: 400, // ìƒë¶€ì¥ ìµœëŒ€ ë†’ì´
        PEDESTAL_H: 60, // ì¢ŒëŒ€ ë†’ì´
        LEG_H: 60, // ë‹¤ë¦¬ë°œ ë†’ì´
        LOWER_BODY_H: 810, // í•˜ë¶€ì¥ ëª¨ë“ˆ ë†’ì´ (ë‹¤ë¦¬ ì œì™¸)
        MODULE_D: 550, // ëª¨ë“ˆ ê¸°ë³¸ ê¹Šì´
        INSTALL_D: 700, // ì„¤ì¹˜ í•„ìš” ê¹Šì´
        TOP_GAP: 15, // ëƒ‰ì¥ê³  ìƒë‹¨ ê°„ê²© (ê³ ì •)
        MOLDING_H: 50, // ìƒëª°ë”© ê¸°ë³¸ ë†’ì´
        EL_W: 600, // í‚¤í°ì¥/ELì¥ ê¸°ë³¸ í­
        HOMECAFE_W: 600, // í™ˆì¹´í˜ì¥ ê¸°ë³¸ í­
        // ì—¬ìœ ê³µê°„ ê¸°ë³¸ê°’
        DEFAULT_GAPS: {
          LG_BUILTIN: { side: 4, between: 8 },
          LG_FREESTANDING: { side: 50, between: 0 },
          SS_BESPOKE: { side: 12, between: 10 },
          SS_INFINITE: { side: 5, between: 10 },
          SS_FREESTANDING: { side: 50, between: 0 },
        },
      };

      // â˜… ëƒ‰ì¥ê³ ì¥ ë‹¤ë¦¬ íƒ€ì…
      const FRIDGE_LEG_TYPES = [
        { id: 'pedestal', name: 'ì¢ŒëŒ€', defaultH: 60 },
        { id: 'leg', name: 'ë‹¤ë¦¬ë°œ', defaultH: 60 },
      ];

      // â˜… ëƒ‰ì¥ê³  ëª¨ë¸ ë°ì´í„° (ì—¬ìœ ê³µê°„ ì •ë³´ í¬í•¨)
      // â˜… ëƒ‰ì¥ê³  ëª¨ë¸ ë°ì´í„° (ê°œë³„ ë„ì–´ ì •ë³´ í¬í•¨)
      const FRIDGE_DATA = {
        LG: {
          name: 'LG',
          categories: {
            'ë‹¨ë… (Fit&Max)': [
              {
                id: 'lg_300l',
                name: 'ë‹¨ë… 300L',
                w: 595,
                h: 1780,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '300L', w: 595 }],
              },
              {
                id: 'lg_400l',
                name: 'ë‹¨ë… 400L',
                w: 595,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '400L', w: 595 }],
              },
              {
                id: 'lg_500l',
                name: 'ë‹¨ë… 500L',
                w: 700,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '500L', w: 700 }],
              },
              {
                id: 'lg_600l',
                name: 'ë‹¨ë… 600L',
                w: 700,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [{ name: '600L', w: 700 }],
              },
            ],
            'ì„¸íŠ¸ (Fit&Max)': [
              {
                id: 'lg_set_1d1d',
                name: '1ë„ì–´+1ë„ì–´',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'lg_set_1d1d1d',
                name: '1ë„ì–´Ã—3',
                w: 1809,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'lg_set_300_1d',
                name: '300+1ë„ì–´',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '300L', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'lg_set_400_1d',
                name: '400+1ë„ì–´',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '400L', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'lg_set_500_1d',
                name: '500+1ë„ì–´',
                w: 1408,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '1ë„ì–´', w: 700 },
                ],
              },
              {
                id: 'lg_set_500_300',
                name: '500+300',
                w: 1303,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '300L', w: 595 },
                ],
              },
              {
                id: 'lg_set_500_400',
                name: '500+400',
                w: 1303,
                h: 1850,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '500L', w: 700 },
                  { name: '400L', w: 595 },
                ],
              },
              {
                id: 'lg_set_600_300',
                name: '600+300',
                w: 1303,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '600L', w: 700 },
                  { name: '300L', w: 595 },
                ],
              },
              {
                id: 'lg_set_600_400',
                name: '600+400',
                w: 1303,
                h: 1920,
                d: 730,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: '600L', w: 700 },
                  { name: '400L', w: 595 },
                ],
              },
            ],
            ë¹ŒíŠ¸ì¸: [
              {
                id: 'lg_builtin_fridge_1d',
                name: 'ëƒ‰ì¥ê³ +1ë„ì–´',
                w: 1568,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ëƒ‰ì¥ê³ ', w: 897 },
                  { name: '1ë„ì–´', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_kimchi_1d',
                name: 'ê¹€ì¹˜+1ë„ì–´',
                w: 1309,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ê¹€ì¹˜', w: 649 },
                  { name: '1ë„ì–´', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_fridge_kimchi',
                name: 'ëƒ‰ì¥+ê¹€ì¹˜',
                w: 1612,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ëƒ‰ì¥', w: 897 },
                  { name: 'ê¹€ì¹˜', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_fridge_kimchi_1d',
                name: 'ëƒ‰ì¥+ê¹€ì¹˜+1ë„ì–´',
                w: 2272,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ëƒ‰ì¥', w: 897 },
                  { name: 'ê¹€ì¹˜', w: 649 },
                  { name: '1ë„ì–´', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_1d3',
                name: '1ë„ì–´Ã—3',
                w: 2013,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: '1ë„ì–´', w: 649 },
                  { name: '1ë„ì–´', w: 649 },
                  { name: '1ë„ì–´', w: 649 },
                ],
              },
              {
                id: 'lg_builtin_mood',
                name: 'ë¬´ë“œëƒ‰ì¥+ë¬´ë“œê¹€ì¹˜',
                w: 1612,
                h: 1860,
                d: 698,
                type: 'builtin',
                line: 'builtin',
                sideGap: 22,
                betweenGap: 11,
                units: [
                  { name: 'ë¬´ë“œëƒ‰ì¥', w: 897 },
                  { name: 'ë¬´ë“œê¹€ì¹˜', w: 649 },
                ],
              },
            ],
            í”„ë¦¬ìŠ¤íƒ ë”©: [
              {
                id: 'lg_free_600_side',
                name: 'ëƒ‰ì¥ê³ 600 ì–‘ë¬¸í˜•',
                w: 913,
                h: 1790,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ì–‘ë¬¸í˜•600', w: 913 }],
              },
              {
                id: 'lg_free_800_side',
                name: 'ëƒ‰ì¥ê³ 800 ì–‘ë¬¸í˜•',
                w: 913,
                h: 1820,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ì–‘ë¬¸í˜•800', w: 913 }],
              },
              {
                id: 'lg_free_800_topbot',
                name: 'ëƒ‰ì¥ê³ 800 ìƒëƒ‰ì¥í•˜ëƒ‰ë™',
                w: 913,
                h: 1820,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ìƒí•˜ëƒ‰ì¥', w: 913 }],
              },
            ],
            ëª¨ë˜ì—£ì§€: [
              {
                id: 'lg_modern_1d1d',
                name: 'ëª¨ë˜ì—£ì§€+1ë„ì–´Ã—2',
                w: 1198,
                h: 1850,
                d: 680,
                type: 'builtin',
                line: 'fitmax',
                sideGap: 4,
                betweenGap: 8,
                units: [
                  { name: 'ëª¨ë˜ì—£ì§€', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
            ],
          },
        },
        Samsung: {
          name: 'ì‚¼ì„±',
          categories: {
            'Bespoke ëƒ‰ì¥ê³ ': [
              {
                id: 'ss_bespoke_1d',
                name: '1ë„ì–´ í‚¤ì¹œí•',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '1ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_bespoke_2d',
                name: '2ë„ì–´ í‚¤ì¹œí•',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '2ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_bespoke_4d',
                name: '4ë„ì–´ í‚¤ì¹œí•',
                w: 912,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: '4ë„ì–´', w: 912 }],
              },
            ],
            'Bespoke ê¹€ì¹˜í”ŒëŸ¬ìŠ¤': [
              {
                id: 'ss_kimchi_1d',
                name: '1ë„ì–´ í‚¤ì¹œí•',
                w: 595,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ê¹€ì¹˜1ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_kimchi_3d',
                name: '3ë„ì–´ í‚¤ì¹œí•',
                w: 695,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ê¹€ì¹˜3ë„ì–´', w: 695 }],
              },
              {
                id: 'ss_kimchi_4d',
                name: '4ë„ì–´ í‚¤ì¹œí•',
                w: 912,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [{ name: 'ê¹€ì¹˜4ë„ì–´', w: 912 }],
              },
            ],
            'Bespoke í‚¤ì¹œí• ì„¸íŠ¸': [
              {
                id: 'ss_kf_2d1d',
                name: '2ë„ì–´+1ë„ì–´',
                w: 1200,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '2ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_kf_4d1d',
                name: '4ë„ì–´+1ë„ì–´',
                w: 1517,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ë„ì–´', w: 912 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_kf_4d3d',
                name: '4ë„ì–´+3ë„ì–´',
                w: 1617,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ë„ì–´', w: 912 },
                  { name: '3ë„ì–´', w: 695 },
                ],
              },
              {
                id: 'ss_kf_4d3d1d',
                name: '4ë„ì–´+3ë„ì–´+1ë„ì–´',
                w: 2222,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ë„ì–´', w: 912 },
                  { name: '3ë„ì–´', w: 695 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_kf_1d3',
                name: '1ë„ì–´Ã—3',
                w: 1805,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_kf_1d4',
                name: '1ë„ì–´Ã—4',
                w: 2410,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_kf_max',
                name: 'Max 4ë„ì–´+4ë„ì–´',
                w: 1834,
                h: 1853,
                d: 688,
                type: 'builtin',
                line: 'bespoke',
                sideGap: 12,
                betweenGap: 10,
                units: [
                  { name: '4ë„ì–´', w: 912 },
                  { name: '4ë„ì–´', w: 912 },
                ],
              },
            ],
            'Bespoke í”„ë¦¬ìŠ¤íƒ ë”©': [
              {
                id: 'ss_bespoke_4d_free',
                name: '4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©',
                w: 912,
                h: 1853,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: '4ë„ì–´FS', w: 912 }],
              },
              {
                id: 'ss_kimchi_4d_free',
                name: 'ê¹€ì¹˜ 4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©',
                w: 912,
                h: 1853,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ê¹€ì¹˜4ë„ì–´FS', w: 912 }],
              },
            ],
            'Infinite Line ëƒ‰ì¥ê³ ': [
              {
                id: 'ss_inf_1d',
                name: '1ë„ì–´ í‚¤ì¹œí•',
                w: 595,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: '1ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_inf_4d',
                name: '4ë„ì–´ í‚¤ì¹œí•',
                w: 912,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: '4ë„ì–´', w: 912 }],
              },
            ],
            'Infinite Line ê¹€ì¹˜í”ŒëŸ¬ìŠ¤': [
              {
                id: 'ss_inf_kimchi_1d',
                name: '1ë„ì–´ í‚¤ì¹œí•',
                w: 595,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: 'ê¹€ì¹˜1ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_inf_kimchi_4d',
                name: '4ë„ì–´ í‚¤ì¹œí•',
                w: 912,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [{ name: 'ê¹€ì¹˜4ë„ì–´', w: 912 }],
              },
            ],
            'Infinite Line í‚¤ì¹œí• ì„¸íŠ¸': [
              {
                id: 'ss_inf_1d1d',
                name: '1ë„ì–´+1ë„ì–´',
                w: 1200,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_inf_1d3',
                name: '1ë„ì–´Ã—3',
                w: 1815,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_inf_1d4',
                name: '1ë„ì–´Ã—4',
                w: 2420,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                  { name: '1ë„ì–´', w: 595 },
                ],
              },
              {
                id: 'ss_inf_4d4d',
                name: '4ë„ì–´+4ë„ì–´',
                w: 1834,
                h: 1855,
                d: 688,
                type: 'builtin',
                line: 'infinite',
                sideGap: 5,
                betweenGap: 10,
                units: [
                  { name: '4ë„ì–´', w: 912 },
                  { name: '4ë„ì–´', w: 912 },
                ],
              },
            ],
            'Infinite Line í”„ë¦¬ìŠ¤íƒ ë”©': [
              {
                id: 'ss_inf_4d_free',
                name: '4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©',
                w: 912,
                h: 1855,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: '4ë„ì–´FS', w: 912 }],
              },
            ],
            'ê¹€ì¹˜í”ŒëŸ¬ìŠ¤ ìŠ¤íƒ ë“œ': [
              {
                id: 'ss_stand_3d',
                name: 'ìŠ¤íƒ ë“œí˜• 3ë„ì–´',
                w: 595,
                h: 1380,
                d: 688,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ìŠ¤íƒ ë“œ3ë„ì–´', w: 595 }],
              },
              {
                id: 'ss_stand_4d',
                name: 'ìŠ¤íƒ ë“œí˜• 4ë„ì–´',
                w: 595,
                h: 1530,
                d: 688,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'ìŠ¤íƒ ë“œ4ë„ì–´', w: 595 }],
              },
            ],
            ì–‘ë¬¸í˜•: [
              {
                id: 'ss_rs70',
                name: 'RS70',
                w: 912,
                h: 1780,
                d: 716,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS70', w: 912 }],
              },
              {
                id: 'ss_rs80f',
                name: 'RS80F',
                w: 912,
                h: 1780,
                d: 716,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS80F', w: 912 }],
              },
              {
                id: 'ss_rs84',
                name: 'RS84',
                w: 912,
                h: 1825,
                d: 738,
                type: 'freestanding',
                line: 'freestanding',
                sideGap: 50,
                betweenGap: 0,
                units: [{ name: 'RS84', w: 912 }],
              },
            ],
          },
        },
      };

      // â˜… ELì¥ ë„ì–´ íƒ€ì… (5ê°€ì§€)
      const EL_DOOR_TYPES = [
        { id: 'liftup', name: 'ë¦¬í”„íŠ¸ì—…' },
        { id: 'flap', name: 'í”Œë©ë„ì–´' },
        { id: 'pocket', name: 'í¬ì¼“ë„ì–´' },
        { id: 'swing', name: 'ì—¬ë‹«ì´' },
        { id: 'sliding', name: 'ìŠ¬ë¼ì´ë”©' },
      ];

      // â˜… ë„ì–´ êµ¬ë¶„ íƒ€ì… (3ê°€ì§€)
      const DOOR_DIVISION_TYPES = [
        { id: 'individual', name: 'ê°œë³„' },
        { id: 'midLower', name: 'ì¤‘ê°„ì¥ã†í•˜ë¶€ì¥' },
        { id: 'all', name: 'ì „ì²´' },
      ];

      // â˜… ë§ˆê° íƒ€ì… (ëª°ë”©, íœ ë¼, EP, ì—†ìŒ)
      const FINISH_TYPES = [
        { id: 'Molding', name: 'ëª°ë”©', defaultW: 60, editable: true },
        { id: 'Filler', name: 'íœ ë¼', defaultW: 60, editable: true },
        { id: 'EP', name: 'EP', defaultW: 20, editable: false },
        { id: 'None', name: 'ì—†ìŒ', defaultW: 0, editable: false },
      ];

      // â˜… ë„ì–´ ìƒ‰ìƒ ë§¤í•‘
      const DOOR_COLOR_MAP = {
        í™”ì´íŠ¸: '#f5f5f5',
        ê·¸ë ˆì´: '#9e9e9e',
        ë² ì´ì§€: '#d4c4b0',
        ì›”ë„›: '#5d4037',
        ì˜¤í¬: '#c4a35a',
      };

      function getDoorColor(colorName) {
        return DOOR_COLOR_MAP[colorName] || '#f5f5f5';
      }

      // â˜… í•˜ë¶€ì¥ ëª¨ë“ˆ íƒ€ì…
      const LOWER_MODULE_TYPES = [
        { id: 'default', name: 'ê¸°ë³¸', defaultW: 600, color: '#6b7280', icon: 'ğŸ—„ï¸' },
        { id: 'robot', name: 'ë¡œë´‡ì²­ì†Œê¸°', defaultW: 600, color: '#f59e0b', icon: 'ğŸ¤–' },
        { id: 'foodwaste', name: 'ìŒì‹ë¬¼ì²˜ë¦¬ê¸°', defaultW: 450, color: '#22c55e', icon: 'â™»ï¸' },
        { id: 'rice', name: 'ë°¥ì†¥', defaultW: 450, color: '#ef4444', icon: 'ğŸš' },
      ];

      let selectedItems = [];

      // ============================================================
      // ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
      // ============================================================

      /**
       * debounce ìœ í‹¸ë¦¬í‹° - ì—°ì† í˜¸ì¶œ ì‹œ ë§ˆì§€ë§‰ í˜¸ì¶œë§Œ ì‹¤í–‰
       * ë Œë”ë§ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì‚¬ìš©
       */
      function debounce(func, wait = 50) {
        let timeoutId = null;
        return function (...args) {
          if (timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            func.apply(this, args);
            timeoutId = null;
          }, wait);
        };
      }

      /**
       * throttle ìœ í‹¸ë¦¬í‹° - ì§€ì • ì‹œê°„ ë™ì•ˆ ìµœëŒ€ 1íšŒë§Œ ì‹¤í–‰
       */
      function throttle(func, limit = 100) {
        let inThrottle = false;
        return function (...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => (inThrottle = false), limit);
          }
        };
      }

      /**
       * í¬ì»¤ìŠ¤ ë³µì› í•¨ìˆ˜ - ë Œë”ë§ í›„ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ë³µì›
       */
      function _restoreFocus(container, focusInfo) {
        if (!focusInfo) return;

        // requestAnimationFrameìœ¼ë¡œ DOM ì—…ë°ì´íŠ¸ í›„ í¬ì»¤ìŠ¤ ë³µì›
        requestAnimationFrame(() => {
          // onchange ë˜ëŠ” onblur ì†ì„±ìœ¼ë¡œ ê°™ì€ ìš”ì†Œ ì°¾ê¸°
          let targetEl = null;
          if (focusInfo.onchange) {
            targetEl = container.querySelector(`input[onchange="${focusInfo.onchange}"]`);
          } else if (focusInfo.onblur) {
            targetEl = container.querySelector(`input[onblur="${focusInfo.onblur}"]`);
          }

          if (targetEl) {
            targetEl.focus();
            // ì„ íƒ ì˜ì—­ ë³µì› (ìˆ«ì ì…ë ¥ í•„ë“œ)
            if (focusInfo.selectionStart !== null && targetEl.type !== 'number') {
              try {
                targetEl.setSelectionRange(focusInfo.selectionStart, focusInfo.selectionEnd);
              } catch (e) {
                // ì¼ë¶€ input íƒ€ì…ì€ setSelectionRangeë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
              }
            }
          }
        });
      }

      /**
       * ì•„ì´í…œ ì¡°íšŒ í—¬í¼
       */
      function getItem(itemUniqueId) {
        return selectedItems.find((i) => i.uniqueId === itemUniqueId);
      }

      /**
       * ëª¨ë“ˆ ì¡°íšŒ í—¬í¼
       */
      function getModule(itemUniqueId, modId) {
        const item = getItem(itemUniqueId);
        return item ? item.modules.find((m) => m.id === modId) : null;
      }

      /**
       * ìŠ¤í™ ì—…ë°ì´íŠ¸ ê³µí†µ í•¨ìˆ˜
       */
      function updateItemSpec(itemUniqueId, field, value, shouldRender = true) {
        const item = getItem(itemUniqueId);
        if (!item) return null;
        item.specs[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);
        if (shouldRender) renderWorkspaceContent(item);
        return item;
      }

      /**
       * ëª¨ë“ˆ ì—…ë°ì´íŠ¸ ê³µí†µ í•¨ìˆ˜
       */
      function updateModuleField(itemUniqueId, modId, field, value, shouldRender = true) {
        const item = getItem(itemUniqueId);
        if (!item) return null;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return null;
        mod[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);
        if (shouldRender) renderWorkspaceContent(item);
        return { item, mod };
      }

      /**
       * SVG ì‚¬ê°í˜• ìƒì„± í—¬í¼
       */
      function svgRect(x, y, w, h, fill, stroke, strokeWidth = 1, rx = 0) {
        return `<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" rx="${rx}"/>`;
      }

      /**
       * SVG í…ìŠ¤íŠ¸ ìƒì„± í—¬í¼
       */
      function svgText(x, y, text, opts = {}) {
        const anchor = opts.anchor || 'middle';
        const fontSize = opts.fontSize || 10;
        const fill = opts.fill || '#333';
        const fontWeight = opts.fontWeight || 'normal';
        return `<text x="${x}" y="${y}" text-anchor="${anchor}" font-size="${fontSize}" fill="${fill}" font-weight="${fontWeight}">${text}</text>`;
      }

      /**
       * ë²„íŠ¼ HTML ìƒì„± í—¬í¼
       */
      function createButton(label, onclick, className = '', style = '') {
        return `<button class="${className}" onclick="${onclick}" style="${style}">${label}</button>`;
      }

      /**
       * ì¸í’‹ HTML ìƒì„± í—¬í¼
       */
      function createNumberInput(value, onchange, style = 'width:60px;') {
        return `<input type="number" value="${value}" onchange="${onchange}" style="${style}">`;
      }

      // ============================================================
      // ìµœì í™”: ê³µí†µ ëª¨ë“ˆ ì¡°ì‘ í•¨ìˆ˜ë“¤
      // ============================================================

      /**
       * ëª¨ë“ˆ ì˜µì…˜ í† ê¸€ (ì²´í¬ë°•ìŠ¤ìš© - ê¸°ì¡´ toggleOptionê³¼ ë³‘í–‰)
       */
      function toggleModuleOption(itemUniqueId, modId, field, checked) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[field] = checked;
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * ëª¨ë“ˆ ê°’ ì¡°ì ˆ (+/- ë²„íŠ¼ìš©)
       */
      function adjustModuleValue(itemUniqueId, modId, field, delta, min = 0) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[field] = Math.max(min, (mod[field] || 0) + delta);
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * ëª¨ë“ˆ íƒ€ì… ì„¤ì •
       */
      function setModuleType(itemUniqueId, modId, typeField, value) {
        const mod = getModule(itemUniqueId, modId);
        if (mod) {
          mod[typeField] = value;
          renderWorkspaceContent(getItem(itemUniqueId));
        }
      }

      /**
       * ì•„ì´í…œ ìŠ¤í™ í† ê¸€
       */
      function toggleItemSpec(itemUniqueId, field) {
        const item = getItem(itemUniqueId);
        if (item && item.specs) {
          item.specs[field] = !item.specs[field];
          renderWorkspaceContent(item);
        }
      }

      // ============================================================
      // ìµœì í™”: ë Œë”ë§ í—¬í¼ í•¨ìˆ˜ë“¤
      // ============================================================

      /**
       * í† ê¸€ ë²„íŠ¼ ê·¸ë£¹ ë Œë”ë§
       * @param {number} itemId - ì•„ì´í…œ ID
       * @param {number} modId - ëª¨ë“ˆ ID
       * @param {Array} options - [{value, label}] ë°°ì—´
       * @param {string} currentValue - í˜„ì¬ ì„ íƒëœ ê°’
       * @param {string} colorClass - ìƒ‰ìƒ í´ë˜ìŠ¤ (green, blue, orange, purple)
       * @param {string} typeField - íƒ€ì… í•„ë“œëª…
       */
      function renderToggleButtons(itemId, modId, options, currentValue, colorClass, typeField = 'type') {
        return `<div class="toggle-group">${options
          .map(
            (opt) =>
              `<button class="btn-toggle ${colorClass} ${currentValue === opt.value ? 'active' : ''}"
       data-action="setType" data-item="${itemId}" data-mod="${modId}"
       data-field="${typeField}" data-value="${opt.value}">${opt.label}</button>`
          )
          .join('')}</div>`;
      }

      /**
       * ì¡°ì ˆ ì»¨íŠ¸ë¡¤ ë Œë”ë§ (+/- ë²„íŠ¼)
       * @param {number} itemId - ì•„ì´í…œ ID
       * @param {number} modId - ëª¨ë“ˆ ID
       * @param {string} field - í•„ë“œëª…
       * @param {number} value - í˜„ì¬ ê°’
       * @param {string} label - ë¼ë²¨ (ì„ íƒ)
       */
      function renderAdjustControl(itemId, modId, field, value, label = '') {
        return `<div class="adjust-control">
    ${label ? `<span>${label}</span>` : ''}
    <button class="btn-adjust" data-action="adjust" data-item="${itemId}"
      data-mod="${modId}" data-field="${field}" data-delta="-1">âˆ’</button>
    <span class="value">${value}</span>
    <button class="btn-adjust" data-action="adjust" data-item="${itemId}"
      data-mod="${modId}" data-field="${field}" data-delta="1">+</button>
  </div>`;
      }

      /**
       * ì²´í¬ë°•ìŠ¤ ë Œë”ë§
       */
      function renderCheckbox(itemId, modId, field, checked, label) {
        return `<label class="checkbox-label">
    <input type="checkbox" ${checked ? 'checked' : ''}
      data-action="toggle" data-item="${itemId}" data-mod="${modId}" data-field="${field}">
    ${label}
  </label>`;
      }

      /**
       * ìˆ«ì ì…ë ¥ í•„ë“œ ë Œë”ë§
       */
      function renderNumberInput(itemId, modId, field, value, width = '50px') {
        return `<input type="number" class="spec-input-sm" value="${value}"
    data-item="${itemId}" data-mod="${modId}" data-field="${field}"
    style="width:${width}">`;
      }

      // ============================================================
      // í•µì‹¬ ê³„ì‚° í•¨ìˆ˜ë“¤
      // ============================================================

      /**
       * ë„ì–´ ë„ˆë¹„ ìµœì í™” (v28 ì—…ë°ì´íŠ¸)
       * ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ê³µê°„ â‰¤ 10mm
       * ì°¨ì„ : 0mm â‰¤ ì”ì—¬ê³µê°„ < 4mm (ì •í™•íˆ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ê²½ìš°)
       * ê·¸ ë‹¤ìŒ: 10ì˜ ë‹¨ìœ„ > ì§ìˆ˜
       * ì œì•½: 350mm â‰¤ ë„ì–´ ë„ˆë¹„ â‰¤ 600mm
       */
      function findBestDoorWidth(totalSpace, doorCount) {
        const rawWidth = totalSpace / doorCount;

        // â˜… ë„ì–´ ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œì•½ í™•ì¸
        if (rawWidth > DOOR_MAX_WIDTH) return null;
        if (rawWidth < DOOR_MIN_WIDTH) return null;

        const primaryCandidates = []; // 4~10mm ì¡°ê±´ ë§Œì¡±
        const secondaryCandidates = []; // 0~3mm (ì°¨ì„ )

        // 10ì˜ ë‹¨ìœ„ í›„ë³´ (ë‚´ë¦¼, ì˜¬ë¦¼)
        const tenFloor = Math.floor(rawWidth / 10) * 10;
        const tenCeil = Math.ceil(rawWidth / 10) * 10;

        // ì§ìˆ˜ í›„ë³´ (ë‚´ë¦¼, ì˜¬ë¦¼)
        const evenFloor = Math.floor(rawWidth / 2) * 2;
        const evenCeil = Math.ceil(rawWidth / 2) * 2;

        // í›„ë³´ë“¤ê³¼ ìš°ì„ ìˆœìœ„ (priority ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
        const allCandidates = [
          { width: tenFloor, priority: 1 },
          { width: tenCeil, priority: 1 },
          { width: evenFloor, priority: 2 },
          { width: evenCeil, priority: 2 },
        ];

        // í›„ë³´ ë¶„ë¥˜
        for (const cand of allCandidates) {
          if (cand.width < DOOR_MIN_WIDTH || cand.width > DOOR_MAX_WIDTH) continue;
          const used = cand.width * doorCount;
          const gap = totalSpace - used;
          if (gap < 0) continue;

          if (gap >= MIN_REMAINDER && gap <= MAX_REMAINDER) {
            // â˜… ìš°ì„ : 4~10mm ì¡°ê±´ ë§Œì¡±
            primaryCandidates.push({ ...cand, gap });
          } else if (gap >= 0 && gap < MIN_REMAINDER) {
            // â˜… ì°¨ì„ : 0~3mm (ì •í™•íˆ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ê²½ìš° í¬í•¨)
            secondaryCandidates.push({ ...cand, gap });
          }
        }

        // ìš°ì„ ìˆœìœ„ ì •ë ¬ í•¨ìˆ˜
        const sortCandidates = (arr) => {
          arr.sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            return a.gap - b.gap;
          });
        };

        // ìš°ì„  í›„ë³´ ì„ íƒ
        if (primaryCandidates.length > 0) {
          sortCandidates(primaryCandidates);
          return primaryCandidates[0].width;
        }

        // ì°¨ì„  í›„ë³´ ì„ íƒ (0~3mm)
        if (secondaryCandidates.length > 0) {
          sortCandidates(secondaryCandidates);
          return secondaryCandidates[0].width;
        }

        return null;
      }

      /**
       * ëª¨ë“ˆ ê· ë“± ë¶„ë°° í•¨ìˆ˜ (v28 ì—…ë°ì´íŠ¸)
       * - ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ê³µê°„ â‰¤ 10mm
       * - ì°¨ì„ : 0mm â‰¤ ì”ì—¬ê³µê°„ < 4mm
       * - ì œì•½: 350mm â‰¤ ë„ì–´ ë„ˆë¹„ â‰¤ 600mm, ëª©í‘œ â‰ˆ 450mm
       * - ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D, ë‚˜ë¨¸ì§€*1D
       */
      function distributeModules(totalSpace) {
        if (totalSpace < 100) return { modules: [], doorWidth: 0, doorCount: 0 };

        // â˜… ë„ì–´ ê°œìˆ˜ ë²”ìœ„ ì„¤ì • (ìµœì†Œ/ìµœëŒ€ ë„ì–´ ë„ˆë¹„ ë°˜ì˜)
        const minCount = Math.max(1, Math.ceil(totalSpace / DOOR_MAX_WIDTH));
        const maxDoorCount = Math.floor(totalSpace / DOOR_MIN_WIDTH);
        const baseCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
        const maxCount = Math.min(maxDoorCount, Math.max(baseCount + 3, minCount + 5));

        // ëª¨ë“  ìœ íš¨í•œ ì¡°í•© ìˆ˜ì§‘
        let allResults = [];

        for (let count = minCount; count <= maxCount; count++) {
          const width = findBestDoorWidth(totalSpace, count);
          if (width !== null) {
            const gap = totalSpace - width * count;
            const targetDiff = Math.abs(width - DOOR_TARGET_WIDTH);
            const isPrimary = gap >= MIN_REMAINDER && gap <= MAX_REMAINDER;

            allResults.push({
              doorCount: count,
              doorWidth: width,
              gap,
              targetDiff,
              isPrimary, // 4~10mm ì¡°ê±´ ë§Œì¡± ì—¬ë¶€
            });
          }
        }

        // ì •ë ¬: isPrimary ìš°ì„  â†’ targetDiff ì‘ì€ ìˆœ â†’ gap ì‘ì€ ìˆœ
        allResults.sort((a, b) => {
          // 1. 4~10mm ì¡°ê±´ ë§Œì¡±í•˜ëŠ” ê²ƒ ìš°ì„ 
          if (a.isPrimary !== b.isPrimary) return b.isPrimary - a.isPrimary;
          // 2. ëª©í‘œ ë„ì–´ ë„ˆë¹„(450mm)ì— ê°€ê¹Œìš´ ê²ƒ ìš°ì„ 
          if (a.targetDiff !== b.targetDiff) return a.targetDiff - b.targetDiff;
          // 3. ì”ì—¬ ì‘ì€ ê²ƒ ìš°ì„ 
          return a.gap - b.gap;
        });

        let bestResult = allResults.length > 0 ? allResults[0] : null;

        // ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ê°•ì œ ê³„ì‚°
        if (!bestResult) {
          // ëª©í‘œ ë„ì–´ ë„ˆë¹„ì— ê°€ì¥ ê°€ê¹Œìš´ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
          const idealCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
          const count = Math.max(minCount, Math.min(maxDoorCount, idealCount));
          let width = Math.floor(totalSpace / count / 2) * 2;
          width = Math.max(DOOR_MIN_WIDTH, Math.min(DOOR_MAX_WIDTH, width));
          bestResult = { doorCount: count, doorWidth: width, gap: totalSpace - width * count };
        }

        const { doorCount, doorWidth } = bestResult;
        const quotient = Math.floor(doorCount / 2);
        const remainder = doorCount % 2;

        const modules = [];
        // 2D ëª¨ë“ˆ (ëª« ê°œ)
        for (let i = 0; i < quotient; i++) {
          modules.push({ w: doorWidth * 2, is2D: true });
        }
        // 1D ëª¨ë“ˆ (ë‚˜ë¨¸ì§€ ê°œ)
        if (remainder > 0) {
          modules.push({ w: doorWidth, is2D: false });
        }

        return { modules, doorWidth, doorCount };
      }

      /**
       * ìœ íš¨ ê³µê°„ ê³„ì‚°
       */
      function calcEffectiveSpace(item) {
        const W = parseFloat(item.w) || 0;
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        const fC1 =
          item.specs.layoutShape !== 'I' && item.specs.finishCorner1Type !== 'None'
            ? parseFloat(item.specs.finishCorner1Width) || 0
            : 0;
        const fC2 =
          item.specs.layoutShape === 'U' && item.specs.finishCorner2Type !== 'None'
            ? parseFloat(item.specs.finishCorner2Width) || 0
            : 0;
        return W - fL - fR - fC1 - fC2;
      }

      function getEffectiveSpace(item, section) {
        const manualValue = section === 'upper' ? item.specs.effectiveUpperW : item.specs.effectiveLowerW;
        if (manualValue !== null && manualValue !== '') return parseFloat(manualValue) || 0;
        return calcEffectiveSpace(item);
      }

      /**
       * ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ì¡°ì • (ê²½ê³„ ë‚´ë¡œ)
       */
      function adjustFixedPositions(fixedList, startBound, endBound) {
        fixedList.sort((a, b) => a.x - b.x);

        // ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê²¹ì¹¨ ë°©ì§€
        let cursor = startBound;
        fixedList.forEach((mod) => {
          if (mod.x < cursor) {
            mod.x = cursor;
            mod.endX = mod.x + mod.w;
          }
          cursor = mod.endX;
        });

        // ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ê²½ê³„ ì¡°ì •
        let rightCursor = endBound;
        for (let i = fixedList.length - 1; i >= 0; i--) {
          const mod = fixedList[i];
          if (mod.endX > rightCursor) {
            mod.endX = rightCursor;
            mod.x = mod.endX - mod.w;
          }
          rightCursor = mod.x;
        }

        return fixedList;
      }

      /**
       * ë¹ˆ ê³µê°„(Gap) ê³„ì‚°
       */
      function calculateGaps(fixedList, startBound, endBound) {
        const gaps = [];
        let cursor = startBound;

        for (const fixed of fixedList) {
          if (fixed.x > cursor + 1) {
            gaps.push({ start: cursor, end: fixed.x, width: fixed.x - cursor });
          }
          cursor = fixed.endX;
        }
        if (cursor < endBound - 1) {
          gaps.push({ start: cursor, end: endBound, width: endBound - cursor });
        }

        return gaps;
      }

      /**
       * Gapì„ ëª¨ë“ˆë¡œ ì±„ìš°ê¸° (v28 ì—…ë°ì´íŠ¸: í›„ë“œ ì œì™¸ ëª¨ë“  ë„ì–´ ë™ì¼ í¬ê¸°)
       * @param {Object} gap - { start, end, width }
       * @param {string} section - 'upper' | 'lower'
       * @param {number} defaultH - ê¸°ë³¸ ë†’ì´
       * @param {number} defaultD - ê¸°ë³¸ ê¹Šì´
       * @param {number} fixedDoorWidth - ê³ ì • ë„ì–´ ë„ˆë¹„ (ì „ë‹¬ì‹œ í•´ë‹¹ ë„ˆë¹„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
       */
      function fillGapWithModules(gap, section, defaultH, defaultD, fixedDoorWidth = null) {
        const newModules = [];
        const namePrefix = section === 'upper' ? 'ìƒë¶€ì¥' : 'í•˜ë¶€ì¥';

        if (gap.width < 100) return newModules;

        let doorWidth, doorCount;

        if (fixedDoorWidth) {
          // â˜… ê³ ì • ë„ì–´ ë„ˆë¹„ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ëª¨ë“  ë„ì–´ ë™ì¼ í¬ê¸°)
          doorWidth = fixedDoorWidth;
          doorCount = Math.round(gap.width / fixedDoorWidth);
          if (doorCount < 1) doorCount = 1;

          // ì œì•½ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë„ì–´ ê°œìˆ˜ ì¡°ì •ì´ í•„ìš”í•œ ê²½ìš°ë§Œ
          if (doorWidth < DOOR_MIN_WIDTH) {
            doorCount = Math.max(1, Math.floor(gap.width / DOOR_MIN_WIDTH));
          } else if (doorWidth > DOOR_MAX_WIDTH) {
            doorCount = Math.ceil(gap.width / DOOR_MAX_WIDTH);
          }
          // â˜… doorWidthëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ (ë™ì¼ í¬ê¸° ìœ ì§€)
        } else {
          // ê³ ì • ë„ì–´ ë„ˆë¹„ê°€ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ ë¶„ë°°ê·œì¹™ ì ìš©
          const result = distributeModules(gap.width);
          doorWidth = result.doorWidth;
          doorCount = result.doorCount;
        }

        // ëª¨ë“ˆ ìƒì„± (ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D + ë‚˜ë¨¸ì§€*1D)
        const quotient = Math.floor(doorCount / 2);
        const mod1D = doorCount % 2;

        let dx = gap.start;

        // 2D ëª¨ë“ˆ (ëª« ê°œ) - ëª¨ë‘ ë™ì¼í•œ ë„ì–´ ë„ˆë¹„ Ã— 2
        for (let i = 0; i < quotient; i++) {
          const w = doorWidth * 2;
          newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, true, dx));
          dx += w;
        }

        // 1D ëª¨ë“ˆ (ë‚˜ë¨¸ì§€ ê°œ) - ë™ì¼í•œ ë„ì–´ ë„ˆë¹„
        if (mod1D > 0) {
          const w = doorWidth;
          newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, false, dx));
          dx += w;
        }

        // â˜… ì”ì—¬ ê³µê°„ì€ ì‹œê³µ ì—¬ìœ ë¡œ ì²˜ë¦¬ (ëª¨ë“ˆ ë„ˆë¹„ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ)

        return newModules;
      }

      /**
       * ëª¨ë“ˆ ê°ì²´ ìƒì„± í—¬í¼
       */
      function createModule(pos, namePrefix, w, h, d, is2D, x) {
        return {
          id: Date.now() + Math.random(),
          type: 'storage',
          name: `${namePrefix}(${is2D ? '2D' : '1D'})`,
          pos,
          w,
          h,
          d,
          isDrawer: false,
          isEL: false,
          isFixed: false,
          _x: x,
        };
      }

      /**
       * ì”ì—¬ ê³µê°„ ìƒ‰ìƒ (v28: 0~10mmê°€ ë…¹ìƒ‰)
       */
      function getRemainColor(remaining) {
        if (remaining < 0 || remaining > MAX_REMAINDER + 5) return '#ff4d4f'; // ìŒìˆ˜ ë˜ëŠ” 15mm ì´ˆê³¼
        if (remaining >= 0 && remaining <= MAX_REMAINDER) return '#00c853'; // 0~10mm ë…¹ìƒ‰
        return '#4a7dff'; // 11~15mm íŒŒë€ìƒ‰
      }

      // ============================================================
      // ì„¹ì…˜ ìë™ ê³„ì‚° í•¨ìˆ˜
      // ============================================================

      /**
       * ìë™ê³„ì‚° ë¡œì§ ìš”ì•½ (v28 ì—…ë°ì´íŠ¸):
       *
       * 1. ìœ íš¨ê³µê°„ = ì „ì²´ë„ˆë¹„ - ë§ˆê°ë“¤
       * 2. ê³ ì • ëª¨ë“ˆ ìˆ˜ì§‘ ë° ìœ„ì¹˜ ê²°ì •
       *    - í•˜ë¶€: ê°œìˆ˜ëŒ€(ë¶„ë°°ê¸°ì‹œì‘-100), ê°€ìŠ¤ëŒ€(í™˜í’êµ¬ì¤‘ì•™), LTë§ì¥(ê°€ìŠ¤ëŒ€ì˜†+ë¨¼ìª½)
       *    - ìƒë¶€: í›„ë“œ(í™˜í’êµ¬ì¤‘ì•™), ê¸°ì¤€ìƒë¶€ì¥(ê°œìˆ˜ëŒ€ ì¤‘ì•™ ì •ë ¬, 2D)
       * 3. ê°œìˆ˜ëŒ€ ë…¼ë¦¬ì¡°ê±´ ê²€ì¦: ì‹œì‘<ë¶„ë°°ê¸°ì‹œì‘ AND ë>ë¶„ë°°ê¸°ë
       * 4. Gap ê³„ì‚° ë° ê· ë“±ë¶„ë°°
       *    - ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ â‰¤ 10mm
       *    - ì°¨ì„ : 0mm â‰¤ ì”ì—¬ < 4mm
       *    - ë„ì–´: 350~600mm, ëª©í‘œ â‰ˆ 450mm
       *    - ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D + ë‚˜ë¨¸ì§€*1D
       */

      function runAutoCalcSection(itemUniqueId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        if (section === 'upper') {
          item.prevUpperModules = JSON.parse(JSON.stringify(item.modules.filter((m) => m.pos === 'upper')));
          runAutoCalcUpper(item);
        } else {
          item.prevLowerModules = JSON.parse(JSON.stringify(item.modules.filter((m) => m.pos === 'lower')));
          runAutoCalcLower(item);
        }

        renderWorkspaceContent(item);
      }

      function runAutoCalcUpper(item) {
        const W = parseFloat(item.w) || 0;
        const effectiveW = getEffectiveSpace(item, 'upper');

        if (effectiveW <= 0) {
          alert('ìƒë¶€ì¥ ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }

        const specUpperH = parseFloat(item.specs.upperH) || 720;
        const upperBodyH = specUpperH - 20;
        const isRefLeft = item.specs.measurementBase === 'Left';
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const startBound = fL;
        const endBound = startBound + effectiveW;

        // â˜… Step 1: ê°œìˆ˜ëŒ€ ì¤‘ì•™ì  ê³„ì‚°
        let absDistStart;
        if (isRefLeft) {
          absDistStart = parseFloat(item.specs.distributorStart) || 0;
        } else {
          absDistStart = W - (parseFloat(item.specs.distributorStart) || 0);
        }
        const sinkStart = absDistStart - 100;
        const sinkW = 1000;
        const sinkCenter = sinkStart + sinkW / 2; // ê°œìˆ˜ëŒ€ ì¤‘ì•™

        // â˜… Step 2: í›„ë“œ ì´ˆê¸° ìœ„ì¹˜ ê³„ì‚° (í™˜í’êµ¬ ì¤‘ì•™ ì •ë ¬)
        const absVent = isRefLeft ? parseFloat(item.specs.ventStart) || 0 : W - (parseFloat(item.specs.ventStart) || 0);
        const hoodW = 800;
        let hoodXInit = Math.max(startBound, Math.min(absVent - hoodW / 2, endBound - hoodW));

        // â˜… Step 3-4: ìœ íš¨ê³µê°„(í›„ë“œ ì œì™¸)ì—ì„œ ì„ì‹œ ë„ì–´ ë„ˆë¹„ ê³„ì‚°
        const totalSpaceExcludeHood = effectiveW - hoodW;
        const tempResult = distributeModules(totalSpaceExcludeHood);
        const tempDoorWidth = tempResult.doorWidth || DOOR_TARGET_WIDTH;

        // ê¸°ì¤€ ìƒë¶€ì¥ ì„ì‹œ ë„ˆë¹„ (2D)
        const tempBaseUpperW = tempDoorWidth * 2;

        // ê¸°ì¤€ ìƒë¶€ì¥ ì´ˆê¸° ìœ„ì¹˜ (ê°œìˆ˜ëŒ€ ì¤‘ì•™ ì •ë ¬)
        let baseUpperXInit = sinkCenter - tempBaseUpperW / 2;
        if (baseUpperXInit < startBound) baseUpperXInit = startBound;
        if (baseUpperXInit + tempBaseUpperW > endBound) baseUpperXInit = endBound - tempBaseUpperW;

        // â˜… Step 5-6-7: í›„ë“œ Â±50mm, ê¸°ì¤€ìƒë¶€ì¥ Â±100mm ì´ë™í•˜ë©´ì„œ ìµœì  ìœ„ì¹˜ ì°¾ê¸°
        const hoodTolerance = 50;
        const baseTolerance = 100;

        let bestHoodOffset = 0;
        let bestBaseOffset = 0;
        let bestDoorWidth = tempDoorWidth;
        let bestTotalRemainder = Infinity;
        let bestHoodX = hoodXInit;
        let bestBaseUpperX = baseUpperXInit;

        for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
          const testHoodX = hoodXInit + hoodOffset;

          // í›„ë“œ ê²½ê³„ ì²´í¬
          if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;

          for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
            const testBaseX = baseUpperXInit + baseOffset;

            // ê¸°ì¤€ìƒë¶€ì¥ ê²½ê³„ ì²´í¬
            if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;

            // í›„ë“œì™€ ê¸°ì¤€ìƒë¶€ì¥ ê²¹ì¹¨ ì²´í¬
            if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;

            // ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ì •ë ¬
            const fixedModules = [
              { x: testHoodX, endX: testHoodX + hoodW, type: 'hood' },
              { x: testBaseX, endX: testBaseX + tempBaseUpperW, type: 'base' },
            ].sort((a, b) => a.x - b.x);

            // â˜… Step 5: ì‹œì‘ ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
            let startSpace = 0;
            let startDoorCount = 0;
            if (fixedModules[0].x > startBound + 50) {
              startSpace = fixedModules[0].x - startBound;
              startDoorCount = Math.round(startSpace / tempDoorWidth);
              if (startDoorCount < 1 && startSpace >= 200) startDoorCount = 1;
            }

            // ì¤‘ê°„ ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
            let middleSpace = 0;
            let middleDoorCount = 0;
            if (fixedModules[1].x > fixedModules[0].endX + 50) {
              middleSpace = fixedModules[1].x - fixedModules[0].endX;
              middleDoorCount = Math.round(middleSpace / tempDoorWidth);
              if (middleDoorCount < 1 && middleSpace >= 200) middleDoorCount = 1;
            }

            // â˜… Step 6: ë ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
            let endSpace = 0;
            let endDoorCount = 0;
            if (endBound > fixedModules[1].endX + 50) {
              endSpace = endBound - fixedModules[1].endX;
              endDoorCount = Math.round(endSpace / tempDoorWidth);
              if (endDoorCount < 1 && endSpace >= 200) endDoorCount = 1;
            }

            // ì´ ë„ì–´ ê°œìˆ˜ (ê¸°ì¤€ìƒë¶€ì¥ = 2D = ë„ì–´ 2ê°œ)
            const baseDoorCount = 2;
            const totalDoorCount = startDoorCount + middleDoorCount + baseDoorCount + endDoorCount;

            if (totalDoorCount < 2) continue;

            // â˜… Step 7: ê· ë“± ë„ì–´ ë„ˆë¹„ ê³„ì‚° (í›„ë“œ ì œì™¸ ì „ì²´ ê³µê°„ / ì´ ë„ì–´ ê°œìˆ˜)
            const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);

            // ë„ì–´ ì œì•½ ì¡°ê±´ í™•ì¸
            if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;

            // ìƒˆ ê¸°ì¤€ìƒë¶€ì¥ ë„ˆë¹„
            const newBaseUpperW = testDoorWidth * 2;

            // ìƒˆ ê¸°ì¤€ìƒë¶€ì¥ ìœ„ì¹˜ (ê°œìˆ˜ëŒ€ ì¤‘ì•™ ê¸°ì¤€ + offset)
            const newBaseUpperX = sinkCenter - newBaseUpperW / 2 + baseOffset;

            // ìƒˆ ê²½ê³„ ì²´í¬
            if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;

            // í›„ë“œì™€ ê²¹ì¹¨ ì¬ì²´í¬
            if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;

            // ì´ ì‚¬ìš© ê³µê°„ ë° ì”ì—¬ ê³„ì‚°
            const totalUsed = testDoorWidth * totalDoorCount;
            const totalRemainder = totalSpaceExcludeHood - totalUsed;

            // â˜… ì¡°ê±´: ì—¬ìœ ê³µê°„ â‰¤ 10mm
            if (totalRemainder >= 0 && totalRemainder <= MAX_REMAINDER) {
              if (totalRemainder < bestTotalRemainder) {
                bestTotalRemainder = totalRemainder;
                bestHoodOffset = hoodOffset;
                bestBaseOffset = baseOffset;
                bestDoorWidth = testDoorWidth;
                bestHoodX = testHoodX;
                bestBaseUpperX = newBaseUpperX;
              }
            }
          }
        }

        // ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²½ìš°ê°€ ì—†ìœ¼ë©´, ì”ì—¬ê°€ ê°€ì¥ ì‘ì€ ê²ƒ ì„ íƒ
        if (bestTotalRemainder > MAX_REMAINDER) {
          for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
            const testHoodX = hoodXInit + hoodOffset;
            if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;

            for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
              const testBaseX = baseUpperXInit + baseOffset;
              if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;
              if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;

              const fixedModules = [
                { x: testHoodX, endX: testHoodX + hoodW },
                { x: testBaseX, endX: testBaseX + tempBaseUpperW },
              ].sort((a, b) => a.x - b.x);

              let startDoorCount = 0,
                middleDoorCount = 0,
                endDoorCount = 0;

              if (fixedModules[0].x > startBound + 50) {
                startDoorCount = Math.max(1, Math.round((fixedModules[0].x - startBound) / tempDoorWidth));
              }
              if (fixedModules[1].x > fixedModules[0].endX + 50) {
                middleDoorCount = Math.max(1, Math.round((fixedModules[1].x - fixedModules[0].endX) / tempDoorWidth));
              }
              if (endBound > fixedModules[1].endX + 50) {
                endDoorCount = Math.max(1, Math.round((endBound - fixedModules[1].endX) / tempDoorWidth));
              }

              const totalDoorCount = startDoorCount + middleDoorCount + 2 + endDoorCount;
              if (totalDoorCount < 2) continue;

              const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);
              if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;

              const newBaseUpperW = testDoorWidth * 2;
              const newBaseUpperX = sinkCenter - newBaseUpperW / 2 + baseOffset;

              if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;
              if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;

              const totalRemainder = Math.abs(totalSpaceExcludeHood - testDoorWidth * totalDoorCount);

              if (totalRemainder < bestTotalRemainder) {
                bestTotalRemainder = totalRemainder;
                bestHoodOffset = hoodOffset;
                bestBaseOffset = baseOffset;
                bestDoorWidth = testDoorWidth;
                bestHoodX = testHoodX;
                bestBaseUpperX = newBaseUpperX;
              }
            }
          }
        }

        // â˜… ìµœì¢… ëª¨ë“ˆ ë°°ì¹˜
        const finalBaseUpperW = bestDoorWidth * 2;
        const finalHoodX = bestHoodX;
        const finalBaseUpperX = bestBaseUpperX;

        let fixedOccupied = [];

        // í›„ë“œ ì¶”ê°€
        fixedOccupied.push({
          type: 'hood',
          name: 'í›„ë“œì¥',
          w: hoodW,
          h: upperBodyH - 40,
          d: 295,
          x: finalHoodX,
          endX: finalHoodX + hoodW,
          pos: 'upper',
          isFixed: true,
        });

        // ê¸°ì¤€ ìƒë¶€ì¥ ì¶”ê°€
        fixedOccupied.push({
          type: 'storage',
          name: 'ê¸°ì¤€ìƒë¶€ì¥(2D)',
          w: finalBaseUpperW,
          h: upperBodyH,
          d: 295,
          x: finalBaseUpperX,
          endX: finalBaseUpperX + finalBaseUpperW,
          pos: 'upper',
          isFixed: true,
          isBase: true,
        });

        // ìœ„ì¹˜ ì¡°ì • ë° Gap ê³„ì‚°
        fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);
        const gaps = calculateGaps(fixedOccupied, startBound, endBound);

        // â˜… ëª¨ë“ˆ ìƒì„± (ëª¨ë“  gapì— ë™ì¼í•œ ë„ì–´ ë„ˆë¹„ ì ìš©)
        item.modules = item.modules.filter((m) => m.pos !== 'upper');
        let newModules = [];

        gaps.forEach((gap) => {
          newModules = newModules.concat(fillGapWithModules(gap, 'upper', upperBodyH, 295, bestDoorWidth));
        });

        // ê³ ì • ëª¨ë“ˆ ì¶”ê°€
        fixedOccupied.forEach((fixed) => {
          newModules.push({
            id: fixed.id || Date.now() + Math.random(),
            type: fixed.type,
            name: fixed.name,
            pos: 'upper',
            w: fixed.w,
            h: fixed.h,
            d: fixed.d,
            isDrawer: fixed.isDrawer || false,
            isEL: fixed.isEL || false,
            isFixed: true,
            isBase: fixed.isBase || false,
            _x: fixed.x,
          });
        });

        // ì •ë ¬ ë° ì €ì¥
        newModules.sort((a, b) => a._x - b._x);
        newModules.forEach((m) => delete m._x);
        if (!isRefLeft) newModules.reverse();

        item.modules = item.modules.concat(newModules);

        console.log(
          `ìƒë¶€ì¥: ë„ì–´=${bestDoorWidth}mm, ê¸°ì¤€ìƒë¶€ì¥=${finalBaseUpperW}mm, í›„ë“œoffset=${bestHoodOffset}mm, ê¸°ì¤€offset=${bestBaseOffset}mm, ì”ì—¬=${bestTotalRemainder}mm`
        );
      }

      function runAutoCalcLower(item) {
        const W = parseFloat(item.w) || 0;
        const effectiveW = getEffectiveSpace(item, 'lower');

        if (effectiveW <= 0) {
          alert('í•˜ë¶€ì¥ ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }

        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const startBound = fL;
        const endBound = startBound + effectiveW;
        const isRefLeft = item.specs.measurementBase === 'Left';

        // ì„¤ë¹„ ìœ„ì¹˜ ê³„ì‚°
        let absDistStart, absDistEnd, absVent;
        if (isRefLeft) {
          absDistStart = parseFloat(item.specs.distributorStart) || 0;
          absDistEnd = parseFloat(item.specs.distributorEnd) || 0;
          absVent = parseFloat(item.specs.ventStart) || 0;
        } else {
          const dS = parseFloat(item.specs.distributorStart) || 0;
          const dE = parseFloat(item.specs.distributorEnd) || 0;
          absDistStart = Math.min(W - dS, W - dE);
          absDistEnd = Math.max(W - dS, W - dE);
          absVent = W - (parseFloat(item.specs.ventStart) || 0);
        }

        const specLowerH = parseFloat(item.specs.lowerH) || 870;
        const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;
        const defaultLowerH = specLowerH - specLegH;

        // í˜„ì¬ ê³ ì • ëª¨ë“ˆ (ê°œìˆ˜ëŒ€, ê°€ìŠ¤ëŒ€, ELì¥, LTë§ì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
        const currentModules = item.modules.filter((m) => m.pos === 'lower');

        // í•„ìˆ˜ ëª¨ë“ˆ ìœ„ì¹˜ ê³„ì‚°
        const sinkW = 1000,
          cookW = 600;

        // â˜… ê°œìˆ˜ëŒ€ ê¸°ë³¸ ìœ„ì¹˜: ë¶„ë°°ê¸°ì‹œì‘ - 100
        let sinkX = absDistStart - 100;

        // â˜… ê°œìˆ˜ëŒ€ ë…¼ë¦¬ ì¡°ê±´ ê²€ì¦ (ì—…ë°ì´íŠ¸)
        // ì¡°ê±´1 ì¶©ì¡±: ê°œìˆ˜ëŒ€ì‹œì‘ < ë¶„ë°°ê¸°ì‹œì‘
        // ì¡°ê±´2 ì¶©ì¡±: ê°œìˆ˜ëŒ€ë > ë¶„ë°°ê¸°ë

        // ì¡°ê±´1 ìœ„ë°˜ ì‹œ: ê°œìˆ˜ëŒ€ ì‹œì‘ì  = ë¶„ë°°ê¸° ì‹œì‘ì  - 100mm
        if (sinkX >= absDistStart) {
          sinkX = absDistStart - 100;
        }
        // ì¡°ê±´2 ìœ„ë°˜ ì‹œ: ê°œìˆ˜ëŒ€ ì‹œì‘ì  = ë¶„ë°°ê¸° ëì  - ê°œìˆ˜ëŒ€ ë„ˆë¹„ + 100mm
        if (sinkX + sinkW <= absDistEnd) {
          sinkX = absDistEnd - sinkW + 100;
        }

        // â˜… ê°œìˆ˜ëŒ€ ì´ë™ ê°€ëŠ¥ ë²”ìœ„ ê³„ì‚°
        // ì¡°ê±´1 ì¶©ì¡±: sinkX < absDistStart
        // ì¡°ê±´2 ì¶©ì¡±: sinkX + sinkW > absDistEnd â†’ sinkX > absDistEnd - sinkW
        const sinkMinX = absDistEnd - sinkW + 1; // ì¡°ê±´2 ë§Œì¡± ìµœì†Œê°’
        const sinkMaxX = absDistStart - 1; // ì¡°ê±´1 ë§Œì¡± ìµœëŒ€ê°’

        // â˜… ê°€ìŠ¤ëŒ€ ìœ„ì¹˜: í™˜í’êµ¬ ì¤‘ì•™ ì •ë ¬
        const cookX = absVent - cookW / 2;

        // â˜… LTë§ì¥ ìœ„ì¹˜ ê³„ì‚°
        let ltX = null,
          ltW = 200;
        if (item.specs.accessories.some((a) => a.type === 'LTMesh')) {
          if (isRefLeft) {
            ltX = cookX + cookW;
          } else {
            ltX = cookX - ltW;
          }
        }

        // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ í™•ì¸ (ELì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
        const hasUserFixedModules = currentModules.some(
          (m) => m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥'
        );

        // â˜… ëª¨ë“ˆ ìˆ˜ì • í›„ ì¬ê³„ì‚° ì‹œ: ê°œìˆ˜ëŒ€ ìœ„ì¹˜ ìµœì í™”
        if (hasUserFixedModules) {
          // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ìˆ˜ì§‘
          let userFixedModules = [];
          let tempX = startBound;
          currentModules.forEach((m) => {
            if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥') {
              userFixedModules.push({ ...m, x: tempX, endX: tempX + parseFloat(m.w) });
            }
            tempX += parseFloat(m.w) || 0;
          });

          // ê°œìˆ˜ëŒ€ ì´ë™ ê°€ëŠ¥ ë²”ìœ„ ë‚´ì—ì„œ ìµœì  ìœ„ì¹˜ ì°¾ê¸°
          let bestSinkX = sinkX;
          let bestTotalRemainder = Infinity;

          // 1mm ë‹¨ìœ„ë¡œ íƒìƒ‰ (ë²”ìœ„ ë‚´ì—ì„œ)
          const searchMin = Math.max(startBound, sinkMinX);
          const searchMax = Math.min(endBound - sinkW, sinkMaxX);

          for (let testSinkX = searchMin; testSinkX <= searchMax; testSinkX++) {
            // ì„ì‹œ ê³ ì • ëª¨ë“ˆ ë°°ì—´ êµ¬ì„±
            let tempFixed = [
              { x: testSinkX, endX: testSinkX + sinkW },
              { x: cookX, endX: cookX + cookW },
            ];
            if (ltX !== null) {
              tempFixed.push({ x: ltX, endX: ltX + ltW });
            }
            userFixedModules.forEach((m) => {
              tempFixed.push({ x: m.x, endX: m.endX });
            });
            tempFixed.sort((a, b) => a.x - b.x);

            // gapë“¤ì˜ ì”ì—¬ê³µê°„ í•© ê³„ì‚°
            let totalRemainder = 0;
            let cursor = startBound;

            for (const fixed of tempFixed) {
              if (fixed.x > cursor + 1) {
                const gapWidth = fixed.x - cursor;
                // ë…ë¦½ ë¶„ë°° ê²°ê³¼ì˜ ì”ì—¬ ê³„ì‚°
                const result = distributeModules(gapWidth);
                if (result.doorCount > 0) {
                  const used = result.doorWidth * result.doorCount;
                  totalRemainder += Math.abs(gapWidth - used);
                }
              }
              cursor = Math.max(cursor, fixed.endX);
            }
            if (cursor < endBound - 1) {
              const gapWidth = endBound - cursor;
              const result = distributeModules(gapWidth);
              if (result.doorCount > 0) {
                const used = result.doorWidth * result.doorCount;
                totalRemainder += Math.abs(gapWidth - used);
              }
            }

            // ìµœì  ìœ„ì¹˜ ì„ íƒ
            if (totalRemainder < bestTotalRemainder) {
              bestTotalRemainder = totalRemainder;
              bestSinkX = testSinkX;
            }
          }

          sinkX = bestSinkX;
        }

        let fixedOccupied = [
          {
            type: 'sink',
            name: 'ê°œìˆ˜ëŒ€',
            w: sinkW,
            h: defaultLowerH,
            d: 600,
            x: sinkX,
            endX: sinkX + sinkW,
            pos: 'lower',
            isFixed: true,
          },
          {
            type: 'cook',
            name: 'ê°€ìŠ¤ëŒ€',
            w: cookW,
            h: defaultLowerH,
            d: 550,
            x: cookX,
            endX: cookX + cookW,
            pos: 'lower',
            isFixed: true,
          },
        ];

        // â˜… LTë§ì¥ ì¶”ê°€
        if (ltX !== null) {
          fixedOccupied.push({
            type: 'storage',
            name: 'LTë§ì¥',
            w: ltW,
            h: defaultLowerH,
            d: 550,
            x: ltX,
            endX: ltX + ltW,
            isDrawer: true,
            pos: 'lower',
            isFixed: true,
          });
        }

        // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ ì¶”ê°€ (ELì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
        let tempX2 = startBound;
        currentModules.forEach((m) => {
          if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥') {
            fixedOccupied.push({ ...m, x: tempX2, endX: tempX2 + parseFloat(m.w) });
          }
          tempX2 += parseFloat(m.w) || 0;
        });

        // ìœ„ì¹˜ ì¡°ì • ë° Gap ê³„ì‚°
        fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);

        if (fixedOccupied[0] && fixedOccupied[0].x < startBound) {
          alert('ê³µê°„ì´ ë¶€ì¡±í•˜ì—¬ í•„ìˆ˜ ì¥ì„ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const gaps = calculateGaps(fixedOccupied, startBound, endBound);

        // í•˜ë¶€ì¥ ì´ˆê¸°í™” í›„ ìƒˆ ëª¨ë“ˆ ìƒì„±
        item.modules = item.modules.filter((m) => m.pos !== 'lower');
        let newModules = [];

        // hasUserFixedModulesëŠ” ì´ë¯¸ ìœ„ì—ì„œ ê³„ì‚°ë¨
        if (hasUserFixedModules) {
          // â˜… í†µí•© ë¶„ë°°: ëª¨ë“ˆ ìˆ˜ì • í›„ ì¬ê³„ì‚° ì‹œ
          // ì „ì²´ ê°€ìš© ê³µê°„ì—ì„œ í‘œì¤€ ë„ì–´ ë„ˆë¹„ ê³„ì‚°
          const totalAvailable = gaps.reduce((sum, g) => sum + g.width, 0);
          const standardResult = distributeModules(totalAvailable);
          const standardDoorWidth = standardResult.doorWidth || DOOR_TARGET_WIDTH;

          gaps.forEach((gap) => {
            newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, standardDoorWidth));
          });
        } else {
          // â˜… ë…ë¦½ ë¶„ë°°: ì´ˆê¸° ìë™ê³„ì‚° ì‹œ
          // ê°œìˆ˜ëŒ€ ì‹œì‘ ê³µê°„ê³¼ ë ê³µê°„ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ë¶„ë°°
          gaps.forEach((gap) => {
            newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, null));
          });
        }

        // ê³ ì • ëª¨ë“ˆ ì¶”ê°€
        fixedOccupied.forEach((fixed) => {
          newModules.push({
            id: fixed.id || Date.now() + Math.random(),
            type: fixed.type,
            name: fixed.name,
            pos: 'lower',
            w: fixed.w,
            h: fixed.h,
            d: fixed.d,
            isDrawer: fixed.isDrawer || false,
            isEL: fixed.isEL || false,
            isFixed: true,
            _x: fixed.x,
          });
        });

        // ì •ë ¬ ë° ì €ì¥
        newModules.sort((a, b) => a._x - b._x);
        newModules.forEach((m) => delete m._x);
        if (!isRefLeft) newModules.reverse();

        item.modules = item.modules.concat(newModules);
      }

      function undoAutoCalc(itemUniqueId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        if (section === 'upper' && item.prevUpperModules) {
          item.modules = item.modules.filter((m) => m.pos !== 'upper').concat(item.prevUpperModules);
          item.prevUpperModules = null;
        } else if (section === 'lower' && item.prevLowerModules) {
          item.modules = item.modules.filter((m) => m.pos !== 'lower').concat(item.prevLowerModules);
          item.prevLowerModules = null;
        }
        renderWorkspaceContent(item);
      }

      // ============================================================
      // UI ê´€ë ¨ í•¨ìˆ˜ë“¤
      // ============================================================

      function initCategoryGrid() {
        const gridEl = document.getElementById('categoryGrid');
        CATEGORIES.forEach((cat) => {
          const btn = document.createElement('div');
          btn.className = 'category-card';
          btn.id = `btn-${cat.id}`;
          btn.innerHTML = `
      <div class="category-name">${cat.name}</div>
      <div class="card-stepper" onclick="event.stopPropagation()">
        <button class="stepper-btn" onclick="decrementCategory('${cat.id}')">ï¼</button>
        <span class="stepper-count" id="count-${cat.id}">0</span>
        <button class="stepper-btn" onclick="incrementCategory('${cat.id}')">ï¼‹</button>
      </div>
    `;
          btn.addEventListener('click', () => incrementCategory(cat.id));
          gridEl.appendChild(btn);
        });
      }

      function incrementCategory(catId) {
        const cat = CATEGORIES.find((c) => c.id === catId);
        const specLegH = 150;
        const specLowerH = 870;
        const specUpperH = 720;
        const lowerBodyH = specLowerH - specLegH;
        const upperBodyH = specUpperH - 20;

        const newItem = {
          uniqueId: Date.now() + Math.random(),
          categoryId: cat.id,
          name: cat.name,
          defaultD: cat.defaultD,
          w: '',
          h: '',
          d: '',
          image: null,
          specs: JSON.parse(JSON.stringify(DEFAULT_SPECS)),
          modules: [],
          prevUpperModules: null,
          prevLowerModules: null,
        };

        // â˜… ë¶™ë°•ì´ì¥: ê¸°ë³¸ ë§ˆê°ì„ ëª°ë”©ìœ¼ë¡œ ì„¤ì •
        if (cat.id === 'wardrobe') {
          newItem.specs.finishLeftType = 'Molding';
          newItem.specs.finishRightType = 'Molding';
        }

        // â˜… ëƒ‰ì¥ê³ ì¥: ê·œì¹™ ê¸°ë°˜ ì´ˆê¸°í™” (ì—…ë°ì´íŠ¸)
        if (cat.id === 'fridge') {
          newItem.specs.fridgeBrand = 'LG';
          newItem.specs.fridgeMoldingH = FRIDGE_RULES.MOLDING_H; // ìƒëª°ë”© ë†’ì´
          newItem.specs.fridgePedestal = FRIDGE_RULES.PEDESTAL_H; // ì¢ŒëŒ€ ë†’ì´
          newItem.specs.fridgeModuleD = FRIDGE_RULES.MODULE_D; // ëª¨ë“ˆ ê¹Šì´ ê¸°ë³¸ 550
          newItem.specs.finishLeftType = 'molding'; // ëª°ë”© ê¸°ë³¸
          newItem.specs.finishRightType = 'molding'; // ëª°ë”© ê¸°ë³¸
          newItem.specs.finishLeftWidth = 60;
          newItem.specs.finishRightWidth = 60;
          // ìë™ê³„ì‚° ê´€ë ¨
          newItem.specs.autoCalculated = false;
        }

        if (cat.id === 'sink') {
          newItem.modules = [
            {
              id: 1,
              type: 'sink',
              name: 'ê°œìˆ˜ëŒ€',
              pos: 'lower',
              w: 1000,
              h: lowerBodyH,
              d: 600,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
            {
              id: 2,
              type: 'cook',
              name: 'ê°€ìŠ¤ëŒ€',
              pos: 'lower',
              w: 600,
              h: lowerBodyH,
              d: 550,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
            {
              id: 3,
              type: 'storage',
              name: 'LTë§ì¥',
              pos: 'lower',
              w: 200,
              h: lowerBodyH,
              d: 550,
              isDrawer: true,
              isEL: false,
              isFixed: true,
            },
            {
              id: 4,
              type: 'hood',
              name: 'í›„ë“œì¥',
              pos: 'upper',
              w: 800,
              h: upperBodyH - 40,
              d: 295,
              isDrawer: false,
              isEL: false,
              isFixed: true,
            },
          ];
        }

        selectedItems.push(newItem);
        updateUI();
      }

      function decrementCategory(catId) {
        const targets = selectedItems.filter((item) => item.categoryId === catId);
        if (targets.length > 0) removeInstance(targets[targets.length - 1].uniqueId);
      }

      function removeInstance(uniqueId) {
        selectedItems = selectedItems.filter((item) => item.uniqueId !== uniqueId);
        updateUI();
      }

      function updateUI() {
        const container = document.getElementById('dynamicInputList');
        const detailSection = document.getElementById('detailInputSection');

        detailSection.style.display = selectedItems.length > 0 ? 'block' : 'none';

        CATEGORIES.forEach((cat) => {
          const count = selectedItems.filter((item) => item.categoryId === cat.id).length;
          document.getElementById(`count-${cat.id}`).innerText = count;
          const btn = document.getElementById(`btn-${cat.id}`);
          btn.classList.toggle('active', count > 0);
        });

        const typeCounter = {};
        container.innerHTML = '';

        selectedItems.forEach((item) => {
          typeCounter[item.categoryId] = (typeCounter[item.categoryId] || 0) + 1;
          item.labelName = `${item.name} #${typeCounter[item.categoryId]}`;

          if (item.specs.layoutShape === 'I' && !item.specs.topSizes[0] && item.w && item.d) {
            item.specs.topSizes[0] = `${item.w} x ${item.d}`;
          }

          const sinkInputs =
            item.categoryId === 'sink'
              ? `
      <div class="extra-settings">
        <div class="extra-title">Layout & ì„¤ë¹„ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>êµ¬ì¡° í˜•íƒœ</label>
            <select onchange="changeLayoutShape(${item.uniqueId}, this.value)">
              <option value="I" ${item.specs.layoutShape === 'I' ? 'selected' : ''}>ã…¡ìí˜•</option>
              <option value="L" ${item.specs.layoutShape === 'L' ? 'selected' : ''}>ã„±ìí˜•</option>
              <option value="U" ${item.specs.layoutShape === 'U' ? 'selected' : ''}>ã„·ìí˜•</option>
            </select>
          </div>
          <div class="input-group"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase === 'Left' ? 'selected' : ''}>ì¢Œì¸¡</option>
              <option value="Right" ${item.specs.measurementBase === 'Right' ? 'selected' : ''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>ë¶„ë°°ê¸° ì‹œì‘(mm)</label><input type="number" value="${item.specs.distributorStart}" oninput="updateSpec(${item.uniqueId}, 'distributorStart', this.value)"></div>
          <div class="input-group"><label>ë¶„ë°°ê¸° ë(mm)</label><input type="number" value="${item.specs.distributorEnd}" oninput="updateSpec(${item.uniqueId}, 'distributorEnd', this.value)"></div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>í™˜í’êµ¬ ìœ„ì¹˜(mm)</label><input type="number" value="${item.specs.ventStart}" oninput="updateSpec(${item.uniqueId}, 'ventStart', this.value)"></div>
        </div>
      </div>
    `
              : '';

          // â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì…ë ¥ í¼
          const wardrobeInputs =
            item.categoryId === 'wardrobe'
              ? `
      <div class="extra-settings">
        <div class="extra-title">ë¶™ë°•ì´ì¥ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase === 'Left' ? 'selected' : ''}>ì¢Œì¸¡</option>
              <option value="Right" ${item.specs.measurementBase === 'Right' ? 'selected' : ''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>ì»¤íŠ¼ë°•ìŠ¤ ê°€ë¡œ(mm)</label><input type="number" value="${item.specs.curtainBoxW || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="input-group"><label>ì»¤íŠ¼ë°•ìŠ¤ ë†’ì´(mm)</label><input type="number" value="${item.specs.curtainBoxH || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>
      </div>
    `
              : '';

          // â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì…ë ¥ í¼ (ê·œì¹™ ê¸°ë°˜)
          const fridgeInputs =
            item.categoryId === 'fridge'
              ? `
      <div class="extra-settings">
        <div class="extra-title">ğŸ§Š ëƒ‰ì¥ê³ ì¥ ê¸°ë³¸ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>ë¸Œëœë“œ</label>
            <select onchange="updateSpec(${item.uniqueId}, 'fridgeBrand', this.value)">
              <option value="LG" ${item.specs.fridgeBrand === 'LG' ? 'selected' : ''}>LG</option>
              <option value="Samsung" ${item.specs.fridgeBrand === 'Samsung' ? 'selected' : ''}>ì‚¼ì„±</option>
            </select>
          </div>
          <div class="input-group"><label>ìƒëª°ë”© ë†’ì´(mm)</label>
            <input type="number" value="${item.specs.fridgeMoldingH || 50}" oninput="updateSpec(${item.uniqueId}, 'fridgeMoldingH', this.value)">
          </div>
        </div>
        <div style="font-size:10px;color:#666;margin-top:4px;">
          â€» ìƒë¶€ì¥ ë„ì–´H = ì‹¤ì¸¡H - ëƒ‰ì¥ê³ H - 15 - ìƒëª°ë”©H (ìµœëŒ€ 400mm)
        </div>
      </div>
    `
              : '';

          const imageHtml =
            item.image === 'loading'
              ? `<div style="font-size:14px;">â³</div><div>ì—…ë¡œë“œì¤‘...</div>`
              : item.image
                ? `<img src="${item.image}" alt="preview" onerror="this.outerHTML='<div>âŒ ì˜¤ë¥˜</div>'">`
                : `<div style="font-size:20px;">ğŸ“·</div><div>ì‚¬ì§„</div>`;

          const card = document.createElement('div');
          card.className = 'item-input-card';
          card.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
        <div style="font-weight:bold;color:var(--primary-color);">${item.labelName}</div>
        <button class="btn-delete" onclick="removeInstance(${item.uniqueId})">Ã—</button>
      </div>
      <div class="item-body">
        <div class="input-section">
          <div class="input-row">
            <div class="input-group"><label>ê°€ë¡œ(W)</label><input type="number" placeholder="mm" value="${item.w}" oninput="updateItemValue(${item.uniqueId}, 'w', this.value)"></div>
            <div class="input-group"><label>ë†’ì´(H)</label><input type="number" placeholder="mm" value="${item.h}" oninput="updateItemValue(${item.uniqueId}, 'h', this.value)"></div>
            <div class="input-group"><label>ê¹Šì´(D)</label><input type="number" placeholder="mm" value="${item.d || item.defaultD || ''}" oninput="updateItemValue(${item.uniqueId}, 'd', this.value)"></div>
          </div>
          ${sinkInputs}
          ${wardrobeInputs}
          ${fridgeInputs}
        </div>
        <div class="photo-section">
          <label>í˜„ì¥ ì‚¬ì§„</label>
          <div class="photo-box" onclick="document.getElementById('file-${item.uniqueId}').click()">${imageHtml}</div>
          <input type="file" id="file-${item.uniqueId}" class="file-input-hidden" accept="image/*" onchange="handleItemPhoto(${item.uniqueId}, event)">
        </div>
      </div>
    `;
          container.appendChild(card);
          if (!item.d && item.defaultD > 0) item.d = item.defaultD;
        });

        document.getElementById('btnNext').disabled =
          selectedItems.length === 0 || !selectedItems.every((item) => item.w && item.h && item.d);
        document.getElementById('aiGuideText').innerHTML =
          selectedItems.length > 0
            ? `ì´ <strong>${selectedItems.length}ê°œ</strong>ì˜ ê°€êµ¬ ì„¤ì • ì¤‘...`
            : 'ê°€êµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì…ë ¥ì°½ì´ ìƒì„±ë©ë‹ˆë‹¤.';
      }

      function updateItemValue(uniqueId, field, value) {
        const target = selectedItems.find((item) => item.uniqueId === uniqueId);
        if (target) {
          target[field] = value;
          if (target.specs.layoutShape === 'I' && (field === 'w' || field === 'd')) {
            target.specs.topSizes[0] = `${target.w} x ${target.d}`;
          }
          // â˜… ë¶™ë°•ì´ì¥: ê°€ë¡œ(W) ë³€ê²½ ì‹œ ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚°
          if (target.categoryId === 'wardrobe' && field === 'w') {
            const W = parseFloat(value) || 0;
            const fL = target.specs.finishLeftType !== 'None' ? parseFloat(target.specs.finishLeftWidth) || 0 : 0;
            const fR = target.specs.finishRightType !== 'None' ? parseFloat(target.specs.finishRightWidth) || 0 : 0;
            target.specs.wardrobeEffectiveW = W - fL - fR;
          }
          document.getElementById('btnNext').disabled = !selectedItems.every((item) => item.w && item.h && item.d);
        }
      }

      async function handleItemPhoto(uniqueId, event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!currentUser) {
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        const target = selectedItems.find((item) => item.uniqueId === uniqueId);
        if (!target) return;

        // ë¡œë”© í‘œì‹œ
        target.image = 'loading';
        updateUI();

        try {
          const imageUrl = await uploadImageToStorage(file, currentUser.id);
          target.image = imageUrl;
          target.imageUrl = imageUrl;
          updateUI();
          hasUnsavedChanges = true;
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
          alert(error.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          target.image = null;
          updateUI();
        }
      }

      function goToStep2() {
        document.getElementById('step1-content').style.display = 'none';
        document.getElementById('step2-content').style.display = 'block';
        document.getElementById('step-dot-1').classList.remove('active');
        document.getElementById('step-dot-2').classList.add('active');
        renderBookmarks();
      }

      function backToStep1() {
        document.getElementById('step1-content').style.display = 'block';
        document.getElementById('step2-content').style.display = 'none';
        document.getElementById('step-dot-1').classList.add('active');
        document.getElementById('step-dot-2').classList.remove('active');
        updateUI();
      }

      function renderBookmarks() {
        const tabsContainer = document.getElementById('bookmarkTabs');
        tabsContainer.innerHTML = '';
        selectedItems.forEach((item, index) => {
          const tab = document.createElement('div');
          tab.className = 'bookmark-tab' + (index === 0 ? ' active' : '');
          tab.innerText = item.labelName;
          tab.onclick = () => {
            document.querySelectorAll('.bookmark-tab').forEach((t) => t.classList.remove('active'));
            tab.classList.add('active');
            currentItemId = item.uniqueId;
            renderWorkspaceContent(item);
          };
          tabsContainer.appendChild(tab);
        });
        if (selectedItems.length > 0) {
          currentItemId = selectedItems[0].uniqueId;
          renderWorkspaceContent(selectedItems[0]);
        }
      }

      // ë Œë”ë§ debounceë¥¼ ìœ„í•œ íƒ€ì´ë¨¸ ì €ì¥ì†Œ
      const _renderTimers = new Map();

      function renderWorkspaceContent(item) {
        if (!item || !item.uniqueId) return;

        // â˜… ì„±ëŠ¥ ìµœì í™”: ë™ì¼ ì•„ì´í…œì— ëŒ€í•œ ì—°ì† ë Œë”ë§ ìš”ì²­ì„ debounce
        const itemId = item.uniqueId;
        if (_renderTimers.has(itemId)) {
          clearTimeout(_renderTimers.get(itemId));
        }

        _renderTimers.set(
          itemId,
          setTimeout(() => {
            _renderTimers.delete(itemId);
            _renderWorkspaceContentImpl(item);
          }, 30)
        ); // 30ms debounce
      }

      // ì‹¤ì œ ë Œë”ë§ êµ¬í˜„
      function _renderWorkspaceContentImpl(item) {
        const ws = document.getElementById('designWorkspace');
        if (!ws) return;

        // â˜… í¬ì»¤ìŠ¤ ë³µì›ì„ ìœ„í•œ ì •ë³´ ì €ì¥
        const activeEl = document.activeElement;
        let focusInfo = null;
        if (activeEl && activeEl.tagName === 'INPUT' && ws.contains(activeEl)) {
          focusInfo = {
            type: activeEl.type,
            value: activeEl.value,
            selectionStart: activeEl.selectionStart,
            selectionEnd: activeEl.selectionEnd,
            // ìš”ì†Œ ì‹ë³„ì„ ìœ„í•œ ì†ì„±ë“¤
            onchange: activeEl.getAttribute('onchange'),
            onblur: activeEl.getAttribute('onblur'),
            parentClass: activeEl.closest('.dim-group, .spec-field, .effective-space-group')?.className,
          };
        }

        // â˜… ë¶™ë°•ì´ì¥ì¸ ê²½ìš° ë³„ë„ ë Œë”ë§
        if (item.categoryId === 'wardrobe') {
          renderWardrobeWorkspace(item);
          _restoreFocus(ws, focusInfo);
          return;
        }

        // â˜… ëƒ‰ì¥ê³ ì¥ì¸ ê²½ìš° ë³„ë„ ë Œë”ë§
        if (item.categoryId === 'fridge') {
          renderFridgeWorkspace(item);
          _restoreFocus(ws, focusInfo);
          return;
        }

        const upperModules = item.modules.filter((m) => m.pos === 'upper');
        const lowerModules = item.modules.filter((m) => m.pos === 'lower');

        const autoEffectiveW = calcEffectiveSpace(item);
        const upperEffectiveW = getEffectiveSpace(item, 'upper');
        const lowerEffectiveW = getEffectiveSpace(item, 'lower');

        const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const upperRemaining = upperEffectiveW - upperUsedW;
        const lowerRemaining = lowerEffectiveW - lowerUsedW;

        const renderModuleCard = (mod, idx, section, totalCount) => {
          const icons = { sink: 'ğŸš°', cook: 'ğŸ”¥', hood: 'ğŸŒ€', tall: 'â†•ï¸', storage: mod.pos === 'upper' ? 'â¬†ï¸' : 'â¬‡ï¸' };
          const icon = icons[mod.type] || 'ğŸ“¦';
          const isTall = mod.type === 'tall';
          const isBase = mod.isBase; // â˜… ê¸°ì¤€ ëª¨ë“ˆ í™•ì¸

          const options =
            mod.pos === 'lower' && (mod.type === 'storage' || mod.type === 'tall')
              ? `
      <div class="module-options">
        <label class="module-chk"><input type="checkbox" ${mod.isDrawer ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isDrawer', this.checked)"> ì„œëì¥</label>
        <label class="module-chk"><input type="checkbox" ${mod.isEL ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isEL', this.checked)"> ELì¥</label>
        ${
          isTall
            ? `<div style="margin-top:4px;display:flex;gap:8px;">
          <label class="module-chk">ë„ì–´ìˆ˜: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.doorCount || 1}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'doorCount', this.value)"></label>
          <label class="module-chk">ELìˆ˜: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.elCount || 0}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'elCount', this.value)"></label>
        </div>`
            : ''
        }
      </div>
    `
              : '';

          // â˜… í´ë˜ìŠ¤ ê²°ì •: í‚¤í°ì¥ > ê¸°ì¤€ëª¨ë“ˆ > ê³ ì •ëª¨ë“ˆ
          let cardClass = 'module-card';
          if (isTall) cardClass += ' tall-type';
          else if (isBase) cardClass += ' base-module';
          else if (mod.isFixed) cardClass += ' fixed-module';

          const fixedClass = mod.isFixed ? 'active' : '';
          return `
      <div class="${cardClass}" data-module-id="${mod.id}">
        <div class="move-buttons">
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'up')" ${idx === 0 ? 'disabled' : ''}>â–²</button>
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'down')" ${idx === totalCount - 1 ? 'disabled' : ''}>â–¼</button>
        </div>
        <div class="module-icon">${icon}</div>
        <div class="module-info">
          <div class="module-header">
            <span class="module-title">${mod.name}</span>
            ${isTall ? '<span class="module-type-badge">í‚¤í°ì¥</span>' : ''}
            <button class="toggle-btn ${fixedClass}" style="margin-left:auto;font-size:9px;padding:2px 6px;" onclick="toggleSinkModuleFixed(${item.uniqueId}, ${mod.id})">ê³ ì •</button>
          </div>
          <div class="module-dims">
            <div class="dim-group"><label class="dim-label">W</label><input type="number" class="dim-input" value="${mod.w}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)"></div>
            <div class="dim-group"><label class="dim-label">H</label><input type="number" class="dim-input" value="${mod.h}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'h', this.value)"></div>
            <div class="dim-group"><label class="dim-label">D</label><input type="number" class="dim-input" value="${mod.d}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)"></div>
          </div>
          ${options}
        </div>
        <button class="btn-delete-module" onclick="removeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>
    `;
        };

        const upperModulesHtml = upperModules
          .map((m, i) => renderModuleCard(m, i, 'upper', upperModules.length))
          .join('');
        const lowerModulesHtml = lowerModules
          .map((m, i) => renderModuleCard(m, i, 'lower', lowerModules.length))
          .join('');

        const upperEffDisplay =
          item.specs.effectiveUpperW !== null ? item.specs.effectiveUpperW : Math.round(autoEffectiveW);
        const lowerEffDisplay =
          item.specs.effectiveLowerW !== null ? item.specs.effectiveLowerW : Math.round(autoEffectiveW);

        // â˜… ì‹±í¬ëŒ€ Front View SVG ìƒì„±
        const sinkW = parseFloat(item.w) || 3000;
        const sinkH = parseFloat(item.h) || 2400;
        const upperH = parseFloat(item.specs.upperH) || 720;
        const lowerH = parseFloat(item.specs.lowerH) || 870;
        const moldingH = parseFloat(item.specs.moldingH) || 50;
        const legH = parseFloat(item.specs.sinkLegHeight) || 120;
        const finishL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const finishR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;

        const svgWidth = 600;
        const svgHeight = 380;
        const scaleX = (svgWidth - 100) / sinkW;
        const scaleY = (svgHeight - 100) / sinkH;
        const scale = Math.min(scaleX, scaleY);
        const drawW = sinkW * scale;
        const drawH = sinkH * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        // ê° ì˜ì—­ ë†’ì´ (ìŠ¤ì¼€ì¼ ì ìš©)
        const moldingH_s = moldingH * scale;
        const upperH_s = upperH * scale;
        const lowerH_s = lowerH * scale;
        const legH_s = legH * scale;

        let sinkModuleSvg = '';

        // ìƒëª°ë”©
        sinkModuleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${moldingH_s}" fill="#e5e7eb" stroke="#9ca3af" stroke-width="1"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + moldingH_s / 2 + 3}" text-anchor="middle" font-size="9" fill="#666">ìƒëª°ë”© ${moldingH}mm</text>`;

        // ë„ì–´ ìƒ‰ìƒ ë° ê°„ê²© ì„¤ì •
        const showDoors = item.specs.showDoors || false;
        const doorColorU = getDoorColor(item.specs.doorColorUpper || 'í™”ì´íŠ¸');
        const doorColorL = getDoorColor(item.specs.doorColorLower || 'í™”ì´íŠ¸');
        const doorGap = 3 * scale; // 3mm ê°„ê²©

        // ìƒë¶€ì¥ ëª¨ë“ˆë“¤
        let upperStartX = offsetX + finishL * scale;
        const upperY = offsetY + moldingH_s;
        upperModules.forEach((mod, idx) => {
          const modW = parseFloat(mod.w) * scale;
          const icons = { hood: 'ğŸŒ€', storage: 'ğŸ“¦' };
          const icon = icons[mod.type] || 'ğŸ“¦';
          const fillColor = mod.type === 'hood' ? '#fef3c7' : '#eff6ff';
          const strokeColor = mod.type === 'hood' ? '#f59e0b' : '#3b82f6';
          sinkModuleSvg += `<rect x="${upperStartX}" y="${upperY}" width="${modW}" height="${upperH_s}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
      <text x="${upperStartX + modW / 2}" y="${upperY + upperH_s / 2 - 8}" text-anchor="middle" font-size="11" fill="${mod.type === 'hood' ? '#b45309' : '#1d4ed8'}" font-weight="bold">${icon}</text>
      <text x="${upperStartX + modW / 2}" y="${upperY + upperH_s / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${mod.w}</text>`;
          upperStartX += modW;
        });

        // â˜… ìƒë¶€ì¥ ë„ì–´ í‘œì‹œ
        if (showDoors) {
          let upperDoorX = offsetX + finishL * scale;
          upperModules.forEach((mod, idx) => {
            const modW = parseFloat(mod.w) * scale;
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = modW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = upperDoorX + d * dW + doorGap / 2;
              sinkModuleSvg += `<rect x="${dX}" y="${upperY + doorGap / 2}" width="${dW - doorGap}" height="${upperH_s - doorGap}" fill="${doorColorU}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
            upperDoorX += modW;
          });
        }

        // ì¤‘ê°„ ê³µê°„ (ìƒíŒ ì˜ì—­)
        const middleY = upperY + upperH_s;
        const middleH_s = drawH - moldingH_s - upperH_s - lowerH_s - legH_s;
        if (middleH_s > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${middleY}" width="${drawW}" height="${middleH_s}" fill="#fafafa" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4"/>`;
        }

        // í•˜ë¶€ì¥ ëª¨ë“ˆë“¤ + ë‹¤ë¦¬ë°œ ì—°ë™
        let lowerStartX = offsetX + finishL * scale;
        const lowerY = middleY + middleH_s;

        lowerModules.forEach((mod, idx) => {
          const modW = parseFloat(mod.w) * scale;
          const isTall = mod.type === 'tall';
          // í‚¤í°ì¥ì€ ìƒë¶€ì¥~í•˜ë¶€ì¥, ì¼ë°˜ í•˜ë¶€ì¥ì€ í•˜ë¶€ì¥+ë‹¤ë¦¬ë°œ
          const modH_s = isTall ? upperH_s + middleH_s + lowerH_s : lowerH_s + legH_s;
          const modY = isTall ? upperY : lowerY;

          const icons = { sink: 'ğŸš°', cook: 'ğŸ”¥', tall: 'â†•ï¸', storage: 'ğŸ—„ï¸' };
          const icon = icons[mod.type] || 'ğŸ“¦';
          let fillColor = '#f3f4f6';
          let strokeColor = '#6b7280';
          if (mod.type === 'sink') {
            fillColor = '#dbeafe';
            strokeColor = '#3b82f6';
          } else if (mod.type === 'cook') {
            fillColor = '#fee2e2';
            strokeColor = '#ef4444';
          } else if (isTall) {
            fillColor = '#dcfce7';
            strokeColor = '#10b981';
          } else if (mod.isDrawer) {
            fillColor = '#fef3c7';
            strokeColor = '#f59e0b';
          }

          // ëª¨ë“ˆ ë³¸ì²´ (ë‹¤ë¦¬ë°œ í¬í•¨ ë†’ì´)
          sinkModuleSvg += `<rect x="${lowerStartX}" y="${modY}" width="${modW}" height="${modH_s}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>`;

          // ë‹¤ë¦¬ë°œ êµ¬ë¶„ì„  (í‚¤í°ì¥ ì œì™¸)
          if (!isTall) {
            const legLineY = lowerY + lowerH_s;
            sinkModuleSvg += `<line x1="${lowerStartX}" y1="${legLineY}" x2="${lowerStartX + modW}" y2="${legLineY}" stroke="${strokeColor}" stroke-width="1" stroke-dasharray="3"/>`;
            sinkModuleSvg += `<text x="${lowerStartX + modW / 2}" y="${legLineY + legH_s / 2 + 3}" text-anchor="middle" font-size="7" fill="#888">${legH}</text>`;
          }

          // ë„ì–´ í‘œì‹œ (showDoorsê°€ trueì¼ ë•Œ)
          if (showDoors && !isTall) {
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = modW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = lowerStartX + d * dW + doorGap / 2;
              sinkModuleSvg += `<rect x="${dX}" y="${modY + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_s - doorGap}" fill="${doorColorL}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
          }

          // ì•„ì´ì½˜ & í…ìŠ¤íŠ¸ (ë„ì–´ í‘œì‹œì‹œ ì¼ë°˜ í•˜ë¶€ì¥ ì•„ì´ì½˜ ìˆ¨ê¹€, í‚¤í°ì¥ì€ í•­ìƒ í‘œì‹œ)
          if (!showDoors || isTall) {
            sinkModuleSvg += `<text x="${lowerStartX + modW / 2}" y="${modY + (isTall ? modH_s : lowerH_s) / 2 - 8}" text-anchor="middle" font-size="12" fill="${strokeColor}" font-weight="bold">${icon}</text>
        <text x="${lowerStartX + modW / 2}" y="${modY + (isTall ? modH_s : lowerH_s) / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${mod.w}${isTall ? ' (TL)' : ''}</text>`;
          }
          lowerStartX += modW;
        });

        // ë‹¤ë¦¬ë°œ (ì „ì²´ ì˜ì—­ - ë§ˆê° í¬í•¨)
        const legY = lowerY + lowerH_s;
        // ë§ˆê° ì˜ì—­ ì•„ë˜ì—ë„ ë‹¤ë¦¬ë°œ í‘œì‹œ
        if (finishL > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${legY}" width="${finishL * scale}" height="${legH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        }
        if (finishR > 0) {
          sinkModuleSvg += `<rect x="${offsetX + drawW - finishR * scale}" y="${legY}" width="${finishR * scale}" height="${legH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        }

        // ì¢Œì¸¡ ë§ˆê°
        if (finishL > 0) {
          sinkModuleSvg += `<rect x="${offsetX}" y="${upperY}" width="${finishL * scale}" height="${upperH_s + middleH_s + lowerH_s}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (finishL * scale) / 2}" y="${upperY + (upperH_s + middleH_s + lowerH_s) / 2}" text-anchor="middle" font-size="8" fill="#666" transform="rotate(-90 ${offsetX + (finishL * scale) / 2} ${upperY + (upperH_s + middleH_s + lowerH_s) / 2})">${finishL}</text>`;
        }
        // ìš°ì¸¡ ë§ˆê°
        if (finishR > 0) {
          sinkModuleSvg += `<rect x="${offsetX + drawW - finishR * scale}" y="${upperY}" width="${finishR * scale}" height="${upperH_s + middleH_s + lowerH_s}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (finishR * scale) / 2}" y="${upperY + (upperH_s + middleH_s + lowerH_s) / 2}" text-anchor="middle" font-size="8" fill="#666" transform="rotate(-90 ${offsetX + drawW - (finishR * scale) / 2} ${upperY + (upperH_s + middleH_s + lowerH_s) / 2})">${finishR}</text>`;
        }

        // â˜… ê±¸ë ˆë°›ì´ (ë„ì–´ í‘œì‹œì‹œì—ë§Œ, í•˜ë¶€ì¥ì— ì„¤ì¹˜)
        if (showDoors) {
          const baseboardH = legH - 5; // ê±¸ë ˆë°›ì´ ë†’ì´ = ë‹¤ë¦¬ë°œ ë†’ì´ - 5mm
          const baseboardH_s = baseboardH * scale;
          // í•˜ë¶€ì¥ ë„ˆë¹„ í•©ê³„ (í‚¤í°ì¥ ì œì™¸)
          const lowerTotalW = lowerModules
            .filter((m) => m.type !== 'tall')
            .reduce((sum, m) => sum + parseFloat(m.w), 0);

          if (lowerTotalW > 0 && baseboardH > 0) {
            const MAX_BASEBOARD_W = 2400;
            const baseboardCount = Math.ceil(lowerTotalW / MAX_BASEBOARD_W);
            const baseboardY = legY + (legH_s - baseboardH_s);
            let currentX = offsetX + finishL * scale;
            let remainingW = lowerTotalW;

            for (let i = 0; i < baseboardCount; i++) {
              const thisW = Math.min(remainingW, MAX_BASEBOARD_W);
              const thisW_s = thisW * scale;
              sinkModuleSvg += `<rect x="${currentX}" y="${baseboardY}" width="${thisW_s}" height="${baseboardH_s}" fill="#8b5cf6" stroke="#6d28d9" stroke-width="1.5" rx="1"/>
          <text x="${currentX + thisW_s / 2}" y="${baseboardY + baseboardH_s / 2 + 3}" text-anchor="middle" font-size="7" fill="#fff" font-weight="bold">ê±¸ë ˆë°›ì´ ${thisW}Ã—${baseboardH}</text>`;
              currentX += thisW_s;
              remainingW -= thisW;
            }
          }
        }

        const sinkFrontViewSvg = `
    <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;">
      <!-- ì¹˜ìˆ˜ì„  - ìƒë‹¨ -->
      <line x1="${offsetX}" y1="${offsetY - 15}" x2="${offsetX + drawW}" y2="${offsetY - 15}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX}" y1="${offsetY - 20}" x2="${offsetX}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX + drawW}" y1="${offsetY - 20}" x2="${offsetX + drawW}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX + drawW / 2}" y="${offsetY - 25}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${sinkW}mm</text>

      <!-- ì¹˜ìˆ˜ì„  - ì¢Œì¸¡ -->
      <line x1="${offsetX - 15}" y1="${offsetY}" x2="${offsetX - 15}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 10}" y2="${offsetY}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY + drawH}" x2="${offsetX - 10}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX - 25}" y="${offsetY + drawH / 2}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold" transform="rotate(-90 ${offsetX - 25} ${offsetY + drawH / 2})">${sinkH}mm</text>

      <!-- ëª¨ë“ˆë“¤ -->
      ${sinkModuleSvg}
    </svg>
  `;

        // ë§ˆê° ì„¤ì •
        let cornerHtml = '';
        if (item.specs.layoutShape === 'L') {
          cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Molding" ${item.specs.finishCorner1Type === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishCorner1Type === 'Filler' ? 'selected' : ''}>íœ ë¼</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>`;
        } else if (item.specs.layoutShape === 'U') {
          cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ1 ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Molding" ${item.specs.finishCorner1Type === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishCorner1Type === 'Filler' ? 'selected' : ''}>íœ ë¼</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>
    <div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ2 ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner2Type', this.value)"><option value="Molding" ${item.specs.finishCorner2Type === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishCorner2Type === 'Filler' ? 'selected' : ''}>íœ ë¼</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner2Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner2Width', this.value)"></div></div>`;
        }

        const shapes = { I: 'ã…¡ìí˜• (1ê°œ)', L: 'ã„±ìí˜• (2ê°œ)', U: 'ã„·ìí˜• (3ê°œ)' };
        const topCount = item.specs.layoutShape === 'U' ? 3 : item.specs.layoutShape === 'L' ? 2 : 1;
        let topSizeInputs = '';
        for (let i = 0; i < topCount; i++) {
          topSizeInputs += `<input type="text" placeholder="W x D" value="${item.specs.topSizes[i] || ''}" oninput="updateTopSize(${item.uniqueId}, ${i}, this.value)" style="margin-bottom:4px;">`;
        }

        const accHtml = item.specs.accessories
          .map(
            (acc) => `
    <div class="acc-item">
      <select style="flex:1;" onchange="updateAccessory(${item.uniqueId}, ${acc.id}, this.value)">
        <option value="LTMesh" ${acc.type === 'LTMesh' ? 'selected' : ''}>LTë§ì¥</option>
        <option value="CircleMesh" ${acc.type === 'CircleMesh' ? 'selected' : ''}>ì›ë§ì¥</option>
        <option value="Cutlery" ${acc.type === 'Cutlery' ? 'selected' : ''}>ìˆ˜ì €ë¶„ë¦¬í•¨</option>
        <option value="Knife" ${acc.type === 'Knife' ? 'selected' : ''}>ì¹¼ê½‚ì´</option>
        <option value="DishRack" ${acc.type === 'DishRack' ? 'selected' : ''}>ì‹ê¸°ê±´ì¡°ëŒ€</option>
        <option value="Etc" ${acc.type === 'Etc' ? 'selected' : ''}>ê¸°íƒ€</option>
      </select>
      <button class="btn-del-acc" onclick="removeAccessory(${item.uniqueId}, ${acc.id})">Ã—</button>
    </div>
  `
          )
          .join('');

        ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ìƒì„¸ ì„¤ê³„ <span class="ws-info-badge">W ${item.w} x H ${item.h} x D ${item.d}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ë””ìì¸ ì´ë¯¸ì§€ ìƒì„±">ğŸ¨ AI ë””ìì¸ ìƒì„±</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ì¹˜ìˆ˜)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒë¶€ì¥ ë†’ì´</label><input type="number" value="${item.specs.upperH}" onblur="updateSpecValue(${item.uniqueId}, 'upperH', this.value)"></div>
          <div class="spec-field"><label>í•˜ë¶€ì¥ ë†’ì´</label><input type="number" value="${item.specs.lowerH}" onblur="updateSpecValue(${item.uniqueId}, 'lowerH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ë‹¤ë¦¬ë°œ ë†’ì´</label>
            <select id="legHeight-${item.uniqueId}" onchange="updateSpec(${item.uniqueId}, 'sinkLegHeight', this.value)">
              <option value="120" ${item.specs.sinkLegHeight == 120 ? 'selected' : ''}>120mm</option>
              <option value="150" ${item.specs.sinkLegHeight == 150 ? 'selected' : ''}>150mm</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì†ì¡ì´</label><select><option>ì°¬ë„¬ (ëª©ì°¬ë„¬)</option><option>Cì°¬ë„¬</option><option>ìŠ¤ë§ˆíŠ¸ë°”</option><option>í‘¸ì‰¬ ë„ì–´</option></select></div>
          <div class="spec-field"><label>ì”½í¬ë³¼</label><select><option>ì‚¬ê°ë³¼ 850</option><option>ì‚¬ê°ë³¼ 800</option><option>ë¼ìš´ë“œë³¼</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìˆ˜ì „</label><select><option>ê±°ìœ„ëª© ìˆ˜ì „</option><option>ã„±ì ìˆ˜ì „</option><option>ì¼ë°˜ ìˆ˜ì „</option></select></div>
          <div class="spec-field"><label>í›„ë“œ</label><select><option>íˆë“  í›„ë“œ</option><option>ì¹¨ë‹ˆ í›„ë“œ</option><option>ìŠ¬ë¼ì´ë”© í›„ë“œ</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¿¡íƒ‘</label><select><option>ì¸ë•ì…˜</option><option>ê°€ìŠ¤ì¿¡íƒ‘</option><option>í•˜ì´ë¼ì´íŠ¸</option></select></div>
          <div class="spec-field"><label>ì‹ê¸°ì„¸ì²™ê¸°</label>
            <select onchange="onDishwasherChange(${item.uniqueId}, this.value)">
              <option value="None" ${item.specs.dishwasher === 'None' ? 'selected' : ''}>ì—†ìŒ</option>
              <option value="BuiltIn" ${item.specs.dishwasher === 'BuiltIn' ? 'selected' : ''}>ë¹ŒíŠ¸ì¸</option>
              <option value="FreeStanding" ${item.specs.dishwasher === 'FreeStanding' ? 'selected' : ''}>í”„ë¦¬ìŠ¤íƒ ë”©</option>
            </select>
          </div>
        </div>
        <div class="spec-row">
          <div class="spec-field">
            <label>ì•¡ì„¸ì„œë¦¬</label>
            <div class="acc-list">${accHtml}</div>
            <button class="btn-add-acc" onclick="addAccessory(${item.uniqueId})">+ ì•¡ì„¸ì„œë¦¬ ì¶”ê°€</button>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ë„ì–´)</div>
        <div class="spec-row"><div class="spec-field"><label>ìƒë¶€ì¥ ë„ì–´</label><div class="color-select-row"><select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select><select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ë„¤ì´ë¹„</option><option>ë¸”ë™</option></select></div></div></div>
        <div class="spec-row"><div class="spec-field"><label>í•˜ë¶€ì¥ ë„ì–´</label><div class="color-select-row"><select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select><select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ë„¤ì´ë¹„</option><option>ë¸”ë™</option></select></div></div></div>

        <div class="spec-group-title">4. Countertop (ìƒíŒ)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒíŒ ìƒ‰ìƒ</label><input type="text" value="${item.specs.topColor}"></div>
          <div class="spec-field"><label>ìƒíŒ ë‘ê»˜(T)</label><input type="number" value="${item.specs.topThickness}"></div>
        </div>
        <div class="spec-row"><div class="spec-field"><label>ìƒíŒ í¬ê¸° (${shapes[item.specs.layoutShape]})</label>${topSizeInputs}</div></div>

        <div class="spec-group-title">5. Finish Settings (ë§ˆê°)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”© ë†’ì´</label><input type="number" value="${item.specs.moldingH}" onblur="updateSpecValue(${item.uniqueId}, 'moldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡ ë§ˆê°</label><select onchange="updateFinishType(${item.uniqueId}, 'Left', this.value)"><option value="Molding" ${item.specs.finishLeftType === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishLeftType === 'Filler' ? 'selected' : ''}>íœ ë¼</option><option value="EP" ${item.specs.finishLeftType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishLeftType === 'None' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡ ë§ˆê°</label><select onchange="updateFinishType(${item.uniqueId}, 'Right', this.value)"><option value="Molding" ${item.specs.finishRightType === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishRightType === 'Filler' ? 'selected' : ''}>íœ ë¼</option><option value="EP" ${item.specs.finishRightType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishRightType === 'None' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishRightWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
        ${cornerHtml ? `<div class="spec-group-title">Corner Settings (ì½”ë„ˆ)</div>${cornerHtml}` : ''}
      </div>

      <div class="module-panel">
        <!-- â˜… Front View ë„ë©´ -->
        <div class="front-view-section" style="margin-bottom:20px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>ğŸ“ Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(ì „ë©´ë¶€ ë„ë©´)</span>
            </div>
            <button onclick="toggleSinkDoors(${item.uniqueId})" class="toggle-btn ${showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">ğŸšª ë„ì–´</button>
          </div>
          ${sinkFrontViewSvg}
        </div>

        <div class="module-section">
          <div class="module-section-header upper">
            <div class="section-title-row"><span>â¬†ï¸ ìƒë¶€ì¥ ëª¨ë“ˆ</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" class="effective-space-input" value="${upperEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'upper', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(upperRemaining)}">ì”ì—¬: ${Math.round(upperRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'upper')" ${item.prevUpperModules ? '' : 'disabled'}>â†© ë˜ëŒë¦¬ê¸°</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'upper')">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${upperModules.length === 0 ? 'empty-list' : ''}">${upperModulesHtml}</div>
        </div>

        <div class="module-section">
          <div class="module-section-header lower">
            <div class="section-title-row"><span>â¬‡ï¸ í•˜ë¶€ì¥ ëª¨ë“ˆ</span><span style="font-size:10px;color:#888;">(í‚¤í°ì¥ í¬í•¨)</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" class="effective-space-input" value="${lowerEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'lower', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(lowerRemaining)}">ì”ì—¬: ${Math.round(lowerRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'lower')" ${item.prevLowerModules ? '' : 'disabled'}>â†© ë˜ëŒë¦¬ê¸°</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'lower')">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${lowerModules.length === 0 ? 'empty-list' : ''}">${lowerModulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split btn-add-upper" onclick="addStorageModule(${item.uniqueId}, 'upper')">+ ìƒë¶€ì¥</button>
          <button class="btn-add-split btn-add-lower" onclick="addStorageModule(${item.uniqueId}, 'lower')">+ í•˜ë¶€ì¥</button>
          <button class="btn-add-split btn-add-tall" onclick="addTallModule(${item.uniqueId})">+ í‚¤í°ì¥(TL)</button>
        </div>
      </div>
    </div>
  `;

        // â˜… í¬ì»¤ìŠ¤ ë³µì›
        _restoreFocus(ws, focusInfo);
      }

      // ============================================================
      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
      // ============================================================

      // â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë Œë”ë§
      function renderWardrobeWorkspace(item) {
        const ws = document.getElementById('designWorkspace');
        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 0;
        const curtainW = parseFloat(item.specs.curtainBoxW) || 0;
        const curtainH = parseFloat(item.specs.curtainBoxH) || 0;
        const isRefLeft = item.specs.measurementBase === 'Left';

        // ëª¨ë“ˆ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ê¸°ë³¸ ëª¨ë“ˆ ìƒì„±)
        if (!item.modules || item.modules.length === 0) {
          item.modules = [];
        }

        const wardrobeModules = item.modules.filter((m) => m.pos === 'wardrobe');
        const usedW = wardrobeModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        // â˜… ìœ íš¨ê³µê°„: ì§ì ‘ ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ê³„ì‚°
        const autoEffectiveW =
          W -
          (item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0) -
          (item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0);
        const effectiveW = item.specs.wardrobeEffectiveW || autoEffectiveW;
        const remaining = effectiveW - usedW;

        // Front View SVG ìƒì„± (í™•ëŒ€ ë° í•˜ë‹¨ ì—¬ë°± ì¶”ê°€)
        const svgWidth = 650;
        const svgHeight = 450;
        const scale = Math.min((svgWidth - 100) / W, (svgHeight - 100) / H);
        const drawW = W * scale;
        const drawH = H * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 40; // ìƒë‹¨ ì—¬ë°± ê³ ì •

        // ëª¨ë“ˆ SVG ê·¸ë¦¬ê¸°
        let moduleSvg = '';
        let currentX = isRefLeft ? 0 : W;

        // ì¢Œì¸¡ ë§ˆê°
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;

        if (fL > 0) {
          moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${fL * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (fL * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fL}</text>`;
        }

        // ì»¤íŠ¼ë°•ìŠ¤ í‘œì‹œ
        let curtainSvg = '';
        if (curtainW > 0 && curtainH > 0) {
          const cbX = isRefLeft ? offsetX + fL * scale : offsetX + drawW - fR * scale - curtainW * scale;
          curtainSvg = `<rect x="${cbX}" y="${offsetY}" width="${curtainW * scale}" height="${curtainH * scale}" fill="#ffe4b5" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4"/>
      <text x="${cbX + (curtainW * scale) / 2}" y="${offsetY + (curtainH * scale) / 2 + 4}" text-anchor="middle" font-size="10" fill="#b45309">ì»¤íŠ¼ë°•ìŠ¤</text>`;
        }

        // ëª¨ë“ˆ ê·¸ë¦¬ê¸° (ìƒë¶€ì¥/í•˜ë¶€ì¥ êµ¬ë¶„) + ì˜·ë´‰/ì„ ë°˜/ì„œë
        let moduleStartX = offsetX + fL * scale;
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const showDoors = item.specs.showDoors || false; // ë„ì–´ í‘œì‹œ ì—¬ë¶€
        const doorColor = getDoorColor(item.specs.doorColorUpper || 'í™”ì´íŠ¸');
        const doorGap = 3 * scale; // 3mm ê°„ê²©
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalModuleH = H - pedestalH - moldingH;
        const pedestalHScaled = pedestalH * scale;
        const moldingHScaled = moldingH * scale;
        const PANEL_THICKNESS = 15; // ì²œíŒ/ì§€íŒ/ì„ ë°˜ ë‘ê»˜
        const ROD_OFFSET = 75; // ì˜·ë´‰ ìœ„ì¹˜: ìƒë‹¨ì—ì„œ -75mm
        const LONG_FIRST_SHELF = 315; // ê¸´ì˜· ì²« ì„ ë°˜: ìƒë‹¨ì—ì„œ -315mm
        const DRAWER_HEIGHT = 300; // ì„œë ë†’ì´ (300mm ê³ ì •)
        const SMARTBAR_WIDTH = 30; // ìŠ¤ë§ˆíŠ¸ë°” ë„ˆë¹„
        const handleType = item.specs.handleType || 'bar';

        // ì„ ë°˜ ìœ„ì¹˜ ê³„ì‚° í•¨ìˆ˜ (ì¼ë°˜): (ëª¨ë“ˆë†’ì´ - ì²œíŒ(15) - ì§€íŒ(15) - ì„ ë°˜ê°¯ìˆ˜*15) / (ì„ ë°˜ê°¯ìˆ˜+1)
        const calcShelfPositions = (moduleH, shelfCount, startY, scale) => {
          if (shelfCount <= 0) return [];
          const usableH = moduleH - PANEL_THICKNESS * 2 - shelfCount * PANEL_THICKNESS;
          const spacing = usableH / (shelfCount + 1);
          const positions = [];
          for (let i = 1; i <= shelfCount; i++) {
            const shelfY = startY + PANEL_THICKNESS * scale + (i * spacing + (i - 1) * PANEL_THICKNESS) * scale;
            positions.push(shelfY);
          }
          return positions;
        };

        // ê¸´ì˜·ìš© ì„ ë°˜ ìœ„ì¹˜ ê³„ì‚° (ì²« ì„ ë°˜ì€ ìƒë‹¨ì—ì„œ -315mm)
        const calcLongShelfPositions = (moduleH, shelfCount, startY, scale) => {
          if (shelfCount <= 0) return [];
          const positions = [];
          // ì²« ì„ ë°˜: ìƒë‹¨ì—ì„œ -315mm
          const firstShelfY = startY + LONG_FIRST_SHELF * scale;
          positions.push(firstShelfY);

          if (shelfCount > 1) {
            // ë‚˜ë¨¸ì§€ ì„ ë°˜: ì²« ì„ ë°˜ ì•„ë˜ ê· ë“± ë¶„ë°°
            const remainingH = moduleH - LONG_FIRST_SHELF - PANEL_THICKNESS;
            const spacing = remainingH / shelfCount;
            for (let i = 2; i <= shelfCount; i++) {
              const shelfY = firstShelfY + (i - 1) * spacing * scale;
              positions.push(shelfY);
            }
          }
          return positions;
        };

        // ì„œë ê·¸ë¦¬ê¸° í•¨ìˆ˜
        const drawDrawers = (x, y, w, drawerCount, isExternal, scale) => {
          if (drawerCount <= 0) return '';
          let svg = '';
          const drawerH = DRAWER_HEIGHT * scale;
          const padding = isExternal ? 0 : 5;

          for (let i = 0; i < drawerCount; i++) {
            const drawerY = y - (i + 1) * drawerH;
            const dx = x + padding;
            const dw = w - padding * 2;

            // ì„œë ë°•ìŠ¤
            svg += `<rect x="${dx}" y="${drawerY}" width="${dw}" height="${drawerH - 2}" fill="#f5f5f5" stroke="#888" stroke-width="1.5"/>`;
            // ì„œë ì†ì¡ì´
            const handleY = drawerY + drawerH / 2 - 3;
            const handleW = 30;
            svg += `<rect x="${dx + dw / 2 - handleW / 2}" y="${handleY}" width="${handleW}" height="6" rx="2" fill="#666"/>`;
          }
          return svg;
        };

        // ìŠ¤ë§ˆíŠ¸ë°” ê·¸ë¦¬ê¸° í•¨ìˆ˜
        const drawSmartbar = (x, y, h, scale) => {
          const sbW = SMARTBAR_WIDTH * scale;
          const sbH = h * scale;
          return `<rect x="${x}" y="${y}" width="${sbW}" height="${sbH}" fill="#333" stroke="#222" stroke-width="1"/>
      <rect x="${x + 2}" y="${y + sbH * 0.3}" width="${sbW - 4}" height="${sbH * 0.4}" fill="#555" rx="2"/>`;
        };

        wardrobeModules.forEach((mod, idx) => {
          const mW = parseFloat(mod.w) * scale;
          const moduleType = mod.moduleType || 'short';
          const isDivided = moduleType === 'short' || moduleType === 'shelf';
          const isShelfType = moduleType === 'shelf';
          const shelfCountUpper = mod.shelfCountUpper || 0;
          const shelfCountLower = mod.shelfCountLower || 0;
          const shelfCount = mod.shelfCount || 0;
          const drawerCount = mod.drawerCount || 0;
          const isExternalDrawer = mod.isExternalDrawer || false;

          if (isDivided) {
            // ìƒë¶€ì¥/í•˜ë¶€ì¥ ë¶„ë¦¬í˜•
            const upperH = parseFloat(mod.upperH) || Math.round(totalModuleH / 2);
            const lowerH = parseFloat(mod.lowerH) || Math.round(totalModuleH / 2);
            const upperHScaled = upperH * scale;
            const lowerHScaled = lowerH * scale;

            // í•˜ë¶€ì¥ (ì•„ë˜) - ì¢ŒëŒ€ ìœ„ì— ìœ„ì¹˜
            const lowerY = offsetY + drawH - pedestalHScaled - lowerHScaled;
            moduleSvg += `<rect x="${moduleStartX}" y="${lowerY}" width="${mW}" height="${lowerHScaled}" fill="${isShelfType ? '#fffbeb' : '#eff6ff'}" stroke="${isShelfType ? '#f59e0b' : '#3b82f6'}" stroke-width="2"/>`;

            // í•˜ë¶€ì¥ ì˜·ë´‰ (ì„ ë°˜í˜• ì œì™¸) - ìƒë‹¨ì—ì„œ -75mm
            if (!isShelfType) {
              const rodY = lowerY + ROD_OFFSET * scale;
              moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
            }

            // í•˜ë¶€ì¥ ì„ ë°˜
            const lowerShelfPositions = calcShelfPositions(lowerH, shelfCountLower, lowerY, scale);
            lowerShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // í•˜ë¶€ì¥ ì„œë (í•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤íƒ)
            const lowerBottom = lowerY + lowerHScaled;
            moduleSvg += drawDrawers(moduleStartX, lowerBottom, mW, drawerCount, isExternalDrawer, scale);

            // í•˜ë¶€ì¥ í…ìŠ¤íŠ¸
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${lowerY + lowerHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${lowerH}</text>`;

            // ìƒë¶€ì¥ (ìœ„)
            const upperY = lowerY - upperHScaled;
            moduleSvg += `<rect x="${moduleStartX}" y="${upperY}" width="${mW}" height="${upperHScaled}" fill="${isShelfType ? '#fef3c7' : '#ecfdf5'}" stroke="${isShelfType ? '#f59e0b' : '#10b981'}" stroke-width="2"/>`;

            // ìƒë¶€ì¥ ì˜·ë´‰ (ì„ ë°˜í˜• ì œì™¸) - ìƒë‹¨ì—ì„œ -75mm
            if (!isShelfType) {
              const rodY = upperY + ROD_OFFSET * scale;
              moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
            }

            // ìƒë¶€ì¥ ì„ ë°˜
            const upperShelfPositions = calcShelfPositions(upperH, shelfCountUpper, upperY, scale);
            upperShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // ìƒë¶€ì¥ í…ìŠ¤íŠ¸
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${upperY + upperHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${upperH}</text>`;

            // í•˜ë‹¨ ë„ˆë¹„ ì¹˜ìˆ˜
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;
          } else {
            // ê¸´ì˜· ë‹¨ì¼í˜• - ì¢ŒëŒ€ ìœ„ì— ìœ„ì¹˜
            const mH = parseFloat(mod.h) || totalModuleH;
            const mHScaled = mH * scale;
            const mY = offsetY + drawH - pedestalHScaled - mHScaled;

            moduleSvg += `<rect x="${moduleStartX}" y="${mY}" width="${mW}" height="${mHScaled}" fill="#f0f7ff" stroke="#4a7dff" stroke-width="2"/>`;

            // ê¸´ì˜· ì˜·ë´‰ - ìƒë‹¨ì—ì„œ -75mm
            const rodY = mY + ROD_OFFSET * scale;
            moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
        <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
        <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;

            // ê¸´ì˜· ì„ ë°˜ (ì²« ì„ ë°˜: ìƒë‹¨ -315mm)
            const longShelfPositions = calcLongShelfPositions(mH, shelfCount, mY, scale);
            longShelfPositions.forEach((sy) => {
              moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
            });

            // ê¸´ì˜· ì„œë (í•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤íƒ)
            const longBottom = mY + mHScaled;
            moduleSvg += drawDrawers(moduleStartX, longBottom, mW, drawerCount, isExternalDrawer, scale);

            // í…ìŠ¤íŠ¸
            moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${mY + mHScaled / 2 + 5}" text-anchor="middle" font-size="9" fill="#666">${mod.w}Ã—${mH}</text>
        <text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;

            // ë„ì–´ í‘œì‹œ (ê¸´ì˜·)
            if (showDoors) {
              const doorCount = Math.max(1, Math.round(mod.w / 450));
              const dW = mW / doorCount;
              for (let d = 0; d < doorCount; d++) {
                const dX = moduleStartX + d * dW + doorGap / 2;
                moduleSvg += `<rect x="${dX}" y="${mY + doorGap / 2}" width="${dW - doorGap}" height="${mHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
              }
            }
          }

          // ë„ì–´ í‘œì‹œ (ìƒë¶€ì¥/í•˜ë¶€ì¥ í†µí•© ë„ì–´)
          if (showDoors && isDivided) {
            const upperH = parseFloat(mod.upperH) || Math.round(totalModuleH / 2);
            const lowerH = parseFloat(mod.lowerH) || Math.round(totalModuleH / 2);
            const upperHScaled = upperH * scale;
            const lowerHScaled = lowerH * scale;
            const lowerY = offsetY + drawH - pedestalHScaled - lowerHScaled;
            const upperY = lowerY - upperHScaled;

            // ì™¸ë¶€ ì„œëì´ ìˆìœ¼ë©´ ì„œë ë†’ì´ë§Œí¼ ì œì™¸
            const DRAWER_H = 300;
            const externalDrawerH = isExternalDrawer ? drawerCount * DRAWER_H : 0;
            const doorAreaH = upperH + lowerH - externalDrawerH;
            const doorAreaHScaled = doorAreaH * scale;

            // í†µí•© ë„ì–´ (ìƒë¶€ì¥ + í•˜ë¶€ì¥, ì™¸ë¶€ì„œë ì œì™¸)
            const doorCount = Math.max(1, Math.round(mod.w / 450));
            const dW = mW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const dX = moduleStartX + d * dW + doorGap / 2;
              moduleSvg += `<rect x="${dX}" y="${upperY + doorGap / 2}" width="${dW - doorGap}" height="${doorAreaHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
            }

            // ì™¸ë¶€ ì„œë ê°œë³„ ë„ì–´
            if (isExternalDrawer && drawerCount > 0) {
              const drawerHScaled = DRAWER_H * scale;
              for (let i = 0; i < drawerCount; i++) {
                const drawerY = offsetY + drawH - pedestalHScaled - (i + 1) * drawerHScaled;
                moduleSvg += `<rect x="${moduleStartX + doorGap / 2}" y="${drawerY + doorGap / 2}" width="${mW - doorGap}" height="${drawerHScaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
              }
            }
          }

          moduleStartX += mW;
        });

        // ìš°ì¸¡ ë§ˆê°
        if (fR > 0) {
          moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY}" width="${fR * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (fR * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fR}</text>`;
        }

        const frontViewSvg = `
    <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;">
      <!-- ì™¸ê³½ì„  -->
      <rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${drawH}" fill="none" stroke="#333" stroke-width="2"/>

      <!-- ìƒëª°ë”© ì˜ì—­ -->
      <rect x="${offsetX + fL * scale}" y="${offsetY}" width="${drawW - fL * scale - fR * scale}" height="${moldingHScaled}" fill="#d4c4a8" stroke="#b8a898" stroke-width="1"/>
      <text x="${offsetX + drawW + 8}" y="${offsetY + moldingHScaled / 2 + 4}" text-anchor="start" font-size="9" fill="#8b7355" font-weight="bold">${moldingH}</text>

      <!-- ì¢ŒëŒ€ ì˜ì—­ -->
      <rect x="${offsetX + fL * scale}" y="${offsetY + drawH - pedestalHScaled}" width="${drawW - fL * scale - fR * scale}" height="${pedestalHScaled}" fill="#c9c0b8" stroke="#a9a098" stroke-width="1"/>
      <text x="${offsetX + drawW + 8}" y="${offsetY + drawH - pedestalHScaled / 2 + 4}" text-anchor="start" font-size="9" fill="#7a7168" font-weight="bold">${pedestalH}</text>

      <!-- ì¹˜ìˆ˜ì„  - ìƒë‹¨ -->
      <line x1="${offsetX}" y1="${offsetY - 15}" x2="${offsetX + drawW}" y2="${offsetY - 15}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX}" y1="${offsetY - 20}" x2="${offsetX}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX + drawW}" y1="${offsetY - 20}" x2="${offsetX + drawW}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX + drawW / 2}" y="${offsetY - 22}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>

      <!-- ì¹˜ìˆ˜ì„  - ì¢Œì¸¡ -->
      <line x1="${offsetX - 15}" y1="${offsetY}" x2="${offsetX - 15}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 10}" y2="${offsetY}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY + drawH}" x2="${offsetX - 10}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX - 25}" y="${offsetY + drawH / 2}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold" transform="rotate(-90 ${offsetX - 25} ${offsetY + drawH / 2})">${H}mm</text>

      <!-- ì»¤íŠ¼ë°•ìŠ¤ -->
      ${curtainSvg}

      <!-- ëª¨ë“ˆë“¤ -->
      ${moduleSvg}

      <!-- ì‹¤ì¸¡ ê¸°ì¤€ í‘œì‹œ -->
      <text x="${isRefLeft ? offsetX + 10 : offsetX + drawW - 10}" y="${offsetY + drawH - pedestalHScaled - 5}" text-anchor="${isRefLeft ? 'start' : 'end'}" font-size="10" fill="#4a7dff" font-weight="bold">â–¼ ì‹¤ì¸¡ê¸°ì¤€</text>
    </svg>
  `;

        // ëª¨ë“ˆ ì¹´ë“œ ë Œë”ë§
        const renderWardrobeModuleCard = (mod, idx, totalCount) => {
          const drawerCount = mod.drawerCount || 0;
          const shelfCountUpper = mod.shelfCountUpper || 0;
          const shelfCountLower = mod.shelfCountLower || 0;
          const shelfCount = mod.shelfCount || 0;
          const rodCountUpper = mod.rodCountUpper || 0;
          const rodCountLower = mod.rodCountLower || 0;
          const moduleType = mod.moduleType || 'short';
          const isDivided = moduleType === 'short' || moduleType === 'shelf';
          const isShelfType = moduleType === 'shelf';
          const isExternalDrawer = mod.isExternalDrawer || false;

          // ë†’ì´ ê³„ì‚°
          const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 0;
          const effectiveH = totalH - pedestalH - moldingH;
          const halfH = Math.floor(effectiveH / 2);

          // ì¹´ìš´í„° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ì••ì¶•í˜•)
          const cBoxStyle =
            'display:flex;flex-direction:column;align-items:center;padding:4px 6px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;';
          const cBtnStyle =
            'width:20px;height:20px;border:1px solid #ddd;background:#fff;border-radius:3px;cursor:pointer;font-size:12px;line-height:1;';
          // ì„œë íƒ€ì… í† ê¸€ (ì••ì¶•í˜•)
          const drawerToggle = `
      <div class="wm-drawer-toggle">
        <div class="wm-drawer-label">ì„œëí˜•</div>
        <div class="wm-drawer-btns">
          <button class="wm-drawer-btn ${!isExternalDrawer ? 'active' : ''}" data-action="setDrawerType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-value="false">ë‚´ë¶€</button>
          <button class="wm-drawer-btn ${isExternalDrawer ? 'active' : ''}" data-action="setDrawerType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-value="true">ì™¸ë¶€</button>
        </div>
      </div>
    `;

          return `
      <div class="module-card wm-card" data-module-id="${mod.id}">
        <!-- ì¢Œì¸¡: ì´ë™ + íƒ€ì… -->
        <div class="wm-left">
          <div class="wm-move-btns">
            <button class="btn-move" data-action="moveWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}" data-dir="up" ${idx === 0 ? 'disabled' : ''}>â–²</button>
            <button class="btn-move" data-action="moveWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}" data-dir="down" ${idx === totalCount - 1 ? 'disabled' : ''}>â–¼</button>
          </div>
          <button class="wm-type-btn short ${moduleType === 'short' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="short">ì§§ì€ì˜·</button>
          <button class="wm-type-btn long ${moduleType === 'long' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="long">ê¸´ì˜·</button>
          <button class="wm-type-btn shelf ${moduleType === 'shelf' ? 'active' : ''}" data-action="setWdrbType" data-item="${item.uniqueId}" data-mod="${mod.id}" data-type="shelf">ì„ ë°˜í˜•</button>
        </div>

        <!-- ì¤‘ì•™: ëª¨ë“ˆ ì •ë³´ -->
        <div class="wm-center">
          <!-- í—¤ë” -->
          <div class="wm-header">
            <span class="wm-icon">ğŸšª</span>
            <span class="wm-name">${mod.name}</span>
            <span class="wm-badge ${moduleType}">${moduleType === 'short' ? 'ì§§ì€ì˜·' : moduleType === 'long' ? 'ê¸´ì˜·' : 'ì„ ë°˜'}</span>
            <label class="checkbox-label" style="margin-left:auto;"><input type="checkbox" ${mod.hasMirror ? 'checked' : ''} data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="hasMirror"> ê±°ìš¸</label>
            <button class="btn-delete-module" data-action="removeWdrb" data-item="${item.uniqueId}" data-mod="${mod.id}">Ã—</button>
          </div>

          ${
            isDivided
              ? `
          <!-- ìƒë¶€ì¥/í•˜ë¶€ì¥ ë¶„ë¦¬í˜• -->
          <div style="display:flex;flex-direction:column;gap:4px;">
            <!-- ìƒë¶€ì¥ -->
            <div class="wm-section upper">
              <span class="wm-section-label">ìƒë¶€ì¥</span>
              <span class="wm-dim-label">W</span>
              <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
              <span class="wm-dim-label">H</span>
              <input type="number" class="wm-dim-input" value="${mod.upperH || halfH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="upperH">
              <span class="wm-dim-label">D</span>
              <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
              ${moduleType !== 'short' ? `<button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'upper')">âš™ï¸</button>` : ''}
            </div>
            <!-- í•˜ë¶€ì¥ -->
            <div class="wm-section lower">
              <span class="wm-section-label">í•˜ë¶€ì¥</span>
              <span class="wm-dim-label">W</span>
              <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
              <span class="wm-dim-label">H</span>
              <input type="number" class="wm-dim-input" value="${mod.lowerH || halfH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="lowerH">
              <span class="wm-dim-label">D</span>
              <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
              <button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'lower')">âš™ï¸</button>
            </div>
          </div>
          `
              : `
          <!-- ê¸´ì˜· ë‹¨ì¼í˜• -->
          <div class="wm-section full">
            <span class="wm-section-label">ê¸´ì˜·ì¥</span>
            <span class="wm-dim-label">W</span>
            <input type="number" class="wm-dim-input" value="${mod.w}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="w">
            <span class="wm-dim-label">H</span>
            <input type="number" class="wm-dim-input" value="${mod.h || effectiveH}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="h">
            <span class="wm-dim-label">D</span>
            <input type="number" class="wm-dim-input" value="${mod.d}" data-item="${item.uniqueId}" data-mod="${mod.id}" data-field="d">
            <button class="wm-sett-btn" onclick="openWardrobeSectionSettings(${item.uniqueId}, ${mod.id}, 'full')">âš™ï¸</button>
          </div>
          `
          }
        </div>
      </div>
    `;
        };

        const modulesHtml = wardrobeModules
          .map((m, i) => renderWardrobeModuleCard(m, i, wardrobeModules.length))
          .join('');

        ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ìƒì„¸ ì„¤ê³„ <span class="ws-info-badge">W ${W} x H ${H} x D ${D}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ë””ìì¸ ì´ë¯¸ì§€ ìƒì„±">ğŸ¨ AI ë””ìì¸ ìƒì„±</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ì¹˜ìˆ˜)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì „ì²´ ë†’ì´</label><input type="number" value="${H}" disabled></div>
          <div class="spec-field"><label>ì „ì²´ ê¹Šì´</label><input type="number" value="${D}" disabled></div>
          <div class="spec-field"><label>ì¢ŒëŒ€ ë†’ì´</label><input type="number" value="${item.specs.wardrobePedestal || 60}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobePedestal', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì»¤íŠ¼ë°•ìŠ¤ ê°€ë¡œ</label><input type="number" value="${curtainW}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="spec-field"><label>ì»¤íŠ¼ë°•ìŠ¤ ë†’ì´</label><input type="number" value="${curtainH}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì†ì¡ì´</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'handleType', this.value)">
              <option value="bar" ${(item.specs.handleType || 'bar') === 'bar' ? 'selected' : ''}>ì¼ì ì†ì¡ì´</option>
              <option value="cchannel" ${item.specs.handleType === 'cchannel' ? 'selected' : ''}>Cì°¬ë„¬</option>
              <option value="push" ${item.specs.handleType === 'push' ? 'selected' : ''}>í‘¸ì‰¬ ë„ì–´</option>
              <option value="smartbar" ${item.specs.handleType === 'smartbar' ? 'selected' : ''}>ìŠ¤ë§ˆíŠ¸ë°”</option>
            </select>
          </div>
          <div class="spec-field"><label>ë ˆì¼</label><select><option>ì†Œí”„íŠ¸í´ë¡œì§•</option><option>ì¼ë°˜ ë ˆì¼</option><option>í’€ìµìŠ¤í…ì…˜</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${isRefLeft ? 'selected' : ''}>ì¢Œì¸¡</option>
              <option value="Right" ${!isRefLeft ? 'selected' : ''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ë„ì–´)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ë„ì–´ ìƒ‰ìƒ</label>
            <div class="color-select-row">
              <select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select>
              <select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ì›”ë„›</option><option>ì˜¤í¬</option></select>
            </div>
          </div>
        </div>

        <div class="spec-group-title">4. Finish Settings (ë§ˆê°)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”© ë†’ì´(mm)</label><input type="number" value="${item.specs.wardrobeMoldingH || 15}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobeMoldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡ ë§ˆê°</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Left', this.value)"><option value="Molding" ${item.specs.finishLeftType === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishLeftType === 'Filler' ? 'selected' : ''}>íœ ë¼</option><option value="EP" ${item.specs.finishLeftType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishLeftType === 'None' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" ${item.specs.finishLeftType === 'EP' || item.specs.finishLeftType === 'None' ? 'disabled' : ''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡ ë§ˆê°</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Right', this.value)"><option value="Molding" ${item.specs.finishRightType === 'Molding' ? 'selected' : ''}>ëª°ë”©</option><option value="Filler" ${item.specs.finishRightType === 'Filler' ? 'selected' : ''}>íœ ë¼</option><option value="EP" ${item.specs.finishRightType === 'EP' ? 'selected' : ''}>EP</option><option value="None" ${item.specs.finishRightType === 'None' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishRightWidth}" ${item.specs.finishRightType === 'EP' || item.specs.finishRightType === 'None' ? 'disabled' : ''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
      </div>

      <div class="module-panel">
        <!-- â˜… Front View ë„ë©´ -->
        <div class="front-view-section" style="margin-bottom:20px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>ğŸ“ Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(ì „ë©´ë¶€ ë„ë©´)</span>
            </div>
            <button onclick="toggleWardrobeDoors(${item.uniqueId})" class="toggle-btn ${item.specs.showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">ğŸšª ë„ì–´</button>
          </div>
          ${frontViewSvg}
        </div>

        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="section-title-row"><span>ğŸšª ë¶™ë°•ì´ì¥ ëª¨ë“ˆ</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" value="${Math.round(item.specs.wardrobeEffectiveW || effectiveW)}" 
                  onblur="updateWardrobeEffectiveW(${item.uniqueId}, this.value)"
                  style="width:70px;padding:2px 6px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.15);color:white;font-weight:bold;font-size:13px;text-align:right;">
                <span style="color:white;">mm</span>
              </div>
              <span class="section-remaining" style="color:${remaining >= 0 && remaining <= 10 ? '#90EE90' : remaining < 0 ? '#ff6b6b' : 'white'}">ì”ì—¬: ${Math.round(remaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-auto" onclick="runWardrobeAutoCalc(${item.uniqueId})">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${wardrobeModules.length === 0 ? 'empty-list' : ''}">${modulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split" style="border-color:#10b981;color:#10b981;" onclick="addWardrobeModule(${item.uniqueId})">+ ë¶™ë°•ì´ì¥ ëª¨ë“ˆ</button>
        </div>
      </div>
    </div>
  `;
      }

      // ë¶™ë°•ì´ì¥ ëª¨ë“ˆ ê´€ë ¨ í•¨ìˆ˜ë“¤
      function addWardrobeModule(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // â˜… ë†’ì´ ê³„ì‚°: (ì „ì²´ë†’ì´ - ì¢ŒëŒ€ - ìƒëª°ë”©) / 2
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalH = parseFloat(item.h) || 0;
        const effectiveH = totalH - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2);

        item.modules.push({
          id: Date.now(),
          type: 'wardrobe',
          name: 'ì§§ì€ì˜·(2ë‹¨)',
          pos: 'wardrobe',
          w: 900,
          h: effectiveH, // ê¸´ì˜·ìš© ì „ì²´ ë†’ì´
          upperH: halfH, // ìƒë¶€ì¥ ë†’ì´
          lowerH: halfH, // í•˜ë¶€ì¥ ë†’ì´
          d: parseFloat(item.d) || 650,
          moduleType: 'short',
          isDivided: true,
          drawerCount: 0,
          shelfCount: 0,
          shelfCountUpper: 0,
          shelfCountLower: 0,
          hasMirror: false,
        });
        renderWorkspaceContent(item);
      }

      function removeWardrobeModule(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.modules = item.modules.filter((m) => m.id !== modId);
        renderWorkspaceContent(item);
      }

      function moveWardrobeModule(itemUniqueId, modId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const modules = item.modules.filter((m) => m.pos === 'wardrobe');
        const idx = modules.findIndex((m) => m.id === modId);
        if (idx === -1) return;

        const newIdx = direction === 'up' ? idx - 1 : idx + 1;
        if (newIdx < 0 || newIdx >= modules.length) return;

        [modules[idx], modules[newIdx]] = [modules[newIdx], modules[idx]];
        item.modules = item.modules.filter((m) => m.pos !== 'wardrobe').concat(modules);
        renderWorkspaceContent(item);
      }

      function updateWardrobeModuleDim(itemUniqueId, modId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = parseFloat(value) || 0;
          renderWorkspaceContent(item);
        }
      }

      function toggleWardrobeOption(itemUniqueId, modId, field, checked) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = checked;
          renderWorkspaceContent(item);
        }
      }

      // â˜… ì„œë ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
      function adjustWardrobeDrawer(itemUniqueId, modId, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.drawerCount = Math.max(0, Math.min(5, (mod.drawerCount || 0) + delta));
          renderWorkspaceContent(item);
        }
      }

      // â˜… ëª¨ë“ˆ íƒ€ì… ì„¤ì • í•¨ìˆ˜ (ì§§ì€ì˜·2ë‹¨, ê¸´ì˜·1ë‹¨, ì„ ë°˜í˜•)
      function setWardrobeModuleType(itemUniqueId, modId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.moduleType = type;
          // íƒ€ì…ì— ë”°ë¥¸ ì´ë¦„ ë³€ê²½
          const typeNames = { short: 'ì§§ì€ì˜·(2ë‹¨)', long: 'ê¸´ì˜·(1ë‹¨)', shelf: 'ì„ ë°˜í˜•' };
          mod.name = typeNames[type] || mod.name;

          // â˜… ë†’ì´ ê³„ì‚°
          const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 0;
          const effectiveH = totalH - pedestalH - moldingH;
          const halfH = Math.floor(effectiveH / 2);

          // â˜… íƒ€ì…ë³„ ê¸°ë³¸ê°’ ì„¤ì •
          if (type === 'short') {
            // ì§§ì€ì˜·(2ë‹¨): ìƒë¶€ì¥/í•˜ë¶€ì¥ 2ë“±ë¶„
            mod.isDivided = true;
            mod.h = effectiveH;
            mod.upperH = halfH;
            mod.lowerH = halfH;
            mod.drawerCount = mod.drawerCount || 0;
            mod.shelfCountUpper = mod.shelfCountUpper || 0;
            mod.shelfCountLower = mod.shelfCountLower || 0;
            mod.shelfCount = 0;
          } else if (type === 'long') {
            // ê¸´ì˜·(1ë‹¨): ì„œë ê¸°ë³¸ê°’ 1, ì„ ë°˜ ê¸°ë³¸ê°’ 1
            mod.isDivided = false;
            mod.h = effectiveH;
            mod.upperH = 0;
            mod.lowerH = 0;
            mod.drawerCount = 1;
            mod.shelfCount = 1;
            mod.shelfCountUpper = 0;
            mod.shelfCountLower = 0;
          } else if (type === 'shelf') {
            // ì„ ë°˜í˜•: ìƒë¶€ì¥/í•˜ë¶€ì¥ 2ë“±ë¶„, ì„ ë°˜ ê¸°ë³¸ê°’ ìƒë¶€2 + í•˜ë¶€2 = 4
            mod.isDivided = true;
            mod.h = effectiveH;
            mod.upperH = halfH;
            mod.lowerH = halfH;
            mod.drawerCount = mod.drawerCount || 0;
            mod.shelfCountUpper = 2;
            mod.shelfCountLower = 2;
            mod.shelfCount = 0;
          }

          renderWorkspaceContent(item);
        }
      }

      // â˜… ì„ ë°˜ ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
      function adjustWardrobeShelf(itemUniqueId, modId, section, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          if (section === 'upper') {
            mod.shelfCountUpper = Math.max(0, Math.min(6, (mod.shelfCountUpper || 0) + delta));
          } else {
            mod.shelfCountLower = Math.max(0, Math.min(6, (mod.shelfCountLower || 0) + delta));
          }
          renderWorkspaceContent(item);
        }
      }

      // â˜… ê¸´ì˜·ìš© ë‹¨ì¼ ì„ ë°˜ ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
      function adjustWardrobeShelfSingle(itemUniqueId, modId, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.shelfCount = Math.max(0, Math.min(6, (mod.shelfCount || 0) + delta));
          renderWorkspaceContent(item);
        }
      }

      // â˜… ì˜·ë´‰ ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜ (ì„ ë°˜í˜• ëª¨ë“ˆìš©)
      function adjustWardrobeRod(itemUniqueId, modId, section, delta) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          if (section === 'upper') {
            mod.rodCountUpper = Math.max(0, Math.min(3, (mod.rodCountUpper || 0) + delta));
          } else {
            mod.rodCountLower = Math.max(0, Math.min(3, (mod.rodCountLower || 0) + delta));
          }
          renderWorkspaceContent(item);
        }
      }

      // â˜… ìƒë¶€ì¥/í•˜ë¶€ì¥ ì„¤ì • íŒì—… ì—´ê¸°
      // í˜„ì¬ ì—´ë¦° ë¶™ë°•ì´ì¥ ì„¹ì…˜ ì„¤ì • íŒì—… ìƒíƒœ
      let currentWardrobePopup = { itemId: null, modId: null, section: null };

      function openWardrobeSectionSettings(itemUniqueId, modId, section) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return;

        currentWardrobePopup = { itemId: itemUniqueId, modId: modId, section: section };
        renderWardrobeSectionPopup(item, mod, section);
      }

      function renderWardrobeSectionPopup(item, mod, section) {
        const existingPopup = document.getElementById('wardrobe-section-popup');
        if (existingPopup) existingPopup.remove();

        const moduleType = mod.moduleType || 'short'; // short, long, shelf
        const isShortType = moduleType === 'short';
        const isLongType = moduleType === 'long';
        const isShelfType = moduleType === 'shelf';
        const isFullType = section === 'full';

        let sectionName, sectionColor, sectionBg;
        if (section === 'upper') {
          sectionName = 'ìƒë¶€ì¥';
          sectionColor = '#10b981';
          sectionBg = '#ecfdf5';
        } else if (section === 'lower') {
          sectionName = 'í•˜ë¶€ì¥';
          sectionColor = '#3b82f6';
          sectionBg = '#eff6ff';
        } else {
          sectionName = 'ê¸´ì˜·ì¥';
          sectionColor = '#4a7dff';
          sectionBg = '#f0f7ff';
        }

        // ì„œë ë†’ì´ 300mm ê³ ì •
        const DRAWER_HEIGHT = 300;
        // ì„ ë°˜ ë‚´ê²½ 300mm
        const SHELF_INNER_HEIGHT = 300;

        let shelfCount, rodCount, drawerCount, hasRod;
        if (isFullType) {
          // ê¸´ì˜·(1ë‹¨) - ì„ ë°˜, ì„œë ê°€ëŠ¥
          shelfCount = mod.shelfCount || 0;
          drawerCount = mod.drawerCount || 0;
          rodCount = 1; // ê¸°ë³¸ ì˜·ë´‰ 1ê°œ
          hasRod = true;
        } else if (section === 'upper') {
          shelfCount = mod.shelfCountUpper || 0;
          rodCount = mod.rodCountUpper || 0;
          hasRod = rodCount > 0;
          drawerCount = 0;
        } else {
          shelfCount = mod.shelfCountLower || 0;
          rodCount = mod.rodCountLower || 0;
          hasRod = rodCount > 0;
          drawerCount = mod.drawerCount || 0;
        }

        // ë†’ì´ ê³„ì‚°
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const totalH = parseFloat(item.h) || 0;
        const effectiveH = totalH - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2);
        let sectionH;
        if (isFullType) {
          sectionH = mod.h || effectiveH;
        } else {
          sectionH = section === 'upper' ? mod.upperH || halfH : mod.lowerH || halfH;
        }

        // SVG í”„ë¡ íŠ¸ë·° ìƒì„±
        const svgW = 180;
        const svgH = 280;
        const scale = Math.min((svgW - 40) / mod.w, (svgH - 80) / sectionH);
        const drawW = mod.w * scale;
        const drawH = sectionH * scale;
        const offsetX = (svgW - drawW) / 2;
        const offsetY = 40;

        // ì„œë/ì„ ë°˜/ì˜·ë´‰ ê·¸ë¦¬ê¸°
        let contentSvg = '';

        // ì„œë ê·¸ë¦¬ê¸° (300mm ê³ ì • ë†’ì´, ì•„ë˜ë¶€í„°)
        const drawerH_scaled = DRAWER_HEIGHT * scale;
        const totalDrawerH = drawerCount * DRAWER_HEIGHT;
        for (let i = 0; i < drawerCount; i++) {
          const y = offsetY + drawH - drawerH_scaled * (i + 1);
          contentSvg += `<rect x="${offsetX + 3}" y="${y}" width="${drawW - 6}" height="${drawerH_scaled - 2}" fill="#e5e7eb" stroke="#6366f1" stroke-width="1.5" rx="2"/>
      <line x1="${offsetX + drawW / 2 - 15}" y1="${y + drawerH_scaled / 2}" x2="${offsetX + drawW / 2 + 15}" y2="${y + drawerH_scaled / 2}" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
      <text x="${offsetX + drawW - 8}" y="${y + drawerH_scaled / 2 + 3}" text-anchor="end" font-size="7" fill="#6366f1">${DRAWER_HEIGHT}</text>`;
        }

        // ì„ ë°˜ ê·¸ë¦¬ê¸° (ê¸´ì˜·ì¥ì€ ì„œë ìœ„ë¶€í„°, ë‚´ê²½ 300mm ê°„ê²©)
        if (isFullType && shelfCount > 0) {
          const availableH = sectionH - totalDrawerH - 50; // ì˜·ë´‰ ê³µê°„ ì œì™¸
          const shelfStartY = offsetY + 50; // ì˜·ë´‰ ì•„ë˜
          for (let i = 0; i < shelfCount; i++) {
            const y = offsetY + drawH - totalDrawerH * scale - (i + 1) * SHELF_INNER_HEIGHT * scale;
            if (y > shelfStartY) {
              contentSvg += `<line x1="${offsetX + 5}" y1="${y}" x2="${offsetX + drawW - 5}" y2="${y}" stroke="#9ca3af" stroke-width="2"/>`;
            }
          }
        } else if (!isFullType && shelfCount > 0) {
          const shelfGap = (drawH - totalDrawerH * scale) / (shelfCount + 1);
          for (let i = 1; i <= shelfCount; i++) {
            const y = offsetY + shelfGap * i;
            contentSvg += `<line x1="${offsetX + 5}" y1="${y}" x2="${offsetX + drawW - 5}" y2="${y}" stroke="#9ca3af" stroke-width="2"/>`;
          }
        }

        // ì˜·ë´‰ í‘œì‹œ
        if (isFullType || hasRod) {
          const rodY = offsetY + 25;
          contentSvg += `<line x1="${offsetX + 10}" y1="${rodY}" x2="${offsetX + drawW - 10}" y2="${rodY}" stroke="#f59e0b" stroke-width="3" stroke-linecap="round"/>
      <circle cx="${offsetX + 10}" cy="${rodY}" r="4" fill="#f59e0b"/>
      <circle cx="${offsetX + drawW - 10}" cy="${rodY}" r="4" fill="#f59e0b"/>`;
        }

        // ì»¨íŠ¸ë¡¤ ìƒì„± - íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ ì˜µì…˜
        let controlsHtml = '';

        if (isShortType && section === 'lower') {
          // ì§§ì€ì˜· í•˜ë¶€ì¥: ì„œëë§Œ
          controlsHtml = `
      <div class="ws-counter-row">
        <span class="ws-counter-label" style="color:#6366f1;">ì„œë (300mm)</span>
        <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
          <button onclick="adjustWardrobePopupValue('drawer', -1)">âˆ’</button>
          <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
          <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
        </div>
      </div>
    `;
        } else if (isFullType) {
          // ê¸´ì˜·(1ë‹¨): ì˜·ë´‰ 1ê°œ ìë™(ì˜µì…˜ í‘œì‹œ ì—†ìŒ), ì„ ë°˜+ì„œë (ì„œëì€ ì„ ë°˜ ì•„ë˜)
          controlsHtml = `
      <div style="font-size:10px;color:#b45309;padding:6px 12px;background:#fef3c7;border-radius:4px;margin-bottom:8px;">â€» ì˜·ë´‰ 1ê°œ ìë™ ì„¤ì¹˜ (ìƒë‹¨ ê³ ì •ì„ ë°˜ ì•„ë˜)</div>
      <div class="ws-counter-row">
        <span class="ws-counter-label">ì„ ë°˜ (ë‚´ê²½ 300mm)</span>
        <div class="ws-counter-box">
          <button onclick="adjustWardrobePopupValue('shelf', -1)">âˆ’</button>
          <span id="ws-shelf-count">${shelfCount}</span>
          <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
        </div>
      </div>
      <div class="ws-counter-row">
        <span class="ws-counter-label" style="color:#6366f1;">ì„œë (300mm)</span>
        <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
          <button onclick="adjustWardrobePopupValue('drawer', -1)">âˆ’</button>
          <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
          <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
        </div>
      </div>
      <div style="font-size:10px;color:#888;padding:4px 12px;background:#f3f4f6;border-radius:4px;">â€» ì„œëì€ ì„ ë°˜ ì•„ë˜ì— ë°°ì¹˜ë©ë‹ˆë‹¤</div>
    `;
        } else if (isShelfType) {
          // ì„ ë°˜í˜•: ë°°íƒ€ì  ìë™ ì„ íƒ (ì„ ë°˜â†”ì˜·ë´‰ ìë™ ì „í™˜)
          if (section === 'upper') {
            // ìƒë¶€ì¥: ì„ ë°˜ OR ì˜·ë´‰ 1ê°œ (ìë™ ì „í™˜)
            const shelfActive = shelfCount > 0;
            const rodActive = rodCount > 0;
            controlsHtml = `
        <div style="font-size:11px;color:#666;padding:8px;background:#fff7ed;border-radius:6px;margin-bottom:8px;">â€» ì„ ë°˜/ì˜·ë´‰ ì„ íƒ ì‹œ ë°˜ëŒ€ í•­ëª© ìë™ í•´ì œ</div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label">ì„ ë°˜</span>
          <div class="ws-counter-box">
            <button onclick="adjustWardrobePopupValue('shelf', -1)">âˆ’</button>
            <span id="ws-shelf-count">${shelfCount}</span>
            <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${shelfActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#b45309;">ì˜·ë´‰ (1ê°œ)</span>
          <div class="ws-counter-box" style="border-color:#f59e0b;background:#fef3c7;">
            <button onclick="adjustWardrobePopupValue('rod', -1)">âˆ’</button>
            <span id="ws-rod-count" style="color:#b45309;">${rodCount}</span>
            <button onclick="adjustWardrobePopupValue('rod', 1)">+</button>
          </div>
        </div>
      `;
          } else {
            // í•˜ë¶€ì¥: (ì„ ë°˜+ì„œë) OR ì˜·ë´‰ (ìë™ ì „í™˜)
            const rodActive = rodCount > 0;
            const shelfDrawerActive = shelfCount > 0 || drawerCount > 0;
            controlsHtml = `
        <div style="font-size:11px;color:#666;padding:8px;background:#fff7ed;border-radius:6px;margin-bottom:8px;">â€» ì„ ë°˜/ì„œëâ†”ì˜·ë´‰ ì„ íƒ ì‹œ ë°˜ëŒ€ í•­ëª© ìë™ í•´ì œ</div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label">ì„ ë°˜</span>
          <div class="ws-counter-box">
            <button onclick="adjustWardrobePopupValue('shelf', -1)">âˆ’</button>
            <span id="ws-shelf-count">${shelfCount}</span>
            <button onclick="adjustWardrobePopupValue('shelf', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${rodActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#6366f1;">ì„œë (300mm)</span>
          <div class="ws-counter-box" style="border-color:#6366f1;background:#eef2ff;">
            <button onclick="adjustWardrobePopupValue('drawer', -1)">âˆ’</button>
            <span id="ws-drawer-count" style="color:#6366f1;">${drawerCount}</span>
            <button onclick="adjustWardrobePopupValue('drawer', 1)">+</button>
          </div>
        </div>
        <div class="ws-counter-row" style="${shelfDrawerActive ? 'opacity:0.5;' : ''}">
          <span class="ws-counter-label" style="color:#b45309;">ì˜·ë´‰ (1ê°œ)</span>
          <div class="ws-counter-box" style="border-color:#f59e0b;background:#fef3c7;">
            <button onclick="adjustWardrobePopupValue('rod', -1)">âˆ’</button>
            <span id="ws-rod-count" style="color:#b45309;">${rodCount}</span>
            <button onclick="adjustWardrobePopupValue('rod', 1)">+</button>
          </div>
        </div>
      `;
          }
        }

        const popupHtml = `
    <div id="wardrobe-section-popup" class="ws-popup-overlay" onclick="if(event.target===this)closeWardrobeSectionPopup()">
      <div class="ws-popup">
        <div class="ws-popup-header" style="background:${sectionColor};">
          <span>ğŸšª ${mod.name} - ${sectionName} ì„¤ì •</span>
          <button onclick="closeWardrobeSectionPopup()" class="ws-popup-close">âœ•</button>
        </div>
        <div class="ws-popup-body">
          <div class="ws-popup-preview">
            <svg width="${svgW}" height="${svgH}" style="background:#fafafa;border-radius:10px;border:1px solid #e5e7eb;">
              <text x="${svgW / 2}" y="20" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">${sectionName} Front View</text>
              <rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${drawH}" fill="${sectionBg}" stroke="${sectionColor}" stroke-width="2" rx="4"/>
              ${contentSvg}
              <text x="${svgW / 2}" y="${offsetY + drawH + 20}" text-anchor="middle" font-size="10" fill="#666">${mod.w} Ã— ${sectionH}mm</text>
            </svg>
          </div>
          <div class="ws-popup-controls">
            ${controlsHtml}
          </div>
        </div>
        <div class="ws-popup-footer">
          <button onclick="applyWardrobeSectionAndClose()" class="ws-popup-save-btn">ì™„ë£Œ</button>
        </div>
      </div>
    </div>
    <style>
      .ws-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center}
      .ws-popup{background:white;border-radius:16px;width:420px;max-width:95vw;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
      .ws-popup-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;color:white;font-weight:700;font-size:14px}
      .ws-popup-close{background:none;border:none;color:white;font-size:20px;cursor:pointer}
      .ws-popup-body{display:flex;gap:20px;padding:20px}
      .ws-popup-preview{flex:0 0 auto}
      .ws-popup-controls{flex:1;display:flex;flex-direction:column;gap:10px;justify-content:center}
      .ws-counter-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f9fafb;border-radius:8px}
      .ws-counter-label{font-weight:700;font-size:12px;color:#374151}
      .ws-counter-box{display:flex;align-items:center;gap:8px;padding:6px 10px;border:2px solid #e5e7eb;border-radius:8px;background:white}
      .ws-counter-box button{width:28px;height:28px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;font-size:16px;font-weight:bold}
      .ws-counter-box button:hover{background:#f3f4f6}
      .ws-counter-box span{min-width:24px;text-align:center;font-weight:bold;font-size:16px}
      .ws-popup-footer{padding:14px 20px;border-top:1px solid #e5e7eb;background:#f9fafb;text-align:right}
      .ws-popup-save-btn{padding:10px 24px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer}
      .ws-popup-save-btn:hover{opacity:0.9}
    </style>
  `;
        document.body.insertAdjacentHTML('beforeend', popupHtml);
      }

      function adjustWardrobePopupValue(type, delta) {
        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentWardrobePopup.modId);
        if (!mod) return;
        const section = currentWardrobePopup.section;
        const isShelfType = mod.moduleType === 'shelf';

        if (type === 'shelf') {
          if (section === 'upper') {
            mod.shelfCountUpper = Math.max(0, Math.min(6, (mod.shelfCountUpper || 0) + delta));
            // ì„ ë°˜í˜• ìƒë¶€ì¥: ì„ ë°˜ ì¶”ê°€ì‹œ ì˜·ë´‰ ì œê±°
            if (isShelfType && mod.shelfCountUpper > 0) mod.rodCountUpper = 0;
          } else if (section === 'full') {
            mod.shelfCount = Math.max(0, Math.min(6, (mod.shelfCount || 0) + delta));
          } else {
            mod.shelfCountLower = Math.max(0, Math.min(6, (mod.shelfCountLower || 0) + delta));
            // ì„ ë°˜í˜• í•˜ë¶€ì¥: ì„ ë°˜/ì„œë ì¶”ê°€ì‹œ ì˜·ë´‰ ì œê±°
            if (isShelfType && mod.shelfCountLower > 0) mod.rodCountLower = 0;
          }
        } else if (type === 'rod') {
          if (section === 'upper') {
            mod.rodCountUpper = Math.max(0, Math.min(1, (mod.rodCountUpper || 0) + delta));
            // ì„ ë°˜í˜• ìƒë¶€ì¥: ì˜·ë´‰ ì¶”ê°€ì‹œ ì„ ë°˜ ì œê±°
            if (isShelfType && mod.rodCountUpper > 0) mod.shelfCountUpper = 0;
          } else if (section !== 'full') {
            mod.rodCountLower = Math.max(0, Math.min(1, (mod.rodCountLower || 0) + delta));
            // ì„ ë°˜í˜• í•˜ë¶€ì¥: ì˜·ë´‰ ì¶”ê°€ì‹œ ì„ ë°˜/ì„œë ì œê±°
            if (isShelfType && mod.rodCountLower > 0) {
              mod.shelfCountLower = 0;
              mod.drawerCount = 0;
            }
          }
        } else if (type === 'drawer') {
          mod.drawerCount = Math.max(0, Math.min(6, (mod.drawerCount || 0) + delta));
          // ì„ ë°˜í˜• í•˜ë¶€ì¥: ì„œë ì¶”ê°€ì‹œ ì˜·ë´‰ ì œê±°
          if (isShelfType && section === 'lower' && mod.drawerCount > 0) {
            mod.rodCountLower = 0;
          }
        }

        renderWardrobeSectionPopup(item, mod, section);
      }

      function closeWardrobeSectionPopup() {
        const popup = document.getElementById('wardrobe-section-popup');
        if (popup) popup.remove();

        // ë©”ì¸ í”„ë¡ íŠ¸ë·°ë„ ì—…ë°ì´íŠ¸
        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (item) renderWorkspaceContent(item);

        currentWardrobePopup = { itemId: null, modId: null, section: null };
      }

      function applyWardrobeSectionAndClose() {
        const popup = document.getElementById('wardrobe-section-popup');
        if (popup) popup.remove();

        const item = selectedItems.find((i) => i.uniqueId === currentWardrobePopup.itemId);
        if (item) renderWorkspaceContent(item);

        currentWardrobePopup = { itemId: null, modId: null, section: null };
      }

      // â˜… ì„œë ì™¸ë¶€í˜•/ë‚´ë¶€í˜• í† ê¸€ í•¨ìˆ˜
      function toggleWardrobeDrawerType(itemUniqueId, modId, isExternal) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.isExternalDrawer = isExternal;
          renderWorkspaceContent(item);
        }
      }

      // â˜… ë§ˆê° íƒ€ì… ë³€ê²½ í•¨ìˆ˜ (EP ì„ íƒ ì‹œ ê¸¸ì´ 20ìœ¼ë¡œ ê³ ì •)
      function updateWardrobeFinishType(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ ë„ˆë¹„: ëª°ë”© 60, íœ ë¼ 60, EP 20, ì—†ìŒ 0
        const defaultWidths = { Molding: 60, Filler: 60, EP: 20, None: 0 };
        const defaultWidth = defaultWidths[value] || 0;

        item.specs[`finish${side}Type`] = value;
        item.specs[`finish${side}Width`] = defaultWidth;

        // â˜… ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚°
        recalcWardrobeEffectiveW(item);

        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ í›„ ë Œë”ë§
        const specPanel = document.querySelector('.spec-panel');
        const scrollTop = specPanel ? specPanel.scrollTop : 0;
        renderWorkspaceContent(item);
        const newSpecPanel = document.querySelector('.spec-panel');
        if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
      }

      // â˜… ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚° í•¨ìˆ˜
      function recalcWardrobeEffectiveW(item) {
        const W = parseFloat(item.w) || 0;
        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        item.specs.wardrobeEffectiveW = W - fL - fR;
      }

      function updateWardrobeSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);

        // â˜… ë§ˆê° ê¸¸ì´ ë³€ê²½ ì‹œ ìœ íš¨ê³µê°„ ì¬ê³„ì‚°
        if (field === 'finishLeftWidth' || field === 'finishRightWidth') {
          recalcWardrobeEffectiveW(item);
        }

        renderWorkspaceContent(item);
      }

      // ë¶™ë°•ì´ì¥ ë„ì–´ í‘œì‹œ í† ê¸€
      function toggleWardrobeDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      // â˜… ìœ íš¨ê³µê°„ ì§ì ‘ ìˆ˜ì • í•¨ìˆ˜
      function updateWardrobeEffectiveW(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const newValue = parseFloat(value);
        if (!isNaN(newValue) && newValue > 0) {
          item.specs.wardrobeEffectiveW = newValue;
        } else {
          // ë¹ˆ ê°’ì´ë©´ ìë™ ê³„ì‚° ëª¨ë“œë¡œ ë³µê·€
          delete item.specs.wardrobeEffectiveW;
        }
        renderWorkspaceContent(item);
      }

      function runWardrobeAutoCalc(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 650;

        // â˜… ë†’ì´ ê³„ì‚°: (ì „ì²´ë†’ì´ - ì¢ŒëŒ€ - ìƒëª°ë”©)
        const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
        const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
        const effectiveH = H - pedestalH - moldingH;
        const halfH = Math.floor(effectiveH / 2); // ìƒë¶€ì¥/í•˜ë¶€ì¥ ê°ê° (ë‚´ë¦¼)

        const fL = item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0;
        const fR = item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0;
        // â˜… ìœ íš¨ê³µê°„: ì§ì ‘ ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ê³„ì‚°
        const effectiveW = item.specs.wardrobeEffectiveW || W - fL - fR;

        if (effectiveW <= 0) {
          alert('ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }

        const handleType = item.specs.handleType || 'bar';
        const SMARTBAR_WIDTH = 30; // ìŠ¤ë§ˆíŠ¸ë°” ë„ˆë¹„
        const TARGET_DOOR_WIDTH = 480; // ëª©í‘œ ë„ì–´ ë„ˆë¹„
        const TOLERANCE = 10; // ì‹œê³µ ì—¬ìœ ê³µê°„

        item.modules = item.modules.filter((m) => m.pos !== 'wardrobe');

        // â˜… ëª¨ë“ˆ íƒ€ì… ê¸°ë³¸ê°’ í•¨ìˆ˜ (ì—…ë°ì´íŠ¸: 2í†µ/3í†µ/4í†µ/ë°˜í†µ ê·œì¹™)
        const getModuleTypeDefaults = (modules2DCount, modules1DCount, idx, is2D) => {
          // ë°˜í†µ(1D)ë§Œ ìˆëŠ” ê²½ìš°: ì„ ë°˜í˜•
          if (!is2D) {
            return { type: 'shelf', name: 'ì„ ë°˜í˜•', isDivided: true };
          }

          // 2í†µ (2D, 2D): ì§§ì€ì˜·(2ë‹¨), ê¸´ì˜·(1ë‹¨)
          if (modules2DCount === 2 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 1) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
          }

          // 3í†µ (2D, 2D, 2D): ì§§ì€ì˜·(2ë‹¨), ì§§ì€ì˜·(2ë‹¨), ê¸´ì˜·(1ë‹¨)
          if (modules2DCount === 3 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
          }

          // 4í†µ (2D, 2D, 2D, 2D): ì§§ì€ì˜·(2ë‹¨), ì§§ì€ì˜·(2ë‹¨), ê¸´ì˜·(1ë‹¨), ì„ ë°˜í˜•
          if (modules2DCount === 4 && modules1DCount === 0) {
            if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
            if (idx === 3) return { type: 'shelf', name: 'ì„ ë°˜í˜•', isDivided: true };
          }

          // 2D + 1D ì¡°í•©: ë§ˆì§€ë§‰ 1DëŠ” ì„ ë°˜í˜•
          if (modules2DCount === 2 && modules1DCount === 1) {
            // 2D, 2D, 1D: ì§§ì€ì˜·, ê¸´ì˜·, ì„ ë°˜
            if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 1) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
          }

          if (modules2DCount === 3 && modules1DCount === 1) {
            // 2D, 2D, 2D, 1D: ì§§ì€ì˜·, ì§§ì€ì˜·, ê¸´ì˜·, ì„ ë°˜
            if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 1) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
            if (idx === 2) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
          }

          // ê¸°ë³¸ê°’
          return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
        };

        if (handleType === 'smartbar') {
          // â˜… ìŠ¤ë§ˆíŠ¸ë°” ëª¨ë“œ: ë„ì–´ ê· ë“±ë¶„ë°° (ìµœìš°ì„ )

          // 1. ì´ ë„ì–´ ìˆ˜ ê²°ì • (ëª©í‘œ 480mm ê¸°ì¤€)
          const totalDoors = Math.round(effectiveW / TARGET_DOOR_WIDTH);

          if (totalDoors <= 0) {
            alert('ê³µê°„ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤.');
            return;
          }

          // 2. ëª¨ë“ˆ ì¡°í•© ê²°ì • (2D ìš°ì„ )
          const modules2D = Math.floor(totalDoors / 2);
          const modules1D = totalDoors % 2;
          const totalModules = modules2D + modules1D;

          // 3. ìŠ¤ë§ˆíŠ¸ë°” ì´ ë„ˆë¹„
          const smartbarTotal = totalModules * SMARTBAR_WIDTH;

          // 4. ë„ì–´ ê³µê°„ ê· ë“±ë¶„ë°° (â˜… ëª¨ë“  ë„ì–´ ë™ì¼ ë„ˆë¹„)
          const doorSpace = effectiveW - smartbarTotal;
          const doorWidth = Math.floor(doorSpace / totalDoors); // ê· ë“± ë„ì–´ ë„ˆë¹„
          const usedDoorSpace = doorWidth * totalDoors;
          const remainder = doorSpace - usedDoorSpace; // ì—¬ìœ ê³µê°„ (ì‹œê³µ ì—¬ìœ )

          // 5. ëª¨ë“ˆ ìƒì„± (ëª¨ë“  ë„ì–´ ë™ì¼ ë„ˆë¹„)
          let doorIdx = 0;

          // 2D ëª¨ë“ˆë“¤
          for (let i = 0; i < modules2D; i++) {
            const modWidth = doorWidth * 2 + SMARTBAR_WIDTH;
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, i, true);

            item.modules.push({
              id: Date.now() + i,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: modWidth,
              doorCount: 2,
              doorWidth: doorWidth,
              hasSmartbar: true,
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          }

          // 1D ëª¨ë“ˆ (ìˆìœ¼ë©´)
          if (modules1D > 0) {
            const modWidth = doorWidth + SMARTBAR_WIDTH;
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, 0, false);

            item.modules.push({
              id: Date.now() + modules2D,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: modWidth,
              doorCount: 1,
              doorWidth: doorWidth,
              hasSmartbar: true,
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: 0,
              shelfCount: 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          }

          // ê²€ì¦ ë¡œê·¸
          const totalWidth = item.modules.filter((m) => m.pos === 'wardrobe').reduce((sum, m) => sum + m.w, 0);
          console.log(`ìŠ¤ë§ˆíŠ¸ë°” ê³„ì‚°: ë„ì–´ë„ˆë¹„=${doorWidth}mm, ëª¨ë“ˆí•©=${totalWidth}mm, ì—¬ìœ ê³µê°„=${remainder}mm`);

          if (remainder > TOLERANCE) {
            console.warn(`ì‹œê³µ ì—¬ìœ ê³µê°„ ì´ˆê³¼: ${remainder}mm (í—ˆìš©: ${TOLERANCE}mm)`);
          }
        } else {
          // â˜… ì¼ë°˜ ëª¨ë“œ: ê¸°ì¡´ ë¶„ë°°ê·œì¹™ ì ìš©
          const result = distributeModules(effectiveW);

          // â˜… ëª¨ë“ˆ êµ¬ì„± ë¶„ì„: 600mm ê¸°ì¤€ìœ¼ë¡œ 2D/1D íŒë³„
          let modules2D = 0;
          let modules1D = 0;
          const MODULE_2D_THRESHOLD = 600; // 600mm ì´ìƒì´ë©´ 2D

          result.modules.forEach((m) => {
            if (m.w >= MODULE_2D_THRESHOLD) modules2D++;
            else modules1D++;
          });

          // 2D/1D ëª¨ë“ˆ ì¸ë±ìŠ¤ ì¶”ì 
          let idx2D = 0;
          let idx1D = 0;

          result.modules.forEach((m, idx) => {
            const is2D = m.w >= MODULE_2D_THRESHOLD;
            const currentIdx = is2D ? idx2D++ : idx1D++;

            // â˜… ìƒˆë¡œìš´ ê·œì¹™ ì ìš©
            const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, currentIdx, is2D);

            item.modules.push({
              id: Date.now() + idx,
              type: 'wardrobe',
              name: typeDefaults.name,
              pos: 'wardrobe',
              w: m.w,
              doorCount: is2D ? 2 : 1, // â˜… 2D/1Dì— ë”°ë¥¸ ë„ì–´ ìˆ˜
              h: effectiveH,
              upperH: halfH,
              lowerH: halfH,
              d: D,
              moduleType: typeDefaults.type,
              isDivided: typeDefaults.isDivided,
              drawerCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCount: typeDefaults.type === 'long' ? 1 : 0,
              shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
              shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
              hasMirror: false,
              isExternalDrawer: false,
            });
          });

          console.log(`ë¶™ë°•ì´ì¥ ìë™ê³„ì‚°: 2D=${modules2D}ê°œ, 1D=${modules1D}ê°œ`);
        }

        renderWorkspaceContent(item);
      }

      function onEffectiveSpaceBlur(itemUniqueId, section, inputEl) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const value = inputEl.value.trim();
        if (section === 'upper') item.specs.effectiveUpperW = value === '' ? null : parseFloat(value);
        else item.specs.effectiveLowerW = value === '' ? null : parseFloat(value);

        renderWorkspaceContent(item);
      }

      function onDishwasherChange(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        item.specs.dishwasher = value;
        if (value === 'BuiltIn' || value === 'FreeStanding') {
          item.specs.sinkLegHeight = 120;
        }
        renderWorkspaceContent(item);
      }

      function changeLayoutShape(itemUniqueId, shape) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.layoutShape = shape;
          renderWorkspaceContent(item);
        }
      }

      function updateTopSize(itemUniqueId, index, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) item.specs.topSizes[index] = value;
      }

      function updateSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = value;
          renderWorkspaceContent(item);
        }
      }

      function updateSpecNoRender(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) item.specs[field] = value;
      }

      // ë§ˆê°ì¬ íƒ€ì… ë³€ê²½ ì‹œ ê¸°ë³¸ ë„ˆë¹„ë„ ìë™ ì„¤ì •
      function updateFinishType(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        // íƒ€ì…ì— ë”°ë¥¸ ê¸°ë³¸ ë„ˆë¹„: íœ ë¼ 60, ëª°ë”© 60, EP 20, ì—†ìŒ 0
        const defaultWidths = { Filler: 60, Molding: 60, EP: 20, None: 0 };
        const defaultWidth = defaultWidths[value] || 0;

        item.specs[`finish${side}Type`] = value;
        item.specs[`finish${side}Width`] = defaultWidth;

        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ í›„ ë Œë”ë§
        const specPanel = document.querySelector('.spec-panel');
        const scrollTop = specPanel ? specPanel.scrollTop : 0;
        renderWorkspaceContent(item);
        const newSpecPanel = document.querySelector('.spec-panel');
        if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
      }

      function updateSpecValue(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ í›„ ë Œë”ë§
          const specPanel = document.querySelector('.spec-panel');
          const scrollTop = specPanel ? specPanel.scrollTop : 0;
          renderWorkspaceContent(item);
          // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
          const newSpecPanel = document.querySelector('.spec-panel');
          if (newSpecPanel) newSpecPanel.scrollTop = scrollTop;
        }
      }

      function updateModuleDim(itemUniqueId, moduleId, dim, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const mod = item.modules.find((m) => m.id === moduleId);
        if (!mod) return;

        mod[dim] = parseFloat(value) || 0;
        mod.isFixed = true;

        updateRemainingDisplay(item);
      }

      function updateRemainingDisplay(item) {
        const upperModules = item.modules.filter((m) => m.pos === 'upper');
        const lowerModules = item.modules.filter((m) => m.pos === 'lower');

        const upperEffectiveW = getEffectiveSpace(item, 'upper');
        const lowerEffectiveW = getEffectiveSpace(item, 'lower');

        const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
        const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);

        const upperRemaining = upperEffectiveW - upperUsedW;
        const lowerRemaining = lowerEffectiveW - lowerUsedW;

        const upperSpan = document.querySelector('.module-section-header.upper .section-remaining');
        const lowerSpan = document.querySelector('.module-section-header.lower .section-remaining');

        if (upperSpan) {
          upperSpan.textContent = `ì”ì—¬: ${Math.round(upperRemaining)}mm`;
          upperSpan.style.color = getRemainColor(upperRemaining);
        }
        if (lowerSpan) {
          lowerSpan.textContent = `ì”ì—¬: ${Math.round(lowerRemaining)}mm`;
          lowerSpan.style.color = getRemainColor(lowerRemaining);
        }

        item.modules.forEach((mod) => {
          if (mod.isFixed) {
            const card = document.querySelector(`[data-module-id="${mod.id}"]`);
            if (card && !card.classList.contains('fixed-module')) {
              card.classList.add('fixed-module');
            }
          }
        });
      }

      function updateModuleDetail(itemUniqueId, moduleId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const mod = item.modules.find((m) => m.id === moduleId);
          if (mod) mod[field] = parseFloat(value) || 0;
        }
      }

      function toggleOption(itemUniqueId, moduleId, field, isChecked) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const mod = item.modules.find((m) => m.id === moduleId);
          if (mod) {
            mod[field] = isChecked;
            // ELì¥ í™œì„±í™” ì‹œ í•˜ë¶€ì¥ ë„ˆë¹„ 600ìœ¼ë¡œ ìë™ ë³€ê²½ + ê³ ì •ì¥ ë³€í™˜
            if (field === 'isEL' && isChecked && mod.pos === 'lower') {
              mod.w = 600;
              mod.isFixed = true; // ELì¥ì€ ê³ ì •ì¥ìœ¼ë¡œ ë³€í™˜
            }
          }
          renderWorkspaceContent(item);
        }
      }

      function moveModule(itemUniqueId, moduleId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const module = item.modules.find((m) => m.id === moduleId);
        if (!module) return;

        const sectionModules = item.modules.filter((m) => m.pos === module.pos);
        const currentIndex = sectionModules.findIndex((m) => m.id === moduleId);

        if (
          (direction === 'up' && currentIndex === 0) ||
          (direction === 'down' && currentIndex === sectionModules.length - 1)
        )
          return;

        const globalCurrentIndex = item.modules.findIndex((m) => m.id === moduleId);
        const targetModuleId =
          direction === 'up' ? sectionModules[currentIndex - 1].id : sectionModules[currentIndex + 1].id;
        const globalTargetIndex = item.modules.findIndex((m) => m.id === targetModuleId);

        [item.modules[globalCurrentIndex], item.modules[globalTargetIndex]] = [
          item.modules[globalTargetIndex],
          item.modules[globalCurrentIndex],
        ];
        renderWorkspaceContent(item);
      }

      function removeModule(itemUniqueId, moduleId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.modules = item.modules.filter((m) => m.id !== moduleId);
          renderWorkspaceContent(item);
        }
      }

      // ì‹±í¬ëŒ€ ëª¨ë“ˆ ê³ ì • í† ê¸€
      function toggleSinkModuleFixed(itemUniqueId, moduleId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === moduleId);
        if (mod) {
          mod.isFixed = !mod.isFixed;
          renderWorkspaceContent(item);
        }
      }

      // ì‹±í¬ëŒ€ ë„ì–´ í‘œì‹œ í† ê¸€
      function toggleSinkDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      function addStorageModule(itemUniqueId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const specUpperH = parseFloat(item.specs.upperH) || 720;
        const specLowerH = parseFloat(item.specs.lowerH) || 870;
        const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;

        const defaultH = type === 'upper' ? specUpperH - 20 : specLowerH - specLegH;
        const defaultD = type === 'upper' ? 295 : 550;
        const name = type === 'upper' ? 'ìƒë¶€ì¥' : 'í•˜ë¶€ì¥';

        item.modules.push({
          id: Date.now(),
          type: 'storage',
          name,
          pos: type,
          w: 600,
          h: defaultH,
          d: defaultD,
          isDrawer: false,
          isEL: false,
          isFixed: false,
        });
        renderWorkspaceContent(item);
      }

      function addTallModule(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const specMoldingH = parseFloat(item.specs.moldingH) || 60;
        const spaceH = parseFloat(item.h) || 2300;
        const defaultH = spaceH - specMoldingH - 60;

        item.modules.push({
          id: Date.now(),
          type: 'tall',
          name: 'í‚¤í°ì¥(TL)',
          pos: 'lower',
          w: 600,
          h: defaultH,
          d: 550,
          isDrawer: false,
          isEL: false,
          isFixed: false,
          doorCount: 1,
          elCount: 0,
        });
        renderWorkspaceContent(item);
      }

      function addAccessory(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.accessories.push({ id: Date.now(), type: 'LTMesh' });
          renderWorkspaceContent(item);
        }
      }

      function updateAccessory(itemUniqueId, accId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          const acc = item.specs.accessories.find((a) => a.id === accId);
          if (acc) acc.type = type;
        }
      }

      function removeAccessory(itemUniqueId, accId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.accessories = item.specs.accessories.filter((a) => a.id !== accId);
          renderWorkspaceContent(item);
        }
      }

      // ============================================================
      // â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë Œë”ë§ (v30 ê·œì¹™ ê¸°ë°˜)
      // ============================================================
      function renderFridgeWorkspace(item) {
        const ws = document.getElementById('designWorkspace');
        const W = parseFloat(item.w) || 0;
        const H = parseFloat(item.h) || 0;
        const D = parseFloat(item.d) || 700;

        if (!item.modules) item.modules = [];

        // ê·œì¹™ ìƒìˆ˜
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
        const TOP_GAP = FRIDGE_RULES.TOP_GAP;

        // ë§ˆê° ê³„ì‚°
        const fL =
          item.specs.finishLeftType !== 'None'
            ? item.specs.finishLeftType === 'EP'
              ? 20
              : parseFloat(item.specs.finishLeftWidth) || 60
            : 0;
        const fR =
          item.specs.finishRightType !== 'None'
            ? item.specs.finishRightType === 'EP'
              ? 20
              : parseFloat(item.specs.finishRightWidth) || 60
            : 0;
        const effectiveW = W - fL - fR;

        // ëª¨ë“ˆë“¤ì„ order ìˆœìœ¼ë¡œ ì •ë ¬
        const allModules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        const fridgeMod = allModules.find((m) => m.type === 'fridge');

        // â˜… ëƒ‰ì¥ê³  ê¸°ì¤€ ìƒë¶€ì¥ ë†’ì´ ìë™ ê³„ì‚° (ëƒ‰ì¥ê³ ëŠ” ë°”ë‹¥ì—ì„œ ì‹œì‘, ì¢ŒëŒ€ ë¬´ê´€)
        const fridgeH = fridgeMod ? fridgeMod.h : 0;
        const calcUpperH = fridgeMod
          ? Math.max(0, Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeH - TOP_GAP - MOLDING_H))
          : 0;

        // ìƒë¶€ì¥ ë†’ì´ (ê³„ì‚°ê°’ ì‚¬ìš©, ìˆ˜ë™ ì…ë ¥ì€ recalcFridgeHeightsì—ì„œ ì²˜ë¦¬)
        const upperDoorH = item.specs.fridgeUpperH !== undefined ? parseFloat(item.specs.fridgeUpperH) : calcUpperH;

        // ì¤‘ê°„ì¥/í•˜ë¶€ì¥ ë†’ì´ ê³„ì‚° (ëª¨ë“ˆ ì˜ì—­ = H - ìƒëª°ë”© - ìƒë¶€ì¥ - ì¢ŒëŒ€)
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH =
          item.specs.fridgeMiddleH !== undefined
            ? parseFloat(item.specs.fridgeMiddleH)
            : Math.floor(moduleBodyH * 0.55);
        const lowerH =
          item.specs.fridgeLowerH !== undefined
            ? parseFloat(item.specs.fridgeLowerH)
            : Math.floor(moduleBodyH - middleH);

        // ì‚¬ìš© ë„ˆë¹„ ê³„ì‚°
        let totalUsedW = 0;
        allModules.forEach((m) => {
          if (m.type === 'fridge') {
            const sideGap = m.sideGap || 50;
            const betweenGap = m.betweenGap || 0;
            const units = m.units || [{ w: m.w }];
            totalUsedW += sideGap * 2;
            units.forEach((u, idx) => {
              totalUsedW += u.w;
              if (idx < units.length - 1) totalUsedW += betweenGap;
            });
          } else {
            totalUsedW += parseFloat(m.w) || 0;
          }
        });
        const remaining = effectiveW - totalUsedW;
        const isOverflow = remaining < 0;

        // SVG ì„¤ì •
        const svgWidth = 720;
        const svgHeight = 560;
        const scale = Math.min((svgWidth - 100) / W, (svgHeight - 160) / H);
        const drawW = W * scale;
        const drawH = H * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        let moduleSvg = '';
        const showDoors = item.specs.showDoors || false; // ë„ì–´ í‘œì‹œ ì—¬ë¶€

        // ìƒëª°ë”©
        moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${MOLDING_H * scale}" fill="#d4a574" stroke="#a67c52" stroke-width="1"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + (MOLDING_H * scale) / 2 + 4}" text-anchor="middle" font-size="9" fill="#fff">ìƒëª°ë”© ${MOLDING_H}</text>`;

        // ì¢Œì¸¡ ë§ˆê°
        if (fL > 0) {
          moduleSvg += `<rect x="${offsetX}" y="${offsetY + MOLDING_H * scale}" width="${fL * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + (fL * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fL}</text>`;
        }
        // ìš°ì¸¡ ë§ˆê°
        if (fR > 0) {
          moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY + MOLDING_H * scale}" width="${fR * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - (fR * scale) / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fR}</text>`;
        }

        // ìƒë¶€ì¥ ê²°í•©
        const contentStartY = offsetY + MOLDING_H * scale;
        const upperH_scaled = upperDoorH * scale;
        let upperX = offsetX + fL * scale;

        // ìƒë¶€ì¥ ì •ë³´ ìˆ˜ì§‘
        let upperCabinets = [];
        allModules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ name: mod.name, w: mod.w }];
            units.forEach((unit, unitIdx) => {
              let upperW = unit.w;
              if (unitIdx === 0) upperW += sideGap;
              if (unitIdx < units.length - 1) upperW += betweenGap / 2;
              if (unitIdx === units.length - 1) upperW += sideGap;
              if (unitIdx > 0) upperW += betweenGap / 2;
              upperCabinets.push({ type: 'fridge', name: unit.name, w: upperW });
            });
          } else {
            upperCabinets.push({ type: mod.type, name: mod.type === 'tall' ? 'í‚¤í°ì¥' : 'í™ˆì¹´í˜', w: mod.w });
          }
        });

        // ìƒë¶€ì¥ ì—°ì† ê·¸ë¦¬ê¸°
        const doorColor = getDoorColor(item.specs.doorColorUpper || 'í™”ì´íŠ¸');
        const doorGap = 3 * scale; // 3mm ê°„ê²©
        upperCabinets.forEach((cab) => {
          const cabW = cab.w * scale;
          moduleSvg += `<rect x="${upperX}" y="${contentStartY}" width="${cabW}" height="${upperH_scaled}" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" rx="2"/>
      <text x="${upperX + cabW / 2}" y="${contentStartY + upperH_scaled / 2 - 2}" text-anchor="middle" font-size="8" fill="#1d4ed8">ìƒë¶€ì¥</text>
      <text x="${upperX + cabW / 2}" y="${contentStartY + upperH_scaled / 2 + 10}" text-anchor="middle" font-size="7" fill="#666">${Math.round(cab.w)}mm</text>`;
          upperX += cabW;
        });

        // â˜… ìƒë¶€ì¥ ë„ì–´ í‘œì‹œ
        if (showDoors) {
          let upperDoorX = offsetX + fL * scale;
          upperCabinets.forEach((cab) => {
            const cabW = cab.w * scale;
            const doorCount = 1; // ëª¨ë“ˆë‹¹ 1ê°œ ë„ì–´
            const doorWidth = cabW / doorCount;
            for (let d = 0; d < doorCount; d++) {
              const doorX = upperDoorX + d * doorWidth + doorGap / 2;
              const doorW = doorWidth - doorGap;
              moduleSvg += `<rect x="${doorX}" y="${contentStartY + doorGap / 2}" width="${doorW}" height="${upperH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
            }
            upperDoorX += cabW;
          });
        }

        // ë³¸ì²´ ì˜ì—­ ê·¸ë¦¬ê¸°
        let currentX = offsetX + fL * scale;
        const bodyStartY = contentStartY + upperH_scaled;
        const middleH_scaled = middleH * scale;
        const lowerH_scaled = lowerH * scale;
        const pedestalH_scaled = PEDESTAL_H * scale;

        allModules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ name: mod.name, w: mod.w }];
            const fridgeDrawH = mod.h * scale;
            // â˜… ëƒ‰ì¥ê³ ëŠ” ë°”ë‹¥ì—ì„œ ì‹œì‘ (ì¢ŒëŒ€ ì˜ì—­ê¹Œì§€ ì°¨ì§€)
            const fridgeContentH = drawH - MOLDING_H * scale - upperH_scaled;
            const gapW = sideGap * scale;

            // ì¢Œì¸¡ ì¸¡ë©´ê³µê°„
            moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW / 2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
            currentX += gapW;

            // ê° ëƒ‰ì¥ê³  ìœ ë‹› (ë°”ë‹¥ê¹Œì§€)
            units.forEach((unit, unitIdx) => {
              const unitW = unit.w * scale;
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${unitW}" height="${fridgeDrawH}" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="2" rx="3"/>
          <text x="${currentX + unitW / 2}" y="${bodyStartY + fridgeDrawH / 2 - 6}" text-anchor="middle" font-size="10" fill="#0369a1" font-weight="bold">ğŸ§Š ${unit.name}</text>
          <text x="${currentX + unitW / 2}" y="${bodyStartY + fridgeDrawH / 2 + 10}" text-anchor="middle" font-size="8" fill="#666">${unit.w}Ã—${mod.h}</text>`;
              moduleSvg += `<text x="${currentX + unitW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#0ea5e9">${unit.w}</text>`;
              currentX += unitW;

              if (unitIdx < units.length - 1 && betweenGap > 0) {
                const bGapW = betweenGap * scale;
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${bGapW}" height="${fridgeContentH}" fill="#fed7aa" stroke="#ea580c" stroke-width="1" stroke-dasharray="2"/>
            <text x="${currentX + bGapW / 2}" y="${bodyStartY + fridgeContentH / 2}" text-anchor="middle" font-size="7" fill="#c2410c" transform="rotate(-90, ${currentX + bGapW / 2}, ${bodyStartY + fridgeContentH / 2})">${betweenGap}</text>`;
                currentX += bGapW;
              }
            });

            // ìš°ì¸¡ ì¸¡ë©´ê³µê°„
            moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW / 2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
            currentX += gapW;
          } else {
            // í‚¤í°ì¥/í™ˆì¹´í˜ì¥
            const modW = mod.w * scale;
            const isEL = mod.isEL;

            if (mod.type === 'tall') {
              // í‚¤í°ì¥: ì¤‘ê°„ì¥ + í•˜ë¶€ì¥ + ì¢ŒëŒ€
              // EL ëª¨ë“ˆë“¤ì´ ìˆìœ¼ë©´ ê°œë³„ ë Œë”ë§, ì—†ìœ¼ë©´ ê¸°ë³¸ ì¤‘ê°„ì¥ í‘œì‹œ
              if (mod.elModules && mod.elModules.length > 0) {
                let elY = bodyStartY;
                let usedH = 0;
                mod.elModules.forEach((elMod, elIdx) => {
                  const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                  const isOpen = elMod.type === 'open';
                  const isEL = elMod.isEL === true; // ê¸°ë³¸ê°’ false (ê¸°ë³¸ëª¨ë“ˆ)
                  let fillColor, strokeColor, label, labelColor;
                  if (isOpen) {
                    fillColor = '#fef3c7';
                    strokeColor = '#f59e0b';
                    label = 'ğŸ“‚';
                    labelColor = '#b45309';
                  } else if (isEL) {
                    fillColor = '#dcfce7';
                    strokeColor = '#10b981';
                    label = 'âš¡';
                    labelColor = '#065f46';
                  } else {
                    fillColor = '#f3f4f6';
                    strokeColor = '#9ca3af';
                    label = 'ğŸ“¦';
                    labelColor = '#4b5563';
                  }
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${elModH_scaled}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
              <text x="${currentX + modW / 2}" y="${elY + elModH_scaled / 2}" text-anchor="middle" font-size="9" fill="${labelColor}" font-weight="bold">${label} ${elMod.h}</text>`;
                  elY += elModH_scaled;
                  usedH += elMod.h;
                });
                // ë‚¨ì€ ì¤‘ê°„ì¥ ê³µê°„
                const remainingH = middleH - usedH;
                if (remainingH > 0) {
                  const remainingH_scaled = (remainingH / middleH) * middleH_scaled;
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${remainingH_scaled}" fill="#f0fdf4" stroke="#86efac" stroke-width="1" stroke-dasharray="3"/>
              <text x="${currentX + modW / 2}" y="${elY + remainingH_scaled / 2}" text-anchor="middle" font-size="7" fill="#16a34a">ì”ì—¬ ${remainingH}</text>`;
                }
              } else {
                // EL ëª¨ë“ˆ ì—†ì„ ë•Œ ê¸°ë³¸ ì¤‘ê°„ì¥ í‘œì‹œ
                const midColor = mod.isEL ? '#dcfce7' : '#dcfce7';
                const midLabel = mod.isEL ? 'âš¡ ELì¥' : 'ğŸ—„ï¸ ì¤‘ê°„ì¥';
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${middleH_scaled}" fill="${midColor}" stroke="#10b981" stroke-width="2" rx="2"/>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 - 8}" text-anchor="middle" font-size="10" fill="#065f46" font-weight="bold">${midLabel}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 + 6}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${middleH}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled - 8}" text-anchor="middle" font-size="7" fill="#888">${EL_DOOR_TYPES.find((t) => t.id === mod.doorType)?.name || 'ì—¬ë‹«ì´'}</text>`;
              }

              // í•˜ë¶€ì¥
              const lowerColor =
                mod.lowerType === 'robot'
                  ? '#fef3c7'
                  : mod.lowerType === 'rice'
                    ? '#fee2e2'
                    : mod.lowerType === 'foodwaste'
                      ? '#dcfce7'
                      : '#f3f4f6';
              const lowerStroke =
                mod.lowerType === 'robot'
                  ? '#f59e0b'
                  : mod.lowerType === 'rice'
                    ? '#ef4444'
                    : mod.lowerType === 'foodwaste'
                      ? '#22c55e'
                      : '#6b7280';
              const lowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'ğŸ—„ï¸';
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled}" width="${modW}" height="${lowerH_scaled}" fill="${lowerColor}" stroke="${lowerStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled + lowerH_scaled / 2}" text-anchor="middle" font-size="9" fill="${lowerStroke}">${lowerIcon} í•˜ë¶€ì¥</text>`;

              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled + lowerH_scaled}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
              moduleSvg += `<text x="${currentX + modW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#10b981">${mod.w}${mod.isFixed ? 'ğŸ”’' : ''}</text>`;

              // â˜… í‚¤í°ì¥ ë„ì–´ í‘œì‹œ (ë„ì–´êµ¬ë¶„ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ)
              if (showDoors) {
                const doorDivision = mod.doorDivision || 'individual';
                const doorCount = Math.max(1, Math.round(mod.w / 450)); // ê°€ë¡œë„ˆë¹„ ê¸°ì¤€ ë„ì–´ë¶„ë°°
                const dW = modW / doorCount;

                if (doorDivision === 'all') {
                  // ì „ì²´: ì¤‘ê°„ì¥+í•˜ë¶€ì¥ í†µí•© ë„ì–´
                  const totalDoorH = middleH_scaled + lowerH_scaled;
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${totalDoorH - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                } else if (doorDivision === 'midLower') {
                  // ì¤‘ê°„ì¥ã†í•˜ë¶€ì¥: ì¤‘ê°„ì¥ ë„ì–´ + í•˜ë¶€ì¥ ë„ì–´ ë¶„ë¦¬
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${middleH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                } else {
                  // ê°œë³„: EL ëª¨ë“ˆë³„ ë„ì–´ (ì˜¤í”ˆì¥ ì œì™¸) + í•˜ë¶€ì¥ ë„ì–´
                  if (mod.elModules && mod.elModules.length > 0) {
                    let elDoorY = bodyStartY;
                    mod.elModules.forEach((elMod) => {
                      const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                      const isOpen = elMod.type === 'open';
                      if (!isOpen) {
                        for (let d = 0; d < doorCount; d++) {
                          const dX = currentX + d * dW + doorGap / 2;
                          moduleSvg += `<rect x="${dX}" y="${elDoorY + doorGap / 2}" width="${dW - doorGap}" height="${elModH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                        }
                      }
                      elDoorY += elModH_scaled;
                    });
                  } else {
                    for (let d = 0; d < doorCount; d++) {
                      const dX = currentX + d * dW + doorGap / 2;
                      moduleSvg += `<rect x="${dX}" y="${bodyStartY + doorGap / 2}" width="${dW - doorGap}" height="${middleH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                    }
                  }
                  // í•˜ë¶€ì¥ ë„ì–´
                  for (let d = 0; d < doorCount; d++) {
                    const dX = currentX + d * dW + doorGap / 2;
                    moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                  }
                }
              }
            } else if (mod.type === 'homecafe') {
              // í™ˆì¹´í˜ì¥: ì¤‘ê°„ì¥ + í•˜ë¶€ì¥ + ì¢ŒëŒ€ (í‚¤í°ì¥ê³¼ ë™ì¼ êµ¬ì¡°)
              // EL ëª¨ë“ˆë“¤ì´ ìˆìœ¼ë©´ ê°œë³„ ë Œë”ë§, ì—†ìœ¼ë©´ ê¸°ë³¸ í‘œì‹œ
              if (mod.elModules && mod.elModules.length > 0) {
                let elY = bodyStartY;
                let usedH = 0;
                mod.elModules.forEach((elMod, elIdx) => {
                  const elModH_scaled = (elMod.h / middleH) * middleH_scaled;
                  const isOpen = elMod.type === 'open';
                  const isEL = elMod.isEL === true; // ê¸°ë³¸ê°’ false (ê¸°ë³¸ëª¨ë“ˆ)
                  let fillColor, strokeColor, label, labelColor;
                  if (isOpen) {
                    fillColor = '#fef3c7';
                    strokeColor = '#f59e0b';
                    label = 'ğŸ“‚';
                    labelColor = '#b45309';
                  } else if (isEL) {
                    fillColor = '#f3e8ff';
                    strokeColor = '#8b5cf6';
                    label = 'âš¡';
                    labelColor = '#6b21a8';
                  } else {
                    fillColor = '#f3f4f6';
                    strokeColor = '#9ca3af';
                    label = 'ğŸ“¦';
                    labelColor = '#4b5563';
                  }
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${elModH_scaled}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>
              <text x="${currentX + modW / 2}" y="${elY + elModH_scaled / 2}" text-anchor="middle" font-size="9" fill="${labelColor}" font-weight="bold">${label} ${elMod.h}</text>`;
                  elY += elModH_scaled;
                  usedH += elMod.h;
                });
                const remainingH = middleH - usedH;
                if (remainingH > 0) {
                  const remainingH_scaled = (remainingH / middleH) * middleH_scaled;
                  moduleSvg += `<rect x="${currentX}" y="${elY}" width="${modW}" height="${remainingH_scaled}" fill="#faf5ff" stroke="#c4b5fd" stroke-width="1" stroke-dasharray="3"/>
              <text x="${currentX + modW / 2}" y="${elY + remainingH_scaled / 2}" text-anchor="middle" font-size="7" fill="#7c3aed">ì”ì—¬ ${remainingH}</text>`;
                }
              } else {
                const midColor = '#f3e8ff';
                const midStroke = '#8b5cf6';
                const midLabel = 'â˜• í™ˆì¹´í˜';
                moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${middleH_scaled}" fill="${midColor}" stroke="${midStroke}" stroke-width="2" rx="2"/>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 - 4}" text-anchor="middle" font-size="10" fill="#6b21a8" font-weight="bold">${midLabel}</text>
            <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled / 2 + 10}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${middleH}</text>`;
              }

              // í™ˆì¹´í˜ í•˜ë¶€ì¥
              const cafeLowerColor =
                mod.lowerType === 'robot'
                  ? '#fef3c7'
                  : mod.lowerType === 'rice'
                    ? '#fee2e2'
                    : mod.lowerType === 'foodwaste'
                      ? '#dcfce7'
                      : '#ede9fe';
              const cafeLowerStroke =
                mod.lowerType === 'robot'
                  ? '#f59e0b'
                  : mod.lowerType === 'rice'
                    ? '#ef4444'
                    : mod.lowerType === 'foodwaste'
                      ? '#22c55e'
                      : '#a78bfa';
              const cafeLowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'ğŸ—„ï¸';
              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled}" width="${modW}" height="${lowerH_scaled}" fill="${cafeLowerColor}" stroke="${cafeLowerStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW / 2}" y="${bodyStartY + middleH_scaled + lowerH_scaled / 2}" text-anchor="middle" font-size="9" fill="${cafeLowerStroke}">${cafeLowerIcon} í•˜ë¶€ì¥</text>`;

              moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled + lowerH_scaled}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
              moduleSvg += `<text x="${currentX + modW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#8b5cf6">${mod.w}${mod.isFixed ? 'ğŸ”’' : ''}</text>`;

              // â˜… í™ˆì¹´í˜ì¥ í•˜ë¶€ì¥ ë„ì–´ë§Œ í‘œì‹œ (ì¤‘ê°„ì¥ì€ ë„ì–´ ì—†ìŒ)
              if (showDoors) {
                const doorCount = Math.max(1, Math.round(mod.w / 450)); // ê°€ë¡œë„ˆë¹„ ê¸°ì¤€ ë„ì–´ë¶„ë°°
                const dW = modW / doorCount;
                for (let d = 0; d < doorCount; d++) {
                  const dX = currentX + d * dW + doorGap / 2;
                  moduleSvg += `<rect x="${dX}" y="${bodyStartY + middleH_scaled + doorGap / 2}" width="${dW - doorGap}" height="${lowerH_scaled - doorGap}" fill="${doorColor}" stroke="#333" stroke-width="1" rx="2"/>`;
                }
              }
            }
            currentX += modW;
          }
        });

        // ì´ ë„ˆë¹„
        moduleSvg += `<line x1="${offsetX}" y1="${offsetY + drawH + 35}" x2="${offsetX + drawW}" y2="${offsetY + drawH + 35}" stroke="#333" stroke-width="1" marker-start="url(#arrowL)" marker-end="url(#arrowR)"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + drawH + 50}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>`;

        // ëƒ‰ì¥ê³  ëª¨ë¸ ëª©ë¡
        const brand = item.specs.fridgeBrand || 'LG';
        const brandData = FRIDGE_DATA[brand];

        let fridgeButtonsHtml = '';
        Object.keys(brandData.categories).forEach((catName) => {
          fridgeButtonsHtml += `<div class="fridge-cat-group"><div class="fridge-cat-title">${catName}</div><div class="fridge-btn-row">`;
          brandData.categories[catName].forEach((model) => {
            const isSelected = fridgeMod && fridgeMod.modelId === model.id;
            fridgeButtonsHtml += `<button class="fridge-model-btn ${isSelected ? 'selected' : ''}" onclick="selectFridgeModel(${item.uniqueId}, '${model.id}')">${model.name}<br><span style="font-size:9px;color:#999;">${model.w}Ã—${model.h}</span></button>`;
          });
          fridgeButtonsHtml += `</div></div>`;
        });

        // ëª¨ë“ˆ ì¹´ë“œ HTML
        const moduleCardsHtml = allModules
          .map((mod, idx) => {
            const isFirst = idx === 0;
            const isLast = idx === allModules.length - 1;

            if (mod.type === 'fridge') {
              const sideGap = mod.sideGap || 50;
              const betweenGap = mod.betweenGap || 0;
              const units = mod.units || [{ w: mod.w }];
              let upperInfo = units
                .map((u, i) => {
                  let uw = u.w;
                  if (i === 0) uw += sideGap;
                  if (i < units.length - 1) uw += betweenGap / 2;
                  if (i === units.length - 1) uw += sideGap;
                  if (i > 0) uw += betweenGap / 2;
                  return Math.round(uw);
                })
                .join('+');

              return `<div class="module-card" style="border-left:3px solid #0ea5e9;">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>â–²</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>â–¼</button>
        </div>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:12px;">ğŸ§Š ${mod.name}</div>
          <div style="font-size:10px;color:#666;">${mod.w} Ã— ${mod.h}mm | ìœ ë‹›: ${units.length}ê°œ</div>
          <div style="font-size:9px;color:#888;">ì¸¡ë©´: ${sideGap}mm | ì‚¬ì´: ${betweenGap}mm</div>
          <div style="font-size:9px;color:#3b82f6;">ìƒë¶€ì¥: ${upperInfo}mm</div>
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>`;
            } else {
              const typeInfo =
                mod.type === 'tall'
                  ? { name: 'í‚¤í°ì¥', icon: 'ğŸ—„ï¸', color: '#10b981' }
                  : { name: 'í™ˆì¹´í˜ì¥', icon: 'â˜•', color: '#8b5cf6' };
              const fixedClass = mod.isFixed ? 'active' : '';

              return `<div class="module-card" style="border-left:3px solid ${typeInfo.color};">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>â–²</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>â–¼</button>
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <span style="font-weight:700;font-size:12px;">${typeInfo.icon} ${typeInfo.name}</span>
            <button class="toggle-btn ${fixedClass}" onclick="toggleFridgeModuleFixed(${item.uniqueId}, ${mod.id})">ê³ ì •</button>
            <button class="el-config-btn" onclick="openELPopup(${item.uniqueId}, ${mod.id})">âš™ï¸ ì„¤ì •</button>
          </div>
          <div class="module-inline-inputs">
            <label>W</label><input type="number" value="${mod.w}" style="width:55px;" onchange="updateFridgeModuleW(${item.uniqueId}, ${mod.id}, this.value)">
            <label>ë„ì–´ êµ¬ë¶„</label><select onchange="updateFridgeDoorDivision(${item.uniqueId}, ${mod.id}, this.value)">${DOOR_DIVISION_TYPES.map((t) => `<option value="${t.id}" ${mod.doorDivision === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select>
            <label>í•˜ë¶€</label><select onchange="updateFridgeSideModule(${item.uniqueId}, ${mod.id}, 'lowerType', this.value)">${LOWER_MODULE_TYPES.map((t) => `<option value="${t.id}" ${mod.lowerType === t.id ? 'selected' : ''}>${t.icon}</option>`).join('')}</select>
          </div>
          ${mod.elModules && mod.elModules.length > 0 ? `<div style="font-size:9px;color:#10b981;margin-top:4px;">âš¡ ëª¨ë“ˆ: ${mod.elModules.length}ê°œ</div>` : ''}
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>`;
            }
          })
          .join('');

        const leftDisabled =
          item.specs.finishLeftType === 'EP' || item.specs.finishLeftType === 'None' ? 'disabled' : '';
        const rightDisabled =
          item.specs.finishRightType === 'EP' || item.specs.finishRightType === 'None' ? 'disabled' : '';
        const leftWidthVal =
          item.specs.finishLeftType === 'EP'
            ? 20
            : item.specs.finishLeftType === 'None'
              ? 0
              : item.specs.finishLeftWidth || 60;
        const rightWidthVal =
          item.specs.finishRightType === 'EP'
            ? 20
            : item.specs.finishRightType === 'None'
              ? 0
              : item.specs.finishRightWidth || 60;

        ws.innerHTML = `
    <style>
      .fridge-brand-tabs{display:flex;gap:8px;margin-bottom:12px}.fridge-brand-tab{padding:8px 20px;border:2px solid #ddd;border-radius:8px;background:#f9f9f9;cursor:pointer;font-weight:600;font-size:13px}.fridge-brand-tab.active{border-color:#0ea5e9;background:#e0f2fe;color:#0369a1}.fridge-cat-group{margin-bottom:10px}.fridge-cat-title{font-size:11px;font-weight:700;color:#666;margin-bottom:5px}.fridge-btn-row{display:flex;flex-wrap:wrap;gap:5px}.fridge-model-btn{padding:5px 8px;border:1px solid #ddd;border-radius:5px;background:white;font-size:10px;cursor:pointer;min-width:80px}.fridge-model-btn:hover{border-color:#0ea5e9;background:#f0f9ff}.fridge-model-btn.selected{border-color:#0ea5e9;background:#0ea5e9;color:white}.fridge-model-btn.selected span{color:#e0f2fe!important}.module-add-btns{display:flex;gap:8px;margin-bottom:12px}.module-add-btn{flex:1;padding:10px;border:2px dashed #ccc;border-radius:8px;background:white;font-size:12px;cursor:pointer;font-weight:600}.module-add-btn:hover{border-style:solid}.module-add-btn.tall{color:#10b981;border-color:#10b981}.module-add-btn.tall:hover{background:#dcfce7}.module-add-btn.homecafe{color:#8b5cf6;border-color:#8b5cf6}.module-add-btn.homecafe:hover{background:#f3e8ff}.auto-calc-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;margin-bottom:15px}.auto-calc-btn:hover{opacity:0.9}.auto-calc-btn:disabled{background:#ccc;cursor:not-allowed}.overflow-warning{background:#fee2e2;color:#b91c1c;padding:8px 12px;border-radius:6px;font-size:11px;margin-bottom:10px}.module-inline-inputs{display:flex;align-items:center;gap:4px;font-size:10px;margin-top:4px}.module-inline-inputs input,.module-inline-inputs select{padding:2px 4px;font-size:10px;border:1px solid #ddd;border-radius:4px}.module-order-btns{display:flex;flex-direction:column;gap:2px;margin-right:8px}.order-btn{width:24px;height:20px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;cursor:pointer;font-size:10px;padding:0}.order-btn:hover:not(:disabled){background:#e0e0e0}.order-btn:disabled{opacity:0.3;cursor:not-allowed}.module-card{display:flex;align-items:center;padding:10px;background:#f9fafb;border-radius:8px;margin-bottom:8px}.height-inputs{display:flex;gap:8px;margin-top:8px;padding:8px;background:#f0f9ff;border-radius:6px;font-size:10px}.height-inputs label{color:#0369a1;font-weight:600}.height-inputs input{width:50px;padding:2px 4px;border:1px solid #0ea5e9;border-radius:4px;font-size:10px}.toggle-btn{padding:2px 6px;border:1px solid #ccc;border-radius:4px;background:#f9f9f9;font-size:9px;cursor:pointer}.toggle-btn:hover{background:#e5e5e5}.toggle-btn.active{background:#ef4444;color:white;border-color:#ef4444}.toggle-btn.el{border-color:#10b981;color:#10b981}.toggle-btn.el.active{background:#10b981;color:white}.el-config-btn{padding:2px 8px;border:1px solid #10b981;border-radius:4px;background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);font-size:9px;cursor:pointer;color:#065f46;font-weight:600}.el-config-btn:hover{background:linear-gradient(135deg,#bbf7d0 0%,#86efac 100%)}.auto-calc-btn-sm{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;padding:4px 10px;border-radius:6px;font-weight:600;cursor:pointer;font-size:10px}.auto-calc-btn-sm:hover{opacity:0.9}.auto-calc-btn-sm:disabled{background:#ccc;cursor:not-allowed}
    </style>
    <div class="ws-header">
      <div class="ws-title">ğŸ§Š ${item.labelName || item.name} <span class="ws-info-badge">${W} Ã— ${H} Ã— ${D}</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-purple-gradient" onclick="generateAIDesign()" title="AI ë””ìì¸ ì´ë¯¸ì§€ ìƒì„±">ğŸ¨ AI ë””ìì¸ ìƒì„±</button>
        <button style="background:var(--primary-color);color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" onclick="saveDesignToFile()">ğŸ’¾ ì €ì¥</button>
        <button class="btn-back" onclick="goBackToStep1()">â† ëª©ë¡</button>
      </div>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">ë¸Œëœë“œ ì„ íƒ</div>
        <div class="fridge-brand-tabs">
          <div class="fridge-brand-tab ${brand === 'LG' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'LG')">LG</div>
          <div class="fridge-brand-tab ${brand === 'Samsung' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'Samsung')">ì‚¼ì„±</div>
        </div>
        <div class="spec-group-title">ëƒ‰ì¥ê³  ëª¨ë¸ ì„ íƒ</div>
        <div style="max-height:200px;overflow-y:auto;padding-right:6px;margin-bottom:12px;">${fridgeButtonsHtml}</div>
        <div class="spec-group-title">ì„¤ì •</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”©</label><input type="number" value="${MOLDING_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgeMoldingH', this.value)"></div>
          <div class="spec-field"><label>ê¹Šì´</label><input type="number" value="${MODULE_D}" onchange="updateFridgeSpec(${item.uniqueId}, 'fridgeModuleD', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>í•˜ë¶€ ë‹¤ë¦¬</label><select onchange="updateFridgeLegType(${item.uniqueId}, this.value)">${FRIDGE_LEG_TYPES.map((t) => `<option value="${t.id}" ${(item.specs.fridgeLegType || 'pedestal') === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>ë†’ì´</label><input type="number" value="${PEDESTAL_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgePedestal', this.value)"></div>
        </div>
        <div class="spec-group-title">ë§ˆê° ì„¤ì •</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Left', this.value)">${FINISH_TYPES.map((t) => `<option value="${t.id}" ${item.specs.finishLeftType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>ê¸¸ì´</label><input type="number" value="${leftWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)" ${leftDisabled}></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Right', this.value)">${FINISH_TYPES.map((t) => `<option value="${t.id}" ${item.specs.finishRightType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select></div>
          <div class="spec-field"><label>ê¸¸ì´</label><input type="number" value="${rightWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishRightWidth', this.value)" ${rightDisabled}></div>
        </div>
        <div style="font-size:9px;color:#888;margin-top:4px;">â€» ê¸°ë³¸ê°’: ëª°ë”©=60, íœ ë¼=60, EP=20, ì—†ìŒ=0</div>
      </div>
      <div class="module-panel">
        <div class="front-view-section" style="margin-bottom:12px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span>ğŸ“ Front View</span>
              <span style="font-size:11px;color:#888;font-weight:normal;">(ë„ì–´ ê¸°ì¤€)</span>
            </div>
            <button onclick="toggleFridgeDoors(${item.uniqueId})" class="toggle-btn ${item.specs.showDoors ? 'active' : ''}" style="padding:4px 12px;font-size:11px;">ğŸšª ë„ì–´</button>
          </div>
          <div style="text-align:center;">
            <svg width="${svgWidth}" height="${svgHeight + 20}" style="background:#fafafa;border-radius:8px;border:1px solid #eee;">
              <defs><marker id="arrowL" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M6,0 L0,3 L6,6" fill="none" stroke="#333"/></marker><marker id="arrowR" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6" fill="none" stroke="#333"/></marker></defs>
              ${moduleSvg}
            </svg>
          </div>
        </div>
        ${isOverflow ? `<div class="overflow-warning">âš ï¸ ìœ íš¨ê³µê°„(${effectiveW}mm)ì„ ${Math.abs(remaining)}mm ì´ˆê³¼!</div>` : ''}
        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg,#e0f2fe,#f0f9ff);color:#0369a1;border-left:4px solid #0ea5e9;">
            <div class="section-title-row" style="display:flex;align-items:center;justify-content:space-between;width:100%;">
              <div><span>ğŸ“¦ ëª¨ë“ˆ êµ¬ì„±</span><span style="font-size:11px;font-weight:normal;color:#666;margin-left:8px;">ìœ íš¨: ${effectiveW}mm</span></div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span class="section-remaining" style="color:${isOverflow ? '#ef4444' : '#10b981'};font-size:11px;">ì”ì—¬: ${remaining}mm</span>
                <button class="auto-calc-btn-sm" onclick="autoCalculateFridge(${item.uniqueId})" ${allModules.length === 0 ? 'disabled' : ''}>âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="height-inputs">
            <label>ìƒë¶€ì¥H</label><input type="number" value="${Math.round(upperDoorH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeUpperH', this.value)">
            <label>ì¤‘ê°„ì¥H</label><input type="number" value="${Math.round(middleH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeMiddleH', this.value)">
            <label>í•˜ë¶€ì¥H</label><input type="number" value="${Math.round(lowerH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeLowerH', this.value)">
          </div>
          <div class="module-add-btns" style="margin-top:10px;">
            <button class="module-add-btn tall" onclick="addFridgeSideModule(${item.uniqueId}, 'tall')">ğŸ—„ï¸ + í‚¤í°ì¥</button>
            <button class="module-add-btn homecafe" onclick="addFridgeSideModule(${item.uniqueId}, 'homecafe')">â˜• + í™ˆì¹´í˜ì¥</button>
          </div>
          ${moduleCardsHtml || '<div style="padding:15px;text-align:center;color:#999;font-size:11px;">ëƒ‰ì¥ê³ ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ëª¨ë“ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>'}
        </div>
      </div>
    </div>
  `;
      }

      function changeFridgeBrand(itemUniqueId, brand) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs.fridgeBrand = brand;
          item.modules = item.modules.filter((m) => m.type !== 'fridge');
          renderWorkspaceContent(item);
        }
      }

      function selectFridgeModel(itemUniqueId, modelId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const brand = item.specs.fridgeBrand || 'LG';
        let model = null;
        Object.values(FRIDGE_DATA[brand].categories).forEach((cat) => {
          const found = cat.find((m) => m.id === modelId);
          if (found) model = found;
        });
        if (!model) return;

        item.modules = item.modules.filter((m) => m.type !== 'fridge');
        const existingModules = item.modules;
        const midOrder = existingModules.length > 0 ? Math.floor(existingModules.length / 2) + 1 : 1;
        existingModules.forEach((m, idx) => {
          m.order = idx < Math.floor(existingModules.length / 2) ? idx + 1 : idx + 2;
        });

        item.modules.push({
          id: Date.now(),
          modelId: model.id,
          type: 'fridge',
          name: model.name,
          w: model.w,
          h: model.h,
          d: model.d,
          line: model.line,
          sideGap: model.sideGap,
          betweenGap: model.betweenGap,
          units: model.units,
          order: midOrder,
        });

        // ë†’ì´ ìë™ ì¬ê³„ì‚°
        recalcFridgeHeights(item);
        renderWorkspaceContent(item);
      }

      // â˜… ë†’ì´ ìë™ ì¬ê³„ì‚° í•¨ìˆ˜
      function recalcFridgeHeights(item) {
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const fridgeMod = item.modules.find((m) => m.type === 'fridge');

        if (fridgeMod) {
          // ìƒë¶€ì¥ ë†’ì´ = ì „ì²´ - ëƒ‰ì¥ê³ ë†’ì´ - ìƒë‹¨ê°„ê²© - ìƒëª°ë”©
          const calcUpperH = Math.max(
            0,
            Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeMod.h - FRIDGE_RULES.TOP_GAP - MOLDING_H)
          );
          item.specs.fridgeUpperH = calcUpperH;

          // ëª¨ë“ˆ ë³¸ì²´ ì˜ì—­ = ì „ì²´ - ìƒëª°ë”© - ìƒë¶€ì¥ - ì¢ŒëŒ€
          const moduleBodyH = H - MOLDING_H - calcUpperH - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH * 0.55);
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - item.specs.fridgeMiddleH);
        }
      }

      function removeFridgeModule(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.modules = item.modules.filter((m) => m.id !== modId);
          item.modules.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((m, idx) => (m.order = idx + 1));
          renderWorkspaceContent(item);
        }
      }

      function addFridgeSideModule(itemUniqueId, type) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const H = parseFloat(item.h) || 2290;
        const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
        const defaultW = type === 'tall' ? FRIDGE_RULES.EL_W : FRIDGE_RULES.HOMECAFE_W;
        const maxOrder = item.modules.length > 0 ? Math.max(...item.modules.map((m) => m.order || 0)) : 0;
        item.modules.push({
          id: Date.now(),
          type: type,
          name: type === 'tall' ? 'í‚¤í°ì¥' : 'í™ˆì¹´í˜ì¥',
          order: maxOrder + 1,
          w: defaultW,
          h: H,
          d: MODULE_D,
          doorType: 'swing',
          lowerType: 'default',
          isFixed: false,
          isEL: false,
        });
        renderWorkspaceContent(item);
      }

      function moveFridgeModule(itemUniqueId, modId, direction) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        const idx = modules.findIndex((m) => m.id === modId);
        if (idx === -1) return;
        if (direction === -1 && idx === 0) return;
        if (direction === 1 && idx === modules.length - 1) return;
        const swapIdx = idx + direction;
        const tempOrder = modules[idx].order;
        modules[idx].order = modules[swapIdx].order;
        modules[swapIdx].order = tempOrder;
        renderWorkspaceContent(item);
      }

      function toggleFridgeDoors(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        if (!item.specs) item.specs = {};
        item.specs.showDoors = !item.specs.showDoors;
        renderWorkspaceContent(item);
      }

      function updateFridgeModuleW(itemUniqueId, modId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.w = parseFloat(value) || 0;
          mod.isFixed = true;
          renderWorkspaceContent(item);
        }
      }

      function toggleFridgeModuleFixed(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.isFixed = !mod.isFixed;
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeSideModule(itemUniqueId, modId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod[field] = value;
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeDoorDivision(itemUniqueId, modId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.doorDivision = value;
          renderWorkspaceContent(item);
        }
      }

      function toggleFridgeModuleEL(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (mod) {
          mod.hasEL = !mod.hasEL;
          // ELì¥ì´ ì—†ì„ ë•Œ í™œì„±í™”í•˜ë©´ ê¸°ë³¸ ELëª¨ë“ˆ ì¶”ê°€
          if (mod.hasEL && (!mod.elModules || mod.elModules.length === 0)) {
            mod.elModules = [{ id: 1, type: 'open', h: 450 }];
          }
          renderWorkspaceContent(item);
        }
      }

      function updateFridgeSpec(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          renderWorkspaceContent(item);
        }
      }

      // ìƒëª°ë”©, ì¢ŒëŒ€ ë³€ê²½ ì‹œ ë†’ì´ ì¬ê³„ì‚°
      function updateFridgeSpecWithRecalc(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (item) {
          item.specs[field] = parseFloat(value) || value;
          recalcFridgeHeights(item);
          renderWorkspaceContent(item);
        }
      }

      // ë†’ì´ ê°’ ë³€ê²½ ì‹œ ì—°ë™ ê³„ì‚°
      function updateFridgeHeightWithRecalc(itemUniqueId, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;

        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
        const newVal = parseFloat(value) || 0;

        if (field === 'fridgeUpperH') {
          item.specs.fridgeUpperH = newVal;
          const moduleBodyH = H - MOLDING_H - newVal - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH * 0.55);
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - item.specs.fridgeMiddleH);
        } else if (field === 'fridgeMiddleH') {
          item.specs.fridgeMiddleH = newVal;
          const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
          const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
          item.specs.fridgeLowerH = Math.floor(moduleBodyH - newVal);
        } else if (field === 'fridgeLowerH') {
          item.specs.fridgeLowerH = newVal;
          const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
          const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
          item.specs.fridgeMiddleH = Math.floor(moduleBodyH - newVal);
        }

        renderWorkspaceContent(item);
      }

      function updateFridgeFinish(itemUniqueId, side, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs[`finish${side}Type`] = value;
        // ë§ˆê°ì¬ ê¸°ë³¸ê°’: ëª°ë”©=60, íœ ë¼=60, EP=20, ì—†ìŒ=0
        const finishType = FINISH_TYPES.find((t) => t.id === value);
        if (finishType) item.specs[`finish${side}Width`] = finishType.defaultW;
        renderWorkspaceContent(item);
      }

      function updateFridgeLegType(itemUniqueId, value) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        item.specs.fridgeLegType = value;
        const legType = FRIDGE_LEG_TYPES.find((t) => t.id === value);
        if (legType) item.specs.fridgePedestal = legType.defaultH;
        recalcFridgeHeights(item);
        renderWorkspaceContent(item);
      }

      function autoCalculateFridge(itemUniqueId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item || item.modules.length === 0) {
          alert('ëª¨ë“ˆì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          return;
        }

        const W = parseFloat(item.w) || 0;
        const fL =
          item.specs.finishLeftType !== 'None'
            ? item.specs.finishLeftType === 'EP'
              ? 20
              : parseFloat(item.specs.finishLeftWidth) || 60
            : 0;
        const fR =
          item.specs.finishRightType !== 'None'
            ? item.specs.finishRightType === 'EP'
              ? 20
              : parseFloat(item.specs.finishRightWidth) || 60
            : 0;
        const effectiveW = W - fL - fR;

        const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
        let fixedW = 0,
          adjustableCount = 0;

        modules.forEach((mod) => {
          if (mod.type === 'fridge') {
            const sideGap = mod.sideGap || 50;
            const betweenGap = mod.betweenGap || 0;
            const units = mod.units || [{ w: mod.w }];
            fixedW += sideGap * 2;
            units.forEach((u, idx) => {
              fixedW += u.w;
              if (idx < units.length - 1) fixedW += betweenGap;
            });
          } else if (mod.isFixed) {
            fixedW += parseFloat(mod.w) || 0;
          } else {
            adjustableCount++;
          }
        });

        if (adjustableCount === 0) {
          alert('ì¡°ì ˆ ê°€ëŠ¥í•œ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        const remainingW = effectiveW - fixedW;
        if (remainingW <= 0) {
          alert('ìœ íš¨ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }
        const perModuleW = Math.floor(remainingW / adjustableCount);
        if (perModuleW < 300) {
          alert(`ê° ëª¨ë“ˆì— ${perModuleW}mmë§Œ í• ë‹¹ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
          return;
        }

        modules.forEach((mod) => {
          if (mod.type !== 'fridge' && !mod.isFixed) mod.w = perModuleW;
        });
        renderWorkspaceContent(item);
      }

      // ì´ˆê¸°í™”
      initCategoryGrid();

      // ============================================================
      // ELì¥ íŒì—… ê¸°ëŠ¥
      // ============================================================
      let currentELPopup = { itemId: null, modId: null };

      function openELPopup(itemUniqueId, modId) {
        const item = selectedItems.find((i) => i.uniqueId === itemUniqueId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === modId);
        if (!mod) return;

        currentELPopup = { itemId: itemUniqueId, modId: modId };

        // EL ëª¨ë“ˆ ë°°ì—´ ì´ˆê¸°í™”
        if (!mod.elModules) mod.elModules = [];

        // íŒì—… HTML ìƒì„±
        renderELPopup(item, mod);
      }

      function renderELPopup(item, mod) {
        // ê¸°ì¡´ íŒì—… ì œê±°
        const existingPopup = document.getElementById('el-popup-overlay');
        if (existingPopup) existingPopup.remove();

        // í‚¤í°ì¥ ì „ì²´ í¬ê¸° ê³„ì‚°
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);
        const lowerH = parseFloat(item.specs.fridgeLowerH) || Math.floor(moduleBodyH * 0.45);
        const modW = mod.w;

        // í•˜ë¶€ì¥ ë†’ì´ (870mm = í•˜ë¶€ì¥ + ì¢ŒëŒ€)
        const lowerWithPedestal = lowerH + PEDESTAL_H;

        // í‚¤í°ì¥ ì „ì²´ ë†’ì´ (ìƒë¶€ì¥ ì œì™¸, ì¤‘ê°„ì¥ + í•˜ë¶€ì¥ + ì¢ŒëŒ€)
        const tallTotalH = middleH + lowerH + PEDESTAL_H;

        // SVG í”„ë¡ íŠ¸ë·° ìƒì„± - í¬ê¸° ìµœì í™”
        const svgWidth = 220;
        const svgHeight = 480;
        const scale = Math.min((svgWidth - 40) / modW, (svgHeight - 100) / tallTotalH);
        const drawW = modW * scale;
        const offsetX = (svgWidth - drawW) / 2;
        const offsetY = 50;

        // ìŠ¤ì¼€ì¼ëœ ë†’ì´
        const middleH_s = middleH * scale;
        const lowerH_s = lowerH * scale;
        const pedestalH_s = PEDESTAL_H * scale;

        let moduleSvg = '';
        let currentY = offsetY;
        let usedH = 0;

        // ì¤‘ê°„ì¥ ì˜ì—­ - EL ëª¨ë“ˆë“¤ ê·¸ë¦¬ê¸°
        if (mod.elModules && mod.elModules.length > 0) {
          mod.elModules.forEach((elMod, idx) => {
            const elModH = elMod.h * scale;
            const isOpen = elMod.type === 'open';
            const isEL = elMod.isEL === true; // ê¸°ë³¸ê°’ false (ê¸°ë³¸ëª¨ë“ˆ)
            // ELì¥: ë…¹ìƒ‰, ê¸°ë³¸ëª¨ë“ˆ: íšŒìƒ‰, ì˜¤í”ˆì¥: ë…¸ë€ìƒ‰
            let fillColor, strokeColor, labelColor, icon, label;
            if (isOpen) {
              fillColor = '#fef3c7';
              strokeColor = '#f59e0b';
              labelColor = '#b45309';
              icon = 'ğŸ“‚';
              label = 'ì˜¤í”ˆì¥';
            } else if (isEL) {
              fillColor = '#dcfce7';
              strokeColor = '#10b981';
              labelColor = '#065f46';
              icon = 'âš¡';
              label = 'ELì¥';
            } else {
              fillColor = '#f3f4f6';
              strokeColor = '#9ca3af';
              labelColor = '#4b5563';
              icon = 'ğŸ“¦';
              label = 'ëª¨ë“ˆ';
            }
            const doorName = EL_DOOR_TYPES.find((t) => t.id === elMod.doorType)?.name || 'ì—¬ë‹«ì´';

            moduleSvg += `
        <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${elModH}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="4"/>
        <text x="${offsetX + drawW / 2}" y="${currentY + elModH / 2 - 6}" text-anchor="middle" font-size="11" fill="${labelColor}" font-weight="bold">${icon} ${label}</text>
        <text x="${offsetX + drawW / 2}" y="${currentY + elModH / 2 + 8}" text-anchor="middle" font-size="9" fill="#666">${!isOpen && isEL ? doorName + ' | ' : ''}${elMod.h}mm</text>
      `;
            currentY += elModH;
            usedH += elMod.h;
          });
        }

        // ì¤‘ê°„ì¥ ë‚¨ì€ ê³µê°„
        const remainingH = middleH - usedH;
        if (remainingH > 0) {
          const remainingScaled = remainingH * scale;
          moduleSvg += `
      <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${remainingScaled}" fill="#f0fdf4" stroke="#86efac" stroke-width="1" stroke-dasharray="4"/>
      <text x="${offsetX + drawW / 2}" y="${currentY + remainingScaled / 2}" text-anchor="middle" font-size="11" fill="#16a34a">ì¤‘ê°„ì¥ ì”ì—¬: ${Math.round(remainingH)}mm</text>
    `;
          currentY += remainingScaled;
        }

        // í•˜ë¶€ì¥
        const lowerIcon = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.icon || 'ğŸ—„ï¸';
        const lowerName = LOWER_MODULE_TYPES.find((t) => t.id === mod.lowerType)?.name || 'ê¸°ë³¸';
        moduleSvg += `
    <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${lowerH_s}" fill="#f3f4f6" stroke="#6b7280" stroke-width="2" rx="4"/>
    <text x="${offsetX + drawW / 2}" y="${currentY + lowerH_s / 2 - 4}" text-anchor="middle" font-size="11" fill="#374151" font-weight="bold">${lowerIcon} í•˜ë¶€ì¥</text>
    <text x="${offsetX + drawW / 2}" y="${currentY + lowerH_s / 2 + 12}" text-anchor="middle" font-size="9" fill="#666">${lowerH}mm</text>
  `;
        currentY += lowerH_s;

        // ì¢ŒëŒ€
        moduleSvg += `
    <rect x="${offsetX}" y="${currentY}" width="${drawW}" height="${pedestalH_s}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1" rx="2"/>
    <text x="${offsetX + drawW / 2}" y="${currentY + pedestalH_s / 2 + 3}" text-anchor="middle" font-size="8" fill="#6b7280">ì¢ŒëŒ€ ${PEDESTAL_H}mm</text>
  `;

        // ì¹˜ìˆ˜ì„ 
        const totalDrawH = middleH_s + lowerH_s + pedestalH_s;
        moduleSvg += `
    <line x1="${offsetX + drawW + 15}" y1="${offsetY}" x2="${offsetX + drawW + 15}" y2="${offsetY + middleH_s}" stroke="#10b981" stroke-width="1"/>
    <text x="${offsetX + drawW + 20}" y="${offsetY + middleH_s / 2}" font-size="9" fill="#10b981" dominant-baseline="middle">ì¤‘ê°„ì¥ ${middleH}</text>
    <line x1="${offsetX + drawW + 15}" y1="${offsetY + middleH_s}" x2="${offsetX + drawW + 15}" y2="${offsetY + middleH_s + lowerH_s + pedestalH_s}" stroke="#6b7280" stroke-width="1"/>
    <text x="${offsetX + drawW + 20}" y="${offsetY + middleH_s + (lowerH_s + pedestalH_s) / 2}" font-size="9" fill="#6b7280" dominant-baseline="middle">í•˜ë¶€ ${lowerWithPedestal}</text>
  `;

        // EL ëª¨ë“ˆ ì¹´ë“œ HTML - ì´ë™ë²„íŠ¼ ì¢Œì¸¡, ê³ ì •ë²„íŠ¼ ì¶”ê°€, ELì¥ í† ê¸€
        const elModuleCards = (mod.elModules || [])
          .map((elMod, idx) => {
            const isOpen = elMod.type === 'open';
            const isEL = elMod.isEL === true; // ê¸°ë³¸ê°’ false (ê¸°ë³¸ëª¨ë“ˆ)
            const isFixed = elMod.isFixed || false;
            const fixedClass = isFixed ? 'fixed-active' : '';
            const elClass = isEL ? 'active' : '';
            return `
      <div class="el-module-card" style="border-left:4px solid ${isOpen ? '#f59e0b' : isEL ? '#10b981' : '#9ca3af'};">
        <div class="el-module-move-btns">
          <button onclick="moveELModule(${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>â–²</button>
          <button onclick="moveELModule(${idx}, 1)" ${idx === mod.elModules.length - 1 ? 'disabled' : ''}>â–¼</button>
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
            <span style="font-weight:700;font-size:12px;">${isOpen ? 'ğŸ“‚ ì˜¤í”ˆì¥' : 'ğŸ“¦ ëª¨ë“ˆ'}</span>
            ${!isOpen ? `<button class="toggle-btn el ${elClass}" onclick="toggleELModuleIsEL(${idx})" style="margin-left:auto;">ELì¥</button>` : ''}
          </div>
          <div class="el-module-inputs">
            <label>ë†’ì´</label>
            <input type="number" value="${elMod.h}" onchange="updateELModule(${idx}, 'h', this.value)">
            <span>mm</span>
            ${
              !isOpen
                ? `
              <label>ë„ì–´</label>
              <select onchange="updateELModule(${idx}, 'doorType', this.value)" ${mod.doorDivision && mod.doorDivision !== 'individual' ? 'disabled style="opacity:0.5;"' : ''}>
                ${EL_DOOR_TYPES.map((t) => `<option value="${t.id}" ${elMod.doorType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
              </select>
              ${mod.doorDivision && mod.doorDivision !== 'individual' ? '<span style="font-size:8px;color:#888;">(ë„ì–´ êµ¬ë¶„ ì ìš©)</span>' : ''}
            `
                : ''
            }
          </div>
        </div>
        <div class="el-module-action-btns">
          <button onclick="toggleELModuleFixed(${idx})" class="fixed-btn ${fixedClass}">ê³ ì •</button>
          <button onclick="removeELModule(${idx})" class="del-btn">Ã—</button>
        </div>
      </div>
    `;
          })
          .join('');

        const modTypeName = mod.type === 'tall' ? 'í‚¤í°ì¥' : 'í™ˆì¹´í˜ì¥';

        const popupHtml = `
    <div id="el-popup-overlay" class="el-popup-overlay" onclick="if(event.target===this)closeELPopup()">
      <div class="el-popup">
        <div class="el-popup-header">
          <span>âš¡ ${modTypeName} ì„¤ì • (${mod.w}mm)</span>
          <button onclick="closeELPopup()" class="el-popup-close">âœ•</button>
        </div>
        <div class="el-popup-body">
          <div class="el-popup-preview">
            <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border-radius:12px;border:1px solid #e5e7eb;">
              <text x="${svgWidth / 2}" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">${modTypeName} Front View</text>
              <text x="${svgWidth / 2}" y="${svgHeight - 15}" text-anchor="middle" font-size="10" fill="#666">W: ${modW}mm</text>
              ${moduleSvg}
            </svg>
          </div>
          <div class="el-popup-controls">
            <div class="el-popup-info">
              <div class="info-row"><span class="info-label">ìœ íš¨ê³µê°„</span><span class="info-value">${middleH}mm</span></div>
              <div class="info-row"><span class="info-label">EL ì‚¬ìš©</span><span class="info-value">${usedH}mm</span></div>
              <div class="info-row highlight"><span class="info-label">ì”ì—¬</span><span class="info-value ${remainingH < 0 ? 'over' : ''}">${remainingH}mm</span></div>
              <div class="info-row auto-calc-row"><button onclick="autoCalculateELModules()" class="el-auto-calc-btn">âš¡ ìë™ê³„ì‚°</button></div>
            </div>
            <div class="el-popup-section-title">EL ëª¨ë“ˆ ì¶”ê°€</div>
            <div class="el-add-btns">
              <button class="el-add-btn el-type" onclick="addELSubModule('el')">âš¡ ëª¨ë“ˆ ì¶”ê°€</button>
              <button class="el-add-btn open-type" onclick="addELSubModule('open')">ğŸ“‚ ì˜¤í”ˆì¥ ì¶”ê°€</button>
            </div>
            <div class="el-popup-section-title">ëª¨ë“ˆ ëª©ë¡ (${mod.elModules?.length || 0}ê°œ)</div>
            <div class="el-module-list">
              ${elModuleCards || '<div class="empty-msg">ëª¨ë“ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>'}
            </div>
            <div class="el-popup-section-title">í•˜ë¶€ì¥ ì„¤ì •</div>
            <div class="el-lower-selector">
              ${LOWER_MODULE_TYPES.map(
                (t) => `
                <button onclick="updateELLowerType('${t.id}')" class="el-lower-btn ${mod.lowerType === t.id ? 'active' : ''}" data-type="${t.id}">
                  <span class="lower-icon">${t.icon}</span>
                  <span class="lower-name">${t.name}</span>
                </button>
              `
              ).join('')}
            </div>
          </div>
        </div>
        <div class="el-popup-footer">
          <div class="footer-info">ğŸ’¡ ELì¥: ì „ë™ ê°€ì „ìˆ˜ë‚© | ì˜¤í”ˆì¥: ë„ì–´ ì—†ìŒ</div>
          <button onclick="applyELPopupAndClose()" class="el-popup-save-btn">ì™„ë£Œ</button>
        </div>
      </div>
    </div>
    <style>
      .el-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center}
      .el-popup{background:white;border-radius:20px;width:720px;max-width:95vw;max-height:90vh;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,0.35)}
      .el-popup-header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;font-weight:700;font-size:16px}
      .el-popup-close{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0 4px}
      .el-popup-body{display:flex;gap:24px;padding:24px;max-height:calc(90vh - 160px);overflow-y:auto}
      .el-popup-preview{flex:0 0 auto}
      .el-popup-controls{flex:1;min-width:0}
      .el-popup-info{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;padding:12px;background:#f0fdf4;border-radius:10px}
      .info-row{display:flex;flex-direction:column;align-items:center;padding:8px}
      .info-row.highlight{background:#dcfce7;border-radius:8px}
      .info-row.auto-calc-row{justify-content:center}
      .info-label{font-size:10px;color:#666;margin-bottom:2px}
      .info-value{font-size:16px;font-weight:700;color:#065f46}
      .info-value.over{color:#ef4444}
      .el-auto-calc-btn{padding:8px 14px;background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer}
      .el-auto-calc-btn:hover{opacity:0.9}
      .el-popup-section-title{font-size:13px;font-weight:700;color:#333;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid #e5e7eb}
      .el-add-btns{display:flex;gap:10px;margin-bottom:16px}
      .el-add-btn{flex:1;padding:14px;border:2px dashed #ccc;border-radius:10px;background:white;font-size:13px;cursor:pointer;font-weight:700;transition:all 0.2s}
      .el-add-btn.el-type{color:#10b981;border-color:#10b981}.el-add-btn.el-type:hover{background:#dcfce7;border-style:solid}
      .el-add-btn.open-type{color:#f59e0b;border-color:#f59e0b}.el-add-btn.open-type:hover{background:#fef3c7;border-style:solid}
      .el-module-list{max-height:220px;overflow-y:auto}
      .el-module-card{display:flex;align-items:center;gap:10px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:10px}
      .el-module-move-btns{display:flex;flex-direction:column;gap:4px}
      .el-module-move-btns button{width:26px;height:26px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:11px}
      .el-module-move-btns button:hover:not(:disabled){background:#e5e5e5}
      .el-module-move-btns button:disabled{opacity:0.3}
      .el-module-inputs{display:flex;align-items:center;gap:8px;font-size:11px;flex-wrap:wrap}
      .el-module-inputs label{font-weight:600;color:#555}
      .el-module-inputs input{width:70px;padding:6px 8px;font-size:12px;border:1px solid #ddd;border-radius:6px}
      .el-module-inputs select{padding:6px 8px;font-size:12px;border:1px solid #ddd;border-radius:6px}
      .el-module-inputs span{color:#888}
      .el-module-action-btns{display:flex;gap:6px;margin-left:auto}
      .el-module-action-btns button{height:28px;border:1px solid #ddd;border-radius:6px;background:#f9f9f9;cursor:pointer;font-size:11px}
      .el-module-action-btns .fixed-btn{padding:0 10px;color:#6b7280;border-color:#d1d5db}
      .el-module-action-btns .fixed-btn:hover{background:#e5e5e5}
      .el-module-action-btns .fixed-btn.fixed-active{background:#dbeafe;color:#2563eb;border-color:#3b82f6;font-weight:700}
      .el-module-action-btns .del-btn{width:28px;color:#ef4444;border-color:#fecaca}
      .el-module-action-btns .del-btn:hover{background:#fee2e2}
      .empty-msg{padding:20px;text-align:center;color:#999;font-size:12px;background:#f9fafb;border-radius:8px}
      .el-lower-selector{display:flex;gap:10px;margin-bottom:16px}
      .el-lower-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border:2px solid #e5e7eb;border-radius:10px;background:white;cursor:pointer;transition:all 0.2s}
      .el-lower-btn:hover{border-color:#6b7280;background:#f9fafb}
      .el-lower-btn.active{border-color:#3b82f6;background:#eff6ff}
      .el-lower-btn .lower-icon{font-size:20px}
      .el-lower-btn .lower-name{font-size:11px;font-weight:600;color:#374151}
      .el-lower-btn.active .lower-name{color:#2563eb}
      .el-popup-footer{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;border-top:1px solid #e5e7eb;background:#f9fafb}
      .footer-info{font-size:11px;color:#666}
      .el-popup-save-btn{padding:12px 28px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer}
      .el-popup-save-btn:hover{opacity:0.9}
    </style>
  `;

        document.body.insertAdjacentHTML('beforeend', popupHtml);
      }

      function closeELPopup() {
        const popup = document.getElementById('el-popup-overlay');
        if (popup) popup.remove();
        currentELPopup = { itemId: null, modId: null };
      }

      // EL íŒì—… ì™„ë£Œ ì‹œ í”„ë¡ íŠ¸ë·° ë°˜ì˜
      function applyELPopupAndClose() {
        const popup = document.getElementById('el-popup-overlay');
        if (popup) popup.remove();

        // ë©”ì¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ í”„ë¡ íŠ¸ë·° ë°˜ì˜
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (item) {
          renderWorkspaceContent(item);
        }

        currentELPopup = { itemId: null, modId: null };
      }

      // EL íŒì—…ì—ì„œ í•˜ë¶€ì¥ íƒ€ì… ë³€ê²½
      function updateELLowerType(typeId) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod) return;

        mod.lowerType = typeId;
        renderELPopup(item, mod);
      }

      function addELSubModule(type) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod) return;

        if (!mod.elModules) mod.elModules = [];

        // ê¸°ë³¸ ë†’ì´ ê³„ì‚° (ì”ì—¬ ë†’ì´ ë˜ëŠ” 300mm)
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);

        const usedH = mod.elModules.reduce((sum, m) => sum + m.h, 0);
        const remainingH = middleH - usedH;
        // ì˜¤í”ˆì¥ì€ 450mm ê¸°ë³¸ê°’, ELì¥ì€ ì”ì—¬ ë†’ì´ ê¸°ë°˜
        const defaultH = type === 'open' ? 450 : Math.min(300, Math.max(100, remainingH));

        mod.elModules.push({
          id: Date.now(),
          type: type,
          h: defaultH,
          doorType: type === 'el' ? 'swing' : null, // ì˜¤í”ˆì¥ì€ ë„ì–´ ì—†ìŒ
          isFixed: false, // ê³ ì • ì—¬ë¶€
          isEL: false, // ê¸°ë³¸ê°’: ê¸°ë³¸ëª¨ë“ˆ (ELì¥ ì•„ë‹˜)
        });

        renderELPopup(item, mod);
      }

      function removeELModule(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules) return;

        mod.elModules.splice(idx, 1);
        renderELPopup(item, mod);
      }

      function updateELModule(idx, field, value) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        if (field === 'h') {
          mod.elModules[idx].h = parseFloat(value) || 100;
        } else {
          mod.elModules[idx][field] = value;
        }

        renderELPopup(item, mod);
      }

      function moveELModule(idx, direction) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules) return;

        const newIdx = idx + direction;
        if (newIdx < 0 || newIdx >= mod.elModules.length) return;

        [mod.elModules[idx], mod.elModules[newIdx]] = [mod.elModules[newIdx], mod.elModules[idx]];
        renderELPopup(item, mod);
      }

      // EL ëª¨ë“ˆ ê³ ì • í† ê¸€
      function toggleELModuleFixed(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        mod.elModules[idx].isFixed = !mod.elModules[idx].isFixed;
        renderELPopup(item, mod);
      }

      // EL ëª¨ë“ˆ ELì¥/ê¸°ë³¸ëª¨ë“ˆ í† ê¸€
      function toggleELModuleIsEL(idx) {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || !mod.elModules[idx]) return;

        // í† ê¸€: trueë©´ falseë¡œ, false/undefinedë©´ trueë¡œ
        mod.elModules[idx].isEL = !mod.elModules[idx].isEL;
        renderELPopup(item, mod);
      }

      // EL ëª¨ë“ˆ ìë™ ê³„ì‚° (ê³ ì •ë˜ì§€ ì•Šì€ ëª¨ë“ˆì˜ ë†’ì´ ê· ë“± ë°°ë¶„)
      function autoCalculateELModules() {
        const item = selectedItems.find((i) => i.uniqueId === currentELPopup.itemId);
        if (!item) return;
        const mod = item.modules.find((m) => m.id === currentELPopup.modId);
        if (!mod || !mod.elModules || mod.elModules.length === 0) return;

        // ì¤‘ê°„ì¥ ìœ íš¨ ë†’ì´ ê³„ì‚°
        const H = parseFloat(item.h) || 0;
        const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || 50;
        const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || 60;
        const upperDoorH = parseFloat(item.specs.fridgeUpperH) || 300;
        const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
        const middleH = parseFloat(item.specs.fridgeMiddleH) || Math.floor(moduleBodyH * 0.55);

        // ê³ ì •ëœ ëª¨ë“ˆê³¼ ê³ ì •ë˜ì§€ ì•Šì€ ëª¨ë“ˆ ë¶„ë¦¬
        const fixedModules = mod.elModules.filter((m) => m.isFixed);
        const unfixedModules = mod.elModules.filter((m) => !m.isFixed);

        // ê³ ì •ëœ ëª¨ë“ˆì´ ì‚¬ìš©í•˜ëŠ” ë†’ì´
        const fixedHeight = fixedModules.reduce((sum, m) => sum + m.h, 0);

        // ê³ ì •ë˜ì§€ ì•Šì€ ëª¨ë“ˆì— ë°°ë¶„í•  ë†’ì´
        const availableHeight = middleH - fixedHeight;

        if (unfixedModules.length > 0 && availableHeight > 0) {
          const heightPerModule = Math.floor(availableHeight / unfixedModules.length);
          unfixedModules.forEach((m) => {
            m.h = heightPerModule;
          });
        }

        renderELPopup(item, mod);
      }

      // ============================================================
      // AI ì–´ì‹œìŠ¤í„´íŠ¸ (ë¶€ê°€ ê¸°ëŠ¥)
      // ============================================================
      (function () {
        // AI ë²„íŠ¼ ë° ëª¨ë‹¬ HTML ì‚½ì…
        const aiHTML = `
    <!-- AI Floating Button -->
    <div id="ai-fab" onclick="toggleAIPanel()" title="AI ì–´ì‹œìŠ¤í„´íŠ¸">
      <span>AI</span>
      <div class="ai-pulse"></div>
    </div>

    <!-- AI Chat Panel -->
    <div id="ai-panel" class="ai-panel-hidden">
      <div class="ai-header">
        <span>ğŸ¤– ë‹¤ë‹´ AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
        <button onclick="toggleAIPanel()" class="ai-close">âœ•</button>
      </div>
      <div id="ai-messages" class="ai-messages">
        <div class="ai-msg ai-bot">ì•ˆë…•í•˜ì„¸ìš”! ê°€êµ¬ ì„¤ê³„ì— ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”.</div>
      </div>
      <div class="ai-input-area">
        <button id="ai-voice-btn" onclick="toggleVoiceInput()" class="ai-voice-btn" title="ìŒì„± ì…ë ¥">ğŸ¤</button>
        <input type="text" id="ai-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter')sendAIMessage()">
        <button onclick="sendAIMessage()" class="ai-send-btn">ì „ì†¡</button>
      </div>
    </div>
  `;

        // AI ìŠ¤íƒ€ì¼ ì‚½ì…
        const aiStyles = `
    <style>
      #ai-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
      }
      #ai-fab:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
      }
      #ai-fab span {
        color: white;
        font-weight: bold;
        font-size: 18px;
        z-index: 1;
      }
      #ai-fab .ai-pulse {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(102, 126, 234, 0.4);
        animation: ai-pulse-anim 2s infinite;
      }
      @keyframes ai-pulse-anim {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(1.5); opacity: 0; }
      }

      #ai-panel {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 360px;
        height: 480px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        z-index: 9998;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .ai-panel-hidden {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none !important;
      }
      .ai-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }
      .ai-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }
      .ai-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #f8f9fa;
      }
      .ai-msg {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
      }
      .ai-bot {
        background: white;
        align-self: flex-start;
        border: 1px solid #e9ecef;
        border-bottom-left-radius: 4px;
      }
      .ai-user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .ai-input-area {
        display: flex;
        padding: 12px;
        gap: 8px;
        border-top: 1px solid #e9ecef;
        background: white;
      }
      #ai-input {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 14px;
        outline: none;
      }
      #ai-input:focus {
        border-color: #667eea;
      }
      .ai-voice-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #dee2e6;
        background: white;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.2s;
      }
      .ai-voice-btn:hover {
        background: #f8f9fa;
      }
      .ai-voice-btn.listening {
        background: #dc3545;
        border-color: #dc3545;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      .ai-send-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
      }
      .ai-send-btn:hover {
        opacity: 0.9;
      }
      .ai-typing {
        display: flex;
        gap: 4px;
        padding: 10px 14px;
        background: white;
        border-radius: 16px;
        border: 1px solid #e9ecef;
        align-self: flex-start;
      }
      .ai-typing span {
        width: 8px;
        height: 8px;
        background: #adb5bd;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }
      .ai-typing span:nth-child(2) { animation-delay: 0.2s; }
      .ai-typing span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
      }
    </style>
  `;

        document.head.insertAdjacentHTML('beforeend', aiStyles);
        document.body.insertAdjacentHTML('beforeend', aiHTML);
      })();

      // AI íŒ¨ë„ í† ê¸€
      let aiPanelOpen = false;
      function toggleAIPanel() {
        const panel = document.getElementById('ai-panel');
        aiPanelOpen = !aiPanelOpen;
        if (aiPanelOpen) {
          panel.classList.remove('ai-panel-hidden');
        } else {
          panel.classList.add('ai-panel-hidden');
        }
      }

      // AI ì„¸ì…˜ ID
      let aiSessionId = null;

      // AI ë©”ì‹œì§€ ì „ì†¡
      async function sendAIMessage() {
        const input = document.getElementById('ai-input');
        const msg = input.value.trim();
        if (!msg) return;

        input.value = '';
        addAIMessage(msg, 'user');

        // íƒ€ì´í•‘ í‘œì‹œ
        const messagesDiv = document.getElementById('ai-messages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-typing';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: msg,
              session_id: aiSessionId,
              context: getCurrentDesignContext(),
            }),
          });

          const data = await response.json();
          typingDiv.remove();

          if (data.session_id) aiSessionId = data.session_id;
          addAIMessage(data.message || data.error || 'ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'bot');

          // TTS (ì„ íƒì )
          if (window.speechSynthesis && data.message) {
            speakAI(data.message);
          }
        } catch (err) {
          typingDiv.remove();
          addAIMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
        }
      }

      function addAIMessage(text, type) {
        const messagesDiv = document.getElementById('ai-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `ai-msg ai-${type}`;
        msgDiv.textContent = text;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // í˜„ì¬ ì„¤ê³„ ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
      function getCurrentDesignContext() {
        if (selectedItems.length === 0) return null;
        const item = selectedItems[selectedItems.length - 1];
        return {
          category: item.category,
          name: item.name,
          dimensions: { width: item.w, height: item.h, depth: item.d },
          modules: item.modules,
        };
      }

      // ìŒì„± ì¸ì‹
      let recognition = null;
      let isListening = false;

      function toggleVoiceInput() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        const btn = document.getElementById('ai-voice-btn');

        if (isListening) {
          recognition.stop();
          return;
        }

        if (!recognition) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.lang = 'ko-KR';
          recognition.continuous = false;
          recognition.interimResults = true;

          recognition.onstart = () => {
            isListening = true;
            btn.classList.add('listening');
            btn.textContent = 'ğŸ”´';
          };

          recognition.onresult = (event) => {
            const result = event.results[event.resultIndex];
            const text = result[0].transcript;
            document.getElementById('ai-input').value = text;

            if (result.isFinal) {
              setTimeout(() => sendAIMessage(), 300);
            }
          };

          recognition.onend = () => {
            isListening = false;
            btn.classList.remove('listening');
            btn.textContent = 'ğŸ¤';
          };

          recognition.onerror = () => {
            isListening = false;
            btn.classList.remove('listening');
            btn.textContent = 'ğŸ¤';
          };
        }

        recognition.start();
      }

      // TTS
      function speakAI(text) {
        const synth = window.speechSynthesis;
        synth.cancel();

        const cleanText = text
          .replace(/\*\*/g, '')
          .replace(/\*/g, '')
          .replace(/#{1,6}\s/g, '')
          .replace(/\n+/g, '. ')
          .trim();

        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.1;
        synth.speak(utterance);
      }

      // ============================================================
      // ìì¬ ì¶”ì¶œ í´ë˜ìŠ¤ (Material Extractor) V2.0
      // SKILL: material-extractor-v2.md ê¸°ë°˜
      // ============================================================
      class MaterialExtractor {
        constructor(config = {}) {
          this.PANEL_W = 1220;
          this.PANEL_H = 2440;
          this.T = config.thickness || 18; // ëª¸í†µ ë‘ê»˜ (15T ë˜ëŠ” 18T)
        }

        // ========================================
        // ë©”ì¸ ì¶”ì¶œ í•¨ìˆ˜
        // ========================================
        extract(designData) {
          const materials = [];
          const items = designData.items || [];

          console.log('[MaterialExtractor] ì¶”ì¶œ ì‹œì‘, ì•„ì´í…œ ìˆ˜:', items.length);

          items.forEach((item) => {
            // â˜… categoryId ì‚¬ìš© (categoryê°€ ì•„ë‹˜!)
            const category = item.categoryId || item.category;
            console.log('[MaterialExtractor] ì²˜ë¦¬ ì¤‘:', category, 'ëª¨ë“ˆ ìˆ˜:', (item.modules || []).length);

            switch (category) {
              case 'sink':
                this.extractSink(item, materials);
                break;
              case 'wardrobe':
                this.extractWardrobe(item, materials);
                break;
              case 'fridge':
                this.extractFridge(item, materials);
                break;
            }
          });

          console.log('[MaterialExtractor] ì¶”ì¶œ ì™„ë£Œ, ìì¬ ìˆ˜:', materials.length);

          return {
            materials,
            summary: this.calculateSummary(materials),
            extractDate: new Date().toISOString(),
          };
        }

        // ========================================
        // ìì¬ ì¶”ê°€ í—¬í¼
        // ========================================
        add(arr, module, part, material, thickness, w, h, qty, edge, note = '') {
          arr.push({
            module,
            part,
            material,
            thickness,
            w: Math.round(w),
            h: Math.round(h),
            qty,
            edge,
            note,
          });
        }

        // ========================================
        // ì‹±í¬ëŒ€ ìì¬ ì¶”ì¶œ
        // ========================================
        extractSink(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const upperD = 295; // ìƒë¶€ì¥ ê¹Šì´ (ê³ ì •)
          const lowerD = 550; // í•˜ë¶€ì¥ ê¹Šì´ (ê³ ì •)
          const isWoodChannel = (specs.handle || '').includes('ëª©ì°¬ë„¬');
          const legH = specs.sinkLegHeight || 150;

          // ===== ìƒë¶€ì¥ ëª¨ë“ˆ =====
          const upperModules = (item.modules || []).filter((m) => m.pos === 'upper' && m.type !== 'hood');
          console.log('[Sink] ìƒë¶€ì¥ ëª¨ë“ˆ:', upperModules.length);

          upperModules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || specs.upperH - 20 || 700;
            const name = mod.name || `${W}/${mod.doorCount || 1}ë„ì–´`;

            // ì¸¡íŒ 2ê°œ (ì‚¬ì¿ ë¦¬í™ˆ)
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ì¸¡íŒ', 'PB', T, upperD, H, 2, '4ë©´', 'ì‚¬ì¿ ë¦¬(17mmì—ì„œ 3mmí™ˆ)');
            // ì§€íŒ (ì‚¬ì¿ ë¦¬ ë°˜ì˜ D-20)
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ì§€íŒ', 'PB', T, W - T * 2, upperD - 20, 1, '1ë©´(ì „)');
            // ì²œíŒ
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ì²œíŒ', 'PB', T, W - T * 2, upperD - 20, 1, '1ë©´(ì „)');
            // ë’·íŒ (ì‚¬ì¿ ë¦¬í™ˆì— ë¼ì›€)
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ë’·íŒ', 'MDF', 2.7, W - 20, H - 1, 1, '-');
            // ë°´ë“œ(ë³´ê°•ëª©) 2ê°œ
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ë°´ë“œ(ë³´ê°•ëª©)', 'PB', T, W - T * 2, 60, 2, '2ë©´(ì¥)');
            // ë°´ë“œ(ì²˜ì§ë°©ì§€ëª©) - W>=700ì´ë©´ 2ê°œ
            const bandQty = W >= 700 ? 2 : 1;
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ë°´ë“œ(ì²˜ì§ë°©ì§€)', 'PB', T, 70, H - T * 2, bandQty, '2ë©´(ì¥)');
            // ì„ ë°˜ 2ê°œ
            this.add(materials, `ìƒë¶€ì¥-${name}`, 'ì„ ë°˜', 'PB', T, W - T * 2, upperD - 35, 2, '1ë©´(ì „)');
            // ë„ì–´ (H + 20)
            const doorCount = mod.doorCount || 1;
            if (doorCount > 0) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `ìƒë¶€ì¥-${name}`, 'ë„ì–´', 'MDF', 18, doorW, H + 20, doorCount, '4ë©´');
            }
          });

          // ===== í•˜ë¶€ì¥ ëª¨ë“ˆ =====
          const lowerModules = (item.modules || []).filter((m) => m.pos === 'lower' && m.type !== 'cook');
          console.log('[Sink] í•˜ë¶€ì¥ ëª¨ë“ˆ:', lowerModules.length);

          lowerModules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || (specs.lowerH || 870) - legH;
            const name = mod.name || `${W}/${mod.doorCount || 1}ë„ì–´`;
            const isDrawer = mod.isDrawer || false;
            const isEL = mod.isEL || false;
            const isOpen = mod.isOpen || false;

            // ì¸¡íŒ 2ê°œ
            this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ì¸¡íŒ', 'PB', T, lowerD, H, 2, '4ë©´');
            // ì§€íŒ
            this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ì§€íŒ', 'PB', T, W - T * 2, lowerD, 1, '1ë©´(ì „)');
            // ë°´ë“œ 2ê°œ
            this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ë°´ë“œ', 'PB', T, 60, W - T * 2, 2, '2ë©´(ì¥)');
            // ë’·íŒ
            this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ë’·íŒ', 'MDF', 2.7, W - 1, H - 1, 1, '-');
            // ë°´ë“œ(ì²˜ì§ë°©ì§€ëª©) - ëª©ì°¬ë„¬ì´ë©´ -70, W>=800ì´ë©´ 2ê°œ
            const bandH = isWoodChannel ? H - T * 2 - 70 : H - T * 2;
            const bandQty = W >= 800 ? 2 : 1;
            this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ë°´ë“œ(ì²˜ì§ë°©ì§€)', 'PB', T, 70, bandH, bandQty, '2ë©´(ì¥)');
            // ì„ ë°˜ (ì„œë/EL/ì˜¤í”ˆì¥ ì—†ìœ¼ë©´ 1ê°œ)
            if (!isDrawer && !isEL && !isOpen && mod.type !== 'sink') {
              this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ì„ ë°˜', 'PB', T, W - T * 2, lowerD - 15, 1, '1ë©´(ì „)');
            }
            // ë„ì–´ (H - 30)
            const doorCount = mod.doorCount || 0;
            if (doorCount > 0 && !isDrawer) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `í•˜ë¶€ì¥-${name}`, 'ë„ì–´', 'MDF', 18, doorW, H - 30, doorCount, '4ë©´');
            }
          });

          // ===== EP (ë§ˆê°ì¬) =====
          const totalLowerW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
          const effectiveW = totalLowerW || item.w - 120;

          // ê±¸ë ˆë°›ì´
          this.add(materials, 'EP', 'ê±¸ë ˆë°›ì´', 'MDF', 18, effectiveW, legH - 5, 1, '2ë©´(ì¥)');

          // ëª©ì°¬ë„¬
          if (isWoodChannel) {
            this.add(materials, 'EP', 'ëª©ì°¬ë„¬(ì „ë©´)', 'MDF', 18, 52, effectiveW, 1, '-');
            this.add(materials, 'EP', 'ëª©ì°¬ë„¬(ì§€ë©´)', 'MDF', 18, 40, effectiveW, 1, '-');
          }

          // íœ ë¼ (ì¢Œ/ìš°)
          const lowerH = (specs.lowerH || 870) - legH;
          if (specs.finishLeftType === 'Filler' && specs.finishLeftWidth > 0) {
            this.add(materials, 'EP', 'íœ ë¼(ì¢Œ)', 'MDF', 18, specs.finishLeftWidth, lowerH, 1, '2ë©´(ì¥)');
          }
          if (specs.finishRightType === 'Filler' && specs.finishRightWidth > 0) {
            this.add(materials, 'EP', 'íœ ë¼(ìš°)', 'MDF', 18, specs.finishRightWidth, lowerH, 1, '2ë©´(ì¥)');
          }
        }

        // ========================================
        // ë¶™ë°•ì´ì¥ ìì¬ ì¶”ì¶œ
        // ========================================
        extractWardrobe(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const D = parseFloat(item.d) || 650;
          const pedestalH = parseFloat(specs.wardrobePedestal) || 60;
          const moldingH = parseFloat(specs.wardrobeMoldingH) || 15;
          const totalH = parseFloat(item.h) || 2300;
          const bodyH = totalH - pedestalH - moldingH;

          console.log('[Wardrobe] ===== ë¶™ë°•ì´ì¥ ìì¬ ì¶”ì¶œ ì‹œì‘ =====');
          console.log('[Wardrobe] item.modules:', item.modules);

          // â˜… ëª¨ë“  ëª¨ë“ˆ ì²˜ë¦¬ (í•„í„° ì—†ì´)
          const modules = item.modules || [];

          console.log('[Wardrobe] ëª¨ë“ˆ ìˆ˜:', modules.length);

          if (modules.length === 0) {
            console.warn('[Wardrobe] âš ï¸ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤!');
            return;
          }

          let totalW = 0;

          modules.forEach((mod, idx) => {
            const W = parseFloat(mod.w) || 900;
            totalW += W;

            // â˜… moduleTypeì´ ì‹¤ì œ ëª¨ë“ˆ ì¢…ë¥˜ (short/long/shelf)
            const modType = mod.moduleType || mod.type || 'long';
            const name = mod.name || `${idx + 1}ë²ˆ`;

            console.log(`[Wardrobe] ëª¨ë“ˆ ${idx + 1} ì²˜ë¦¬: ${name}, W=${W}, type=${modType}`);

            // ì¸¡íŒ 2ê°œ
            this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ì¸¡íŒ', 'PB', T, D, bodyH, 2, '4ë©´');
            // ì²œíŒ
            this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ì²œíŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
            // ì§€íŒ
            this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ì§€íŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
            // ë’·íŒ
            this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ë’·íŒ', 'MDF', 2.7, W - 1, bodyH - 1, 1, '-');

            // ì¤‘ê°„ì¹¸ë§‰ì´ (ì§§ì€ì˜·2ë‹¨ë§Œ)
            if (modType === 'short') {
              this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ì¤‘ê°„ì¹¸ë§‰ì´', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
            }

            // ì„ ë°˜ (ì„ ë°˜í˜•=4ê°œ, ê·¸ì™¸=1ê°œ)
            const shelfCount = modType === 'shelf' ? 4 : mod.shelfCount || 1;
            this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ì„ ë°˜', 'PB', T, W - T * 2, D - 15, shelfCount, '1ë©´(ì „)');

            // ë„ì–´ (H + 20)
            const doorCount = mod.doorCount || 1;
            if (doorCount > 0) {
              const doorW = Math.floor((W - 4) / doorCount);
              this.add(materials, `ë¶™ë°•ì´ì¥-${name}`, 'ë„ì–´', 'MDF', 18, doorW, bodyH + 20, doorCount, '4ë©´');
            }
          });

          console.log('[Wardrobe] ëª¨ë“ˆ í•©ê³„ ë„ˆë¹„:', totalW);

          // EP (ìƒëª°ë”©, ì¢ŒëŒ€)
          if (moldingH > 0 && totalW > 0) {
            this.add(materials, 'EP', 'ìƒëª°ë”©', 'MDF', 18, totalW, moldingH, 1, '2ë©´(ì¥)');
          }
          if (pedestalH > 0 && totalW > 0) {
            this.add(materials, 'EP', 'ì¢ŒëŒ€', 'PB', T, totalW, pedestalH, 1, '1ë©´(ì „)');
          }

          console.log('[Wardrobe] ===== ì¶”ì¶œ ì™„ë£Œ, ìì¬ ìˆ˜:', materials.length, '=====');
        }

        // ========================================
        // ëƒ‰ì¥ê³ ì¥ ìì¬ ì¶”ì¶œ
        // ========================================
        extractFridge(item, materials) {
          const specs = item.specs || {};
          const T = this.T;
          const modules = item.modules || [];

          console.log('[Fridge] ëª¨ë“ˆ:', modules.length);

          if (modules.length === 0) return;

          modules.forEach((mod, idx) => {
            const modType = mod.type || '';
            if (modType === 'fridge') return; // ëƒ‰ì¥ê³  ìì²´ëŠ” ì œì™¸

            const W = parseFloat(mod.w) || 600;
            const H = parseFloat(mod.h) || 2000;
            const D = parseFloat(mod.d) || specs.fridgeModuleD || 550;
            const name = mod.name || modType;

            console.log(`[Fridge] ëª¨ë“ˆ: ${modType}, W=${W}, H=${H}, D=${D}`);

            // í‚¤í°ì¥ (tall)
            if (modType === 'tall') {
              this.add(materials, 'í‚¤í°ì¥', 'ì¸¡íŒ', 'PB', T, D, H, 2, '4ë©´');
              this.add(materials, 'í‚¤í°ì¥', 'ì²œíŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'í‚¤í°ì¥', 'ì§€íŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'í‚¤í°ì¥', 'ë’·íŒ', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              this.add(materials, 'í‚¤í°ì¥', 'ì„ ë°˜', 'PB', T, W - T * 2, D - 15, 3, '1ë©´(ì „)');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'í‚¤í°ì¥', 'ë„ì–´', 'MDF', 18, doorW, H + 20, doorCount, '4ë©´');
              }
            }
            // í™ˆì¹´í˜ì¥ (homecafe) - ì˜¤í”ˆì¥ ê·œì¹™: MDF 18T
            else if (modType === 'homecafe') {
              this.add(materials, 'í™ˆì¹´í˜ì¥', 'ì¸¡íŒ', 'MDF', 18, D + 20, H, 2, '4ë©´');
              this.add(materials, 'í™ˆì¹´í˜ì¥', 'ì²œíŒ', 'MDF', 18, W - 36, D, 1, '2ë©´(ê°€ë¡œ)');
              this.add(materials, 'í™ˆì¹´í˜ì¥', 'ì§€íŒ', 'MDF', 18, W - 36, D, 1, '2ë©´(ê°€ë¡œ)');
              this.add(materials, 'í™ˆì¹´í˜ì¥', 'ë’·íŒ', 'MDF', 18, W - 36, H, 1, '2ë©´(ê°€ë¡œ)'); // 18T!
              this.add(materials, 'í™ˆì¹´í˜ì¥', 'ì„ ë°˜', 'MDF', 18, W - 36, D - 15, 2, '1ë©´(ì „)');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'í™ˆì¹´í˜ì¥', 'ë„ì–´', 'MDF', 18, doorW, H + 20, doorCount, '4ë©´');
              }
            }
            // ìƒë¶€ì¥ (upper)
            else if (modType === 'upper') {
              this.add(materials, 'ëƒ‰ì¥ê³ ìƒë¶€ì¥', 'ì¸¡íŒ', 'PB', T, D, H, 2, '4ë©´');
              this.add(materials, 'ëƒ‰ì¥ê³ ìƒë¶€ì¥', 'ì²œíŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ëƒ‰ì¥ê³ ìƒë¶€ì¥', 'ì§€íŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ëƒ‰ì¥ê³ ìƒë¶€ì¥', 'ë’·íŒ', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              this.add(materials, 'ëƒ‰ì¥ê³ ìƒë¶€ì¥', 'ë„ì–´', 'MDF', 18, W - 4, H + 20, 1, '4ë©´');
            }
            // í•˜ë¶€ì¥ (lower)
            else if (modType === 'lower') {
              this.add(materials, 'ëƒ‰ì¥ê³ í•˜ë¶€ì¥', 'ì¸¡íŒ', 'PB', T, D, H, 2, '4ë©´');
              this.add(materials, 'ëƒ‰ì¥ê³ í•˜ë¶€ì¥', 'ì²œíŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ëƒ‰ì¥ê³ í•˜ë¶€ì¥', 'ì§€íŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ëƒ‰ì¥ê³ í•˜ë¶€ì¥', 'ë’·íŒ', 'MDF', 2.7, W - 1, H - 1, 1, '-');
              const doorCount = mod.doorCount || 1;
              if (doorCount > 0) {
                const doorW = Math.floor((W - 4) / doorCount);
                this.add(materials, 'ëƒ‰ì¥ê³ í•˜ë¶€ì¥', 'ë„ì–´', 'MDF', 18, doorW, H - 30, doorCount, '4ë©´');
              }
            }
            // ELì¥ (el)
            else if (modType === 'el') {
              this.add(materials, 'ELì¥', 'ì¸¡íŒ', 'PB', T, D, H, 2, '4ë©´');
              this.add(materials, 'ELì¥', 'ì²œíŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ELì¥', 'ì§€íŒ', 'PB', T, W - T * 2, D, 1, '1ë©´(ì „)');
              this.add(materials, 'ELì¥', 'ë’·íŒ', 'MDF', 2.7, W - 1, H - 1, 1, '-');
            }
          });
        }

        // ========================================
        // ìš”ì•½ ê³„ì‚°
        // ========================================
        calculateSummary(materials) {
          const summary = {};
          materials.forEach((m) => {
            const key = `${m.material}_${m.thickness}`;
            if (!summary[key]) {
              summary[key] = { material: m.material, thickness: m.thickness, totalArea: 0, panelCount: 0 };
            }
            summary[key].totalArea += m.w * m.h * m.qty;
          });

          const panelArea = this.PANEL_W * this.PANEL_H;
          Object.values(summary).forEach((s) => {
            s.panelCount = Math.ceil(s.totalArea / panelArea);
          });

          return summary;
        }

        // ========================================
        // CSV ì¶œë ¥
        // ========================================
        toCSV(materials) {
          let csv = 'ëª¨ë“ˆ,ë¶€í’ˆ,ìì¬,ë‘ê»˜,ê°€ë¡œ,ì„¸ë¡œ,ìˆ˜ëŸ‰,ì—£ì§€,ë¹„ê³ \n';
          materials.forEach((m) => {
            csv += `${m.module},${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${m.edge},${m.note || ''}\n`;
          });
          return csv;
        }

        // ========================================
        // CNC ì¶œë ¥
        // ========================================
        toCNC(materials) {
          let csv = 'í’ˆëª©,ìì¬,ë‘ê»˜,ê°€ë¡œ,ì„¸ë¡œ,ìˆ˜ëŸ‰,ì—£ì§€L,ì—£ì§€R,ì—£ì§€T,ì—£ì§€B\n';
          materials.forEach((m) => {
            let el = 0,
              er = 0,
              et = 0,
              eb = 0;
            if (m.edge === '4ë©´') {
              el = er = et = eb = 1;
            } else if (m.edge.includes('2ë©´')) {
              if (m.w > m.h) {
                el = er = 1;
              } else {
                et = eb = 1;
              }
            } else if (m.edge.includes('1ë©´')) {
              el = 1;
            }
            csv += `${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${el},${er},${et},${eb}\n`;
          });
          return csv;
        }
      }

      // ============================================================
      // ë¶€ìì¬ ì¶”ì¶œ í´ë˜ìŠ¤ (Hardware Extractor) v1.0
      // ============================================================
      class HardwareExtractor {
        constructor() {
          this.hingeRules = { 900: 2, 1600: 3, 9999: 4 }; // ë†’ì´ë³„ ê²½ì²© ìˆ˜
        }

        extract(designData) {
          const hardware = [];
          const items = designData.items || [];

          items.forEach((item) => {
            this.extractHinges(item, hardware);
            this.extractRails(item, hardware);
            this.extractHandles(item, hardware);
            this.extractLegs(item, hardware);
            this.extractBrackets(item, hardware);
            this.extractOthers(item, hardware);
          });

          return {
            hardware,
            summary: this.calculateSummary(hardware),
            extractDate: new Date().toISOString(),
          };
        }

        // ê²½ì²© ìˆ˜ ê³„ì‚°
        getHingeCount(doorH) {
          if (doorH <= 900) return 2;
          if (doorH <= 1600) return 3;
          return 4;
        }

        // ë³´ë§ ìœ„ì¹˜ ê³„ì‚°
        getBoringPositions(doorH) {
          const count = this.getHingeCount(doorH);
          if (count === 2) return [110, doorH - 110];
          if (count === 3) return [110, Math.round(doorH / 2), doorH - 110];
          return [110, Math.round(doorH / 3), Math.round((doorH * 2) / 3), doorH - 110];
        }

        // ê²½ì²© ì¶”ì¶œ
        extractHinges(item, hardware) {
          const specs = item.specs || {};
          (item.modules || []).forEach((mod) => {
            const doorCount = mod.doorCount || 0;
            if (doorCount === 0) return;

            let doorH;
            if (mod.pos === 'upper') doorH = (mod.h || specs.upperH - 20) + 20;
            else if (mod.pos === 'lower') doorH = (mod.h || specs.lowerH - specs.sinkLegHeight) - 30;
            else doorH = mod.h || 700;

            const hingesPerDoor = this.getHingeCount(doorH);
            const boring = this.getBoringPositions(doorH);

            hardware.push({
              category: 'ê²½ì²©',
              item: 'ì»¨ì‹¤ë“œ ê²½ì²© 110Â°',
              manufacturer: 'ë¸”ë£¸',
              spec: `${hingesPerDoor}êµ¬`,
              qty: hingesPerDoor * doorCount,
              unit: 'EA',
              note: `${mod.name || mod.type} (ë³´ë§: ${boring.join(', ')})`,
            });
          });
        }

        // ë ˆì¼ ì¶”ì¶œ
        extractRails(item, hardware) {
          (item.modules || []).forEach((mod) => {
            if (!mod.isDrawer) return;
            const depth = mod.d || 550;
            let railLength = 500;
            if (depth <= 350) railLength = 350;
            else if (depth <= 450) railLength = 450;

            hardware.push({
              category: 'ë ˆì¼',
              item: 'ì†Œí”„íŠ¸í´ë¡œì¦ˆ ì„œëë ˆì¼',
              manufacturer: 'ë¸”ë£¸',
              spec: `${railLength}mm`,
              qty: 1,
              unit: 'SET',
              note: mod.name || mod.type,
            });
          });
        }

        // ì†ì¡ì´ ì¶”ì¶œ
        extractHandles(item, hardware) {
          const specs = item.specs || {};
          const handleType = specs.handle || 'ì°¬ë„¬';
          let totalDoors = 0;

          (item.modules || []).forEach((mod) => {
            totalDoors += mod.doorCount || 0;
          });

          if (totalDoors > 0) {
            hardware.push({
              category: 'ì†ì¡ì´',
              item: handleType.includes('ìŠ¤ë§ˆíŠ¸ë°”')
                ? 'ìŠ¤ë§ˆíŠ¸ë°”'
                : handleType.includes('ëª©ì°¬ë„¬')
                  ? 'ëª©ì°¬ë„¬'
                  : handleType,
              manufacturer: '-',
              spec: '-',
              qty: handleType.includes('ìŠ¤ë§ˆíŠ¸ë°”') ? (item.modules || []).length : totalDoors,
              unit: 'EA',
              note: item.category,
            });
          }
        }

        // ë‹¤ë¦¬ë°œ ì¶”ì¶œ
        extractLegs(item, hardware) {
          const category = item.categoryId || item.category;
          if (category !== 'sink') return;
          const specs = item.specs || {};
          const legH = specs.sinkLegHeight || 150;
          let totalLegs = 0;

          (item.modules || [])
            .filter((m) => m.pos === 'lower')
            .forEach((mod) => {
              const w = mod.w || 600;
              if (w <= 600) totalLegs += 4;
              else if (w <= 900) totalLegs += 6;
              else totalLegs += 8;
            });

          if (totalLegs > 0) {
            hardware.push({
              category: 'ë‹¤ë¦¬ë°œ',
              item: 'ì¡°ì ˆ ë‹¤ë¦¬ë°œ',
              manufacturer: '-',
              spec: `${legH}mm`,
              qty: totalLegs,
              unit: 'EA',
              note: 'í•˜ë¶€ì¥',
            });
          }
        }

        // ì„ ë°˜ ë¸Œë¼ì¼“ ì¶”ì¶œ
        extractBrackets(item, hardware) {
          let shelfCount = 0;
          (item.modules || []).forEach((mod) => {
            if (mod.pos === 'upper' && mod.type !== 'hood') shelfCount += 2;
            else if (mod.pos === 'lower' && !mod.isDrawer && mod.type !== 'sink' && mod.type !== 'cook')
              shelfCount += 1;
          });

          if (shelfCount > 0) {
            hardware.push({
              category: 'ë¸Œë¼ì¼“',
              item: 'ì„ ë°˜ ë¸Œë¼ì¼“ (í•€íƒ€ì…)',
              manufacturer: '-',
              spec: 'Î¦5mm',
              qty: shelfCount * 4,
              unit: 'EA',
              note: `ì„ ë°˜ ${shelfCount}ê°œ Ã— 4`,
            });
          }
        }

        // ê¸°íƒ€ ë¶€ìì¬
        extractOthers(item, hardware) {
          let totalDoors = 0;
          (item.modules || []).forEach((mod) => {
            totalDoors += mod.doorCount || 0;
          });

          if (totalDoors > 0) {
            hardware.push({
              category: 'ê¸°íƒ€',
              item: 'ë„ì–´ ëŒí¼',
              manufacturer: '-',
              spec: '-',
              qty: totalDoors * 2,
              unit: 'EA',
              note: `ë„ì–´ ${totalDoors}ê°œ Ã— 2`,
            });
          }
        }

        // ìš”ì•½
        calculateSummary(hardware) {
          const summary = {};
          hardware.forEach((h) => {
            if (!summary[h.category]) summary[h.category] = 0;
            summary[h.category] += h.qty;
          });
          return summary;
        }

        // CSV ìƒì„±
        toCSV(hardware) {
          let csv = 'ë¶„ë¥˜,í’ˆëª©,ì œì¡°ì‚¬,ìŠ¤í™,ìˆ˜ëŸ‰,ë‹¨ìœ„,ë¹„ê³ \n';
          hardware.forEach((h) => {
            csv += `${h.category},${h.item},${h.manufacturer},${h.spec},${h.qty},${h.unit},${h.note}\n`;
          });
          return csv;
        }
      }

      // ============================================================
      // ë„ë©´ ì‹œê°í™” í´ë˜ìŠ¤ (Drawing Visualizer) v1.0
      // ============================================================
      class DrawingVisualizer {
        constructor() {
          this.PANEL_W = 1220;
          this.PANEL_H = 2440;
          this.KERF = 4;
        }

        // ì¬ë‹¨ ë„ë©´ ìƒì„±
        generateCuttingLayout(materials, mode = 'material') {
          const groups = this.groupByMaterial(materials);
          const panels = {};

          Object.keys(groups).forEach((key) => {
            panels[key] = this.packParts(groups[key], mode);
          });

          return panels;
        }

        // ìì¬ë³„ ê·¸ë£¹í™”
        groupByMaterial(materials) {
          const groups = {};
          materials.forEach((m) => {
            const key = `${m.material}_${m.thickness}T`;
            if (!groups[key]) groups[key] = [];
            for (let i = 0; i < m.qty; i++) {
              groups[key].push({ ...m, qty: 1 });
            }
          });
          return groups;
        }

        // Bin Packing
        packParts(parts, mode) {
          const sorted = [...parts].sort((a, b) => b.w * b.h - a.w * a.h);
          const panels = [];
          let panelId = 1;

          sorted.forEach((part) => {
            let placed = false;
            for (const panel of panels) {
              if (this.tryPlace(panel, part)) {
                placed = true;
                break;
              }
            }
            if (!placed) {
              const newPanel = this.createPanel(panelId++);
              this.tryPlace(newPanel, part);
              panels.push(newPanel);
            }
          });

          return panels;
        }

        createPanel(id) {
          return {
            id,
            w: this.PANEL_W,
            h: this.PANEL_H,
            parts: [],
            freeRects: [{ x: 0, y: 0, w: this.PANEL_W, h: this.PANEL_H }],
          };
        }

        tryPlace(panel, part) {
          const orientations = [
            { w: part.w, h: part.h, rotated: false },
            { w: part.h, h: part.w, rotated: true },
          ];

          for (const orient of orientations) {
            for (let i = 0; i < panel.freeRects.length; i++) {
              const rect = panel.freeRects[i];
              if (orient.w + this.KERF <= rect.w && orient.h + this.KERF <= rect.h) {
                const placed = {
                  ...part,
                  x: rect.x,
                  y: rect.y,
                  w: orient.w,
                  h: orient.h,
                  rotated: orient.rotated,
                };
                panel.parts.push(placed);
                this.splitRect(panel, rect, orient.w, orient.h);
                return true;
              }
            }
          }
          return false;
        }

        splitRect(panel, rect, usedW, usedH) {
          const idx = panel.freeRects.indexOf(rect);
          panel.freeRects.splice(idx, 1);

          const rightW = rect.w - usedW - this.KERF;
          if (rightW > 100) {
            panel.freeRects.push({ x: rect.x + usedW + this.KERF, y: rect.y, w: rightW, h: rect.h });
          }

          const bottomH = rect.h - usedH - this.KERF;
          if (bottomH > 100) {
            panel.freeRects.push({ x: rect.x, y: rect.y + usedH + this.KERF, w: usedW, h: bottomH });
          }

          panel.freeRects.sort((a, b) => b.w * b.h - a.w * a.h);
        }

        getEfficiency(panel) {
          const used = panel.parts.reduce((sum, p) => sum + p.w * p.h, 0);
          return ((used / (panel.w * panel.h)) * 100).toFixed(1);
        }

        // SVG ìƒì„±
        generateSVG(panel, matKey, scale = 0.25) {
          const svgW = Math.round(this.PANEL_W * scale);
          const svgH = Math.round(this.PANEL_H * scale);
          const eff = this.getEfficiency(panel);

          let svg = `<svg width="${svgW + 40}" height="${svgH + 60}" viewBox="0 0 ${svgW + 40} ${svgH + 60}" xmlns="http://www.w3.org/2000/svg">
      <style>
        .panel { fill: #f5f5f5; stroke: #333; stroke-width: 2; }
        .part { fill: #e3f2fd; stroke: #1976d2; stroke-width: 1; }
        .door { fill: #fff3e0; stroke: #f57c00; stroke-width: 1; }
        .back { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 1; }
        .label { font-family: Arial; font-size: 9px; fill: #333; }
        .dim { font-family: Arial; font-size: 7px; fill: #666; }
        .title { font-family: Arial; font-size: 11px; font-weight: bold; fill: #333; }
      </style>
      <text x="20" y="18" class="title">íŒ¨ë„ #${panel.id} (${matKey}) - íš¨ìœ¨: ${eff}%</text>
      <rect x="20" y="30" width="${svgW}" height="${svgH}" class="panel"/>`;

          panel.parts.forEach((part) => {
            const x = Math.round(part.x * scale) + 20;
            const y = Math.round(part.y * scale) + 30;
            const w = Math.round(part.w * scale);
            const h = Math.round(part.h * scale);
            const cls = part.part.includes('ë„ì–´') ? 'door' : part.part.includes('ë’·íŒ') ? 'back' : 'part';

            svg += `<rect x="${x}" y="${y}" width="${w}" height="${h}" class="${cls}"/>`;
            svg += `<text x="${x + w / 2}" y="${y + h / 2 - 4}" class="label" text-anchor="middle">${part.part}</text>`;
            svg += `<text x="${x + w / 2}" y="${y + h / 2 + 8}" class="dim" text-anchor="middle">${part.w}Ã—${part.h}</text>`;
            if (part.rotated) svg += `<text x="${x + 3}" y="${y + 12}" class="dim">â†»</text>`;
          });

          svg += `</svg>`;
          return svg;
        }

        // HTML ë¦¬í¬íŠ¸ ìƒì„±
        generateReport(panelGroups) {
          let html = `<div style="font-family:Arial;padding:20px;">
      <h2 style="color:#1976d2;">ğŸªµ ì¬ë‹¨ ë„ë©´</h2>
      <p>ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}</p>`;

          let totalPanels = 0;
          Object.keys(panelGroups).forEach((key) => {
            const panels = panelGroups[key];
            totalPanels += panels.length;
            html += `<h3>${key}: ${panels.length}ì¥</h3>`;
            panels.forEach((panel) => {
              html += `<div style="margin:10px 0;border:1px solid #ddd;padding:10px;border-radius:8px;">`;
              html += this.generateSVG(panel, key);
              html += `<p style="font-size:12px;color:#666;">ë¶€í’ˆ ${panel.parts.length}ê°œ</p></div>`;
            });
          });

          html += `<h3>ì´ íŒ¨ë„: ${totalPanels}ì¥</h3></div>`;
          return html;
        }
      }

      // ============================================================
      // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      // ============================================================
      const materialExtractor = new MaterialExtractor();
      const hardwareExtractor = new HardwareExtractor();
      const drawingVisualizer = new DrawingVisualizer();

      // DadamAgentì— ì¶”ì¶œ ê¸°ëŠ¥ ì¶”ê°€
      window.DadamAgent.extractMaterials = function () {
        const design = window.DadamAgent.exportDesign();
        return materialExtractor.extract(design);
      };

      window.DadamAgent.extractHardware = function () {
        const design = window.DadamAgent.exportDesign();
        return hardwareExtractor.extract(design);
      };

      window.DadamAgent.generateDrawings = function (mode = 'material') {
        const design = window.DadamAgent.exportDesign();
        const matResult = materialExtractor.extract(design);
        return drawingVisualizer.generateCuttingLayout(matResult.materials, mode);
      };

      // ============================================================
      // UI í•¨ìˆ˜: ëª¨ë‹¬ í‘œì‹œ
      // ============================================================
      function showExtractorModal(title, content) {
        const existingModal = document.getElementById('extractorModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'extractorModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:900px;max-height:85vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="background:#1976d2;color:white;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:18px;">${title}</h3>
          <button onclick="document.getElementById('extractorModal').remove()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px;overflow-y:auto;max-height:calc(85vh - 120px);">
          ${content}
        </div>
        <div style="padding:12px 20px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;">
          <button onclick="downloadExtractorData()" style="background:#4caf50;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
          <button onclick="document.getElementById('extractorModal').remove()" style="background:#eee;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // ìì¬ ì¶”ì¶œ UI
      function showMaterialExtractor() {
        const result = window.DadamAgent.extractMaterials();
        if (!result.materials.length) {
          alert('ì¶”ì¶œí•  ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
          return;
        }

        let tableHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead style="background:#e3f2fd;">
      <tr>
        <th style="border:1px solid #ddd;padding:8px;">No</th>
        <th style="border:1px solid #ddd;padding:8px;">ëª¨ë“ˆ</th>
        <th style="border:1px solid #ddd;padding:8px;">ë¶€í’ˆ</th>
        <th style="border:1px solid #ddd;padding:8px;">ìì¬</th>
        <th style="border:1px solid #ddd;padding:8px;">ë‘ê»˜</th>
        <th style="border:1px solid #ddd;padding:8px;">ê°€ë¡œ</th>
        <th style="border:1px solid #ddd;padding:8px;">ì„¸ë¡œ</th>
        <th style="border:1px solid #ddd;padding:8px;">ìˆ˜ëŸ‰</th>
        <th style="border:1px solid #ddd;padding:8px;">ì—£ì§€</th>
      </tr>
    </thead><tbody>`;

        result.materials.forEach((m, i) => {
          tableHTML += `<tr>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${i + 1}</td>
      <td style="border:1px solid #ddd;padding:6px;">${m.module}</td>
      <td style="border:1px solid #ddd;padding:6px;">${m.part}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.material}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.thickness}T</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.w}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.h}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.qty}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.edge}</td>
    </tr>`;
        });
        tableHTML += `</tbody></table>`;

        // ìš”ì•½
        let summaryHTML = `<div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
    <h4 style="margin:0 0 10px 0;">ğŸ“Š ìì¬ ìš”ì•½</h4><table style="width:100%;font-size:13px;">
    <tr style="background:#e8f5e9;"><th style="padding:8px;text-align:left;">ìì¬</th><th>ì´ë©´ì </th><th>íŒ¨ë„ ìˆ˜</th></tr>`;
        Object.values(result.summary).forEach((s) => {
          summaryHTML += `<tr><td style="padding:6px;">${s.material} ${s.thickness}T</td>
      <td style="text-align:right;">${(s.totalArea / 1000000).toFixed(2)} ã¡</td>
      <td style="text-align:center;font-weight:bold;">${s.panelCount}ì¥</td></tr>`;
        });
        summaryHTML += `</table></div>`;

        window._extractorData = {
          type: 'material',
          csv: materialExtractor.toCSV(result.materials),
          cnc: materialExtractor.toCNC(result.materials),
        };
        showExtractorModal('ğŸ“¦ ìì¬ ì¶”ì¶œ ê²°ê³¼', tableHTML + summaryHTML);
      }

      // ë¶€ìì¬ ì¶”ì¶œ UI
      function showHardwareExtractor() {
        const result = window.DadamAgent.extractHardware();
        if (!result.hardware.length) {
          alert('ì¶”ì¶œí•  ë¶€ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
          return;
        }

        let tableHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead style="background:#e8f5e9;">
      <tr>
        <th style="border:1px solid #ddd;padding:8px;">No</th>
        <th style="border:1px solid #ddd;padding:8px;">ë¶„ë¥˜</th>
        <th style="border:1px solid #ddd;padding:8px;">í’ˆëª©</th>
        <th style="border:1px solid #ddd;padding:8px;">ì œì¡°ì‚¬</th>
        <th style="border:1px solid #ddd;padding:8px;">ìŠ¤í™</th>
        <th style="border:1px solid #ddd;padding:8px;">ìˆ˜ëŸ‰</th>
        <th style="border:1px solid #ddd;padding:8px;">ë‹¨ìœ„</th>
        <th style="border:1px solid #ddd;padding:8px;">ë¹„ê³ </th>
      </tr>
    </thead><tbody>`;

        result.hardware.forEach((h, i) => {
          tableHTML += `<tr>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${i + 1}</td>
      <td style="border:1px solid #ddd;padding:6px;">${h.category}</td>
      <td style="border:1px solid #ddd;padding:6px;">${h.item}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.manufacturer}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.spec}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;font-weight:bold;">${h.qty}</td>
      <td style="border:1px solid #ddd;padding:6px;text-align:center;">${h.unit}</td>
      <td style="border:1px solid #ddd;padding:6px;font-size:11px;">${h.note}</td>
    </tr>`;
        });
        tableHTML += `</tbody></table>`;

        // ìš”ì•½
        let summaryHTML = `<div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
    <h4 style="margin:0 0 10px 0;">ğŸ”© ë¶€ìì¬ ìš”ì•½</h4><div style="display:flex;gap:15px;flex-wrap:wrap;">`;
        Object.entries(result.summary).forEach(([cat, qty]) => {
          summaryHTML += `<div style="background:white;padding:10px 15px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
      <div style="font-size:11px;color:#666;">${cat}</div>
      <div style="font-size:18px;font-weight:bold;color:#1976d2;">${qty}</div></div>`;
        });
        summaryHTML += `</div></div>`;

        window._extractorData = { type: 'hardware', csv: hardwareExtractor.toCSV(result.hardware) };
        showExtractorModal('ğŸ”© ë¶€ìì¬ ì¶”ì¶œ ê²°ê³¼', tableHTML + summaryHTML);
      }

      // ì¬ë‹¨ ë„ë©´ UI
      function showDrawingVisualizer() {
        const result = window.DadamAgent.extractMaterials();
        if (!result.materials.length) {
          alert('ìƒì„±í•  ë„ë©´ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
          return;
        }

        const panels = drawingVisualizer.generateCuttingLayout(result.materials);
        const reportHTML = drawingVisualizer.generateReport(panels);

        window._extractorData = { type: 'drawing', panels };
        showExtractorModal('ğŸªµ ì¬ë‹¨ ë„ë©´', reportHTML);
      }

      // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
      function downloadExtractorData() {
        if (!window._extractorData) return;

        const data = window._extractorData;
        let blob, filename;

        if (data.type === 'material') {
          blob = new Blob(['\uFEFF' + data.csv], { type: 'text/csv;charset=utf-8;' });
          filename = `ìì¬ëª©ë¡_${new Date().toISOString().slice(0, 10)}.csv`;
        } else if (data.type === 'hardware') {
          blob = new Blob(['\uFEFF' + data.csv], { type: 'text/csv;charset=utf-8;' });
          filename = `ë¶€ìì¬ëª©ë¡_${new Date().toISOString().slice(0, 10)}.csv`;
        } else if (data.type === 'drawing') {
          const html = drawingVisualizer.generateReport(data.panels);
          blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
          filename = `ì¬ë‹¨ë„ë©´_${new Date().toISOString().slice(0, 10)}.html`;
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ============================================================
      // ì„¤ê³„ ì €ì¥ í•¨ìˆ˜ (JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ)
      // ============================================================
      function saveDesignToFile() {
        const design = window.DadamAgent.exportDesign();

        if (!design.items || design.items.length === 0) {
          alert('ì €ì¥í•  ì„¤ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // íŒŒì¼ëª… ìƒì„± (ì²«ë²ˆì§¸ ì•„ì´í…œ ê¸°ì¤€)
        const firstItem = design.items[0];
        const categoryName = firstItem.category || 'design';
        const dateStr = new Date().toISOString().slice(0, 10);
        const filename = `ë‹¤ë‹´_${categoryName}_${firstItem.w}x${firstItem.h}_${dateStr}.json`;

        // JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const jsonStr = JSON.stringify(design, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        alert(`ì„¤ê³„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ${filename}`);
      }

      // ============================================================
      // AI ë””ìì¸ ìƒì„± ì‹œìŠ¤í…œ (ì„¤ê³„ ë°ì´í„° ê¸°ë°˜ - Fast Generation)
      // ============================================================

      // ìŠ¤íƒ€ì¼ ì¶”ì¶œ í—¬í¼ í•¨ìˆ˜
      function extractStyleFromSpecs(specs) {
        if (!specs) return 'modern minimal white';
        const styles = [];

        // ë§ˆê°ì¬ ìŠ¤íƒ€ì¼
        if (specs.doorFinishUpper === 'ë¬´ê´‘' || specs.doorFinishLower === 'ë¬´ê´‘') {
          styles.push('matte');
        } else if (specs.doorFinishUpper === 'ìœ ê´‘') {
          styles.push('glossy');
        }

        // ìƒ‰ìƒ ìŠ¤íƒ€ì¼
        const colorMap = {
          'í™”ì´íŠ¸': 'white', 'ê·¸ë ˆì´': 'gray', 'ë¸”ë™': 'black',
          'ì•„ì´ë³´ë¦¬': 'ivory', 'ì˜¤í¬': 'oak', 'ì›”ë„›': 'walnut'
        };
        if (specs.doorColorUpper && colorMap[specs.doorColorUpper]) {
          styles.push(colorMap[specs.doorColorUpper]);
        }

        // í•¸ë“¤ ìŠ¤íƒ€ì¼
        if (specs.handle?.includes('í‘¸ì‹œ') || specs.handle?.includes('push')) {
          styles.push('handleless');
        }

        return `modern minimal korean ${styles.join(' ')}`.trim();
      }

      // ëª¨ë“ˆ ìœ„ì¹˜ ê³„ì‚° í—¬í¼ í•¨ìˆ˜
      function calculateModulePositions(modules, section) {
        let currentPos = 0;
        return modules
          .filter(m => m.pos === section || m.type === section)
          .map(m => {
            const moduleWithPos = {
              ...m,
              position_from_left_mm: currentPos,
              width_mm: parseInt(m.w) || 0,
              height_mm: parseInt(m.h) || 0,
              depth_mm: parseInt(m.d) || 0,
              is_drawer: m.isDrawer || false,
              door_count: m.doorCount || 1,
              has_sink: m.moduleType === 'sink' || m.name?.includes('ì‹±í¬'),
              has_cooktop: m.moduleType === 'cooktop' || m.name?.includes('ì¿¡íƒ‘') || m.name?.includes('ì¸ë•ì…˜'),
            };
            currentPos += parseInt(m.w) || 0;
            return moduleWithPos;
          });
      }

      // ì´ë¯¸ì§€ URLì„ base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      async function fetchImageAsBase64(imageUrl) {
        try {
          const response = await fetch(imageUrl);
          if (!response.ok) throw new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');

          const blob = await response.blob();
          const mimeType = blob.type || 'image/jpeg';

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
              const base64 = reader.result.split(',')[1]; // data:image/...;base64, ì œê±°
              resolve({ base64, type: mimeType });
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨:', error);
          return null;
        }
      }

      async function generateAIDesign() {
        // 1. ì„¤ê³„ ë°ì´í„° ì¶”ì¶œ
        const design = window.DadamAgent.exportDesign();

        if (!design.items || design.items.length === 0) {
          alert('AI ë””ìì¸ì„ ìƒì„±í•  ì„¤ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € ìºë¹„ë„·ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          return;
        }

        // 2. ë¡œë”© UI í‘œì‹œ
        showAIGeneratingModal();

        try {
          // 3. ì²« ë²ˆì§¸ ì•„ì´í…œ ê¸°ì¤€ìœ¼ë¡œ ìƒì„¸ ì‚¬ì–‘ ì¶”ì¶œ
          const mainItem = design.items[0];
          const specs = mainItem.specs || {};
          const modules = mainItem.modules || [];

          // 4. ì¹´í…Œê³ ë¦¬ ë° ìŠ¤íƒ€ì¼ ê²°ì •
          const category = mainItem.categoryId || mainItem.category || 'sink';
          const style = extractStyleFromSpecs(specs);

          // 5. ìƒì„¸ ìºë¹„ë„· ì‚¬ì–‘ êµ¬ì„±
          const cabinetSpecs = {
            // ê¸°ë³¸ ì¹˜ìˆ˜
            total_width_mm: parseInt(mainItem.w) || 0,
            total_height_mm: parseInt(mainItem.h) || 0,
            depth_mm: parseInt(mainItem.d) || 0,

            // ë†’ì´ ì„¸ë¶€ ì‚¬í•­
            upper_cabinet_height: specs.upperH || 720,
            lower_cabinet_height: specs.lowerH || 870,
            molding_height: specs.moldingH || 60,
            leg_height: specs.sinkLegHeight || specs.legH || 150,
            countertop_thickness: specs.topThickness || 20,

            // ìƒ‰ìƒ ë° ë§ˆê°
            door_color_upper: specs.doorColorUpper || 'í™”ì´íŠ¸',
            door_color_lower: specs.doorColorLower || 'í™”ì´íŠ¸',
            door_finish_upper: specs.doorFinishUpper || 'ë¬´ê´‘',
            door_finish_lower: specs.doorFinishLower || 'ë¬´ê´‘',
            countertop_color: specs.topColor || 'ìŠ¤ë…¸ìš°',

            // í•˜ë“œì›¨ì–´
            handle_type: specs.handle || 'push-open',

            // ê°€ì „ (ì‹±í¬ëŒ€/ì•„ì¼ëœë“œ)
            sink_type: specs.sink || null,
            faucet_type: specs.faucet || null,
            hood_type: specs.hood || null,
            cooktop_type: specs.cooktop || null,

            // ë§ˆê° (ì¢Œìš°)
            finish_left_type: specs.finishLeftType || 'Molding',
            finish_left_width: specs.finishLeftWidth || 60,
            finish_right_type: specs.finishRightType || 'Molding',
            finish_right_width: specs.finishRightWidth || 60,
          };

          // 6. ëª¨ë“ˆ ë ˆì´ì•„ì›ƒ êµ¬ì„±
          const upperModules = calculateModulePositions(modules, 'upper');
          const lowerModules = calculateModulePositions(modules, 'lower');

          // ì‹±í¬ëŒ€/ì¿¡íƒ‘ ìœ„ì¹˜ ì°¾ê¸°
          const sinkModule = lowerModules.find(m => m.has_sink);
          const cooktopModule = lowerModules.find(m => m.has_cooktop);

          if (sinkModule) {
            cabinetSpecs.sink_position_mm = sinkModule.position_from_left_mm;
          }
          if (cooktopModule) {
            cabinetSpecs.cooktop_position_mm = cooktopModule.position_from_left_mm;
          }

          // 7. í˜„ì¥ ì‚¬ì§„ í™•ì¸ ë° ë³€í™˜
          let roomImageData = null;
          const sitePhotoUrl = mainItem.imageUrl || mainItem.image;

          if (sitePhotoUrl && sitePhotoUrl !== 'loading') {
            console.log('í˜„ì¥ ì‚¬ì§„ ë°œê²¬:', sitePhotoUrl);
            roomImageData = await fetchImageAsBase64(sitePhotoUrl);
            if (roomImageData) {
              console.log('í˜„ì¥ ì‚¬ì§„ ë³€í™˜ ì„±ê³µ:', roomImageData.type);
            }
          }

          // 8. ì—”ë“œí¬ì¸íŠ¸ ê²°ì • (ì´ë¯¸ì§€ ìœ ë¬´ì— ë”°ë¼)
          // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë©”ì¸ ì›Œí¬í”Œë¡œìš° (Wall Analysis í¬í•¨), ì—†ìœ¼ë©´ design-to-image
          const apiEndpoint = roomImageData
            ? 'https://dadam-proxy.dadamfurniture.workers.dev'  // ë©”ì¸ ì›Œí¬í”Œë¡œìš°
            : N8N_AI_DESIGN_URL;  // design-to-image ì›Œí¬í”Œë¡œìš°

          console.log('AI ë””ìì¸ ìƒì„± ìš”ì²­:', {
            category,
            style,
            cabinetSpecs,
            upperModules: upperModules.length,
            lowerModules: lowerModules.length,
            hasRoomImage: !!roomImageData,
            endpoint: apiEndpoint
          });

          // 9. n8n ì›Œí¬í”Œë¡œìš° í˜¸ì¶œ (ê°•í™”ëœ í˜ì´ë¡œë“œ)
          const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              // í˜„ì¥ ì‚¬ì§„ (ìˆëŠ” ê²½ìš°)
              room_image: roomImageData?.base64 || '',
              image_type: roomImageData?.type || 'image/jpeg',

              // ê¸°ë³¸ ì •ë³´
              category: category,
              style: style,
              design_style: style,

              // ìƒì„¸ ìºë¹„ë„· ì‚¬ì–‘
              cabinet_specs: cabinetSpecs,

              // ëª¨ë“ˆ ë ˆì´ì•„ì›ƒ
              modules: {
                upper: upperModules,
                lower: lowerModules,
                upper_count: upperModules.length,
                lower_count: lowerModules.length,
              },

              // ë ˆê±°ì‹œ í˜¸í™˜ (ê¸°ì¡´ Parse Design Data ë…¸ë“œ)
              design_data: design,
              items: design.items.map((item) => ({
                categoryId: item.categoryId || item.category,
                category: item.categoryId || item.category,
                name: item.name,
                w: parseInt(item.w) || 0,
                h: parseInt(item.h) || 0,
                d: parseInt(item.d) || 0,
                specs: item.specs,
                modules: item.modules,
              })),
            }),
          });

          if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: HTTP ${response.status}`);

          // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸
          const responseText = await response.text();
          if (!responseText || responseText.trim() === '') {
            throw new Error('AI ì„œë²„ì—ì„œ ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.\nn8n ì›Œí¬í”Œë¡œìš°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }

          // JSON íŒŒì‹± ì‹œë„
          let data;
          try {
            data = JSON.parse(responseText);
            if (Array.isArray(data)) data = data[0];
          } catch (parseError) {
            console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', responseText);
            throw new Error('AI ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì‘ë‹µ: ' + responseText.substring(0, 100));
          }

          // 4. ê²°ê³¼ í™•ì¸ ë° í‘œì‹œ
          if (data.success === false) {
            throw new Error(data.error || data.message || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          showAIDesignResult(data);
        } catch (error) {
          console.error('AI ë””ìì¸ ìƒì„± ì˜¤ë¥˜:', error);
          alert('AI ë””ìì¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
        } finally {
          hideAIGeneratingModal();
        }
      }

      // AI ìƒì„± ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
      function showAIGeneratingModal() {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existing = document.getElementById('aiGeneratingModal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'aiGeneratingModal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
    <div style="background:#fff;border-radius:20px;padding:40px 60px;text-align:center;max-width:400px;">
      <div style="width:60px;height:60px;margin:0 auto 20px;border:4px solid #EBE8E2;border-top-color:#6366F1;border-radius:50%;animation:spin 1s linear infinite;"></div>
      <h3 style="font-size:18px;margin:0 0 12px;color:#2D2A26;">ğŸ¨ AI ë””ìì¸ ìƒì„± ì¤‘...</h3>
      <p style="color:#8B8680;margin:0;font-size:14px;">ì„¤ê³„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // AI ìƒì„± ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      function hideAIGeneratingModal() {
        const modal = document.getElementById('aiGeneratingModal');
        if (modal) modal.remove();
      }

      // AI ë””ìì¸ ê²°ê³¼ í‘œì‹œ
      function showAIDesignResult(data) {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existing = document.querySelector('.ai-design-result-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.className = 'ai-design-result-modal';
        modal.style.cssText =
          'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
        modal.innerHTML = `
    <div style="background:#fff;border-radius:20px;max-width:800px;width:90%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid #EBE8E2;">
        <h3 style="margin:0;font-size:18px;color:#2D2A26;">ğŸ¨ AI ë””ìì¸ ê²°ê³¼</h3>
        <button onclick="this.closest('.ai-design-result-modal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#8B8680;line-height:1;">&times;</button>
      </div>
      <div style="padding:24px;overflow-y:auto;flex:1;">
        ${
          data.generated_image
            ? `
          <img src="data:image/png;base64,${data.generated_image.base64 || data.generated_image}"
               style="width:100%;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        `
            : data.image_url
              ? `
          <img src="${data.image_url}"
               style="width:100%;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        `
              : ''
        }
        <div style="background:#F8F7F4;padding:16px;border-radius:12px;color:#2D2A26;line-height:1.7;">
          ${data.analysis || data.message || data.output || 'ë””ìì¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'}
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid #EBE8E2;">
        ${
          data.generated_image || data.image_url
            ? `
          <button onclick="downloadAIDesignImage()" style="padding:12px 24px;background:#6366F1;color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;">ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥</button>
        `
            : ''
        }
        <button onclick="this.closest('.ai-design-result-modal').remove()" style="padding:12px 24px;background:#EBE8E2;color:#2D2A26;border:none;border-radius:10px;font-size:14px;cursor:pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  `;

        // ê²°ê³¼ ë°ì´í„° ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
        window._aiDesignResult = data;

        document.body.appendChild(modal);

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      }

      // AI ë””ìì¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      function downloadAIDesignImage() {
        const data = window._aiDesignResult;
        if (!data) return;

        let imageUrl;
        if (data.generated_image) {
          const base64 = data.generated_image.base64 || data.generated_image;
          imageUrl = `data:image/png;base64,${base64}`;
        } else if (data.image_url) {
          imageUrl = data.image_url;
        }

        if (imageUrl) {
          const a = document.createElement('a');
          a.href = imageUrl;
          a.download = `ai-design-${new Date().toISOString().slice(0, 10)}.png`;
          a.click();
        }
      }

      // ============================================================
      // ì„¤ê³„ ì™„ë£Œ ë³´ê³ ì„œ (í†µí•© ìì¬ ì¶”ì¶œ ì‹œìŠ¤í…œ V2)
      // ì¬ë‹¨ ì¶”ì¶œ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™” - AI ë””ìì¸ ìƒì„±ìœ¼ë¡œ ëŒ€ì²´
      // ============================================================
      function showDesignCompleteReport() {
        // AI ë””ìì¸ ìƒì„± í•¨ìˆ˜ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        generateAIDesign();

        /* ===== ì¬ë‹¨ ì¶”ì¶œ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™” =====
  const design = window.DadamAgent.exportDesign();
  console.log('===== ì„¤ê³„ ì™„ë£Œ ë³´ê³ ì„œ ìƒì„± =====');
  console.log('ì„¤ê³„ ë°ì´í„°:', design);
  console.log('ì•„ì´í…œ ìˆ˜:', design.items?.length);

  if (design.items && design.items.length > 0) {
    design.items.forEach((item, idx) => {
      console.log(`ì•„ì´í…œ[${idx}]:`, item.category, 'W=', item.w, 'H=', item.h);
      console.log(`  modules (${item.modules?.length || 0}ê°œ):`, item.modules);
    });
  }

  if (!design.items || design.items.length === 0) {
    alert('ì„¤ê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ê³„ë¥¼ ì™„ë£Œí•˜ì„¸ìš”.');
    return;
  }

  // ìì¬ ì¶”ì¶œ
  console.log('ìì¬ ì¶”ì¶œ ì‹œì‘...');
  const matResult = materialExtractor.extract(design);
  console.log('ìì¬ ì¶”ì¶œ ê²°ê³¼:', matResult);
  console.log('ì¶”ì¶œëœ ìì¬ ìˆ˜:', matResult.materials?.length);

  // ëª¨ë“ˆì´ ì—†ì–´ë„ ë³´ê³ ì„œëŠ” ë³´ì—¬ì¤Œ
  if (!matResult.materials.length) {
    console.warn('âš ï¸ ì¶”ì¶œëœ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤!');
    console.warn('ì²« ë²ˆì§¸ ì•„ì´í…œ ëª¨ë“ˆ:', design.items[0]?.modules);
  }

  // ë¶€ìì¬ ì¶”ì¶œ
  const hwResult = hardwareExtractor.extract(design);

  // íƒ­ ì½˜í…ì¸  ìƒì„±
  const tabContent = generateReportTabs(matResult, hwResult, design);

  // ì „ì—­ ë°ì´í„° ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
  window._reportData = {
    design,
    materials: matResult,
    hardware: hwResult,
    csvMaterial: materialExtractor.toCSV(matResult.materials),
    cncMaterial: materialExtractor.toCNC(matResult.materials),
    csvHardware: hardwareExtractor.toCSV(hwResult.hardware)
  };

  showReportModal(tabContent);
  ===== ì¬ë‹¨ ì¶”ì¶œ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™” ===== */
      }

      // ë³´ê³ ì„œ íƒ­ ìƒì„±
      function generateReportTabs(matResult, hwResult, design) {
        const firstItem = design.items[0];
        const projectName = `${firstItem.name || firstItem.category} ${firstItem.w}Ã—${firstItem.h}`;

        // 1. ìš”ì•½ íƒ­
        const summaryTab = generateSummaryTab(matResult, hwResult, design);

        // 2. ë³¸ì²´ ìì¬ íƒ­
        const bodyTab = generateBodyMaterialTab(matResult.materials);

        // 3. ë„ì–´ ìì¬ íƒ­
        const doorTab = generateDoorMaterialTab(matResult.materials);

        // 4. EP ìì¬ íƒ­
        const epTab = generateEPMaterialTab(matResult.materials);

        // 5. ë¶€ìì¬ íƒ­
        const hardwareTab = generateHardwareTab(hwResult);

        return `
    <div style="margin-bottom:15px;">
      <div style="font-size:20px;font-weight:bold;color:#1976d2;margin-bottom:5px;">ğŸ“‹ ì„¤ê³„ ì™„ë£Œ ë³´ê³ ì„œ</div>
      <div style="font-size:13px;color:#666;">í”„ë¡œì íŠ¸: ${projectName} | ì¶”ì¶œì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</div>
    </div>
    <div class="report-tabs" style="display:flex;border-bottom:2px solid #1976d2;margin-bottom:15px;">
      <button class="report-tab active" onclick="switchReportTab(this, 'summary')" style="padding:10px 20px;border:none;background:#1976d2;color:white;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;">ğŸ“Š ìš”ì•½</button>
      <button class="report-tab" onclick="switchReportTab(this, 'body')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">ğŸªµ ë³¸ì²´</button>
      <button class="report-tab" onclick="switchReportTab(this, 'door')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">ğŸšª ë„ì–´</button>
      <button class="report-tab" onclick="switchReportTab(this, 'ep')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">ğŸ“ EP</button>
      <button class="report-tab" onclick="switchReportTab(this, 'hardware')" style="padding:10px 20px;border:none;background:#e3f2fd;color:#1976d2;font-weight:bold;cursor:pointer;border-radius:8px 8px 0 0;margin-left:4px;">ğŸ”© ë¶€ìì¬</button>
    </div>
    <div id="report-content-summary" class="report-content">${summaryTab}</div>
    <div id="report-content-body" class="report-content" style="display:none;">${bodyTab}</div>
    <div id="report-content-door" class="report-content" style="display:none;">${doorTab}</div>
    <div id="report-content-ep" class="report-content" style="display:none;">${epTab}</div>
    <div id="report-content-hardware" class="report-content" style="display:none;">${hardwareTab}</div>
  `;
      }

      // íƒ­ ì „í™˜
      function switchReportTab(btn, tabId) {
        // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('.report-tab').forEach((t) => {
          t.style.background = '#e3f2fd';
          t.style.color = '#1976d2';
          t.classList.remove('active');
        });
        // í´ë¦­ëœ íƒ­ í™œì„±í™”
        btn.style.background = '#1976d2';
        btn.style.color = 'white';
        btn.classList.add('active');

        // ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¹€
        document.querySelectorAll('.report-content').forEach((c) => (c.style.display = 'none'));
        // ì„ íƒëœ ì½˜í…ì¸  í‘œì‹œ
        document.getElementById('report-content-' + tabId).style.display = 'block';
      }

      // ìš”ì•½ íƒ­ ìƒì„±
      function generateSummaryTab(matResult, hwResult, design) {
        const summary = matResult.summary;
        const item = design.items[0];
        // â˜… categoryId ì‚¬ìš©
        const category = item.categoryId || item.category;

        // íŒ¨ë„ ì‚¬ìš©ëŸ‰ ì¹´ë“œ
        let panelCards = '';
        if (Object.keys(summary).length === 0) {
          panelCards = '<div style="color:#999;font-size:13px;">ìì¬ ì •ë³´ ì—†ìŒ</div>';
        } else {
          Object.values(summary).forEach((s) => {
            const area = (s.totalArea / 1000000).toFixed(2);
            const efficiency = ((s.totalArea / (s.panelCount * 1220 * 2440)) * 100).toFixed(1);
            panelCards += `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:15px;border-radius:10px;min-width:150px;">
          <div style="font-size:12px;opacity:0.9;">${s.material} ${s.thickness}T</div>
          <div style="font-size:28px;font-weight:bold;margin:5px 0;">${s.panelCount}ì¥</div>
          <div style="font-size:11px;opacity:0.8;">${area}ã¡ (íš¨ìœ¨ ${efficiency}%)</div>
        </div>
      `;
          });
        }

        // ë¶€ìì¬ ìš”ì•½
        let hwSummary = '';
        Object.entries(hwResult.summary || {}).forEach(([cat, qty]) => {
          hwSummary += `<span style="background:#fff3e0;color:#e65100;padding:4px 10px;border-radius:15px;font-size:12px;margin-right:5px;">${cat}: ${qty}</span>`;
        });

        // ëª¨ë“ˆ ìˆ˜ ê³„ì‚° (ì¹´í…Œê³ ë¦¬ë³„)
        let moduleInfo = '';
        if (category === 'sink') {
          const upperCount = (item.modules || []).filter((m) => m.pos === 'upper').length;
          const lowerCount = (item.modules || []).filter((m) => m.pos === 'lower').length;
          moduleInfo = `
      <div><span style="color:#666;">ìƒë¶€ì¥ ìˆ˜:</span> <strong>${upperCount}ê°œ</strong></div>
      <div><span style="color:#666;">í•˜ë¶€ì¥ ìˆ˜:</span> <strong>${lowerCount}ê°œ</strong></div>
    `;
        } else if (category === 'wardrobe') {
          const wardrobeCount = (item.modules || []).filter(
            (m) => m.pos === 'wardrobe' || m.type === 'wardrobe'
          ).length;
          const shortCount = (item.modules || []).filter((m) => m.moduleType === 'short').length;
          const longCount = (item.modules || []).filter((m) => m.moduleType === 'long').length;
          const shelfCount = (item.modules || []).filter((m) => m.moduleType === 'shelf').length;
          moduleInfo = `
      <div><span style="color:#666;">ì´ ëª¨ë“ˆ ìˆ˜:</span> <strong>${wardrobeCount}ê°œ</strong></div>
      <div><span style="color:#666;">ì§§ì€ì˜·/ê¸´ì˜·/ì„ ë°˜:</span> <strong>${shortCount}/${longCount}/${shelfCount}</strong></div>
    `;
        } else if (category === 'fridge') {
          const moduleCount = (item.modules || []).filter((m) => m.type !== 'fridge').length;
          moduleInfo = `
      <div><span style="color:#666;">ëª¨ë“ˆ ìˆ˜:</span> <strong>${moduleCount}ê°œ</strong></div>
      <div><span style="color:#666;">ëƒ‰ì¥ê³  íƒ€ì…:</span> <strong>${item.specs?.fridgeModel || '-'}</strong></div>
    `;
        }

        const totalParts = matResult.materials.length;

        return `
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;">
      <div style="background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid #e0e0e0;">
        <h4 style="margin:0 0 15px 0;color:#333;display:flex;align-items:center;gap:8px;">ğŸ“¦ íŒ¨ë„ ì‚¬ìš©ëŸ‰</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">${panelCards}</div>
      </div>
      
      <div style="background:#f8f9fa;padding:20px;border-radius:12px;border:1px solid #e0e0e0;">
        <h4 style="margin:0 0 15px 0;color:#333;display:flex;align-items:center;gap:8px;">ğŸ“ ì„¤ê³„ ì •ë³´</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:13px;">
          <div><span style="color:#666;">ê°€êµ¬ ìœ í˜•:</span> <strong>${item.name || item.category}</strong></div>
          <div><span style="color:#666;">ì „ì²´ í¬ê¸°:</span> <strong>${item.w} Ã— ${item.h} Ã— ${item.d}</strong></div>
          ${moduleInfo}
          <div><span style="color:#666;">ì´ ë¶€í’ˆ ìˆ˜:</span> <strong>${totalParts}ê°œ</strong></div>
          <div><span style="color:#666;">ë¶€ìì¬ í’ˆëª©:</span> <strong>${hwResult.hardware?.length || 0}ê°œ</strong></div>
        </div>
      </div>
    </div>
    
    <div style="margin-top:20px;background:#e8f5e9;padding:15px;border-radius:10px;border:1px solid #c8e6c9;">
      <h4 style="margin:0 0 10px 0;color:#2e7d32;">ğŸ”© ë¶€ìì¬ ìš”ì•½</h4>
      <div>${hwSummary || '<span style="color:#666;">ë¶€ìì¬ ì •ë³´ ì—†ìŒ</span>'}</div>
    </div>
    
    <div style="margin-top:20px;background:#fff8e1;padding:15px;border-radius:10px;border:1px solid #ffe082;">
      <h4 style="margin:0 0 10px 0;color:#f57c00;">ğŸ’¡ ì°¸ê³ ì‚¬í•­</h4>
      <ul style="margin:0;padding-left:20px;font-size:12px;color:#666;">
        <li>íŒ¨ë„ ê·œê²©: 1220 Ã— 2440 mm (4Ã—8 í•©íŒ ê¸°ì¤€)</li>
        <li>ë³¸ì²´ ìì¬: PB (íŒŒí‹°í´ë³´ë“œ) 18T ê¸°ì¤€</li>
        <li>ë„ì–´ ìì¬: MDF 18T ê¸°ì¤€</li>
        <li>ë’·íŒ ìì¬: MDF 2.7T ê¸°ì¤€ (í™ˆì¹´í˜/ì˜¤í”ˆì¥ì€ 18T)</li>
      </ul>
    </div>
  `;
      }

      // ë³¸ì²´ ìì¬ íƒ­
      function generateBodyMaterialTab(materials) {
        const bodyParts = materials.filter(
          (m) => !['ë„ì–´', 'ê±¸ë ˆë°›ì´', 'íœ ë¼', 'ëª©ì°¬ë„¬', 'ìƒëª°ë”©'].some((p) => m.part.includes(p))
        );

        if (bodyParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">ë³¸ì²´ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#e3f2fd;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">ëª¨ë“ˆ</th>
          <th style="border:1px solid #ddd;padding:10px;">ë¶€í’ˆ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìì¬</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ë‘ê»˜</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ê°€ë¡œ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ì„¸ë¡œ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìˆ˜ëŸ‰</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ì—£ì§€</th>
          <th style="border:1px solid #ddd;padding:10px;">ë¹„ê³ </th>
        </tr>
      </thead>
      <tbody>`;

        bodyParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#f9f9f9'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#1976d2;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-size:11px;">${m.edge}</td>
        <td style="border:1px solid #ddd;padding:8px;font-size:11px;color:#666;">${m.note || ''}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:14px;font-weight:bold;color:#333;">ğŸªµ ë³¸ì²´ ìì¬ ëª©ë¡ (${bodyParts.length}ê°œ í’ˆëª©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // ë„ì–´ ìì¬ íƒ­
      function generateDoorMaterialTab(materials) {
        const doorParts = materials.filter((m) => m.part.includes('ë„ì–´'));

        if (doorParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">ë„ì–´ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#fff3e0;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">ëª¨ë“ˆ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìì¬</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ë‘ê»˜</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ê°€ë¡œ(W)</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ì„¸ë¡œ(H)</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìˆ˜ëŸ‰</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ì—£ì§€</th>
        </tr>
      </thead>
      <tbody>`;

        doorParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#fff8e1'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:600;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:600;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#e65100;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.edge}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        // ë„ì–´ ì´ ìˆ˜ëŸ‰ ê³„ì‚°
        const totalDoors = doorParts.reduce((sum, m) => sum + m.qty, 0);

        return `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:14px;font-weight:bold;color:#333;">ğŸšª ë„ì–´ ìì¬ ëª©ë¡</span>
      <span style="background:#ff9800;color:white;padding:4px 12px;border-radius:15px;font-size:12px;">ì´ ${totalDoors}ê°œ</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
    <div style="margin-top:15px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#666;">
      <strong>ğŸ“Œ ë„ì–´ ê·œì¹™:</strong> ìƒë¶€ì¥ ë„ì–´ = ëª¨ë“ˆë†’ì´ + 20mm / í•˜ë¶€ì¥ ë„ì–´ = ëª¨ë“ˆë†’ì´ - 30mm / ë„ˆë¹„ = ëª¨ë“ˆë„ˆë¹„ - 4mm
    </div>
  `;
      }

      // EP ìì¬ íƒ­
      function generateEPMaterialTab(materials) {
        const epParts = materials.filter((m) =>
          ['ê±¸ë ˆë°›ì´', 'íœ ë¼', 'ëª©ì°¬ë„¬', 'ìƒëª°ë”©', 'EP'].some((p) => m.module.includes(p) || m.part.includes(p))
        );

        if (epParts.length === 0)
          return '<p style="color:#666;text-align:center;padding:40px;">EP(ë§ˆê°ì¬) ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#e8f5e9;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">í’ˆëª©</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìì¬</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ë‘ê»˜</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ê°€ë¡œ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:right;">ì„¸ë¡œ</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìˆ˜ëŸ‰</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ì—£ì§€</th>
        </tr>
      </thead>
      <tbody>`;

        epParts.forEach((m, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#e8f5e9'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#2e7d32;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${m.edge}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;">
      <span style="font-size:14px;font-weight:bold;color:#333;">ğŸ“ EP(ë§ˆê°ì¬) ìì¬ ëª©ë¡ (${epParts.length}ê°œ í’ˆëª©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // ë¶€ìì¬ íƒ­
      function generateHardwareTab(hwResult) {
        if (!hwResult.hardware || hwResult.hardware.length === 0) {
          return '<p style="color:#666;text-align:center;padding:40px;">ë¶€ìì¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        let tableHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead style="background:#fce4ec;">
        <tr>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">No</th>
          <th style="border:1px solid #ddd;padding:10px;">ë¶„ë¥˜</th>
          <th style="border:1px solid #ddd;padding:10px;">í’ˆëª©</th>
          <th style="border:1px solid #ddd;padding:10px;">ì œì¡°ì‚¬</th>
          <th style="border:1px solid #ddd;padding:10px;">ìŠ¤í™</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ìˆ˜ëŸ‰</th>
          <th style="border:1px solid #ddd;padding:10px;text-align:center;">ë‹¨ìœ„</th>
          <th style="border:1px solid #ddd;padding:10px;">ë¹„ê³ </th>
        </tr>
      </thead>
      <tbody>`;

        hwResult.hardware.forEach((h, i) => {
          tableHTML += `
      <tr style="background:${i % 2 === 0 ? '#fff' : '#fce4ec'};">
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${i + 1}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.category}</td>
        <td style="border:1px solid #ddd;padding:8px;font-weight:600;">${h.item}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.manufacturer || '-'}</td>
        <td style="border:1px solid #ddd;padding:8px;">${h.spec || '-'}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;font-weight:bold;color:#c2185b;">${h.qty}</td>
        <td style="border:1px solid #ddd;padding:8px;text-align:center;">${h.unit}</td>
        <td style="border:1px solid #ddd;padding:8px;font-size:11px;color:#666;">${h.note || ''}</td>
      </tr>`;
        });

        tableHTML += '</tbody></table>';

        return `
    <div style="margin-bottom:10px;">
      <span style="font-size:14px;font-weight:bold;color:#333;">ğŸ”© ë¶€ìì¬ ëª©ë¡ (${hwResult.hardware.length}ê°œ í’ˆëª©)</span>
    </div>
    <div style="max-height:400px;overflow-y:auto;">${tableHTML}</div>
  `;
      }

      // ë³´ê³ ì„œ ëª¨ë‹¬ í‘œì‹œ
      function showReportModal(content) {
        const existingModal = document.getElementById('reportModal');
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = 'reportModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);">
      <div style="background:white;border-radius:16px;width:95%;max-width:1100px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%);color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:20px;display:flex;align-items:center;gap:10px;">âœ… ì„¤ê³„ ì™„ë£Œ - ìì¬ ì¶”ì¶œ ë³´ê³ ì„œ</h3>
          <button onclick="document.getElementById('reportModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">&times;</button>
        </div>
        <div style="padding:24px;overflow-y:auto;max-height:calc(90vh - 180px);">
          ${content}
        </div>
        <div style="padding:15px 24px;border-top:1px solid #eee;background:#f9f9f9;">
          <div style="display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;">
              <button onclick="downloadReportExcel()" style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
              </button>
              <button onclick="downloadReportCSV()" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ
              </button>
              <button onclick="downloadReportCNC()" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                ğŸ”§ CNC íŒŒì¼
              </button>
            </div>
            <div style="display:flex;gap:8px;">
              <button onclick="generateDrawingFromReport()" style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;gap:5px;">
                ğŸ“ ë„ë©´ ìƒì„±
              </button>
              <button onclick="document.getElementById('reportModal').remove()" style="background:#eee;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
        document.body.appendChild(modal);
      }

      // ë³´ê³ ì„œì—ì„œ ì¬ë‹¨ ìµœì í™” ì‹¤í–‰
      function generateDrawingFromReport() {
        // íŒì—… ë‹«ê¸°
        document.getElementById('reportModal')?.remove();
        // ì¬ë‹¨ ìµœì í™” ì‹¤í–‰
        showNestingOptimizer();
      }

      // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (CSVë¥¼ ì—‘ì…€ í˜¸í™˜ í˜•ì‹ìœ¼ë¡œ)
      function downloadReportExcel() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);

        // ì—‘ì…€ í˜¸í™˜ CSV (UTF-8 BOM + Tab êµ¬ë¶„)
        let excelContent = '\uFEFF'; // BOM

        // í—¤ë” ì •ë³´
        const item = data.design.items[0];
        excelContent += `ë‹¤ë‹´ ìºë¹„ë„· - ìì¬ ì¶”ì¶œ ë³´ê³ ì„œ\n`;
        excelContent += `í”„ë¡œì íŠ¸\t${item.name || item.category}\n`;
        excelContent += `í¬ê¸°\t${item.w} Ã— ${item.h} Ã— ${item.d}\n`;
        excelContent += `ì¶”ì¶œì¼ì‹œ\t${new Date().toLocaleString('ko-KR')}\n\n`;

        // ìì¬ ëª©ë¡
        excelContent += `[ë³¸ì²´ ë° ë„ì–´ ìì¬]\n`;
        excelContent += `ëª¨ë“ˆ\të¶€í’ˆ\tìì¬\të‘ê»˜(T)\tê°€ë¡œ(mm)\tì„¸ë¡œ(mm)\tìˆ˜ëŸ‰\tì—£ì§€\të¹„ê³ \n`;
        data.materials.materials.forEach((m) => {
          excelContent += `${m.module}\t${m.part}\t${m.material}\t${m.thickness}\t${m.w}\t${m.h}\t${m.qty}\t${m.edge}\t${m.note || ''}\n`;
        });

        excelContent += `\n[íŒ¨ë„ ì‚¬ìš©ëŸ‰ ìš”ì•½]\n`;
        excelContent += `ìì¬\tì´ë©´ì (ã¡)\tí•„ìš” íŒ¨ë„ ìˆ˜\n`;
        Object.values(data.materials.summary).forEach((s) => {
          excelContent += `${s.material} ${s.thickness}T\t${(s.totalArea / 1000000).toFixed(2)}\t${s.panelCount}ì¥\n`;
        });

        // ë¶€ìì¬ ëª©ë¡
        if (data.hardware.hardware && data.hardware.hardware.length > 0) {
          excelContent += `\n[ë¶€ìì¬]\n`;
          excelContent += `ë¶„ë¥˜\tí’ˆëª©\tì œì¡°ì‚¬\tìŠ¤í™\tìˆ˜ëŸ‰\të‹¨ìœ„\të¹„ê³ \n`;
          data.hardware.hardware.forEach((h) => {
            excelContent += `${h.category}\t${h.item}\t${h.manufacturer || ''}\t${h.spec || ''}\t${h.qty}\t${h.unit}\t${h.note || ''}\n`;
          });
        }

        const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const filename = `ìì¬ë³´ê³ ì„œ_${item.category}_${dateStr}.xls`;
        downloadBlob(blob, filename);

        showToast('ğŸ“Š ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      // CSV ë‹¤ìš´ë¡œë“œ
      function downloadReportCSV() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);
        const item = data.design.items[0];

        const blob = new Blob(['\uFEFF' + data.csvMaterial], { type: 'text/csv;charset=utf-8;' });
        const filename = `ìì¬ëª©ë¡_${item.category}_${dateStr}.csv`;
        downloadBlob(blob, filename);

        showToast('ğŸ“„ CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      // CNC íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      function downloadReportCNC() {
        if (!window._reportData) return;

        const data = window._reportData;
        const dateStr = new Date().toISOString().slice(0, 10);
        const item = data.design.items[0];

        const blob = new Blob(['\uFEFF' + data.cncMaterial], { type: 'text/csv;charset=utf-8;' });
        const filename = `CNCì¬ë‹¨_${item.category}_${dateStr}.csv`;
        downloadBlob(blob, filename);

        showToast('ğŸ”§ CNC íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }

      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
      function showToast(message) {
        const existing = document.querySelector('.toast-message');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.style.cssText =
          'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:20000;box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:fadeIn 0.3s ease;';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, 2500);
      }

      // ============================================================
      // ì„¤ê³„ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
      // ============================================================
      function loadDesignFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const design = JSON.parse(event.target.result);
              const result = window.DadamAgent.importDesign(design);
              if (result.success) {
                alert('ì„¤ê³„ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                location.reload();
              } else {
                alert('ì„¤ê³„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + result.error);
              }
            } catch (err) {
              alert('íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      // ============================================================
      // ì¬ë‹¨ ìµœì í™” í´ë˜ìŠ¤ (Nesting Optimizer) v1.0
      // ============================================================
      // ê·¸ë£¹1: ì¸¡íŒ, ì§€íŒ â†’ ì‹¤ì‹œê°„ ì¬ë‹¨ ë„ë©´
      // ê·¸ë£¹2: ì„œëì¬ (H60, H120, H180) â†’ ì¬ê³  ìš´ì˜
      // ê·¸ë£¹3: ë³´ê°•ëª©, ì«„ëŒ€ (W60, W70) â†’ ì¬ê³  ìš´ì˜
      // ============================================================

      class NestingOptimizer {
        constructor() {
          this.PANEL_W = 1220; // íŒ¨ë„ ë„ˆë¹„
          this.PANEL_H = 2440; // íŒ¨ë„ ë†’ì´
          this.KERF = 4; // í†±ë‚  ë‘ê»˜
          this.MARGIN = 10; // íŒ¨ë„ ê°€ì¥ìë¦¬ ì—¬ìœ 
        }

        // ========================================
        // ë©”ì¸: ìì¬ ë¶„ë¥˜ ë° ì¬ë‹¨ ìµœì í™”
        // ========================================
        process(materials) {
          // 1. ìì¬ ê·¸ë£¹ ë¶„ë¥˜
          const grouped = this.classifyMaterials(materials);

          // 2. ê·¸ë£¹1 ì¬ë‹¨ ìµœì í™” (ì¸¡íŒ, ì§€íŒ ë“±)
          const nestingResult = this.optimizeNesting(grouped.group1);

          // 3. ê²°ê³¼ ë°˜í™˜
          return {
            group1: grouped.group1, // ì¬ë‹¨ ëŒ€ìƒ
            group2: grouped.group2, // ì„œëì¬ (ì¬ê³ )
            group3: grouped.group3, // ë³´ê°•ëª©/ì«„ëŒ€ (ì¬ê³ )
            doors: grouped.doors, // ë„ì–´ì¬
            backs: grouped.backs, // ë’·íŒ
            eps: grouped.eps, // EP (ê±¸ë ˆë°›ì´ ë“±)
            nesting: nestingResult, // ì¬ë‹¨ ê²°ê³¼
            summary: this.calculateSummary(grouped, nestingResult),
          };
        }

        // ========================================
        // ìì¬ ê·¸ë£¹ ë¶„ë¥˜
        // ========================================
        classifyMaterials(materials) {
          const result = {
            group1: [], // ì¸¡íŒ, ì§€íŒ, ì²œíŒ, ì„ ë°˜, ì¤‘ê°„ì¹¸ë§‰ì´
            group2: [], // ì„œëì¬ (H: 60, 120, 180)
            group3: [], // ë³´ê°•ëª©, ì«„ëŒ€, ë°´ë“œ (W: 60, 70)
            doors: [], // ë„ì–´
            backs: [], // ë’·íŒ
            eps: [], // EP (ê±¸ë ˆë°›ì´, íœ ë¼, ëª©ì°¬ë„¬, ìƒëª°ë”©, ì¢ŒëŒ€)
          };

          materials.forEach((m) => {
            const part = m.part;
            const h = m.h;
            const w = m.w;

            // ë„ì–´
            if (part.includes('ë„ì–´')) {
              result.doors.push(m);
            }
            // ë’·íŒ
            else if (part.includes('ë’·íŒ')) {
              result.backs.push(m);
            }
            // EPë¥˜
            else if (['ê±¸ë ˆë°›ì´', 'íœ ë¼', 'ëª©ì°¬ë„¬', 'ìƒëª°ë”©', 'ì¢ŒëŒ€'].some((ep) => part.includes(ep))) {
              result.eps.push(m);
            }
            // ê·¸ë£¹2: ì„œëì¬ (ë†’ì´ 60, 120, 180)
            else if (part.includes('ì„œë') || [60, 120, 180].includes(h)) {
              result.group2.push(m);
            }
            // ê·¸ë£¹3: ë³´ê°•ëª©, ì«„ëŒ€, ë°´ë“œ (í­ 60, 70)
            else if (part.includes('ë°´ë“œ') || part.includes('ë³´ê°•') || part.includes('ì«„ëŒ€') || [60, 70].includes(w)) {
              result.group3.push(m);
            }
            // ê·¸ë£¹1: ì¸¡íŒ, ì§€íŒ, ì²œíŒ, ì„ ë°˜ ë“± (ì¬ë‹¨ ëŒ€ìƒ)
            else {
              result.group1.push(m);
            }
          });

          return result;
        }

        // ========================================
        // ê·¸ë£¹1 ì¬ë‹¨ ìµœì í™” (Guillotine Cut)
        // ========================================
        optimizeNesting(parts) {
          if (!parts || parts.length === 0) {
            return { sheets: [], totalSheets: 0, efficiency: 0 };
          }

          // ìì¬+ë‘ê»˜ë³„ ë¶„ë¥˜
          const byMaterial = {};
          parts.forEach((p) => {
            const key = `${p.material}_${p.thickness}T`;
            if (!byMaterial[key]) byMaterial[key] = [];
            // ìˆ˜ëŸ‰ë§Œí¼ ê°œë³„ ë¶€í’ˆìœ¼ë¡œ í™•ì¥
            for (let i = 0; i < p.qty; i++) {
              byMaterial[key].push({
                ...p,
                partId: `${p.module}_${p.part}_${i + 1}`,
                qty: 1,
              });
            }
          });

          const allSheets = [];

          // ìì¬ë³„ ì¬ë‹¨
          Object.entries(byMaterial).forEach(([matKey, matParts]) => {
            const [material, thickness] = matKey.split('_');
            const sheets = this.nestParts(matParts, material, thickness);
            allSheets.push(...sheets);
          });

          // ì „ì²´ íš¨ìœ¨ ê³„ì‚°
          let totalUsed = 0,
            totalPanel = 0;
          allSheets.forEach((s) => {
            totalUsed += s.usedArea;
            totalPanel += this.PANEL_W * this.PANEL_H;
          });

          return {
            sheets: allSheets,
            totalSheets: allSheets.length,
            efficiency: totalPanel > 0 ? Math.round((totalUsed / totalPanel) * 1000) / 10 : 0,
          };
        }

        // ========================================
        // Guillotine Nesting (ìµœì†Œ ì¬ë‹¨ íšŸìˆ˜)
        // ========================================
        nestParts(parts, material, thickness) {
          const sheets = [];

          // ë©´ì  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (í° ê²ƒ ë¨¼ì €)
          const sorted = [...parts].sort((a, b) => {
            const areaA = a.w * a.h;
            const areaB = b.w * b.h;
            if (areaA !== areaB) return areaB - areaA;
            return b.h - a.h; // ë†’ì´ í° ê²ƒ ìš°ì„ 
          });

          const remaining = [...sorted];

          while (remaining.length > 0) {
            const sheet = this.createSheet(material, thickness);

            // ì‚¬ìš© ê°€ëŠ¥í•œ ì˜ì—­ ì´ˆê¸°í™”
            sheet.freeRects = [
              {
                x: this.MARGIN,
                y: this.MARGIN,
                w: this.PANEL_W - this.MARGIN * 2,
                h: this.PANEL_H - this.MARGIN * 2,
              },
            ];

            // ë¶€í’ˆ ë°°ì¹˜
            const placed = [];
            for (let i = remaining.length - 1; i >= 0; i--) {
              const part = remaining[i];
              const placement = this.placePart(sheet, part);
              if (placement) {
                sheet.placements.push(placement);
                placed.push(i);
              }
            }

            // ë°°ì¹˜ëœ ë¶€í’ˆ ì œê±°
            placed.forEach((idx) => remaining.splice(idx, 1));

            // ì¬ë‹¨ì„  ê³„ì‚°
            sheet.cuts = this.calculateCuts(sheet.placements);

            // ì‚¬ìš© ë©´ì  ê³„ì‚°
            sheet.usedArea = sheet.placements.reduce((sum, p) => sum + p.w * p.h, 0);
            sheet.efficiency = Math.round((sheet.usedArea / (this.PANEL_W * this.PANEL_H)) * 1000) / 10;

            sheets.push(sheet);

            // ë¬´í•œë£¨í”„ ë°©ì§€
            if (placed.length === 0) {
              console.warn('ë°°ì¹˜ ë¶ˆê°€ëŠ¥í•œ ë¶€í’ˆ:', remaining[0]);
              break;
            }
          }

          return sheets;
        }

        createSheet(material, thickness) {
          return {
            sheetId: Date.now() + Math.random(),
            material,
            thickness,
            width: this.PANEL_W,
            height: this.PANEL_H,
            placements: [],
            cuts: [],
            freeRects: [],
            usedArea: 0,
            efficiency: 0,
          };
        }

        // ========================================
        // ë¶€í’ˆ ë°°ì¹˜ (Best Fit)
        // ========================================
        placePart(sheet, part) {
          let bestRect = null;
          let bestFit = Infinity;
          let bestIdx = -1;

          // ê°€ì¥ ì í•©í•œ ë¹ˆ ê³µê°„ ì°¾ê¸°
          for (let i = 0; i < sheet.freeRects.length; i++) {
            const rect = sheet.freeRects[i];

            // íšŒì „ ì—†ì´ ë°°ì¹˜ ê°€ëŠ¥?
            if (part.w <= rect.w && part.h <= rect.h) {
              const fit = rect.w * rect.h - part.w * part.h;
              if (fit < bestFit) {
                bestFit = fit;
                bestRect = { ...rect, rotated: false };
                bestIdx = i;
              }
            }

            // íšŒì „í•´ì„œ ë°°ì¹˜ ê°€ëŠ¥? (ë’·íŒë§Œ íšŒì „ í—ˆìš©)
            if (part.part && part.part.includes('ë’·íŒ')) {
              if (part.h <= rect.w && part.w <= rect.h) {
                const fit = rect.w * rect.h - part.w * part.h;
                if (fit < bestFit) {
                  bestFit = fit;
                  bestRect = { ...rect, rotated: true };
                  bestIdx = i;
                }
              }
            }
          }

          if (!bestRect) return null;

          // ë¶€í’ˆ ë°°ì¹˜
          const placement = {
            partId: part.partId || `${part.module}_${part.part}`,
            name: part.part,
            module: part.module,
            x: bestRect.x,
            y: bestRect.y,
            w: bestRect.rotated ? part.h : part.w,
            h: bestRect.rotated ? part.w : part.h,
            originalW: part.w,
            originalH: part.h,
            rotated: bestRect.rotated,
            edge: part.edge,
            material: part.material,
            thickness: part.thickness,
          };

          // ë¹ˆ ê³µê°„ì—ì„œ ì œê±°
          sheet.freeRects.splice(bestIdx, 1);

          // Guillotine ë¶„í•  (ìµœì†Œ ì¬ë‹¨ íšŸìˆ˜ ìœ„í•´ ìˆ˜í‰ ìš°ì„ )
          this.splitRect(sheet, bestRect, placement);

          return placement;
        }

        // ========================================
        // Guillotine ë¶„í•  (ìˆ˜í‰ ìš°ì„  - ì¬ë‹¨ íšŸìˆ˜ ìµœì†Œí™”)
        // ========================================
        splitRect(sheet, rect, placement) {
          const rightW = rect.w - placement.w - this.KERF;
          const topH = rect.h - placement.h - this.KERF;

          // ìˆ˜í‰ ë¶„í•  ìš°ì„  (ê¸´ ìˆ˜í‰ì„  í•˜ë‚˜ë¡œ ì—¬ëŸ¬ ë¶€í’ˆ ì¬ë‹¨ ê°€ëŠ¥)
          if (topH > 50) {
            sheet.freeRects.push({
              x: rect.x,
              y: rect.y + placement.h + this.KERF,
              w: rect.w,
              h: topH,
            });
          }
          if (rightW > 50) {
            sheet.freeRects.push({
              x: rect.x + placement.w + this.KERF,
              y: rect.y,
              w: rightW,
              h: placement.h,
            });
          }

          // ë¹ˆ ê³µê°„ ì •ë ¬ (ì‘ì€ ê²ƒ ìš°ì„  ì‚¬ìš©)
          sheet.freeRects.sort((a, b) => a.w * a.h - b.w * b.h);
        }

        // ========================================
        // ì¬ë‹¨ì„  ê³„ì‚°
        // ========================================
        calculateCuts(placements) {
          const cuts = [];
          const horizontalY = new Set();
          const verticalX = new Set();

          placements.forEach((p) => {
            // ìˆ˜í‰ ì¬ë‹¨ì„  (ë¶€í’ˆ ìƒë‹¨)
            horizontalY.add(p.y + p.h + this.KERF / 2);
            // ìˆ˜ì§ ì¬ë‹¨ì„  (ë¶€í’ˆ ìš°ì¸¡)
            verticalX.add(p.x + p.w + this.KERF / 2);
          });

          horizontalY.forEach((y) => {
            if (y < this.PANEL_H - this.MARGIN) {
              cuts.push({ type: 'horizontal', y, x1: 0, x2: this.PANEL_W });
            }
          });

          verticalX.forEach((x) => {
            if (x < this.PANEL_W - this.MARGIN) {
              cuts.push({ type: 'vertical', x, y1: 0, y2: this.PANEL_H });
            }
          });

          return cuts;
        }

        // ========================================
        // ìš”ì•½ ê³„ì‚°
        // ========================================
        calculateSummary(grouped, nesting) {
          const countParts = (arr) => arr.reduce((sum, p) => sum + (p.qty || 1), 0);

          return {
            group1Count: countParts(grouped.group1),
            group2Count: countParts(grouped.group2),
            group3Count: countParts(grouped.group3),
            doorCount: countParts(grouped.doors),
            backCount: countParts(grouped.backs),
            epCount: countParts(grouped.eps),
            totalSheets: nesting.totalSheets,
            efficiency: nesting.efficiency,
          };
        }

        // ========================================
        // Canvas ë Œë”ë§ (ì¬ë‹¨ ë„ë©´)
        // ========================================
        renderSheet(canvas, sheet, scale = 0.25) {
          const ctx = canvas.getContext('2d');
          const W = this.PANEL_W * scale;
          const H = this.PANEL_H * scale;

          canvas.width = W + 40;
          canvas.height = H + 60;

          ctx.fillStyle = '#f5f5f5';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // íŒ¨ë„ ë°°ê²½
          ctx.fillStyle = '#fff8e1';
          ctx.fillRect(20, 20, W, H);
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 2;
          ctx.strokeRect(20, 20, W, H);

          // íŒ¨ë„ í¬ê¸° í‘œì‹œ
          ctx.fillStyle = '#333';
          ctx.font = '11px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`${this.PANEL_W}mm`, 20 + W / 2, 15);
          ctx.save();
          ctx.translate(12, 20 + H / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.fillText(`${this.PANEL_H}mm`, 0, 0);
          ctx.restore();

          // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
          const colors = ['#81d4fa', '#a5d6a7', '#ffe082', '#ef9a9a', '#ce93d8', '#80cbc4', '#ffcc80', '#b39ddb'];

          // ë¶€í’ˆ ë Œë”ë§
          sheet.placements.forEach((p, idx) => {
            const x = 20 + p.x * scale;
            const y = 20 + (this.PANEL_H - p.y - p.h) * scale; // Yì¶• ë°˜ì „
            const w = p.w * scale;
            const h = p.h * scale;

            // ë¶€í’ˆ ë°°ê²½
            ctx.fillStyle = colors[idx % colors.length];
            ctx.fillRect(x, y, w, h);

            // ë¶€í’ˆ í…Œë‘ë¦¬
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);

            // ì—£ì§€ í‘œì‹œ
            this.renderEdge(ctx, x, y, w, h, p.edge);

            // ë¶€í’ˆëª…
            ctx.fillStyle = '#000';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const label = p.name.length > 6 ? p.name.substring(0, 6) : p.name;
            ctx.fillText(label, x + w / 2, y + h / 2 - 6);

            ctx.font = '9px Arial';
            ctx.fillText(`${p.originalW}Ã—${p.originalH}`, x + w / 2, y + h / 2 + 6);
          });

          // ì¬ë‹¨ì„  ë Œë”ë§
          ctx.strokeStyle = '#e53935';
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 3]);

          sheet.cuts.forEach((cut) => {
            ctx.beginPath();
            if (cut.type === 'horizontal') {
              const y = 20 + (this.PANEL_H - cut.y) * scale;
              ctx.moveTo(20, y);
              ctx.lineTo(20 + W, y);
            } else {
              const x = 20 + cut.x * scale;
              ctx.moveTo(x, 20);
              ctx.lineTo(x, 20 + H);
            }
            ctx.stroke();
          });

          ctx.setLineDash([]);

          // ì •ë³´ í‘œì‹œ
          ctx.fillStyle = '#333';
          ctx.font = '11px Arial';
          ctx.textAlign = 'left';
          ctx.fillText(
            `${sheet.material} ${sheet.thickness}  |  íš¨ìœ¨: ${sheet.efficiency}%  |  ë¶€í’ˆ: ${sheet.placements.length}ê°œ  |  ì¬ë‹¨ì„ : ${sheet.cuts.length}ê°œ`,
            20,
            H + 50
          );
        }

        // ========================================
        // ì—£ì§€ í‘œì‹œ ë Œë”ë§
        // ========================================
        renderEdge(ctx, x, y, w, h, edge) {
          if (!edge || edge === '-') return;

          ctx.strokeStyle = '#d32f2f';
          ctx.lineWidth = 3;

          const edgeStr = edge.toString();

          // 4ë©´ ì—£ì§€
          if (edgeStr.includes('4ë©´')) {
            ctx.strokeRect(x + 1, y + 1, w - 2, h - 2);
            return;
          }

          // 1ë©´(ì „) - ì•ë©´ë§Œ
          if (edgeStr.includes('1ë©´(ì „)') || edgeStr.includes('1ë©´')) {
            ctx.beginPath();
            ctx.moveTo(x, y + h);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
            return;
          }

          // 2ë©´(ì¥) - ê¸´ë©´ 2ê°œ
          if (edgeStr.includes('2ë©´(ì¥)')) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + w, y);
            ctx.moveTo(x, y + h);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
            return;
          }

          // 2ë©´(ë‹¨) - ì§§ì€ë©´ 2ê°œ
          if (edgeStr.includes('2ë©´(ë‹¨)')) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + h);
            ctx.moveTo(x + w, y);
            ctx.lineTo(x + w, y + h);
            ctx.stroke();
          }
        }
      }

      // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
      const nestingOptimizer = new NestingOptimizer();

      // ============================================================
      // ì¬ë‹¨ ìµœì í™” UI
      // ============================================================
      function showNestingOptimizer() {
        const design = window.DadamAgent.exportDesign();
        if (!design.items || design.items.length === 0) {
          alert('ì„¤ê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ìì¬ ì¶”ì¶œ
        const matResult = materialExtractor.extract(design);
        if (!matResult.materials.length) {
          alert('ì¶”ì¶œëœ ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ì¬ë‹¨ ìµœì í™”
        const result = nestingOptimizer.process(matResult.materials);
        console.log('[Nesting] ê²°ê³¼:', result);

        // íŒì—… ìƒì„±
        showNestingModal(result, design);
      }

      function showNestingModal(result, design) {
        const existingModal = document.getElementById('nestingModal');
        if (existingModal) existingModal.remove();

        const item = design.items[0];
        const projectName = `${item.name || item.categoryId} ${item.w}Ã—${item.h}`;

        // ìì¬ í…Œì´ë¸” ìƒì„±
        const group1Table = generateMaterialTable(result.group1, 'ê·¸ë£¹1: ì¬ë‹¨ ëŒ€ìƒ (ì¸¡íŒ, ì§€íŒ, ì²œíŒ, ì„ ë°˜ ë“±)');
        const group2Table = generateMaterialTable(result.group2, 'ê·¸ë£¹2: ì„œëì¬ (ì¬ê³  ìš´ì˜)');
        const group3Table = generateMaterialTable(result.group3, 'ê·¸ë£¹3: ë³´ê°•ëª©/ì«„ëŒ€ (ì¬ê³  ìš´ì˜)');
        const doorTable = generateMaterialTable(result.doors, 'ë„ì–´ì¬');
        const backTable = generateMaterialTable(result.backs, 'ë’·íŒ');
        const epTable = generateMaterialTable(result.eps, 'EP (ê±¸ë ˆë°›ì´, íœ ë¼ ë“±)');

        // ì¬ë‹¨ ë„ë©´ ìº”ë²„ìŠ¤ ìƒì„±
        let sheetCanvases = '';
        if (result.nesting.sheets.length > 0) {
          result.nesting.sheets.forEach((sheet, idx) => {
            sheetCanvases += `
        <div style="margin-bottom:20px;padding:15px;background:#fafafa;border-radius:8px;">
          <h4 style="margin:0 0 10px 0;color:#1976d2;">ğŸ“ íŒ¨ë„ #${idx + 1} - ${sheet.material} ${sheet.thickness}</h4>
          <canvas id="nestingCanvas_${idx}" style="border:1px solid #ddd;border-radius:4px;"></canvas>
        </div>
      `;
          });
        } else {
          sheetCanvases = '<p style="color:#666;text-align:center;padding:40px;">ì¬ë‹¨ ëŒ€ìƒ ë¶€í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        const modal = document.createElement('div');
        modal.id = 'nestingModal';
        modal.innerHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);">
      <div style="background:white;border-radius:16px;width:95%;max-width:1200px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="background:linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);color:white;padding:18px 24px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:20px;display:flex;align-items:center;gap:10px;">ğŸªµ ì¬ë‹¨ ìµœì í™” - ${projectName}</h3>
          <button onclick="document.getElementById('nestingModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;">&times;</button>
        </div>
        
        <div style="display:flex;border-bottom:1px solid #e0e0e0;">
          <button class="nesting-tab active" onclick="switchNestingTab(this, 'summary')" style="flex:1;padding:12px;border:none;background:#e8f5e9;color:#2e7d32;font-weight:bold;cursor:pointer;">ğŸ“Š ìš”ì•½</button>
          <button class="nesting-tab" onclick="switchNestingTab(this, 'cutting')" style="flex:1;padding:12px;border:none;background:#f5f5f5;color:#666;font-weight:bold;cursor:pointer;">ğŸ“ ì¬ë‹¨ë„ë©´</button>
          <button class="nesting-tab" onclick="switchNestingTab(this, 'materials')" style="flex:1;padding:12px;border:none;background:#f5f5f5;color:#666;font-weight:bold;cursor:pointer;">ğŸ“‹ ì „ì²´ìì¬</button>
        </div>
        
        <div style="padding:20px;overflow-y:auto;max-height:calc(90vh - 180px);">
          <!-- ìš”ì•½ íƒ­ -->
          <div id="nesting-tab-summary" class="nesting-content">
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:15px;margin-bottom:20px;">
              <div style="background:linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.nesting.totalSheets}</div>
                <div style="font-size:12px;opacity:0.9;">í•„ìš” íŒ¨ë„ ìˆ˜</div>
              </div>
              <div style="background:linear-gradient(135deg, #66bb6a 0%, #43a047 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.nesting.efficiency}%</div>
                <div style="font-size:12px;opacity:0.9;">ì¬ë‹¨ íš¨ìœ¨</div>
              </div>
              <div style="background:linear-gradient(135deg, #ffca28 0%, #ffa000 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.summary.group1Count}</div>
                <div style="font-size:12px;opacity:0.9;">ì¬ë‹¨ ë¶€í’ˆ</div>
              </div>
              <div style="background:linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%);color:white;padding:20px;border-radius:12px;text-align:center;">
                <div style="font-size:32px;font-weight:bold;">${result.summary.doorCount}</div>
                <div style="font-size:12px;opacity:0.9;">ë„ì–´ ìˆ˜</div>
              </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
              <div style="background:#e3f2fd;padding:15px;border-radius:10px;">
                <h4 style="margin:0 0 10px 0;color:#1565c0;">ğŸ”§ ì¬ê³  ìš´ì˜ ë¶€í’ˆ</h4>
                <div style="font-size:13px;color:#333;">
                  <div style="margin-bottom:5px;">â€¢ ì„œëì¬ (ê·¸ë£¹2): <strong>${result.summary.group2Count}ê°œ</strong></div>
                  <div>â€¢ ë³´ê°•ëª©/ì«„ëŒ€ (ê·¸ë£¹3): <strong>${result.summary.group3Count}ê°œ</strong></div>
                </div>
              </div>
              <div style="background:#fce4ec;padding:15px;border-radius:10px;">
                <h4 style="margin:0 0 10px 0;color:#c2185b;">ğŸ“¦ ê¸°íƒ€ ìì¬</h4>
                <div style="font-size:13px;color:#333;">
                  <div style="margin-bottom:5px;">â€¢ ë’·íŒ: <strong>${result.summary.backCount}ê°œ</strong></div>
                  <div>â€¢ EP (ê±¸ë ˆë°›ì´ ë“±): <strong>${result.summary.epCount}ê°œ</strong></div>
                </div>
              </div>
            </div>
            
            <div style="margin-top:20px;background:#fff3e0;padding:15px;border-radius:10px;border:1px solid #ffe0b2;">
              <h4 style="margin:0 0 10px 0;color:#e65100;">ğŸ’¡ ì—£ì§€ í‘œì‹œ ì•ˆë‚´</h4>
              <div style="display:flex;gap:20px;font-size:12px;">
                <span><span style="display:inline-block;width:20px;height:3px;background:#d32f2f;vertical-align:middle;margin-right:5px;"></span> ë¹¨ê°„ êµµì€ì„  = ì—£ì§€ ì²˜ë¦¬ë©´</span>
                <span><span style="display:inline-block;width:20px;height:1px;background:#e53935;border-style:dashed;vertical-align:middle;margin-right:5px;"></span> ë¹¨ê°„ ì ì„  = ì¬ë‹¨ì„ </span>
              </div>
            </div>
          </div>
          
          <!-- ì¬ë‹¨ë„ë©´ íƒ­ -->
          <div id="nesting-tab-cutting" class="nesting-content" style="display:none;">
            ${sheetCanvases}
          </div>
          
          <!-- ì „ì²´ìì¬ íƒ­ -->
          <div id="nesting-tab-materials" class="nesting-content" style="display:none;">
            ${group1Table}
            ${doorTable}
            ${group2Table}
            ${group3Table}
            ${backTable}
            ${epTable}
          </div>
        </div>
        
        <div style="padding:15px 24px;border-top:1px solid #eee;background:#f9f9f9;display:flex;gap:10px;justify-content:space-between;">
          <div style="display:flex;gap:8px;">
            <button onclick="downloadNestingCSV()" style="background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">ğŸ“„ ì¬ë‹¨ëª©ë¡ CSV</button>
            <button onclick="downloadNestingPDF()" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">ğŸ“‹ ì¬ë‹¨ì§€ì‹œì„œ</button>
            <button onclick="printNestingSheets()" style="background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">ğŸ–¨ï¸ ì¸ì‡„</button>
          </div>
          <button onclick="document.getElementById('nestingModal').remove()" style="background:#eee;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:13px;">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        // ì „ì—­ ë°ì´í„° ì €ì¥
        window._nestingResult = result;

        // Canvas ë Œë”ë§
        setTimeout(() => {
          result.nesting.sheets.forEach((sheet, idx) => {
            const canvas = document.getElementById(`nestingCanvas_${idx}`);
            if (canvas) {
              nestingOptimizer.renderSheet(canvas, sheet, 0.28);
            }
          });
        }, 100);
      }

      // íƒ­ ì „í™˜
      function switchNestingTab(btn, tabId) {
        document.querySelectorAll('.nesting-tab').forEach((t) => {
          t.style.background = '#f5f5f5';
          t.style.color = '#666';
          t.classList.remove('active');
        });
        btn.style.background = '#e8f5e9';
        btn.style.color = '#2e7d32';
        btn.classList.add('active');

        document.querySelectorAll('.nesting-content').forEach((c) => (c.style.display = 'none'));
        document.getElementById('nesting-tab-' + tabId).style.display = 'block';

        // ì¬ë‹¨ë„ë©´ íƒ­ ì„ íƒì‹œ Canvas ë‹¤ì‹œ ë Œë”ë§
        if (tabId === 'cutting' && window._nestingResult) {
          setTimeout(() => {
            window._nestingResult.nesting.sheets.forEach((sheet, idx) => {
              const canvas = document.getElementById(`nestingCanvas_${idx}`);
              if (canvas) {
                nestingOptimizer.renderSheet(canvas, sheet, 0.28);
              }
            });
          }, 50);
        }
      }

      // ìì¬ í…Œì´ë¸” ìƒì„±
      function generateMaterialTable(materials, title) {
        if (!materials || materials.length === 0) {
          return `<div style="margin-bottom:20px;"><h4 style="color:#666;margin-bottom:10px;">${title}</h4><p style="color:#999;font-size:13px;">í•´ë‹¹ ìì¬ ì—†ìŒ</p></div>`;
        }

        let html = `
    <div style="margin-bottom:25px;">
      <h4 style="color:#333;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #4caf50;">${title}</h4>
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead style="background:#e8f5e9;">
          <tr>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">No</th>
            <th style="border:1px solid #ddd;padding:8px;">ëª¨ë“ˆ</th>
            <th style="border:1px solid #ddd;padding:8px;">ë¶€í’ˆ</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ìì¬</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ë‘ê»˜</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:right;">ê°€ë¡œ</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:right;">ì„¸ë¡œ</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ìˆ˜ëŸ‰</th>
            <th style="border:1px solid #ddd;padding:8px;text-align:center;">ì—£ì§€</th>
          </tr>
        </thead>
        <tbody>
  `;

        materials.forEach((m, idx) => {
          html += `
      <tr style="background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${idx + 1}</td>
        <td style="border:1px solid #ddd;padding:6px;">${m.module}</td>
        <td style="border:1px solid #ddd;padding:6px;">${m.part}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.material}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.thickness}T</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.w}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:right;">${m.h}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${m.qty}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;color:#d32f2f;font-weight:bold;">${m.edge}</td>
      </tr>
    `;
        });

        html += '</tbody></table></div>';
        return html;
      }

      // CSV ë‹¤ìš´ë¡œë“œ
      function downloadNestingCSV() {
        if (!window._nestingResult) return;

        const result = window._nestingResult;
        let csv = '\uFEFF'; // BOM
        csv += 'ê·¸ë£¹,ëª¨ë“ˆ,ë¶€í’ˆ,ìì¬,ë‘ê»˜,ê°€ë¡œ,ì„¸ë¡œ,ìˆ˜ëŸ‰,ì—£ì§€\n';

        const addRows = (group, groupName) => {
          group.forEach((m) => {
            csv += `${groupName},${m.module},${m.part},${m.material},${m.thickness},${m.w},${m.h},${m.qty},${m.edge}\n`;
          });
        };

        addRows(result.group1, 'ê·¸ë£¹1(ì¬ë‹¨)');
        addRows(result.doors, 'ë„ì–´ì¬');
        addRows(result.group2, 'ê·¸ë£¹2(ì„œë)');
        addRows(result.group3, 'ê·¸ë£¹3(ë³´ê°•)');
        addRows(result.backs, 'ë’·íŒ');
        addRows(result.eps, 'EP');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ì¬ë‹¨ëª©ë¡_${new Date().toISOString().slice(0, 10)}.csv`;
        a.click();
      }

      // ì¬ë‹¨ ì§€ì‹œì„œ (ê°„ë‹¨ ë²„ì „)
      function downloadNestingPDF() {
        if (!window._nestingResult) return;

        const result = window._nestingResult;
        let content = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        content += '              ë‹¤ë‹´ ê°€êµ¬ - ì¬ë‹¨ ì§€ì‹œì„œ\n';
        content += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        content += `ì‘ì„±ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}\n`;
        content += `í•„ìš” íŒ¨ë„: ${result.nesting.totalSheets}ì¥  |  íš¨ìœ¨: ${result.nesting.efficiency}%\n`;
        content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n';

        result.nesting.sheets.forEach((sheet, idx) => {
          content += `[íŒ¨ë„ #${idx + 1}] ${sheet.material} ${sheet.thickness} (${sheet.width}Ã—${sheet.height}mm)\n`;
          content += `íš¨ìœ¨: ${sheet.efficiency}%  |  ì¬ë‹¨ì„ : ${sheet.cuts.length}ê°œ\n`;
          content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

          sheet.placements.forEach((p, pIdx) => {
            content += `  ${pIdx + 1}. ${p.name} (${p.originalW}Ã—${p.originalH})\n`;
            content += `     ìœ„ì¹˜: X=${p.x}, Y=${p.y}  |  ì—£ì§€: ${p.edge}\n`;
            content += `     ëª¨ë“ˆ: ${p.module}\n\n`;
          });
          content += '\n';
        });

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ì¬ë‹¨ì§€ì‹œì„œ_${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
      }

      // ì¸ì‡„
      function printNestingSheets() {
        window.print();
      }

      // ============================================================
      // Supabase ì¸ì¦ ë° ë°ì´í„° ì €ì¥ ì‹œìŠ¤í…œ
      // ============================================================
      // (Supabase ì„¤ì •ì€ js/supabase-utils.jsì—ì„œ ê´€ë¦¬)

      // n8n Webhook URL (ì„¤ì • í•„ìš”)
      const N8N_WEBHOOK_URL = ''; // ì˜ˆ: 'https://your-n8n.com/webhook/design-save'

      // AI ë””ìì¸ ìƒì„± API URL (ì„¤ê³„ ë°ì´í„° ê¸°ë°˜ - Fast Generation)
      // Cloudflare Proxy ê²½ìœ  (CORS í•´ê²°)
      const N8N_AI_DESIGN_URL = 'https://dadam-proxy.dadamfurniture.workers.dev/webhook/design-to-image';
      const N8N_CHAT_URL = 'https://dadam.app.n8n.cloud/webhook/chat';

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ì±„íŒ… ê¸°ë¡ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (Supabase)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // ì„¸ì…˜ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸° (ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ììš©)
      function getChatSessionId() {
        let sessionId = sessionStorage.getItem('chat_session_id');
        if (!sessionId) {
          sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('chat_session_id', sessionId);
        }
        return sessionId;
      }

      // ë©”ì‹œì§€ ì €ì¥
      async function saveChatMessage(content, role) {
        if (!supabaseClient) return;

        try {
          const userId = currentUser?.id || null;
          const sessionId = userId ? null : getChatSessionId();

          await supabaseClient.from('chat_messages').insert({
            user_id: userId,
            session_id: sessionId,
            role: role,
            content: content,
            page_source: 'detail-design'
          });
        } catch (error) {
          console.log('ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:', error.message);
        }
      }

      // ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadChatHistory() {
        if (!supabaseClient) return;

        try {
          const userId = currentUser?.id;
          const sessionId = getChatSessionId();

          let query = supabaseClient
            .from('chat_messages')
            .select('*')
            .eq('page_source', 'detail-design')
            .order('created_at', { ascending: true })
            .limit(50);

          if (userId) {
            query = query.eq('user_id', userId);
          } else {
            query = query.eq('session_id', sessionId);
          }

          const { data, error } = await query;

          if (error) throw error;

          if (data && data.length > 0) {
            data.forEach(msg => {
              addChatMessage(msg.content, msg.role === 'user', null, false);
            });
          }
        } catch (error) {
          console.log('ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error.message);
        }
      }

      // ì´ë¯¸ì§€ë¥¼ Supabase Storageì— ì—…ë¡œë“œ (SupabaseUtils ìœ„ì„)
      async function uploadImageToStorage(file, userId) {
        return SupabaseUtils.uploadImage(file, userId);
      }

      let supabaseClient = null;
      let currentUser = null;
      let userProfile = null;
      let currentDesignId = null;
      let autoSaveTimer = null;
      let hasUnsavedChanges = false;

      // Supabase ì´ˆê¸°í™” ë° ì¸ì¦ í™•ì¸ (SupabaseUtils í†µí•©)
      async function initAuth() {
        // SupabaseUtils ì‚¬ìš© (js/supabase-utils.js)
        const session = await SupabaseUtils.init();

        // ë¡œì»¬ ì°¸ì¡° ë™ê¸°í™” (í•˜ìœ„ í˜¸í™˜ì„±)
        supabaseClient = SupabaseUtils.client;

        if (!session) {
          showAuthOverlay();
          return;
        }

        currentUser = SupabaseUtils.currentUser;
        await loadUserProfile();
      }

      // ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ
      async function loadUserProfile() {
        // profiles í…Œì´ë¸”ì—ì„œ ì¡°íšŒ (ë˜ëŠ” auth.users metadata ì‚¬ìš©)
        try {
          const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();

          if (!error && data) {
            userProfile = data;
          } else {
            // profiles í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ auth.users metadata ì‚¬ìš©
            userProfile = {
              id: currentUser.id,
              email: currentUser.email,
              tier: currentUser.user_metadata?.tier || 'standard',
              name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
            };
          }
        } catch (e) {
          // í´ë°±: auth.users metadata ì‚¬ìš©
          userProfile = {
            id: currentUser.id,
            email: currentUser.email,
            tier: currentUser.user_metadata?.tier || 'standard',
            name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
          };
        }

        // ì¸ì¦ ì„±ê³µ - UI ì—…ë°ì´íŠ¸ (ë“±ê¸‰ ì œí•œ ì œê±° - ai-design.htmlì—ì„œ ë¦¬ë””ë ‰íŠ¸ ì²˜ë¦¬)
        hideAuthOverlay();
        document.getElementById('toolbarUser').textContent = currentUser.email;

        // ë„¤ë¹„ê²Œì´ì…˜ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        const name = userProfile.name || currentUser.email.split('@')[0];
        document.getElementById('navUserAvatar').textContent = name.charAt(0).toUpperCase();
        document.getElementById('navUserName').textContent = name;

        // URLì—ì„œ ì„¤ê³„ ID í™•ì¸ (ìˆ˜ì • ëª¨ë“œ)
        const urlParams = new URLSearchParams(window.location.search);
        const designId = urlParams.get('id');
        if (designId) {
          await loadDesign(designId);
        }

        // ìë™ ì €ì¥ ì„¤ì • (5ë¶„ë§ˆë‹¤)
        setupAutoSave();

        // ì´ì „ ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadChatHistory();
      }

      // ì¸ì¦ ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
      function showAuthOverlay() {
        document.getElementById('authOverlay').classList.remove('hidden');
        document.getElementById('topToolbar').classList.add('hidden');
      }

      function hideAuthOverlay() {
        document.getElementById('authOverlay').classList.add('hidden');
        document.getElementById('topToolbar').classList.remove('hidden');
      }

      // ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€
      function toggleMobileMenu() {
        const hamburger = document.querySelector('.hamburger');
        const mobileMenu = document.getElementById('mobileMenu');
        hamburger.classList.toggle('active');
        mobileMenu.classList.toggle('active');
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ë¡œê·¸ì•„ì›ƒ
      async function logoutNav() {
        await SupabaseUtils.signOut('index.html');
      }

      // ì„¤ê³„ ì €ì¥
      async function saveDesign() {
        if (!currentUser || !supabaseClient) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        if (selectedItems.length === 0) {
          alert('ì €ì¥í•  ì„¤ê³„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        updateSaveStatus('saving', 'ì €ì¥ ì¤‘...');

        try {
          // ì„¤ê³„ ë°ì´í„° ì¤€ë¹„
          const designData = window.DadamAgent.exportDesign();
          const designName = prompt(
            'ì„¤ê³„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:',
            currentDesignId ? 'ê¸°ì¡´ ì„¤ê³„' : `ì„¤ê³„_${new Date().toLocaleDateString('ko-KR')}`
          );

          if (!designName) {
            updateSaveStatus('saved', 'ì €ì¥ë¨');
            return;
          }

          // ì‹ ê·œ ë˜ëŠ” ì—…ë°ì´íŠ¸
          if (currentDesignId) {
            // ê¸°ì¡´ ì„¤ê³„ ì—…ë°ì´íŠ¸
            const { error } = await supabaseClient
              .from('designs')
              .update({
                name: designName,
                total_items: selectedItems.length,
                total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
                app_version: APP_CONFIG.version,
                updated_at: new Date().toISOString(),
              })
              .eq('id', currentDesignId);

            if (error) throw error;

            // ê¸°ì¡´ ì•„ì´í…œ ì‚­ì œ í›„ ì¬ì‚½ì…
            await supabaseClient.from('design_items').delete().eq('design_id', currentDesignId);

            await saveDesignItems(currentDesignId);
          } else {
            // ì‹ ê·œ ì„¤ê³„ ìƒì„±
            const { data: newDesign, error } = await supabaseClient
              .from('designs')
              .insert({
                user_id: currentUser.id,
                name: designName,
                status: 'draft',
                total_items: selectedItems.length,
                total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
                app_version: APP_CONFIG.version,
              })
              .select()
              .single();

            if (error) throw error;

            currentDesignId = newDesign.id;
            await saveDesignItems(currentDesignId);

            // URL ì—…ë°ì´íŠ¸
            window.history.replaceState({}, '', `?id=${currentDesignId}`);
          }

          // n8n Webhook í˜¸ì¶œ (ì„¤ì •ëœ ê²½ìš°)
          if (N8N_WEBHOOK_URL) {
            await sendToN8N(designData);
          }

          hasUnsavedChanges = false;
          updateSaveStatus('saved', 'ì €ì¥ë¨');
        } catch (error) {
          console.error('ì €ì¥ ì‹¤íŒ¨:', error);
          updateSaveStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ì„¤ê³„ ì•„ì´í…œ ì €ì¥
      async function saveDesignItems(designId) {
        const itemsToInsert = selectedItems.map((item, index) => ({
          design_id: designId,
          category: item.category || item.categoryId,
          name: item.name,
          unique_id: Math.floor(item.uniqueId), // bigint í˜¸í™˜ì„ ìœ„í•´ ì •ìˆ˜ë¡œ ë³€í™˜
          width: item.w,
          height: item.h,
          depth: item.d,
          specs: {
            ...(item.specs || {}),
            imageUrl: (item.imageUrl || item.image) !== 'loading' ? item.imageUrl || item.image || null : null,
          },
          modules: item.modules || [],
          item_order: index,
        }));

        const { error } = await supabaseClient.from('design_items').insert(itemsToInsert);

        if (error) throw error;
      }

      // ì„¤ê³„ ë¶ˆëŸ¬ì˜¤ê¸°
      async function loadDesign(designId) {
        try {
          // ì„¤ê³„ ë©”íƒ€ ì •ë³´
          const { data: design, error: designError } = await supabaseClient
            .from('designs')
            .select('*')
            .eq('id', designId)
            .eq('user_id', currentUser.id)
            .single();

          if (designError || !design) {
            throw new Error('ì„¤ê³„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ì„¤ê³„ ì•„ì´í…œ
          const { data: items, error: itemsError } = await supabaseClient
            .from('design_items')
            .select('*')
            .eq('design_id', designId)
            .order('item_order');

          if (itemsError) throw itemsError;

          // ë°ì´í„° ë³µì›
          currentDesignId = designId;
          selectedItems = items.map((item) => ({
            uniqueId: item.unique_id || Date.now(),
            category: item.category,
            categoryId: item.category,
            name: item.name,
            w: item.width,
            h: item.height,
            d: item.depth,
            specs: item.specs || { ...DEFAULT_SPECS },
            modules: item.modules || [],
            image: item.specs?.imageUrl || item.specs?.image || null,
            imageUrl: item.specs?.imageUrl || item.specs?.image || null,
          }));

          // UI ì—…ë°ì´íŠ¸
          updateUI();
          updateSaveStatus('saved', 'ë¶ˆëŸ¬ì˜´');
        } catch (error) {
          console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
          alert('ì„¤ê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ì„¤ê³„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (íŒì—… ëª¨ë‹¬)
      async function loadDesignList() {
        if (!currentUser || !supabaseClient) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return;
        }

        try {
          const { data: designs, error } = await supabaseClient
            .from('designs')
            .select('id, name, status, total_items, total_modules, created_at, updated_at')
            .eq('user_id', currentUser.id)
            .order('updated_at', { ascending: false })
            .limit(30);

          if (error) throw error;

          // ëª¨ë‹¬ ìƒì„±
          const modal = document.createElement('div');
          modal.className = 'load-modal-overlay';
          modal.id = 'loadDesignModal';
          modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
          };

          const statusLabels = {
            draft: 'ì„ì‹œì €ì¥',
            submitted: 'ì œì¶œë¨',
            in_review: 'ê²€í† ì¤‘',
            completed: 'ì™„ë£Œ',
            feedback_done: 'í”¼ë“œë°±ì™„ë£Œ',
          };

          modal.innerHTML = `
      <div class="load-modal">
        <div class="load-modal-header">
          <h3>ğŸ“‚ ì €ì¥ëœ ì„¤ê³„ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
          <button class="load-modal-close" onclick="closeLoadModal()">&times;</button>
        </div>
        <div class="load-modal-body">
          ${
            designs.length === 0
              ? `
            <div class="load-modal-empty">
              <div style="font-size:48px;margin-bottom:16px;">ğŸ“‹</div>
              <p>ì €ì¥ëœ ì„¤ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          `
              : designs
                  .map(
                    (d) => `
            <div class="design-list-item" onclick="selectDesign('${d.id}')">
              <div class="info">
                <div class="name">${d.name || 'ì œëª© ì—†ìŒ'}</div>
                <div class="meta">
                  <span>ğŸª‘ ${d.total_items || 0}ê°œ ê°€êµ¬</span>
                  <span>ğŸ“… ${new Date(d.updated_at).toLocaleDateString('ko-KR')}</span>
                  <span class="status ${d.status}">${statusLabels[d.status] || d.status}</span>
                </div>
              </div>
              <button class="delete-btn" onclick="event.stopPropagation();deleteDesignFromList('${d.id}','${(d.name || '').replace(/'/g, "\\'")}')">ğŸ—‘ï¸</button>
            </div>
          `
                  )
                  .join('')
          }
        </div>
      </div>
    `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ì„¤ê³„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ ë‹«ê¸°
      function closeLoadModal() {
        const modal = document.getElementById('loadDesignModal');
        if (modal) modal.remove();
      }

      // ì„¤ê³„ ì„ íƒ (ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°)
      function selectDesign(designId) {
        closeLoadModal();
        window.open(`detaildesign.html?id=${designId}`, '_blank');
      }

      // ì„¤ê³„ ì‚­ì œ (ëª©ë¡ì—ì„œ)
      async function deleteDesignFromList(designId, designName) {
        if (!confirm(`"${designName}" ì„¤ê³„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì„¤ê³„ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

        try {
          const { error } = await supabaseClient
            .from('designs')
            .delete()
            .eq('id', designId)
            .eq('user_id', currentUser.id);

          if (error) throw error;

          // ëª¨ë‹¬ì—ì„œ í•´ë‹¹ í•­ëª© ì œê±°
          const item = document.querySelector(`.design-list-item[onclick*="${designId}"]`);
          if (item) item.remove();

          // ëª©ë¡ì´ ë¹„ì—ˆìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
          const body = document.querySelector('.load-modal-body');
          if (body && !body.querySelector('.design-list-item')) {
            body.innerHTML = `
        <div class="load-modal-empty">
          <div style="font-size:48px;margin-bottom:16px;">ğŸ“‹</div>
          <p>ì €ì¥ëœ ì„¤ê³„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      `;
          }

          // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì„¤ê³„ê°€ ì‚­ì œëœ ê²½ìš°
          if (currentDesignId === designId) {
            currentDesignId = null;
            hasUnsavedChanges = true;
          }
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì„¤ê³„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì„¤ê³„ ì œì¶œ (ê²€í†  ìš”ì²­)
      async function submitDesign() {
        if (!currentDesignId) {
          alert('ë¨¼ì € ì„¤ê³„ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!confirm('ì„¤ê³„ë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì œì¶œ í›„ì—ë„ ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.')) return;

        try {
          const { error } = await supabaseClient
            .from('designs')
            .update({
              status: 'submitted',
              submitted_at: new Date().toISOString(),
            })
            .eq('id', currentDesignId);

          if (error) throw error;

          // n8nìœ¼ë¡œ ì œì¶œ ì•Œë¦¼
          if (N8N_WEBHOOK_URL) {
            const designData = window.DadamAgent.exportDesign();
            await sendToN8N({ ...designData, action: 'submit', designId: currentDesignId });
          }

          alert('ì„¤ê³„ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ì œì¶œ ì‹¤íŒ¨:', error);
          alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // n8n Webhook ì „ì†¡
      async function sendToN8N(data) {
        if (!N8N_WEBHOOK_URL) return;

        try {
          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              timestamp: new Date().toISOString(),
              userId: currentUser.id,
              userEmail: currentUser.email,
              designId: currentDesignId,
              appVersion: APP_CONFIG.version,
              data: data,
            }),
          });

          if (!response.ok) {
            console.warn('n8n Webhook ì‘ë‹µ ì˜¤ë¥˜:', response.status);
          }
        } catch (error) {
          console.warn('n8n Webhook ì „ì†¡ ì‹¤íŒ¨:', error);
        }
      }

      // ì €ì¥ ìƒíƒœ UI ì—…ë°ì´íŠ¸
      function updateSaveStatus(status, text) {
        const statusEl = document.getElementById('saveStatus');
        const iconEl = document.getElementById('saveStatusIcon');
        const textEl = document.getElementById('saveStatusText');

        statusEl.classList.remove('hidden', 'saving', 'saved', 'error');
        statusEl.classList.add(status);

        if (status === 'saving') {
          iconEl.textContent = 'â³';
        } else if (status === 'saved') {
          iconEl.textContent = 'âœ“';
        } else if (status === 'error') {
          iconEl.textContent = 'âœ•';
        }

        textEl.textContent = text;
      }

      // ìë™ ì €ì¥ ì„¤ì •
      function setupAutoSave() {
        // ë³€ê²½ ê°ì§€
        const originalUpdateUI = window.updateUI;
        window.updateUI = function () {
          if (originalUpdateUI) originalUpdateUI.apply(this, arguments);
          hasUnsavedChanges = true;
          updateSaveStatus('saving', 'ìˆ˜ì •ë¨');
        };

        // 5ë¶„ë§ˆë‹¤ ìë™ ì €ì¥
        autoSaveTimer = setInterval(
          () => {
            if (hasUnsavedChanges && currentDesignId) {
              console.log('ìë™ ì €ì¥ ì‹¤í–‰...');
              // ìë™ ì €ì¥ì€ ì¡°ìš©íˆ ì‹¤í–‰
              saveDesignQuiet();
            }
          },
          5 * 60 * 1000
        );

        // í˜ì´ì§€ ë– ë‚  ë•Œ ê²½ê³ 
        window.addEventListener('beforeunload', (e) => {
          if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
          }
        });
      }

      // ì¡°ìš©í•œ ì €ì¥ (í”„ë¡¬í”„íŠ¸ ì—†ì´)
      async function saveDesignQuiet() {
        if (!currentUser || !supabaseClient || !currentDesignId) return;

        try {
          await supabaseClient
            .from('designs')
            .update({
              total_items: selectedItems.length,
              total_modules: selectedItems.reduce((sum, item) => sum + (item.modules?.length || 0), 0),
              updated_at: new Date().toISOString(),
            })
            .eq('id', currentDesignId);

          await supabaseClient.from('design_items').delete().eq('design_id', currentDesignId);

          await saveDesignItems(currentDesignId);

          hasUnsavedChanges = false;
          updateSaveStatus('saved', 'ìë™ ì €ì¥ë¨');
        } catch (error) {
          console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);
        }
      }

      // ============================================================
      // AI ì±„íŒ… ì‹œìŠ¤í…œ
      // ============================================================
      function toggleAIChat() {
        const panel = document.getElementById('aiChatPanel');
        const btn = document.getElementById('aiChatToggle');
        if (panel.style.display === 'none' || !panel.style.display) {
          panel.style.display = 'flex';
          btn.innerHTML = 'âœ•';
          btn.style.background = '#2D2A26';
        } else {
          panel.style.display = 'none';
          btn.innerHTML = 'ğŸ’¬ AI ìƒë‹´';
          btn.style.background = 'linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%)';
        }
      }

      async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ ë° ì €ì¥
        addChatMessage(message, true);
        input.value = '';

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        addChatMessage(
          '<div style="display:flex;align-items:center;gap:8px;"><span class="chat-loading"></span> ì‘ë‹µ ì¤‘...</div>',
          false,
          loadingId,
          false
        );

        // í˜„ì¬ ì„¤ê³„ ë°ì´í„° í¬í•¨
        const design = window.DadamAgent?.exportDesign() || { items: [] };

        try {
          const response = await fetch(N8N_CHAT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: message,
              context: {
                page: 'detaildesign',
                designData: design,
                itemCount: design.items?.length || 0,
              },
            }),
          });

          // ë¡œë”© ë©”ì‹œì§€ ì œê±°
          const loadingMsg = document.getElementById(loadingId);
          if (loadingMsg) loadingMsg.remove();

          const data = await response.json();
          const aiResponse = data.response || data.output || 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          addChatMessage(aiResponse, false);
        } catch (error) {
          // ë¡œë”© ë©”ì‹œì§€ ì œê±°
          const loadingMsg = document.getElementById(loadingId);
          if (loadingMsg) loadingMsg.remove();
          addChatMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
        }
      }

      function addChatMessage(text, isUser, msgId, shouldSave = true) {
        const container = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        if (msgId) msg.id = msgId;
        msg.className = `chat-msg ${isUser ? 'user' : 'ai'}`;
        msg.innerHTML = text;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;

        // DBì— ì €ì¥ (shouldSaveê°€ trueì¼ ë•Œë§Œ)
        if (shouldSave && !msgId) {
          saveChatMessage(text, isUser ? 'user' : 'assistant');
        }
      }

      // ============================================================
      // ìµœì í™”: ì´ë²¤íŠ¸ ìœ„ì„ í•¸ë“¤ëŸ¬
      // ============================================================

      function setupEventDelegation() {
        const workspace = document.getElementById('step2-content');
        if (!workspace) return;

        // í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
        workspace.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-action]');
          if (!btn) return;

          const { action, item, mod, field, delta, value } = btn.dataset;
          const itemId = parseInt(item);
          const modId = parseInt(mod);

          switch (action) {
            case 'adjust':
              adjustModuleValue(itemId, modId, field, parseInt(delta));
              break;
            case 'setType':
              setModuleType(itemId, modId, field, value);
              break;
            case 'toggle':
              toggleModuleOption(
                itemId,
                modId,
                field,
                btn.checked !== undefined ? btn.checked : !btn.classList.contains('active')
              );
              break;
            // Wardrobe ì „ìš© ì•¡ì…˜
            case 'moveWdrb':
              moveWardrobeModule(itemId, modId, btn.dataset.dir);
              break;
            case 'setWdrbType':
              setWardrobeModuleType(itemId, modId, btn.dataset.type);
              break;
            case 'removeWdrb':
              removeWardrobeModule(itemId, modId);
              break;
            case 'setDrawerType':
              toggleWardrobeDrawerType(itemId, modId, btn.dataset.value === 'true');
              break;
          }
        });

        // Change ì´ë²¤íŠ¸ ìœ„ì„ (input, select)
        workspace.addEventListener('change', (e) => {
          const input = e.target;
          if (!input.dataset.item) return;

          const { item, mod, field } = input.dataset;
          const itemId = parseInt(item);
          const modId = mod ? parseInt(mod) : null;
          const value = input.type === 'checkbox' ? input.checked : input.value;

          if (modId) {
            updateModuleField(itemId, modId, field, value);
          } else if (field) {
            updateItemSpec(itemId, field, value);
          }
        });

        // Input ì´ë²¤íŠ¸ ìœ„ì„ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
        workspace.addEventListener('input', (e) => {
          const input = e.target;
          if (!input.dataset.item || input.type === 'checkbox') return;

          // ë””ë°”ìš´ìŠ¤ ì²˜ë¦¬
          clearTimeout(input._debounceTimer);
          input._debounceTimer = setTimeout(() => {
            const { item, mod, field } = input.dataset;
            const itemId = parseInt(item);
            const modId = mod ? parseInt(mod) : null;

            if (modId) {
              updateModuleField(itemId, modId, field, input.value, false);
            } else if (field) {
              updateItemSpec(itemId, field, input.value, false);
            }
          }, 300);
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        initAuth();
        setupEventDelegation();
      });
    </script>

    <!-- AI ì±„íŒ… í† ê¸€ ë²„íŠ¼ -->
    <button
      id="aiChatToggle"
      onclick="toggleAIChat()"
      style="
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        padding: 14px 24px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
        border: none;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        transition: all 0.3s;
      "
    >
      ğŸ’¬ AI ìƒë‹´
    </button>

    <!-- AI ì±„íŒ… íŒ¨ë„ -->
    <div
      id="aiChatPanel"
      style="
        display: none;
        position: fixed;
        bottom: 90px;
        right: 24px;
        width: 360px;
        height: 500px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
        flex-direction: column;
        z-index: 1000;
        overflow: hidden;
      "
    >
      <div
        style="
          padding: 18px 20px;
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          color: #fff;
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <span style="font-weight: 600; font-size: 15px">ğŸ¤– ë‹¤ë‹´ AI ì„¤ê³„ ìƒë‹´</span>
        <button
          onclick="toggleAIChat()"
          style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; line-height: 1"
        >
          âœ•
        </button>
      </div>
      <div
        id="chatMessages"
        style="flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px"
      >
        <div class="chat-msg ai">
          ì•ˆë…•í•˜ì„¸ìš”! ì„¤ê³„ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë¬¼ì–´ë³´ì„¸ìš”.<br />
          í˜„ì¬ ì„¤ê³„ë¥¼ ë¶„ì„í•˜ì—¬ ê°œì„  ì œì•ˆë„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
      <div style="display: flex; padding: 12px 16px; border-top: 1px solid #ebe8e2; gap: 10px">
        <input
          type="text"
          id="chatInput"
          placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
          style="
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ebe8e2;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
          "
          onkeypress="if (event.key === 'Enter') sendChatMessage();"
        />
        <button
          onclick="sendChatMessage()"
          style="
            padding: 12px 20px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
          "
        >
          ì „ì†¡
        </button>
      </div>
    </div>

    <style>
      .chat-msg {
        padding: 12px 16px;
        border-radius: 14px;
        max-width: 85%;
        line-height: 1.5;
        font-size: 14px;
      }
      .chat-msg.ai {
        background: #f8f7f4;
        color: #2d2a26;
        align-self: flex-start;
      }
      .chat-msg.user {
        background: #2d2a26;
        color: #fff;
        align-self: flex-end;
      }
      .chat-loading {
        width: 20px;
        height: 20px;
        border: 2px solid #ebe8e2;
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
    </style>
  </body>
</html>
