{
  "name": "Dadam Interior v8 (Claude Analysis)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dadam-interior-v4",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [18272, 4560],
      "webhookId": "c409630f-2f2c-4fcc-a00d-736eb9cfa9f6"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Parse Input v4 - Manual Position ÏßÄÏõê Ï∂îÍ∞Ä\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst body = $input.first().json.body || $input.first().json;\n\nconst category = body.category || 'sink';\nconst style = body.design_style || body.style || 'modern';\nconst roomImage = body.room_image || '';\nconst imageType = body.image_type || 'image/jpeg';\n\n// ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÌëúÏãúÌïú ÏúÑÏπò (ÏûàÏùÑ Í≤ΩÏö∞)\nconst manualPositions = body.manual_positions || null;\n\nreturn {\n  category,\n  style,\n  roomImage,\n  imageType,\n  manualPositions,\n  hasManualPositions: !!(manualPositions && (manualPositions.water_pipe || manualPositions.exhaust_duct))\n};"
      },
      "id": "parse-input-001",
      "name": "Parse Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [18464, 4560]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Build Claude Analysis Request\n// Claude APIÎ•º ÏÇ¨Ïö©Ìïú Ï†ïÎ∞Ä Î∞∞Í¥Ä Î∂ÑÏÑù\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $input.first().json;\n\nconst analysisPrompt = `ÎãπÏã†ÏùÄ ÌïúÍµ≠ Ï£ºÎ∞© ÏãúÍ≥µ ÌòÑÏû•Ïùò Î∞∞Í¥Ä ÏúÑÏπòÎ•º Î∂ÑÏÑùÌïòÎäî Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.\n\nÏù¥ Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÏó¨ Îã§Ïùå ÏÑ§ÎπÑÏùò ÏúÑÏπòÎ•º Ï†ïÌôïÌïòÍ≤å Ï∞æÏïÑÏ£ºÏÑ∏Ïöî.\n\n[Î∂ÑÏÑù ÎåÄÏÉÅ]\n1. Í∏âÏàò Î∞∞Í¥Ä (Water Supply Pipe)\n   - ÌäπÏßï: Îπ®Í∞ÑÏÉâ/ÌååÎûÄÏÉâ Î∞∞Í¥Ä, Ìù∞ÏÉâ Î∂ÑÎ∞∞Í∏∞ Î∞ïÏä§, PVC Î∞∞Í¥Ä\n   - Î≥¥ÌÜµ ÏúÑÏπò: Î≤ΩÎ©¥ ÌïòÎã®, Î∞îÎã•ÏóêÏÑú 200-400mm ÎÜíÏù¥\n\n2. Î∞∞Í∏∞ ÎçïÌä∏ (Exhaust Duct)\n   - ÌäπÏßï: ÏïåÎ£®ÎØ∏ÎäÑ ÌîåÎ†âÏãúÎ∏î ÎçïÌä∏ (ÏùÄÏÉâ), ÏõêÌòï Íµ¨Î©ç, ÌôòÍ∏∞Íµ¨\n   - Î≥¥ÌÜµ ÏúÑÏπò: Ï≤úÏû• Í∑ºÏ≤ò, ÏÉÅÎ∂Ä Î≤ΩÎ©¥\n\n3. Í∞ÄÏä§ Î∞∞Í¥Ä (Gas Pipe)\n   - ÌäπÏßï: ÎÖ∏ÎûÄÏÉâ Î∞∞Í¥Ä, Í∞ÄÏä§ Î∞∏Î∏å, Í∞ÄÏä§ ÏΩï\n   - Î≥¥ÌÜµ ÏúÑÏπò: Î≤ΩÎ©¥ ÌïòÎã®, Î∞îÎã•ÏóêÏÑú 300-500mm ÎÜíÏù¥\n\n4. Ï†ÑÍ∏∞ ÏΩòÏÑºÌä∏ (Electrical Outlets)\n   - ÌäπÏßï: Ìù∞ÏÉâ ÌîåÎùºÏä§Ìã± Î∞ïÏä§, ÏΩòÏÑºÌä∏ Ïª§Î≤Ñ\n   - Î≥¥ÌÜµ ÏúÑÏπò: Ïπ¥Ïö¥ÌÑ∞ ÎÜíÏù¥ (Î∞îÎã•ÏóêÏÑú 1000-1200mm)\n\n[ÏúÑÏπò Ï∏°Ï†ï Î∞©Î≤ï]\n- Ïù¥ÎØ∏ÏßÄÏùò Í∞ÄÎ°úÎ•º 0%~100%Î°ú Î¥ÖÎãàÎã§\n- 0% = Ïù¥ÎØ∏ÏßÄ Îß® ÏôºÏ™Ω\n- 100% = Ïù¥ÎØ∏ÏßÄ Îß® Ïò§Î•∏Ï™Ω\n- Í∞Å ÏÑ§ÎπÑÏùò Ï§ëÏã¨Ï†êÏù¥ Î™á % ÏúÑÏπòÏóê ÏûàÎäîÏßÄ Ï∏°Ï†ïÌïòÏÑ∏Ïöî\n\n[Ï∂úÎ†• ÌòïÏãù - Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•]\n{\n  \"image_analysis\": {\n    \"wall_structure\": {\n      \"lower_tile\": \"ÌÉÄÏùº ÏÉâÏÉÅ Î∞è ÎÜíÏù¥\",\n      \"upper_wall\": \"ÏÉÅÎ∂Ä Î≤ΩÎ©¥ ÎßàÍ∞ê\",\n      \"estimated_width_mm\": 3000,\n      \"estimated_height_mm\": 2400\n    },\n    \"water_supply\": {\n      \"detected\": true,\n      \"position_percent\": 38,\n      \"position_description\": \"Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ÏïΩ 38% ÏßÄÏ†ê\",\n      \"visual_features\": \"Ìù∞ÏÉâ Î∞∞Í¥Ä Î∞ïÏä§, PVC Ïó∞Í≤∞Î∂Ä\",\n      \"height_from_floor\": \"ÏïΩ 350mm\",\n      \"confidence\": \"high\"\n    },\n    \"exhaust_duct\": {\n      \"detected\": true,\n      \"position_percent\": 72,\n      \"position_description\": \"Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ÏïΩ 72% ÏßÄÏ†ê\",\n      \"visual_features\": \"ÏïåÎ£®ÎØ∏ÎäÑ ÌîåÎ†âÏãúÎ∏î ÎçïÌä∏, ÏùÄÏÉâ\",\n      \"height_from_floor\": \"Ï≤úÏû• Í∑ºÏ≤ò\",\n      \"confidence\": \"high\"\n    },\n    \"gas_pipe\": {\n      \"detected\": false,\n      \"position_percent\": null,\n      \"visual_features\": null,\n      \"confidence\": \"low\"\n    },\n    \"electrical_outlets\": [\n      {\n        \"position_percent\": 45,\n        \"height\": \"Ïπ¥Ïö¥ÌÑ∞ ÎÜíÏù¥\"\n      }\n    ],\n    \"construction_debris\": [\n      \"ÏûëÏóÖÎåÄ\",\n      \"Í≥µÍµ¨\",\n      \"ÏãúÎ©òÌä∏ Ìè¨ÎåÄ\"\n    ]\n  },\n  \"furniture_placement_recommendation\": {\n    \"sink_center_percent\": 38,\n    \"cooktop_center_percent\": 72,\n    \"layout_direction\": \"left_to_right\"\n  }\n}\n\nÏ§ëÏöî: JSON ÌòïÏãùÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî. Îã§Î•∏ ÏÑ§Î™ÖÏùÄ Î∂àÌïÑÏöîÌï©ÎãàÎã§.`;\n\nconst claudeRequestBody = {\n  model: 'claude-sonnet-4-20250514',\n  max_tokens: 2048,\n  messages: [\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image',\n          source: {\n            type: 'base64',\n            media_type: input.imageType || 'image/jpeg',\n            data: input.roomImage\n          }\n        },\n        {\n          type: 'text',\n          text: analysisPrompt\n        }\n      ]\n    }\n  ]\n};\n\nreturn {\n  claudeRequestBody: JSON.stringify(claudeRequestBody),\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  manualPositions: input.manualPositions,\n  hasManualPositions: input.hasManualPositions\n};"
      },
      "id": "build-claude-001",
      "name": "Build Claude Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [18656, 4560]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "x-api-key", "value": "YOUR_ANTHROPIC_API_KEY" },
            { "name": "anthropic-version", "value": "2023-06-01" },
            { "name": "content-type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.claudeRequestBody }}",
        "options": { "timeout": 120000 }
      },
      "id": "claude-analysis-001",
      "name": "Claude Pipe Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [18848, 4560]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Parse Claude Analysis Result v2 - Manual Position Ïö∞ÏÑ† Ï†ÅÏö©\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $('Build Claude Request').first().json;\nconst response = $input.first().json;\n\n// ÏàòÎèô ÏúÑÏπòÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏\nconst manualPos = input.manualPositions;\nconst hasManual = input.hasManualPositions;\n\nlet analysisResult = {\n  water_supply_percent: 30,\n  exhaust_duct_percent: 70,\n  gas_pipe_percent: null,\n  confidence: 'low',\n  wall_width_mm: 3000,\n  wall_height_mm: 2400,\n  source: 'default'\n};\n\n// 1. Î®ºÏ†Ä Claude Î∂ÑÏÑù Í≤∞Í≥º ÌååÏã± ÏãúÎèÑ\ntry {\n  const content = response.content || [];\n  for (const block of content) {\n    if (block.type === 'text' && block.text) {\n      const jsonMatch = block.text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        \n        analysisResult = {\n          water_supply_percent: parsed.image_analysis?.water_supply?.position_percent || parsed.furniture_placement_recommendation?.sink_center_percent || 30,\n          water_supply_features: parsed.image_analysis?.water_supply?.visual_features || '',\n          water_supply_confidence: parsed.image_analysis?.water_supply?.confidence || 'low',\n          \n          exhaust_duct_percent: parsed.image_analysis?.exhaust_duct?.position_percent || parsed.furniture_placement_recommendation?.cooktop_center_percent || 70,\n          exhaust_duct_features: parsed.image_analysis?.exhaust_duct?.visual_features || '',\n          exhaust_duct_confidence: parsed.image_analysis?.exhaust_duct?.confidence || 'low',\n          \n          gas_pipe_percent: parsed.image_analysis?.gas_pipe?.detected ? parsed.image_analysis.gas_pipe.position_percent : null,\n          \n          wall_width_mm: parsed.image_analysis?.wall_structure?.estimated_width_mm || 3000,\n          wall_height_mm: parsed.image_analysis?.wall_structure?.estimated_height_mm || 2400,\n          \n          construction_debris: parsed.image_analysis?.construction_debris || [],\n          \n          confidence: (parsed.image_analysis?.water_supply?.confidence === 'high' && parsed.image_analysis?.exhaust_duct?.confidence === 'high') ? 'high' : 'medium',\n          source: 'claude'\n        };\n      }\n    }\n  }\n} catch (e) {\n  console.log('Parse error:', e.message);\n}\n\n// 2. ÏàòÎèô ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞ (ÏµúÏö∞ÏÑ† Ï†ÅÏö©!)\nif (hasManual) {\n  if (manualPos.water_pipe) {\n    analysisResult.water_supply_percent = manualPos.water_pipe.x;\n    analysisResult.water_supply_features = 'ÏÇ¨Ïö©Ïûê ÏßÅÏ†ë ÌëúÏãú';\n    analysisResult.water_supply_confidence = 'manual';\n  }\n  if (manualPos.exhaust_duct) {\n    analysisResult.exhaust_duct_percent = manualPos.exhaust_duct.x;\n    analysisResult.exhaust_duct_features = 'ÏÇ¨Ïö©Ïûê ÏßÅÏ†ë ÌëúÏãú';\n    analysisResult.exhaust_duct_confidence = 'manual';\n  }\n  analysisResult.source = 'manual';\n  analysisResult.confidence = 'high'; // ÏÇ¨Ïö©Ïûê ÌëúÏãúÎäî Ìï≠ÏÉÅ Ïã†Î¢∞ÎèÑ high\n}\n\nreturn [{\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  analysisResult,\n  analysisMethod: hasManual ? 'manual' : 'claude'\n}];"
      },
      "id": "parse-claude-001",
      "name": "Parse Claude Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [19040, 4560]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Build Background Cleanup Prompt v2\n// Ï†ÑÏÑ† Ï†úÍ±∞ + ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ Î≥¥Ï†ï Ï∂îÍ∞Ä\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $input.first().json;\nconst analysis = input.analysisResult;\n\nconst debrisList = analysis.construction_debris?.length > 0 \n  ? analysis.construction_debris.join(', ')\n  : 'Í≥µÏÇ¨ ÏûîÌï¥, Í≥µÍµ¨, ÏûÑÏãú Î¨ºÍ±¥';\n\nconst cleanupPrompt = `[TASK: BACKGROUND CLEANUP - STRUCTURE PRESERVATION]\n\n‚òÖ‚òÖ‚òÖ ABSOLUTE RULES ‚òÖ‚òÖ‚òÖ\n\n[MUST PRESERVE - Ï†àÎåÄ Î≥ÄÍ≤Ω Í∏àÏßÄ]\n1. Î≤ΩÎ©¥ ÏúÑÏπòÏôÄ Í∞ÅÎèÑ\n2. Î∞îÎã• ÏúÑÏπòÏôÄ Î†àÎ≤®\n3. Ï≤úÏû• ÎÜíÏù¥ÏôÄ ÏúÑÏπò\n4. Ï∞ΩÎ¨∏/Î¨∏ ÏúÑÏπòÏôÄ ÌÅ¨Í∏∞\n5. Ïπ¥Î©îÎùº ÏïµÍ∏ÄÍ≥º ÏãúÏ†ê\n6. Ï°∞Î™Ö Î∞©Ìñ•\n\n[MUST REMOVE - Ï†úÍ±∞ ÎåÄÏÉÅ]\n${debrisList}\n- ÏÇ¨Îûå\n- Ïò∑Í±∏Ïù¥ÏôÄ Ïò∑\n- ÏûÑÏãú ÏûëÏóÖÎåÄ\n- Í≥µÍµ¨ÏôÄ Ïû•ÎπÑ\n- ÏãúÎ©òÌä∏ Ìè¨ÎåÄ\n- Î™®Îì† Í≥µÏÇ¨ ÏûîÌï¥\n\n‚òÖ‚òÖ‚òÖ Ï†ÑÏÑ† Ï†úÍ±∞ - WIRE REMOVAL ‚òÖ‚òÖ‚òÖ\n- ÎÖ∏Ï∂úÎêú Ï†ÑÏÑ† Î™®Îëê Ï†úÍ±∞\n- Î≤ΩÎ©¥Ïóê ÎìúÎü¨ÎÇú Î∞∞ÏÑ† Ï†úÍ±∞\n- Ï≤úÏû•Ïùò ÎÖ∏Ï∂ú Ï†ÑÏÑ† Ï†úÍ±∞\n- Ï†ÑÏÑ†Ïù¥ ÏûàÎçò ÏûêÎ¶¨Îäî Ï£ºÎ≥Ä Î≤ΩÎ©¥/Ï≤úÏû•Í≥º ÎèôÏùºÌïòÍ≤å Î≥¥Ï†ï\n\n‚òÖ‚òÖ‚òÖ ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ Î≥¥Ï†ï - UNFINISHED AREA REPAIR ‚òÖ‚òÖ‚òÖ\n- ÎßàÍ∞êÎêòÏßÄ ÏïäÏùÄ Î≤ΩÎ©¥: Ï£ºÎ≥ÄÏùò ÎπÑÏä∑Ìïú ÏÜåÏû¨/ÏÉâÏÉÅÏúºÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Î≥¥Ï†ï\n- ÎßàÍ∞êÎêòÏßÄ ÏïäÏùÄ Ï≤úÏû•: Ï£ºÎ≥Ä Ï≤úÏû•Í≥º ÎèôÏùºÌïú ÏÉâÏÉÅ(Ìù∞ÏÉâ)ÏúºÎ°ú Î≥¥Ï†ï\n- ÏÑùÍ≥†Î≥¥Îìú ÎÖ∏Ï∂ú Î∂ÄÎ∂Ñ: Ï£ºÎ≥Ä ÎßàÍ∞êÏû¨ÏôÄ ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨\n- ÏãúÎ©òÌä∏/ÏΩòÌÅ¨Î¶¨Ìä∏ ÎÖ∏Ï∂ú: Ï£ºÎ≥Ä ÌÉÄÏùºÏù¥ÎÇò ÌéòÏù∏Ìä∏Î°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïó∞Í≤∞\n- ÌÉÄÏùºÏù¥ Îπ†ÏßÑ Î∂ÄÎ∂Ñ: Ï£ºÎ≥Ä ÌÉÄÏùº Ìå®ÌÑ¥Í≥º ÎèôÏùºÌïòÍ≤å Ï±ÑÏö∞Í∏∞\n\n[MUST IMPROVE - ÎßàÍ∞ê Ï≤òÎ¶¨]\n1. Î≤ΩÎ©¥ ÌïòÎã®: Í∏∞Ï°¥ ÌÉÄÏùº Ìå®ÌÑ¥ Ïú†ÏßÄÌïòÎ©∞ Íπ®ÎÅóÌïòÍ≤å\n2. Î≤ΩÎ©¥ ÏÉÅÎã®: Ï£ºÎ≥ÄÍ≥º ÎèôÏùºÌïú ÏÉâÏÉÅÏúºÎ°ú Îß§ÎÅÑÎüΩÍ≤å\n3. Î∞îÎã•: Íπ®ÎÅóÌïú ÌÉÄÏùº ÎòêÎäî ÎßàÍ∞êÏû¨\n4. Ï≤úÏû•: Íπ®ÎÅóÌïú Ìù∞ÏÉâ, Ï°∞Î™Ö Ïú†ÏßÄ\n\n[KEEP VISIBLE - Ïú†ÏßÄÌï† ÏÑ§ÎπÑ]\n- Í∏âÏàò Î∞∞Í¥Ä ÏúÑÏπò: ${analysis.water_supply_percent}% ÏßÄÏ†ê (Î∞∞Í¥Ä Ïó∞Í≤∞Î∂ÄÎßå ÌëúÏãú)\n- Î∞∞Í∏∞ ÎçïÌä∏ ÏúÑÏπò: ${analysis.exhaust_duct_percent}% ÏßÄÏ†ê (ÎçïÌä∏ Íµ¨Î©çÎßå ÌëúÏãú)\n${analysis.gas_pipe_percent ? '- Í∞ÄÏä§ Î∞∞Í¥Ä ÏúÑÏπò: ' + analysis.gas_pipe_percent + '% ÏßÄÏ†ê' : ''}\n\n[OUTPUT]\n- Íπ®ÎÅóÌïòÍ≤å ÎßàÍ∞êÎêú Îπà Í≥µÍ∞Ñ\n- Ï†ÑÏÑ† ÏóÜÏùå\n- ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ ÏóÜÏùå\n- Í∞ÄÍµ¨ ÏÑ§Ïπò Ï§ÄÎπÑ ÏôÑÎ£å ÏÉÅÌÉú`;\n\nconst geminiCleanupBody = {\n  contents: [{\n    parts: [\n      { text: cleanupPrompt },\n      { inline_data: { mime_type: input.imageType || 'image/jpeg', data: input.roomImage }}\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.3 }\n};\n\nreturn {\n  geminiCleanupBody: JSON.stringify(geminiCleanupBody),\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  analysisResult: analysis\n};"
      },
      "id": "build-cleanup-001",
      "name": "Build Cleanup Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [19232, 4560]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=AIzaSyCP4pCny0iIRCaztNTa9Eg33mb0NoIzJNw",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiCleanupBody }}",
        "options": { "timeout": 120000 }
      },
      "id": "gemini-cleanup-001",
      "name": "Gemini Background Cleanup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [19424, 4560]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Parse Background + Build Furniture Prompt (Claude Î∂ÑÏÑù Í≤∞Í≥º ÏÇ¨Ïö©)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $('Build Cleanup Prompt').first().json;\nconst response = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet cleanedBackground = null;\ntry {\n  const candidates = response.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inlineData || part.inline_data) {\n        cleanedBackground = (part.inlineData || part.inline_data).data;\n      }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\n// ÏúÑÏπò ÏÑ§Î™Ö Ìï®Ïàò\nfunction describePosition(percent) {\n  if (percent <= 20) return 'Îß® ÏôºÏ™Ω ÏòÅÏó≠';\n  if (percent <= 40) return 'ÏôºÏ™Ω ÏòÅÏó≠';\n  if (percent <= 60) return 'Ï§ëÏïô ÏòÅÏó≠';\n  if (percent <= 80) return 'Ïò§Î•∏Ï™Ω ÏòÅÏó≠';\n  return 'Îß® Ïò§Î•∏Ï™Ω ÏòÅÏó≠';\n}\n\nconst waterPercent = analysis.water_supply_percent;\nconst exhaustPercent = analysis.exhaust_duct_percent;\nconst waterDesc = describePosition(waterPercent);\nconst exhaustDesc = describePosition(exhaustPercent);\n\nconst furniturePrompt = `[TASK: FURNITURE PLACEMENT - CLAUDE ANALYZED POSITIONS]\n\n‚òÖ‚òÖ‚òÖ Î∞∞Í≤Ω Î≥¥Ï°¥ ÌïÑÏàò ‚òÖ‚òÖ‚òÖ\nÏù¥ Ïù¥ÎØ∏ÏßÄÎäî Ï†ïÎ¶¨Îêú Î∞∞Í≤ΩÏûÖÎãàÎã§.\nÎ∞∞Í≤ΩÏùÑ Ï†àÎåÄ ÏàòÏ†ïÌïòÏßÄ ÎßêÍ≥†, Í∞ÄÍµ¨Îßå Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n‚òÖ‚òÖ‚òÖ CLAUDE AI Î∂ÑÏÑù Í≤∞Í≥º Í∏∞Î∞ò Ï†ïÎ∞Ä Î∞∞Ïπò ‚òÖ‚òÖ‚òÖ\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n[Î∂ÑÏÑù Ïã†Î¢∞ÎèÑ: ${analysis.confidence}]\n\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 0%          25%          50%          75%          100%    ‚îÇ\n‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§        ‚îÇ\n‚îÇ      ${waterPercent < 50 ? '‚ñº' : ' '}                              ${exhaustPercent > 50 ? '‚ñº' : ' '}              ‚îÇ\n‚îÇ   Í∏âÏàòÎ∞∞Í¥Ä(${waterPercent}%)                    Î∞∞Í∏∞ÎçïÌä∏(${exhaustPercent}%)         ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n[Í∏∞Ï§ÄÏ†ê 1: Í∏âÏàòÎ∞∞Í¥Ä ‚Üí Ïã±ÌÅ¨Î≥º Ï§ëÏã¨]\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìç Claude Î∂ÑÏÑù ÏúÑÏπò: Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ${waterPercent}% ÏßÄÏ†ê\nüìç ÏòÅÏó≠: ${waterDesc}\nüìç Í∞êÏßÄ ÌäπÏßï: ${analysis.water_supply_features || 'Î∞∞Í¥Ä Î∞ïÏä§'}\nüìç Ïã†Î¢∞ÎèÑ: ${analysis.water_supply_confidence || 'medium'}\n\n‚Üí Ïã±ÌÅ¨Î≥º(SINK BOWL) Ï§ëÏã¨ÏùÑ Ï†ïÌôïÌûà ${waterPercent}% ÏßÄÏ†êÏóê Î∞∞Ïπò\n‚Üí ÏàòÏ†Ñ(FAUCET)ÏùÄ Ïã±ÌÅ¨Î≥º Îí§Ï™Ω Ï§ëÏïôÏóê Î∞∞Ïπò\n‚Üí Ïã±ÌÅ¨ Ï∫êÎπÑÎãõÏùÄ Ïã±ÌÅ¨Î≥º Ï§ëÏã¨ÏúºÎ°ú Ï¢åÏö∞ ÎåÄÏπ≠\n\n‚ö†Ô∏è Ïã±ÌÅ¨Î≥ºÏù¥ ${waterPercent}% ÏúÑÏπòÏóê ÏóÜÏúºÎ©¥ Ïã§Ìå®!\n\n[Í∏∞Ï§ÄÏ†ê 2: Î∞∞Í∏∞ÎçïÌä∏ ‚Üí Ïø°ÌÉë Ï§ëÏã¨]\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìç Claude Î∂ÑÏÑù ÏúÑÏπò: Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ${exhaustPercent}% ÏßÄÏ†ê\nüìç ÏòÅÏó≠: ${exhaustDesc}\nüìç Í∞êÏßÄ ÌäπÏßï: ${analysis.exhaust_duct_features || 'ÏïåÎ£®ÎØ∏ÎäÑ ÎçïÌä∏'}\nüìç Ïã†Î¢∞ÎèÑ: ${analysis.exhaust_duct_confidence || 'medium'}\n\n‚Üí Ïø°ÌÉë(COOKTOP) Ï§ëÏã¨ÏùÑ Ï†ïÌôïÌûà ${exhaustPercent}% ÏßÄÏ†êÏóê Î∞∞Ïπò\n‚Üí Î†àÏù∏ÏßÄÌõÑÎìú(RANGE HOOD)Îäî Ïø°ÌÉë Î∞îÎ°ú ÏúÑ, Í∞ôÏùÄ Ï§ëÏã¨ÏÑ†\n‚Üí Ïø°ÌÉë Ï∫êÎπÑÎãõÏùÄ Ïø°ÌÉë Ï§ëÏã¨ÏúºÎ°ú Ï¢åÏö∞ ÎåÄÏπ≠\n\n‚ö†Ô∏è Ïø°ÌÉëÏù¥ ${exhaustPercent}% ÏúÑÏπòÏóê ÏóÜÏúºÎ©¥ Ïã§Ìå®!\n\n[Ï£ºÎ∞© Íµ¨ÏÑ±ÏöîÏÜå - ÌïÑÏàò Ìè¨Ìï®]\n‚úì Ïã±ÌÅ¨Î≥º (Sink Bowl) - Ïä§ÌÖåÏù∏Î¶¨Ïä§, ${waterPercent}% ÏúÑÏπò\n‚úì ÏàòÏ†Ñ (Faucet) - Ïã±ÌÅ¨Î≥º Îí§Ï™Ω\n‚úì Ïø°ÌÉë (Cooktop) - ${exhaustPercent}% ÏúÑÏπò\n‚úì Î†àÏù∏ÏßÄÌõÑÎìú (Range Hood) - Ïø°ÌÉë ÏúÑ\n‚úì ÌïòÎ∂ÄÏû• (Lower Cabinet) - ÎÜíÏù¥ 870mm\n‚úì ÏÉÅÎ∂ÄÏû• (Upper Cabinet) - Î≤ΩÎ©¥ Î∂ÄÏ∞©\n‚úì Í±∏Î†àÎ∞õÏù¥ (Toe Kick) - ÌïòÎ∂ÄÏû• ÏïÑÎûò\n\n[Ïä§ÌÉÄÏùº: Modern Minimal]\n- ÏÉâÏÉÅ: ÌôîÏù¥Ìä∏, Í∑∏Î†àÏù¥, Ïö∞ÎìúÌÜ§\n- ÎßàÍ∞ê: Î¨¥Í¥ë\n- ÏÜêÏû°Ïù¥: ÌûàÎì† (Ìë∏ÏãúÏò§Ìîà)\n\n[Í≤ÄÏ¶ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏]\n‚òë Ïã±ÌÅ¨Î≥º Ï§ëÏã¨ = ${waterPercent}% ?\n‚òë ÏàòÏ†ÑÏù¥ Ïã±ÌÅ¨Î≥º Îí§Ïóê ÏûàÎäîÍ∞Ä?\n‚òë Ïø°ÌÉë Ï§ëÏã¨ = ${exhaustPercent}% ?\n‚òë Î†àÏù∏ÏßÄÌõÑÎìúÍ∞Ä Ïø°ÌÉë ÏúÑÏóê ÏûàÎäîÍ∞Ä?\n\n[Í∏àÏßÄ ÏÇ¨Ìï≠]\n‚ùå Î∞∞Í≤Ω/Î≤Ω/Î∞îÎã• Î≥ÄÍ≤Ω Í∏àÏßÄ\n‚ùå ÌÖçÏä§Ìä∏/ÎùºÎ≤®/ÏπòÏàò Í∏àÏßÄ\n‚ùå Ïã±ÌÅ¨Î≥º/ÏàòÏ†Ñ ÎàÑÎùΩ Í∏àÏßÄ\n‚ùå Ïø°ÌÉë ÏúÑÏπò Ïù¥ÌÉà Í∏àÏßÄ`;\n\nconst geminiFurnitureBody = {\n  contents: [{\n    parts: [\n      { text: furniturePrompt },\n      { inline_data: { mime_type: 'image/png', data: cleanedBackground }}\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.4 }\n};\n\nreturn [{\n  cleanedBackground,\n  hasCleanedBackground: !!cleanedBackground,\n  geminiFurnitureBody: JSON.stringify(geminiFurnitureBody),\n  category: input.category,\n  style: input.style,\n  analysisResult: analysis\n}];"
      },
      "id": "parse-bg-furniture-001",
      "name": "Parse BG + Build Furniture",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [19616, 4560]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "has-bg", "leftValue": "={{ $json.hasCleanedBackground }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" }}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-bg-001",
      "name": "Has Cleaned BG?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [19808, 4560]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=AIzaSyCP4pCny0iIRCaztNTa9Eg33mb0NoIzJNw",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiFurnitureBody }}",
        "options": { "timeout": 120000 }
      },
      "id": "gemini-furniture-001",
      "name": "Gemini Furniture",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [20000, 4448]
    },
    {
      "parameters": {
        "jsCode": "// Parse Furniture + Prep Open\nconst input = $('Parse BG + Build Furniture').first().json;\nconst response = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet closedImage = null;\ntry {\n  const candidates = response.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inlineData || part.inline_data) {\n        closedImage = (part.inlineData || part.inline_data).data;\n      }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\nconst openPrompt = `[TASK: OPEN DOORS AND DRAWERS]\n\n‚òÖ‚òÖ‚òÖ Î∞∞Í≤ΩÍ≥º Í∞ÄÍµ¨ ÏúÑÏπò Ïú†ÏßÄ ‚òÖ‚òÖ‚òÖ\n\n[Î≥ÄÍ≤Ω Í∏àÏßÄ]\n- Î∞∞Í≤Ω (Î≤Ω, Î∞îÎã•, Ï≤úÏû•)\n- Í∞ÄÍµ¨ ÏúÑÏπò, ÌÅ¨Í∏∞, ÏÉâÏÉÅ\n- Ïπ¥Î©îÎùº ÏïµÍ∏Ä\n- Ï°∞Î™Ö\n\n[Î≥ÄÍ≤Ω ÏÇ¨Ìï≠]\n- Ïó¨Îã´Ïù¥ ÎèÑÏñ¥: 90ÎèÑ Î∞îÍπ•ÏúºÎ°ú Ïó¥Í∏∞\n- ÏÑúÎûç: 30-40% ÎãπÍ∏∞Í∏∞\n- ÎÇ¥Î∂Ä ÏàòÎÇ©Ìíà Î≥¥Ïù¥Í≤å\n\n[ÎÇ¥Î∂Ä ÏàòÎÇ©Ìíà]\n- Í∑∏Î¶á, Ï†ëÏãú, Ïªµ\n- ÎÉÑÎπÑ, ÌîÑÎùºÏù¥Ìå¨\n- ÏñëÎÖêÌÜµ, Ï°∞ÎØ∏Î£å\n\n[Ï∂úÎ†•]\n- ÎèôÏùºÌïú Í∞ÄÍµ¨, ÎèÑÏñ¥Îßå Ïó¥Î¶∞ ÏÉÅÌÉú\n- Ìè¨ÌÜ†Î¶¨ÏñºÎ¶¨Ïä§Ìã± ÌíàÏßà`;\n\nconst geminiOpenBody = {\n  contents: [{\n    parts: [\n      { inline_data: { mime_type: 'image/png', data: closedImage }},\n      { text: openPrompt }\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.3 }\n};\n\nreturn [{\n  cleanedBackground: input.cleanedBackground,\n  closedImage,\n  hasClosedImage: !!closedImage,\n  geminiOpenBody: JSON.stringify(geminiOpenBody),\n  category: input.category,\n  style: input.style,\n  analysisResult: analysis\n}];"
      },
      "id": "parse-furniture-open-001",
      "name": "Parse Furniture + Prep Open",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [20192, 4448]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "id": "has-closed", "leftValue": "={{ $json.hasClosedImage }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" }}],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-closed-001",
      "name": "Has Closed Image?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [20384, 4448]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=AIzaSyCP4pCny0iIRCaztNTa9Eg33mb0NoIzJNw",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiOpenBody }}",
        "options": { "timeout": 120000 }
      },
      "id": "gemini-open-001",
      "name": "Gemini Open Door",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [20576, 4336]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Furniture + Prep Open').first().json;\nconst openResponse = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet openImage = null;\ntry {\n  const candidates = openResponse.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inline_data?.data) { openImage = part.inline_data.data; break; }\n      if (part.inlineData?.data) { openImage = part.inlineData.data; break; }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\nreturn [{\n  success: true,\n  message: 'Claude Î∂ÑÏÑù + 2Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å',\n  processing: 'claude-analysis + 2-stage-generation',\n  category: input.category,\n  style: input.style,\n  pipe_analysis: {\n    method: 'claude',\n    water_supply_percent: analysis.water_supply_percent,\n    exhaust_duct_percent: analysis.exhaust_duct_percent,\n    confidence: analysis.confidence\n  },\n  generated_image: {\n    background: { base64: input.cleanedBackground, mime_type: 'image/png', description: 'Stage 1: Cleaned background' },\n    closed: { base64: input.closedImage, mime_type: 'image/png', description: 'Stage 2: Furniture added (closed)' },\n    open: { base64: openImage, mime_type: 'image/png', description: 'Stage 3: Doors open' }\n  }\n}];"
      },
      "id": "format-all-001",
      "name": "Format Response (All)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [20768, 4336]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Furniture + Prep Open').first().json;\nconst analysis = input.analysisResult;\n\nreturn [{\n  success: true,\n  message: 'Claude Î∂ÑÏÑù + Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å (Îã´Ìûå ÎèÑÏñ¥Îßå)',\n  processing: 'claude-analysis + 2-stage-generation',\n  category: input.category,\n  style: input.style,\n  pipe_analysis: {\n    method: 'claude',\n    water_supply_percent: analysis.water_supply_percent,\n    exhaust_duct_percent: analysis.exhaust_duct_percent,\n    confidence: analysis.confidence\n  },\n  generated_image: {\n    background: { base64: input.cleanedBackground, mime_type: 'image/png', description: 'Stage 1: Cleaned background' },\n    closed: { base64: input.closedImage, mime_type: 'image/png', description: 'Stage 2: Furniture added (closed)' },\n    open: null\n  }\n}];"
      },
      "id": "format-closed-001",
      "name": "Format Response (Closed)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [20576, 4560]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Build Cleanup Prompt').first().json;\nreturn [{\n  success: false,\n  message: 'Î∞∞Í≤Ω Ï†ïÎ¶¨ Ïã§Ìå®',\n  error: 'Background cleanup failed',\n  category: input.category\n}];"
      },
      "id": "format-error-001",
      "name": "Format Response (Error)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [20000, 4672]
    },
    {
      "parameters": { "respondWith": "json", "responseBody": "={{ $json }}", "options": {} },
      "id": "respond-all-001",
      "name": "Respond (All)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [20960, 4336]
    },
    {
      "parameters": { "respondWith": "json", "responseBody": "={{ $json }}", "options": {} },
      "id": "respond-closed-001",
      "name": "Respond (Closed)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [20768, 4560]
    },
    {
      "parameters": { "respondWith": "json", "responseBody": "={{ $json }}", "options": {} },
      "id": "respond-error-001",
      "name": "Respond (Error)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [20192, 4672]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Parse Input", "type": "main", "index": 0 }]]
    },
    "Parse Input": {
      "main": [[{ "node": "Build Claude Request", "type": "main", "index": 0 }]]
    },
    "Build Claude Request": {
      "main": [[{ "node": "Claude Pipe Analysis", "type": "main", "index": 0 }]]
    },
    "Claude Pipe Analysis": {
      "main": [[{ "node": "Parse Claude Result", "type": "main", "index": 0 }]]
    },
    "Parse Claude Result": {
      "main": [[{ "node": "Build Cleanup Prompt", "type": "main", "index": 0 }]]
    },
    "Build Cleanup Prompt": {
      "main": [[{ "node": "Gemini Background Cleanup", "type": "main", "index": 0 }]]
    },
    "Gemini Background Cleanup": {
      "main": [[{ "node": "Parse BG + Build Furniture", "type": "main", "index": 0 }]]
    },
    "Parse BG + Build Furniture": {
      "main": [[{ "node": "Has Cleaned BG?", "type": "main", "index": 0 }]]
    },
    "Has Cleaned BG?": {
      "main": [
        [{ "node": "Gemini Furniture", "type": "main", "index": 0 }],
        [{ "node": "Format Response (Error)", "type": "main", "index": 0 }]
      ]
    },
    "Gemini Furniture": {
      "main": [[{ "node": "Parse Furniture + Prep Open", "type": "main", "index": 0 }]]
    },
    "Parse Furniture + Prep Open": {
      "main": [[{ "node": "Has Closed Image?", "type": "main", "index": 0 }]]
    },
    "Has Closed Image?": {
      "main": [
        [{ "node": "Gemini Open Door", "type": "main", "index": 0 }],
        [{ "node": "Format Response (Closed)", "type": "main", "index": 0 }]
      ]
    },
    "Gemini Open Door": {
      "main": [[{ "node": "Format Response (All)", "type": "main", "index": 0 }]]
    },
    "Format Response (All)": {
      "main": [[{ "node": "Respond (All)", "type": "main", "index": 0 }]]
    },
    "Format Response (Closed)": {
      "main": [[{ "node": "Respond (Closed)", "type": "main", "index": 0 }]]
    },
    "Format Response (Error)": {
      "main": [[{ "node": "Respond (Error)", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": { "availableInMCP": false },
  "versionId": "v8-claude-001",
  "meta": { "instanceId": "244e14704bf7bd5d7ea20567a9c92fb83222642504dc698a01d22d41bd5f300d" },
  "id": "NK3jfPhTHsWjMH66",
  "tags": []
}
