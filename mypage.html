<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2A26">
  <title>마이페이지 - 다담가구</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Noto+Serif+KR:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--white:#FAFAFA;--cream:#F8F7F4;--warm:#EBE8E2;--gray:#8B8680;--charcoal:#2D2A26;--black:#1A1918;--gold:#B8956C;--expert:#6366F1;--business:#059669}
    body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;background:var(--cream);color:var(--charcoal);line-height:1.7;min-height:100vh}
    h1,h2,h3,h4{font-family:'Playfair Display','Noto Serif KR',serif;font-weight:500}
    a{text-decoration:none;color:inherit}

    /* Header */
    .header{position:sticky;top:0;background:rgba(248,247,244,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--warm);z-index:100;padding:16px 24px}
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:10px;font-family:'Playfair Display',serif;font-size:24px}
    .logo svg{width:32px;height:32px}
    .header-nav{display:flex;align-items:center;gap:24px}
    .header-nav a{font-size:14px;color:var(--gray);transition:color .3s}
    .header-nav a:hover{color:var(--charcoal)}
    .btn-logout{padding:8px 16px;background:var(--charcoal);color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;transition:background .3s}
    .btn-logout:hover{background:var(--gold)}

    /* Main */
    .main{max-width:1000px;margin:0 auto;padding:40px 24px}

    /* Profile Header */
    .profile-header{display:flex;align-items:center;gap:24px;margin-bottom:40px;padding:32px;background:#fff;border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
    .profile-avatar{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--charcoal));display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;font-family:'Playfair Display',serif}
    .profile-info{flex:1}
    .profile-name{font-size:28px;margin-bottom:4px}
    .profile-email{color:var(--gray);font-size:14px;margin-bottom:12px}
    .profile-tier{display:inline-flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500}
    .tier-standard{background:var(--warm);color:var(--charcoal)}
    .tier-expert{background:var(--expert);color:#fff}
    .tier-business{background:var(--business);color:#fff}
    .profile-actions{display:flex;gap:12px}
    .btn-edit{padding:10px 20px;background:var(--charcoal);color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;transition:background .3s}
    .btn-edit:hover{background:var(--gold)}
    .btn-upgrade{padding:10px 20px;background:linear-gradient(135deg,var(--expert),var(--gold));color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;transition:transform .3s}
    .btn-upgrade:hover{transform:scale(1.02)}

    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px}
    .stat-card{background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px}
    .stat-icon svg{width:24px;height:24px}
    .stat-icon.purple{background:rgba(99,102,241,.1);color:var(--expert)}
    .stat-icon.gold{background:rgba(184,149,108,.15);color:var(--gold)}
    .stat-icon.green{background:rgba(5,150,105,.1);color:var(--business)}
    .stat-value{font-size:32px;font-weight:600;margin-bottom:4px}
    .stat-label{font-size:14px;color:var(--gray)}

    /* Sections */
    .section{background:#fff;border-radius:20px;padding:32px;margin-bottom:24px;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    .section-title{font-size:20px;display:flex;align-items:center;gap:12px}
    .section-title svg{width:24px;height:24px;color:var(--gold)}
    .btn-link{font-size:14px;color:var(--gold);display:flex;align-items:center;gap:4px}
    .btn-link:hover{text-decoration:underline}

    /* Info List */
    .info-list{display:flex;flex-direction:column;gap:16px}
    .info-item{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--warm)}
    .info-item:last-child{border-bottom:none}
    .info-label{font-size:14px;color:var(--gray)}
    .info-value{font-size:15px;font-weight:500}

    /* Design List */
    .design-list{display:flex;flex-direction:column;gap:12px}
    .design-item{display:flex;align-items:center;gap:16px;padding:16px;background:var(--cream);border-radius:12px;transition:background .3s}
    .design-item:hover{background:var(--warm)}
    .design-thumb{width:60px;height:60px;border-radius:8px;background:var(--warm);display:flex;align-items:center;justify-content:center}
    .design-thumb svg{width:28px;height:28px;color:var(--gray)}
    .design-info{flex:1}
    .design-name{font-weight:500;margin-bottom:4px}
    .design-meta{font-size:13px;color:var(--gray)}
    .design-status{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:500}
    .status-draft{background:var(--warm);color:var(--charcoal)}
    .status-submitted{background:rgba(99,102,241,.1);color:var(--expert)}
    .status-completed{background:rgba(5,150,105,.1);color:var(--business)}

    /* Empty State */
    .empty-state{text-align:center;padding:48px 24px;color:var(--gray)}
    .empty-state svg{width:64px;height:64px;margin-bottom:16px;opacity:.5}
    .empty-state p{margin-bottom:16px}
    .btn-primary{padding:12px 24px;background:var(--charcoal);color:#fff;border:none;border-radius:10px;font-size:14px;cursor:pointer;transition:background .3s}
    .btn-primary:hover{background:var(--gold)}

    /* Quick Actions */
    .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
    .action-card{display:flex;flex-direction:column;align-items:center;padding:24px;background:var(--cream);border-radius:12px;text-align:center;transition:all .3s;cursor:pointer}
    .action-card:hover{background:var(--warm);transform:translateY(-2px)}
    .action-card svg{width:32px;height:32px;margin-bottom:12px;color:var(--gold)}
    .action-card span{font-size:14px;font-weight:500}

    /* Loading */
    .loading{display:flex;align-items:center;justify-content:center;min-height:60vh}
    .spinner{width:40px;height:40px;border:3px solid var(--warm);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid var(--warm)}
    .modal-header h3{font-size:1.3rem}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray)}
    .modal-body{padding:24px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-size:14px;color:var(--charcoal);font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:1px solid var(--warm);border-radius:10px;font-size:15px;font-family:inherit;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--gold)}
    .form-group textarea{resize:vertical;min-height:80px}
    .form-hint{font-size:12px;color:var(--gray);margin-top:6px}
    .modal-footer{display:flex;justify-content:flex-end;gap:12px;padding:24px;border-top:1px solid var(--warm)}

    /* Upgrade Status Banner */
    .upgrade-status{padding:16px 20px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
    .upgrade-status.pending{background:#fff3e0;color:#f57c00}
    .upgrade-status.approved{background:#e8f5e9;color:#388e3c}
    .upgrade-status.rejected{background:#ffebee;color:#c62828}
    .upgrade-status svg{width:24px;height:24px;flex-shrink:0}
    .upgrade-status .status-text{flex:1}
    .upgrade-status .status-title{font-weight:600;margin-bottom:2px}
    .upgrade-status .status-desc{font-size:13px;opacity:.8}

    /* Responsive */
    @media(max-width:768px){
      .profile-header{flex-direction:column;text-align:center}
      .profile-actions{justify-content:center}
      .header-nav{gap:16px}
    }
    @media(max-width:480px){
      .main{padding:24px 16px}
      .profile-avatar{width:80px;height:80px;font-size:28px}
      .profile-name{font-size:24px}
      .stats-grid{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <svg viewBox="0 0 40 40" fill="currentColor"><path d="M20 4L4 12v16l16 8 16-8V12L20 4zm0 4l12 6-12 6-12-6 12-6zm-12 10l12 6 12-6v8l-12 6-12-6v-8z"/></svg>
        <span>다담</span>
      </a>
      <nav class="header-nav">
        <a href="index.html">홈</a>
        <a href="ai-design.html">AI 설계</a>
        <button class="btn-logout" onclick="logout()">로그아웃</button>
      </nav>
    </div>
  </header>

  <!-- Loading State -->
  <div class="loading" id="loadingState">
    <div class="spinner"></div>
  </div>

  <!-- Main Content -->
  <main class="main" id="mainContent" style="display:none">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar">?</div>
      <div class="profile-info">
        <h1 class="profile-name" id="profileName">로딩 중...</h1>
        <p class="profile-email" id="profileEmail">-</p>
        <span class="profile-tier tier-standard" id="profileTier">Standard</span>
      </div>
      <div class="profile-actions">
        <button class="btn-edit" onclick="openEditProfile()">프로필 수정</button>
        <button class="btn-upgrade" id="btnUpgrade" onclick="requestUpgrade()">Expert 업그레이드</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div class="stat-value" id="statDesigns">0</div>
        <div class="stat-label">저장된 설계</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon gold">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
        </div>
        <div class="stat-value" id="statConsults">0</div>
        <div class="stat-label">상담 요청</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div class="stat-value" id="statCompleted">0</div>
        <div class="stat-label">완료된 프로젝트</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          빠른 메뉴
        </h2>
      </div>
      <div class="quick-actions">
        <a href="ai-design.html" class="action-card" id="actionDesign">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          <span>AI 설계 시작</span>
        </a>
        <a href="consultation.html" class="action-card">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span>상담 요청</span>
        </a>
        <div class="action-card" onclick="location.href='#'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          <span>포트폴리오</span>
        </div>
        <div class="action-card" onclick="location.href='#'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span>설정</span>
        </div>
      </div>
    </section>

    <!-- Account Info -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          계정 정보
        </h2>
        <a href="#" class="btn-link" onclick="openEditProfile()">수정 <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg></a>
      </div>
      <div class="info-list">
        <div class="info-item">
          <span class="info-label">이름</span>
          <span class="info-value" id="infoName">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">이메일</span>
          <span class="info-value" id="infoEmail">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">연락처</span>
          <span class="info-value" id="infoPhone">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">거주지역</span>
          <span class="info-value" id="infoLocation">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">가입일</span>
          <span class="info-value" id="infoJoined">-</span>
        </div>
      </div>
    </section>

    <!-- Recent Designs -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          최근 설계
        </h2>
        <a href="#" class="btn-link">전체보기 <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14m-7-7 7 7-7 7"/></svg></a>
      </div>
      <div class="design-list" id="designList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
          <p>아직 저장된 설계가 없습니다.</p>
          <button class="btn-primary" onclick="location.href='ai-design.html'">첫 설계 시작하기</button>
        </div>
      </div>
    </section>

    <!-- Upgrade Status (shown if request exists) -->
    <div class="upgrade-status pending" id="upgradeStatus" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      <div class="status-text">
        <div class="status-title" id="upgradeStatusTitle">Expert 승급 심사 중</div>
        <div class="status-desc" id="upgradeStatusDesc">관리자 확인 후 승인됩니다.</div>
      </div>
    </div>
  </main>

  <!-- Expert Upgrade Modal -->
  <div class="modal" id="upgradeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Expert 등급 신청</h3>
        <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:20px;color:var(--gray);font-size:14px;line-height:1.6">
          Expert 등급은 인테리어 전문가, 시공업체 대표님을 위한 등급입니다.<br>
          상세 설계 도구, 자재 자동 산출 등 고급 기능을 이용하실 수 있습니다.
        </p>
        <form id="upgradeForm" onsubmit="submitUpgradeRequest(event)">
          <div class="form-group">
            <label>회사/상호명 *</label>
            <input type="text" id="companyName" required placeholder="예: 다담인테리어">
          </div>
          <div class="form-group">
            <label>업종 *</label>
            <select id="businessType" required>
              <option value="">선택하세요</option>
              <option value="interior">인테리어 디자인</option>
              <option value="construction">시공/설치</option>
              <option value="furniture">가구 제작</option>
              <option value="architecture">건축/설계</option>
              <option value="other">기타</option>
            </select>
          </div>
          <div class="form-group">
            <label>경력 연수 *</label>
            <select id="careerYears" required>
              <option value="">선택하세요</option>
              <option value="1">1년 미만</option>
              <option value="3">1~3년</option>
              <option value="5">3~5년</option>
              <option value="10">5~10년</option>
              <option value="15">10년 이상</option>
            </select>
          </div>
          <div class="form-group">
            <label>사업자등록번호</label>
            <input type="text" id="businessNumber" placeholder="000-00-00000 (선택사항)">
            <div class="form-hint">사업자등록번호가 있으면 심사가 빨라집니다.</div>
          </div>
          <div class="form-group">
            <label>포트폴리오 링크</label>
            <input type="url" id="portfolioUrl" placeholder="https://... (선택사항)">
            <div class="form-hint">홈페이지, 블로그, 인스타그램 등</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-edit" onclick="closeUpgradeModal()">취소</button>
        <button type="submit" form="upgradeForm" class="btn-upgrade">신청하기</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase 설정
    const SUPABASE_URL = 'https://vvqrvgcgnlfpiqqndsve.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2cXJ2Z2NnbmxmcGlxcW5kc3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTYyMjYsImV4cCI6MjA4MzQzMjIyNn0.WvMdB2bojqRUjYWdljAcxP1yHqQZJwuyv2equltyWWQ';

    let supabaseClient = null;
    let currentUser = null;

    // Supabase 초기화
    try {
      if (typeof window.supabase !== 'undefined') {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.error('Supabase 초기화 오류:', e);
    }

    // 페이지 로드
    async function init() {
      if (!supabaseClient) {
        alert('서비스에 연결할 수 없습니다.');
        window.location.href = 'login.html';
        return;
      }

      const { data: { session } } = await supabaseClient.auth.getSession();

      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = session.user;
      await loadUserProfile();
    }

    // 사용자 프로필 로드
    async function loadUserProfile() {
      const user = currentUser;
      const meta = user.user_metadata || {};

      // 프로필 표시
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      // 이름
      const name = meta.name || meta.full_name || user.email.split('@')[0];
      document.getElementById('profileName').textContent = name;
      document.getElementById('profileAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('infoName').textContent = name;

      // 이메일
      document.getElementById('profileEmail').textContent = user.email;
      document.getElementById('infoEmail').textContent = user.email;

      // 연락처
      document.getElementById('infoPhone').textContent = meta.phone || '미등록';

      // 지역
      const location = meta.sido && meta.gugun ? `${meta.sido} ${meta.gugun}` : (meta.sido || '미등록');
      document.getElementById('infoLocation').textContent = location;

      // 가입일
      const joinedDate = new Date(user.created_at).toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      document.getElementById('infoJoined').textContent = joinedDate;

      // 등급
      const tier = meta.tier || 'standard';
      const tierEl = document.getElementById('profileTier');
      tierEl.className = 'profile-tier tier-' + tier;
      tierEl.textContent = tier === 'expert' ? 'Expert' : tier === 'business' ? 'Business' : 'Standard';

      // Expert 이상이면 업그레이드 버튼 숨김
      if (tier === 'expert' || tier === 'business') {
        document.getElementById('btnUpgrade').style.display = 'none';
      }

      // Expert 등급이면 AI 설계 링크를 detaildesign으로 변경
      if (tier === 'expert' || tier === 'business') {
        const actionDesign = document.getElementById('actionDesign');
        actionDesign.href = 'detaildesign.html';
        actionDesign.querySelector('span').textContent = '상세 설계 도구';
      }

      // 기존 승급 신청 확인
      await checkExistingUpgradeRequest();
    }

    // 기존 승급 신청 확인
    async function checkExistingUpgradeRequest() {
      try {
        const { data: requests, error } = await supabaseClient
          .from('expert_requests')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(1);

        if (error) throw error;

        if (requests && requests.length > 0) {
          const request = requests[0];
          const statusEl = document.getElementById('upgradeStatus');
          const titleEl = document.getElementById('upgradeStatusTitle');
          const descEl = document.getElementById('upgradeStatusDesc');

          if (request.status === 'pending') {
            statusEl.className = 'upgrade-status pending';
            titleEl.textContent = 'Expert 승급 심사 중';
            descEl.textContent = '관리자 확인 후 승인됩니다. 신청일: ' + formatDate(request.created_at);
            statusEl.style.display = 'flex';
            document.getElementById('btnUpgrade').style.display = 'none';
          } else if (request.status === 'rejected') {
            statusEl.className = 'upgrade-status rejected';
            titleEl.textContent = 'Expert 승급 신청이 반려되었습니다';
            descEl.textContent = request.admin_memo || '다시 신청하실 수 있습니다.';
            statusEl.style.display = 'flex';
            // 재신청 가능
            document.getElementById('btnUpgrade').textContent = '다시 신청하기';
          }
        }
      } catch (e) {
        console.log('승급 신청 확인 실패 (테이블이 없을 수 있음):', e.message);
      }
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('ko-KR');
    }

    // 프로필 수정
    function openEditProfile() {
      alert('프로필 수정 기능은 준비 중입니다.');
    }

    // Expert 업그레이드 모달 열기
    function requestUpgrade() {
      document.getElementById('upgradeModal').classList.add('active');
    }

    // Expert 업그레이드 모달 닫기
    function closeUpgradeModal() {
      document.getElementById('upgradeModal').classList.remove('active');
    }

    // Expert 업그레이드 신청 제출
    async function submitUpgradeRequest(e) {
      e.preventDefault();

      const companyName = document.getElementById('companyName').value.trim();
      const businessType = document.getElementById('businessType').value;
      const careerYears = parseInt(document.getElementById('careerYears').value);
      const businessNumber = document.getElementById('businessNumber').value.trim();
      const portfolioUrl = document.getElementById('portfolioUrl').value.trim();

      if (!companyName || !businessType || !careerYears) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
      }

      try {
        const meta = currentUser.user_metadata || {};

        const { error } = await supabaseClient
          .from('expert_requests')
          .insert({
            user_id: currentUser.id,
            user_email: currentUser.email,
            user_name: meta.name || meta.full_name || null,
            current_tier: meta.tier || 'standard',
            requested_tier: 'expert',
            company_name: companyName,
            business_type: businessType,
            career_years: careerYears,
            business_number: businessNumber || null,
            portfolio_url: portfolioUrl || null,
            status: 'pending'
          });

        if (error) throw error;

        alert('Expert 등급 신청이 완료되었습니다.\n관리자 확인 후 승인됩니다.');
        closeUpgradeModal();

        // 상태 업데이트
        document.getElementById('upgradeStatus').className = 'upgrade-status pending';
        document.getElementById('upgradeStatusTitle').textContent = 'Expert 승급 심사 중';
        document.getElementById('upgradeStatusDesc').textContent = '관리자 확인 후 승인됩니다.';
        document.getElementById('upgradeStatus').style.display = 'flex';
        document.getElementById('btnUpgrade').style.display = 'none';

      } catch (error) {
        console.error('Error:', error);
        if (error.message.includes('expert_requests')) {
          alert('승급 신청 기능을 사용하려면 관리자에게 문의하세요.\n(데이터베이스 설정 필요)');
        } else {
          alert('신청 중 오류가 발생했습니다: ' + error.message);
        }
      }
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('upgradeModal').addEventListener('click', (e) => {
      if (e.target.id === 'upgradeModal') {
        closeUpgradeModal();
      }
    });

    // 로그아웃
    async function logout() {
      if (!supabaseClient) return;

      await supabaseClient.auth.signOut();
      window.location.href = 'index.html';
    }

    // 초기화
    init();
  </script>
</body>
</html>
