{
  "name": "Dadam Interior v8 (Claude Analysis)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dadam-interior-v4",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "099d2b78-2665-4ffc-a361-c530c3b043bf",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        18944,
        9360
      ],
      "webhookId": "c409630f-2f2c-4fcc-a00d-736eb9cfa9f6"
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // Parse Input v2 - Material Code Detection\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n  const body = $input.first().json.body || $input.first().json;\n\n  const category = body.category || 'sink';\n  const style = body.design_style || body.style || 'modern';\n  const roomImage = body.room_image || '';\n  const imageType = body.image_type || 'image/jpeg';\n\n  const triggerMap = {\n    sink: ['ÏÉÅÎ∂ÄÏû•', 'ÌïòÎ∂ÄÏû•', 'Í±∏Î†àÎ∞õÏù¥', 'ÎèÑÏñ¥Í∑úÍ≤©', 'Î™∞Îî©', 'Î∞∞Í≤ΩÎ≥¥Ï†ï', 'Î≤ΩÎ©¥ÎßàÍ∞ê', 'Ï≤úÏû•ÎßàÍ∞ê', 'Î∞îÎã•ÎßàÍ∞ê'],\n    wardrobe: ['Î∂ôÎ∞ïÏù¥Ïû•', 'Ï¢åÎåÄ', 'ÏÉÅÎ™∞Îî©', 'ÏßßÏùÄÏò∑', 'Í∏¥Ïò∑', 'ÏÑúÎûç', 'Ïä§ÎßàÌä∏Î∞î', 'Î∞∞Í≤ΩÎ≥¥Ï†ï', 'Î≤ΩÎ©¥ÎßàÍ∞ê'],\n    fridge: ['ÎÉâÏû•Í≥†Ïû•', 'ÏÉÅÎ∂ÄÏû•', 'ELÏû•', 'ÌôàÏπ¥Ìéò', 'Î∞∞Í≤ΩÎ≥¥Ï†ï', 'Î≤ΩÎ©¥ÎßàÍ∞ê', 'Ï≤úÏû•ÎßàÍ∞ê', 'Î∞îÎã•ÎßàÍ∞ê']\n  };\n\n  function detectMaterialCodes(styleText) {\n    if (!styleText) return [];\n    const materialPatterns = [\n      /YPG-\\d+/gi, /YPA-\\d+/gi, /YPW-\\d+/gi, /SM-\\d+/gi, /SG-\\d+/gi,\n      /CP-\\d+/gi, /PW-\\d+/gi, /LC-\\d+/gi, /PL-\\d+/gi, /PM-\\d+/gi,\n      /PE-\\d+/gi, /AM-\\d+/gi, /LP-\\d+/gi, /HS\\d+/gi, /HC\\d+/gi,\n      /HP\\d+/gi, /HW\\d+/gi, /MFB-\\d+/gi, /LS-\\d+/gi,\n    ];\n    const detectedCodes = [];\n    for (const pattern of materialPatterns) {\n      const matches = styleText.match(pattern);\n      if (matches) detectedCodes.push(...matches.map(m => m.toUpperCase()));\n    }\n    return [...new Set(detectedCodes)];\n  }\n\n  function detectColorKeywords(styleText) {\n    if (!styleText) return [];\n    const colorPatterns = [\n      'ÌôîÏù¥Ìä∏', 'Í∑∏Î†àÏù¥', 'Î∏îÎûô', 'ÏïÑÏù¥Î≥¥Î¶¨', 'Î≤†Ïù¥ÏßÄ', 'Î∏åÎùºÏö¥',\n      'Ïò§ÌÅ¨', 'ÏõîÎÑõ', 'Ï≤¥Î¶¨', 'Ïï†Ïâ¨', 'ÎÑ§Ïù¥ÎπÑ', 'Î∏îÎ£®', 'Í∑∏Î¶∞', 'ÌïëÌÅ¨', 'Î†àÎìú', 'ÏòêÎ°úÏö∞',\n      'Î¨¥Í¥ë', 'Ïú†Í¥ë', 'ÌéÑ', 'Îß§Ìä∏', 'Í∏ÄÎ°úÏãú',\n      'ÎßàÎ∏î', 'Ïä§ÌÜ§', 'ÏΩòÌÅ¨Î¶¨Ìä∏', 'Ïö∞Îìú', 'Í∞ÄÏ£Ω', 'Î†àÎçî',\n      'ÎπÑÏä§Ìè¨ÌÅ¨', 'Îâ¥Ìä∏Î°ú', 'ÌîåÎ†àÏù¥', 'Î∂ÅÏú†ÎüΩ', 'Î™®Îçò', 'ÎØ∏ÎãàÎ©Ä',\n      'white', 'grey', 'gray', 'black', 'ivory', 'beige', 'brown',\n      'oak', 'walnut', 'matte', 'glossy', 'pearl',\n      'marble', 'stone', 'wood', 'bespoke', 'modern', 'minimal'\n    ];\n    const detected = [];\n    const lowerStyle = styleText.toLowerCase();\n    for (const keyword of colorPatterns) {\n      if (styleText.includes(keyword) || lowerStyle.includes(keyword.toLowerCase())) {\n        detected.push(keyword);\n      }\n    }\n    return [...new Set(detected)];\n  }\n\n  const materialCodes = detectMaterialCodes(style);\n  const colorKeywords = detectColorKeywords(style);\n  let triggers = [...(triggerMap[category] || triggerMap.sink)];\n  if (materialCodes.length > 0) triggers = [...triggers, ...materialCodes];\n  if (colorKeywords.length > 0) triggers = [...triggers, ...colorKeywords.slice(0, 5)];\n\n  // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌîÑÎ°¨ÌîÑÌä∏ (ÏÉÅÏÑ∏ ÏòµÏÖò Í∏∞Î∞ò)\n  const clientPrompt = body.prompt || '';\n  const negativePrompt = body.negative_prompt || '';\n  const cabinetSpecs = body.cabinet_specs || {};\n\n  return {\n    category, style, roomImage, imageType, triggers,\n    materialCodes, colorKeywords,\n    hasMaterialRequest: materialCodes.length > 0 || colorKeywords.length > 0,\n    clientPrompt, negativePrompt, cabinetSpecs\n  };"
      },
      "id": "d51b42b8-0ad9-4f87-875f-bfe4fc32d105",
      "name": "Parse Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19136,
        9360
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Build Claude Analysis Request\n// Claude APIÎ•º ÏÇ¨Ïö©Ìïú Ï†ïÎ∞Ä Î∞∞Í¥Ä Î∂ÑÏÑù\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $input.first().json;\n\nconst analysisPrompt = `ÎãπÏã†ÏùÄ ÌïúÍµ≠ Ï£ºÎ∞© ÏãúÍ≥µ ÌòÑÏû•Ïùò Î∞∞Í¥Ä ÏúÑÏπòÎ•º Î∂ÑÏÑùÌïòÎäî Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.\n\nÏù¥ Ïù¥ÎØ∏ÏßÄÎ•º Î∂ÑÏÑùÌïòÏó¨ Îã§Ïùå ÏÑ§ÎπÑÏùò ÏúÑÏπòÎ•º Ï†ïÌôïÌïòÍ≤å Ï∞æÏïÑÏ£ºÏÑ∏Ïöî.\n\n[Î∂ÑÏÑù ÎåÄÏÉÅ]\n1. Í∏âÏàò Î∞∞Í¥Ä (Water Supply Pipe)\n   - ÌäπÏßï: Îπ®Í∞ÑÏÉâ/ÌååÎûÄÏÉâ Î∞∞Í¥Ä, Ìù∞ÏÉâ Î∂ÑÎ∞∞Í∏∞ Î∞ïÏä§, PVC Î∞∞Í¥Ä\n   - Î≥¥ÌÜµ ÏúÑÏπò: Î≤ΩÎ©¥ ÌïòÎã®, Î∞îÎã•ÏóêÏÑú 200-400mm ÎÜíÏù¥\n\n2. Î∞∞Í∏∞ ÎçïÌä∏ (Exhaust Duct)\n   - ÌäπÏßï: ÏïåÎ£®ÎØ∏ÎäÑ ÌîåÎ†âÏãúÎ∏î ÎçïÌä∏ (ÏùÄÏÉâ), ÏõêÌòï Íµ¨Î©ç, ÌôòÍ∏∞Íµ¨\n   - Î≥¥ÌÜµ ÏúÑÏπò: Ï≤úÏû• Í∑ºÏ≤ò, ÏÉÅÎ∂Ä Î≤ΩÎ©¥\n\n3. Í∞ÄÏä§ Î∞∞Í¥Ä (Gas Pipe)\n   - ÌäπÏßï: ÎÖ∏ÎûÄÏÉâ Î∞∞Í¥Ä, Í∞ÄÏä§ Î∞∏Î∏å, Í∞ÄÏä§ ÏΩï\n   - Î≥¥ÌÜµ ÏúÑÏπò: Î≤ΩÎ©¥ ÌïòÎã®, Î∞îÎã•ÏóêÏÑú 300-500mm ÎÜíÏù¥\n\n4. Ï†ÑÍ∏∞ ÏΩòÏÑºÌä∏ (Electrical Outlets)\n   - ÌäπÏßï: Ìù∞ÏÉâ ÌîåÎùºÏä§Ìã± Î∞ïÏä§, ÏΩòÏÑºÌä∏ Ïª§Î≤Ñ\n   - Î≥¥ÌÜµ ÏúÑÏπò: Ïπ¥Ïö¥ÌÑ∞ ÎÜíÏù¥ (Î∞îÎã•ÏóêÏÑú 1000-1200mm)\n\n[ÏúÑÏπò Ï∏°Ï†ï Î∞©Î≤ï]\n- Ïù¥ÎØ∏ÏßÄÏùò Í∞ÄÎ°úÎ•º 0%~100%Î°ú Î¥ÖÎãàÎã§\n- 0% = Ïù¥ÎØ∏ÏßÄ Îß® ÏôºÏ™Ω\n- 100% = Ïù¥ÎØ∏ÏßÄ Îß® Ïò§Î•∏Ï™Ω\n- Í∞Å ÏÑ§ÎπÑÏùò Ï§ëÏã¨Ï†êÏù¥ Î™á % ÏúÑÏπòÏóê ÏûàÎäîÏßÄ Ï∏°Ï†ïÌïòÏÑ∏Ïöî\n\n[Ï∂úÎ†• ÌòïÏãù - Î∞òÎìúÏãú JSONÎßå Ï∂úÎ†•]\n{\n  \"image_analysis\": {\n    \"wall_structure\": {\n      \"lower_tile\": \"ÌÉÄÏùº ÏÉâÏÉÅ Î∞è ÎÜíÏù¥\",\n      \"upper_wall\": \"ÏÉÅÎ∂Ä Î≤ΩÎ©¥ ÎßàÍ∞ê\",\n      \"estimated_width_mm\": 3000,\n      \"estimated_height_mm\": 2400\n    },\n    \"water_supply\": {\n      \"detected\": true,\n      \"position_percent\": 38,\n      \"position_description\": \"Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ÏïΩ 38% ÏßÄÏ†ê\",\n      \"visual_features\": \"Ìù∞ÏÉâ Î∞∞Í¥Ä Î∞ïÏä§, PVC Ïó∞Í≤∞Î∂Ä\",\n      \"height_from_floor\": \"ÏïΩ 350mm\",\n      \"confidence\": \"high\"\n    },\n    \"exhaust_duct\": {\n      \"detected\": true,\n      \"position_percent\": 72,\n      \"position_description\": \"Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ÏïΩ 72% ÏßÄÏ†ê\",\n      \"visual_features\": \"ÏïåÎ£®ÎØ∏ÎäÑ ÌîåÎ†âÏãúÎ∏î ÎçïÌä∏, ÏùÄÏÉâ\",\n      \"height_from_floor\": \"Ï≤úÏû• Í∑ºÏ≤ò\",\n      \"confidence\": \"high\"\n    },\n    \"gas_pipe\": {\n      \"detected\": false,\n      \"position_percent\": null,\n      \"visual_features\": null,\n      \"confidence\": \"low\"\n    },\n    \"electrical_outlets\": [\n      {\n        \"position_percent\": 45,\n        \"height\": \"Ïπ¥Ïö¥ÌÑ∞ ÎÜíÏù¥\"\n      }\n    ],\n    \"construction_debris\": [\n      \"ÏûëÏóÖÎåÄ\",\n      \"Í≥µÍµ¨\",\n      \"ÏãúÎ©òÌä∏ Ìè¨ÎåÄ\"\n    ]\n  },\n  \"furniture_placement_recommendation\": {\n    \"sink_center_percent\": 38,\n    \"cooktop_center_percent\": 72,\n    \"layout_direction\": \"left_to_right\"\n  }\n}\n\nÏ§ëÏöî: JSON ÌòïÏãùÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî. Îã§Î•∏ ÏÑ§Î™ÖÏùÄ Î∂àÌïÑÏöîÌï©ÎãàÎã§.`;\n\nconst claudeRequestBody = {\n  model: 'claude-sonnet-4-20250514',\n  max_tokens: 2048,\n  messages: [\n    {\n      role: 'user',\n      content: [\n        {\n          type: 'image',\n          source: {\n            type: 'base64',\n            media_type: input.imageType || 'image/jpeg',\n            data: input.roomImage\n          }\n        },\n        {\n          type: 'text',\n          text: analysisPrompt\n        }\n      ]\n    }\n  ]\n};\n\nreturn {\n  claudeRequestBody: JSON.stringify(claudeRequestBody),\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  manualPositions: input.manualPositions,\n  hasManualPositions: input.hasManualPositions\n};"
      },
      "id": "c9397227-5182-45e6-8849-46768dacf112",
      "name": "Build Claude Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19328,
        9360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{$env.ANTHROPIC_API_KEY}}"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.claudeRequestBody }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "25b0ee8c-a3d7-4a5f-8474-47b0f84870af",
      "name": "Claude Pipe Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        19520,
        9360
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Parse Claude Analysis Result v2 - Manual Position Ïö∞ÏÑ† Ï†ÅÏö©\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $('Build Claude Request').first().json;\nconst response = $input.first().json;\n\n// ÏàòÎèô ÏúÑÏπòÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏\nconst manualPos = input.manualPositions;\nconst hasManual = input.hasManualPositions;\n\nlet analysisResult = {\n  water_supply_percent: 30,\n  exhaust_duct_percent: 70,\n  gas_pipe_percent: null,\n  confidence: 'low',\n  wall_width_mm: 3000,\n  wall_height_mm: 2400,\n  source: 'default'\n};\n\n// 1. Î®ºÏ†Ä Claude Î∂ÑÏÑù Í≤∞Í≥º ÌååÏã± ÏãúÎèÑ\ntry {\n  const content = response.content || [];\n  for (const block of content) {\n    if (block.type === 'text' && block.text) {\n      const jsonMatch = block.text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        \n        analysisResult = {\n          water_supply_percent: parsed.image_analysis?.water_supply?.position_percent || parsed.furniture_placement_recommendation?.sink_center_percent || 30,\n          water_supply_features: parsed.image_analysis?.water_supply?.visual_features || '',\n          water_supply_confidence: parsed.image_analysis?.water_supply?.confidence || 'low',\n          \n          exhaust_duct_percent: parsed.image_analysis?.exhaust_duct?.position_percent || parsed.furniture_placement_recommendation?.cooktop_center_percent || 70,\n          exhaust_duct_features: parsed.image_analysis?.exhaust_duct?.visual_features || '',\n          exhaust_duct_confidence: parsed.image_analysis?.exhaust_duct?.confidence || 'low',\n          \n          gas_pipe_percent: parsed.image_analysis?.gas_pipe?.detected ? parsed.image_analysis.gas_pipe.position_percent : null,\n          \n          wall_width_mm: parsed.image_analysis?.wall_structure?.estimated_width_mm || 3000,\n          wall_height_mm: parsed.image_analysis?.wall_structure?.estimated_height_mm || 2400,\n          \n          construction_debris: parsed.image_analysis?.construction_debris || [],\n          \n          confidence: (parsed.image_analysis?.water_supply?.confidence === 'high' && parsed.image_analysis?.exhaust_duct?.confidence === 'high') ? 'high' : 'medium',\n          source: 'claude'\n        };\n      }\n    }\n  }\n} catch (e) {\n  console.log('Parse error:', e.message);\n}\n\n// 2. ÏàòÎèô ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞ (ÏµúÏö∞ÏÑ† Ï†ÅÏö©!)\nif (hasManual) {\n  if (manualPos.water_pipe) {\n    analysisResult.water_supply_percent = manualPos.water_pipe.x;\n    analysisResult.water_supply_features = 'ÏÇ¨Ïö©Ïûê ÏßÅÏ†ë ÌëúÏãú';\n    analysisResult.water_supply_confidence = 'manual';\n  }\n  if (manualPos.exhaust_duct) {\n    analysisResult.exhaust_duct_percent = manualPos.exhaust_duct.x;\n    analysisResult.exhaust_duct_features = 'ÏÇ¨Ïö©Ïûê ÏßÅÏ†ë ÌëúÏãú';\n    analysisResult.exhaust_duct_confidence = 'manual';\n  }\n  analysisResult.source = 'manual';\n  analysisResult.confidence = 'high'; // ÏÇ¨Ïö©Ïûê ÌëúÏãúÎäî Ìï≠ÏÉÅ Ïã†Î¢∞ÎèÑ high\n}\n\nreturn [{\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  analysisResult,\n  analysisMethod: hasManual ? 'manual' : 'claude'\n}];"
      },
      "id": "864f6f17-fdbe-4822-a499-2117fc71218f",
      "name": "Parse Claude Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19712,
        9360
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Build Background Cleanup Prompt v2\n// Ï†ÑÏÑ† Ï†úÍ±∞ + ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ Î≥¥Ï†ï Ï∂îÍ∞Ä\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $input.first().json;\nconst analysis = input.analysisResult;\n\nconst debrisList = analysis.construction_debris?.length > 0 \n  ? analysis.construction_debris.join(', ')\n  : 'Í≥µÏÇ¨ ÏûîÌï¥, Í≥µÍµ¨, ÏûÑÏãú Î¨ºÍ±¥';\n\nconst cleanupPrompt = `[TASK: BACKGROUND CLEANUP - STRUCTURE PRESERVATION]\n\n‚òÖ‚òÖ‚òÖ ABSOLUTE RULES ‚òÖ‚òÖ‚òÖ\n\n[MUST PRESERVE - Ï†àÎåÄ Î≥ÄÍ≤Ω Í∏àÏßÄ]\n1. Î≤ΩÎ©¥ ÏúÑÏπòÏôÄ Í∞ÅÎèÑ\n2. Î∞îÎã• ÏúÑÏπòÏôÄ Î†àÎ≤®\n3. Ï≤úÏû• ÎÜíÏù¥ÏôÄ ÏúÑÏπò\n4. Ï∞ΩÎ¨∏/Î¨∏ ÏúÑÏπòÏôÄ ÌÅ¨Í∏∞\n5. Ïπ¥Î©îÎùº ÏïµÍ∏ÄÍ≥º ÏãúÏ†ê\n6. Ï°∞Î™Ö Î∞©Ìñ•\n\n[MUST REMOVE - Ï†úÍ±∞ ÎåÄÏÉÅ]\n${debrisList}\n- ÏÇ¨Îûå\n- Ïò∑Í±∏Ïù¥ÏôÄ Ïò∑\n- ÏûÑÏãú ÏûëÏóÖÎåÄ\n- Í≥µÍµ¨ÏôÄ Ïû•ÎπÑ\n- ÏãúÎ©òÌä∏ Ìè¨ÎåÄ\n- Î™®Îì† Í≥µÏÇ¨ ÏûîÌï¥\n\n‚òÖ‚òÖ‚òÖ Ï†ÑÏÑ† Ï†úÍ±∞ - WIRE REMOVAL ‚òÖ‚òÖ‚òÖ\n- ÎÖ∏Ï∂úÎêú Ï†ÑÏÑ† Î™®Îëê Ï†úÍ±∞\n- Î≤ΩÎ©¥Ïóê ÎìúÎü¨ÎÇú Î∞∞ÏÑ† Ï†úÍ±∞\n- Ï≤úÏû•Ïùò ÎÖ∏Ï∂ú Ï†ÑÏÑ† Ï†úÍ±∞\n- Ï†ÑÏÑ†Ïù¥ ÏûàÎçò ÏûêÎ¶¨Îäî Ï£ºÎ≥Ä Î≤ΩÎ©¥/Ï≤úÏû•Í≥º ÎèôÏùºÌïòÍ≤å Î≥¥Ï†ï\n\n‚òÖ‚òÖ‚òÖ ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ Î≥¥Ï†ï - UNFINISHED AREA REPAIR ‚òÖ‚òÖ‚òÖ\n- ÎßàÍ∞êÎêòÏßÄ ÏïäÏùÄ Î≤ΩÎ©¥: Ï£ºÎ≥ÄÏùò ÎπÑÏä∑Ìïú ÏÜåÏû¨/ÏÉâÏÉÅÏúºÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Î≥¥Ï†ï\n- ÎßàÍ∞êÎêòÏßÄ ÏïäÏùÄ Ï≤úÏû•: Ï£ºÎ≥Ä Ï≤úÏû•Í≥º ÎèôÏùºÌïú ÏÉâÏÉÅ(Ìù∞ÏÉâ)ÏúºÎ°ú Î≥¥Ï†ï\n- ÏÑùÍ≥†Î≥¥Îìú ÎÖ∏Ï∂ú Î∂ÄÎ∂Ñ: Ï£ºÎ≥Ä ÎßàÍ∞êÏû¨ÏôÄ ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨\n- ÏãúÎ©òÌä∏/ÏΩòÌÅ¨Î¶¨Ìä∏ ÎÖ∏Ï∂ú: Ï£ºÎ≥Ä ÌÉÄÏùºÏù¥ÎÇò ÌéòÏù∏Ìä∏Î°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïó∞Í≤∞\n- ÌÉÄÏùºÏù¥ Îπ†ÏßÑ Î∂ÄÎ∂Ñ: Ï£ºÎ≥Ä ÌÉÄÏùº Ìå®ÌÑ¥Í≥º ÎèôÏùºÌïòÍ≤å Ï±ÑÏö∞Í∏∞\n\n‚òÖ‚òÖ‚òÖ Î∞∞Í∏∞ÎçïÌä∏ Ï£ºÎ≥Ä ÎßàÍ∞ê - EXHAUST DUCT AREA FINISHING ‚òÖ‚òÖ‚òÖ\n- ÎçïÌä∏ Ï£ºÎ≥Ä Î≤ΩÎ©¥: Îß§ÎÅÑÎüΩÍ≤å ÌéòÏù∏Ìä∏ Ï≤òÎ¶¨ (Ìù∞ÏÉâ ÎòêÎäî Ï£ºÎ≥Ä Î≤Ω ÏÉâÏÉÅ)\n- ÎçïÌä∏ Ï£ºÎ≥Ä ÏñºÎ£©/Î®ºÏßÄ: ÏôÑÏ†ÑÌûà Ï†úÍ±∞\n\n[MUST IMPROVE - ÎßàÍ∞ê Ï≤òÎ¶¨]\n1. Î≤ΩÎ©¥ ÌïòÎã®: Í∏∞Ï°¥ ÌÉÄÏùº Ìå®ÌÑ¥ Ïú†ÏßÄÌïòÎ©∞ Íπ®ÎÅóÌïòÍ≤å\n2. Î≤ΩÎ©¥ ÏÉÅÎã®: Ï£ºÎ≥ÄÍ≥º ÎèôÏùºÌïú ÏÉâÏÉÅÏúºÎ°ú Îß§ÎÅÑÎüΩÍ≤å\n3. Î∞îÎã•: Íπ®ÎÅóÌïú ÌÉÄÏùº ÎòêÎäî ÎßàÍ∞êÏû¨\n4. Ï≤úÏû•: Íπ®ÎÅóÌïú Ìù∞ÏÉâ, Ï°∞Î™Ö Ïú†ÏßÄ\n\n[KEEP VISIBLE - Ïú†ÏßÄÌï† ÏÑ§ÎπÑ (ÍπîÎÅîÌïòÍ≤å ÎßàÍ∞êÎêú ÏÉÅÌÉúÎ°ú)]\n- Í∏âÏàò Î∞∞Í¥Ä ÏúÑÏπò: ${analysis.water_supply_percent}% ÏßÄÏ†ê\n  ‚Üí ÍπîÎÅîÌïú Î≤ΩÎ©¥Ïóê Î∞∞Í¥Ä Ïó∞Í≤∞Î∂ÄÎßå ÌëúÏãú (Ï∫° ÏîåÏö¥ ÏÉÅÌÉú)\n- Î∞∞Í∏∞ ÎçïÌä∏ ÏúÑÏπò: ${analysis.exhaust_duct_percent}% ÏßÄÏ†ê\n  ‚Üí ÎçïÌä∏ Ï£ºÎ≥Ä Î≤ΩÎ©¥/Ï≤úÏû•ÏùÄ Îß§ÎÅÑÎüΩÍ≤å ÎßàÍ∞ê\n${analysis.gas_pipe_percent ? '- Í∞ÄÏä§ Î∞∞Í¥Ä ÏúÑÏπò: ' + analysis.gas_pipe_percent + '% ÏßÄÏ†ê (ÍπîÎÅîÌïú Í∞ÄÏä§ Î∞∏Î∏åÎßå ÌëúÏãú)' : ''}\n\n[OUTPUT]\n- Íπ®ÎÅóÌïòÍ≤å ÎßàÍ∞êÎêú Îπà Í≥µÍ∞Ñ\n- Ï†ÑÏÑ† ÏóÜÏùå\n- ÎØ∏ÎßàÍ∞ê Î∂ÄÎ∂Ñ ÏóÜÏùå\n- Í∞ÄÍµ¨ ÏÑ§Ïπò Ï§ÄÎπÑ ÏôÑÎ£å ÏÉÅÌÉú`;\n\nconst geminiCleanupBody = {\n  contents: [{\n    parts: [\n      { text: cleanupPrompt },\n      { inline_data: { mime_type: input.imageType || 'image/jpeg', data: input.roomImage }}\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.3 }\n};\n\nreturn {\n  geminiCleanupBody: JSON.stringify(geminiCleanupBody),\n  category: input.category,\n  style: input.style,\n  roomImage: input.roomImage,\n  imageType: input.imageType,\n  analysisResult: analysis\n};"
      },
      "id": "8e547387-a72c-43e0-9d59-c9c0169a92cd",
      "name": "Build Cleanup Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19904,
        9360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key={{$env.GEMINI_API_KEY}}",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiCleanupBody }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "ef110b01-1af9-4d44-8645-4d71bec9c203",
      "name": "Gemini Background Cleanup",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        20096,
        9360
      ]
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Parse Background + Build Furniture Prompt (Claude Î∂ÑÏÑù Í≤∞Í≥º ÏÇ¨Ïö©)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst input = $('Build Cleanup Prompt').first().json;\nconst response = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet cleanedBackground = null;\ntry {\n  const candidates = response.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inlineData || part.inline_data) {\n        cleanedBackground = (part.inlineData || part.inline_data).data;\n      }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\n// ÏúÑÏπò ÏÑ§Î™Ö Ìï®Ïàò\nfunction describePosition(percent) {\n  if (percent <= 20) return 'Îß® ÏôºÏ™Ω ÏòÅÏó≠';\n  if (percent <= 40) return 'ÏôºÏ™Ω ÏòÅÏó≠';\n  if (percent <= 60) return 'Ï§ëÏïô ÏòÅÏó≠';\n  if (percent <= 80) return 'Ïò§Î•∏Ï™Ω ÏòÅÏó≠';\n  return 'Îß® Ïò§Î•∏Ï™Ω ÏòÅÏó≠';\n}\n\nconst waterPercent = analysis.water_supply_percent;\nconst exhaustPercent = analysis.exhaust_duct_percent;\nconst waterDesc = describePosition(waterPercent);\nconst exhaustDesc = describePosition(exhaustPercent);\n\nconst furniturePrompt = `[TASK: FURNITURE PLACEMENT - CLAUDE ANALYZED POSITIONS]\n\n‚òÖ‚òÖ‚òÖ Î∞∞Í≤Ω Î≥¥Ï°¥ ÌïÑÏàò ‚òÖ‚òÖ‚òÖ\nÏù¥ Ïù¥ÎØ∏ÏßÄÎäî Ï†ïÎ¶¨Îêú Î∞∞Í≤ΩÏûÖÎãàÎã§.\nÎ∞∞Í≤ΩÏùÑ Ï†àÎåÄ ÏàòÏ†ïÌïòÏßÄ ÎßêÍ≥†, Í∞ÄÍµ¨Îßå Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n‚òÖ‚òÖ‚òÖ CLAUDE AI Î∂ÑÏÑù Í≤∞Í≥º Í∏∞Î∞ò Ï†ïÎ∞Ä Î∞∞Ïπò ‚òÖ‚òÖ‚òÖ\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n[Î∂ÑÏÑù Ïã†Î¢∞ÎèÑ: ${analysis.confidence}]\n\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 0%          25%          50%          75%          100%    ‚îÇ\n‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§        ‚îÇ\n‚îÇ      ${waterPercent < 50 ? '‚ñº' : ' '}                              ${exhaustPercent > 50 ? '‚ñº' : ' '}              ‚îÇ\n‚îÇ   Í∏âÏàòÎ∞∞Í¥Ä(${waterPercent}%)                    Î∞∞Í∏∞ÎçïÌä∏(${exhaustPercent}%)         ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n[Í∏∞Ï§ÄÏ†ê 1: Í∏âÏàòÎ∞∞Í¥Ä ‚Üí Ïã±ÌÅ¨Î≥º Ï§ëÏã¨]\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìç Claude Î∂ÑÏÑù ÏúÑÏπò: Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ${waterPercent}% ÏßÄÏ†ê\nüìç ÏòÅÏó≠: ${waterDesc}\nüìç Í∞êÏßÄ ÌäπÏßï: ${analysis.water_supply_features || 'Î∞∞Í¥Ä Î∞ïÏä§'}\nüìç Ïã†Î¢∞ÎèÑ: ${analysis.water_supply_confidence || 'medium'}\n\n‚Üí Ïã±ÌÅ¨Î≥º(SINK BOWL) Ï§ëÏã¨ÏùÑ Ï†ïÌôïÌûà ${waterPercent}% ÏßÄÏ†êÏóê Î∞∞Ïπò\n‚Üí ÏàòÏ†Ñ(FAUCET)ÏùÄ Ïã±ÌÅ¨Î≥º Îí§Ï™Ω Ï§ëÏïôÏóê Î∞∞Ïπò\n‚Üí Ïã±ÌÅ¨ Ï∫êÎπÑÎãõÏùÄ Ïã±ÌÅ¨Î≥º Ï§ëÏã¨ÏúºÎ°ú Ï¢åÏö∞ ÎåÄÏπ≠\n\n‚ö†Ô∏è Ïã±ÌÅ¨Î≥ºÏù¥ ${waterPercent}% ÏúÑÏπòÏóê ÏóÜÏúºÎ©¥ Ïã§Ìå®!\n\n[Í∏∞Ï§ÄÏ†ê 2: Î∞∞Í∏∞ÎçïÌä∏ ‚Üí Ïø°ÌÉë Ï§ëÏã¨]\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìç Claude Î∂ÑÏÑù ÏúÑÏπò: Ïù¥ÎØ∏ÏßÄ ÏôºÏ™ΩÏóêÏÑú ${exhaustPercent}% ÏßÄÏ†ê\nüìç ÏòÅÏó≠: ${exhaustDesc}\nüìç Í∞êÏßÄ ÌäπÏßï: ${analysis.exhaust_duct_features || 'ÏïåÎ£®ÎØ∏ÎäÑ ÎçïÌä∏'}\nüìç Ïã†Î¢∞ÎèÑ: ${analysis.exhaust_duct_confidence || 'medium'}\n\n‚Üí Ïø°ÌÉë(COOKTOP) Ï§ëÏã¨ÏùÑ Ï†ïÌôïÌûà ${exhaustPercent}% ÏßÄÏ†êÏóê Î∞∞Ïπò\n‚Üí Î†àÏù∏ÏßÄÌõÑÎìú(RANGE HOOD)Îäî Ïø°ÌÉë Î∞îÎ°ú ÏúÑ, Í∞ôÏùÄ Ï§ëÏã¨ÏÑ†\n‚Üí Ïø°ÌÉë Ï∫êÎπÑÎãõÏùÄ Ïø°ÌÉë Ï§ëÏã¨ÏúºÎ°ú Ï¢åÏö∞ ÎåÄÏπ≠\n\n‚ö†Ô∏è Ïø°ÌÉëÏù¥ ${exhaustPercent}% ÏúÑÏπòÏóê ÏóÜÏúºÎ©¥ Ïã§Ìå®!\n\n[Ï£ºÎ∞© Íµ¨ÏÑ±ÏöîÏÜå - ÌïÑÏàò Ìè¨Ìï®]\n‚úì Ïã±ÌÅ¨Î≥º (Sink Bowl) - Ïä§ÌÖåÏù∏Î¶¨Ïä§, ${waterPercent}% ÏúÑÏπò\n‚úì ÏàòÏ†Ñ (Faucet) - Ïã±ÌÅ¨Î≥º Îí§Ï™Ω\n‚úì Ïø°ÌÉë (Cooktop) - ${exhaustPercent}% ÏúÑÏπò\n‚úì Î†àÏù∏ÏßÄÌõÑÎìú (Range Hood) - Ïø°ÌÉë ÏúÑ\n‚úì ÌïòÎ∂ÄÏû• (Lower Cabinet) - ÎÜíÏù¥ 870mm\n‚úì ÏÉÅÎ∂ÄÏû• (Upper Cabinet) - Ï≤úÏû•Ïóê Î∂ôÏó¨ÏÑú ÏÑ§Ïπò (Ï≤úÏû•Í≥º ÏÉÅÎ∂ÄÏû• ÏÇ¨Ïù¥ Ìãà ÏóÜÏùå)\n‚úì Í±∏Î†àÎ∞õÏù¥ (Toe Kick) - ÌïòÎ∂ÄÏû• ÏïÑÎûò\n\n‚òÖ‚òÖ‚òÖ ÏÉÅÎ∂ÄÏû• ÌïÑÏàò Í∑úÏπô ‚òÖ‚òÖ‚òÖ\n- ÏÉÅÎ∂ÄÏû• ÏÉÅÎã®ÏùÄ Î∞òÎìúÏãú Ï≤úÏû•Ïóê Î∞ÄÏ∞©\n- Ï≤úÏû•Í≥º ÏÉÅÎ∂ÄÏû• ÏÇ¨Ïù¥Ïóê ÌãàÏù¥ ÏûàÏúºÎ©¥ ÏïàÎê®\n- ÏÉÅÎ∂ÄÏû• ÎÜíÏù¥: Ï≤úÏû•ÏóêÏÑú Ïπ¥Ïö¥ÌÑ∞ ÏÉÅÎã®ÍπåÏßÄ Ïó∞Í≤∞\n\n[Ïä§ÌÉÄÏùº: Modern Minimal]\n- ÏÉâÏÉÅ: ÌôîÏù¥Ìä∏, Í∑∏Î†àÏù¥, Ïö∞ÎìúÌÜ§\n- ÎßàÍ∞ê: Î¨¥Í¥ë\n- ÏÜêÏû°Ïù¥: ÌûàÎì† (Ìë∏ÏãúÏò§Ìîà)\n\n[Í≤ÄÏ¶ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏]\n‚òë Ïã±ÌÅ¨Î≥º Ï§ëÏã¨ = ${waterPercent}% ?\n‚òë ÏàòÏ†ÑÏù¥ Ïã±ÌÅ¨Î≥º Îí§Ïóê ÏûàÎäîÍ∞Ä?\n‚òë Ïø°ÌÉë Ï§ëÏã¨ = ${exhaustPercent}% ?\n‚òë Î†àÏù∏ÏßÄÌõÑÎìúÍ∞Ä Ïø°ÌÉë ÏúÑÏóê ÏûàÎäîÍ∞Ä?\n‚òë ÏÉÅÎ∂ÄÏû•Ïù¥ Ï≤úÏû•Ïóê Î∞ÄÏ∞©ÎêòÏñ¥ ÏûàÎäîÍ∞Ä? (Ìãà ÏóÜÏùå)\n\n[Í∏àÏßÄ ÏÇ¨Ìï≠]\n‚ùå Î∞∞Í≤Ω/Î≤Ω/Î∞îÎã• Î≥ÄÍ≤Ω Í∏àÏßÄ\n‚ùå ÌÖçÏä§Ìä∏/ÎùºÎ≤®/ÏπòÏàò Í∏àÏßÄ\n‚ùå Ïã±ÌÅ¨Î≥º/ÏàòÏ†Ñ ÎàÑÎùΩ Í∏àÏßÄ\n‚ùå Ïø°ÌÉë ÏúÑÏπò Ïù¥ÌÉà Í∏àÏßÄ`;\n\nconst geminiFurnitureBody = {\n  contents: [{\n    parts: [\n      { text: furniturePrompt },\n      { inline_data: { mime_type: 'image/png', data: cleanedBackground }}\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.4 }\n};\n\nreturn [{\n  cleanedBackground,\n  hasCleanedBackground: !!cleanedBackground,\n  geminiFurnitureBody: JSON.stringify(geminiFurnitureBody),\n  category: input.category,\n  style: input.style,\n  analysisResult: analysis\n}];"
      },
      "id": "e15fe4e3-2177-4f4d-b42a-05191a8fafd4",
      "name": "Parse BG + Build Furniture",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20288,
        9360
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-bg",
              "leftValue": "={{ $json.hasCleanedBackground }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f5383ac9-ffdb-43d5-9963-33ee4a430ba0",
      "name": "Has Cleaned BG?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        20480,
        9360
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key={{$env.GEMINI_API_KEY}}",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiFurnitureBody }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "5fa83dd4-dbec-4800-81db-cc5952bcdd00",
      "name": "Gemini Furniture",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        20672,
        9248
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse Furniture + Prep Open\nconst input = $('Parse BG + Build Furniture').first().json;\nconst response = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet closedImage = null;\ntry {\n  const candidates = response.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inlineData || part.inline_data) {\n        closedImage = (part.inlineData || part.inline_data).data;\n      }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\nconst openPrompt = `[TASK: OPEN DOORS AND DRAWERS]\n\n‚òÖ‚òÖ‚òÖ Î∞∞Í≤ΩÍ≥º Í∞ÄÍµ¨ ÏúÑÏπò Ïú†ÏßÄ ‚òÖ‚òÖ‚òÖ\n\n[Î≥ÄÍ≤Ω Í∏àÏßÄ]\n- Î∞∞Í≤Ω (Î≤Ω, Î∞îÎã•, Ï≤úÏû•)\n- Í∞ÄÍµ¨ ÏúÑÏπò, ÌÅ¨Í∏∞, ÏÉâÏÉÅ\n- Ïπ¥Î©îÎùº ÏïµÍ∏Ä\n- Ï°∞Î™Ö\n\n[Î≥ÄÍ≤Ω ÏÇ¨Ìï≠]\n- Ïó¨Îã´Ïù¥ ÎèÑÏñ¥: 90ÎèÑ Î∞îÍπ•ÏúºÎ°ú Ïó¥Í∏∞\n- ÏÑúÎûç: 30-40% ÎãπÍ∏∞Í∏∞\n- ÎÇ¥Î∂Ä ÏàòÎÇ©Ìíà Î≥¥Ïù¥Í≤å\n\n[ÎÇ¥Î∂Ä ÏàòÎÇ©Ìíà]\n- Í∑∏Î¶á, Ï†ëÏãú, Ïªµ\n- ÎÉÑÎπÑ, ÌîÑÎùºÏù¥Ìå¨\n- ÏñëÎÖêÌÜµ, Ï°∞ÎØ∏Î£å\n\n[Ï∂úÎ†•]\n- ÎèôÏùºÌïú Í∞ÄÍµ¨, ÎèÑÏñ¥Îßå Ïó¥Î¶∞ ÏÉÅÌÉú\n- Ìè¨ÌÜ†Î¶¨ÏñºÎ¶¨Ïä§Ìã± ÌíàÏßà`;\n\nconst geminiOpenBody = {\n  contents: [{\n    parts: [\n      { inline_data: { mime_type: 'image/png', data: closedImage }},\n      { text: openPrompt }\n    ]\n  }],\n  generationConfig: { responseModalities: ['image', 'text'], temperature: 0.3 }\n};\n\nreturn [{\n  cleanedBackground: input.cleanedBackground,\n  closedImage,\n  hasClosedImage: !!closedImage,\n  geminiOpenBody: JSON.stringify(geminiOpenBody),\n  category: input.category,\n  style: input.style,\n  analysisResult: analysis\n}];"
      },
      "id": "bbec31cd-d4de-421c-a3bf-d95c36257d65",
      "name": "Parse Furniture + Prep Open",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20864,
        9248
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-closed",
              "leftValue": "={{ $json.hasClosedImage }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ad9d9036-7724-4875-8d09-5edcf0cd9e40",
      "name": "Has Closed Image?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        21056,
        9248
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key={{$env.GEMINI_API_KEY}}",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.geminiOpenBody }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "4d057b78-c4f3-4754-94c4-7f7c44757334",
      "name": "Gemini Open Door",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        21248,
        9136
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Furniture + Prep Open').first().json;\nconst openResponse = $input.first().json;\nconst analysis = input.analysisResult;\n\nlet openImage = null;\ntry {\n  const candidates = openResponse.candidates || [];\n  if (candidates.length > 0) {\n    const parts = candidates[0].content?.parts || [];\n    for (const part of parts) {\n      if (part.inline_data?.data) { openImage = part.inline_data.data; break; }\n      if (part.inlineData?.data) { openImage = part.inlineData.data; break; }\n    }\n  }\n} catch (e) { console.log('Parse error:', e.message); }\n\nreturn [{\n  success: true,\n  message: 'Claude Î∂ÑÏÑù + 2Îã®Í≥Ñ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å',\n  processing: 'claude-analysis + 2-stage-generation',\n  category: input.category,\n  style: input.style,\n  pipe_analysis: {\n    method: 'claude',\n    water_supply_percent: analysis.water_supply_percent,\n    exhaust_duct_percent: analysis.exhaust_duct_percent,\n    confidence: analysis.confidence\n  },\n  generated_image: {\n    background: { base64: input.cleanedBackground, mime_type: 'image/png', description: 'Stage 1: Cleaned background' },\n    closed: { base64: input.closedImage, mime_type: 'image/png', description: 'Stage 2: Furniture added (closed)' },\n    open: { base64: openImage, mime_type: 'image/png', description: 'Stage 3: Doors open' }\n  }\n}];"
      },
      "id": "c5e5e3dd-d58f-4f54-9af9-a98df1f66017",
      "name": "Format Response (All)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        21440,
        9136
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Parse Furniture + Prep Open').first().json;\nconst analysis = input.analysisResult;\n\nreturn [{\n  success: true,\n  message: 'Claude Î∂ÑÏÑù + Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± ÏôÑÎ£å (Îã´Ìûå ÎèÑÏñ¥Îßå)',\n  processing: 'claude-analysis + 2-stage-generation',\n  category: input.category,\n  style: input.style,\n  pipe_analysis: {\n    method: 'claude',\n    water_supply_percent: analysis.water_supply_percent,\n    exhaust_duct_percent: analysis.exhaust_duct_percent,\n    confidence: analysis.confidence\n  },\n  generated_image: {\n    background: { base64: input.cleanedBackground, mime_type: 'image/png', description: 'Stage 1: Cleaned background' },\n    closed: { base64: input.closedImage, mime_type: 'image/png', description: 'Stage 2: Furniture added (closed)' },\n    open: null\n  }\n}];"
      },
      "id": "612a15d9-2653-4b4b-87bc-7925b439f81d",
      "name": "Format Response (Closed)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        21248,
        9360
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $('Build Cleanup Prompt').first().json;\nreturn [{\n  success: false,\n  message: 'Î∞∞Í≤Ω Ï†ïÎ¶¨ Ïã§Ìå®',\n  error: 'Background cleanup failed',\n  category: input.category\n}];"
      },
      "id": "8849c870-c698-4ccc-b858-42b9f6866d64",
      "name": "Format Response (Error)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20672,
        9472
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "2207fe01-7ee9-46f1-8681-0040ec8c9bce",
      "name": "Respond (All)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        21632,
        9136
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "5e9a267a-b79f-4442-995a-48b8ab89b23b",
      "name": "Respond (Closed)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        21440,
        9360
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "a3aeef74-eb09-4584-baac-6ebc6647c8a2",
      "name": "Respond (Error)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        20864,
        9472
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Input": {
      "main": [
        [
          {
            "node": "Build Claude Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Claude Request": {
      "main": [
        [
          {
            "node": "Claude Pipe Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude Pipe Analysis": {
      "main": [
        [
          {
            "node": "Parse Claude Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Claude Result": {
      "main": [
        [
          {
            "node": "Build Cleanup Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Cleanup Prompt": {
      "main": [
        [
          {
            "node": "Gemini Background Cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Background Cleanup": {
      "main": [
        [
          {
            "node": "Parse BG + Build Furniture",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse BG + Build Furniture": {
      "main": [
        [
          {
            "node": "Has Cleaned BG?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Cleaned BG?": {
      "main": [
        [
          {
            "node": "Gemini Furniture",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Response (Error)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Furniture": {
      "main": [
        [
          {
            "node": "Parse Furniture + Prep Open",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Furniture + Prep Open": {
      "main": [
        [
          {
            "node": "Has Closed Image?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Closed Image?": {
      "main": [
        [
          {
            "node": "Gemini Open Door",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Response (Closed)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Open Door": {
      "main": [
        [
          {
            "node": "Format Response (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response (All)": {
      "main": [
        [
          {
            "node": "Respond (All)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response (Closed)": {
      "main": [
        [
          {
            "node": "Respond (Closed)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response (Error)": {
      "main": [
        [
          {
            "node": "Respond (Error)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "495ad7fb-ed25-4f01-b47a-1c01e1fe46d8",
  "meta": {
    "instanceId": "244e14704bf7bd5d7ea20567a9c92fb83222642504dc698a01d22d41bd5f300d"
  },
  "id": "4Nw23tbPb3Gg18gV",
  "tags": []
}