<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒë‹´ ê´€ë¦¬ - ë‹¤ë‹´ê°€êµ¬ ê´€ë¦¬ì</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f5; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            position: fixed; left: 0; top: 0; width: 250px; height: 100vh;
            background: #1a1a2e; color: white; padding: 20px 0; z-index: 1000;
        }
        .sidebar-logo { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-logo h1 { font-size: 1.3rem; font-weight: 700; }
        .sidebar-logo span { font-size: 0.8rem; color: #888; }
        .nav-menu { list-style: none; }
        .nav-menu li a {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            color: #aaa; text-decoration: none; transition: all 0.3s;
        }
        .nav-menu li a:hover, .nav-menu li a.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-menu li a.active { border-left: 3px solid #007bff; }
        .nav-icon { width: 20px; text-align: center; }
        .sidebar-footer { position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px; }
        .sidebar-footer a {
            display: block; padding: 10px; text-align: center; background: rgba(255,255,255,0.1);
            color: #aaa; text-decoration: none; border-radius: 5px; font-size: 0.9rem;
        }
        .sidebar-footer a:hover { background: rgba(255,255,255,0.2); color: white; }

        /* Main Content */
        .main-content { margin-left: 250px; padding: 20px 30px; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #ddd;
        }
        .header h2 { font-size: 1.5rem; color: #333; }

        /* Stats Tabs */
        .stats-tabs {
            display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;
        }
        .stat-tab {
            padding: 12px 20px; background: white; border-radius: 8px;
            border: 2px solid transparent; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 10px;
        }
        .stat-tab:hover { border-color: #ddd; }
        .stat-tab.active { border-color: #007bff; background: #e3f2fd; }
        .stat-tab .count { font-size: 1.3rem; font-weight: 700; }
        .stat-tab .label { font-size: 0.85rem; color: #666; }
        .stat-tab.pending .count { color: #f57c00; }
        .stat-tab.confirmed .count { color: #1976d2; }
        .stat-tab.completed .count { color: #388e3c; }
        .stat-tab.cancelled .count { color: #c62828; }

        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 0.9rem; color: #666; }
        .filter-group select, .filter-group input {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;
            font-size: 0.9rem; font-family: inherit;
        }
        .search-input { min-width: 200px; }

        /* Buttons */
        .btn {
            padding: 8px 16px; border: none; border-radius: 5px; font-size: 0.9rem;
            cursor: pointer; font-family: inherit; transition: all 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        /* Card */
        .card {
            background: white; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card-body { padding: 0; }

        /* Consultation List */
        .consultation-list { padding: 20px; }
        .consultation-card {
            border: 1px solid #eee; border-radius: 10px; padding: 20px;
            margin-bottom: 15px; transition: all 0.3s;
        }
        .consultation-card:hover { border-color: #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .consultation-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px;
        }
        .consultation-user { display: flex; align-items: center; gap: 12px; }
        .user-avatar {
            width: 45px; height: 45px; border-radius: 50%; background: #e0e0e0;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #666;
        }
        .user-details h4 { font-size: 1rem; margin-bottom: 3px; }
        .user-details span { font-size: 0.85rem; color: #888; }

        .badge {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 500;
        }
        .badge.pending { background: #fff3e0; color: #f57c00; }
        .badge.confirmed { background: #e3f2fd; color: #1976d2; }
        .badge.completed { background: #e8f5e9; color: #388e3c; }
        .badge.cancelled { background: #ffebee; color: #c62828; }

        .type-badge {
            display: inline-block; padding: 3px 8px; border-radius: 4px;
            font-size: 0.75rem; background: #f5f5f5; color: #666; margin-left: 10px;
        }

        .consultation-info {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px;
        }
        .info-item label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 3px; }
        .info-item p { font-size: 0.95rem; color: #333; }

        .consultation-description {
            padding: 15px; background: #f9f9f9; border-radius: 8px;
            margin-bottom: 15px; font-size: 0.9rem; color: #555; line-height: 1.6;
        }

        .consultation-actions {
            display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #eee;
            flex-wrap: wrap;
        }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state h4 { margin-bottom: 10px; color: #666; }

        /* Access Denied */
        .access-denied { display: none; text-align: center; padding: 100px 20px; }
        .access-denied h2 { font-size: 1.5rem; color: #c62828; margin-bottom: 15px; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 10px; width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; border-bottom: 1px solid #eee;
        }
        .modal-header h3 { font-size: 1.2rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #333; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px;
            font-size: 0.95rem; font-family: inherit;
        }
        .form-group textarea { resize: vertical; }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: 10px;
            padding: 20px; border-top: 1px solid #eee;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
        @media (max-width: 768px) {
            .stats-tabs { flex-direction: column; }
            .stat-tab { justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-logo">
            <h1>ë‹¤ë‹´ê°€êµ¬</h1>
            <span>ê´€ë¦¬ì íŒ¨ë„</span>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html"><span class="nav-icon">ğŸ“Š</span>ëŒ€ì‹œë³´ë“œ</a></li>
            <li><a href="users.html"><span class="nav-icon">ğŸ‘¥</span>íšŒì› ê´€ë¦¬</a></li>
            <li><a href="expert-requests.html"><span class="nav-icon">â­</span>Expert ìŠ¹ê¸‰ ê´€ë¦¬</a></li>
            <li><a href="consultations.html" class="active"><span class="nav-icon">ğŸ’¬</span>ìƒë‹´ ê´€ë¦¬</a></li>
            <li><a href="logs.html"><span class="nav-icon">ğŸ“‹</span>í™œë™ ë¡œê·¸</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="../index.html">â† ë©”ì¸ ì‚¬ì´íŠ¸ë¡œ</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="access-denied" id="accessDenied">
            <h2>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h2>
            <p>ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.</p>
            <a href="../index.html">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="pageContent" style="display: none;">
            <header class="header">
                <h2>ìƒë‹´ ê´€ë¦¬</h2>
            </header>

            <!-- Stats Tabs -->
            <div class="stats-tabs">
                <div class="stat-tab active" onclick="filterByStatus('')" data-status="">
                    <span class="count" id="totalCount">0</span>
                    <span class="label">ì „ì²´</span>
                </div>
                <div class="stat-tab pending" onclick="filterByStatus('pending')" data-status="pending">
                    <span class="count" id="pendingCount">0</span>
                    <span class="label">ëŒ€ê¸°</span>
                </div>
                <div class="stat-tab confirmed" onclick="filterByStatus('confirmed')" data-status="confirmed">
                    <span class="count" id="confirmedCount">0</span>
                    <span class="label">í™•ì •</span>
                </div>
                <div class="stat-tab completed" onclick="filterByStatus('completed')" data-status="completed">
                    <span class="count" id="completedCount">0</span>
                    <span class="label">ì™„ë£Œ</span>
                </div>
                <div class="stat-tab cancelled" onclick="filterByStatus('cancelled')" data-status="cancelled">
                    <span class="count" id="cancelledCount">0</span>
                    <span class="label">ì·¨ì†Œ</span>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <input type="text" class="search-input" placeholder="ì´ë¦„, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..."
                           id="searchInput" onkeyup="handleSearch(event)">
                </div>
                <div class="filter-group">
                    <label>ìœ í˜•:</label>
                    <select id="typeFilter" onchange="loadConsultations()">
                        <option value="">ì „ì²´</option>
                        <option value="ai-design">AI ì„¤ê³„</option>
                        <option value="detail-design">ìƒì„¸ ì„¤ê³„</option>
                        <option value="estimate">ê²¬ì  ìƒë‹´</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="loadConsultations()">ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <!-- Consultation List -->
            <div class="card">
                <div class="card-body">
                    <div class="consultation-list" id="consultationList">
                        <div class="empty-state"><h4>ë¡œë”© ì¤‘...</h4></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirm Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ìƒë‹´ ì¼ì • í™•ì •</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>í™•ì • ì¼ì‹œ</label>
                    <input type="datetime-local" id="confirmedDateTime">
                </div>
                <div class="form-group">
                    <label>ë‹´ë‹¹ì ë©”ëª¨</label>
                    <textarea id="confirmMemo" rows="3" placeholder="ê³ ê°ì—ê²Œ ì „ë‹¬í•  ì•ˆë‚´ì‚¬í•­..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmConsultation()">ì¼ì • í™•ì •</button>
            </div>
        </div>
    </div>

    <!-- Complete Modal -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ìƒë‹´ ì™„ë£Œ ì²˜ë¦¬</h3>
                <button class="modal-close" onclick="closeModal('completeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ìƒë‹´ ê²°ê³¼ ë©”ëª¨</label>
                    <textarea id="completeMemo" rows="4" placeholder="ìƒë‹´ ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('completeModal')">ì·¨ì†Œ</button>
                <button class="btn btn-success" onclick="completeConsultation()">ì™„ë£Œ ì²˜ë¦¬</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vvqrvgcgnlfpiqqndsve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2cXJ2Z2NnbmxmcGlxcW5kc3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTYyMjYsImV4cCI6MjA4MzQzMjIyNn0.WvMdB2bojqRUjYWdljAcxP1yHqQZJwuyv2equltyWWQ';

        let supabaseClient = null;
        let currentUser = null;
        let selectedConsultationId = null;
        let currentStatusFilter = '';

        const ADMIN_EMAILS = ['dadamfurniture@gmail.com'];
        const TYPE_LABELS = {
            'ai-design': 'AI ì„¤ê³„',
            'detail-design': 'ìƒì„¸ ì„¤ê³„',
            'estimate': 'ê²¬ì  ìƒë‹´',
            'other': 'ê¸°íƒ€'
        };
        const STATUS_LABELS = {
            'pending': 'ëŒ€ê¸°',
            'confirmed': 'í™•ì •',
            'completed': 'ì™„ë£Œ',
            'cancelled': 'ì·¨ì†Œ'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await initAdmin();
        });

        async function initAdmin() {
            if (typeof window.supabase === 'undefined') {
                showAccessDenied();
                return;
            }
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session || !ADMIN_EMAILS.includes(session.user.email)) {
                showAccessDenied();
                return;
            }
            currentUser = session.user;
            document.getElementById('pageContent').style.display = 'block';
            await loadStats();
            await loadConsultations();
        }

        function showAccessDenied() {
            document.getElementById('accessDenied').style.display = 'block';
            document.getElementById('pageContent').style.display = 'none';
        }

        async function loadStats() {
            try {
                const { data, error } = await supabaseClient.from('consultations').select('status');
                if (error) throw error;

                const counts = { total: 0, pending: 0, confirmed: 0, completed: 0, cancelled: 0 };
                data.forEach(c => {
                    counts.total++;
                    if (counts[c.status] !== undefined) counts[c.status]++;
                });

                document.getElementById('totalCount').textContent = counts.total;
                document.getElementById('pendingCount').textContent = counts.pending;
                document.getElementById('confirmedCount').textContent = counts.confirmed;
                document.getElementById('completedCount').textContent = counts.completed;
                document.getElementById('cancelledCount').textContent = counts.cancelled;
            } catch (e) {
                console.log('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', e.message);
            }
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.stat-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.status === status);
            });
            loadConsultations();
        }

        async function loadConsultations() {
            const container = document.getElementById('consultationList');
            container.innerHTML = '<div class="empty-state"><h4>ë¡œë”© ì¤‘...</h4></div>';

            const typeFilter = document.getElementById('typeFilter').value;
            const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();

            try {
                let query = supabaseClient
                    .from('consultations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (currentStatusFilter) query = query.eq('status', currentStatusFilter);
                if (typeFilter) query = query.eq('consultation_type', typeFilter);

                const { data, error } = await query;
                if (error) throw error;

                let filtered = data || [];
                if (searchQuery) {
                    filtered = filtered.filter(c =>
                        (c.name && c.name.toLowerCase().includes(searchQuery)) ||
                        (c.email && c.email.toLowerCase().includes(searchQuery))
                    );
                }

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h4>ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p>ì¡°ê±´ì— ë§ëŠ” ìƒë‹´ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(c => renderConsultationCard(c)).join('');
            } catch (e) {
                console.error('Error:', e);
                container.innerHTML = `
                    <div class="empty-state">
                        <h4>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>${e.message}</p>
                        <p style="font-size:0.85rem;color:#888;margin-top:10px;">
                            consultations í…Œì´ë¸”ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
                        </p>
                    </div>
                `;
            }
        }

        function renderConsultationCard(c) {
            const initial = (c.name || c.email || '?').charAt(0).toUpperCase();
            const typeLabel = TYPE_LABELS[c.consultation_type] || c.consultation_type || 'ë¯¸ì§€ì •';
            const statusLabel = STATUS_LABELS[c.status] || c.status;

            let actionsHtml = '';
            if (c.status === 'pending') {
                actionsHtml = `
                    <button class="btn btn-primary btn-sm" onclick="openConfirmModal('${c.id}')">ì¼ì • í™•ì •</button>
                    <button class="btn btn-danger btn-sm" onclick="cancelConsultation('${c.id}')">ì·¨ì†Œ</button>
                `;
            } else if (c.status === 'confirmed') {
                actionsHtml = `
                    <button class="btn btn-success btn-sm" onclick="openCompleteModal('${c.id}')">ì™„ë£Œ ì²˜ë¦¬</button>
                    <button class="btn btn-warning btn-sm" onclick="openConfirmModal('${c.id}')">ì¼ì • ë³€ê²½</button>
                    <button class="btn btn-danger btn-sm" onclick="cancelConsultation('${c.id}')">ì·¨ì†Œ</button>
                `;
            } else {
                actionsHtml = `<button class="btn btn-secondary btn-sm" disabled>ì²˜ë¦¬ ì™„ë£Œ</button>`;
            }

            return `
                <div class="consultation-card">
                    <div class="consultation-header">
                        <div class="consultation-user">
                            <div class="user-avatar">${initial}</div>
                            <div class="user-details">
                                <h4>${c.name || 'ì´ë¦„ ì—†ìŒ'} <span class="type-badge">${typeLabel}</span></h4>
                                <span>${c.email} ${c.phone ? '| ' + c.phone : ''}</span>
                            </div>
                        </div>
                        <span class="badge ${c.status}">${statusLabel}</span>
                    </div>
                    <div class="consultation-info">
                        <div class="info-item">
                            <label>ì œëª©</label>
                            <p>${c.title || '-'}</p>
                        </div>
                        <div class="info-item">
                            <label>í¬ë§ ì¼ì‹œ</label>
                            <p>${c.preferred_date || '-'} ${c.preferred_time || ''}</p>
                        </div>
                        <div class="info-item">
                            <label>ì‹ ì²­ì¼</label>
                            <p>${formatDate(c.created_at)}</p>
                        </div>
                        ${c.confirmed_at ? `
                        <div class="info-item">
                            <label>í™•ì • ì¼ì‹œ</label>
                            <p>${formatDateTime(c.confirmed_at)}</p>
                        </div>
                        ` : ''}
                    </div>
                    ${c.description ? `
                    <div class="consultation-description">${c.description}</div>
                    ` : ''}
                    ${c.admin_memo ? `
                    <div class="consultation-description" style="background:#fff3e0;">
                        <strong>ê´€ë¦¬ì ë©”ëª¨:</strong> ${c.admin_memo}
                    </div>
                    ` : ''}
                    <div class="consultation-actions">${actionsHtml}</div>
                </div>
            `;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('ko-KR');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('ko-KR');
        }

        function handleSearch(e) {
            if (e.key === 'Enter') loadConsultations();
        }

        function openConfirmModal(id) {
            selectedConsultationId = id;
            document.getElementById('confirmedDateTime').value = '';
            document.getElementById('confirmMemo').value = '';
            document.getElementById('confirmModal').classList.add('active');
        }

        function openCompleteModal(id) {
            selectedConsultationId = id;
            document.getElementById('completeMemo').value = '';
            document.getElementById('completeModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            selectedConsultationId = null;
        }

        async function confirmConsultation() {
            if (!selectedConsultationId) return;
            const dateTime = document.getElementById('confirmedDateTime').value;
            const memo = document.getElementById('confirmMemo').value;

            if (!dateTime) {
                alert('í™•ì • ì¼ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('consultations')
                    .update({
                        status: 'confirmed',
                        confirmed_at: dateTime,
                        admin_memo: memo,
                        assigned_to: currentUser.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', selectedConsultationId);

                if (error) throw error;
                alert('ìƒë‹´ ì¼ì •ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('confirmModal');
                await loadStats();
                await loadConsultations();
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        async function completeConsultation() {
            if (!selectedConsultationId) return;
            const memo = document.getElementById('completeMemo').value;

            try {
                const { error } = await supabaseClient
                    .from('consultations')
                    .update({
                        status: 'completed',
                        admin_memo: memo,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', selectedConsultationId);

                if (error) throw error;
                alert('ìƒë‹´ì´ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal('completeModal');
                await loadStats();
                await loadConsultations();
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        async function cancelConsultation(id) {
            if (!confirm('ì •ë§ ì´ ìƒë‹´ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('consultations')
                    .update({
                        status: 'cancelled',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                alert('ìƒë‹´ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadStats();
                await loadConsultations();
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
    </script>
</body>
</html>
