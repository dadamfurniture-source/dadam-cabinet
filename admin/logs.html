<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í™œë™ ë¡œê·¸ - ë‹¤ë‹´ê°€êµ¬ ê´€ë¦¬ì</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="../js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f5f5f5;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 250px;
        height: 100vh;
        background: #1a1a2e;
        color: white;
        padding: 20px 0;
        z-index: 1000;
      }
      .sidebar-logo {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
      }
      .sidebar-logo h1 {
        font-size: 1.3rem;
        font-weight: 700;
      }
      .sidebar-logo span {
        font-size: 0.8rem;
        color: #888;
      }
      .nav-menu {
        list-style: none;
      }
      .nav-menu li a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #aaa;
        text-decoration: none;
        transition: all 0.3s;
      }
      .nav-menu li a:hover,
      .nav-menu li a.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }
      .nav-menu li a.active {
        border-left: 3px solid #007bff;
      }
      .nav-icon {
        width: 20px;
        text-align: center;
      }
      .sidebar-footer {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        padding: 0 20px;
      }
      .sidebar-footer a {
        display: block;
        padding: 10px;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        color: #aaa;
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.9rem;
      }
      .sidebar-footer a:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      /* Main Content */
      .main-content {
        margin-left: 250px;
        padding: 20px 30px;
      }

      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }
      .header h2 {
        font-size: 1.5rem;
        color: #333;
      }

      /* Filters */
      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .filter-group label {
        font-size: 0.9rem;
        color: #666;
        white-space: nowrap;
      }
      .filter-group input,
      .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.9rem;
        font-family: inherit;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        font-size: 0.9rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.3s;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background: #0056b3;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      /* Card */
      .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .card-body {
        padding: 0;
      }

      /* Log List */
      .log-list {
        padding: 0;
      }
      .log-item {
        display: flex;
        gap: 16px;
        padding: 20px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
      }
      .log-item:hover {
        background: #fafafa;
      }
      .log-item:last-child {
        border-bottom: none;
      }

      .log-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }
      .log-icon.user {
        background: #e3f2fd;
        color: #1976d2;
      }
      .log-icon.tier {
        background: #fff3e0;
        color: #f57c00;
      }
      .log-icon.consultation {
        background: #e8f5e9;
        color: #388e3c;
      }
      .log-icon.system {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .log-icon.login {
        background: #e0f7fa;
        color: #00838f;
      }

      .log-content {
        flex: 1;
      }
      .log-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 6px;
      }
      .log-action {
        font-weight: 500;
        color: #333;
      }
      .log-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        background: #e0e0e0;
        color: #616161;
      }
      .log-description {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
        line-height: 1.5;
      }
      .log-meta {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        color: #888;
      }
      .log-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .log-changes {
        margin-top: 10px;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 6px;
        font-size: 0.85rem;
        font-family: monospace;
      }
      .log-changes .old {
        color: #c62828;
        text-decoration: line-through;
      }
      .log-changes .new {
        color: #2e7d32;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 20px;
        border-top: 1px solid #eee;
      }
      .pagination button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        font-family: inherit;
      }
      .pagination button:hover:not(:disabled) {
        background: #f5f5f5;
      }
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pagination span {
        font-size: 0.9rem;
        color: #666;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
      }
      .empty-state h4 {
        margin-bottom: 10px;
        color: #666;
      }

      /* Access Denied */
      .access-denied {
        display: none;
        text-align: center;
        padding: 100px 20px;
      }
      .access-denied h2 {
        font-size: 1.5rem;
        color: #c62828;
        margin-bottom: 15px;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .main-content {
          margin-left: 0;
        }
      }
      @media (max-width: 768px) {
        .filters {
          flex-direction: column;
        }
        .filter-group {
          width: 100%;
        }
        .filter-group input,
        .filter-group select {
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-logo">
        <h1>ë‹¤ë‹´ê°€êµ¬</h1>
        <span>ê´€ë¦¬ì íŒ¨ë„</span>
      </div>
      <ul class="nav-menu">
        <li>
          <a href="index.html"><span class="nav-icon">ğŸ“Š</span>ëŒ€ì‹œë³´ë“œ</a>
        </li>
        <li>
          <a href="users.html"><span class="nav-icon">ğŸ‘¥</span>íšŒì› ê´€ë¦¬</a>
        </li>
        <li>
          <a href="expert-requests.html"><span class="nav-icon">â­</span>Expert ìŠ¹ê¸‰ ê´€ë¦¬</a>
        </li>
        <li>
          <a href="consultations.html"><span class="nav-icon">ğŸ’¬</span>ìƒë‹´ ê´€ë¦¬</a>
        </li>
        <li>
          <a href="logs.html" class="active"><span class="nav-icon">ğŸ“‹</span>í™œë™ ë¡œê·¸</a>
        </li>
        <li>
          <a href="settings.html"><span class="nav-icon">âš™ï¸</span>ì„¤ì •</a>
        </li>
      </ul>
      <div class="sidebar-footer">
        <a href="../index.html">â† ë©”ì¸ ì‚¬ì´íŠ¸ë¡œ</a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="access-denied" id="accessDenied">
        <h2>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h2>
        <p>ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.</p>
        <a href="../index.html">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>

      <div id="pageContent" style="display: none">
        <header class="header">
          <h2>í™œë™ ë¡œê·¸</h2>
          <span id="totalCount">ì „ì²´ 0ê±´</span>
        </header>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <label>ê¸°ê°„:</label>
            <input type="date" id="startDate" />
            <span>~</span>
            <input type="date" id="endDate" />
          </div>
          <div class="filter-group">
            <label>ìœ í˜•:</label>
            <select id="actionFilter">
              <option value="">ì „ì²´</option>
              <option value="user_update">íšŒì› ìˆ˜ì •</option>
              <option value="tier_change">ë“±ê¸‰ ë³€ê²½</option>
              <option value="consultation_update">ìƒë‹´ ì²˜ë¦¬</option>
              <option value="expert_request">ìŠ¹ê¸‰ ì²˜ë¦¬</option>
              <option value="login">ë¡œê·¸ì¸</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="loadLogs()">ê²€ìƒ‰</button>
          <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>

        <!-- Log List -->
        <div class="card">
          <div class="card-body">
            <div class="log-list" id="logList">
              <div class="empty-state"><h4>ë¡œë”© ì¤‘...</h4></div>
            </div>
          </div>
          <div class="pagination">
            <button onclick="prevPage()" id="prevBtn" disabled>ì´ì „</button>
            <span id="pageInfo">1 / 1</span>
            <button onclick="nextPage()" id="nextBtn" disabled>ë‹¤ìŒ</button>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Supabase ì„¤ì • - config.jsì—ì„œ ê°€ì ¸ì˜´
      let supabaseClient = null;
      let currentUser = null;
      let currentPage = 1;
      const pageSize = 20;
      let totalLogs = 0;

      const ADMIN_EMAILS = ['dadamfurniture@gmail.com'];

      const ACTION_LABELS = {
        user_update: 'íšŒì› ìˆ˜ì •',
        tier_change: 'ë“±ê¸‰ ë³€ê²½',
        consultation_update: 'ìƒë‹´ ì²˜ë¦¬',
        expert_request: 'ìŠ¹ê¸‰ ì²˜ë¦¬',
        login: 'ë¡œê·¸ì¸',
        system: 'ì‹œìŠ¤í…œ',
      };

      const ACTION_ICONS = {
        user_update: { class: 'user', icon: 'ğŸ‘¤' },
        tier_change: { class: 'tier', icon: 'â­' },
        consultation_update: { class: 'consultation', icon: 'ğŸ’¬' },
        expert_request: { class: 'tier', icon: 'ğŸ–ï¸' },
        login: { class: 'login', icon: 'ğŸ”‘' },
        system: { class: 'system', icon: 'âš™ï¸' },
      };

      document.addEventListener('DOMContentLoaded', async () => {
        await initAdmin();
        // ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ìµœê·¼ 30ì¼)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      });

      async function initAdmin() {
        if (typeof window.supabase === 'undefined' || !window.DADAM_CONFIG?.supabase) {
          showAccessDenied();
          return;
        }
        const { url, anonKey } = window.DADAM_CONFIG.supabase;
        supabaseClient = window.supabase.createClient(url, anonKey);
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (!session || !ADMIN_EMAILS.includes(session.user.email)) {
          showAccessDenied();
          return;
        }
        currentUser = session.user;
        document.getElementById('pageContent').style.display = 'block';
        await loadLogs();
      }

      function showAccessDenied() {
        document.getElementById('accessDenied').style.display = 'block';
        document.getElementById('pageContent').style.display = 'none';
      }

      async function loadLogs() {
        const container = document.getElementById('logList');
        container.innerHTML = '<div class="empty-state"><h4>ë¡œë”© ì¤‘...</h4></div>';

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const actionFilter = document.getElementById('actionFilter').value;

        try {
          let query = supabaseClient
            .from('admin_logs')
            .select('*', { count: 'exact' })
            .order('created_at', { ascending: false })
            .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

          if (startDate) {
            query = query.gte('created_at', startDate + 'T00:00:00');
          }
          if (endDate) {
            query = query.lte('created_at', endDate + 'T23:59:59');
          }
          if (actionFilter) {
            query = query.eq('action_type', actionFilter);
          }

          const { data: logs, error, count } = await query;

          if (error) throw error;

          totalLogs = count || 0;
          document.getElementById('totalCount').textContent = `ì „ì²´ ${totalLogs}ê±´`;

          const totalPages = Math.ceil(totalLogs / pageSize) || 1;
          document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
          document.getElementById('prevBtn').disabled = currentPage <= 1;
          document.getElementById('nextBtn').disabled = currentPage >= totalPages;

          if (!logs || logs.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <h4>í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p>ì¡°ê±´ì— ë§ëŠ” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
            return;
          }

          container.innerHTML = logs.map((log) => renderLogItem(log)).join('');
        } catch (e) {
          console.error('Error:', e);
          container.innerHTML = `
                    <div class="empty-state">
                        <h4>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h4>
                        <p>${e.message}</p>
                        <p style="font-size:0.85rem;color:#888;margin-top:10px;">
                            admin_logs í…Œì´ë¸”ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
                            database/admin-schema.sqlì„ Supabaseì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.
                        </p>
                    </div>
                `;
        }
      }

      function renderLogItem(log) {
        const actionInfo = ACTION_ICONS[log.action_type] || ACTION_ICONS['system'];
        const actionLabel = ACTION_LABELS[log.action_type] || log.action_type;

        let changesHtml = '';
        if (log.old_value || log.new_value) {
          changesHtml = `
                    <div class="log-changes">
                        ${log.old_value ? `<span class="old">${JSON.stringify(log.old_value)}</span>` : ''}
                        ${log.old_value && log.new_value ? ' â†’ ' : ''}
                        ${log.new_value ? `<span class="new">${JSON.stringify(log.new_value)}</span>` : ''}
                    </div>
                `;
        }

        return `
                <div class="log-item">
                    <div class="log-icon ${actionInfo.class}">${actionInfo.icon}</div>
                    <div class="log-content">
                        <div class="log-header">
                            <span class="log-action">${actionLabel}</span>
                            <span class="log-badge">${log.target_type || '-'}</span>
                        </div>
                        <div class="log-description">${log.description || '-'}</div>
                        <div class="log-meta">
                            <span>ğŸ‘¤ ${log.admin_email || 'ì‹œìŠ¤í…œ'}</span>
                            <span>ğŸ• ${formatDateTime(log.created_at)}</span>
                            ${log.ip_address ? `<span>ğŸŒ ${log.ip_address}</span>` : ''}
                        </div>
                        ${changesHtml}
                    </div>
                </div>
            `;
      }

      function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function resetFilters() {
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('actionFilter').value = '';
        currentPage = 1;
        loadLogs();
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage--;
          loadLogs();
        }
      }

      function nextPage() {
        const totalPages = Math.ceil(totalLogs / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          loadLogs();
        }
      }
    </script>
  </body>
</html>
