<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2A26">
  <title>상담 신청 - 다담가구</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Noto+Serif+KR:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Sentry SDK for Error Tracking -->
  <script src="https://browser.sentry-cdn.com/7.94.1/bundle.tracing.min.js" crossorigin="anonymous"></script>
  <script>
    window.SENTRY_DSN = '';
    window.APP_ENV = window.location.hostname === 'localhost' ? 'development' : 'production';
    window.APP_VERSION = '1.0.0';
  </script>
  <script src="js/error-tracking.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--white:#FAFAFA;--cream:#F8F7F4;--warm:#EBE8E2;--gray:#8B8680;--charcoal:#2D2A26;--black:#1A1918;--gold:#B8956C}
    body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;background:var(--cream);color:var(--charcoal);line-height:1.7;min-height:100vh}
    h1,h2,h3{font-family:'Playfair Display','Noto Serif KR',serif;font-weight:500}
    a{text-decoration:none;color:inherit}

    /* Navigation */
    .nav{position:fixed;top:0;left:0;right:0;z-index:100;padding:0 48px;height:72px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.97);backdrop-filter:blur(10px);box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .nav-logo{display:flex;align-items:center;gap:8px;color:var(--charcoal)}
    .nav-logo svg{width:32px;height:32px}
    .nav-logo span{font-family:'Playfair Display',serif;font-size:24px}
    .nav-menu{display:flex;gap:32px}
    .nav-menu a{color:var(--charcoal);font-size:14px;letter-spacing:.5px;transition:all .3s}
    .nav-menu a:hover{color:var(--gold)}
    .nav-menu a.active{color:var(--gold);font-weight:500}
    .nav-icons{display:flex;align-items:center;gap:24px;color:var(--charcoal)}
    .login-btn{padding:8px 16px;background:transparent;border:1px solid var(--charcoal);border-radius:8px;font-size:13px;transition:all .3s}
    .login-btn:hover{background:var(--gold);border-color:var(--gold);color:#fff}
    .user-menu{position:relative;display:none}
    .user-btn{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:var(--cream);border:none;color:inherit;cursor:pointer;transition:all .3s}
    .user-btn:hover{background:var(--warm)}
    .user-avatar{width:28px;height:28px;border-radius:50%;background:var(--gold);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff}
    .user-name{font-size:13px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .user-dropdown{position:absolute;top:calc(100% + 8px);right:0;min-width:180px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;visibility:hidden;transform:translateY(-10px);transition:all .3s;z-index:200}
    .user-menu:hover .user-dropdown{opacity:1;visibility:visible;transform:translateY(0)}
    .user-dropdown a,.user-dropdown button{display:flex;align-items:center;gap:10px;width:100%;padding:12px 16px;font-size:14px;color:var(--charcoal);background:none;border:none;cursor:pointer;transition:background .2s;text-align:left}
    .user-dropdown a:hover,.user-dropdown button:hover{background:var(--cream)}
    .user-dropdown svg{width:18px;height:18px;color:var(--gray)}
    .hamburger{display:none;flex-direction:column;gap:5px;padding:10px;cursor:pointer;background:none;border:none}
    .hamburger span{width:24px;height:2px;background:var(--charcoal);border-radius:2px;transition:all .3s}
    .mobile-menu{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--white);z-index:99;padding:100px 24px 24px;display:none;flex-direction:column;gap:8px}
    .mobile-menu.active{display:flex}
    .mobile-menu a{padding:18px 20px;font-size:18px;border-radius:12px;color:var(--charcoal)}
    .mobile-menu a:hover{background:var(--cream);color:var(--gold)}
    @media(max-width:768px){
      .nav{padding:0 20px;height:64px}
      .nav-menu{display:none}
      .hamburger{display:flex}
    }

    /* Main */
    .main{max-width:700px;margin:0 auto;padding:112px 24px 60px}

    /* Page Header */
    .page-header{text-align:center;margin-bottom:48px}
    .page-header h1{font-size:2.5rem;margin-bottom:16px}
    .page-header p{color:var(--gray);font-size:1.1rem;line-height:1.8}

    /* Form Card */
    .form-card{background:#fff;border-radius:20px;padding:40px;box-shadow:0 4px 20px rgba(0,0,0,.05)}

    /* Type Selection */
    .type-selection{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:32px}
    .type-card{padding:20px;border:2px solid var(--warm);border-radius:12px;cursor:pointer;transition:all .3s;text-align:center}
    .type-card:hover{border-color:var(--gold);background:rgba(184,149,108,.05)}
    .type-card.selected{border-color:var(--gold);background:rgba(184,149,108,.1)}
    .type-card input{display:none}
    .type-card svg{width:32px;height:32px;margin-bottom:10px;color:var(--gold)}
    .type-card h4{font-size:15px;margin-bottom:4px}
    .type-card p{font-size:12px;color:var(--gray)}

    /* Form Groups */
    .form-section{margin-bottom:32px}
    .form-section-title{font-size:1.1rem;margin-bottom:16px;color:var(--charcoal);display:flex;align-items:center;gap:8px}
    .form-section-title svg{width:20px;height:20px;color:var(--gold)}

    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}
    .form-group label .required{color:#c62828;margin-left:2px}
    .form-group input,.form-group select,.form-group textarea{
      width:100%;padding:14px 16px;border:1px solid var(--warm);border-radius:10px;
      font-size:15px;font-family:inherit;transition:all .3s;background:#fff
    }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{
      outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(184,149,108,.15)
    }
    .form-group textarea{resize:vertical;min-height:120px}
    .form-hint{font-size:12px;color:var(--gray);margin-top:6px}

    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:600px){.form-row{grid-template-columns:1fr}}

    /* Date/Time Selection */
    .datetime-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}

    /* Submit */
    .btn-submit{
      width:100%;padding:16px;background:var(--charcoal);color:#fff;border:none;
      border-radius:12px;font-size:16px;font-weight:500;cursor:pointer;transition:all .3s;
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .btn-submit:hover{background:var(--gold)}
    .btn-submit:disabled{background:var(--gray);cursor:not-allowed}
    .btn-submit svg{width:20px;height:20px}

    /* Success Message */
    .success-message{display:none;text-align:center;padding:60px 20px}
    .success-message.show{display:block}
    .success-icon{width:80px;height:80px;background:rgba(5,150,105,.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px}
    .success-icon svg{width:40px;height:40px;color:#059669}
    .success-message h2{margin-bottom:12px}
    .success-message p{color:var(--gray);margin-bottom:24px;line-height:1.8}
    .btn-home{display:inline-block;padding:14px 28px;background:var(--charcoal);color:#fff;border-radius:10px;font-size:15px;transition:background .3s}
    .btn-home:hover{background:var(--gold)}

    /* Footer */
    .footer{text-align:center;padding:40px 24px;color:var(--gray);font-size:13px}
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a href="index.html" class="nav-logo">
      <svg viewBox="0 0 40 40" fill="currentColor"><path d="M20 4L4 12v16l16 8 16-8V12L20 4zm0 4l12 6-12 6-12-6 12-6zm-12 10l12 6 12-6v8l-12 6-12-6v-8z"/></svg>
      <span>다담</span>
    </a>
    <div class="nav-menu">
      <a href="index.html">홈</a>
      <a href="ai-design.html">AI 설계</a>
      <a href="consultation.html" class="active">상담 신청</a>
    </div>
    <div class="nav-icons">
      <a href="login.html" class="login-btn" id="loginLink">로그인</a>
      <div class="user-menu" id="userMenu">
        <button class="user-btn">
          <div class="user-avatar" id="navUserAvatar">?</div>
          <span class="user-name" id="navUserName">사용자</span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <div class="user-dropdown">
          <a href="mypage.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>마이페이지</a>
          <button onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>로그아웃</button>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="mobile-menu" id="mobileMenu">
    <a href="index.html">홈</a>
    <a href="ai-design.html">AI 설계</a>
    <a href="consultation.html" style="background:var(--cream)">상담 신청</a>
    <a href="login.html" id="mobileLoginLink">로그인 / 회원가입</a>
  </div>

  <!-- Main -->
  <main class="main">
    <div class="page-header">
      <h1>상담 신청</h1>
      <p>맞춤 가구, 인테리어 설계에 대해<br>전문 상담사가 친절히 안내해 드립니다.</p>
    </div>

    <div class="form-card">
      <!-- Form -->
      <form id="consultationForm" onsubmit="submitConsultation(event)">
        <!-- Consultation Type -->
        <div class="form-section">
          <h3 class="form-section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            상담 유형
          </h3>
          <div class="type-selection">
            <label class="type-card selected" onclick="selectType(this, 'ai-design')">
              <input type="radio" name="consultationType" value="ai-design" checked>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
              <h4>AI 설계 상담</h4>
              <p>AI 기반 공간 설계</p>
            </label>
            <label class="type-card" onclick="selectType(this, 'detail-design')">
              <input type="radio" name="consultationType" value="detail-design">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
              <h4>상세 설계</h4>
              <p>전문가 맞춤 설계</p>
            </label>
            <label class="type-card" onclick="selectType(this, 'estimate')">
              <input type="radio" name="consultationType" value="estimate">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              <h4>견적 상담</h4>
              <p>비용 및 일정 안내</p>
            </label>
            <label class="type-card" onclick="selectType(this, 'other')">
              <input type="radio" name="consultationType" value="other">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <h4>기타 문의</h4>
              <p>일반 문의 사항</p>
            </label>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="form-section">
          <h3 class="form-section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            연락처 정보
          </h3>
          <div class="form-row">
            <div class="form-group">
              <label>이름 <span class="required">*</span></label>
              <input type="text" id="name" required placeholder="홍길동">
            </div>
            <div class="form-group">
              <label>연락처 <span class="required">*</span></label>
              <input type="tel" id="phone" required placeholder="010-1234-5678">
            </div>
          </div>
          <div class="form-group">
            <label>이메일 <span class="required">*</span></label>
            <input type="email" id="email" required placeholder="example@email.com">
          </div>
        </div>

        <!-- Consultation Details -->
        <div class="form-section">
          <h3 class="form-section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            상담 내용
          </h3>
          <div class="form-group">
            <label>상담 제목 <span class="required">*</span></label>
            <input type="text" id="title" required placeholder="예: 거실 붙박이장 설계 문의">
          </div>
          <div class="form-group">
            <label>상세 내용</label>
            <textarea id="description" placeholder="상담 받고 싶은 내용을 자세히 작성해주세요."></textarea>
            <div class="form-hint">공간 크기, 원하는 스타일, 예산 범위 등을 알려주시면 더 정확한 상담이 가능합니다.</div>
          </div>
        </div>

        <!-- Preferred Date/Time -->
        <div class="form-section">
          <h3 class="form-section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            희망 상담 일시 (선택)
          </h3>
          <div class="datetime-row">
            <div class="form-group">
              <label>희망 날짜</label>
              <input type="date" id="preferredDate">
            </div>
            <div class="form-group">
              <label>희망 시간대</label>
              <select id="preferredTime">
                <option value="">선택하세요</option>
                <option value="09:00-12:00">오전 (09:00~12:00)</option>
                <option value="12:00-15:00">점심 (12:00~15:00)</option>
                <option value="15:00-18:00">오후 (15:00~18:00)</option>
                <option value="18:00-21:00">저녁 (18:00~21:00)</option>
              </select>
            </div>
          </div>
          <div class="form-hint">선택하신 일정은 담당자 확인 후 확정됩니다.</div>
        </div>

        <!-- Submit -->
        <button type="submit" class="btn-submit" id="submitBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          상담 신청하기
        </button>
      </form>

      <!-- Success Message -->
      <div class="success-message" id="successMessage">
        <div class="success-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <h2>상담 신청이 완료되었습니다</h2>
        <p>담당자 확인 후 입력하신 연락처로<br>상담 일정을 안내해 드리겠습니다.</p>
        <a href="index.html" class="btn-home">홈으로 돌아가기</a>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 다담가구. All rights reserved.</p>
  </footer>

  <script>
    const SUPABASE_URL = 'https://vvqrvgcgnlfpiqqndsve.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2cXJ2Z2NnbmxmcGlxcW5kc3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTYyMjYsImV4cCI6MjA4MzQzMjIyNn0.WvMdB2bojqRUjYWdljAcxP1yHqQZJwuyv2equltyWWQ';

    let supabaseClient = null;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof window.supabase !== 'undefined') {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        await checkAuthState();
      }

      // 최소 날짜를 오늘로 설정
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('preferredDate').min = today;
    });

    async function checkAuthState() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        currentUser = session.user;
        const meta = currentUser.user_metadata || {};

        // 로그인한 경우 정보 자동 입력
        document.getElementById('name').value = meta.name || meta.full_name || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('phone').value = meta.phone || '';

        // 네비게이션 - 로그인 버튼 숨기고 사용자 메뉴 표시
        document.getElementById('loginLink').style.display = 'none';
        document.getElementById('userMenu').style.display = 'block';

        const name = meta.name || meta.full_name || currentUser.email.split('@')[0];
        document.getElementById('navUserAvatar').textContent = name.charAt(0).toUpperCase();
        document.getElementById('navUserName').textContent = name;

        // 모바일 메뉴 로그인 링크 변경
        const mobileLoginLink = document.getElementById('mobileLoginLink');
        mobileLoginLink.textContent = '마이페이지';
        mobileLoginLink.href = 'mypage.html';
      }
    }

    function toggleMobileMenu() {
      const hamburger = document.querySelector('.hamburger');
      const mobileMenu = document.getElementById('mobileMenu');
      hamburger.classList.toggle('active');
      mobileMenu.classList.toggle('active');
    }

    async function logout() {
      if (!supabaseClient) return;
      await supabaseClient.auth.signOut();
      window.location.href = 'index.html';
    }

    function selectType(el, type) {
      document.querySelectorAll('.type-card').forEach(card => {
        card.classList.remove('selected');
      });
      el.classList.add('selected');
    }

    async function submitConsultation(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>신청 중...</span>';

      const consultationType = document.querySelector('input[name="consultationType"]:checked').value;
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const preferredDate = document.getElementById('preferredDate').value;
      const preferredTime = document.getElementById('preferredTime').value;

      if (!name || !phone || !email || !title) {
        alert('필수 항목을 모두 입력해주세요.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>상담 신청하기';
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('consultations')
          .insert({
            user_id: currentUser?.id || null,
            name: name,
            email: email,
            phone: phone,
            consultation_type: consultationType,
            title: title,
            description: description || null,
            preferred_date: preferredDate || null,
            preferred_time: preferredTime || null,
            status: 'pending'
          });

        if (error) throw error;

        // 성공 메시지 표시
        document.getElementById('consultationForm').style.display = 'none';
        document.getElementById('successMessage').classList.add('show');

      } catch (error) {
        console.error('Error:', error);
        if (error.message.includes('consultations')) {
          alert('상담 신청 기능을 이용하려면 관리자에게 문의하세요.\n(데이터베이스 설정 필요)');
        } else {
          alert('신청 중 오류가 발생했습니다: ' + error.message);
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>상담 신청하기';
      }
    }
  </script>
</body>
</html>
